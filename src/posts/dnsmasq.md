# Automating Local DNS Management with `dnsmasq`

If you often manage multiple local or lab domains for pentesting, local dev, or homelabs manually editing `/etc/hosts` gets old fast.
A lightweight DNS resolver like **dnsmasq** can handle everything, and with a small automation script, it will reload automatically whenever you add or modify domains.

## Step 1: Install and Prepare

Install the required packages:

```bash
sudo apt update
sudo apt install dnsmasq inotify-tools -y
```

### Disable conflicting DNS resolvers

If you're using **systemd-resolved** (common on Ubuntu/Debian):

```bash
sudo systemctl disable --now systemd-resolved
```

If you're using **Tailscale** (on VPS), it likely manages your DNS through `/etc/resolv.conf` like this:

```
# resolv.conf(5) file generated by tailscale
# DO NOT EDIT THIS FILE BY HAND
nameserver 100.100.100.100
search tailXXXX.ts.net
```

This setup conflicts with `dnsmasq` because Tailscale's **MagicDNS** listens on port 53 and overrides your resolver.

To give control back to `dnsmasq`, run:
```bash
sudo tailscale set --accept-dns=false
```

Then recreate your resolver configuration:
```bash
echo $'nameserver 127.0.0.1\nnameserver 8.8.8.8' | sudo tee /etc/resolv.conf
```

Now your system queries your local `dnsmasq` instance instead of Tailscale.

## Step 2: Verify and Enable `dnsmasq`

Before automating anything, make sure it runs cleanly:
```bash
sudo systemctl enable dnsmasq
sudo systemctl start dnsmasq
sudo systemctl status dnsmasq
```

If it fails, check syntax:
```bash
sudo dnsmasq --test
```

and logs:
```bash
journalctl -xeu dnsmasq
```

Once you see `Active: active (running)`, proceed.

## Step 3: Create a Watcher Script

We'll use `inotifywait` to watch `/etc/dnsmasq.d/` for changes and **reload** (not restart) the service when something changes, avoiding restart loops.

Create `/usr/local/bin/watch_dns.sh`:

```bash
#!/bin/bash

WATCH_DIR="/etc/dnsmasq.d"
LOG_FILE="/var/log/dnsmasq-watch.log"

sudo touch "$LOG_FILE"
sudo chmod 644 "$LOG_FILE"

inotifywait -m -r "$WATCH_DIR" -e modify,create,delete,move |
while read -r path action file; do
    echo "$(date): Detected $action on $file in $path. Reloading dnsmasq..." | sudo tee -a "$LOG_FILE"
    sudo systemctl reload dnsmasq || sudo systemctl restart dnsmasq
    sleep 2  # Prevent rapid restarts
done
```

Make it executable:
```bash
sudo chmod +x /usr/local/bin/watch_dns.sh
```

## Step 4: Start on Boot

Add it to **root's crontab** so it runs at startup:
```bash
sudo crontab -e
```

Add:
```bash
@reboot /usr/local/bin/watch_dns.sh &
```

Alternatively, you can create a systemd unit for it, but for most use cases, cron is perfectly fine.

## Step 5: Prevent the `start-limit-hit` Error

If `dnsmasq` restarts too quickly (for example, due to conflicts or the watcher firing too fast), systemd will stop it with:
```
dnsmasq.service: Start request repeated too quickly.
dnsmasq.service: Failed with result 'start-limit-hit'.
```

To fix this permanently, increase the restart thresholds. Create an override file:
```bash
sudo systemctl edit dnsmasq
```

Add:
```ini
[Service]
StartLimitIntervalSec=60
StartLimitBurst=10
```

Save and reload:
```bash
sudo systemctl daemon-reexec
sudo systemctl daemon-reload
sudo systemctl reset-failed dnsmasq
sudo systemctl restart dnsmasq
```

This allows up to **10 restarts per minute** before hitting the limit again, ideal for auto-reload setups.

## Step 6: Add DNS Entries

Example file:

```bash
cat /etc/dnsmasq.d/lab_hosts.conf
```

```bash
address=/instant.htb/10.10.11.37
address=/chemistry.htb/10.10.11.38
address=/university.htb/10.10.11.39
```

Save the file, your watcher will detect the change and reload `dnsmasq` instantly.

## Optional: Quick Editing Alias

Add this to your shell rc file:

```bash
alias eh='sudo nvim /etc/dnsmasq.d'
```

Now running `eh` opens the directory in Neovim for quick editing.

## Optional: Block Noisy Domains (for Burp)

Burp Suite logs can fill up with requests from background browser telemetry. You can block them locally:

```bash
$ sudo nano /etc/dnsmasq.d/google_block.conf
address=/googleapis.com/127.0.0.1
address=/google-analytics.com/127.0.0.1
address=/play.google.com/127.0.0.1
address=/googleadservices.com/127.0.0.1
address=/pki.goog/127.0.0.1
address=/lencr.org/127.0.0.1
```

Reload automatically, no manual restarts needed.

## Troubleshooting

### `dnsmasq.service: Start request repeated too quickly`

You've hit the start-limit threshold.

Fix:
```bash
sudo systemctl reset-failed dnsmasq
sudo systemctl restart dnsmasq
```

If it keeps happening, verify the override file includes:
```ini
[Service]
StartLimitIntervalSec=60
StartLimitBurst=10
```

### "Failed to revert interface configuration: Unit dbus-org.freedesktop.resolve1.service not found"

Harmless. It appears when `systemd-resolved` is disabled, safe to ignore.

### Port 53 already in use

Run:
```bash
sudo lsof -i :53
```

If you see Tailscale or another resolver, either disable its DNS (`sudo tailscale set --accept-dns=false`) or move `dnsmasq` to another port in `/etc/dnsmasq.conf`:
```
port=5353
listen-address=127.0.0.1
```

Then query it directly:
```bash
dig example.htb @127.0.0.1 -p 5353
```

## Conclusion

With this configuration:
* `dnsmasq` automatically reloads when configs change
* Tailscale no longer interferes
* The service is safe from restart loops (`start-limit-hit`)
* Local DNS development is frictionless

You now have a **robust, automated, and Tailscale-compatible local DNS setup** for labs, pentesting, or development, no more manual restarts or broken resolvers.
